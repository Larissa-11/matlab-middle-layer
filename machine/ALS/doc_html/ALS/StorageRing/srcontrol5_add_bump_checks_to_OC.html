<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of srcontrol5_add_bump_checks_to_OC</title>
  <meta name="keywords" content="srcontrol5_add_bump_checks_to_OC">
  <meta name="description" content="srcontrol5">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">ALS</a> &gt; <a href="index.html">StorageRing</a> &gt; srcontrol5_add_bump_checks_to_OC.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for ALS\StorageRing&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>srcontrol5_add_bump_checks_to_OC
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>srcontrol5</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function srcontrol5(action, Input2, Input3) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> srcontrol5
 Storage ring control program

 This program controls all storage ring magnets, performs orbit feedback and
 tune feedforward and helps to diagnose problems in routine user operation
 of the ALS storage ring. It includes a gui to simplify the use of this
 program.

 It was originally programmed by Greg Portmann (until December 2000) with input
 from Winfried Decking, David Robin, Christoph Steier, Ying Wu and others
 and is currently (July 2002) maintained by Christoph Steier and Tom Scarvie.

 The actual version of this program is srcontrol5 (is called by default if you call srcontrol).

 Christoph Steier, July 2002

 SRCONTROL5 is the newest versionof SRCONTROL, edited to work with G. Portmann's new (2005) Matlab middle layer.

 Tom Scarvie, April 2005</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="amp2k.html" class="code" title="function [k, B] = amp2k(Family, Field, Amps, DeviceList, Energy, BranchFlag)">amp2k</a>	AMP2K - Converts amperes to simulator values</li><li><a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>	BEND2GEV - Compute the energy based on the ramp tables</li><li><a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>	CHECKSRMAGS - Check SR power supplies against a lattice file</li><li><a href="checksrorbit.html" class="code" title="function ErrorNums = checksrorbit(SectorList, BPMxtol,BPMytol)">checksrorbit</a>	ErrorNums =checksrorbit(Sector, BPMxtolerance [.015 mm], [BPMytolerance [.015 mm]])</li><li><a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>	GAP2TUNE - Computes the vertical tune shift for a insertion device gap change.</li><li><a href="gaplimit.html" class="code" title="function [GAPmin, GAPmax] = gaplimit(DeviceList)">gaplimit</a>	[GapMin, GapMax] = gaplimit(DeviceList)</li><li><a href="getbpmlist.html" class="code" title="function [DeviceList, Index] = getbpmlist(varargin)">getbpmlist</a>	GETBPMLIST - Return a BPM list based on key words and sector numbers</li><li><a href="getbpmtimeconstant.html" class="code" title="function [BPMTimeConstant, WarningFlag] = getbpmtimeconstant(varargin)">getbpmtimeconstant</a>	GETBPMTIMECONSTANT - Sets the timeconstants for the Bergoz style BPMs.</li><li><a href="getff.html" class="code" title="function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)">getff</a>	GETFF - Get the state of insertion device feed forward and user gap contr5ol</li><li><a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>	GETID - Get the insertion device position, velocity, run flag, and user requested gap</li><li><a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>	[StateNumber, StateString] = getsrstate</li><li><a href="ocsinit.html" class="code" title="function [HBPM, VBPM, HCM, VCM, HSV, VSV] = ocsinit(MethodName)">ocsinit</a>	OCSINIT - Corrector and BPM</li><li><a href="set_alarmhandler_AHU_thresholds_inject.html" class="code" title="function set_alarmhandler_AHU_thresholds_inject">set_alarmhandler_AHU_thresholds_inject</a>	function set_alarmhandler_AHU_thresholds_inject</li><li><a href="set_etaywave_nuy9_20skews_skewFF.html" class="code" title="function [SQSFincr, SQSDincr] = set_etaywave_nuy9_20skews_skewFF(scale);">set_etaywave_nuy9_20skews_skewFF</a>	function [SQSFincr, SQSDincr] = set_etaywave_nuy9_20skews_skewFF(scale);</li><li><a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>	SETBPMTIMECONSTANT - Sets the timeconstants for the Bergoz style BPMs.</li><li><a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>	SETBUMPS - Make a straight section bump</li><li><a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>	function setff(DeviceList, FFEnableBC, GapEnableBC)</li><li><a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag)">setid</a>	SETID - Set the insertion device vertical gap</li><li><a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>	</li><li><a href="shift2tune.html" class="code" title="function [Dnux, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = shift2tune(Sector, Gap, EPUshift, GeV)">shift2tune</a>	SHIFT2TUNE - Computes the horizontal tune shift for a EPU gap and horizontal shift</li><li><a href="srcycle.html" class="code" title="function FailFlag = srcycle(varargin)">srcycle</a>	SRCYCLE - Storage ring cycle</li><li><a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>	SRRAMP - Ramp the storage ring energy</li><li><a href="write_goldenorbit_ffb.html" class="code" title="function write_goldenorbit_ffb">write_goldenorbit_ffb</a>	function write_goldenorbit_ffb</li><li><a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>	WRITE_GOLDENORBIT_FFTB_2PLANES - Sets the BPM setpoints which are used by the fast feedback system</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function srcontrol5(action, Input2, Input3)</a>
0002 <span class="comment">% srcontrol5</span>
0003 <span class="comment">% Storage ring control program</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% This program controls all storage ring magnets, performs orbit feedback and</span>
0006 <span class="comment">% tune feedforward and helps to diagnose problems in routine user operation</span>
0007 <span class="comment">% of the ALS storage ring. It includes a gui to simplify the use of this</span>
0008 <span class="comment">% program.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% It was originally programmed by Greg Portmann (until December 2000) with input</span>
0011 <span class="comment">% from Winfried Decking, David Robin, Christoph Steier, Ying Wu and others</span>
0012 <span class="comment">% and is currently (July 2002) maintained by Christoph Steier and Tom Scarvie.</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% The actual version of this program is srcontrol5 (is called by default if you call srcontrol).</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% Christoph Steier, July 2002</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% SRCONTROL5 is the newest versionof SRCONTROL, edited to work with G. Portmann's new (2005) Matlab middle layer.</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% Tom Scarvie, April 2005</span>
0021 
0022 <span class="comment">% known bugs/problems (May 2001):</span>
0023 <span class="comment">% - IDBPM averaging might be a bit too long for orbit feedback</span>
0024 <span class="comment">%        solved after Superbend shutdown ... Instead of averaging, digital low pass filters are used</span>
0025 <span class="comment">% - gap2tune does not give correct answers for wiggler and potentially other IDs -&gt; orbit feedback</span>
0026 <span class="comment">%        seems to be OK for other IDs, has been corrected for wiggler (fit to insertion device</span>
0027 <span class="comment">%        compensation table)</span>
0028 <span class="comment">% - chicanes do not work in orbit feedback</span>
0029 <span class="comment">%        solved. One problem was that orbit response matrizes were mis-scaled by factor of two.</span>
0030 <span class="comment">%        Second problem was different time constant of power supply control. Solved by moving controls</span>
0031 <span class="comment">%        of center chicanes to cPCI (and magnets are fast, hysteresis free, aircore coils).</span>
0032 <span class="comment">%        Center chicane in sector 4 is now routinely used in orbit feedback. Sector 11 to follow soon.</span>
0033 <span class="comment">% - zero reading of ID gap dumps beam</span>
0034 <span class="comment">%        solved in srcontrol5, still a problem in srcontrol5_hightune (but that routine has to be completely</span>
0035 <span class="comment">%        rewritten because of all recent changes to srcontrol5, anyhow). For gap readings below the minimum</span>
0036 <span class="comment">%        allowed gap for a device, the tune feedforward disables itself.</span>
0037 <span class="comment">% - cycling of lattice causes frequent power supply failures</span>
0038 <span class="comment">%        solved by changing the cycling procedure. 1.5 GeV operation is now on the upper hysteresis branch</span>
0039 <span class="comment">%        as was the 1.9 GeV injection lattice before.</span>
0040 <span class="comment">% - frequently stalled data in IDBPM readout</span>
0041 <span class="comment">%        solved with new BPM readouts and digital filtering. Seems to have been a resolution problem</span>
0042 <span class="comment">%        of the digital averaging algorithm.</span>
0043 <span class="comment">% - magnet ramp tables are not in perfect agreement with magnetic measurements</span>
0044 <span class="comment">%        Does not appear to be a serious problem. Superbends are slightly out of sync with other magnets,</span>
0045 <span class="comment">%        but this does not cause any negative effects while ramping.</span>
0046 <span class="comment">% - no good way to operate with injection at 1.5 GeV and storage energy below that</span>
0047 <span class="comment">%        There now is a reasonable way to inject at 1.5 GeV and ramp down to lower storage energy. But</span>
0048 <span class="comment">%        it has to be tested again after implementing new (and more) chicanes ...</span>
0049 
0050 <span class="comment">% revision history</span>
0051 <span class="comment">% 2001-05-10, Christoph Steier</span>
0052 <span class="comment">% check whether readback from insertion device is significantly (more than 1 mm) below minimum</span>
0053 <span class="comment">% gap, to avoid false zero readings of insertion device gaps to cause the tune feed forward</span>
0054 <span class="comment">% to implement false huge correction (and dump the beam). If the insertion device gap readbacks</span>
0055 <span class="comment">% gets more than 1 mm below the nominal minimum gap, the routine now assumes the insertion device</span>
0056 <span class="comment">% to be open.</span>
0057 <span class="comment">%</span>
0058 <span class="comment">% 2001-08-30 and during Superbend commissioning, Christoph Steier, Tom Scarvie, Winni Decking</span>
0059 <span class="comment">% various changes have been made to incorporate the Superbends and some other new equipment</span>
0060 <span class="comment">% installed in the Superbend shutdown. This included some changes to programs being called by srcontrol</span>
0061 <span class="comment">% (like srload, srsave, srcycle, srramp, ...). The main changes within srcontrol were in the orbit</span>
0062 <span class="comment">% correction and slow orbit feedback routines (incorporating frequency feedback, ...)</span>
0063 <span class="comment">%</span>
0064 <span class="comment">% 2002-05-04, Christoph Steier</span>
0065 <span class="comment">% added new IDBPMs, modified orbit feedback to use trim DACs, removed LSB toggling in vertical</span>
0066 <span class="comment">% orbit feedback, ...</span>
0067 <span class="comment">%</span>
0068 
0069 <span class="comment">% 2002-07-29, T.Scarvie</span>
0070 <span class="comment">% added check of CM trim currents to warn of problems that might rail the orbit feedback</span>
0071 <span class="comment">%</span>
0072 <span class="comment">% 2002-07-31, Christoph Steier</span>
0073 <span class="comment">% increased the gain of the RF frequency feedback from 1/50 of the gain of the horizontal</span>
0074 <span class="comment">% orbit feedback to 1/20. Reason was that the frequency feedback was reacting a bit too slow if all</span>
0075 <span class="comment">% insertion device gaps are closed at once at high speed at the beginning of a fill.</span>
0076 <span class="comment">%</span>
0077 <span class="comment">% 2002-08-05, C.Steier, T.Scarvie</span>
0078 <span class="comment">% Added conditional to reduce orbit feedback gain if running in two-bunch mode</span>
0079 <span class="comment">%</span>
0080 <span class="comment">% 2003-06-02, T.Scarvie</span>
0081 <span class="comment">% Added loop inside orbit feedback to reset the SR11 chicane M1 and M2 motors every 20s to combat drift problem</span>
0082 <span class="comment">%</span>
0083 <span class="comment">% 2003-06-18, C. Steier</span>
0084 <span class="comment">% Disabled loop to periodically reset chicane in SR11. Al Robb replaced power supply, seems to be no problem anymore.</span>
0085 <span class="comment">%</span>
0086 <span class="comment">% 2004-05-10, C. Steier</span>
0087 <span class="comment">% The list of all BBPMs is now set up automatically be calling getlist('BBPMx'). This way, new BBPMs have to be added</span>
0088 <span class="comment">% at fewer places in the software. It should now be sufficient to modify getlist and run the orbit response matrix</span>
0089 <span class="comment">% rountine (getsmat) once to enable use of the new BBPMs.</span>
0090 <span class="comment">%</span>
0091 <span class="comment">% 2004-05-14, C. Steier</span>
0092 <span class="comment">% Modified parameters for ramprate reduction (in srramp and here). Previous parameters were slightly too</span>
0093 <span class="comment">% cautious. Increased initial slow ramprate to 0.4 A/s.</span>
0094 <span class="comment">%</span>
0095 <span class="comment">% 2004-05-14, C. Steier</span>
0096 <span class="comment">% Incorporated insertion device compensation schemes for nu_y = 9.2 lattice.</span>
0097 <span class="comment">%</span>
0098 <span class="comment">% 2004-06-14, T.Scarvie</span>
0099 <span class="comment">% Added controls for fast orbit feedback</span>
0100 <span class="comment">%</span>
0101 <span class="comment">% 2004-06-21, C. Steier</span>
0102 <span class="comment">% Added tune feedforward (in the global tune compensation scheme for the nu_y=9.2 lattice) for the shift</span>
0103 <span class="comment">% dependent tune shift of the EPUs, as well as a skew quadrupole feedforward for the EPU im sector 11</span>
0104 <span class="comment">% (both only active in parallel mode so far).</span>
0105 <span class="comment">%</span>
0106 <span class="comment">% 2005-02-13, T.Scarvie</span>
0107 <span class="comment">% Separated horizontal and vertical planes for setting Fast Feedback PIDs</span>
0108 
0109 
0110 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0111 <span class="comment">% NOTES for conversion to new Middle Layer %</span>
0112 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0113 <span class="comment">%</span>
0114 <span class="comment">% We never use the gap and bump control flags - the radio buttons have been disabled -</span>
0115 <span class="comment">%        should we try to keep the functionality?</span>
0116 <span class="comment">%</span>
0117 <span class="comment">% checksrmags</span>
0118 <span class="comment">% checksrorbit(...)</span>
0119 
0120 
0121 <span class="comment">% For the compiler</span>
0122 <span class="comment">%#function goldenpage</span>
0123 <span class="comment">%#function setoperationalmode</span>
0124 
0125 
0126 <span class="comment">% Check if the AO exists</span>
0127 checkforao;
0128 
0129 
0130 <span class="comment">%%%%%%%%%%%%%%</span>
0131 <span class="comment">% Initialize %</span>
0132 <span class="comment">%%%%%%%%%%%%%%</span>
0133 
0134 <span class="keyword">global</span> FEEDBACK_STOP_FLAG
0135 
0136 SR_Mode = getfamilydata(<span class="string">'OperationalMode'</span>);
0137 SR_GEV = getfamilydata(<span class="string">'Energy'</span>);
0138 
0139 BSCramprate = getfamilydata(<span class="string">'BSCRampRate'</span>);
0140 <span class="keyword">if</span> isnan(BSCramprate) || isempty(BSCramprate)
0141     BSCramprate = 0.4;
0142     setfamilydata(BSCramprate, <span class="string">'BSCRampRate'</span>);
0143 <span class="keyword">end</span>
0144 
0145 <span class="keyword">if</span> nargin &lt; 1
0146     action = <span class="string">'Initialize'</span>;
0147 <span class="keyword">end</span>
0148 <span class="keyword">if</span> nargin &lt; 2
0149     Input2 = 0;
0150 <span class="keyword">end</span>
0151 <span class="keyword">if</span> nargin &lt; 3
0152     Input3 = 0;
0153 <span class="keyword">end</span>
0154 
0155 <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
0156     FOFBcheckboxVal = 0;
0157 <span class="keyword">else</span>
0158     FOFBcheckboxVal = 1;
0159 <span class="keyword">end</span>
0160 
0161 <span class="comment">% if strcmp(getfamilydata('OperationalMode'), '1.5 GeV, Inject at 1.23') || strcmp(SR_Mode, '1.9 GeV, Inject at 1.353')</span>
0162 <span class="comment">%     TUNEcheckboxVal = 0;</span>
0163 <span class="comment">% else</span>
0164 TUNEcheckboxVal = 1;
0165 <span class="comment">% end</span>
0166 
0167 <span class="comment">%%%%%%%%%%%%%%%%</span>
0168 <span class="comment">% Main Program %</span>
0169 <span class="comment">%%%%%%%%%%%%%%%%</span>
0170 
0171 <span class="keyword">switch</span>(action)
0172 
0173     <span class="keyword">case</span> <span class="string">'StopOrbitFeedback'</span>
0174 
0175         FEEDBACK_STOP_FLAG = 1;
0176 
0177     <span class="keyword">case</span> <span class="string">'Initialize'</span>
0178 
0179         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0180         <span class="comment">% GUI</span>
0181         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0182         ButtonWidth = 200;
0183         ButtonHeight  = 25;
0184 
0185         Offset1 = 8*25+12 + 47 + 25+25;
0186         Offset2 = 47+25+25;
0187         Offset3 = 45+25;
0188         Offset4 = 1;
0189         Offset5 = 30;
0190         FigWidth = ButtonWidth+6;
0191         FigHeight  = 3+9*(ButtonHeight+6)+24+Offset1;
0192         ButtonWidth = 200-6;
0193 
0194         <span class="comment">% Change figure position</span>
0195         set(0,<span class="string">'Units'</span>,<span class="string">'pixels'</span>);
0196         p=get(0,<span class="string">'screensize'</span>);
0197 
0198         h0 = figure( <span class="keyword">...</span>
0199             <span class="string">'Color'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0200             <span class="string">'HandleVisibility'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0201             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0202             <span class="string">'MenuBar'</span>,<span class="string">'none'</span>, <span class="keyword">...</span>
0203             <span class="string">'Name'</span>,<span class="string">'ALS SR CONTROL'</span>, <span class="keyword">...</span>
0204             <span class="string">'NumberTitle'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0205             <span class="string">'Units'</span>,<span class="string">'pixels'</span>, <span class="keyword">...</span>
0206             <span class="string">'Position'</span>,[30 p(4)-FigHeight-40 FigWidth FigHeight+Offset5], <span class="keyword">...</span>
0207             <span class="string">'Resize'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0208             <span class="string">'Tag'</span>,<span class="string">'SRCTRLFig1'</span>);
0209 
0210         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0211             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0212             <span class="string">'Callback'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0213             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0214             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0215             <span class="string">'FontWeight'</span>,<span class="string">'Bold'</span>, <span class="keyword">...</span>
0216             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0217             <span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>, <span class="keyword">...</span>
0218             <span class="string">'Position'</span>,[6 3+8*(ButtonHeight+3)+19+19+8+Offset1  ButtonWidth 20+Offset5], <span class="keyword">...</span>
0219             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0220             <span class="string">'String'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0221             <span class="string">'Tag'</span>,<span class="string">'SRCTRLTitle'</span>);
0222 
0223         <span class="comment">% Frame Box I</span>
0224         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0225             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0226             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0227             <span class="string">'Position'</span>,[3 3+3*(ButtonHeight+3)+Offset1-3+Offset5 ButtonWidth+6 7*ButtonHeight+18], <span class="keyword">...</span>
0228             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0229 
0230         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0231             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0232             <span class="string">'Callback'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0233             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0234             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0235             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0236             <span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>, <span class="keyword">...</span>
0237             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)+Offset1  ButtonWidth 15+Offset5], <span class="keyword">...</span>
0238             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0239             <span class="string">'String'</span>,<span class="string">'Lattice Setup Functions'</span>);
0240 
0241         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0242             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Cycle'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0243             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0244             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0245             <span class="string">'Position'</span>,[6 3+8*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0246             <span class="string">'String'</span>,<span class="string">'Cycle SR Lattice'</span>, <span class="keyword">...</span>
0247             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>);
0248 
0249         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0250             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Injection'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0251             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0252             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0253             <span class="string">'Position'</span>,[6 3+7*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0254             <span class="string">'String'</span>,<span class="string">'Injection'</span>, <span class="keyword">...</span>
0255             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>);
0256 
0257         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0258             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Production'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0259             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0260             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0261             <span class="string">'Position'</span>,[6 3+6*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0262             <span class="string">'String'</span>,[<span class="string">'Production'</span>], <span class="keyword">...</span>
0263             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>);
0264 
0265         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0266             <span class="string">'Callback'</span>,[<span class="keyword">...</span>
0267             <span class="string">'fprintf(''\n'');'</span> <span class="keyword">...</span>
0268             <span class="string">'disp([''   **********************************************'']);'</span>, <span class="keyword">...</span>
0269             <span class="string">'disp([''   **  Changing Storage Ring Operational Mode  **'']);'</span>, <span class="keyword">...</span>
0270             <span class="string">'disp([''   **********************************************'']);'</span>, <span class="keyword">...</span>
0271             <span class="string">'setoperationalmode;'</span>, <span class="keyword">...</span>
0272             <span class="string">'srcontrol5(''CheckInputs'');'</span>, <span class="keyword">...</span>
0273             <span class="string">'disp([''   ****************************'']);'</span>, <span class="keyword">...</span>
0274             <span class="string">'disp([''   **  Mode Change Complete  **'']);'</span>, <span class="keyword">...</span>
0275             <span class="string">'disp([''   ****************************'']);'</span>, <span class="keyword">...</span>
0276             <span class="string">'fprintf(''\n'');'</span>], <span class="keyword">...</span>
0277             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0278             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0279             <span class="string">'Position'</span>,[6 3+5*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0280             <span class="string">'Value'</span>,1, <span class="keyword">...</span>
0281             <span class="string">'String'</span>,<span class="string">'Change Operational Mode'</span>, <span class="keyword">...</span>
0282             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>);
0283 
0284         h1 = uicontrol(<span class="keyword">...</span>
0285             <span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0286             <span class="string">'Callback'</span>, [<span class="keyword">...</span>
0287             <span class="string">'srcontrol5(''CheckInputs'');'</span>,<span class="keyword">...</span>
0288             <span class="string">'srcontrol5(''SRState'');'</span>], <span class="keyword">...</span>
0289             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0290             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0291             <span class="string">'Position'</span>,[6 3+4*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0292             <span class="string">'String'</span>,<span class="string">'Check For Problems'</span>, <span class="keyword">...</span>
0293             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>);
0294 
0295         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0296             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs''); goldenpage;'</span>, <span class="keyword">...</span>
0297             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0298             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0299             <span class="string">'Position'</span>,[6 3+3*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0300             <span class="string">'String'</span>,<span class="string">'Golden Page'</span>, <span class="keyword">...</span>
0301             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>);
0302 
0303 
0304         <span class="comment">% Frame Box II</span>
0305         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0306             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0307             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0308             <span class="string">'Position'</span>,[3 3+9*(ButtonHeight+3)-29+Offset2+Offset5 ButtonWidth+6 2*ButtonHeight+15], <span class="keyword">...</span>
0309             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0310         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0311             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0312             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0313             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0314             <span class="string">'Position'</span>,[6 3+10*(ButtonHeight+3)-10+Offset2 ButtonWidth .6*ButtonHeight+Offset5], <span class="keyword">...</span>
0315             <span class="string">'String'</span>,<span class="string">'Global/Local Orbit Correction'</span>, <span class="keyword">...</span>
0316             <span class="string">'Style'</span>,<span class="string">'text'</span>);
0317         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0318             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''OrbitCorrection'');'</span>, <span class="keyword">...</span>
0319             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0320             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0321             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)-6+Offset2+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0322             <span class="string">'String'</span>,<span class="string">'Correct Global Orbit w/ IDBPMs'</span>, <span class="keyword">...</span>
0323             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>);
0324         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0325             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''OrbitCorrectionSetup'',1);'</span>, <span class="keyword">...</span>
0326             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''OrbitCorrectionSetup'',0);'</span>, <span class="keyword">...</span>
0327             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0328             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0329             <span class="string">'Position'</span>,[6 9*(ButtonHeight+3)-22+Offset2+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0330             <span class="string">'String'</span>,<span class="string">'Edit IDBPM, CM, &amp; Local Bump Lists'</span>, <span class="keyword">...</span>
0331             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0332             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0333             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>);
0334 
0335 
0336         <span class="comment">% Frame Box III</span>
0337         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0338             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0339             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0340             <span class="string">'Position'</span>,[3 1*(ButtonHeight)+Offset3+Offset5-38 ButtonWidth+6 8*ButtonHeight+61], <span class="keyword">...</span>
0341             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0342         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0343             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0344             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0345             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0346             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)+Offset3-25 ButtonWidth .55*ButtonHeight+Offset5], <span class="keyword">...</span>
0347             <span class="string">'String'</span>,<span class="string">'Orbit Feedback'</span>, <span class="keyword">...</span>
0348             <span class="string">'Style'</span>,<span class="string">'text'</span>);
0349 
0350         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0351             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0352             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0353             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0354             <span class="string">'Position'</span>,[26 3+8*(ButtonHeight+3)+Offset3-18+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0355             <span class="string">'String'</span>,<span class="string">'Slow Orbit Correction'</span>, <span class="keyword">...</span>
0356             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0357             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0358             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxSOFB'</span>);
0359         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0360             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0361             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0362             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0363             <span class="string">'Position'</span>,[26 3+7*(ButtonHeight+3)+Offset3-9+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0364             <span class="string">'String'</span>,<span class="string">'Fast Orbit Correction'</span>, <span class="keyword">...</span>
0365             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0366             <span class="string">'Value'</span>,FOFBcheckboxVal,<span class="keyword">...</span>
0367             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxFOFB'</span>);
0368 
0369         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0370             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0371             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0372             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0373             <span class="string">'Position'</span>,[26 3+6*(ButtonHeight+3)+Offset3+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0374             <span class="string">'String'</span>,<span class="string">'Correct ID Tune Shift  '</span>, <span class="keyword">...</span>
0375             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0376             <span class="string">'Value'</span>,TUNEcheckboxVal,<span class="keyword">...</span>
0377             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxTune'</span>);
0378 
0379         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0380             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0381             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0382             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0383             <span class="string">'Position'</span>,[26 3+5*(ButtonHeight+3)+Offset3+9+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0384             <span class="string">'String'</span>,<span class="string">'Correct RF Frequency'</span>, <span class="keyword">...</span>
0385             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0386             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0387             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>);
0388 
0389         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0390             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''Feedback'');'</span>, <span class="keyword">...</span>
0391             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0392             <span class="string">'FontSize'</span>,12, <span class="keyword">...</span>
0393             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0394             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0395             <span class="string">'Position'</span>,[8 3+5*(ButtonHeight+3)+3+Offset3-25+Offset5 .5*ButtonWidth-6 1.0*ButtonHeight], <span class="keyword">...</span>
0396             <span class="string">'String'</span>,<span class="string">'Start FB'</span>, <span class="keyword">...</span>
0397             <span class="string">'Value'</span>,0, <span class="keyword">...</span>
0398             <span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>);
0399         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0400             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''StopOrbitFeedback'');pause(0);'</span>, <span class="keyword">...</span>
0401             <span class="string">'Enable'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0402             <span class="string">'FontSize'</span>,12, <span class="keyword">...</span>
0403             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0404             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0405             <span class="string">'Position'</span>,[.5*FigWidth+3 3+5*(ButtonHeight+3)+3+Offset3-25+Offset5 .5*ButtonWidth-6 1.0*ButtonHeight], <span class="keyword">...</span>
0406             <span class="string">'String'</span>,<span class="string">'Stop FB'</span>, <span class="keyword">...</span>
0407             <span class="string">'Value'</span>,0, <span class="keyword">...</span>
0408             <span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>);
0409 
0410         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0411             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0412             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0413             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0414             <span class="string">'Position'</span>,[14 4*(ButtonHeight)+Offset3+Offset5-3 ButtonWidth-14 .75*ButtonHeight], <span class="keyword">...</span>
0415             <span class="string">'String'</span>,<span class="string">'Horizontal RMS = _____ mm'</span>, <span class="keyword">...</span>
0416             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0417             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>);
0418         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0419             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0420             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0421             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0422             <span class="string">'Position'</span>,[26 3+3.5*(ButtonHeight)+16+Offset3-25+Offset5 ButtonWidth-26 .75*ButtonHeight], <span class="keyword">...</span>
0423             <span class="string">'String'</span>,<span class="string">'Vertical RMS = _____ mm'</span>, <span class="keyword">...</span>
0424             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0425             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>);
0426 
0427         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0428             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''FeedbackSetup'',1);'</span>, <span class="keyword">...</span>
0429             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''FeedbackSetup'',0);'</span>, <span class="keyword">...</span>
0430             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0431             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0432             <span class="string">'Position'</span>,[8 3+3.5*(ButtonHeight)+.5+Offset3-25+Offset5 ButtonWidth-5 .75*ButtonHeight], <span class="keyword">...</span>
0433             <span class="string">'String'</span>,<span class="string">'Edit SOFB Setup'</span>, <span class="keyword">...</span>
0434             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0435             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0436             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>);
0437 
0438         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0439             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0440             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0441             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0442             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0443             <span class="string">'String'</span>,<span class="string">'01 ____'</span>, <span class="keyword">...</span>
0444             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0445             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0446             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>);
0447 
0448         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0449             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0450             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0451             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0452             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0453             <span class="string">'String'</span>,<span class="string">'02 ____'</span>, <span class="keyword">...</span>
0454             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0455             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0456             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>);
0457 
0458         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0459             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0460             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0461             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0462             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0463             <span class="string">'String'</span>,<span class="string">'03 ____'</span>, <span class="keyword">...</span>
0464             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0465             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0466             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>);
0467 
0468         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0469             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0470             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0471             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0472             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0473             <span class="string">'String'</span>,<span class="string">'04 ____'</span>, <span class="keyword">...</span>
0474             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0475             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0476             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>);
0477 
0478         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0479             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0480             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0481             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0482             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0483             <span class="string">'String'</span>,<span class="string">'05 ____'</span>, <span class="keyword">...</span>
0484             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0485             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0486             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>);
0487 
0488         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0489             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0490             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0491             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0492             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0493             <span class="string">'String'</span>,<span class="string">'06 ____'</span>, <span class="keyword">...</span>
0494             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0495             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0496             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>);
0497 
0498         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0499             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0500             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0501             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0502             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0503             <span class="string">'String'</span>,<span class="string">'07 ____'</span>, <span class="keyword">...</span>
0504             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0505             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0506             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>);
0507 
0508         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0509             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0510             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0511             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0512             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0513             <span class="string">'String'</span>,<span class="string">'08 ____'</span>, <span class="keyword">...</span>
0514             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0515             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0516             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>);
0517 
0518         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0519             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0520             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0521             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0522             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0523             <span class="string">'String'</span>,<span class="string">'09 ____'</span>, <span class="keyword">...</span>
0524             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0525             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0526             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>);
0527 
0528         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0529             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0530             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0531             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0532             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0533             <span class="string">'String'</span>,<span class="string">'10 ____'</span>, <span class="keyword">...</span>
0534             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0535             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0536             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>);
0537 
0538         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0539             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0540             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0541             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0542             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0543             <span class="string">'String'</span>,<span class="string">'11 ____'</span>, <span class="keyword">...</span>
0544             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0545             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0546             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>);
0547 
0548         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0549             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0550             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0551             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0552             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0553             <span class="string">'String'</span>,<span class="string">'12 ____'</span>, <span class="keyword">...</span>
0554             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0555             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0556             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>);
0557 
0558         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0559             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''FastFeedbackSetup'',1);'</span>, <span class="keyword">...</span>
0560             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''FastFeedbackSetup'',0);'</span>, <span class="keyword">...</span>
0561             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0562             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0563             <span class="string">'Position'</span>,[8 1*(ButtonHeight)+Offset3-3 ButtonWidth-5 .75*ButtonHeight], <span class="keyword">...</span>
0564             <span class="string">'String'</span>,<span class="string">'Edit FOFB Setup'</span>, <span class="keyword">...</span>
0565             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0566             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0567             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>);
0568 
0569         <span class="comment">% Frame Box IV</span>
0570         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0571             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0572             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0573             <span class="string">'Position'</span>,[3 3+ButtonHeight+Offset4-14+Offset5 ButtonWidth+6 ButtonHeight+12], <span class="keyword">...</span>
0574             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0575         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0576             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0577             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0578             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0579             <span class="string">'Position'</span>,[6 3+1.75*ButtonHeight+5+Offset4-21+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0580             <span class="string">'String'</span>,<span class="string">'Storage Ring State'</span>, <span class="keyword">...</span>
0581             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0582             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHeader'</span>);
0583         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0584             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''CheckInputs'');'</span>, <span class="keyword">...</span>
0585             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0586             <span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>, <span class="keyword">...</span>
0587             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0588             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0589             <span class="string">'Position'</span>,[6 3+ButtonHeight+6+3+2+Offset4-22+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0590             <span class="string">'String'</span>,<span class="string">'   '</span>, <span class="keyword">...</span>
0591             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0592             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>);
0593 
0594 
0595         <span class="comment">% Frame Box &quot;Close&quot;</span>
0596         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0597             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0598             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0599             <span class="string">'Position'</span>,[3 8 ButtonWidth+6 ButtonHeight+8], <span class="keyword">...</span>
0600             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0601         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0602             <span class="string">'Callback'</span>,<span class="string">'close(gcbf);'</span>, <span class="keyword">...</span>
0603             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0604             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0605             <span class="string">'Position'</span>,[6 13 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0606             <span class="string">'String'</span>,<span class="string">'Close'</span>, <span class="keyword">...</span>
0607             <span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>);
0608 
0609 
0610         <span class="comment">% Update database channels</span>
0611         <a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>;
0612 
0613         <span class="keyword">if</span> nargout &gt; 0
0614             fig = h0;
0615         <span class="keyword">end</span>
0616 
0617 
0618     <span class="keyword">case</span> <span class="string">'Cycle'</span>
0619         GapFlag = Input2;
0620         BumpMagnetFlag = Input3;
0621 
0622         fprintf(<span class="string">'\n'</span>);
0623         disp(<span class="string">'   **************************'</span>);
0624         disp(<span class="string">'   **  Storage Ring Cycle  **'</span>);
0625         disp(<span class="string">'   **************************'</span>);
0626         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
0627 
0628         BSCFlag = questdlg(sprintf(<span class="string">'Cycle Superbend Magnets?'</span>),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0629         <span class="comment">%if strcmp(BSCFlag,'No')</span>
0630         <span class="comment">%    disp(['   ** Superbends will not be cycled. **']);</span>
0631         <span class="comment">%else</span>
0632         <span class="comment">%    disp(['   ** Superbends will be cycled during the second mini-cycle only. **']);</span>
0633         <span class="comment">%end</span>
0634 
0635         ChicSQFlag = questdlg(sprintf(<span class="string">'Cycle chicanes and skew quads and home motor chicanes?'</span>),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0636         <span class="comment">%if strcmp(ChicSQFlag,'No')</span>
0637         <span class="comment">%    disp(['   ** Chicanes and skew quads will not be cycled; motor chicanes will not be homed. **']);</span>
0638         <span class="comment">%else</span>
0639         <span class="comment">%    disp(['   ** Chicanes and skew quads will be cycled; motor chicanes will be homed. **']);</span>
0640         <span class="comment">%end</span>
0641 
0642 
0643         StartFlag = questdlg(sprintf(<span class="string">'Start %.1f GeV Cycle?'</span>,SR_GEV),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0644         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
0645             disp([<span class="string">'   ***************************'</span>]);
0646             disp([<span class="string">'   **    Cycle  Canceled    **'</span>]);
0647             disp([<span class="string">'   ***************************'</span>]);
0648             fprintf(<span class="string">'\n'</span>);
0649             <span class="keyword">return</span>
0650         <span class="keyword">end</span>
0651 
0652         <span class="keyword">try</span>
0653             <span class="keyword">if</span> GapFlag
0654                 <span class="comment">% Make sure that the gaps are open with FF off</span>
0655                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0656                     <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0657                     disp(<span class="string">'   Insertion device gaps are not open.'</span>);
0658                     disp(<span class="string">'   Opening all gaps at maximum speed.'</span>);
0659                     <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0660                     disp(<span class="string">'   Gap control disabled.'</span>);
0661                     disp(<span class="string">'   Feed forward enabled.'</span>);
0662                     pause(1);
0663                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag)">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0664                     disp(<span class="string">'   Gaps opened.'</span>);
0665                     disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0666                     a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0667                 <span class="keyword">else</span>
0668                     disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0669                 <span class="keyword">end</span>
0670             <span class="keyword">else</span>
0671                 disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0672             <span class="keyword">end</span>
0673 
0674             <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0675             pause(1);
0676             
0677             <a href="srcycle.html" class="code" title="function FailFlag = srcycle(varargin)">srcycle</a>(BSCFlag, ChicSQFlag);
0678 
0679             setpv(<span class="string">'SR_STATE'</span>,1);
0680 
0681         <span class="keyword">catch</span>
0682 
0683             fprintf(<span class="string">'   %s \n'</span>,lasterr);
0684             fprintf(<span class="string">'   Cycle failed due to error condition! \n\n'</span>);
0685             setpv(<span class="string">'SR_STATE'</span>,-1);
0686             
0687         <span class="keyword">end</span>
0688 
0689         date;
0690         a = clock;
0691         datestr1=date;
0692         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0693         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0694         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0695         <span class="keyword">if</span> StateNumber &gt;= 0
0696             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0697             disp(<span class="string">'   **********************************************'</span>);
0698             disp(<span class="string">'   **  SR Cycle complete, ready for injection  **'</span>);
0699             disp(<span class="string">'   **********************************************'</span>); fprintf(<span class="string">'\n'</span>);
0700         <span class="keyword">else</span>
0701             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0702             disp(<span class="string">'   **********************************'</span>);
0703             disp(<span class="string">'   **  Problem cycling SR lattice  **'</span>);
0704             disp(<span class="string">'   **********************************'</span>); fprintf(<span class="string">'\n'</span>);
0705         <span class="keyword">end</span>
0706         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0707         
0708 
0709     <span class="keyword">case</span> <span class="string">'Injection'</span>
0710         AD = getad;
0711         GapFlag = Input2;
0712         BumpMagnetFlag = Input3;
0713 
0714         fprintf(<span class="string">'\n'</span>);
0715         <span class="keyword">if</span> abs(AD.Energy - AD.InjectionEnergy) &gt; .05
0716             fprintf(<span class="string">'   ***************************************************\n'</span>);
0717             fprintf(<span class="string">'   **  Setup For %.2f GeV Injection (with ramping)  **\n'</span>, getfamilydata(<span class="string">'InjectionEnergy'</span>));
0718             fprintf(<span class="string">'   ***************************************************\n'</span>);
0719             <a href="set_alarmhandler_AHU_thresholds_inject.html" class="code" title="function set_alarmhandler_AHU_thresholds_inject">set_alarmhandler_AHU_thresholds_inject</a>;
0720             StartFlag = questdlg(sprintf(<span class="string">'Start setup for injection, %.2f GeV?'</span>,getfamilydata(<span class="string">'InjectionEnergy'</span>)),<span class="string">'Injection Setup'</span>,<span class="string">'Ramp quickly'</span>,<span class="string">'Ramp slowly'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0721         <span class="keyword">else</span>
0722             fprintf(<span class="string">'   *************************************************\n'</span>);
0723             fprintf(<span class="string">'   **  Setup For On Energy Injection at %.2f GeV  **\n'</span>, SR_GEV);
0724             fprintf(<span class="string">'   *************************************************\n'</span>);
0725             StartFlag = questdlg(sprintf(<span class="string">'Start setup for injection, %.2f GeV?'</span>,SR_GEV),<span class="string">'Injection Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0726         <span class="keyword">end</span>
0727         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0728         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'Cancel'</span>)
0729             disp([<span class="string">'   ********************************'</span>]);
0730             disp([<span class="string">'   **  Injection Setup Canceled  **'</span>]);
0731             disp([<span class="string">'   ********************************'</span>]);
0732             <span class="comment">%set_alarmhandler_thresholds_new;</span>
0733             fprintf(<span class="string">'\n'</span>);
0734             <span class="keyword">return</span>
0735         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp quickly'</span>)
0736             setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0737         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp slowly'</span>)
0738             setfamilydata(0.4, <span class="string">'BSCRampRate'</span>);
0739         <span class="keyword">end</span>
0740 
0741         <span class="keyword">try</span>
0742 
0743             <span class="keyword">if</span> GapFlag
0744                 <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([],1,0);
0745                 disp(<span class="string">'   Gap control disabled'</span>);
0746                 disp(<span class="string">'   Feed forward enabled'</span>);
0747                 pause(1);
0748 
0749                 <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0750                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0751                     disp(<span class="string">'   Opening all gaps'</span>);
0752                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag)">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0753                 <span class="keyword">end</span>
0754 
0755                 disp(<span class="string">'   Gaps are open'</span>);
0756                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0757                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0758             <span class="keyword">else</span>
0759                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0760             <span class="keyword">end</span>
0761 
0762             <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0763             pause(1);
0764 
0765             <span class="keyword">if</span> (AD.Energy-AD.InjectionEnergy) &gt; 0.05
0766                 <span class="comment">% Ramp down to Injection Energy</span>
0767                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,<span class="string">'Ramping Down'</span>,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0768                 drawnow;
0769                 ErrorFlag = <a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>(<span class="string">'Injection'</span>);
0770                 <span class="keyword">if</span> ErrorFlag
0771                     error(<span class="string">'Superbends over temperature.'</span>);
0772                 <span class="keyword">end</span>
0773                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n\n'</span>,date, a(4), a(5), a(6));
0774 
0775             <span class="keyword">elseif</span> (AD.Energy-AD.InjectionEnergy) &lt; -0.05
0776 
0777                 <span class="comment">% first load injection lattice, then ramp to 1.9 GeV and back to 1.5 GeV to get onto same hysteresis branch</span>
0778 
0779                 srload(<span class="string">'Injection'</span>);
0780 
0781                 <span class="comment">% load 1.9 GeV lattice</span>
0782                 tempfilename = sprintf(<span class="string">'%s19nuy9prod.mat'</span>, getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>));
0783 
0784                 srload(tempfilename);
0785 
0786                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0787 
0788                 pause(5);
0789 
0790             <span class="keyword">end</span>
0791 
0792             srload(<span class="string">'Injection'</span>);
0793 
0794             setpv(<span class="string">'SR_STATE'</span>,2);
0795 
0796         <span class="keyword">catch</span>
0797 
0798             fprintf(<span class="string">'   %s \n'</span>,lasterr);
0799             fprintf(<span class="string">'   Injection lattice setup failed due to error condition! \n\n'</span>);
0800             setpv(<span class="string">'SR_STATE'</span>,-2);
0801 
0802         <span class="keyword">end</span>
0803 
0804 
0805         date;
0806         a = clock;
0807         datestr1=date;
0808         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0809         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0810         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0811         <span class="keyword">if</span> StateNumber &gt;= 0
0812             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0813             <span class="keyword">if</span> AD.Energy &lt;= 1.5
0814                 disp([<span class="string">'   *******************************************************************************'</span>]);
0815                 disp([<span class="string">'   **  Function complete:  the storage ring is setup for injection at '</span>,sprintf(<span class="string">'%.2f'</span>,SR_GEV),<span class="string">' GeV  **'</span>]);
0816                 disp([<span class="string">'   *******************************************************************************'</span>]); 
0817                 fprintf(<span class="string">'\n'</span>);
0818             <span class="keyword">else</span>
0819                 fprintf(<span class="string">'   **********************************************************************************************\n'</span>);
0820                 fprintf(<span class="string">'   **  Function complete:  the storage ring is setup for injection at %.2f GeV (upper branch)  **\n'</span>, getfamilydata(<span class="string">'InjectionEnergy'</span>));
0821                 fprintf(<span class="string">'   **********************************************************************************************\n'</span>); 
0822                 fprintf(<span class="string">'\n'</span>);
0823             <span class="keyword">end</span>
0824         <span class="keyword">else</span>
0825             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0826             disp([<span class="string">'   ************************************'</span>]);
0827             disp([<span class="string">'   **  Problem with injection setup  **'</span>]);
0828             disp([<span class="string">'   ************************************'</span>]); 
0829             fprintf(<span class="string">'\n'</span>);
0830         <span class="keyword">end</span>
0831         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0832 
0833         <span class="comment">%soundchord;</span>
0834 
0835         setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0836 
0837 
0838     <span class="keyword">case</span> <span class="string">'Production'</span>
0839         GapFlag = Input2;
0840         BumpMagnetFlag = Input3;
0841         AD=getad;
0842         
0843         fprintf(<span class="string">'\n'</span>);
0844         <span class="keyword">if</span> abs(AD.Energy - AD.InjectionEnergy) &gt; .05
0845             disp(<span class="string">'   ********************************************************'</span>);
0846             disp(sprintf(<span class="string">'   **  Setup For %.2f GeV User Operation (with ramping)  **'</span>,SR_GEV));
0847             disp(<span class="string">'   ********************************************************'</span>);
0848             StartFlag = questdlg(sprintf(<span class="string">'Start setup for users, %.1f GeV?'</span>,SR_GEV),<span class="string">'User Setup'</span>,<span class="string">'Ramp quickly'</span>,<span class="string">'Ramp slowly'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0849         <span class="keyword">else</span>
0850             disp(<span class="string">'   *****************************************'</span>);
0851             disp(sprintf(<span class="string">'   **  Setup For %.2f GeV User Operation  **'</span>,SR_GEV));
0852             disp(<span class="string">'   *****************************************'</span>);
0853             StartFlag = questdlg(sprintf(<span class="string">'Start setup for users, %.1f GeV?'</span>,SR_GEV),<span class="string">'User Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0854         <span class="keyword">end</span>
0855         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0856 
0857         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'Cancel'</span>)
0858             disp([<span class="string">'   ***************************'</span>]);
0859             disp([<span class="string">'   **  User Setup Canceled  **'</span>]);
0860             disp([<span class="string">'   ***************************'</span>]);
0861             fprintf(<span class="string">'\n'</span>);
0862             <span class="keyword">return</span>
0863         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp quickly'</span>)
0864             setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0865         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp slowly'</span>)
0866             setfamilydata(0.4, <span class="string">'BSCRampRate'</span>);
0867         <span class="keyword">end</span>
0868 
0869         <span class="keyword">try</span>
0870 
0871             <span class="keyword">if</span> GapFlag
0872                 <span class="comment">% Make sure that the gaps are open</span>
0873                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0874                     <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0875                     disp(<span class="string">'   Insertion device gaps are not open'</span>);
0876                     disp(<span class="string">'   Opening all gaps at maximum speed'</span>);
0877                     <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0878                     disp(<span class="string">'   Gap control disabled'</span>);
0879                     disp(<span class="string">'   Feed forward enabled'</span>);
0880                     pause(1);
0881                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag)">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0882                     disp(<span class="string">'   Gaps opened'</span>);
0883                     disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0884                     a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0885                 <span class="keyword">else</span>
0886                     disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0887                 <span class="keyword">end</span>
0888             <span class="keyword">else</span>
0889                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0890             <span class="keyword">end</span>
0891 
0892             <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0893             pause(1);
0894 
0895             <span class="comment">%%%%%%%%%%%%%%%</span>
0896             <span class="keyword">if</span> (AD.Energy-AD.InjectionEnergy) &gt; 0.05
0897                 <span class="comment">% Ramp up to the production lattice</span>
0898                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,<span class="string">'Ramping Up'</span>,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0899                 drawnow;
0900                 ErrorFlag = <a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>(<span class="string">'Production'</span>);
0901                 <span class="keyword">if</span> ErrorFlag
0902                     error(<span class="string">'Superbends over temperature.'</span>);
0903                 <span class="keyword">end</span>
0904                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0905 
0906                 srload(<span class="string">'Production'</span>);
0907 
0908 
0909             <span class="keyword">elseif</span> abs(AD.Energy-AD.InjectionEnergy) &lt; 0.05
0910 
0911                 <span class="comment">% load production lattice - no ramp required</span>
0912                 srload(<span class="string">'Production'</span>);
0913                 <span class="comment">%a = clock; fprintf('   %s %d:%d:%.0f\n',date, a(4), a(5), a(6));</span>
0914                 pause(1);
0915 
0916             <span class="keyword">end</span>
0917             <span class="comment">%%%%%%%%%%%%%%%</span>
0918             
0919             <span class="keyword">if</span> GapFlag
0920                 <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0921                 disp(<span class="string">'   Gap control disabled'</span>);
0922                 disp(<span class="string">'   Feed forward enable'</span>);
0923                 pause(1);
0924 
0925                 disp(<span class="string">'   Insertion device velocity profile boolean control off'</span>);
0926                 disp(<span class="string">'   Closing all gaps at maximum speed'</span>);
0927 
0928                 <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0929                 [Position, Velocity, RunFlag, UserGap] = <a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>;
0930 
0931                 <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag)">setid</a>([], UserGap, maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0932 
0933                 <span class="comment">% Turn velocity profile on</span>
0934                 disp(<span class="string">'   Insertion device velocity profile boolean control is on'</span>);
0935                 <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag)">setid</a>([], [], maxsp(<span class="string">'IDvel'</span>), 1, 1, 0);
0936 
0937                 disp(<span class="string">'   Gaps are closed'</span>);
0938                 <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([4;7;8;9;10;12], 1, 1);
0939                 <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>(5, 1, 0);
0940                 disp(<span class="string">'   Gap control enabled (except sector 5 (W16))'</span>);
0941             <span class="keyword">end</span>
0942 
0943             <span class="comment">%set_alarmhandler_thresholds_new;</span>
0944             setpv(<span class="string">'SR_STATE'</span>,3);
0945 
0946         <span class="keyword">catch</span>
0947 
0948             fprintf(<span class="string">'   %s \n'</span>, lasterr);
0949             fprintf(<span class="string">'   User lattice setup failed due to error condition! \n\n'</span>);
0950             setpv(<span class="string">'SR_STATE'</span>,-3);
0951 
0952         <span class="keyword">end</span>
0953 
0954         <span class="comment">%give JH scrapers a chance to move</span>
0955         <span class="comment">% pause(15);</span>
0956         
0957         a = clock;
0958         datestr1 = date;
0959         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0960         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0961         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0962         <span class="keyword">if</span> StateNumber &gt;= 0
0963             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0964             disp([<span class="string">'   **************************************************************************'</span>]);
0965             disp([<span class="string">'   **  Function complete:  the storage ring is setup for users at '</span>,sprintf(<span class="string">'%.1f'</span>,SR_GEV),<span class="string">' GeV  **'</span>]);
0966             disp([<span class="string">'   **************************************************************************'</span>]); 
0967             fprintf(<span class="string">'\n'</span>);
0968         <span class="keyword">else</span>
0969             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0970             disp([<span class="string">'   *************************************'</span>]);
0971             disp([<span class="string">'   **  Problem with production setup  **'</span>]);
0972             disp([<span class="string">'   *************************************'</span>]); 
0973             fprintf(<span class="string">'\n'</span>);
0974         <span class="keyword">end</span>
0975         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0976 
0977         setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0978 
0979 
0980 <span class="comment">%         % for BL6.0.x, set lower setpoint limit for IVID to 12.5mm until beamlines are surveyed below that value</span>
0981 <span class="comment">%         try</span>
0982 <span class="comment">%             scaput('SR06U___GDS1PS_AC00.DRVL',12.5);</span>
0983 <span class="comment">%             disp('  Setting SR06U___GDS1PS_AC00.DRVL to 12.5mm (lower limit for IVID');</span>
0984 <span class="comment">%         catch</span>
0985 <span class="comment">%             disp('  Trouble setting lower limit for IVID to 12.5mm!');</span>
0986 <span class="comment">%         end</span>
0987 
0988         
0989     <span class="keyword">case</span> <span class="string">'CheckInputs'</span>
0990 
0991         SR_GEV = getfamilydata(<span class="string">'Energy'</span>);
0992         AD=getad;
0993         <a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>; 
0994 
0995         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0996 
0997         <span class="keyword">if</span> AD.Energy &gt; 1.55 &amp; AD.InjectionEnergy &lt; 1.55
0998             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection (Ramp Down)'</span>]);
0999             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users (Ramp Up)'</span>]);
1000         <span class="keyword">elseif</span> AD.Energy &lt; 1.45
1001             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection (Ramp Up+cycle)'</span>]);
1002             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users, '</span>,num2str(round(10*SR_GEV)/10),<span class="string">' GeV (Ramp Down)'</span>]);
1003         <span class="keyword">else</span>
1004             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection'</span>]);
1005             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users, '</span>,num2str(round(10*SR_GEV)/10),<span class="string">' GeV'</span>]);
1006         <span class="keyword">end</span>
1007         set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLTitle'</span>),<span class="string">'String'</span>,SR_Mode);
1008 
1009         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1010         <span class="keyword">if</span> StateNumber &gt;= 0
1011             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1012         <span class="keyword">else</span>
1013             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1014         <span class="keyword">end</span>
1015 
1016         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1017 
1018 
1019     <span class="keyword">case</span> <span class="string">'SRState'</span>
1020         NumErrors = 0;
1021         fprintf(<span class="string">'\n'</span>);
1022         disp(<span class="string">'   ***********************************'</span>);
1023         disp(<span class="string">'   **  Checking Storage Ring State  **'</span>);
1024         disp(<span class="string">'   ***********************************'</span>);
1025         a = clock;
1026         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1027 
1028         <span class="comment">%       FileName = getpv('SR_LATTICE_FILE','String');   % Last srload file name (in OLD MIDDLE LAYER nomenclature!!)</span>
1029 
1030         GeVnow = <a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>;
1031         <span class="keyword">if</span> GeVnow == getfamilydata(<span class="string">'Energy'</span>)
1032             [ConfigSetpoint, ConfigMonitor, FileName] = getproductionlattice;
1033         <span class="keyword">elseif</span> GeVnow == getfamilydata(<span class="string">'InjectionEnergy'</span>)
1034             [ConfigSetpoint, ConfigMonitor, FileName] = getinjectionlattice;
1035         <span class="keyword">else</span>
1036             FileName = <span class="string">''</span>;
1037         <span class="keyword">end</span>
1038 
1039         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1040         fprintf(<span class="string">'   Storage ring operational mode: %s\n'</span>, SR_Mode);
1041         <span class="keyword">if</span> StateNumber &lt; 0
1042             fprintf(<span class="string">'   Storage ring state error: %s\n'</span>, StateString);
1043             NumErrors = NumErrors + 1;
1044         <span class="keyword">else</span>
1045             fprintf(<span class="string">'   Storage ring state: %s\n'</span>, StateString);
1046         <span class="keyword">end</span>
1047         <span class="keyword">if</span> StateNumber==0
1048             <span class="comment">% Storage ring state unknown</span>
1049             NumErrors = NumErrors + 1;
1050         <span class="keyword">elseif</span> abs(StateNumber)==1 || abs(StateNumber)==2
1051             FileNameGoal = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>) getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'InjectionFile'</span>) <span class="string">'.mat'</span>];
1052             <span class="keyword">if</span> ~strcmp(FileName, FileNameGoal)
1053                 fprintf(<span class="string">'   Lattice file %s should be loaded but it appears that %s is loaded.\n'</span>, getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'InjectionFile'</span>), FileName);
1054                 NumErrors = NumErrors + 1;
1055             <span class="keyword">end</span>
1056         <span class="keyword">else</span>
1057             FileNameGoal = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>) getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'LatticeFile'</span>) <span class="string">'.mat'</span>];
1058             <span class="keyword">if</span> ~strcmp(FileName, FileNameGoal)
1059                 fprintf(<span class="string">'   Lattice file %s should be loaded but it appears that %s is loaded.\n'</span>, getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'LatticeFile'</span>), FileName);
1060                 NumErrors = NumErrors + 1;
1061             <span class="keyword">end</span>
1062         <span class="keyword">end</span>
1063 
1064 
1065         <span class="comment">% Check all SR magnets</span>
1066         <span class="keyword">if</span> isempty(FileName)
1067             fprintf(<span class="string">'   Goal setpoints will not be checked since the last lattice load is unknown.\n'</span>);
1068             NumErrors1 = <a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>(<span class="string">''</span>);
1069         <span class="keyword">else</span>
1070 <span class="comment">%            NumErrors1 = checksrmags([getfamilydata('Directory','OpsData') FileName]);</span>
1071             NumErrors1 = <a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>(FileName);
1072         <span class="keyword">end</span>
1073         <span class="keyword">if</span> NumErrors1 == 0
1074             fprintf(<span class="string">'   SR magnets power supplies are OK.\n'</span>);
1075         <span class="keyword">end</span>
1076         NumErrors = NumErrors + NumErrors1;
1077 
1078 
1079         <span class="comment">% Check RF frequency</span>
1080         <span class="keyword">if</span> isempty(FileName)
1081             fprintf(<span class="string">'   RF frequency will not be checked since the last lattice load is unknown.\n'</span>);
1082         <span class="keyword">else</span>
1083 <span class="comment">%            load([getfamilydata('Directory','OpsData'), FileName]);</span>
1084             load(FileName);
1085             [tmp, RFHPCounterPresent] = getrf;
1086             <span class="keyword">if</span> abs(RFHPCounterPresent-ConfigSetpoint.RF.Setpoint.Data) &gt; .002
1087                 NumErrors = NumErrors + 1;
1088                 fprintf(<span class="string">'   RF frequency should be %f, presently it is %f MHz (as measured by the HP counter).\n'</span>, ConfigSetpoint.RF.Setpoint.Data, RFHPCounterPresent);
1089             <span class="keyword">else</span>
1090                 fprintf(<span class="string">'   RF frequency is OK (HP counter is %f MHz, at the time of the lattice save it was %f MHz).\n'</span>, RFHPCounterPresent, ConfigSetpoint.RF.Setpoint.Data);
1091             <span class="keyword">end</span>
1092         <span class="keyword">end</span>
1093 
1094 
1095         <span class="comment">% Check for orbit problems</span>
1096         <span class="keyword">if</span> (StateNumber &gt;= 3) &amp;&amp; (getdcct &gt; 2)   <span class="comment">% Production lattice is loaded with beam in the machine</span>
1097             Xtol = 0.070;
1098             Ytol = 0.010;
1099             NumErrors1 = <a href="checksrorbit.html" class="code" title="function ErrorNums = checksrorbit(SectorList, BPMxtol,BPMytol)">checksrorbit</a>([],Xtol,Ytol);
1100             <span class="keyword">if</span> NumErrors1
1101                 fprintf(<span class="string">'   SR orbit in the ID straight sections or at Bergoz BPMs deviates more than allowed from the golden orbit.\n'</span>);
1102             <span class="keyword">else</span>
1103                 fprintf(<span class="string">'   SR orbit in the ID straight sections and at Bergoz BPMs is OK.\n'</span>);
1104                 fprintf(<span class="string">'   The orbit is within %.3f mm horizontally and %.3f mm vertically'</span>, Xtol, Ytol);
1105             <span class="keyword">end</span>
1106             NumErrors = NumErrors + NumErrors1;
1107         <span class="keyword">else</span>
1108             fprintf(<span class="string">'   Storage ring orbit was not checked.\n'</span>);
1109         <span class="keyword">end</span>
1110 
1111 
1112         a = clock;
1113         datestr1=date;
1114         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
1115         <span class="keyword">if</span> NumErrors
1116             disp(<span class="string">'   *********************************'</span>);
1117             disp(<span class="string">'   **  Storage Ring Has Problems  **'</span>);
1118             disp(<span class="string">'   *********************************'</span>);
1119         <span class="keyword">else</span>
1120             disp(<span class="string">'   **********************************'</span>);
1121             disp(<span class="string">'   **  Storage Ring Lattice is OK  **'</span>);
1122             disp(<span class="string">'   **********************************'</span>);
1123         <span class="keyword">end</span>
1124         fprintf(<span class="string">'   \n'</span>);
1125 
1126         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1127         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1128         <span class="keyword">if</span> StateNumber &gt;= 0
1129             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1130         <span class="keyword">else</span>
1131             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1132         <span class="keyword">end</span>
1133         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1134 
1135 
1136     <span class="keyword">case</span> <span class="string">'OrbitCorrection'</span>
1137         fprintf(<span class="string">'\n'</span>);
1138         fprintf(<span class="string">'   *********************************\n'</span>);
1139         fprintf(<span class="string">'   **  Starting Orbit Correction  **\n'</span>);
1140         fprintf(<span class="string">'   *********************************\n'</span>);
1141         a = clock;
1142         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1143 
1144         StartFlag = questdlg(sprintf(<span class="string">'Start orbit correction, %.1f GeV?'</span>,SR_GEV),<span class="string">'Orbit Correction'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
1145         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
1146             disp([<span class="string">'   ********************************'</span>]);
1147             disp([<span class="string">'   **  Orbit Correction Aborted  **'</span>]);
1148             disp([<span class="string">'   ********************************'</span>]);
1149             fprintf(<span class="string">'\n'</span>);
1150             <span class="keyword">return</span>
1151         <span class="keyword">end</span>
1152 
1153         <span class="keyword">if</span> getdcct &lt; 2     <span class="comment">% Don't correct the orbit if the current is too small</span>
1154             fprintf(<span class="string">'   Orbit not corrected due to small current.\n'</span>);
1155             <span class="keyword">return</span>
1156         <span class="keyword">end</span>
1157 
1158         <span class="keyword">if</span> abs(SR_GEV-<a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>(getpv(<span class="string">'BEND'</span>,<span class="string">'Setpoint'</span>,[1 1])))&gt;  0.05     <span class="comment">% Don't use this routine for the injection lattice</span>
1159             fprintf(<span class="string">'   This routine should only be used for the production energy: Correction aborted\n'</span>);
1160             <span class="keyword">return</span>
1161         <span class="keyword">end</span>
1162 
1163         SR_STATE_OLD = scaget(<span class="string">'SR_STATE'</span>);
1164         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1165         setpv(<span class="string">'SR_STATE'</span>,4);
1166         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1167         <span class="keyword">if</span> StateNumber &gt;= 0
1168             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1169         <span class="keyword">else</span>
1170             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1171         <span class="keyword">end</span>
1172         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1173 
1174 
1175         <span class="keyword">try</span>
1176             <span class="comment">% save current BPM timeconstant - will reset to this after correction</span>
1177             BPMtimeconstantOC = <a href="getbpmtimeconstant.html" class="code" title="function [BPMTimeConstant, WarningFlag] = getbpmtimeconstant(varargin)">getbpmtimeconstant</a>;
1178             fprintf(<span class="string">'   Current Bergoz BPM time constant is %.1fs\n'</span>, BPMtimeconstantOC);
1179 
1180             <span class="comment">% 2 Hz update rate on IDBPMs</span>
1181             disp(<span class="string">'   Bergoz BPM time constant set to 0.5s.'</span>)
1182             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.5)
1183             pause(2);
1184 
1185 
1186             <span class="comment">% Turn off feed forward</span>
1187             fprintf(<span class="string">'   Turning feed forward off.\n'</span>);
1188             [FFEnableBM, FFEnableBC] = <a href="getff.html" class="code" title="function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)">getff</a>;
1189             <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 0);
1190             scasleep(.2);
1191 
1192 
1193             <span class="comment">% Check whether bumps and kickers are on and warn to turn off before starting feedback if necessary</span>
1194             <span class="keyword">try</span>
1195                 <span class="keyword">if</span> (getsp(<span class="string">'SR01S___BUMP1__BC21'</span>)==1 &amp;&amp; getsp(<span class="string">'SR01S___BUMP1P_BC22'</span>)==1) || (getsp(<span class="string">'SR01S___SEK____BC21'</span>)==1 &amp;&amp; getsp(<span class="string">'SR01S___SEK_P__BC23'</span>)==1) || (getsp(<span class="string">'SR01S___SEN____BC20'</span>)==1 &amp;&amp; getsp(<span class="string">'SR01S___SEN_P__BC22'</span>)==1)
1196                     soundtada;
1197                     fprintf(<span class="string">'   \n'</span>);
1198                     fprintf(<span class="string">'   *****************************************************************\n'</span>);
1199                     fprintf(<span class="string">'   ** One or more of the pulsed SR injection magnets is still on! **\n'</span>);
1200                     fprintf(<span class="string">'   **      Please turn them off then re-correct the orbit...      **\n'</span>);
1201                     fprintf(<span class="string">'   *****************************************************************\n'</span>);
1202                     fprintf(<span class="string">'   \n'</span>);
1203                 <span class="keyword">end</span>
1204             <span class="keyword">catch</span>
1205                 disp(<span class="string">'**Problem checking the state of the bumps and kickers - please check that they are not pulsing.'</span>);
1206             <span class="keyword">end</span>
1207 
1208 
1209             <span class="comment">% Get vectors</span>
1210             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>);
1211             LocalBumplist = FB.LocalBumplist;
1212 
1213         <span class="keyword">catch</span>
1214 
1215             fprintf(<span class="string">'   %s \n'</span>,lasterr);
1216             fprintf(<span class="string">'   Orbit correction setup failed due to error condition! \n\n'</span>);
1217             setpv(<span class="string">'SR_STATE'</span>,-4);
1218             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1219             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1220             <span class="keyword">if</span> StateNumber &gt;= 0
1221                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1222             <span class="keyword">else</span>
1223                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1224             <span class="keyword">end</span>
1225             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1226 
1227             <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1228             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1229             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1230             <span class="keyword">return</span>
1231         <span class="keyword">end</span>
1232 
1233         iNotHCMChicane = find(FB.HCMlist1(:,2) &lt; 10); <span class="comment">%used by steppv's for setting correctors in loop</span>
1234         iHCMChicane = find(FB.HCMlist1(:,2) == 10);
1235         iNotVCMChicane = find(FB.VCMlist1(:,2) &lt; 10);
1236         iVCMChicane = find(FB.VCMlist1(:,2) == 10);
1237 
1238         fprintf(<span class="string">'   Starting horizontal and vertical global orbit correction (SVD method).\n'</span>);
1239 
1240         <span class="keyword">for</span> iloop = 1:3
1241             <span class="keyword">try</span>
1242                 <span class="comment">% use the following to get corrector settings in OCS without setting them, so the values can be checked</span>
1243                 FB.OCSx = setorbit(FB.OCSx,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1244                 FB.OCSy = setorbit(FB.OCSy,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1245                 <span class="keyword">if</span> any(abs(FB.OCSx.CM.Delta(iNotHCMChicane)) &gt; 5)
1246                   disp(<span class="string">'   Orbit Correction is changing some horizontal corrector(s) &gt; 5A!!'</span>);
1247                 <span class="keyword">end</span>
1248                 <span class="keyword">if</span> any(abs(FB.OCSy.CM.Delta(iNotVCMChicane)) &gt; 5)
1249                   disp(<span class="string">'   Orbit Correction is changing some vertical corrector(s) &gt; 5A!!'</span>);
1250                 <span class="keyword">end</span>
1251                 <span class="keyword">if</span> any(abs(FB.OCSx.CM.Delta(iHCMChicane)) &gt; 10)
1252                   disp(<span class="string">'   Orbit Correction is changing some horizontal chicane corrector(s) &gt; 10A!!'</span>);
1253                 <span class="keyword">end</span>
1254                 <span class="keyword">if</span> any(abs(FB.OCSy.CM.Delta(iVCMChicane)) &gt; 10)
1255                     disp(<span class="string">'   Orbit Correction is changing some vertical chicane corrector(s) &gt; 10A!!'</span>);
1256                 <span class="keyword">end</span>
1257 
1258                 <span class="comment">% Correct RF</span>
1259                 rf0=getrf;
1260                 nRFsteps = 4*ceil(abs(FB.OCSx.DeltaRF/10e-6)); <span class="comment">%added factor 4 to slow down change for laser-lock at BL11.0.1 - 3-14-08, T.Scarvie</span>
1261                 <span class="keyword">if</span> nRFsteps &gt; 100
1262                     nRFsteps = 100;
1263                 <span class="keyword">end</span>
1264                 <span class="keyword">for</span> loop = 1:nRFsteps
1265                     steprf(FB.OCSx.DeltaRF/nRFsteps,0);
1266                 <span class="keyword">end</span>
1267                 fprintf(<span class="string">'   %d. nRFsteps = %d, RF change = %.1f Hz\n'</span>,iloop, nRFsteps, FB.OCSx.DeltaRF*1e6);
1268 <span class="comment">%               fprintf('   %d. RF change = %.1f Hz, nRFsteps = %d, DelRF = %.1f Hz\n',iloop, (getrf-rf0)*1e6, nRFsteps, FB.OCSx.DeltaRF*1e6);</span>
1269 
1270                 <span class="comment">% Correct horizontal and vertical orbits</span>
1271                 <span class="comment">% calculate corrections</span>
1272                 FB.OCSx.CM.Data = FB.OCSx.CM.Data + FB.OCSx.CM.Delta;
1273                 FB.OCSy.CM.Data = FB.OCSy.CM.Data + FB.OCSy.CM.Delta;
1274                 <span class="comment">% start vertical correctors moving</span>
1275                 setpv(FB.OCSy.CM,0);
1276                 <span class="comment">% Correct horizontal</span>
1277                 setpv(FB.OCSx.CM,-1);
1278                 <span class="comment">% Correct vertical</span>
1279                 setpv(FB.OCSy.CM,-2);
1280 
1281                 <span class="comment">% Check for current in machine - stop orbit correction if DCCT &lt; 5mA</span>
1282                 <span class="keyword">if</span> (getdcct &lt; 2)
1283                     error(<span class="string">'**There is less than 5mA in the machine! Stopping orbit correction.'</span>);
1284                 <span class="keyword">end</span>
1285 
1286                 <span class="comment">% Check state of gaps - stop orbit correction if any are moving</span>
1287                 GAPrunflag = getpv(<span class="string">'ID'</span>,<span class="string">'RunFlag'</span>);
1288                 <span class="keyword">if</span> any(GAPrunflag-round(GAPrunflag))
1289                     error(<span class="string">'**One or more of the gaps are moving! Stopping orbit correction.'</span>);
1290                 <span class="keyword">end</span>
1291 
1292                 x = FB.OCSx.GoalOrbit - getx(FB.OCSx.BPM.DeviceList);
1293                 y = FB.OCSy.GoalOrbit - gety(FB.OCSy.BPM.DeviceList);
1294                 fprintf(<span class="string">'   %d. Horizontal RMS = %.3f mm\n'</span>, iloop, norm(x)/sqrt(length(x)));
1295                 fprintf(<span class="string">'   %d.   Vertical RMS = %.3f mm\n'</span>, iloop, norm(y)/sqrt(length(y)));
1296 
1297             <span class="keyword">catch</span>
1298                 <span class="comment">% fprintf('   %s \n',lasterr);</span>
1299                 fprintf(<span class="string">'   Orbit correction failed due to error condition!\n  Fix the problem, reload the lattice (srload), and try again.  \n\n'</span>);
1300                 setpv(<span class="string">'SR_STATE'</span>,-4);
1301                 set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1302                 [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1303                 <span class="keyword">if</span> StateNumber &gt;= 0
1304                     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1305                 <span class="keyword">else</span>
1306                     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1307                 <span class="keyword">end</span>
1308                 set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1309 
1310                 <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1311                 <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1312                 fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1313                 <span class="keyword">return</span>
1314             <span class="keyword">end</span>
1315         <span class="keyword">end</span>
1316 
1317 
1318         <span class="comment">% Set user bumps w/o sextupole correctors</span>
1319         <span class="keyword">try</span>
1320 
1321             <span class="comment">%turn up corrector speed here to quicken setting bumps</span>
1322             HCMramprate = getpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>);
1323             VCMramprate = getpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>);
1324             setpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>, 10, [], 0);
1325             setpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>, 10, [], 0);
1326             
1327             <span class="keyword">if</span> ~isempty(LocalBumplist)
1328                 fprintf(<span class="string">'   Setting local bumps in the straight sections.\n'</span>);
1329                 <span class="keyword">for</span> loop = 1:size(LocalBumplist,1)
1330 
1331                     <span class="comment">% Check for current in machine - stop orbit correction if DCCT &lt; 5mA</span>
1332                     <span class="keyword">if</span> (getdcct &lt; 2)
1333                         error(<span class="string">'** There is less than 5mA in the machine! Stopping local bumps.'</span>);
1334                     <span class="keyword">end</span>
1335 
1336                     <span class="comment">% Check state of gaps - stop setting bumps if any are moving</span>
1337                     GAPrunflag = getpv(<span class="string">'ID'</span>,<span class="string">'RunFlag'</span>);
1338                     <span class="keyword">if</span> any(GAPrunflag-round(GAPrunflag))
1339                         error(<span class="string">'** One or more of the gaps are moving! Stopping local bumps.'</span>);
1340                     <span class="keyword">end</span>
1341 
1342                     HCMoldsp = getsp(<span class="string">'HCM'</span>, FB.HCMlist1);
1343                     VCMoldsp = getsp(<span class="string">'VCM'</span>, FB.VCMlist1);
1344 
1345                     <span class="keyword">if</span> any(LocalBumplist(loop,1) == [4 6 11])
1346                         <span class="keyword">if</span> LocalBumplist(loop,2) == 0
1347                             <span class="comment">% Upstream bump</span>
1348                             [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1)-1 11;LocalBumplist(loop,1)-1 12;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1349                             <span class="keyword">if</span> isempty(iRemove)
1350                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1351                             <span class="keyword">else</span>
1352                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1353                             <span class="keyword">end</span>
1354                         <span class="keyword">elseif</span> LocalBumplist(loop,2) == 1
1355                             <span class="comment">% Upstream bump</span>
1356                             [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1)-1 11;],FB.OCSx.BPM.DeviceList);
1357                             <span class="keyword">if</span> isempty(iRemove)
1358                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1359                             <span class="keyword">else</span>
1360                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1361                             <span class="keyword">end</span>
1362                         <span class="keyword">else</span>
1363                             <span class="comment">% Downstream bump</span>
1364                             [i, iRemove] = findrowindex([LocalBumplist(loop,1)-1 12;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1365                             <span class="keyword">if</span> isempty(iRemove)
1366                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1367                             <span class="keyword">else</span>
1368                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1369                             <span class="keyword">end</span>
1370                         <span class="keyword">end</span>
1371                     <span class="keyword">else</span>
1372                         [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1373                         <span class="keyword">if</span> isempty(iRemove)
1374                             <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1375                         <span class="keyword">else</span>
1376                             fprintf(<span class="string">'\n   BPMs missing from Sector %02d - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,1));
1377                         <span class="keyword">end</span>
1378                     <span class="keyword">end</span>
1379                     
1380                     HCMnewsp = getsp(<span class="string">'HCM'</span>, FB.HCMlist1);
1381                     VCMnewsp = getsp(<span class="string">'VCM'</span>, FB.VCMlist1);
1382                     <span class="comment">% Remove center chicane trim from corrector check</span>
1383                     <span class="keyword">if</span> (max(abs(HCMoldsp(iNotHCMChicane)-HCMnewsp(iNotHCMChicane))) &gt; 5) || (max(abs(VCMoldsp(iNotVCMChicane)-VCMnewsp(iNotVCMChicane))) &gt; 10)
1384                         error(<span class="string">'**Setbumps caused some corrector magnet currents to change by more than 5(Horiz)/10(Vert) A!'</span>);
1385                     <span class="keyword">end</span>
1386                     <span class="comment">% Now check center chicane trims</span>
1387                     <span class="keyword">if</span> (max(abs(HCMoldsp(iNotHCMChicane)-HCMnewsp(iNotHCMChicane))) &gt; 10) || (max(abs(VCMoldsp(iNotVCMChicane)-VCMnewsp(iNotVCMChicane))) &gt; 15)
1388                         error(<span class="string">'**Setbumps caused some chicane trim magnet currents to change by more than 10(Horiz)/15(Vert) A!'</span>);
1389                     <span class="keyword">end</span>
1390                 <span class="keyword">end</span>
1391             <span class="keyword">end</span>
1392 
1393             <span class="comment">%restore corrector speeds</span>
1394             setpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>, HCMramprate, [], 0);
1395             setpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>, VCMramprate, [], 0);
1396 
1397         <span class="keyword">catch</span>
1398             fprintf(<span class="string">'   %s \n'</span>,lasterr);
1399             fprintf(<span class="string">'   Setbumps failed due to error condition!  Fix the problem, reload the lattice (srload), and try again.\n\n'</span>);
1400             setpv(<span class="string">'SR_STATE'</span>,-4);
1401             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1402             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1403             <span class="keyword">if</span> StateNumber &gt;= 0
1404                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1405             <span class="keyword">else</span>
1406                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1407             <span class="keyword">end</span>
1408             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1409 
1410             <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1411             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1412             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1413             <span class="keyword">return</span>
1414         <span class="keyword">end</span>
1415 
1416         <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1417         <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1418         fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1419 
1420         <span class="comment">% Turn feed forward back to it's original state</span>
1421         <span class="keyword">if</span> any(FFEnableBC)
1422             fprintf(<span class="string">'   Turning feed forward back on.\n'</span>);
1423             <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], FFEnableBC);
1424         <span class="keyword">end</span>
1425 
1426 
1427         a = clock;
1428         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1429         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1430         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1431         <span class="keyword">if</span> StateNumber &gt;= 0
1432             setpv(<span class="string">'SR_STATE'</span>,4.1);
1433             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1434             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1435             fprintf(<span class="string">'   *********************************\n'</span>);
1436             fprintf(<span class="string">'   **  Orbit Correction Complete  **\n'</span>);
1437             fprintf(<span class="string">'   *********************************\n\n'</span>);
1438         <span class="keyword">else</span>
1439             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1440             fprintf(<span class="string">'   *************************************\n'</span>);
1441             fprintf(<span class="string">'   **  Problem With Orbit Correction  **\n'</span>);
1442             fprintf(<span class="string">'   *************************************\n\n'</span>);
1443         <span class="keyword">end</span>
1444         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1445         pause(0);
1446 
1447 
1448     <span class="keyword">case</span> <span class="string">'OrbitCorrectionSetup'</span>
1449         InitFlag = Input2;           <span class="comment">% Input #2: if InitFlag, then initialize variables</span>
1450 
1451         <span class="keyword">if</span> InitFlag
1452             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1453             <span class="comment">% This setup is now done in ocsinit.m %</span>
1454             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1455             <span class="comment">% Setup feedback elements</span>
1456             <span class="comment">% disp('Orbit correction condition: InitFlag=1 -- debugging message');</span>
1457 
1458             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1459             <span class="comment">% Edit the following lists to change default configuration of Orbit Correction %</span>
1460             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1461 <span class="comment">%             hlist=[];vlist=[];</span>
1462 <span class="comment">%             for Sector =1:12</span>
1463 <span class="comment">%                 if Sector == 1</span>
1464 <span class="comment">%                     vlist = [vlist;Sector 2;Sector 4;Sector 5;Sector 8];</span>
1465 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7];</span>
1466 <span class="comment">%                 elseif Sector == 3</span>
1467 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];</span>
1468 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7;Sector 10];</span>
1469 <span class="comment">%                 elseif Sector == 5</span>
1470 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];</span>
1471 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7;Sector 10];</span>
1472 <span class="comment">% %                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8]; %remove HCM and VCM(5,10) since corrector is not controlling starting 4-6-07</span>
1473 <span class="comment">% %                     hlist = [hlist;Sector 2;Sector 7];</span>
1474 <span class="comment">%                 elseif Sector == 10</span>
1475 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];</span>
1476 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7;Sector 10];</span>
1477 <span class="comment">%                 elseif Sector == 12</span>
1478 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 7];</span>
1479 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7];</span>
1480 <span class="comment">%                 else</span>
1481 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8];</span>
1482 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7];</span>
1483 <span class="comment">%                 end</span>
1484 <span class="comment">%             end</span>
1485 <span class="comment">%             HCMlist1 = hlist;</span>
1486 <span class="comment">%             VCMlist1 = vlist;</span>
1487 <span class="comment">%</span>
1488 <span class="comment">%             BPMlist1 = [</span>
1489 <span class="comment">%                 1 2</span>
1490 <span class="comment">%                 1 5</span>
1491 <span class="comment">%                 1 6</span>
1492 <span class="comment">%                 1 10</span>
1493 <span class="comment">%                 2 1</span>
1494 <span class="comment">%                 2 5</span>
1495 <span class="comment">%                 2 6</span>
1496 <span class="comment">%                 2 9</span>
1497 <span class="comment">%                 3 2</span>
1498 <span class="comment">%                 3 5</span>
1499 <span class="comment">%                 3 6</span>
1500 <span class="comment">%                 3 10</span>
1501 <span class="comment">%                 3 11</span>
1502 <span class="comment">%                 3 12</span>
1503 <span class="comment">%                 4 1</span>
1504 <span class="comment">%                 4 5</span>
1505 <span class="comment">%                 4 6</span>
1506 <span class="comment">%                 4 10</span>
1507 <span class="comment">%                 5 1</span>
1508 <span class="comment">%                 5 5</span>
1509 <span class="comment">%                 5 6</span>
1510 <span class="comment">%                 5 10</span>
1511 <span class="comment">%                 5 11</span>
1512 <span class="comment">%                 5 12</span>
1513 <span class="comment">%                 6 1</span>
1514 <span class="comment">%                 6 5</span>
1515 <span class="comment">%                 6 6</span>
1516 <span class="comment">%                 6 10</span>
1517 <span class="comment">%                 7 1</span>
1518 <span class="comment">%                 7 5</span>
1519 <span class="comment">%                 7 6</span>
1520 <span class="comment">%                 7 10</span>
1521 <span class="comment">%                 8 1</span>
1522 <span class="comment">%                 8 5</span>
1523 <span class="comment">%                 8 6</span>
1524 <span class="comment">%                 8 10</span>
1525 <span class="comment">%                 9 1</span>
1526 <span class="comment">%                 9 5</span>
1527 <span class="comment">%                 9 6</span>
1528 <span class="comment">%                 9 10</span>
1529 <span class="comment">%                 10 1</span>
1530 <span class="comment">%                 10 5</span>
1531 <span class="comment">%                 10 6</span>
1532 <span class="comment">%                 10 10</span>
1533 <span class="comment">%                 10 11</span>
1534 <span class="comment">%                 10 12</span>
1535 <span class="comment">%                 11 1</span>
1536 <span class="comment">%                 11 5</span>
1537 <span class="comment">%                 11 6</span>
1538 <span class="comment">%                 11 10</span>
1539 <span class="comment">%                 12 1</span>
1540 <span class="comment">%                 12 5</span>
1541 <span class="comment">%                 12 6</span>
1542 <span class="comment">%                 12 9];</span>
1543 <span class="comment">%</span>
1544 <span class="comment">%             % SVD orbit correction</span>
1545 <span class="comment">%             Xivec = [1:28];</span>
1546 <span class="comment">%             Yivec = [1:51];</span>
1547 <span class="comment">%</span>
1548 <span class="comment">%</span>
1549 <span class="comment">%             % Look for bad status BPMs</span>
1550 <span class="comment">%             iStatus = family2status('BPMx', BPMlist1);</span>
1551 <span class="comment">%             iBad = find(~iStatus);</span>
1552 <span class="comment">%             BPMlist1 = BPMlist1(find(iStatus),:);</span>
1553 <span class="comment">%             if length(iBad)</span>
1554 <span class="comment">%                 fprintf('   Global Orbit Correction: %d BPMs removed for bad status\n', length(iBad));</span>
1555 <span class="comment">%                 Yivec = Yivec(1:end-length(iBad));</span>
1556 <span class="comment">%             end</span>
1557 <span class="comment">%</span>
1558 <span class="comment">%             iStatus = family2status('HCM', HCMlist1);</span>
1559 <span class="comment">%             iBad = find(~iStatus);</span>
1560 <span class="comment">%             HCMlist1 = HCMlist1(find(iStatus),:);</span>
1561 <span class="comment">%             if length(iBad)</span>
1562 <span class="comment">%                 fprintf('   Global Orbit Correction: %d HCMs removed for bad status\n', length(iBad));</span>
1563 <span class="comment">%             end</span>
1564 <span class="comment">%</span>
1565 <span class="comment">%             iStatus = family2status('VCM', VCMlist1);</span>
1566 <span class="comment">%             iBad = find(~iStatus);</span>
1567 <span class="comment">%             VCMlist1 = VCMlist1(find(iStatus),:);</span>
1568 <span class="comment">%             if length(iBad)</span>
1569 <span class="comment">%                 fprintf('   Global Orbit Correction: %d VCMs removed for bad status\n', length(iBad));</span>
1570 <span class="comment">%             end</span>
1571 
1572             <span class="comment">% Initialize RFCorrFlag</span>
1573             RFCorrFlag = <span class="string">'Yes'</span>;
1574 
1575             <span class="comment">% Get the device lists from oscsinit and convert to srcontrol variables</span>
1576             [HBPM, VBPM, HCM, VCM, HSV, VSV] = <a href="ocsinit.html" class="code" title="function [HBPM, VBPM, HCM, VCM, HSV, VSV] = ocsinit(MethodName)">ocsinit</a>(<span class="string">'TopOfFill'</span>);
1577             <span class="keyword">if</span> strcmpi(RFCorrFlag, <span class="string">'Yes'</span>)
1578                 Xivec = 1:HSV+1;
1579             <span class="keyword">else</span>
1580                 Xivec = 1:HSV;
1581             <span class="keyword">end</span>
1582             Yivec = 1:VSV;
1583             BPMlist1 = HBPM.DeviceList;
1584             HCMlist1 = HCM.DeviceList;
1585             VCMlist1 = VCM.DeviceList;
1586             
1587             
1588             LocalBumplist = [
1589               <span class="comment">% 1 1</span>
1590               <span class="comment">% 2 1</span>
1591               <span class="comment">% 3 1</span>
1592                 4 1
1593               <span class="comment">% 4 2</span>
1594                 5 1
1595               <span class="comment">% 6 1</span>
1596               <span class="comment">% 6 2</span>
1597                 7 1
1598                 8 1
1599                 9 1
1600                 10 1
1601                 11 1
1602                 11 2
1603                 12 1
1604                 ];
1605             <span class="comment">%LocalBumplist = []</span>
1606             
1607 
1608         <span class="keyword">else</span>
1609 
1610             <span class="comment">% Get vectors</span>
1611             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>);
1612             BPMlist1 = FB.BPMlist1;
1613             HCMlist1 = FB.HCMlist1;
1614             VCMlist1 = FB.VCMlist1;
1615             Xivec = FB.Xivec;
1616             Yivec = FB.Yivec;
1617             LocalBumplist = FB.LocalBumplist;
1618             Xgoal = FB.Xgoal;
1619             Ygoal = FB.Ygoal;
1620             RFCorrFlag = FB.RFCorrFlag;
1621 
1622             <span class="comment">% Add button to change #ivectors, CMs, IDBPMs,</span>
1623             EditFlag = 0;
1624             h_fig1 = figure;
1625             <span class="keyword">while</span> EditFlag ~= 8
1626 
1627                 <span class="comment">% Sensitivity matrix</span>
1628                 Sx = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
1629                 Sy = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
1630                 
1631                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1632                 <span class="comment">% Can the call below work for setting FOFB RF parameter? %</span>
1633                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1634                 <span class="keyword">if</span> strcmpi(RFCorrFlag, <span class="string">'Yes'</span>)
1635                     Sx = [Sx getdisp(<span class="string">'BPMx'</span>,BPMlist1)];
1636                 <span class="keyword">end</span>
1637                 
1638                 Sx(isnan(Sx)) = 0;
1639                 Sy(isnan(Sy)) = 0;
1640                                
1641                 [Ux, SVx, Vx] = svd(Sx);
1642                 [Uy, SVy, Vy] = svd(Sy);
1643 
1644 
1645                 <span class="comment">% Remove singular values greater than the actual number of singular values</span>
1646                 i = find(Xivec&gt;length(diag(SVx)));
1647                 <span class="keyword">if</span> ~isempty(i)
1648                     disp(<span class="string">'   Horizontal E-vector scaled since there were more elements in the vector than singular values.'</span>);
1649                     pause(0);
1650                     Xivec(i) = [];
1651                 <span class="keyword">end</span>
1652                 i = find(Yivec&gt;length(diag(SVy)));
1653                 <span class="keyword">if</span> ~isempty(i)
1654                     disp(<span class="string">'   Vertical E-vector scaled since there were more elements in the vector than singular values.'</span>);
1655                     pause(0);
1656                     Yivec(i) = [];
1657                 <span class="keyword">end</span>
1658 
1659 
1660                 Ax = Sx*Vx(:,Xivec);
1661                 Tx = inv(Ax'*Ax)*Ax';
1662 
1663                 Ay = Sy*Vy(:,Yivec);
1664                 Ty = inv(Ay'*Ay)*Ay';
1665 
1666 
1667                 figure(h_fig1);
1668                 subplot(2,1,1);
1669                 semilogy(diag(SVx),<span class="string">'b'</span>);
1670                 hold on;
1671                 semilogy(diag(SVx(Xivec,Xivec)),<span class="string">'xr'</span>);
1672                 ylabel(<span class="string">'Horizontal'</span>);
1673                 title(<span class="string">'Response Matrix Singular Values'</span>);
1674                 hold off;
1675                 subplot(2,1,2);
1676                 semilogy(diag(SVy),<span class="string">'b'</span>);
1677                 hold on;
1678                 semilogy(diag(SVy(Yivec,Yivec)),<span class="string">'xr'</span>);
1679                 xlabel(<span class="string">'Singular Value Number'</span>);
1680                 ylabel(<span class="string">'Vertical'</span>);
1681                 hold off;
1682                 drawnow;
1683 
1684                 <span class="keyword">if</span> strcmp(RFCorrFlag,<span class="string">'No'</span>)
1685                     RFCorrState = <span class="string">'NOT CORRECTED'</span>;
1686                 <span class="keyword">elseif</span> strcmp(RFCorrFlag,<span class="string">'Yes'</span>)
1687                     RFCorrState = <span class="string">'CORRECTED'</span>;
1688                 <span class="keyword">else</span>
1689                     RFCorrState = <span class="string">'???'</span>;
1690                 <span class="keyword">end</span>
1691 
1692                 <span class="comment">%         EditFlag = menu('Change Parameters?','Singular Values','HCM List','VCM List','HCM Chicane List','VCM Chicane List','IDBPM List','BBPM List','Change Golden Orbit',...</span>
1693                 <span class="comment">%            'Local Bump List',sprintf('RF Frequency (currently %s)',RFCorrState),'Continue');</span>
1694                 EditFlag = menu(<span class="string">'Change Parameters?'</span>,<span class="string">'Singular Values'</span>,<span class="string">'HCM List'</span>,<span class="string">'VCM List'</span>,<span class="string">'BPM List'</span>,<span class="string">'Change Golden Orbit'</span>,<span class="keyword">...</span>
1695                     <span class="string">'Local Bump List'</span>,sprintf(<span class="string">'RF Frequency (currently %s)'</span>,RFCorrState),<span class="string">'Continue'</span>);
1696 
1697                 <span class="keyword">if</span> EditFlag == 1
1698                     prompt={<span class="string">'Enter the horizontal E-vector numbers (Matlab vector format):'</span>,<span class="string">'Enter the vertical E-vector numbers (Matlab vector format):'</span>};
1699                     def={sprintf(<span class="string">'[%d:%d]'</span>,1,Xivec(end)),sprintf(<span class="string">'[%d:%d]'</span>,1,Yivec(end))};
1700                     titlestr=<span class="string">'SVD Orbit Feedback'</span>;
1701                     lineNo=1;
1702                     answer=inputdlg(prompt,titlestr,lineNo,def);
1703                     <span class="keyword">if</span> ~isempty(answer)
1704                         XivecNew = fix(str2num(answer{1}));
1705                         <span class="keyword">if</span> isempty(XivecNew)
1706                             disp(<span class="string">'   Horizontal E-vector cannot be empty.  No change made.'</span>);
1707                         <span class="keyword">else</span>
1708                             <span class="keyword">if</span> any(XivecNew&lt;=0) || max(XivecNew)&gt;length(diag(SVx))
1709                                 disp(<span class="string">'   Error reading horizontal E-vector.  No change made.'</span>);
1710                             <span class="keyword">else</span>
1711                                 Xivec = XivecNew;
1712                             <span class="keyword">end</span>
1713                         <span class="keyword">end</span>
1714                         YivecNew = fix(str2num(answer{2}));
1715                         <span class="keyword">if</span> isempty(YivecNew)
1716                             disp(<span class="string">'   Vertical E-vector cannot be empty.  No change made.'</span>);
1717                         <span class="keyword">else</span>
1718                             <span class="keyword">if</span> any(YivecNew&lt;=0) || max(YivecNew)&gt;length(diag(SVy))
1719                                 disp(<span class="string">'   Error reading vertical E-vector.  No change made.'</span>);
1720                             <span class="keyword">else</span>
1721                                 Yivec = YivecNew;
1722                             <span class="keyword">end</span>
1723                         <span class="keyword">end</span>
1724                     <span class="keyword">end</span>
1725                 <span class="keyword">end</span>
1726 
1727                 <span class="keyword">if</span> EditFlag == 2
1728                     List = getlist(<span class="string">'HCM'</span>);
1729                     CheckList = zeros(size(List,1));
1730                     Elem = dev2elem(<span class="string">'HCM'</span>, HCMlist1);
1731                     CheckList(Elem) = ones(size(Elem));
1732                     CheckList = CheckList(dev2elem(<span class="string">'HCM'</span>,List));
1733                     newList = editlist(List, <span class="string">'HCM'</span>, CheckList);
1734                     <span class="keyword">if</span> isempty(newList)
1735                         fprintf(<span class="string">'   Horizontal corrector magnet list cannot be empty.  No change made.\n'</span>);
1736                     <span class="keyword">else</span>
1737                         HCMlist1 = newList;
1738                     <span class="keyword">end</span>
1739                 <span class="keyword">end</span>
1740 
1741                 <span class="keyword">if</span> EditFlag == 3
1742                     List = getlist(<span class="string">'VCM'</span>);
1743                     CheckList = zeros(size(List,1));
1744                     Elem = dev2elem(<span class="string">'VCM'</span>, VCMlist1);
1745                     CheckList(Elem) = ones(size(Elem));
1746                     CheckList = CheckList(dev2elem(<span class="string">'VCM'</span>,List));
1747                     newList = editlist(List, <span class="string">'VCM'</span>, CheckList);
1748                     <span class="keyword">if</span> isempty(newList)
1749                         fprintf(<span class="string">'   Vertical corrector magnet cannot be empty.  No change made.\n'</span>);
1750                     <span class="keyword">else</span>
1751                         VCMlist1 = newList;
1752                     <span class="keyword">end</span>
1753                 <span class="keyword">end</span>
1754 
1755                 <span class="keyword">if</span> EditFlag == 4
1756                     ListOld = BPMlist1;
1757                     XgoalOld = Xgoal;
1758                     YgoalOld = Ygoal;
1759 
1760                     <span class="comment">% Full BPM list</span>
1761                     List = <a href="getbpmlist.html" class="code" title="function [DeviceList, Index] = getbpmlist(varargin)">getbpmlist</a>(<span class="string">'Bergoz'</span>);
1762 <span class="comment">%                     List = [</span>
1763 <span class="comment">%                         1 2</span>
1764 <span class="comment">%                         1 5</span>
1765 <span class="comment">%                         1 6</span>
1766 <span class="comment">%                         1 10</span>
1767 <span class="comment">%                         2 1</span>
1768 <span class="comment">%                         2 5</span>
1769 <span class="comment">%                         2 6</span>
1770 <span class="comment">%                         2 9</span>
1771 <span class="comment">%                         3 2</span>
1772 <span class="comment">%                         3 5</span>
1773 <span class="comment">%                         3 6</span>
1774 <span class="comment">%                         3 10</span>
1775 <span class="comment">%                         3 11</span>
1776 <span class="comment">%                         3 12</span>
1777 <span class="comment">%                         4 1</span>
1778 <span class="comment">%                         4 5</span>
1779 <span class="comment">%                         4 6</span>
1780 <span class="comment">%                         4 10</span>
1781 <span class="comment">%                         5 1</span>
1782 <span class="comment">%                         5 5</span>
1783 <span class="comment">%                         5 6</span>
1784 <span class="comment">%                         5 10</span>
1785 <span class="comment">%                         5 11</span>
1786 <span class="comment">%                         5 12</span>
1787 <span class="comment">%                         6 1</span>
1788 <span class="comment">%                         6 5</span>
1789 <span class="comment">%                         6 6</span>
1790 <span class="comment">%                         6 10</span>
1791 <span class="comment">%                         7 1</span>
1792 <span class="comment">%                         7 5</span>
1793 <span class="comment">%                         7 6</span>
1794 <span class="comment">%                         7 10</span>
1795 <span class="comment">%                         8 1</span>
1796 <span class="comment">%                         8 5</span>
1797 <span class="comment">%                         8 6</span>
1798 <span class="comment">%                         8 10</span>
1799 <span class="comment">%                         9 1</span>
1800 <span class="comment">%                         9 5</span>
1801 <span class="comment">%                         9 6</span>
1802 <span class="comment">%                         9 10</span>
1803 <span class="comment">%                         10 1</span>
1804 <span class="comment">%                         10 5</span>
1805 <span class="comment">%                         10 6</span>
1806 <span class="comment">%                         10 10</span>
1807 <span class="comment">%                         10 11</span>
1808 <span class="comment">%                         10 12</span>
1809 <span class="comment">%                         11 1</span>
1810 <span class="comment">%                         11 5</span>
1811 <span class="comment">%                         11 6</span>
1812 <span class="comment">%                         11 10</span>
1813 <span class="comment">%                         12 1</span>
1814 <span class="comment">%                         12 5</span>
1815 <span class="comment">%                         12 6</span>
1816 <span class="comment">%                         12 9</span>
1817 <span class="comment">%                         ];</span>
1818 
1819                     CheckList = zeros(size(List,1),1);
1820                     <span class="keyword">if</span> ~isempty(BPMlist1)
1821                         <span class="keyword">for</span> i = 1:size(List,1)
1822                             k = find(List(i,1)==BPMlist1(:,1));
1823                             l = find(List(i,2)==BPMlist1(k,2));
1824 
1825                             <span class="keyword">if</span> isempty(k) || isempty(l)
1826                                 <span class="comment">% Item not in list</span>
1827                             <span class="keyword">else</span>
1828                                 CheckList(i) = 1;
1829                             <span class="keyword">end</span>
1830                         <span class="keyword">end</span>
1831                     <span class="keyword">end</span>
1832 
1833                     newList = editlist(List, <span class="string">'BPM'</span>, CheckList);
1834                     <span class="keyword">if</span> isempty(newList)
1835                         fprintf(<span class="string">'   BPM list cannot be empty.  No change made.\n'</span>);
1836                     <span class="keyword">else</span>
1837                         BPMlist1 = newList;
1838                     <span class="keyword">end</span>
1839 
1840                     <span class="comment">% Set the goal orbit to the golden orbit</span>
1841                     Xgoal = getgolden(<span class="string">'BPMx'</span>, BPMlist1);
1842                     Ygoal = getgolden(<span class="string">'BPMy'</span>, BPMlist1);
1843 
1844 
1845                     <span class="comment">% If a new BPM is added, then set the goal orbit to the golden orbit</span>
1846                     <span class="keyword">for</span> i = 1:size(BPMlist1,1)
1847 
1848                         <span class="comment">% Is it a new BPM?</span>
1849                         k = find(BPMlist1(i,1)==ListOld(:,1));
1850                         l = find(BPMlist1(i,2)==ListOld(k,2));
1851 
1852                         <span class="keyword">if</span> isempty(k) || isempty(l)
1853                             <span class="comment">% New BPM</span>
1854                         <span class="keyword">else</span>
1855                             <span class="comment">% Use the old value for old BPM</span>
1856                             Xgoal(i) = XgoalOld(k(l));
1857                             Ygoal(i) = YgoalOld(k(l));
1858                         <span class="keyword">end</span>
1859                     <span class="keyword">end</span>
1860                 <span class="keyword">end</span>
1861 
1862                 <span class="keyword">if</span> EditFlag == 5
1863 
1864                     ChangeList = editlist(BPMlist1, <span class="string">'Change BPM'</span>, zeros(size(BPMlist1,1),1));
1865                     <span class="keyword">for</span> i = 1:size(ChangeList,1)
1866 
1867                         k = find(ChangeList(i,1)==BPMlist1(:,1));
1868                         l = find(ChangeList(i,2)==BPMlist1(k,2));
1869 
1870                         prompt = {sprintf(<span class="string">'Enter the new horizontal goal orbit for BPMx(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2)),sprintf(<span class="string">'Enter the new vertical goal orbit for BPMy(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2))};
1871                         def = {sprintf(<span class="string">'%f'</span>,Xgoal(k(l))),sprintf(<span class="string">'%f'</span>,Ygoal(k(l)))};
1872                         titlestr = <span class="string">'CHANGE THE GOAL ORBIT'</span>;
1873                         lineNo = 1;
1874                         answer = inputdlg(prompt, titlestr, lineNo, def);
1875 
1876                         <span class="keyword">if</span> isempty(answer)
1877                             <span class="comment">% No change</span>
1878                             fprintf(<span class="string">'   No change was made to the golden orbit.\n'</span>);
1879                         <span class="keyword">else</span>
1880                             Xgoalnew = str2num(answer{1});
1881                             <span class="keyword">if</span> isempty(Xgoalnew)
1882                                 fprintf(<span class="string">'   No change was made to the horizontal golden orbit.\n'</span>);
1883                             <span class="keyword">else</span>
1884                                 Xgoal(k(l)) = Xgoalnew;
1885                             <span class="keyword">end</span>
1886 
1887                             Ygoalnew = str2num(answer{2});
1888                             <span class="keyword">if</span> isempty(Ygoalnew)
1889                                 fprintf(<span class="string">'   No change was made to the vertical golden orbit.\n'</span>);
1890                             <span class="keyword">else</span>
1891                                 Ygoal(k(l)) = Ygoalnew;
1892                             <span class="keyword">end</span>
1893                         <span class="keyword">end</span>
1894                     <span class="keyword">end</span>
1895                     <span class="keyword">if</span> ~isempty(ChangeList)
1896                         fprintf(<span class="string">'   Note:  changing the goal orbit for &quot;Orbit Correction&quot; does not change the goal orbit for &quot;Slow Orbit Feedback.&quot;\n'</span>);
1897                         fprintf(<span class="string">'          Re-running srcontrol will restart the goal orbit to the golden orbit.&quot;\n'</span>);
1898                     <span class="keyword">end</span>
1899                 <span class="keyword">end</span>
1900 
1901                 <span class="keyword">if</span> EditFlag == 6
1902                     List = [
1903                         1 1
1904                         2 1
1905                         3 1
1906                         4 1
1907                         4 2
1908                         5 1
1909                         6 1
1910                         6 2
1911                         7 1
1912                         8 1
1913                         9 1
1914                         10 1
1915                         11 1
1916                         11 2
1917                         12 1];
1918                     CheckList = zeros(size(List,1),1);
1919                     <span class="keyword">if</span> ~isempty(LocalBumplist)
1920                         <span class="keyword">for</span> i = 1:size(List,1)
1921                             k = find(List(i,1)==LocalBumplist(:,1));
1922                             l = find(List(i,2)==LocalBumplist(k,2));
1923 
1924                             <span class="keyword">if</span> isempty(k) || isempty(l)
1925                                 <span class="comment">% Item not in list</span>
1926                             <span class="keyword">else</span>
1927                                 CheckList(i) = 1;
1928                             <span class="keyword">end</span>
1929                         <span class="keyword">end</span>
1930                     <span class="keyword">end</span>
1931                     LocalBumplist = editlist2(List, <span class="string">'Sector'</span>, CheckList);
1932                 <span class="keyword">end</span>
1933 
1934                 <span class="keyword">if</span> EditFlag == 7
1935                     RFCorrFlag = questdlg(sprintf(<span class="string">'Set RF Frequency during Orbit Correction?'</span>),<span class="string">'RF Frequency'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>, <span class="string">'No'</span>);
1936                     <span class="keyword">if</span> strcmp(RFCorrFlag,<span class="string">'No'</span>)
1937                         disp([<span class="string">'   RF Frequency will not be included in global orbit correction.'</span>]);
1938                     <span class="keyword">elseif</span> strcmp(RFCorrFlag,<span class="string">'Yes'</span>)
1939                         disp([<span class="string">'   RF Frequency will be included in global orbit correction.'</span>]);
1940                     <span class="keyword">end</span>
1941 
1942                 <span class="keyword">end</span>
1943             <span class="keyword">end</span>
1944             close(h_fig1);
1945         <span class="keyword">end</span>
1946 
1947         <span class="comment">%  ORBIT CORRECTION STRUCTURE (OCS)</span>
1948         <span class="comment">%    OCS.BPM (data structure)</span>
1949         <span class="comment">%    OCS.CM  (data structure)</span>
1950         <span class="comment">%    OCS.GoalOrbit</span>
1951         <span class="comment">%    OCS.NIter</span>
1952         <span class="comment">%    OCS.SVDIndex</span>
1953         <span class="comment">%    OCS.IncrementalFlag = 'Yes'/'No'</span>
1954         <span class="comment">%    OCS.BPMWeight</span>
1955         <span class="comment">%    OCS.Flags = { 'FitRF' , etc. }</span>
1956         OCSx.BPM = getx(BPMlist1, <span class="string">'struct'</span>);
1957         OCSx.CM = getsp(<span class="string">'HCM'</span>, HCMlist1, <span class="string">'struct'</span>);
1958         OCSx.GoalOrbit = getgolden(OCSx.BPM, <span class="string">'numeric'</span>);
1959         OCSx.NIter = 1;
1960         OCSx.SVDIndex = Xivec;
1961         OCSx.IncrementalFlag = <span class="string">'No'</span>;
1962         OCSx.FitRF = 1;
1963         OCSy.BPM = gety(BPMlist1, <span class="string">'struct'</span>);
1964         OCSy.CM = getsp(<span class="string">'VCM'</span>, VCMlist1, <span class="string">'struct'</span>);
1965         OCSy.GoalOrbit = getgolden(OCSy.BPM, <span class="string">'numeric'</span>);
1966         OCSy.NIter = 1;
1967         OCSy.SVDIndex = Yivec;
1968         OCSy.IncrementalFlag = <span class="string">'No'</span>;
1969         OCSy.FitRF = 0;
1970 
1971         <span class="comment">% Save vectors</span>
1972         FB.OCSx = OCSx;
1973         FB.OCSy = OCSy;
1974 
1975         FB.BPMlist1 = BPMlist1;
1976         FB.HCMlist1 = HCMlist1;
1977         FB.VCMlist1 = VCMlist1;
1978         FB.Xivec = Xivec;
1979         FB.Yivec = Yivec;
1980         FB.Xgoal = OCSx.GoalOrbit;
1981         FB.Ygoal = OCSy.GoalOrbit;
1982         FB.RFCorrFlag = RFCorrFlag;
1983         FB.LocalBumplist = LocalBumplist;
1984         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>,FB);
1985         
1986         
1987     <span class="keyword">case</span> <span class="string">'Feedback'</span>
1988 
1989         FBloopIter = 1;
1990         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxFOFB'</span>),<span class="string">'Value'</span>) == 1
1991             StartFOFBFlag = 1;
1992         <span class="keyword">else</span>
1993             StartFOFBFlag = 0;
1994         <span class="keyword">end</span>
1995 
1996         FEEDBACK_STOP_FLAG = 0;
1997         HWarnNum=0;
1998         VWarnNum=0;
1999 
2000         SR_GeV = getenergy;
2001         <span class="comment">% Feedback loop setup</span>
2002         PlotInfoFlag = 0;           <span class="comment">% Plot micado stuff</span>
2003         LoopDelay = 1.0;           <span class="comment">% Period of feedback loop [seconds], make sure the BPM averaging is correct</span>
2004         VCM_LSB = .00366211;
2005         VCMCHICANE_LSB = .002441;   <span class="comment">% 80 max?,  Note: not fully implemented</span>
2006 
2007         <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
2008             Xgain  = 0.2;
2009             Ygain  = 0.1;
2010         <span class="keyword">else</span>
2011             Xgain  = 0.8; <span class="comment">% raised 0.5-&gt;0.8 at 17:20, 3-2-05 to more quickly correct EPU4 fast switching orbit distortions</span>
2012             Ygain  = 0.8;
2013         <span class="keyword">end</span>
2014 
2015         <span class="comment">% Load lattice set for tune feed forward</span>
2016         ConfigSetpoint = getproductionlattice;
2017         <span class="comment">%load([getfamilydata('Directory','OpsData') getfamilydata('OpsData','LatticeFile')]);</span>
2018         QFsp = ConfigSetpoint.QF.Setpoint.Data;
2019         QDsp = ConfigSetpoint.QD.Setpoint.Data;
2020         TuneW16Min = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>([5 1], 13.23, 1.8909);
2021         <span class="comment">% Tune response matrix</span>
2022         SR_TUNE_MATRIX = gettuneresp({<span class="string">'QF'</span>,<span class="string">'QD'</span>}, {[],[]}, getenergy(<span class="string">'Production'</span>));    <span class="comment">% Approx. [0.1944 -0.0286;-0.1182 0.1526];</span>
2023         <span class="comment">%SR_TUNE_MATRIX = [0.1641 -0.0245</span>
2024         <span class="comment">%                 -0.1149 0.1477];</span>
2025         
2026         SQSFsp = <a href="amp2k.html" class="code" title="function [k, B] = amp2k(Family, Field, Amps, DeviceList, Energy, BranchFlag)">amp2k</a>(<span class="string">'SQSF'</span>,<span class="string">'Setpoint'</span>,ConfigSetpoint.SQSF.Setpoint.Data);
2027         SQSDsp = <a href="amp2k.html" class="code" title="function [k, B] = amp2k(Family, Field, Amps, DeviceList, Energy, BranchFlag)">amp2k</a>(<span class="string">'SQSD'</span>,<span class="string">'Setpoint'</span>,ConfigSetpoint.SQSD.Setpoint.Data);
2028 
2029 <span class="comment">%         % tune FF for EPUs (data exist for 4 1 parallel, 11 1 parallel and antiparallel</span>
2030 <span class="comment">%         load '/home/als/physdata/matlab/srdata/gaptrack/EPU4-1_tunecomp/after_shimming/nux_map_withgaps.mat'</span>
2031 <span class="comment">%         dnux_epu_41_m0 = tunexmap(2:end,2:end)-tunexmap(2,12);</span>
2032 <span class="comment">%         [gap_epu_41,shift_epu_41]=meshgrid(tunexmap(2:end,1),tunexmap(1,2:end));</span>
2033 <span class="comment">%         load '/home/als/physdata/matlab/srdata/gaptrack/EPU4-1_tunecomp/after_shimming/nuy_map_withgaps.mat'</span>
2034 <span class="comment">%         dnuy_epu_41_m0 = tuneymap(2:end,2:end)-tuneymap(2,12);</span>
2035 <span class="comment">%</span>
2036 <span class="comment">%         load '/home/als/physdata/matlab/srdata/gaptrack/archive/epu11d1m0e19_2007-01-28.mat' tune_x tune_y Gaps GapsLongitudinal</span>
2037 <span class="comment">%         dnux_epu_111_m0 = tune_x-tune_x(1,11);</span>
2038 <span class="comment">%         [gap_epu_111,shift_epu_111]=meshgrid(Gaps,GapsLongitudinal);</span>
2039 <span class="comment">%         dnuy_epu_111_m0 = tune_y-tune_y(1,11);</span>
2040 <span class="comment">%         load '/home/als/physdata/matlab/srdata/gaptrack/archive/epu11d1m1e19_2007-01-28.mat' tune_x tune_y Gaps GapsLongitudinal</span>
2041 <span class="comment">%         dnux_epu_111_m1 = tune_x-tune_x(1,11);</span>
2042 <span class="comment">%         dnuy_epu_111_m1 = tune_y-tune_y(1,11);</span>
2043 
2044         <span class="comment">% tune FF for EPUs (data exist for 4 1 parallel, 11 1 parallel and antiparallel</span>
2045         load <span class="string">'/home/als/physdata/matlab/srdata/epu/tuneshift_2d_tables/epu_tunetables_2d_20070723.mat'</span>
2046         dnux41p = nux41p-nux41p(1,11);      
2047         dnuy41p = nuy41p-nuy41p(1,11);      
2048         dnux41a = nux41a-nux41a(1,11);      
2049         dnuy41a = nuy41a-nuy41a(1,11);      
2050         dnux111p = nux111p-nux111p(1,11);      
2051         dnuy111p = nuy111p-nuy111p(1,11);      
2052         dnux111a = nux111a-nux111a(1,11);      
2053         dnuy111a = nuy111a-nuy111a(1,11);      
2054         dnux112p = nux112p-nux112p(1,11);      
2055         dnuy112p = nuy112p-nuy112p(1,11);      
2056         dnux112a = nux112a-nux112a(1,11);      
2057         dnuy112a = nuy112a-nuy112a(1,11);      
2058         
2059         <span class="comment">% ID tune compensation does not work in the injection lattice, so ...</span>
2060         <span class="keyword">if</span> abs(SR_GEV - <a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>)&gt;  0.05     <span class="comment">% Don't use this routine for the injection lattice</span>
2061             fprintf(<span class="string">'   This routine should only be used for the production energy: Orbit feedback aborted\n'</span>);
2062             <span class="keyword">return</span>
2063         <span class="keyword">end</span>
2064 
2065         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
2066 
2067         <span class="keyword">try</span>
2068             fprintf(<span class="string">'\n'</span>);
2069             fprintf(<span class="string">'   *******************************\n'</span>);
2070             fprintf(<span class="string">'   **  Starting Orbit Feedback  **\n'</span>);
2071             fprintf(<span class="string">'   *******************************\n'</span>);
2072             a = clock;
2073             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2074             fprintf(<span class="string">'   Note: the Matlab command window will be used to display status information.\n'</span>);
2075             fprintf(<span class="string">'         It cannot be used to enter commands during slow orbit feedback.\n'</span>);
2076 
2077 
2078                 <span class="comment">% save current BPM timeconstant - will reset to this when feedback stops</span>
2079                 BPMtimeconstantOFB = <a href="getbpmtimeconstant.html" class="code" title="function [BPMTimeConstant, WarningFlag] = getbpmtimeconstant(varargin)">getbpmtimeconstant</a>;
2080                 fprintf(<span class="string">'   Current Bergoz BPM time constant is %.1fs\n'</span>, BPMtimeconstantOFB);
2081                 
2082             <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
2083             disp(<span class="string">'   Bergoz BPM time constant set to 0.2s.'</span>)
2084             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.2)
2085             pause(1.1);
2086 
2087             <span class="comment">% Check whether bumps and kickers are on and warn to turn off before starting feedback if necessary</span>
2088             <span class="keyword">try</span>
2089                 <span class="keyword">if</span> (getsp(<span class="string">'SR01S___BUMP1__BC21'</span>)==1 &amp;&amp; getsp(<span class="string">'SR01S___BUMP1P_BC22'</span>)==1) || (getsp(<span class="string">'SR01S___SEK____BC21'</span>)==1 &amp;&amp; getsp(<span class="string">'SR01S___SEK_P__BC23'</span>)==1) || (getsp(<span class="string">'SR01S___SEN____BC20'</span>)==1 &amp;&amp; getsp(<span class="string">'SR01S___SEN_P__BC22'</span>)==1)
2090                     soundtada;
2091                     fprintf(<span class="string">'   \n'</span>);
2092                     fprintf(<span class="string">'   *********************************************************************************\n'</span>);
2093                     fprintf(<span class="string">'   ** One or more of the pulsed SR injection magnets is still on!  Turn them off! **\n'</span>);
2094                     fprintf(<span class="string">'   *********************************************************************************\n'</span>);
2095                     fprintf(<span class="string">'   \n'</span>);
2096                 <span class="keyword">end</span>
2097             <span class="keyword">catch</span>
2098                 disp(<span class="string">'**Problem checking the state of the bumps and kickers - please check that they are not pulsing.'</span>);
2099             <span class="keyword">end</span>
2100 
2101             <span class="comment">% Get vectors</span>
2102 
2103             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
2104 
2105             BPMlist1 = FB.OCSx.BPM.DeviceList;
2106             <span class="comment">% FOFB_BPMlist =</span>
2107             HCMlist1 = FB.HCMlist1;
2108             VCMlist1 = FB.VCMlist1;
2109             Xivec = FB.Xivec;
2110             Yivec = FB.Yivec;
2111             Xgoal = FB.OCSx.GoalOrbit;
2112             Ygoal = FB.OCSy.GoalOrbit;
2113             FFTypeFlag = FB.FFTypeFlag;   <span class="comment">%local or global tune correction</span>
2114 
2115             iNotHCMChicane = find(HCMlist1(:,2) &lt; 10); <span class="comment">%used by steppv's for setting correctors in loop</span>
2116             iHCMChicane = find(HCMlist1(:,2) == 10);
2117             iNotVCMChicane = find(VCMlist1(:,2) &lt; 10);
2118             iVCMChicane = find(VCMlist1(:,2) == 10);
2119 
2120             <span class="comment">% Sensitivity matrix for setting fast feedback setpoints</span>
2121             Sx1 = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
2122             Sy1 = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
2123 
2124         <span class="keyword">catch</span>
2125             fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
2126 
2127             <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2128             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2129             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2130 
2131 
2132             a = clock;
2133             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2134             fprintf(<span class="string">'   *************************************************************\n'</span>);
2135             fprintf(<span class="string">'   **  Orbit feedback could not start due to error condition  **\n'</span>);
2136             fprintf(<span class="string">'   *************************************************************\n\n'</span>);
2137             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
2138             pause(0);
2139 
2140             <span class="keyword">return</span>
2141         <span class="keyword">end</span>
2142 
2143         StartFlag = questdlg(strvcat(<span class="string">''</span>,<span class="string">'Is it OK to start orbit feedback?'</span>),<span class="string">'Orbit Feedback'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
2144         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
2145             <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2146             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2147             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2148 
2149             a = clock;
2150             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2151             fprintf(<span class="string">'   ***************************\n'</span>);
2152             fprintf(<span class="string">'   **  Orbit Feedback Exit  **\n'</span>);
2153             fprintf(<span class="string">'   ***************************\n\n'</span>);
2154             pause(0);
2155             <span class="keyword">return</span>
2156         <span class="keyword">end</span>
2157 
2158         SR_STATE_OLD = scaget(<span class="string">'SR_STATE'</span>);
2159         setpv(<span class="string">'SR_STATE'</span>, 5);
2160         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
2161         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2162         <span class="keyword">if</span> StateNumber &gt;= 0
2163             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2164         <span class="keyword">else</span>
2165             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2166         <span class="keyword">end</span>
2167         fprintf(<span class="string">'   Using %d E-vectors horizontally.\n'</span>, length(Xivec));
2168         fprintf(<span class="string">'   Using %d E-vectors vertically.\n'</span>,   length(Yivec));
2169         fprintf(<span class="string">'   Starting slow orbit correction every %.1f seconds.\n'</span>, LoopDelay);
2170         <span class="comment">%  fprintf('   Resetting SR11 chicane motors every 20 seconds to fix drift problem.\n');</span>
2171 
2172         IDSector = getlist(<span class="string">'ID'</span>);
2173         EPUlist = find((IDSector(:,1)==4) | (IDSector(:,1)==11));
2174         oldgap=210*ones(size(IDSector,1),1);
2175         oldShift=zeros(size(oldgap));
2176           
2177         <span class="keyword">try</span>
2178             
2179             <span class="comment">% Get and display data</span>
2180             x = FB.OCSx.GoalOrbit - getx(FB.OCSx.BPM.DeviceList);
2181             y = FB.OCSy.GoalOrbit - gety(FB.OCSy.BPM.DeviceList);
2182             STDx = norm(x)/sqrt(length(x));
2183             STDy = norm(y)/sqrt(length(y));
2184             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = %.4f mm'</span>,STDx),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2185             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = %.4f mm'</span>,STDy),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2186 
2187             <span class="comment">% write goldenorbit values to Fast Orbit Feedback</span>
2188             <span class="keyword">try</span>
2189                 <a href="write_goldenorbit_ffb.html" class="code" title="function write_goldenorbit_ffb">write_goldenorbit_ffb</a>;
2190             <span class="keyword">catch</span>
2191                 disp(<span class="string">'write_goldenorbit_ffb did not work!'</span>);
2192             <span class="keyword">end</span>
2193             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2194             <span class="comment">%pause(0);</span>
2195 
2196             <span class="comment">%display state of FOFB system</span>
2197             FOFBStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2198                 getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2199                 getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2200                 getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2201             FOFBStatusStr = [<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>];
2202             <span class="keyword">for</span> loop = 1:size(FOFBStatus,2)
2203                 <span class="keyword">if</span> FOFBStatus(loop)==0
2204                     FOFBStatusStr(loop,:) = <span class="string">'OFF '</span>;
2205                 <span class="keyword">elseif</span> FOFBStatus(loop)==1
2206                     FOFBStatusStr(loop,:) = <span class="string">'ON  '</span>;
2207                 <span class="keyword">elseif</span> FOFBStatus(loop)==2
2208                     FOFBStatusStr(loop,:) = <span class="string">'OPEN'</span>;
2209                 <span class="keyword">else</span>
2210                     FOFBStatusStr(loop,:) = <span class="string">'BAD '</span>;
2211                 <span class="keyword">end</span>
2212             <span class="keyword">end</span>
2213             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 %s'</span>,FOFBStatusStr(1,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2214             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 %s'</span>,FOFBStatusStr(2,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2215             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 %s'</span>,FOFBStatusStr(3,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2216             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 %s'</span>,FOFBStatusStr(4,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2217             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 %s'</span>,FOFBStatusStr(5,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2218             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 %s'</span>,FOFBStatusStr(6,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2219             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 %s'</span>,FOFBStatusStr(7,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2220             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 %s'</span>,FOFBStatusStr(8,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2221             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 %s'</span>,FOFBStatusStr(9,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2222             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 %s'</span>,FOFBStatusStr(10,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2223             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 %s'</span>,FOFBStatusStr(11,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2224             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 %s'</span>,FOFBStatusStr(12,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2225 
2226         <span class="keyword">catch</span>
2227 
2228             fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
2229 
2230             <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2231             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2232             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2233 
2234 
2235             a = clock;
2236             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2237             fprintf(<span class="string">'   *************************************************************\n'</span>);
2238             fprintf(<span class="string">'   **  Orbit feedback could not start due to error condition  **\n'</span>);
2239             fprintf(<span class="string">'   *************************************************************\n\n'</span>);
2240 
2241             setpv(<span class="string">'SR_STATE'</span>,SR_STATE_OLD);
2242             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2243             <span class="keyword">if</span> StateNumber &gt;= 0
2244                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2245             <span class="keyword">else</span>
2246                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2247             <span class="keyword">end</span>
2248             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
2249             pause(0);
2250 
2251             <span class="keyword">return</span>
2252 
2253         <span class="keyword">end</span>
2254 
2255 
2256         <span class="comment">% Disable buttons</span>
2257         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
2258         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2259         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2260         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2261         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2262         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2263         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2264         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2265         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2266         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2267         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2268         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2269         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2270         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2271         pause(0);
2272 
2273 
2274         <span class="comment">% Initialize feedback loop</span>
2275         StartTime = gettime;
2276         StartErrorTime = gettime;
2277         Xold = getx(FB.OCSx.BPM.DeviceList);
2278         Yold = gety(FB.OCSy.BPM.DeviceList);
2279         HQMOFM_stalenum = 0;
2280         pause(LoopDelay);
2281 
2282         N_HCM = size(HCMlist1,1);
2283         N_VCM = size(VCMlist1,1);
2284 
2285         N_RFMO = 1;
2286 
2287         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
2288             [FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,<span class="string">'SetRF'</span>,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2289         <span class="keyword">else</span>
2290             [FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2291         <span class="keyword">end</span>
2292         [FB.OCSx, Smatx, Sx, Ux, Vx] = orbitcorrectionmethods(FB.OCSx);
2293 
2294         [FB.OCSy, junk, OCSy0] = setorbit(FB.OCSy,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2295         [FB.OCSy, Smaty, Sy, Uy, Vy] = orbitcorrectionmethods(FB.OCSy);
2296 
2297 
2298         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2299         <span class="comment">% Start feedback loop %</span>
2300         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2301 
2302         <span class="comment">% chicaneloop=1;  % loop variable for resetting drifting chicanes (see a few lines below)</span>
2303         <span class="comment">% fftest=figure;</span>
2304 
2305         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2); <span class="comment">% put FOFB in open loop so beamnoise gets recorded even if FOFB is not enabled</span>
2306 
2307         <span class="keyword">while</span> 1
2308             <span class="keyword">try</span>
2309                 t00 = gettime;
2310 
2311                 <span class="comment">%          if chicaneloop==20 % reset SR11 motor chicane setpoints every 20s due to drifting positions</span>
2312                 <span class="comment">%             setsp('HCMCHICANEM',HCMCHICANEMsp(6),[11 1],0);</span>
2313                 <span class="comment">%             setsp('HCMCHICANEM',HCMCHICANEMsp(7),[11 2],0);</span>
2314                 <span class="comment">%             chicaneloop = 1;</span>
2315                 <span class="comment">%          else</span>
2316                 <span class="comment">%             chicaneloop = chicaneloop + 1;</span>
2317                 <span class="comment">%          end</span>
2318 
2319                 <span class="comment">% Check if GUI has been closed</span>
2320                 <span class="keyword">if</span> isempty(gcbf)
2321                     FEEDBACK_STOP_FLAG = 1;
2322                     lasterr(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2323                     error(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2324                 <span class="keyword">end</span>
2325 
2326                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2327                 <span class="comment">% Fast orbit feedback %</span>
2328                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2329                 <span class="keyword">if</span> StartFOFBFlag == 1 &amp;&amp; FBloopIter &gt; 3
2330                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2331                     pause(0.5);
2332                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,1);
2333                     StartFOFBFlag = 0;
2334                     pause(1);
2335                     FOFBOnStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2336                         getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2337                         getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2338                         getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2339                     <span class="keyword">if</span> any(FOFBOnStatus==0) || any(FOFBOnStatus==2)
2340                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2); <span class="comment">% open FOFB loop</span>
2341                         disp(<span class="string">'************************************************************************************************************'</span>);
2342                         disp(<span class="string">'** Problem turning on Fast Orbit Feedback system...                                                       **'</span>);
2343                         disp(<span class="string">'** Check status of ffbsecXX crates - but remember that a crate reboot will turn off Quads in that sector! **'</span>);
2344                         disp(<span class="string">'** Suggest disabling the &quot;Fast Orbit Correction&quot; checkbox and starting Orbit Feedback again.              **'</span>);
2345                         disp(<span class="string">'************************************************************************************************************'</span>);
2346                     <span class="keyword">else</span>
2347                         fprintf(<span class="string">'   Starting Fast Orbit Feedback at %.0f Hz.\n'</span>, getpv(<span class="string">'SR01____FFBFREQAM00'</span>));
2348                     <span class="keyword">end</span>
2349                 <span class="keyword">end</span>
2350 
2351 
2352                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2353                 <span class="comment">% Horizontal plane &quot;feedback&quot; %</span>
2354                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2355 
2356                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxSOFB'</span>),<span class="string">'Value'</span>) == 1
2357 
2358                     <span class="comment">% Get orbit and check that the BPMs are different from the last update</span>
2359                     Xnew = getx(FB.OCSx.BPM.DeviceList);
2360 
2361                     <span class="comment">% Don't feedback if the current is too small</span>
2362                     <span class="keyword">if</span> getdcct &lt; 2
2363                         FEEDBACK_STOP_FLAG = 1;
2364                         fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2365                         <span class="keyword">break</span>;
2366                     <span class="keyword">end</span>
2367 
2368                     x = Xgoal - Xnew;
2369                     STDx = norm(x)/sqrt(length(x));
2370 
2371                     <span class="keyword">if</span> any(Xold == Xnew)
2372                         a = clock;
2373                         N_Stale_Data_Points = find((Xold==Xnew)==1);
2374                         <span class="keyword">for</span> loop = N_Stale_Data_Points'
2375                             fprintf(<span class="string">'   Stale data: BPMx(%2d,%d), feedback step skipped (%s %d:%d:%.0f). \n'</span>, FB.OCSx.BPM.DeviceList(loop,1), FB.OCSx.BPM.DeviceList(loop,2), date, a(4), a(5), a(6));
2376                         <span class="keyword">end</span>
2377                     <span class="keyword">else</span>
2378                         <span class="comment">% Compute horizontal correction</span>
2379                         <span class="comment">%%%OCSx0 = FB.OCSx;</span>
2380                         FB.OCSx.BPM.Data = Xnew;
2381                         FB.OCSx = orbitcorrectionmethods(FB.OCSx, Smatx, Sx, Ux, Vx);
2382 
2383                         <span class="comment">%%%[FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,'Nodisplay','Nosetsp');</span>
2384 
2385                         <span class="comment">% reduced feedback gain (implemented by Greg Portmann, December 2000)</span>
2386                         <span class="comment">% reduced to 0.1, C. Steier, 2001-09-04, IDBPMs are noisy at the moment</span>
2387                         <span class="comment">% increased back to 0.8 C. Steier, 2001-09-29, IDBPMs filtering + direct DAC read/write + all SVDs (no arc BPMs)</span>
2388                         <span class="comment">% increased to 1.0, C. Steier, 2002-05-04, trim DACs</span>
2389                                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2390                                 <span class="comment">% should probably actively allocate X's size to prevent possible memory leak %</span>
2391                                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2392                         X = [Xgain .* FB.OCSx.CM.Delta; 0.3*FB.OCSx.DeltaRF/4.988e-3];
2393                         
2394                         <span class="comment">%%%X = Xgain .* (FB.OCSx.CM.Data - OCSx0.CM.Data);</span>
2395 
2396                         <span class="comment">% check corrector trim values + next step values, warn or stop FB as necessary</span>
2397                         HCMtrimSP=getpv(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1);
2398                         HCMtrimSP_next = HCMtrimSP + X(1:N_HCM);
2399                         <span class="keyword">if</span> max(abs(HCMtrimSP_next)) &gt; 4
2400                             HCMtrimnum=find(abs(HCMtrimSP_next) &gt; 4);
2401 
2402                             <span class="comment">% print message to screen</span>
2403                             fprintf(<span class="string">'\n'</span>);
2404                             fprintf(<span class="string">'***One or more of the horizontal correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2405                             fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2406                             <span class="keyword">for</span> loop = HCMtrimnum'
2407                                 fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1(loop,:)));
2408                             <span class="keyword">end</span>
2409 
2410                             <span class="comment">% send alphapage to operator pager</span>
2411                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2412                             FEEDBACK_STOP_FLAG = 1;
2413 
2414                             setpv(<span class="string">'SR_STATE'</span>, -5);
2415                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2416                             <span class="keyword">if</span> StateNumber &gt;= 0
2417                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2418                             <span class="keyword">else</span>
2419                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2420                             <span class="keyword">end</span>
2421                         <span class="keyword">end</span>
2422 
2423                         <span class="comment">% check chicane trim coil values + next step values, warn or stop FB as necessary</span>
2424                         HCMCHICANEtrimSP=getpv(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>,HCMlist1(iHCMChicane,:));
2425                         HCMCHICANEtrimSP_next = HCMCHICANEtrimSP + X(iHCMChicane);
2426                         <span class="keyword">if</span> max(abs(HCMCHICANEtrimSP_next)) &gt; 19.9
2427                             HCMCHICANEtrimnum=find(abs(HCMCHICANEtrimSP_next) &gt; 19.9);
2428 
2429                             <span class="comment">% print message to screen</span>
2430                             fprintf(<span class="string">'\n'</span>);
2431                             fprintf(<span class="string">'***One or more of the horizontal chicane trim coil correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2432                             fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2433                             <span class="keyword">for</span> loop = HCMCHICANEtrimnum'
2434                                 fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>,HCMlist1(iHCMChicane(loop,:),:)));
2435                             <span class="keyword">end</span>
2436                             fprintf(<span class="string">'***Maybe try resetting the setpoints of the motor chicanes in case they are drifting...\n'</span>);
2437 
2438                             <span class="comment">% send alphapage to operator pager</span>
2439                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2440                             FEEDBACK_STOP_FLAG = 1;
2441 
2442                             setpv(<span class="string">'SR_STATE'</span>, -5);
2443                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2444                             <span class="keyword">if</span> StateNumber &gt;= 0
2445                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2446                             <span class="keyword">else</span>
2447                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2448                             <span class="keyword">end</span>
2449                         <span class="keyword">end</span>
2450 
2451                         <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2452                             <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2453                             <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2454                                 disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2455                             <span class="keyword">end</span>
2456                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2457                             pause(0.5);
2458                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2459                             <span class="keyword">break</span>;
2460                         <span class="keyword">end</span>
2461 
2462                         <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2463                         pause(0);
2464 
2465                         <span class="keyword">if</span> max(abs(HCMtrimSP_next) &gt; 3)
2466                             HCMtrimnum=find(abs(HCMtrimSP_next) &gt; 3);
2467                             HWarnNum=HWarnNum+1;
2468                             <span class="keyword">if</span> (HWarnNum==1 || rem(HWarnNum,120)==0)
2469 
2470                                 <span class="comment">% print message to screen every two minutes</span>
2471                                 fprintf(<span class="string">'\n'</span>);
2472                                 fprintf(<span class="string">'***One or more of the horizontal corrector trims is above 3A or below -3A! \n'</span>);
2473                                 fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2474                                 <span class="keyword">for</span> loop = HCMtrimnum'
2475                                     fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1(loop,:)));
2476                                 <span class="keyword">end</span>
2477                                 fprintf(<span class="string">'***The orbit feedback is still working but this problem should be investigated. \n'</span>);
2478 
2479                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2480                                 <span class="keyword">if</span> (HWarnNum==1 || HWarnNum==600)
2481                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageHCM.txt
2482                                 <span class="keyword">end</span>
2483                             <span class="keyword">end</span>
2484                         <span class="keyword">elseif</span> max(abs(HCMCHICANEtrimSP_next) &gt; 15)
2485                             HCMCHICANEtrimnum=find(abs(HCMCHICANEtrimSP_next) &gt; 15);
2486                             HWarnNum=HWarnNum+1;
2487                             <span class="keyword">if</span> (HWarnNum==1 || rem(HWarnNum,120)==0)
2488 
2489                                 <span class="comment">% print message to screen every two minutes</span>
2490                                 fprintf(<span class="string">'\n'</span>);
2491                                 fprintf(<span class="string">'***One or more of the horizontal chicane corrector trim coils is above 15A or below -15A! \n'</span>);
2492                                 fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2493                                 <span class="keyword">for</span> loop = HCMCHICANEtrimnum'
2494                                     fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>,HCMlist1(iHCMChicane(loop,:),:)));
2495                                 <span class="keyword">end</span>
2496                                 fprintf(<span class="string">'***The orbit feedback is still working but this problem should be investigated. \n'</span>);
2497                                 
2498                                 <span class="comment">%reset motor chicanes in case they are drifting</span>
2499                                 <span class="keyword">try</span>
2500                                     <span class="comment">%                                     if HCMCHICANEtrimnum(1)==1</span>
2501                                     <span class="comment">%                                         if HCMCHICANEtrimSP_next(1)&gt;15</span>
2502                                     <span class="comment">%                                             steppv('HCMCHICANEM',-0.5,[4 1;4 2]);</span>
2503                                     <span class="comment">%                                         elseif HCMCHICANEtrimSP_next(1)&lt;(-15)</span>
2504                                     <span class="comment">%                                             steppv('HCMCHICANEM',0.5,[4 1;4 2]);</span>
2505                                     <span class="comment">%                                         end</span>
2506                                     <span class="comment">%                                     end</span>
2507                                     fprintf(<span class="string">'   Resetting the setpoints of the motor chicanes in case they are drifting...\n'</span>);
2508                                     setpv(<span class="string">'HCMCHICANEM'</span>,<span class="string">'Setpoint'</span>,ConfigSetpoint.HCMCHICANEM.Setpoint.Data,[],0);
2509                                 <span class="keyword">catch</span>
2510                                 <span class="keyword">end</span>
2511 
2512                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2513                                 <span class="keyword">if</span> (HWarnNum==1 || HWarnNum==600)
2514                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageHCMCHICANE.txt
2515                                 <span class="keyword">end</span>
2516                             <span class="keyword">end</span>
2517                         <span class="keyword">else</span>
2518                             HWarnNum=0;
2519                         <span class="keyword">end</span>
2520 
2521                         <span class="comment">% Don't feedback if the current is too small</span>
2522                         <span class="keyword">if</span> getdcct &lt; 2
2523                             FEEDBACK_STOP_FLAG = 1;
2524                             fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2525                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/beamisoff.txt
2526                             <span class="keyword">break</span>;
2527                         <span class="keyword">end</span>
2528 
2529                         <span class="keyword">if</span> N_HCM &gt; 0
2530                             steppv(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>, X(iNotHCMChicane), HCMlist1(iNotHCMChicane,:), 0);
2531                             steppv(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>, X(iHCMChicane), HCMlist1(iHCMChicane,:), 0);
2532                         <span class="keyword">end</span>
2533 
2534                         <span class="comment">% write fast orbit feedback setpoints</span>
2535                         <span class="keyword">if</span> 1
2536                             <span class="comment">%write_goldenorbit_ffb_2planes(1, Xnew(1:size(BPMlist1,1))+Sx1*X(1:N_HCM)+Sx3*X(length(X))/20, BPMlist1);</span>
2537                             <span class="comment">% should be corrected to include result of next frequency step ...</span>
2538                             <a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>(1,Xnew(1:size(BPMlist1,1))+Sx1*X(1:N_HCM),BPMlist1);
2539                         <span class="keyword">end</span>
2540 
2541                         <span class="comment">%fprintf('Horizontal Done: %f \n',gettime-t00);</span>
2542 
2543                         <span class="comment">% RF feedback</span>
2544                         HQMOFMsp_last = getpv(<span class="string">'EG______HQMOFM_AC01'</span>);
2545 
2546                         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
2547                             <span class="keyword">if</span> N_RFMO &gt; 0
2548                                 <span class="keyword">if</span> abs(X(end)) &lt; .01
2549                                     <span class="comment">% if abs(FB.OCSx.DeltaRF/3) &lt; .01</span>
2550                                     steppv(<span class="string">'EG______HQMOFM_AC01'</span>, X(end));
2551                                 <span class="keyword">else</span>
2552                                     steppv(<span class="string">'EG______HQMOFM_AC01'</span>, 0.01*sign(X(end)));
2553                                 <span class="keyword">end</span>
2554                             <span class="keyword">end</span>
2555 
2556                             HQMOFMsp_now = getpv(<span class="string">'EG______HQMOFM_AC01'</span>);
2557 
2558                             <span class="comment">% Check for stale RF feedback</span>
2559                             <span class="keyword">if</span> HQMOFMsp_last == HQMOFMsp_now
2560                                 HQMOFM_stalenum = HQMOFM_stalenum + 1;
2561                                 <span class="keyword">if</span> HQMOFM_stalenum == 30 <span class="comment">% warn and message to pager if stale for 30 secs</span>
2562                                     fprintf(<span class="string">'\n'</span>);
2563                                     fprintf(<span class="string">'***The RF is not responding to orbit feedback changes! \n'</span>);
2564                                     fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2565                                     fprintf(<span class="string">'***The orbit feedback is still working but this problem should be investigated. \n'</span>);
2566                                     fprintf(<span class="string">'***ILC 73 controls the EG______HQMOFM_AC01 channel, which sets the RF frequency. \n'</span>);
2567                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstaleRFmessage.txt
2568                                 <span class="keyword">end</span>
2569                                 <span class="keyword">if</span> rem(HQMOFM_stalenum,120)==0 <span class="comment">% message to screen every 2 minutes</span>
2570                                     fprintf(<span class="string">'\n'</span>);
2571                                     fprintf(<span class="string">'***The RF is not responding to orbit feedback changes! (%s)\n'</span>,datestr(now));
2572                                 <span class="keyword">end</span>
2573                             <span class="keyword">else</span>
2574                                 HQMOFM_stalenum = 0;
2575                             <span class="keyword">end</span>
2576 
2577                         <span class="keyword">end</span>
2578 
2579                         <span class="comment">%fprintf('RF Done: %f \n',gettime-t00);</span>
2580 
2581                         Xold = Xnew;
2582                     <span class="keyword">end</span> <span class="comment">% End horizontal correction</span>
2583 
2584 
2585                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2586                     <span class="comment">% Vertical plane &quot;feedback&quot; %</span>
2587                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2588 
2589                     <span class="comment">% Get orbit and check that the BPMs are different from the last update</span>
2590                     Ynew = gety(FB.OCSy.BPM.DeviceList);
2591 
2592                     <span class="comment">% Don't feedback if the current is too small</span>
2593                     <span class="keyword">if</span> getdcct &lt; 2
2594                         FEEDBACK_STOP_FLAG = 1;
2595                         fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2596                         <span class="keyword">break</span>;
2597                     <span class="keyword">end</span>
2598 
2599                     y = Ygoal - Ynew;
2600                     STDy = norm(y)/sqrt(length(y));
2601 
2602                     <span class="keyword">if</span> any(Yold == Ynew)
2603                         a = clock;
2604                         N_Stale_Data_Points = find((Yold==Ynew)==1);
2605                         <span class="keyword">for</span> loop = N_Stale_Data_Points'
2606                             fprintf(<span class="string">'   Stale data: BPMy(%2d,%d), feedback step skipped (%s %d:%d:%.0f). \n'</span>, FB.OCSy.BPM.DeviceList(loop,1), FB.OCSy.BPM.DeviceList(loop,2), date, a(4), a(5), a(6));
2607                         <span class="keyword">end</span>
2608 
2609                     <span class="keyword">else</span>
2610 
2611                         <span class="comment">% Compute vertical correction</span>
2612                         <span class="comment">%%%OCSy0 = FB.OCSy;</span>
2613                         FB.OCSy.BPM.Data = Ynew;
2614                         FB.OCSy = orbitcorrectionmethods(FB.OCSy, Smaty, Sy, Uy, Vy);
2615 
2616                         <span class="comment">%%%[FB.OCSy, RF, OCSy0] = setorbit(FB.OCSy,'Nodisplay','Nosetsp');</span>
2617 
2618                         <span class="comment">% reduced feedback gain, C. Steier, 2001-03-25</span>
2619                         <span class="comment">% reduced to 0.1, C. Steier, 2001-09-04, IDBPMs are noisy at the moment</span>
2620                         <span class="comment">% increased back to 0.8, C. Steier, 2001-09-29, IDBPMs filtering + direct DAC read/write + all SVDs (no arc BPMs)</span>
2621                         <span class="comment">% set to unity gain, C. Steier, 2002-05-04, trim DACs</span>
2622                         Y = Ygain .* FB.OCSy.CM.Delta;
2623                         <span class="comment">%%%Y = Ygain .* (FB.OCSy.CM.Data - OCSy0.CM.Data);</span>
2624 
2625                         <span class="comment">% Just SVD correction</span>
2626                         <span class="comment">% warning('Not using &quot;micado&quot; correction in the vertical plane.');</span>
2627 
2628                         <span class="comment">% check for trim values+next step values, warn or stop FB as necessary</span>
2629                         VCMtrimSP = getpv(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1);
2630                         VCMtrimSP_next = VCMtrimSP + Y(1:N_VCM);
2631                         <span class="keyword">if</span> max(abs(VCMtrimSP_next)) &gt; 12
2632                             VCMtrimnum=find(abs(VCMtrimSP_next) &gt; 12);
2633 
2634                             <span class="comment">% print message to screen</span>
2635                             fprintf(<span class="string">'\n'</span>);
2636                             fprintf(<span class="string">'***One or more of the vertical correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2637                             fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2638                             <span class="keyword">for</span> loop = VCMtrimnum'
2639                                 fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1(loop,:)));
2640                             <span class="keyword">end</span>
2641 
2642                             <span class="comment">% send alphapage to operator pager</span>
2643                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2644                             FEEDBACK_STOP_FLAG = 1;
2645 
2646                             setpv(<span class="string">'SR_STATE'</span>, -5);
2647                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2648                             <span class="keyword">if</span> StateNumber &gt;= 0
2649                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2650                             <span class="keyword">else</span>
2651                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2652                             <span class="keyword">end</span>
2653                         <span class="keyword">end</span>
2654 
2655                         <span class="comment">% check chicane trim coil values + next step values, warn or stop FB as necessary</span>
2656                         VCMCHICANEtrimSP=getpv(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>,VCMlist1(iVCMChicane,:));
2657                         VCMCHICANEtrimSP_next = VCMCHICANEtrimSP + Y(iVCMChicane);
2658                         <span class="keyword">if</span> max(abs(VCMCHICANEtrimSP_next)) &gt; 19.9
2659                             VCMCHICANEtrimnum=find(abs(VCMCHICANEtrimSP_next) &gt; 19.9);
2660 
2661                             <span class="comment">% print message to screen</span>
2662                             fprintf(<span class="string">'\n'</span>);
2663                             fprintf(<span class="string">'***One or more of the vertical chicane trim coil correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2664                             fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2665                             <span class="keyword">for</span> loop = VCMCHICANEtrimnum'
2666                                 fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>,VCMlist1(iVCMChicane(loop,:),:)));
2667                             <span class="keyword">end</span>
2668                             fprintf(<span class="string">'***Maybe try resetting the setpoints of the motor chicanes in case they are drifting...\n'</span>);
2669 
2670                             <span class="comment">% send alphapage to operator pager</span>
2671                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2672                             FEEDBACK_STOP_FLAG = 1;
2673 
2674                             setpv(<span class="string">'SR_STATE'</span>, -5);
2675                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2676                             <span class="keyword">if</span> StateNumber &gt;= 0
2677                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2678                             <span class="keyword">else</span>
2679                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2680                             <span class="keyword">end</span>
2681                         <span class="keyword">end</span>
2682 
2683                         <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2684                             <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2685                             <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2686                                 disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2687                             <span class="keyword">end</span>
2688                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2689                             pause(0.5);
2690                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2691                             <span class="keyword">break</span>;
2692                         <span class="keyword">end</span>
2693 
2694                         <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2695                         <span class="comment">% pause(0);</span>
2696 
2697                         <span class="keyword">if</span> max(abs(VCMtrimSP_next) &gt; 8) <span class="comment">% changed from 6A ~12/1/07 since orbit FB is going past 6A</span>
2698                             VCMtrimnum=find(abs(VCMtrimSP_next) &gt; 8);
2699                             VWarnNum=VWarnNum+1;
2700                             <span class="keyword">if</span> (VWarnNum==1 || rem(VWarnNum,120)==0)
2701 
2702                                 <span class="comment">% print message to screen every two minutes</span>
2703                                 fprintf(<span class="string">'\n'</span>);
2704                                 fprintf(<span class="string">'***One or more of the vertical corrector trims is above 8A or below -8A! \n'</span>);
2705                                 fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2706                                 <span class="keyword">for</span> loop = VCMtrimnum'
2707                                     fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1(loop,:)));
2708                                 <span class="keyword">end</span>
2709                                 fprintf(<span class="string">'***The orbit feedback is still working but this problem should be investigated. \n'</span>);
2710 
2711                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2712                                 <span class="keyword">if</span> (VWarnNum==1 || VWarnNum==600)
2713                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageVCM.txt
2714                                 <span class="keyword">end</span>
2715                             <span class="keyword">end</span>
2716                         <span class="keyword">elseif</span> max(abs(VCMCHICANEtrimSP_next) &gt; 15)
2717                             VCMCHICANEtrimnum=find(abs(VCMCHICANEtrimSP_next) &gt; 15);
2718                             VWarnNum=VWarnNum+1;
2719                             <span class="keyword">if</span> (VWarnNum==1 || rem(VWarnNum,120)==0)
2720 
2721                                 <span class="comment">% print message to screen every two minutes</span>
2722                                 fprintf(<span class="string">'\n'</span>);
2723                                 fprintf(<span class="string">'***One or more of the vertical chicane corrector trim coils is above 15A or below -15A! \n'</span>);
2724                                 fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2725                                 <span class="keyword">for</span> loop = VCMCHICANEtrimnum'
2726                                     fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>,VCMlist1(iVCMChicane(loop,:),:)));
2727                                 <span class="keyword">end</span>
2728                                 fprintf(<span class="string">'***The orbit feedback is still working but this problem should be investigated. \n'</span>);
2729 
2730                                 <span class="comment">%reset motor chicanes in case they are drifting</span>
2731                                 <span class="keyword">try</span>
2732                                         fprintf(<span class="string">'  Resetting the setpoints of the motor chicanes in case they are drifting...\n'</span>);
2733                                         setpv(<span class="string">'HCMCHICANEM'</span>,<span class="string">'Setpoint'</span>,ConfigSetpoint.HCMCHICANEM.Setpoint.Data,[],0);
2734                                 <span class="keyword">catch</span>
2735                                 <span class="keyword">end</span>
2736 
2737                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2738                                 <span class="keyword">if</span> (VWarnNum==1 || VWarnNum==600)
2739                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageVCMCHICANE.txt
2740                                 <span class="keyword">end</span>
2741                             <span class="keyword">end</span>
2742                         <span class="keyword">else</span>
2743                             VWarnNum=0;
2744                         <span class="keyword">end</span>
2745 
2746                         <span class="comment">% Don't feedback if the current is too small</span>
2747                         <span class="keyword">if</span> getdcct &lt; 2
2748                             FEEDBACK_STOP_FLAG = 1;
2749                             fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2750                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/beamisoff.txt
2751                             <span class="keyword">break</span>;
2752                         <span class="keyword">end</span>
2753 
2754                         <span class="keyword">if</span> N_VCM &gt; 0
2755                             steppv(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>, Y(iNotVCMChicane), VCMlist1(iNotVCMChicane,:), 0);
2756                             steppv(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>, Y(iVCMChicane), VCMlist1(iVCMChicane,:), 0);
2757                         <span class="keyword">end</span>
2758 
2759                         <span class="comment">% write fast orbit feedback setpoints</span>
2760                         <span class="keyword">if</span> 1
2761                             <a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>(2,Ynew(1:size(BPMlist1,1))+Sy1*Y(1:N_VCM),BPMlist1);
2762                         <span class="keyword">end</span>
2763 
2764                     <span class="keyword">end</span>
2765 
2766                     Yold = Ynew;
2767 
2768                     <span class="comment">%fprintf('Vertical Done: %f \n',gettime-t00);</span>
2769                 <span class="keyword">end</span> <span class="comment">% End vertical correction</span>
2770 
2771 
2772                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
2773                 <span class="comment">% Tune feed forward %</span>
2774                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
2775                 <span class="comment">% We should do a Sector limit check</span>
2776 
2777                 tic;
2778                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxTune'</span>),<span class="string">'Value'</span>) == 1
2779 
2780                     <span class="keyword">if</span> strcmp(SR_Mode, <span class="string">'1.9 GeV, High Tune'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Inject at 1.23'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Inject at 1.353'</span>) ||<span class="keyword">...</span>
2781                         strcmp(SR_Mode, <span class="string">'1.9 GeV, Two-Bunch'</span>)  || strcmp(SR_Mode, <span class="string">'1.5 GeV, Inject at 1.353'</span>)  || strcmp(SR_Mode, <span class="string">'1.9 GeV, TopOff'</span>)
2782 
2783                         addQFsp = zeros(24,1);
2784                         addQDsp = zeros(24,1);
2785 
2786                         <span class="keyword">if</span> strcmp(FFTypeFlag,<span class="string">'Local'</span>)
2787                             disp(<span class="string">'  No local tune compensation available - global is the default now.'</span>);
2788                         <span class="keyword">elseif</span> strcmp(FFTypeFlag,<span class="string">'Global'</span>)
2789 
2790                             <span class="comment">% The vectorized gets were put outside of loop for speed reasons</span>
2791                             <span class="comment">%</span>
2792                             <span class="comment">% should also set up QFfac, Quadelem, Quadlist structures outside loop</span>
2793                             actualgap = <a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>(IDSector);
2794                             [gapmin,gapmax] = <a href="gaplimit.html" class="code" title="function [GAPmin, GAPmax] = gaplimit(DeviceList)">gaplimit</a>(IDSector);
2795                             corrind = find(actualgap&lt;(gapmin-1));
2796                             actualgap(corrind)=gapmax(corrind);
2797                             Shift=zeros(size(actualgap));
2798                             Shift(EPUlist)=getpv(<span class="string">'EPU'</span>);
2799 
2800                             IDchangedList=find((abs(actualgap-oldgap)&gt;0.005) | (abs(Shift-oldShift)&gt;0.005));
2801 
2802                             <span class="keyword">if</span> ~isempty(IDchangedList)
2803 
2804                                 oldgap=actualgap;
2805                                 oldShift=Shift;
2806 
2807                                 <span class="comment">% EPUs excite nux = .25 resonance in vertical linear polarization mode!</span>
2808                                 <span class="comment">% therefore with EPU tune feedforward</span>
2809                                 <span class="comment">% running, we want to move our nominal working point away (just below) the .25 resonance.</span>
2810                                 <span class="comment">%</span>
2811                                 <span class="comment">% The following tune correction moves nominal</span>
2812                                 <span class="comment">% nu_x from .25 to .245 - this should be enough for well set up lattices.</span>
2813                                 <span class="comment">%</span>
2814                                 <span class="comment">% 24 QF+ 24 QD</span>
2815                                 DeltaAmps = inv(SR_TUNE_MATRIX) * [-0.005;0];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2816                                 addQFsp = addQFsp + DeltaAmps(1,:);
2817                                 addQDsp = addQDsp + DeltaAmps(2,:);
2818 
2819                                 <span class="keyword">for</span> gapnum = 1:length(actualgap)
2820 
2821                                     <span class="comment">% Change in tune and [QF;QD] from maximum gap</span>
2822 
2823                                     <span class="keyword">if</span> (IDSector(gapnum,1) == 4) || (IDSector(gapnum,1) == 11)
2824                                         <span class="keyword">if</span> IDSector(gapnum,2) == 1
2825                                             modenamestr = sprintf(<span class="string">'SR%02dU___ODS1M__DC00'</span>,IDSector(gapnum,1));
2826                                         <span class="keyword">else</span> <span class="comment">% if IDSector(gapnum,2) == 2</span>
2827                                             modenamestr = sprintf(<span class="string">'SR%02dU___ODS2M__DC00'</span>,IDSector(gapnum,1));
2828                                         <span class="keyword">end</span>
2829                                         epumode = getpv(modenamestr);
2830                                         <span class="keyword">if</span> (IDSector(gapnum,1) == 4) &amp;&amp; (IDSector(gapnum,2) == 1) 
2831                                             <span class="keyword">if</span> 1   <span class="comment">% temporary fix as long as we do not have good tune FF table without shims (2008-02-15)</span>
2832                                                 <span class="keyword">if</span> (epumode==0)
2833                                                     DeltaNuX = <a href="shift2tune.html" class="code" title="function [Dnux, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = shift2tune(Sector, Gap, EPUshift, GeV)">shift2tune</a>(IDSector(gapnum,:),actualgap(gapnum),Shift(gapnum));
2834                                                     DeltaNuY = 0;
2835                                                 <span class="keyword">else</span>
2836                                                     DeltaNuX = 0;
2837                                                     DeltaNuY = 0;
2838                                                 <span class="keyword">end</span>
2839                                             <span class="keyword">elseif</span> (epumode == 0)
2840 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_41,shift_epu_41,dnux_epu_41_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2841 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_41,shift_epu_41,dnuy_epu_41_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2842                                                 DeltaNuX = interp2(gap41p',shift41p',dnux41p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2843                                                 DeltaNuY = interp2(gap41p',shift41p',dnuy41p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2844                                             <span class="keyword">elseif</span> (epumode == 1)
2845 <span class="comment">%                                                 DeltaNux = 0;</span>
2846 <span class="comment">%                                                 DeltaNuY = gap2tune(IDSector(gapnum, :), actualgap(gapnum), SR_GeV);</span>
2847                                                 DeltaNuX = interp2(gap41a',shift41a',dnux41a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2848                                                 DeltaNuY = interp2(gap41a',shift41a',dnuy41a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2849                                             <span class="keyword">else</span>
2850                                                 DeltaNux = 0;
2851                                                 DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum, :), actualgap(gapnum), SR_GeV);  
2852                                             <span class="keyword">end</span>
2853                                         <span class="keyword">elseif</span> (IDSector(gapnum,1) == 11) &amp;&amp; (IDSector(gapnum,2) == 1) 
2854                                             <span class="keyword">if</span> (epumode == 0)
2855 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_111,shift_epu_111,dnux_epu_111_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2856 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_111,shift_epu_111,dnuy_epu_111_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2857                                                 DeltaNuX = interp2(gap111p',shift111p',dnux111p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2858                                                 DeltaNuY = interp2(gap111p',shift111p',dnuy111p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2859                                             <span class="keyword">elseif</span> (epumode == 1)
2860 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_111,shift_epu_111,dnux_epu_111_m1',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2861 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_111,shift_epu_111,dnuy_epu_111_m1',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2862                                                 DeltaNuX = interp2(gap111a',shift111a',dnux111a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2863                                                 DeltaNuY = interp2(gap111a',shift111a',dnuy111a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2864                                             <span class="keyword">else</span>
2865                                                 DeltaNuX = 0;
2866                                                 DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);   <span class="comment">% variation of vertical tune shift with phase is small for EPUs</span>
2867                                             <span class="keyword">end</span>
2868                                         <span class="keyword">elseif</span> (IDSector(gapnum,1) == 11) &amp;&amp; (IDSector(gapnum,2) == 2) 
2869                                             <span class="keyword">if</span> (epumode == 0)
2870 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_111,shift_epu_111,dnux_epu_111_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2871 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_111,shift_epu_111,dnuy_epu_111_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2872                                                 DeltaNuX = interp2(gap112p',shift112p',dnux112p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2873                                                 DeltaNuY = interp2(gap112p',shift112p',dnuy112p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2874                                             <span class="keyword">elseif</span> (epumode == 1)
2875 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_111,shift_epu_111,dnux_epu_111_m1',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2876 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_111,shift_epu_111,dnuy_epu_111_m1',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2877                                                 DeltaNuX = interp2(gap112a',shift112a',dnux112a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2878                                                 DeltaNuY = interp2(gap112a',shift112a',dnuy112a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2879                                             <span class="keyword">else</span>
2880                                                 DeltaNuX = 0;
2881                                                 DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);   <span class="comment">% variation of vertical tune shift with phase is small for EPUs</span>
2882                                             <span class="keyword">end</span>
2883                                         <span class="keyword">else</span>
2884                                             DeltaNuX = 0;
2885                                             DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);   
2886                                         <span class="keyword">end</span>
2887 
2888                                     <span class="keyword">else</span>
2889                                         DeltaNuX = 0;
2890                                         DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);
2891                                     <span class="keyword">end</span>
2892 
2893                                     DelQF = zeros(length(QFsp),1);
2894                                     DelQD = zeros(length(QFsp),1);
2895 
2896                                     fraccorr = 0.8*DeltaNuY ./ TuneW16Min;
2897 
2898                                     <span class="comment">% Find which quads to change (local beta beating correction</span>
2899                                     <span class="comment">% (horizontal for EPU, vertical otherwise)</span>
2900                                     QuadList = [IDSector(gapnum,1)-1 2; IDSector(gapnum,1) 1];
2901                                     QuadElem = dev2elem(<span class="string">'QF'</span>,QuadList); <span class="comment">% in reality use QF and QD ...</span>
2902 
2903                                     <span class="comment">% global vertical tune correction</span>
2904                                     <span class="comment">% 24 QF+ 24 QD</span>
2905                                     DeltaAmps = inv(SR_TUNE_MATRIX) * [(fraccorr*6.23e-4); fraccorr*(-0.05301)];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2906                                     DelQF = DelQF + DeltaAmps(1,:);
2907                                     DelQD = DelQD + DeltaAmps(2,:);
2908 
2909                                     <span class="comment">% local horizontal tune correction (is also nearly a beta beating correction) only nonzero for EPUs!</span>
2910                                     <span class="comment">% 2 QF + 2 QD</span>
2911                                     DeltaAmpsLocal = 12*inv(SR_TUNE_MATRIX) * [-DeltaNuX;0];                       <span class="comment">%  DelAmps =  [QF; QD];</span>
2912                                     DelQF(QuadElem) = DelQF(QuadElem)+DeltaAmpsLocal(1,1);
2913                                     DelQD(QuadElem) = DelQD(QuadElem)+DeltaAmpsLocal(2,1);
2914 
2915                                     <span class="comment">% local vertical beta beating correction (should be used together with above global tune correction)</span>
2916                                     <span class="comment">% set to zero for EPUs, since their vertical tune shift is small</span>
2917                                     <span class="comment">% 2 QF + 2QD</span>
2918                                     <span class="keyword">if</span> (IDSector(gapnum,1)==6) || (IDSector(gapnum,1)==7) || (IDSector(gapnum,1)==10) || (IDSector(gapnum,1)==11)
2919                                         QFfac = ([2.243127/2.237111; 2.243127/2.237111]-1) * fraccorr;
2920                                         QDfac = ([2.556392/2.511045; 2.556392/2.511045]-1) * fraccorr;
2921                                     <span class="keyword">elseif</span> (IDSector(gapnum,1)==5) || (IDSector(gapnum,1)==9)
2922                                         QFfac = ([2.225965/2.219784; 2.243096/2.237111]-1) * fraccorr;
2923                                         QDfac = ([2.528950/2.483259; 2.556345/2.511045]-1) * fraccorr;
2924                                     <span class="keyword">elseif</span> (IDSector(gapnum,1)==4) || (IDSector(gapnum,1)==8) || (IDSector(gapnum,1)==12)
2925                                         QFfac = ([2.243096/2.237111; 2.225965/2.219784]-1) * fraccorr;
2926                                         QDfac = ([2.556345/2.511045; 2.528950/2.483259]-1) * fraccorr;
2927                                     <span class="keyword">else</span>
2928                                         QFfac = zeros(2,1);
2929                                         QDfac = zeros(2,1);
2930                                     <span class="keyword">end</span>
2931 
2932                                     DelQF(QuadElem,:) = DelQF(QuadElem,:) + QFfac.*QFsp(QuadElem,:);
2933                                     DelQD(QuadElem,:) = DelQD(QuadElem,:) + QDfac.*QDsp(QuadElem,:);
2934 
2935                                     <span class="comment">% add all tune and beta beating corrections for this one ID to the summed up correction vectors for all IDs</span>
2936                                     addQFsp = addQFsp+DelQF;
2937                                     addQDsp = addQDsp+DelQD;
2938                                     
2939                                     
2940                                     <span class="comment">% Skew FF for IVID</span>
2941                                     <span class="keyword">if</span> (IDSector(gapnum,1)==6)
2942                                         scale=(<a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>([6 1])/0.005)^(3/4)*0.16;
2943                                         [SQSFincr, SQSDincr] = <a href="set_etaywave_nuy9_20skews_skewFF.html" class="code" title="function [SQSFincr, SQSDincr] = set_etaywave_nuy9_20skews_skewFF(scale);">set_etaywave_nuy9_20skews_skewFF</a>(scale);
2944                                         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2945                                         <span class="comment">% should add a limit check here %</span>
2946                                         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2947                                         setpv(<span class="string">'SQSF'</span>, <span class="string">'Setpoint'</span>, SQSFsp+SQSFincr, [], 0, <span class="string">'Physics'</span>);
2948                                         setpv(<span class="string">'SQSD'</span>, <span class="string">'Setpoint'</span>, SQSDsp+SQSDincr, [], 0, <span class="string">'Physics'</span>);
2949                                     <span class="keyword">end</span>
2950 
2951                                 <span class="keyword">end</span>
2952 
2953                                 <span class="comment">% Set quadrupoles using main setpoint channels</span>
2954                                 setpv(<span class="string">'QF'</span>, QFsp+addQFsp,[], 0);
2955                                 setpv(<span class="string">'QD'</span>, QDsp+addQDsp,[], 0);
2956                                 <span class="comment">% % Set quadrupoles using FF setpoint channels</span>
2957                                 <span class="comment">% setpv('QF', 'FF', addQFsp, [], 0);</span>
2958                                 <span class="comment">% setpv('QD', 'FF', addQDsp, [], 0);</span>
2959                                 
2960                             <span class="keyword">end</span>
2961 
2962                         <span class="keyword">else</span>
2963                             error(<span class="string">'Unknown type selected for tune FF'</span>);
2964                         <span class="keyword">end</span>
2965 
2966                     <span class="keyword">else</span>
2967                         disp(<span class="string">'  No tune FF algorithm for non-production modes yet...'</span>);
2968                     <span class="keyword">end</span>
2969                 <span class="keyword">end</span>
2970 
2971                 ffdeltaquad_delay = toc;
2972                 <span class="comment">%fprintf('tune FF delay = %.1f seconds\n',ffdeltaquad_delay);</span>
2973                 <span class="comment">% fprintf('Tune Done: %f \n',gettime-t00);</span>
2974 
2975                 <span class="comment">% Output info to screen</span>
2976                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = %.4f mm'</span>,STDx),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2977                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = %.4f mm'</span>,STDy),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2978                 <span class="comment">%pause(0);</span>
2979 
2980                 FOFBStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2981                     getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2982                     getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2983                     getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2984                 <span class="keyword">for</span> loop = 1:size(FOFBStatus,2)
2985                     <span class="keyword">if</span> FOFBStatus(loop)==0
2986                         FOFBStatusStr(loop,:) = <span class="string">'OFF '</span>;
2987                     <span class="keyword">elseif</span> FOFBStatus(loop)==1
2988                         FOFBStatusStr(loop,:) = <span class="string">'ON  '</span>;
2989                     <span class="keyword">elseif</span> FOFBStatus(loop)==2
2990                         FOFBStatusStr(loop,:) = <span class="string">'OPEN'</span>;
2991                     <span class="keyword">else</span>
2992                         FOFBStatusStr(loop,:) = <span class="string">'BAD '</span>;
2993                     <span class="keyword">end</span>
2994                 <span class="keyword">end</span>
2995                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 %s'</span>,FOFBStatusStr(1,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2996                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 %s'</span>,FOFBStatusStr(2,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2997                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 %s'</span>,FOFBStatusStr(3,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2998                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 %s'</span>,FOFBStatusStr(4,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2999                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 %s'</span>,FOFBStatusStr(5,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3000                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 %s'</span>,FOFBStatusStr(6,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3001                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 %s'</span>,FOFBStatusStr(7,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3002                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 %s'</span>,FOFBStatusStr(8,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3003                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 %s'</span>,FOFBStatusStr(9,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3004                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 %s'</span>,FOFBStatusStr(10,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3005                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 %s'</span>,FOFBStatusStr(11,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3006                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 %s'</span>,FOFBStatusStr(12,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3007 
3008 
3009                 <span class="comment">%fprintf('End of feedback operations: %f \n\n',gettime-t00);</span>
3010 
3011                 <span class="comment">% Wait for next update time or stop request</span>
3012                 <span class="keyword">while</span> (gettime-t00) &lt; LoopDelay
3013                     <span class="comment">%disp('interval could be shorter')</span>
3014                     pause(.05);
3015                     <span class="comment">% Check if GUI has been closed</span>
3016                     <span class="keyword">if</span> isempty(gcbf)
3017                         FEEDBACK_STOP_FLAG = 1;
3018                         lasterr(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
3019                         error(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
3020                     <span class="keyword">end</span>
3021 
3022                     <span class="comment">% Check if Stop button was pressed</span>
3023                     <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
3024                         <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
3025                         <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
3026                             disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
3027                         <span class="keyword">end</span>
3028                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
3029                         pause(0.5);
3030                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
3031                         <span class="keyword">break</span>;
3032                     <span class="keyword">end</span>
3033                 <span class="keyword">end</span>
3034 
3035 
3036                 <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
3037                     <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
3038                     <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
3039                         disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
3040                     <span class="keyword">end</span>
3041                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
3042                     pause(0.5);
3043                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
3044                     <span class="keyword">break</span>;
3045                 <span class="keyword">end</span>
3046 
3047                 StartErrorTime = gettime;
3048 
3049             <span class="keyword">catch</span>
3050 
3051                 fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
3052 
3053                 <span class="comment">% Quit if error exists for more than 20 seconds</span>
3054                 <span class="keyword">if</span> gettime-StartErrorTime&gt;20 || FEEDBACK_STOP_FLAG==1
3055                     fprintf(<span class="string">'%s  Orbit feedback stopped due to error condition. \n\n'</span>,datestr(now));
3056 
3057                     <span class="comment">%send alphapage to operator pager</span>
3058                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
3059                     FEEDBACK_STOP_FLAG = 1;
3060 
3061                     setpv(<span class="string">'SR_STATE'</span>, -5);
3062                     [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
3063                     <span class="keyword">if</span> StateNumber &gt;= 0
3064                         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
3065                     <span class="keyword">else</span>
3066                         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
3067                     <span class="keyword">end</span>
3068                 <span class="keyword">else</span>
3069                     a = clock;
3070                     fprintf(<span class="string">'   Orbit feedback was paused due to error condition (%s %d:%d:%.0f). \n'</span>, date, a(4), a(5), a(6));
3071                     fprintf(<span class="string">'   Orbit feedback has automatically restarted and is running. \n\n'</span>);
3072                 <span class="keyword">end</span>
3073 
3074             <span class="keyword">end</span>
3075 
3076             <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
3077                 <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
3078                 <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
3079                     disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
3080                 <span class="keyword">end</span>
3081                 setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
3082                 pause(0.5);
3083                 setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
3084                 <span class="keyword">break</span>;
3085             <span class="keyword">end</span>
3086 
3087             <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
3088 
3089             <span class="comment">%pause(0);</span>
3090 
3091             <span class="comment">% this loop delays turn on of Fast Feedback system</span>
3092             <span class="keyword">if</span> FBloopIter &lt; 5
3093                 FBloopIter = FBloopIter + 1;
3094             <span class="keyword">end</span>
3095 
3096         <span class="keyword">end</span>  <span class="comment">% End of feedback loop</span>
3097 
3098 
3099         <span class="comment">% End feedback, reset all parameters</span>
3100         <span class="keyword">try</span>
3101 
3102             <span class="comment">% Enable buttons</span>
3103             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3104             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
3105             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3106             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3107             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3108             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3109             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3110             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3111             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3112             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3113             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3114             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3115             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3116 
3117             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = _____ mm'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3118             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = _____ mm'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3119 
3120             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3121             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3122             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3123             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3124             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3125             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3126             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3127             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3128             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3129             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3130             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3131             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3132 
3133             <span class="comment">%pause(0);</span>
3134 
3135         <span class="keyword">catch</span>
3136 
3137             <span class="comment">% GUI must have been closed</span>
3138 
3139         <span class="keyword">end</span>
3140 
3141 
3142         <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
3143         fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
3144         <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
3145 
3146 
3147         a = clock;
3148         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
3149         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
3150         <span class="keyword">if</span> StateNumber &gt;= 0
3151             setpv(<span class="string">'SR_STATE'</span>,5.1);
3152             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
3153             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
3154             fprintf(<span class="string">'   ******************************\n'</span>);
3155             fprintf(<span class="string">'   **  Orbit Feedback Stopped  **\n'</span>);
3156             fprintf(<span class="string">'   ******************************\n\n'</span>);
3157         <span class="keyword">else</span>
3158             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
3159             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
3160             fprintf(<span class="string">'   ****************************************\n'</span>);
3161             fprintf(<span class="string">'   **  Problem With Slow Orbit Feedback  **\n'</span>);
3162             fprintf(<span class="string">'   ****************************************\n\n'</span>);
3163         <span class="keyword">end</span>
3164         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
3165         pause(0);
3166 
3167 
3168     <span class="keyword">case</span> <span class="string">'FeedbackSetup'</span>
3169         InitFlag = Input2;           <span class="comment">% Input #2: if InitFlag, then initialize variables</span>
3170 
3171         <span class="keyword">if</span> InitFlag
3172             
3173            
3174             <span class="comment">% Get the device lists from oscsinit and convert to srcontrol variables</span>
3175             [HBPM, VBPM, HCM, VCM, HSV, VSV] = <a href="ocsinit.html" class="code" title="function [HBPM, VBPM, HCM, VCM, HSV, VSV] = ocsinit(MethodName)">ocsinit</a>(<span class="string">'SOFB'</span>);
3176             Xivec = 1:HSV;
3177             Yivec = 1:VSV;
3178             BPMlist1 = HBPM.DeviceList;
3179             HCMlist1 = HCM.DeviceList;
3180             VCMlist1 = VCM.DeviceList;           
3181             
3182             
3183             OCSx.BPM = getx(BPMlist1, <span class="string">'struct'</span>);
3184             OCSx.CM = getsp(<span class="string">'HCM'</span>, HCMlist1, <span class="string">'struct'</span>);
3185             OCSx.GoalOrbit = getgolden(OCSx.BPM, <span class="string">'numeric'</span>);
3186             OCSx.NIter = 1;
3187             OCSx.SVDIndex = Xivec;
3188             OCSx.IncrementalFlag = <span class="string">'No'</span>;
3189             OCSx.BPMWeight = {[]};
3190             OCSx.FitRF = 0;
3191             OCSy.BPM = gety(BPMlist1, <span class="string">'struct'</span>);
3192             OCSy.CM = getsp(<span class="string">'VCM'</span>, VCMlist1, <span class="string">'struct'</span>);
3193             OCSy.GoalOrbit = getgolden(OCSy.BPM, <span class="string">'numeric'</span>);
3194             OCSy.NIter = 1;
3195             OCSy.SVDIndex = Yivec;
3196             OCSy.IncrementalFlag = <span class="string">'No'</span>;
3197             OCSy.BPMWeight = {[]};
3198             OCSy.FitRF = 0;
3199             
3200             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
3201             <span class="comment">% do we need these Smat calls? %</span>
3202             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
3203             SXmat = getrespmat(OCSx.BPM, OCSx.CM, <span class="string">'numeric'</span>);
3204             SYmat = getrespmat(OCSy.BPM, OCSy.CM, <span class="string">'numeric'</span>);
3205             <span class="comment">% [OCSx, Sx, Ux, Vx] = orbitcorrectionmethods(OCSx, SXmat);</span>
3206             <span class="comment">% [OCSy, Sy, Uy, Vy] = orbitcorrectionmethods(OCSy, SYmat);</span>
3207 
3208             <span class="comment">% initialize FFTypeFlag</span>
3209             FFTypeFlag = <span class="string">'Global'</span>;
3210 
3211             <span class="comment">% Fit decision comes from check box</span>
3212             <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
3213                 OCSx.FitRF = 1;
3214                 Xivec = 1:HSV+1;
3215             <span class="keyword">end</span>
3216         
3217         <span class="keyword">else</span>
3218 
3219             <span class="comment">% Get vectors</span>
3220             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
3221             <span class="comment">% the two lines below seem to fix BPMlist editing problem</span>
3222             OCSx = FB.OCSx;
3223             OCSy = FB.OCSy;
3224             BPMlist1 = FB.BPMlist1;
3225             HCMlist1 = FB.HCMlist1;
3226             VCMlist1 = FB.VCMlist1;
3227             Xivec = FB.Xivec;
3228             Yivec = FB.Yivec;
3229             Xgoal = FB.OCSx.GoalOrbit;
3230             OCSx.GoalOrbit = Xgoal;
3231             Ygoal = FB.OCSy.GoalOrbit;
3232             OCSy.GoalOrbit = Ygoal;
3233             FFTypeFlag = FB.FFTypeFlag;
3234 
3235 
3236             <span class="comment">% FF corrector magnet list - only channels which are blocked when FF is running should be</span>
3237             <span class="comment">% listed</span>
3238             ListFF = [
3239                 4     2
3240                 4     8
3241                 5     1
3242                 5     7
3243 <span class="comment">%               5     8 % IVID is using digital FF, i.e. FF algorithm does not block</span>
3244 <span class="comment">%               6     1 % other access to PVs</span>
3245                 6     8
3246                 7     1
3247                 7     8
3248                 8     1
3249                 8     8
3250                 9     1
3251                 9     8
3252                 10    1
3253                 11    8
3254                 12    1];
3255             ElemFF = dev2elem(<span class="string">'HCM'</span>,ListFF);
3256 
3257 
3258             <span class="comment">% Add button to change #ivectors, cm, IDBPMs,</span>
3259             EditFlag = 0;
3260             h_fig1 = figure;
3261             <span class="keyword">while</span> EditFlag ~= 6
3262 
3263                 Sx = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
3264                 Sy = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
3265                 
3266                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
3267                     DispOrbit = getdisp(<span class="string">'BPMx'</span>, BPMlist1);
3268                     Sx = [Sx DispOrbit];
3269                 <span class="keyword">end</span>
3270                 
3271                 Sx(isnan(Sx)) = 0;
3272                 Sy(isnan(Sy)) = 0;
3273                 
3274                 [Ux, SVx, Vx] = svd(Sx);
3275                 [Uy, SVy, Vy] = svd(Sy);
3276 
3277                 
3278                 <span class="comment">% Remove singular values greater than the actual number of singular values</span>
3279                 i = find(Xivec&gt;length(diag(SVx)));
3280                 <span class="keyword">if</span> ~isempty(i)
3281                     disp(<span class="string">'   Horizontal E-vector scaled since there were more elements in the vector than singular values.'</span>);
3282                     pause(0);
3283                     Xivec(i) = [];
3284                 <span class="keyword">end</span>
3285                 i = find(Yivec&gt;length(diag(SVy)));
3286                 <span class="keyword">if</span> ~isempty(i)
3287                     disp(<span class="string">'   Vertical E-vector scaled since there were more elements in the vector than singular values.'</span>);
3288                     pause(0);
3289                     Yivec(i) = [];
3290                 <span class="keyword">end</span>
3291 
3292 
3293                 Ax = Sx*Vx(:,Xivec);
3294                 Tx = inv(Ax'*Ax)*Ax';
3295 
3296                 Ay = Sy*Vy(:,Yivec);
3297                 Ty = inv(Ay'*Ay)*Ay';
3298 
3299                 figure(h_fig1);
3300                 subplot(2,1,1);
3301                 semilogy(diag(SVx),<span class="string">'b'</span>);
3302                 hold on;
3303                 semilogy(diag(SVx(Xivec,Xivec)),<span class="string">'xr'</span>);
3304                 ylabel(<span class="string">'Horizontal'</span>);
3305                 title(<span class="string">'Response Matrix Singular Values'</span>);
3306                 hold off;
3307                 subplot(2,1,2);
3308                 semilogy(diag(SVy),<span class="string">'b'</span>);
3309                 hold on;
3310                 semilogy(diag(SVy(Yivec,Yivec)),<span class="string">'xr'</span>);
3311                 xlabel(<span class="string">'Singular Value Number'</span>);
3312                 ylabel(<span class="string">'Vertical'</span>);
3313                 hold off;
3314                 drawnow;
3315 
3316                 EditFlag = menu(<span class="string">'Change Parameters?'</span>,<span class="string">'Singular Values'</span>,<span class="string">'HCM List'</span>,<span class="string">'VCM List'</span>, <span class="keyword">...</span>
3317                     <span class="string">'BPM List'</span>,<span class="string">'Change the Goal Orbit'</span>,<span class="string">'Continue'</span>);
3318 
3319                 <span class="keyword">if</span> EditFlag == 1
3320                     prompt={<span class="string">'Enter the horizontal E-vector numbers (Matlab vector format):'</span>,<span class="string">'Enter the vertical E-vector numbers (Matlab vector format):'</span>};
3321                     def={sprintf(<span class="string">'[%d:%d]'</span>,1,Xivec(end)),sprintf(<span class="string">'[%d:%d]'</span>,1,Yivec(end))};
3322                     titlestr=<span class="string">'SVD Orbit Feedback'</span>;
3323                     lineNo=1;
3324                     answer=inputdlg(prompt,titlestr,lineNo,def);
3325                     <span class="keyword">if</span> ~isempty(answer)
3326                         XivecNew = fix(str2num(answer{1}));
3327                         <span class="keyword">if</span> isempty(XivecNew)
3328                             disp(<span class="string">'   Horizontal E-vector cannot be empty.  No change made.'</span>);
3329                         <span class="keyword">else</span>
3330                             <span class="keyword">if</span> any(XivecNew&lt;=0) || max(XivecNew)&gt;length(diag(SVx))
3331                                 disp(<span class="string">'   Error reading horizontal E-vector.  No change made.'</span>);
3332                             <span class="keyword">else</span>
3333                                 Xivec = XivecNew;
3334                             <span class="keyword">end</span>
3335                         <span class="keyword">end</span>
3336                         YivecNew = fix(str2num(answer{2}));
3337                         <span class="keyword">if</span> isempty(YivecNew)
3338                             disp(<span class="string">'   Vertical E-vector cannot be empty.  No change made.'</span>);
3339                         <span class="keyword">else</span>
3340                             <span class="keyword">if</span> any(YivecNew&lt;=0) || max(YivecNew)&gt;length(diag(SVy))
3341                                 disp(<span class="string">'   Error reading vertical E-vector.  No change made.'</span>);
3342                             <span class="keyword">else</span>
3343                                 Yivec = YivecNew;
3344                             <span class="keyword">end</span>
3345                         <span class="keyword">end</span>
3346                     <span class="keyword">end</span>
3347                 <span class="keyword">end</span>
3348 
3349                 <span class="keyword">if</span> EditFlag == 2
3350                     List= getlist(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>);
3351                     CheckList = zeros(96,1);
3352                     Elem = dev2elem(<span class="string">'HCM'</span>, HCMlist1);
3353                     CheckList(Elem) = ones(size(Elem));
3354                     CheckList = CheckList(dev2elem(<span class="string">'HCM'</span>,List));
3355 
3356                     <span class="comment">% Remove FF corrrectors</span>
3357                     <span class="comment">%           Elem = dev2elem('HCM',List);</span>
3358                     <span class="comment">%           for j = length(ElemFF):-1:1</span>
3359                     <span class="comment">%              i = find(Elem==ElemFF(j));</span>
3360                     <span class="comment">%              Elem(i,:) = [];</span>
3361                     <span class="comment">%              List(i,:) = [];</span>
3362                     <span class="comment">%              CheckList(i,:) = [];</span>
3363                     <span class="comment">%           end</span>
3364 
3365                     newList = editlist(List, <span class="string">'HCMtrim'</span>, CheckList);
3366 
3367                     <span class="keyword">if</span> isempty(newList)
3368                         fprintf(<span class="string">'   WARNING: Horizontal corrector magnet list is empty!\n'</span>);
3369                         HCMlist1 = newList;
3370                     <span class="keyword">else</span>
3371                         HCMlist1 = newList;
3372                     <span class="keyword">end</span>
3373                     OCSx.CM.DeviceList = HCMlist1;
3374                 <span class="keyword">end</span>
3375 
3376                 <span class="keyword">if</span> EditFlag == 3
3377                     List = getlist(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>);
3378                     CheckList = zeros(96,1);
3379                     Elem = dev2elem(<span class="string">'VCM'</span>, VCMlist1);
3380                     CheckList(Elem) = ones(size(Elem));
3381                     CheckList = CheckList(dev2elem(<span class="string">'VCM'</span>,List));
3382 
3383                     <span class="comment">% Remove FF corrrectors</span>
3384                     <span class="comment">%           Elem = dev2elem('VCM',List);</span>
3385                     <span class="comment">%           for j = length(ElemFF):-1:1</span>
3386                     <span class="comment">%              i = find(Elem==ElemFF(j));</span>
3387                     <span class="comment">%              Elem(i,:) = [];</span>
3388                     <span class="comment">%              List(i,:) = [];</span>
3389                     <span class="comment">%              CheckList(i,:) = [];</span>
3390                     <span class="comment">%           end</span>
3391 
3392                     newList = editlist(List, <span class="string">'VCMtrim'</span>, CheckList);
3393 
3394                     <span class="keyword">if</span> isempty(newList)
3395                         fprintf(<span class="string">'   WARNING: Vertical corrector magnet list is empty!\n'</span>);
3396                         VCMlist1 = newList;
3397                     <span class="keyword">else</span>
3398                         VCMlist1 = newList;
3399                     <span class="keyword">end</span>
3400                     OCSy.CM.DeviceList = VCMlist1;
3401                 <span class="keyword">end</span>
3402 
3403                 <span class="keyword">if</span> EditFlag == 4
3404                     ListOld = BPMlist1;
3405                     XgoalOld = Xgoal;
3406                     YgoalOld = Ygoal;
3407 
3408                     <span class="comment">% Full BPM list</span>
3409                     List = <a href="getbpmlist.html" class="code" title="function [DeviceList, Index] = getbpmlist(varargin)">getbpmlist</a>(<span class="string">'Bergoz'</span>);
3410 
3411                     CheckList = zeros(size(List,1),1);
3412                     <span class="keyword">if</span> ~isempty(BPMlist1)
3413                         <span class="keyword">for</span> i = 1:size(List,1)
3414                             k = find(List(i,1)==BPMlist1(:,1));
3415                             l = find(List(i,2)==BPMlist1(k,2));
3416 
3417                             <span class="keyword">if</span> isempty(k) || isempty(l)
3418                                 <span class="comment">% Item not in list</span>
3419                             <span class="keyword">else</span>
3420                                 CheckList(i) = 1;
3421                             <span class="keyword">end</span>
3422                         <span class="keyword">end</span>
3423                     <span class="keyword">end</span>
3424 
3425                     newList = editlist(List, <span class="string">'BPM'</span>, CheckList);
3426                     <span class="keyword">if</span> isempty(newList)
3427                         fprintf(<span class="string">'   BPM list cannot be empty.  No change made.\n'</span>);
3428                     <span class="keyword">else</span>
3429                         BPMlist1 = newList;
3430                     <span class="keyword">end</span>
3431 
3432                     <span class="comment">% Set the goal orbit to the golden orbit</span>
3433                     Xgoal = getgolden(<span class="string">'BPMx'</span>, BPMlist1);
3434                     Ygoal = getgolden(<span class="string">'BPMy'</span>, BPMlist1);
3435 
3436 
3437                     <span class="comment">% If a new BPM is added, then set the goal orbit to the golden orbit</span>
3438                     <span class="keyword">for</span> i = 1:size(BPMlist1,1)
3439 
3440                         <span class="comment">% Is it a new BPM?</span>
3441                         k = find(BPMlist1(i,1)==ListOld(:,1));
3442                         l = find(BPMlist1(i,2)==ListOld(k,2));
3443 
3444                         <span class="keyword">if</span> isempty(k) || isempty(l)
3445                             <span class="comment">% New BPM</span>
3446                         <span class="keyword">else</span>
3447                             <span class="comment">% Use the old value for old BPM</span>
3448                             Xgoal(i) = XgoalOld(k(l));
3449                             Ygoal(i) = YgoalOld(k(l));
3450                         <span class="keyword">end</span>
3451                     <span class="keyword">end</span>
3452                     OCSx.BPM.DeviceList = BPMlist1;
3453                     OCSy.BPM.DeviceList = BPMlist1;
3454                     OCSx.GoalOrbit = Xgoal;
3455                     OCSy.GoalOrbit = Ygoal;
3456                 <span class="keyword">end</span>
3457 
3458                 <span class="keyword">if</span> EditFlag == 5
3459                     ChangeList = editlist2(BPMlist1, <span class="string">'Change BPM'</span>, zeros(size(BPMlist1,1),1));
3460 
3461                     <span class="keyword">for</span> i = 1:size(ChangeList,1)
3462 
3463                         k = find(ChangeList(i,1)==BPMlist1(:,1));
3464                         l = find(ChangeList(i,2)==BPMlist1(k,2));
3465 
3466                         prompt={sprintf(<span class="string">'Enter the new horizontal goal orbit for BPMx(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2)),sprintf(<span class="string">'Enter the new vertical goal orbit for BPMy(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2))};
3467                         def={sprintf(<span class="string">'%f'</span>,Xgoal(k(l))),sprintf(<span class="string">'%f'</span>,Ygoal(k(l)))};
3468                         titlestr=<span class="string">'CHANGE THE GOAL ORBIT'</span>;
3469                         lineNo=1;
3470                         answer = inputdlg(prompt, titlestr, lineNo, def);
3471 
3472                         <span class="keyword">if</span> isempty(answer)
3473                             <span class="comment">% No change</span>
3474                             fprintf(<span class="string">'   No change was made to the golden orbit.\n'</span>);
3475                         <span class="keyword">else</span>
3476                             Xgoalnew = str2num(answer{1});
3477                             <span class="keyword">if</span> isempty(Xgoalnew)
3478                                 fprintf(<span class="string">'   No change was made to the horizontal golden orbit.\n'</span>);
3479                             <span class="keyword">else</span>
3480                                 Xgoal(k(l)) = Xgoalnew;
3481                             <span class="keyword">end</span>
3482 
3483                             Ygoalnew = str2num(answer{2});
3484                             <span class="keyword">if</span> isempty(Ygoalnew)
3485                                 fprintf(<span class="string">'   No change was made to the vertical golden orbit.\n'</span>);
3486                             <span class="keyword">else</span>
3487                                 Ygoal(k(l)) = Ygoalnew;
3488                             <span class="keyword">end</span>
3489                         <span class="keyword">end</span>
3490                     <span class="keyword">end</span>
3491                     <span class="keyword">if</span> ~isempty(ChangeList)
3492                         fprintf(<span class="string">'   Note:  Changing the goal orbit for &quot;Slow Orbit Feedback&quot; does not change the goal orbit for &quot;Orbit Correction.&quot;\n'</span>);
3493                         fprintf(<span class="string">'          Re-running srcontrol will restart the goal orbit to the golden orbit.&quot;\n'</span>);
3494                     <span class="keyword">end</span>
3495                     OCSx.GoalOrbit = Xgoal;
3496                     OCSy.GoalOrbit = Ygoal;
3497                 <span class="keyword">end</span>
3498 
3499 <span class="comment">%                 if EditFlag == 6</span>
3500 <span class="comment">%                     FFTypeFlag = questdlg(sprintf('Do you want to use a fully local or a combined local/global compensation of IDs? (nuy=9.2 only)'),'Tune FF','Local','Global', 'Global');</span>
3501 <span class="comment">%                     if strcmp(FFTypeFlag,'Local')</span>
3502 <span class="comment">%                         disp(['   The tune FF will use 8 local quadrupoles to compensate beta beating and tune shift']);</span>
3503 <span class="comment">%                         disp(['   from each ID.']);</span>
3504 <span class="comment">%                     elseif strcmp(FFTypeFlag,'Global')</span>
3505 <span class="comment">%                         disp(['   The tune FF will use 4 local quadrupoles to compensate beta beating and all QF+QD']);</span>
3506 <span class="comment">%                         disp(['   to compensate tune shift from each ID.']);</span>
3507 <span class="comment">%                     end</span>
3508 <span class="comment">%                 end</span>
3509 
3510             <span class="keyword">end</span>
3511             close(h_fig1);
3512         <span class="keyword">end</span>
3513 
3514         <span class="comment">% Save vectors</span>
3515         FB.Xivec = Xivec;
3516         FB.Yivec = Yivec;
3517         FB.HCMlist1 = HCMlist1;
3518         FB.VCMlist1 = VCMlist1;
3519         FB.BPMlist1 = BPMlist1;
3520 
3521         OCSx.SVDIndex = Xivec;
3522         OCSy.SVDIndex = Yivec;
3523         FB.OCSx = OCSx;
3524         FB.OCSy = OCSy;
3525 
3526         FB.FFTypeFlag = FFTypeFlag;
3527         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>,FB);
3528 
3529 
3530     <span class="keyword">case</span> <span class="string">'FastFeedbackSetup'</span>
3531 
3532         InitFlag = Input2;
3533 
3534         <span class="keyword">if</span> InitFlag
3535             FOFBFreq = 1000;
3536             <span class="comment">% user operations 9/14-10/17/04: P=0.5, I=120, D=0.0015 (for both planes)</span>
3537             <span class="comment">% below are known good values for user ops as of 8-1-05</span>
3538             HorP = 2;
3539             HorI = 300;
3540             HorD = 0.002;
3541             VertP = 1;
3542             VertI = 100;
3543             VertD = 0.0015;
3544 
3545             <span class="comment">% this initial set is now done in hwinit.m because it's not a good idea to set anything when srcontrol is launched</span>
3546             <span class="comment">% try</span>
3547             <span class="comment">%     setsp('SR01____FFBFREQAC00', FOFBFreq); % set freq</span>
3548             <span class="comment">%     write_pid_ffb2_patch(HorP, HorI, HorD, VertP, VertI, VertD);</span>
3549             <span class="comment">% catch</span>
3550             <span class="comment">%     disp('   Trouble setting Fast Orbit Feedback parameters!');</span>
3551             <span class="comment">% end</span>
3552 
3553         <span class="keyword">else</span>
3554             <span class="comment">% Get vectors</span>
3555             FOFB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
3556             FOFBFreq = FOFB.FOFBFreq;
3557             HorP  = FOFB.HorP;
3558             HorI  = FOFB.HorI;
3559             HorD  = FOFB.HorD;
3560             VertP = FOFB.VertP;
3561             VertI = FOFB.VertI;
3562             VertD = FOFB.VertD;
3563 
3564             <span class="comment">% Add button to change #ivectors, CMs, IDBPMs,</span>
3565             EditFlag = 0;
3566             <span class="comment">%h_fig1 = figure;</span>
3567             <span class="keyword">while</span> EditFlag ~= 3
3568 
3569                 <span class="comment">%EditFlag = menu('Change Parameters?', 'Fast Feedback Frequency', 'PID Values', 'HCM List', 'VCM List', ...</span>
3570                 <span class="comment">%   'IDBPM List', 'BBPM List', 'Continue');</span>
3571                 <span class="comment">% Use menu below until other FFB config routines work (then also uncomment options 3,4,5,6 below)</span>
3572                 EditFlag = menu(<span class="string">'Change Parameters?'</span>, <span class="string">'Fast Feedback Frequency'</span>, <span class="string">'PID Values'</span>, <span class="string">'Continue'</span>);
3573 
3574                 <span class="keyword">if</span> EditFlag == 1
3575                     <span class="comment">% change rate</span>
3576 
3577                     prompt={<span class="string">'Enter the desired Fast Feedback Frequency (1-1000 Hz)'</span>};
3578                     def={num2str(FOFBFreq)};
3579                     titlestr=<span class="string">'Fast Feedback Setup'</span>;
3580                     lineNo=1;
3581                     answer=inputdlg(prompt,titlestr,lineNo,def);
3582                     <span class="keyword">if</span> ~isempty(answer)
3583                         FOFBFreq = fix(str2num(answer{1}));
3584                         <span class="keyword">if</span> isempty(FOFBFreq)
3585                             disp(<span class="string">'   Frequency value cannot be empty.  No change made.'</span>);
3586                             FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3587                         <span class="keyword">else</span>
3588                             <span class="keyword">if</span> FOFBFreq &lt; 1 || FOFBFreq &gt; 1000
3589                                 disp(<span class="string">'   Frequency must be between 1 and 1000 Hz.  No change made.'</span>);
3590                                 FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3591                             <span class="keyword">end</span>
3592                         <span class="keyword">end</span>
3593                         setsp(<span class="string">'SR01____FFBFREQAC00'</span>,FOFBFreq   ); <span class="comment">% change freq</span>
3594                         pause(0.5);
3595                         fprintf(<span class="string">'   Fast orbit feedback frequency is running at %.0f Hz.\n'</span>, getpv(<span class="string">'SR01____FFBFREQAM00'</span>));
3596                     <span class="keyword">else</span>
3597                         FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3598                     <span class="keyword">end</span>
3599                 <span class="keyword">end</span>
3600 
3601                 <span class="keyword">if</span> EditFlag == 2
3602                     <span class="comment">% edit  PIDs</span>
3603                     <span class="comment">% User defaults are HorP=2, HorI=300, HorD=0.002, VertP=1, VertI=100, VertD=0.0015</span>
3604                     prompt={<span class="string">'P horizontal'</span>, <span class="string">'I horizontal'</span>, <span class="string">'D horizontal'</span>, <span class="string">'P vertical'</span>, <span class="string">'I vertical'</span>, <span class="string">'D vertical'</span>};
3605                     def={num2str(HorP), num2str(HorI), num2str(HorD), num2str(VertP), num2str(VertI), num2str(VertD)};
3606                     titlestr=<span class="string">'Fast Feedback PID Setup'</span>;
3607                     lineNo=1;
3608                     answer=inputdlg(prompt,titlestr,lineNo,def);
3609                     <span class="keyword">if</span> ~isempty(answer)
3610                         HorPnewnum = str2num(answer{1});
3611                         <span class="keyword">if</span> isempty(HorPnewnum)
3612                             disp(<span class="string">'   HorP value cannot be empty.  No change made.'</span>);
3613                         <span class="keyword">else</span>
3614                             HorP = HorPnewnum;
3615                         <span class="keyword">end</span>
3616                         HorInewnum = str2num(answer{2});
3617                         <span class="keyword">if</span> isempty(HorInewnum)
3618                             disp(<span class="string">'   HorI value cannot be empty.  No change made.'</span>);
3619                         <span class="keyword">else</span>
3620                             HorI = HorInewnum;
3621                         <span class="keyword">end</span>
3622                         HorDnewnum = str2num(answer{3});
3623                         <span class="keyword">if</span> isempty(HorDnewnum)
3624                             disp(<span class="string">'   HorD value cannot be empty.  No change made.'</span>);
3625                         <span class="keyword">else</span>
3626                             HorD = HorDnewnum;
3627                         <span class="keyword">end</span>
3628                         VertPnewnum = str2num(answer{4});
3629                         <span class="keyword">if</span> isempty(VertPnewnum)
3630                             disp(<span class="string">'   VertP value cannot be empty.  No change made.'</span>);
3631                         <span class="keyword">else</span>
3632                             VertP = VertPnewnum;
3633                         <span class="keyword">end</span>
3634                         VertInewnum = str2num(answer{5});
3635                         <span class="keyword">if</span> isempty(VertInewnum)
3636                             disp(<span class="string">'   VertI value cannot be empty.  No change made.'</span>);
3637                         <span class="keyword">else</span>
3638                             VertI = VertInewnum;
3639                         <span class="keyword">end</span>
3640                         VertDnewnum = str2num(answer{6});
3641                         <span class="keyword">if</span> isempty(VertDnewnum)
3642                             disp(<span class="string">'   VertD value cannot be empty.  No change made.'</span>);
3643                         <span class="keyword">else</span>
3644                             VertD = VertDnewnum;
3645                         <span class="keyword">end</span>
3646 
3647                         <span class="keyword">try</span>
3648                             write_pid_ffb2_patch(HorP, HorI, HorD, VertP, VertI, VertD);
3649                             fprintf(<span class="string">'   Setting FFB gains to Horizontal P=%.2f, I=%.1f, D=%.4f;  Vertical P=%.2f, I=%.1f, D=%.4f\n'</span>, HorP, HorI, HorD, VertP, VertI, VertD);
3650                         <span class="keyword">catch</span>
3651                             disp(<span class="string">'   Trouble setting Fast Orbit Feedback parameters!'</span>);
3652                         <span class="keyword">end</span>
3653                     <span class="keyword">end</span>
3654                 <span class="keyword">end</span>
3655 
3656                 <span class="comment">%if EditFlag == 3</span>
3657                 <span class="comment">%   disp('   This function not yet available.');</span>
3658                 <span class="comment">%   % change HCM List</span>
3659                 <span class="comment">%end</span>
3660                 <span class="comment">%</span>
3661                 <span class="comment">%if EditFlag == 4</span>
3662                 <span class="comment">%   disp('   This function not yet available.');</span>
3663                 <span class="comment">%   % change VCM List</span>
3664                 <span class="comment">%end</span>
3665                 <span class="comment">%</span>
3666                 <span class="comment">%if EditFlag == 5</span>
3667                 <span class="comment">%   disp('   This function not yet available.');</span>
3668                 <span class="comment">%   % change IDBPM List</span>
3669                 <span class="comment">%end</span>
3670                 <span class="comment">%</span>
3671                 <span class="comment">%if EditFlag == 6</span>
3672                 <span class="comment">%   disp('   This function not yet available.');</span>
3673                 <span class="comment">%   % change BBPM List</span>
3674                 <span class="comment">%end</span>
3675 
3676             <span class="keyword">end</span>
3677             <span class="comment">%close(h_fig1);</span>
3678         <span class="keyword">end</span>
3679 
3680         <span class="comment">% Save vectors</span>
3681         FOFB.FOFBFreq = FOFBFreq;
3682         FOFB.HorP = HorP;
3683         FOFB.HorI = HorI;
3684         FOFB.HorD = HorD;
3685         FOFB.VertP = VertP;
3686         FOFB.VertI = VertI;
3687         FOFB.VertD = VertD;
3688         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Userdata'</span>,FOFB);
3689 
3690     <span class="keyword">otherwise</span>
3691         fprintf(<span class="string">'   No action for %s.\n'</span>, action);
3692 <span class="keyword">end</span>   <span class="comment">% end case</span></pre></div>
<hr><address>Generated on Fri 01-Aug-2008 11:41:01 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>