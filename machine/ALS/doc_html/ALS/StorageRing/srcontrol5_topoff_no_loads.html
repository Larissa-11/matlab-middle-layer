<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of srcontrol5_topoff_no_loads</title>
  <meta name="keywords" content="srcontrol5_topoff_no_loads">
  <meta name="description" content="srcontrol5">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">ALS</a> &gt; <a href="index.html">StorageRing</a> &gt; srcontrol5_topoff_no_loads.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for ALS\StorageRing&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>srcontrol5_topoff_no_loads
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>srcontrol5</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function srcontrol5(action, Input2, Input3) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> srcontrol5
 Storage ring control program

 This program controls all storage ring magnets, performs orbit feedback and
 tune feedforward and helps to diagnose problems in routine user operation
 of the ALS storage ring. It includes a gui to simplify the use of this
 program.

 It was originally programmed by Greg Portmann (until December 2000) with input
 from Winfried Decking, David Robin, Christoph Steier, Ying Wu and others
 and is currently (July 2002) maintained by Christoph Steier and Tom Scarvie.

 The actual version of this program is srcontrol5 (is called by default if you call srcontrol).

 Christoph Steier, July 2002

 SRCONTROL5 is the newest versionof SRCONTROL, edited to work with G. Portmann's new (2005) Matlab middle layer.

 Tom Scarvie, April 2005</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="amp2k.html" class="code" title="function [k, B] = amp2k(Family, Field, Amps, DeviceList, Energy, BranchFlag)">amp2k</a>	AMP2K - Converts amperes to simulator values</li><li><a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>	BEND2GEV - Compute the energy based on the ramp tables</li><li><a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>	CHECKSRMAGS - Check SR power supplies against a lattice file</li><li><a href="checksrorbit.html" class="code" title="function ErrorNums = checksrorbit(SectorList, BPMxtol,BPMytol)">checksrorbit</a>	ErrorNums =checksrorbit(Sector, BPMxtolerance [.015 mm], [BPMytolerance [.015 mm]])</li><li><a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>	GAP2TUNE - Computes the vertical tune shift for a insertion device gap change.</li><li><a href="gaplimit.html" class="code" title="function [GAPmin, GAPmax] = gaplimit(DeviceList)">gaplimit</a>	[GapMin, GapMax] = gaplimit(DeviceList)</li><li><a href="getbpmlist.html" class="code" title="function [DeviceList, Index] = getbpmlist(varargin)">getbpmlist</a>	GETBPMLIST - Return a BPM list based on key words and sector numbers</li><li><a href="getbpmtimeconstant.html" class="code" title="function [BPMTimeConstant, WarningFlag] = getbpmtimeconstant(varargin)">getbpmtimeconstant</a>	GETBPMTIMECONSTANT - Sets the timeconstants for the Bergoz style BPMs.</li><li><a href="getff.html" class="code" title="function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)">getff</a>	GETFF - Get the state of insertion device feed forward and user gap contr5ol</li><li><a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>	GETID - Get the insertion device position, velocity, run flag, and user requested gap</li><li><a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>	[StateNumber, StateString] = getsrstate</li><li><a href="ocsinit.html" class="code" title="function [HBPM, VBPM, HCM, VCM, HSV, VSV] = ocsinit(MethodName)">ocsinit</a>	OCSINIT - Corrector and BPM</li><li><a href="set_alarmhandler_AHU_thresholds_inject.html" class="code" title="function set_alarmhandler_AHU_thresholds_inject">set_alarmhandler_AHU_thresholds_inject</a>	function set_alarmhandler_AHU_thresholds_inject</li><li><a href="set_etaywave_nuy9_20skews_skewFF.html" class="code" title="function [SQSFincr, SQSDincr] = set_etaywave_nuy9_20skews_skewFF(scale);">set_etaywave_nuy9_20skews_skewFF</a>	function [SQSFincr, SQSDincr] = set_etaywave_nuy9_20skews_skewFF(scale);</li><li><a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>	SETBPMTIMECONSTANT - Sets the timeconstants for the Bergoz style BPMs.</li><li><a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>	SETBUMPS - Make a straight section bump</li><li><a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>	function setff(DeviceList, FFEnableBC, GapEnableBC)</li><li><a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag)">setid</a>	SETID - Set the insertion device vertical gap</li><li><a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>	</li><li><a href="srcycle.html" class="code" title="function FailFlag = srcycle(varargin)">srcycle</a>	SRCYCLE - Storage ring cycle</li><li><a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>	SRRAMP - Ramp the storage ring energy</li><li><a href="write_goldenorbit_ffb.html" class="code" title="function write_goldenorbit_ffb">write_goldenorbit_ffb</a>	function write_goldenorbit_ffb</li><li><a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>	WRITE_GOLDENORBIT_FFTB_2PLANES - Sets the BPM setpoints which are used by the fast feedback system</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function srcontrol5(action, Input2, Input3)</a>
0002 <span class="comment">% srcontrol5</span>
0003 <span class="comment">% Storage ring control program</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% This program controls all storage ring magnets, performs orbit feedback and</span>
0006 <span class="comment">% tune feedforward and helps to diagnose problems in routine user operation</span>
0007 <span class="comment">% of the ALS storage ring. It includes a gui to simplify the use of this</span>
0008 <span class="comment">% program.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% It was originally programmed by Greg Portmann (until December 2000) with input</span>
0011 <span class="comment">% from Winfried Decking, David Robin, Christoph Steier, Ying Wu and others</span>
0012 <span class="comment">% and is currently (July 2002) maintained by Christoph Steier and Tom Scarvie.</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% The actual version of this program is srcontrol5 (is called by default if you call srcontrol).</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% Christoph Steier, July 2002</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% SRCONTROL5 is the newest versionof SRCONTROL, edited to work with G. Portmann's new (2005) Matlab middle layer.</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% Tom Scarvie, April 2005</span>
0021 
0022 <span class="comment">% known bugs/problems (May 2001):</span>
0023 <span class="comment">% - IDBPM averaging might be a bit too long for orbit feedback</span>
0024 <span class="comment">%        solved after Superbend shutdown ... Instead of averaging, digital low pass filters are used</span>
0025 <span class="comment">% - gap2tune does not give correct answers for wiggler and potentially other IDs -&gt; orbit feedback</span>
0026 <span class="comment">%        seems to be OK for other IDs, has been corrected for wiggler (fit to insertion device</span>
0027 <span class="comment">%        compensation table)</span>
0028 <span class="comment">% - chicanes do not work in orbit feedback</span>
0029 <span class="comment">%        solved. One problem was that orbit response matrizes were mis-scaled by factor of two.</span>
0030 <span class="comment">%        Second problem was different time constant of power supply control. Solved by moving controls</span>
0031 <span class="comment">%        of center chicanes to cPCI (and magnets are fast, hysteresis free, aircore coils).</span>
0032 <span class="comment">%        Center chicane in sector 4 is now routinely used in orbit feedback. Sector 11 to follow soon.</span>
0033 <span class="comment">% - zero reading of ID gap dumps beam</span>
0034 <span class="comment">%        solved in srcontrol5, still a problem in srcontrol5_hightune (but that routine has to be completely</span>
0035 <span class="comment">%        rewritten because of all recent changes to srcontrol5, anyhow). For gap readings below the minimum</span>
0036 <span class="comment">%        allowed gap for a device, the tune feedforward disables itself.</span>
0037 <span class="comment">% - cycling of lattice causes frequent power supply failures</span>
0038 <span class="comment">%        solved by changing the cycling procedure. 1.5 GeV operation is now on the upper hysteresis branch</span>
0039 <span class="comment">%        as was the 1.9 GeV injection lattice before.</span>
0040 <span class="comment">% - frequently stalled data in IDBPM readout</span>
0041 <span class="comment">%        solved with new BPM readouts and digital filtering. Seems to have been a resolution problem</span>
0042 <span class="comment">%        of the digital averaging algorithm.</span>
0043 <span class="comment">% - magnet ramp tables are not in perfect agreement with magnetic measurements</span>
0044 <span class="comment">%        Does not appear to be a serious problem. Superbends are slightly out of sync with other magnets,</span>
0045 <span class="comment">%        but this does not cause any negative effects while ramping.</span>
0046 <span class="comment">% - no good way to operate with injection at 1.5 GeV and storage energy below that</span>
0047 <span class="comment">%        There now is a reasonable way to inject at 1.5 GeV and ramp down to lower storage energy. But</span>
0048 <span class="comment">%        it has to be tested again after implementing new (and more) chicanes ...</span>
0049 
0050 <span class="comment">% revision history</span>
0051 <span class="comment">% 2001-05-10, Christoph Steier</span>
0052 <span class="comment">% check whether readback from insertion device is significantly (more than 1 mm) below minimum</span>
0053 <span class="comment">% gap, to avoid false zero readings of insertion device gaps to cause the tune feed forward</span>
0054 <span class="comment">% to implement false huge correction (and dump the beam). If the insertion device gap readbacks</span>
0055 <span class="comment">% gets more than 1 mm below the nominal minimum gap, the routine now assumes the insertion device</span>
0056 <span class="comment">% to be open.</span>
0057 <span class="comment">%</span>
0058 <span class="comment">% 2001-08-30 and during Superbend commissioning, Christoph Steier, Tom Scarvie, Winni Decking</span>
0059 <span class="comment">% various changes have been made to incorporate the Superbends and some other new equipment</span>
0060 <span class="comment">% installed in the Superbend shutdown. This included some changes to programs being called by srcontrol</span>
0061 <span class="comment">% (like srload, srsave, srcycle, srramp, ...). The main changes within srcontrol were in the orbit</span>
0062 <span class="comment">% correction and slow orbit feedback routines (incorporating frequency feedback, ...)</span>
0063 <span class="comment">%</span>
0064 <span class="comment">% 2002-05-04, Christoph Steier</span>
0065 <span class="comment">% added new IDBPMs, modified orbit feedback to use trim DACs, removed LSB toggling in vertical</span>
0066 <span class="comment">% orbit feedback, ...</span>
0067 <span class="comment">%</span>
0068 
0069 <span class="comment">% 2002-07-29, T.Scarvie</span>
0070 <span class="comment">% added check of CM trim currents to warn of problems that might rail the orbit feedback</span>
0071 <span class="comment">%</span>
0072 <span class="comment">% 2002-07-31, Christoph Steier</span>
0073 <span class="comment">% increased the gain of the RF frequency feedback from 1/50 of the gain of the horizontal</span>
0074 <span class="comment">% orbit feedback to 1/20. Reason was that the frequency feedback was reacting a bit too slow if all</span>
0075 <span class="comment">% insertion device gaps are closed at once at high speed at the beginning of a fill.</span>
0076 <span class="comment">%</span>
0077 <span class="comment">% 2002-08-05, C.Steier, T.Scarvie</span>
0078 <span class="comment">% Added conditional to reduce orbit feedback gain if running in two-bunch mode</span>
0079 <span class="comment">%</span>
0080 <span class="comment">% 2003-06-02, T.Scarvie</span>
0081 <span class="comment">% Added loop inside orbit feedback to reset the SR11 chicane M1 and M2 motors every 20s to combat drift problem</span>
0082 <span class="comment">%</span>
0083 <span class="comment">% 2003-06-18, C. Steier</span>
0084 <span class="comment">% Disabled loop to periodically reset chicane in SR11. Al Robb replaced power supply, seems to be no problem anymore.</span>
0085 <span class="comment">%</span>
0086 <span class="comment">% 2004-05-10, C. Steier</span>
0087 <span class="comment">% The list of all BBPMs is now set up automatically be calling getlist('BBPMx'). This way, new BBPMs have to be added</span>
0088 <span class="comment">% at fewer places in the software. It should now be sufficient to modify getlist and run the orbit response matrix</span>
0089 <span class="comment">% rountine (getsmat) once to enable use of the new BBPMs.</span>
0090 <span class="comment">%</span>
0091 <span class="comment">% 2004-05-14, C. Steier</span>
0092 <span class="comment">% Modified parameters for ramprate reduction (in srramp and here). Previous parameters were slightly too</span>
0093 <span class="comment">% cautious. Increased initial slow ramprate to 0.4 A/s.</span>
0094 <span class="comment">%</span>
0095 <span class="comment">% 2004-05-14, C. Steier</span>
0096 <span class="comment">% Incorporated insertion device compensation schemes for nu_y = 9.2 lattice.</span>
0097 <span class="comment">%</span>
0098 <span class="comment">% 2004-06-14, T.Scarvie</span>
0099 <span class="comment">% Added controls for fast orbit feedback</span>
0100 <span class="comment">%</span>
0101 <span class="comment">% 2004-06-21, C. Steier</span>
0102 <span class="comment">% Added tune feedforward (in the global tune compensation scheme for the nu_y=9.2 lattice) for the shift</span>
0103 <span class="comment">% dependent tune shift of the EPUs, as well as a skew quadrupole feedforward for the EPU im sector 11</span>
0104 <span class="comment">% (both only active in parallel mode so far).</span>
0105 <span class="comment">%</span>
0106 <span class="comment">% 2005-02-13, T.Scarvie</span>
0107 <span class="comment">% Separated horizontal and vertical planes for setting Fast Feedback PIDs</span>
0108 
0109 
0110 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0111 <span class="comment">% NOTES for conversion to new Middle Layer %</span>
0112 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0113 <span class="comment">%</span>
0114 <span class="comment">% We never use the gap and bump control flags - the radio buttons have been disabled -</span>
0115 <span class="comment">%        should we try to keep the functionality?</span>
0116 <span class="comment">%</span>
0117 <span class="comment">% checksrmags</span>
0118 <span class="comment">% checksrorbit(...)</span>
0119 
0120 
0121 <span class="comment">% For the compiler</span>
0122 <span class="comment">%#function goldenpage</span>
0123 <span class="comment">%#function setoperationalmode</span>
0124 
0125 
0126 <span class="comment">% Check if the AO exists</span>
0127 checkforao;
0128 
0129 
0130 <span class="comment">%%%%%%%%%%%%%%</span>
0131 <span class="comment">% Initialize %</span>
0132 <span class="comment">%%%%%%%%%%%%%%</span>
0133 
0134 <span class="keyword">global</span> FEEDBACK_STOP_FLAG
0135 
0136 SR_Mode = getfamilydata(<span class="string">'OperationalMode'</span>);
0137 SR_GEV = getfamilydata(<span class="string">'Energy'</span>);
0138 
0139 BSCramprate = getfamilydata(<span class="string">'BSCRampRate'</span>);
0140 <span class="keyword">if</span> isnan(BSCramprate) || isempty(BSCramprate)
0141     BSCramprate = 0.4;
0142     setfamilydata(BSCramprate, <span class="string">'BSCRampRate'</span>);
0143 <span class="keyword">end</span>
0144 
0145 <span class="keyword">if</span> nargin &lt; 1
0146     action = <span class="string">'Initialize'</span>;
0147 <span class="keyword">end</span>
0148 <span class="keyword">if</span> nargin &lt; 2
0149     Input2 = 0;
0150 <span class="keyword">end</span>
0151 <span class="keyword">if</span> nargin &lt; 3
0152     Input3 = 0;
0153 <span class="keyword">end</span>
0154 
0155 <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
0156     FOFBcheckboxVal = 0;
0157 <span class="keyword">else</span>
0158     FOFBcheckboxVal = 1;
0159 <span class="keyword">end</span>
0160 
0161 <span class="comment">% if strcmp(getfamilydata('OperationalMode'), '1.5 GeV, Inject at 1.23') || strcmp(SR_Mode, '1.9 GeV, Inject at 1.353')</span>
0162 <span class="comment">%     TUNEcheckboxVal = 0;</span>
0163 <span class="comment">% else</span>
0164 TUNEcheckboxVal = 1;
0165 <span class="comment">% end</span>
0166 
0167 <span class="comment">%%%%%%%%%%%%%%%%</span>
0168 <span class="comment">% Main Program %</span>
0169 <span class="comment">%%%%%%%%%%%%%%%%</span>
0170 
0171 <span class="keyword">switch</span>(action)
0172 
0173     <span class="keyword">case</span> <span class="string">'StopOrbitFeedback'</span>
0174 
0175         FEEDBACK_STOP_FLAG = 1;
0176 
0177     <span class="keyword">case</span> <span class="string">'Initialize'</span>
0178 
0179         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0180         <span class="comment">% GUI</span>
0181         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0182         ButtonWidth = 200;
0183         ButtonHeight  = 25;
0184 
0185         Offset1 = 8*25+12 + 47 + 25+25;
0186         Offset2 = 47+25+25;
0187         Offset3 = 45+25;
0188         Offset4 = 1;
0189         Offset5 = 30;
0190         FigWidth = ButtonWidth+6;
0191         FigHeight  = 3+9*(ButtonHeight+6)+24+Offset1;
0192         ButtonWidth = 200-6;
0193 
0194         <span class="comment">% Change figure position</span>
0195         set(0,<span class="string">'Units'</span>,<span class="string">'pixels'</span>);
0196         p=get(0,<span class="string">'screensize'</span>);
0197 
0198         h0 = figure( <span class="keyword">...</span>
0199             <span class="string">'Color'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0200             <span class="string">'HandleVisibility'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0201             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0202             <span class="string">'MenuBar'</span>,<span class="string">'none'</span>, <span class="keyword">...</span>
0203             <span class="string">'Name'</span>,<span class="string">'ALS SR CONTROL'</span>, <span class="keyword">...</span>
0204             <span class="string">'NumberTitle'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0205             <span class="string">'Units'</span>,<span class="string">'pixels'</span>, <span class="keyword">...</span>
0206             <span class="string">'Position'</span>,[30 p(4)-FigHeight-40 FigWidth FigHeight+Offset5], <span class="keyword">...</span>
0207             <span class="string">'Resize'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0208             <span class="string">'Tag'</span>,<span class="string">'SRCTRLFig1'</span>);
0209 
0210         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0211             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0212             <span class="string">'Callback'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0213             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0214             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0215             <span class="string">'FontWeight'</span>,<span class="string">'Bold'</span>, <span class="keyword">...</span>
0216             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0217             <span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>, <span class="keyword">...</span>
0218             <span class="string">'Position'</span>,[6 3+8*(ButtonHeight+3)+19+19+8+Offset1  ButtonWidth 20+Offset5], <span class="keyword">...</span>
0219             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0220             <span class="string">'String'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0221             <span class="string">'Tag'</span>,<span class="string">'SRCTRLTitle'</span>);
0222 
0223         <span class="comment">% Frame Box I</span>
0224         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0225             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0226             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0227             <span class="string">'Position'</span>,[3 3+3*(ButtonHeight+3)+Offset1-3+Offset5 ButtonWidth+6 7*ButtonHeight+18], <span class="keyword">...</span>
0228             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0229 
0230         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0231             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0232             <span class="string">'Callback'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0233             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0234             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0235             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0236             <span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>, <span class="keyword">...</span>
0237             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)+Offset1  ButtonWidth 15+Offset5], <span class="keyword">...</span>
0238             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0239             <span class="string">'String'</span>,<span class="string">'Lattice Setup Functions'</span>);
0240 
0241         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0242             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Cycle'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0243             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0244             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0245             <span class="string">'Position'</span>,[6 3+8*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0246             <span class="string">'String'</span>,<span class="string">'Cycle SR Lattice'</span>, <span class="keyword">...</span>
0247             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>);
0248 
0249         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0250             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Injection'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0251             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0252             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0253             <span class="string">'Position'</span>,[6 3+7*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0254             <span class="string">'String'</span>,<span class="string">'Injection'</span>, <span class="keyword">...</span>
0255             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>);
0256 
0257         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0258             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Production'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0259             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0260             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0261             <span class="string">'Position'</span>,[6 3+6*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0262             <span class="string">'String'</span>,[<span class="string">'Production'</span>], <span class="keyword">...</span>
0263             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>);
0264 
0265         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0266             <span class="string">'Callback'</span>,[<span class="keyword">...</span>
0267             <span class="string">'fprintf(''\n'');'</span> <span class="keyword">...</span>
0268             <span class="string">'disp([''   **********************************************'']);'</span>, <span class="keyword">...</span>
0269             <span class="string">'disp([''   **  Changing Storage Ring Operational Mode  **'']);'</span>, <span class="keyword">...</span>
0270             <span class="string">'disp([''   **********************************************'']);'</span>, <span class="keyword">...</span>
0271             <span class="string">'setoperationalmode;'</span>, <span class="keyword">...</span>
0272             <span class="string">'srcontrol5(''CheckInputs'');'</span>, <span class="keyword">...</span>
0273             <span class="string">'disp([''   ****************************'']);'</span>, <span class="keyword">...</span>
0274             <span class="string">'disp([''   **  Mode Change Complete  **'']);'</span>, <span class="keyword">...</span>
0275             <span class="string">'disp([''   ****************************'']);'</span>, <span class="keyword">...</span>
0276             <span class="string">'fprintf(''\n'');'</span>], <span class="keyword">...</span>
0277             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0278             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0279             <span class="string">'Position'</span>,[6 3+5*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0280             <span class="string">'Value'</span>,1, <span class="keyword">...</span>
0281             <span class="string">'String'</span>,<span class="string">'Change Operational Mode'</span>, <span class="keyword">...</span>
0282             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>);
0283 
0284         h1 = uicontrol(<span class="keyword">...</span>
0285             <span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0286             <span class="string">'Callback'</span>, [<span class="keyword">...</span>
0287             <span class="string">'srcontrol5(''CheckInputs'');'</span>,<span class="keyword">...</span>
0288             <span class="string">'srcontrol5(''SRState'');'</span>], <span class="keyword">...</span>
0289             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0290             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0291             <span class="string">'Position'</span>,[6 3+4*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0292             <span class="string">'String'</span>,<span class="string">'Check For Problems'</span>, <span class="keyword">...</span>
0293             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>);
0294 
0295         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0296             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs''); goldenpage;'</span>, <span class="keyword">...</span>
0297             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0298             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0299             <span class="string">'Position'</span>,[6 3+3*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0300             <span class="string">'String'</span>,<span class="string">'Golden Page'</span>, <span class="keyword">...</span>
0301             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>);
0302 
0303 
0304         <span class="comment">% Frame Box II</span>
0305         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0306             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0307             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0308             <span class="string">'Position'</span>,[3 3+9*(ButtonHeight+3)-29+Offset2+Offset5 ButtonWidth+6 2*ButtonHeight+15], <span class="keyword">...</span>
0309             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0310         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0311             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0312             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0313             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0314             <span class="string">'Position'</span>,[6 3+10*(ButtonHeight+3)-10+Offset2 ButtonWidth .6*ButtonHeight+Offset5], <span class="keyword">...</span>
0315             <span class="string">'String'</span>,<span class="string">'Global/Local Orbit Correction'</span>, <span class="keyword">...</span>
0316             <span class="string">'Style'</span>,<span class="string">'text'</span>);
0317         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0318             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''OrbitCorrection'');'</span>, <span class="keyword">...</span>
0319             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0320             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0321             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)-6+Offset2+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0322             <span class="string">'String'</span>,<span class="string">'Correct Global Orbit w/ IDBPMs'</span>, <span class="keyword">...</span>
0323             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>);
0324         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0325             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''OrbitCorrectionSetup'',1);'</span>, <span class="keyword">...</span>
0326             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''OrbitCorrectionSetup'',0);'</span>, <span class="keyword">...</span>
0327             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0328             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0329             <span class="string">'Position'</span>,[6 9*(ButtonHeight+3)-22+Offset2+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0330             <span class="string">'String'</span>,<span class="string">'Edit IDBPM, CM, &amp; Local Bump Lists'</span>, <span class="keyword">...</span>
0331             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0332             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0333             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>);
0334 
0335 
0336         <span class="comment">% Frame Box III</span>
0337         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0338             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0339             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0340             <span class="string">'Position'</span>,[3 1*(ButtonHeight)+Offset3+Offset5-38 ButtonWidth+6 8*ButtonHeight+61], <span class="keyword">...</span>
0341             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0342         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0343             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0344             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0345             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0346             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)+Offset3-25 ButtonWidth .55*ButtonHeight+Offset5], <span class="keyword">...</span>
0347             <span class="string">'String'</span>,<span class="string">'Orbit Feedback'</span>, <span class="keyword">...</span>
0348             <span class="string">'Style'</span>,<span class="string">'text'</span>);
0349 
0350         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0351             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0352             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0353             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0354             <span class="string">'Position'</span>,[26 3+8*(ButtonHeight+3)+Offset3-18+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0355             <span class="string">'String'</span>,<span class="string">'Slow Orbit Correction'</span>, <span class="keyword">...</span>
0356             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0357             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0358             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxSOFB'</span>);
0359         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0360             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0361             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0362             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0363             <span class="string">'Position'</span>,[26 3+7*(ButtonHeight+3)+Offset3-9+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0364             <span class="string">'String'</span>,<span class="string">'Fast Orbit Correction'</span>, <span class="keyword">...</span>
0365             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0366             <span class="string">'Value'</span>,FOFBcheckboxVal,<span class="keyword">...</span>
0367             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxFOFB'</span>);
0368 
0369         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0370             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0371             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0372             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0373             <span class="string">'Position'</span>,[26 3+6*(ButtonHeight+3)+Offset3+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0374             <span class="string">'String'</span>,<span class="string">'Correct ID Tune Shift  '</span>, <span class="keyword">...</span>
0375             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0376             <span class="string">'Value'</span>,TUNEcheckboxVal,<span class="keyword">...</span>
0377             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxTune'</span>);
0378 
0379         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0380             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0381             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0382             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0383             <span class="string">'Position'</span>,[26 3+5*(ButtonHeight+3)+Offset3+9+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0384             <span class="string">'String'</span>,<span class="string">'Correct RF Frequency'</span>, <span class="keyword">...</span>
0385             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0386             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0387             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>);
0388 
0389         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0390             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''Feedback'');'</span>, <span class="keyword">...</span>
0391             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0392             <span class="string">'FontSize'</span>,12, <span class="keyword">...</span>
0393             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0394             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0395             <span class="string">'Position'</span>,[8 3+5*(ButtonHeight+3)+3+Offset3-25+Offset5 .5*ButtonWidth-6 1.0*ButtonHeight], <span class="keyword">...</span>
0396             <span class="string">'String'</span>,<span class="string">'Start FB'</span>, <span class="keyword">...</span>
0397             <span class="string">'Value'</span>,0, <span class="keyword">...</span>
0398             <span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>);
0399         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0400             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''StopOrbitFeedback'');pause(0);'</span>, <span class="keyword">...</span>
0401             <span class="string">'Enable'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0402             <span class="string">'FontSize'</span>,12, <span class="keyword">...</span>
0403             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0404             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0405             <span class="string">'Position'</span>,[.5*FigWidth+3 3+5*(ButtonHeight+3)+3+Offset3-25+Offset5 .5*ButtonWidth-6 1.0*ButtonHeight], <span class="keyword">...</span>
0406             <span class="string">'String'</span>,<span class="string">'Stop FB'</span>, <span class="keyword">...</span>
0407             <span class="string">'Value'</span>,0, <span class="keyword">...</span>
0408             <span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>);
0409 
0410         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0411             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0412             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0413             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0414             <span class="string">'Position'</span>,[14 4*(ButtonHeight)+Offset3+Offset5-3 ButtonWidth-14 .75*ButtonHeight], <span class="keyword">...</span>
0415             <span class="string">'String'</span>,<span class="string">'Horizontal RMS = _____ mm'</span>, <span class="keyword">...</span>
0416             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0417             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>);
0418         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0419             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0420             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0421             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0422             <span class="string">'Position'</span>,[26 3+3.5*(ButtonHeight)+16+Offset3-25+Offset5 ButtonWidth-26 .75*ButtonHeight], <span class="keyword">...</span>
0423             <span class="string">'String'</span>,<span class="string">'Vertical RMS = _____ mm'</span>, <span class="keyword">...</span>
0424             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0425             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>);
0426 
0427         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0428             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''FeedbackSetup'',1);'</span>, <span class="keyword">...</span>
0429             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''FeedbackSetup'',0);'</span>, <span class="keyword">...</span>
0430             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0431             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0432             <span class="string">'Position'</span>,[8 3+3.5*(ButtonHeight)+.5+Offset3-25+Offset5 ButtonWidth-5 .75*ButtonHeight], <span class="keyword">...</span>
0433             <span class="string">'String'</span>,<span class="string">'Edit SOFB Setup'</span>, <span class="keyword">...</span>
0434             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0435             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0436             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>);
0437 
0438         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0439             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0440             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0441             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0442             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0443             <span class="string">'String'</span>,<span class="string">'01 ____'</span>, <span class="keyword">...</span>
0444             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0445             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0446             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>);
0447 
0448         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0449             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0450             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0451             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0452             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0453             <span class="string">'String'</span>,<span class="string">'02 ____'</span>, <span class="keyword">...</span>
0454             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0455             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0456             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>);
0457 
0458         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0459             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0460             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0461             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0462             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0463             <span class="string">'String'</span>,<span class="string">'03 ____'</span>, <span class="keyword">...</span>
0464             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0465             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0466             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>);
0467 
0468         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0469             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0470             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0471             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0472             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0473             <span class="string">'String'</span>,<span class="string">'04 ____'</span>, <span class="keyword">...</span>
0474             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0475             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0476             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>);
0477 
0478         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0479             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0480             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0481             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0482             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0483             <span class="string">'String'</span>,<span class="string">'05 ____'</span>, <span class="keyword">...</span>
0484             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0485             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0486             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>);
0487 
0488         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0489             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0490             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0491             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0492             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0493             <span class="string">'String'</span>,<span class="string">'06 ____'</span>, <span class="keyword">...</span>
0494             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0495             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0496             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>);
0497 
0498         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0499             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0500             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0501             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0502             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0503             <span class="string">'String'</span>,<span class="string">'07 ____'</span>, <span class="keyword">...</span>
0504             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0505             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0506             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>);
0507 
0508         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0509             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0510             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0511             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0512             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0513             <span class="string">'String'</span>,<span class="string">'08 ____'</span>, <span class="keyword">...</span>
0514             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0515             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0516             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>);
0517 
0518         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0519             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0520             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0521             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0522             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0523             <span class="string">'String'</span>,<span class="string">'09 ____'</span>, <span class="keyword">...</span>
0524             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0525             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0526             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>);
0527 
0528         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0529             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0530             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0531             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0532             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0533             <span class="string">'String'</span>,<span class="string">'10 ____'</span>, <span class="keyword">...</span>
0534             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0535             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0536             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>);
0537 
0538         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0539             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0540             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0541             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0542             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0543             <span class="string">'String'</span>,<span class="string">'11 ____'</span>, <span class="keyword">...</span>
0544             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0545             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0546             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>);
0547 
0548         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0549             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0550             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0551             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0552             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0553             <span class="string">'String'</span>,<span class="string">'12 ____'</span>, <span class="keyword">...</span>
0554             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0555             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0556             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>);
0557 
0558         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0559             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''FastFeedbackSetup'',1);'</span>, <span class="keyword">...</span>
0560             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''FastFeedbackSetup'',0);'</span>, <span class="keyword">...</span>
0561             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0562             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0563             <span class="string">'Position'</span>,[8 1*(ButtonHeight)+Offset3-3 ButtonWidth-5 .75*ButtonHeight], <span class="keyword">...</span>
0564             <span class="string">'String'</span>,<span class="string">'Edit FOFB Setup'</span>, <span class="keyword">...</span>
0565             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0566             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0567             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>);
0568 
0569         <span class="comment">% Frame Box IV</span>
0570         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0571             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0572             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0573             <span class="string">'Position'</span>,[3 3+ButtonHeight+Offset4-14+Offset5 ButtonWidth+6 ButtonHeight+12], <span class="keyword">...</span>
0574             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0575         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0576             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0577             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0578             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0579             <span class="string">'Position'</span>,[6 3+1.75*ButtonHeight+5+Offset4-21+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0580             <span class="string">'String'</span>,<span class="string">'Storage Ring State'</span>, <span class="keyword">...</span>
0581             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0582             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHeader'</span>);
0583         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0584             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''CheckInputs'');'</span>, <span class="keyword">...</span>
0585             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0586             <span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>, <span class="keyword">...</span>
0587             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0588             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0589             <span class="string">'Position'</span>,[6 3+ButtonHeight+6+3+2+Offset4-22+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0590             <span class="string">'String'</span>,<span class="string">'   '</span>, <span class="keyword">...</span>
0591             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0592             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>);
0593 
0594 
0595         <span class="comment">% Frame Box &quot;Close&quot;</span>
0596         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0597             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0598             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0599             <span class="string">'Position'</span>,[3 8 ButtonWidth+6 ButtonHeight+8], <span class="keyword">...</span>
0600             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0601         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0602             <span class="string">'Callback'</span>,<span class="string">'close(gcbf);'</span>, <span class="keyword">...</span>
0603             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0604             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0605             <span class="string">'Position'</span>,[6 13 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0606             <span class="string">'String'</span>,<span class="string">'Close'</span>, <span class="keyword">...</span>
0607             <span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>);
0608 
0609 
0610         <span class="comment">% Update database channels</span>
0611         <a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>;
0612 
0613         <span class="keyword">if</span> nargout &gt; 0
0614             fig = h0;
0615         <span class="keyword">end</span>
0616 
0617 
0618     <span class="keyword">case</span> <span class="string">'Cycle'</span>
0619         GapFlag = Input2;
0620         BumpMagnetFlag = Input3;
0621 
0622         fprintf(<span class="string">'\n'</span>);
0623         disp(<span class="string">'   **************************'</span>);
0624         disp(<span class="string">'   **  Storage Ring Cycle  **'</span>);
0625         disp(<span class="string">'   **************************'</span>);
0626         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
0627 
0628         BSCFlag = questdlg(sprintf(<span class="string">'Cycle Superbend Magnets?'</span>),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0629         <span class="comment">%if strcmp(BSCFlag,'No')</span>
0630         <span class="comment">%    disp(['   ** Superbends will not be cycled. **']);</span>
0631         <span class="comment">%else</span>
0632         <span class="comment">%    disp(['   ** Superbends will be cycled during the second mini-cycle only. **']);</span>
0633         <span class="comment">%end</span>
0634 
0635         ChicSQFlag = questdlg(sprintf(<span class="string">'Cycle chicanes and skew quads and home motor chicanes?'</span>),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0636         <span class="comment">%if strcmp(ChicSQFlag,'No')</span>
0637         <span class="comment">%    disp(['   ** Chicanes and skew quads will not be cycled; motor chicanes will not be homed. **']);</span>
0638         <span class="comment">%else</span>
0639         <span class="comment">%    disp(['   ** Chicanes and skew quads will be cycled; motor chicanes will be homed. **']);</span>
0640         <span class="comment">%end</span>
0641 
0642 
0643         StartFlag = questdlg(sprintf(<span class="string">'Start %.1f GeV Cycle?'</span>,SR_GEV),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0644         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
0645             disp([<span class="string">'   ***************************'</span>]);
0646             disp([<span class="string">'   **    Cycle  Canceled    **'</span>]);
0647             disp([<span class="string">'   ***************************'</span>]);
0648             fprintf(<span class="string">'\n'</span>);
0649             <span class="keyword">return</span>
0650         <span class="keyword">end</span>
0651 
0652         <span class="keyword">try</span>
0653             <span class="keyword">if</span> GapFlag
0654                 <span class="comment">% Make sure that the gaps are open with FF off</span>
0655                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0656                     <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0657                     disp(<span class="string">'   Insertion device gaps are not open.'</span>);
0658                     disp(<span class="string">'   Opening all gaps at maximum speed.'</span>);
0659                     <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0660                     disp(<span class="string">'   Gap control disabled.'</span>);
0661                     disp(<span class="string">'   Feed forward enabled.'</span>);
0662                     pause(1);
0663                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag)">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0664                     disp(<span class="string">'   Gaps opened.'</span>);
0665                     disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0666                     a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0667                 <span class="keyword">else</span>
0668                     disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0669                 <span class="keyword">end</span>
0670             <span class="keyword">else</span>
0671                 disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0672             <span class="keyword">end</span>
0673 
0674             <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0675             pause(1);
0676             
0677             <a href="srcycle.html" class="code" title="function FailFlag = srcycle(varargin)">srcycle</a>(BSCFlag, ChicSQFlag);
0678 
0679             setpv(<span class="string">'SR_STATE'</span>,1);
0680 
0681         <span class="keyword">catch</span>
0682 
0683             fprintf(<span class="string">'   %s \n'</span>,lasterr);
0684             fprintf(<span class="string">'   Cycle failed due to error condition! \n\n'</span>);
0685             setpv(<span class="string">'SR_STATE'</span>,-1);
0686             
0687         <span class="keyword">end</span>
0688 
0689         date;
0690         a = clock;
0691         datestr1=date;
0692         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0693         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0694         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0695         <span class="keyword">if</span> StateNumber &gt;= 0
0696             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0697             disp(<span class="string">'   **********************************************'</span>);
0698             disp(<span class="string">'   **  SR Cycle complete, ready for injection  **'</span>);
0699             disp(<span class="string">'   **********************************************'</span>); fprintf(<span class="string">'\n'</span>);
0700         <span class="keyword">else</span>
0701             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0702             disp(<span class="string">'   **********************************'</span>);
0703             disp(<span class="string">'   **  Problem cycling SR lattice  **'</span>);
0704             disp(<span class="string">'   **********************************'</span>); fprintf(<span class="string">'\n'</span>);
0705         <span class="keyword">end</span>
0706         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0707         
0708 
0709     <span class="keyword">case</span> <span class="string">'Injection'</span>
0710         AD = getad;
0711         GapFlag = Input2;
0712         BumpMagnetFlag = Input3;
0713 
0714         fprintf(<span class="string">'\n'</span>);
0715         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0716 
0717         <span class="keyword">if</span> abs(AD.Energy - AD.InjectionEnergy) &gt; .05
0718             fprintf(<span class="string">'   ***************************************************\n'</span>);
0719             fprintf(<span class="string">'   **  Setup For %.2f GeV Injection (with ramping)  **\n'</span>, getfamilydata(<span class="string">'InjectionEnergy'</span>));
0720             fprintf(<span class="string">'   ***************************************************\n'</span>);
0721             <a href="set_alarmhandler_AHU_thresholds_inject.html" class="code" title="function set_alarmhandler_AHU_thresholds_inject">set_alarmhandler_AHU_thresholds_inject</a>;
0722             StartFlag = questdlg(sprintf(<span class="string">'Start setup for injection, %.2f GeV?'</span>,getfamilydata(<span class="string">'InjectionEnergy'</span>)),<span class="string">'Injection Setup'</span>,<span class="string">'Ramp quickly'</span>,<span class="string">'Ramp slowly'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0723         <span class="keyword">else</span>
0724             fprintf(<span class="string">'   *************************************************\n'</span>);
0725             fprintf(<span class="string">'   **  Setup For On Energy Injection at %.2f GeV  **\n'</span>, SR_GEV);
0726             fprintf(<span class="string">'   *************************************************\n'</span>);
0727             StartFlag = questdlg(sprintf(<span class="string">'Start setup for injection, %.2f GeV?'</span>,SR_GEV),<span class="string">'Injection Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0728         <span class="keyword">end</span>
0729         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'Cancel'</span>)
0730             disp([<span class="string">'   ********************************'</span>]);
0731             disp([<span class="string">'   **  Injection Setup Canceled  **'</span>]);
0732             disp([<span class="string">'   ********************************'</span>]);
0733             <span class="comment">%set_alarmhandler_thresholds_new;</span>
0734             fprintf(<span class="string">'\n'</span>);
0735             <span class="keyword">return</span>
0736         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp quickly'</span>)
0737             setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0738         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp slowly'</span>)
0739             setfamilydata(0.4, <span class="string">'BSCRampRate'</span>);
0740         <span class="keyword">end</span>
0741 
0742         <span class="keyword">try</span>
0743 
0744             <span class="keyword">if</span> GapFlag
0745                 <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([],1,0);
0746                 disp(<span class="string">'   Gap control disabled'</span>);
0747                 disp(<span class="string">'   Feed forward enabled'</span>);
0748                 pause(1);
0749 
0750                 <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0751                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0752                     disp(<span class="string">'   Opening all gaps'</span>);
0753                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag)">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0754                 <span class="keyword">end</span>
0755 
0756                 disp(<span class="string">'   Gaps are open'</span>);
0757                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0758                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0759             <span class="keyword">else</span>
0760                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0761             <span class="keyword">end</span>
0762 
0763             <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0764             pause(1);
0765 
0766             <span class="keyword">if</span> (AD.Energy-AD.InjectionEnergy) &gt; 0.05
0767                 <span class="comment">% Ramp down to Injection Energy</span>
0768                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,<span class="string">'Ramping Down'</span>,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0769                 drawnow;
0770                 ErrorFlag = <a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>(<span class="string">'Injection'</span>);
0771                 <span class="keyword">if</span> ErrorFlag
0772                     error(<span class="string">'Superbends over temperature.'</span>);
0773                 <span class="keyword">end</span>
0774                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n\n'</span>,date, a(4), a(5), a(6));
0775 
0776             <span class="keyword">elseif</span> (AD.Energy-AD.InjectionEnergy) &lt; -0.05
0777 
0778                 <span class="comment">% first load injection lattice, then ramp to 1.9 GeV and back to 1.5 GeV to get onto same hysteresis branch</span>
0779 
0780                 srload(<span class="string">'Injection'</span>);
0781 
0782                 <span class="comment">% load 1.9 GeV lattice</span>
0783                 tempfilename = sprintf(<span class="string">'%s19nuy9prod.mat'</span>, getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>));
0784 
0785                 srload(tempfilename);
0786 
0787                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0788 
0789                 pause(5);
0790 
0791             <span class="keyword">end</span>
0792 
0793             srload(<span class="string">'Injection'</span>);
0794 
0795             setpv(<span class="string">'SR_STATE'</span>,2);
0796 
0797         <span class="keyword">catch</span>
0798 
0799             fprintf(<span class="string">'   %s \n'</span>,lasterr);
0800             fprintf(<span class="string">'   Injection lattice setup failed due to error condition! \n\n'</span>);
0801             setpv(<span class="string">'SR_STATE'</span>,-2);
0802 
0803         <span class="keyword">end</span>
0804 
0805 
0806         date;
0807         a = clock;
0808         datestr1=date;
0809         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0810         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0811         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0812         <span class="keyword">if</span> StateNumber &gt;= 0
0813             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0814             <span class="keyword">if</span> AD.Energy &lt;= 1.5
0815                 disp([<span class="string">'   *******************************************************************************'</span>]);
0816                 disp([<span class="string">'   **  Function complete:  the storage ring is setup for injection at '</span>,sprintf(<span class="string">'%.2f'</span>,SR_GEV),<span class="string">' GeV  **'</span>]);
0817                 disp([<span class="string">'   *******************************************************************************'</span>]); 
0818                 fprintf(<span class="string">'\n'</span>);
0819             <span class="keyword">else</span>
0820                 fprintf(<span class="string">'   **********************************************************************************************\n'</span>);
0821                 fprintf(<span class="string">'   **  Function complete:  the storage ring is setup for injection at %.2f GeV (upper branch)  **\n'</span>, getfamilydata(<span class="string">'InjectionEnergy'</span>));
0822                 fprintf(<span class="string">'   **********************************************************************************************\n'</span>); 
0823                 fprintf(<span class="string">'\n'</span>);
0824             <span class="keyword">end</span>
0825         <span class="keyword">else</span>
0826             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0827             disp([<span class="string">'   ************************************'</span>]);
0828             disp([<span class="string">'   **  Problem with injection setup  **'</span>]);
0829             disp([<span class="string">'   ************************************'</span>]); 
0830             fprintf(<span class="string">'\n'</span>);
0831         <span class="keyword">end</span>
0832         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0833 
0834         <span class="comment">%soundchord;</span>
0835 
0836         setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0837 
0838 
0839     <span class="keyword">case</span> <span class="string">'Production'</span>
0840         GapFlag = Input2;
0841         BumpMagnetFlag = Input3;
0842         AD=getad;
0843         
0844         fprintf(<span class="string">'\n'</span>);
0845         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0846 
0847         <span class="keyword">if</span> abs(AD.Energy - AD.InjectionEnergy) &gt; .05
0848             disp(<span class="string">'   ********************************************************'</span>);
0849             disp(sprintf(<span class="string">'   **  Setup For %.2f GeV User Operation (with ramping)  **'</span>,SR_GEV));
0850             disp(<span class="string">'   ********************************************************'</span>);
0851             StartFlag = questdlg(sprintf(<span class="string">'Start setup for users, %.1f GeV?'</span>,SR_GEV),<span class="string">'User Setup'</span>,<span class="string">'Ramp quickly'</span>,<span class="string">'Ramp slowly'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0852         <span class="keyword">else</span>
0853             disp(<span class="string">'   *****************************************'</span>);
0854             disp(sprintf(<span class="string">'   **  Setup For %.2f GeV User Operation  **'</span>,SR_GEV));
0855             disp(<span class="string">'   *****************************************'</span>);
0856             StartFlag = questdlg(sprintf(<span class="string">'Start setup for users, %.1f GeV?'</span>,SR_GEV),<span class="string">'User Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0857         <span class="keyword">end</span>
0858 
0859         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'Cancel'</span>)
0860             disp([<span class="string">'   ***************************'</span>]);
0861             disp([<span class="string">'   **  User Setup Canceled  **'</span>]);
0862             disp([<span class="string">'   ***************************'</span>]);
0863             fprintf(<span class="string">'\n'</span>);
0864             <span class="keyword">return</span>
0865         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp quickly'</span>)
0866             setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0867         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp slowly'</span>)
0868             setfamilydata(0.4, <span class="string">'BSCRampRate'</span>);
0869         <span class="keyword">end</span>
0870 
0871         <span class="keyword">try</span>
0872 
0873             <span class="keyword">if</span> GapFlag
0874                 <span class="comment">% Make sure that the gaps are open</span>
0875                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0876                     <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0877                     disp(<span class="string">'   Insertion device gaps are not open'</span>);
0878                     disp(<span class="string">'   Opening all gaps at maximum speed'</span>);
0879                     <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0880                     disp(<span class="string">'   Gap control disabled'</span>);
0881                     disp(<span class="string">'   Feed forward enabled'</span>);
0882                     pause(1);
0883                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag)">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0884                     disp(<span class="string">'   Gaps opened'</span>);
0885                     disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0886                     a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0887                 <span class="keyword">else</span>
0888                     disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0889                 <span class="keyword">end</span>
0890             <span class="keyword">else</span>
0891                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0892             <span class="keyword">end</span>
0893 
0894             <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0895             pause(1);
0896 
0897             <span class="comment">%%%%%%%%%%%%%%%</span>
0898             <span class="keyword">if</span> (AD.Energy-AD.InjectionEnergy) &gt; 0.05
0899                 <span class="comment">% Ramp up to the production lattice</span>
0900                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,<span class="string">'Ramping Up'</span>,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0901                 drawnow;
0902                 ErrorFlag = <a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>(<span class="string">'Production'</span>);
0903                 <span class="keyword">if</span> ErrorFlag
0904                     error(<span class="string">'Superbends over temperature.'</span>);
0905                 <span class="keyword">end</span>
0906                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0907 
0908                 srload(<span class="string">'Production'</span>);
0909 
0910 
0911             <span class="keyword">elseif</span> abs(AD.Energy-AD.InjectionEnergy) &lt; 0.05
0912 
0913                 <span class="comment">% load production lattice - no ramp required</span>
0914 
0915                 srload(<span class="string">'Production'</span>);
0916 
0917                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0918 
0919                 pause(5);
0920 
0921             <span class="keyword">end</span>
0922             <span class="comment">%%%%%%%%%%%%%%%</span>
0923 
0924             <span class="keyword">if</span> GapFlag
0925                 <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0926                 disp(<span class="string">'   Gap control disabled'</span>);
0927                 disp(<span class="string">'   Feed forward enable'</span>);
0928                 pause(1);
0929 
0930                 disp(<span class="string">'   Insertion device velocity profile boolean control off'</span>);
0931                 disp(<span class="string">'   Closing all gaps at maximum speed'</span>);
0932 
0933                 <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0934                 [Position, Velocity, RunFlag, UserGap] = <a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>;
0935 
0936                 <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag)">setid</a>([], UserGap, maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0937 
0938                 <span class="comment">% Turn velocity profile on</span>
0939                 disp(<span class="string">'   Insertion device velocity profile boolean control is on'</span>);
0940                 <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag)">setid</a>([], [], maxsp(<span class="string">'IDvel'</span>), 1, 1, 0);
0941 
0942                 disp(<span class="string">'   Gaps are closed'</span>);
0943                 <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([4;7;8;9;10;12], 1, 1);
0944                 <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>(5, 1, 0);
0945                 disp(<span class="string">'   Gap control enabled (except sector 5 (W16))'</span>);
0946             <span class="keyword">end</span>
0947 
0948             <span class="comment">%set_alarmhandler_thresholds_new;</span>
0949             setpv(<span class="string">'SR_STATE'</span>,3);
0950 
0951         <span class="keyword">catch</span>
0952 
0953             fprintf(<span class="string">'   %s \n'</span>, lasterr);
0954             fprintf(<span class="string">'   User lattice setup failed due to error condition! \n\n'</span>);
0955             setpv(<span class="string">'SR_STATE'</span>,-3);
0956 
0957         <span class="keyword">end</span>
0958 
0959         <span class="comment">%give JH scrapers a chance to move</span>
0960         pause(15);
0961         
0962         a = clock;
0963         datestr1=date;
0964         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0965         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0966         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0967         <span class="keyword">if</span> StateNumber &gt;= 0
0968             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0969             disp([<span class="string">'   **************************************************************************'</span>]);
0970             disp([<span class="string">'   **  Function complete:  the storage ring is setup for users at '</span>,sprintf(<span class="string">'%.1f'</span>,SR_GEV),<span class="string">' GeV  **'</span>]);
0971             disp([<span class="string">'   **************************************************************************'</span>]); fprintf(<span class="string">'\n'</span>);
0972         <span class="keyword">else</span>
0973             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0974             disp([<span class="string">'   *************************************'</span>]);
0975             disp([<span class="string">'   **  Problem with production setup  **'</span>]);
0976             disp([<span class="string">'   *************************************'</span>]); fprintf(<span class="string">'\n'</span>);
0977         <span class="keyword">end</span>
0978         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0979 
0980         setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0981 
0982 
0983 <span class="comment">%         % for BL6.0.x, set lower setpoint limit for IVID to 12.5mm until beamlines are surveyed below that value</span>
0984 <span class="comment">%         try</span>
0985 <span class="comment">%             scaput('SR06U___GDS1PS_AC00.DRVL',12.5);</span>
0986 <span class="comment">%             disp('  Setting SR06U___GDS1PS_AC00.DRVL to 12.5mm (lower limit for IVID');</span>
0987 <span class="comment">%         catch</span>
0988 <span class="comment">%             disp('  Trouble setting lower limit for IVID to 12.5mm!');</span>
0989 <span class="comment">%         end</span>
0990 
0991         
0992     <span class="keyword">case</span> <span class="string">'CheckInputs'</span>
0993 
0994         SR_GEV = getfamilydata(<span class="string">'Energy'</span>);
0995         AD=getad;
0996         <a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>; 
0997 
0998         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0999 
1000         <span class="keyword">if</span> AD.Energy &gt; 1.55 &amp; AD.InjectionEnergy &lt; 1.55
1001             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection (Ramp Down)'</span>]);
1002             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users (Ramp Up)'</span>]);
1003         <span class="keyword">elseif</span> AD.Energy &lt; 1.45
1004             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection (Ramp Up+cycle)'</span>]);
1005             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users, '</span>,num2str(round(10*SR_GEV)/10),<span class="string">' GeV (Ramp Down)'</span>]);
1006         <span class="keyword">else</span>
1007             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection'</span>]);
1008             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users, '</span>,num2str(round(10*SR_GEV)/10),<span class="string">' GeV'</span>]);
1009         <span class="keyword">end</span>
1010         set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLTitle'</span>),<span class="string">'String'</span>,SR_Mode);
1011 
1012         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1013         <span class="keyword">if</span> StateNumber &gt;= 0
1014             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1015         <span class="keyword">else</span>
1016             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1017         <span class="keyword">end</span>
1018 
1019         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1020 
1021 
1022     <span class="keyword">case</span> <span class="string">'SRState'</span>
1023         NumErrors = 0;
1024         fprintf(<span class="string">'\n'</span>);
1025         disp(<span class="string">'   ***********************************'</span>);
1026         disp(<span class="string">'   **  Checking Storage Ring State  **'</span>);
1027         disp(<span class="string">'   ***********************************'</span>);
1028         a = clock;
1029         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1030 
1031         <span class="comment">%       FileName = getpv('SR_LATTICE_FILE','String');   % Last srload file name (in OLD MIDDLE LAYER nomenclature!!)</span>
1032 
1033         GeVnow = <a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>;
1034         <span class="keyword">if</span> GeVnow == getfamilydata(<span class="string">'Energy'</span>)
1035             [ConfigSetpoint, ConfigMonitor, FileName] = getproductionlattice;
1036         <span class="keyword">elseif</span> GeVnow == getfamilydata(<span class="string">'InjectionEnergy'</span>)
1037             [ConfigSetpoint, ConfigMonitor, FileName] = getinjectionlattice;
1038         <span class="keyword">else</span>
1039             FileName = <span class="string">''</span>;
1040         <span class="keyword">end</span>
1041 
1042         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1043         fprintf(<span class="string">'   Storage ring operational mode: %s\n'</span>, SR_Mode);
1044         <span class="keyword">if</span> StateNumber &lt; 0
1045             fprintf(<span class="string">'   Storage ring state error: %s\n'</span>, StateString);
1046             NumErrors = NumErrors + 1;
1047         <span class="keyword">else</span>
1048             fprintf(<span class="string">'   Storage ring state: %s\n'</span>, StateString);
1049         <span class="keyword">end</span>
1050         <span class="keyword">if</span> StateNumber==0
1051             <span class="comment">% Storage ring state unknown</span>
1052             NumErrors = NumErrors + 1;
1053         <span class="keyword">elseif</span> abs(StateNumber)==1 || abs(StateNumber)==2
1054             FileNameGoal = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>) getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'InjectionFile'</span>) <span class="string">'.mat'</span>];
1055             <span class="keyword">if</span> ~strcmp(FileName, FileNameGoal)
1056                 fprintf(<span class="string">'   Lattice file %s should be loaded but it appears that %s is loaded.\n'</span>, getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'InjectionFile'</span>), FileName);
1057                 NumErrors = NumErrors + 1;
1058             <span class="keyword">end</span>
1059         <span class="keyword">else</span>
1060             FileNameGoal = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>) getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'LatticeFile'</span>) <span class="string">'.mat'</span>];
1061             <span class="keyword">if</span> ~strcmp(FileName, FileNameGoal)
1062                 fprintf(<span class="string">'   Lattice file %s should be loaded but it appears that %s is loaded.\n'</span>, getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'LatticeFile'</span>), FileName);
1063                 NumErrors = NumErrors + 1;
1064             <span class="keyword">end</span>
1065         <span class="keyword">end</span>
1066 
1067 
1068         <span class="comment">% Check all SR magnets</span>
1069         <span class="keyword">if</span> isempty(FileName)
1070             fprintf(<span class="string">'   Goal setpoints will not be checked since the last lattice load is unknown.\n'</span>);
1071             NumErrors1 = <a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>(<span class="string">''</span>);
1072         <span class="keyword">else</span>
1073 <span class="comment">%            NumErrors1 = checksrmags([getfamilydata('Directory','OpsData') FileName]);</span>
1074             NumErrors1 = <a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>(FileName);
1075         <span class="keyword">end</span>
1076         <span class="keyword">if</span> NumErrors1 == 0
1077             fprintf(<span class="string">'   SR magnets power supplies are OK.\n'</span>);
1078         <span class="keyword">end</span>
1079         NumErrors = NumErrors + NumErrors1;
1080 
1081 
1082         <span class="comment">% Check RF frequency</span>
1083         <span class="keyword">if</span> isempty(FileName)
1084             fprintf(<span class="string">'   RF frequency will not be checked since the last lattice load is unknown.\n'</span>);
1085         <span class="keyword">else</span>
1086 <span class="comment">%            load([getfamilydata('Directory','OpsData'), FileName]);</span>
1087             load(FileName);
1088             [tmp, RFHPCounterPresent] = getrf;
1089             <span class="keyword">if</span> abs(RFHPCounterPresent-ConfigSetpoint.RF.Setpoint.Data) &gt; .002
1090                 NumErrors = NumErrors + 1;
1091                 fprintf(<span class="string">'   RF frequency should be %f, presently it is %f MHz (as measured by the HP counter).\n'</span>, ConfigSetpoint.RF.Setpoint.Data, RFHPCounterPresent);
1092             <span class="keyword">else</span>
1093                 fprintf(<span class="string">'   RF frequency is OK (HP counter is %f MHz, at the time of the lattice save it was %f MHz).\n'</span>, RFHPCounterPresent, ConfigSetpoint.RF.Setpoint.Data);
1094             <span class="keyword">end</span>
1095         <span class="keyword">end</span>
1096 
1097 
1098         <span class="comment">% Check for orbit problems</span>
1099         <span class="keyword">if</span> (StateNumber &gt;= 3) &amp;&amp; (getdcct &gt; 2)   <span class="comment">% Production lattice is loaded with beam in the machine</span>
1100             Xtol = 0.070;
1101             Ytol = 0.010;
1102             NumErrors1 = <a href="checksrorbit.html" class="code" title="function ErrorNums = checksrorbit(SectorList, BPMxtol,BPMytol)">checksrorbit</a>([],Xtol,Ytol);
1103             <span class="keyword">if</span> NumErrors1
1104                 fprintf(<span class="string">'   SR orbit in the ID straight sections or at Bergoz BPMs deviates more than allowed from the golden orbit.\n'</span>);
1105             <span class="keyword">else</span>
1106                 fprintf(<span class="string">'   SR orbit in the ID straight sections and at Bergoz BPMs is OK.\n'</span>);
1107                 fprintf(<span class="string">'   The orbit is within %.3f mm horizontally and %.3f mm vertically'</span>, Xtol, Ytol);
1108             <span class="keyword">end</span>
1109             NumErrors = NumErrors + NumErrors1;
1110         <span class="keyword">else</span>
1111             fprintf(<span class="string">'   Storage ring orbit was not checked.\n'</span>);
1112         <span class="keyword">end</span>
1113 
1114 
1115         a = clock;
1116         datestr1=date;
1117         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
1118         <span class="keyword">if</span> NumErrors
1119             disp(<span class="string">'   *********************************'</span>);
1120             disp(<span class="string">'   **  Storage Ring Has Problems  **'</span>);
1121             disp(<span class="string">'   *********************************'</span>);
1122         <span class="keyword">else</span>
1123             disp(<span class="string">'   **********************************'</span>);
1124             disp(<span class="string">'   **  Storage Ring Lattice is OK  **'</span>);
1125             disp(<span class="string">'   **********************************'</span>);
1126         <span class="keyword">end</span>
1127         fprintf(<span class="string">'   \n'</span>);
1128 
1129         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1130         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1131         <span class="keyword">if</span> StateNumber &gt;= 0
1132             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1133         <span class="keyword">else</span>
1134             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1135         <span class="keyword">end</span>
1136         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1137 
1138 
1139     <span class="keyword">case</span> <span class="string">'OrbitCorrection'</span>
1140         fprintf(<span class="string">'\n'</span>);
1141         fprintf(<span class="string">'   *********************************\n'</span>);
1142         fprintf(<span class="string">'   **  Starting Orbit Correction  **\n'</span>);
1143         fprintf(<span class="string">'   *********************************\n'</span>);
1144         a = clock;
1145         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1146 
1147         StartFlag = questdlg(sprintf(<span class="string">'Start orbit correction, %.1f GeV?'</span>,SR_GEV),<span class="string">'Orbit Correction'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
1148         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
1149             disp([<span class="string">'   ********************************'</span>]);
1150             disp([<span class="string">'   **  Orbit Correction Aborted  **'</span>]);
1151             disp([<span class="string">'   ********************************'</span>]);
1152             fprintf(<span class="string">'\n'</span>);
1153             <span class="keyword">return</span>
1154         <span class="keyword">end</span>
1155 
1156         <span class="keyword">if</span> getdcct &lt; 5     <span class="comment">% Don't correct the orbit if the current is too small</span>
1157             fprintf(<span class="string">'   Orbit not corrected due to small current.\n'</span>);
1158             <span class="keyword">return</span>
1159         <span class="keyword">end</span>
1160 
1161         <span class="keyword">if</span> abs(SR_GEV-<a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>(getpv(<span class="string">'BEND'</span>,<span class="string">'Setpoint'</span>,[1 1])))&gt;  0.05     <span class="comment">% Don't use this routine for the injection lattice</span>
1162             fprintf(<span class="string">'   This routine should only be used for the production energy: Correction aborted\n'</span>);
1163             <span class="keyword">return</span>
1164         <span class="keyword">end</span>
1165 
1166         SR_STATE_OLD = scaget(<span class="string">'SR_STATE'</span>);
1167         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1168         setpv(<span class="string">'SR_STATE'</span>,4);
1169         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1170         <span class="keyword">if</span> StateNumber &gt;= 0
1171             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1172         <span class="keyword">else</span>
1173             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1174         <span class="keyword">end</span>
1175         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1176 
1177 
1178         <span class="keyword">try</span>
1179             <span class="comment">% save current BPM timeconstant - will reset to this after correction</span>
1180             BPMtimeconstantOC = <a href="getbpmtimeconstant.html" class="code" title="function [BPMTimeConstant, WarningFlag] = getbpmtimeconstant(varargin)">getbpmtimeconstant</a>;
1181             fprintf(<span class="string">'   Current Bergoz BPM time constant is %.1fs\n'</span>, BPMtimeconstantOC);
1182 
1183             <span class="comment">% 2 Hz update rate on IDBPMs</span>
1184             disp(<span class="string">'   Bergoz BPM time constant set to 0.5s.'</span>)
1185             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.5)
1186             pause(2);
1187 
1188 
1189             <span class="comment">% Turn off feed forward</span>
1190             fprintf(<span class="string">'   Turning feed forward off.\n'</span>);
1191             [FFEnableBM, FFEnableBC] = <a href="getff.html" class="code" title="function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)">getff</a>;
1192             <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 0);
1193             scasleep(.2);
1194 
1195 
1196             <span class="comment">% Get vectors</span>
1197             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>);
1198             LocalBumplist = FB.LocalBumplist;
1199 
1200         <span class="keyword">catch</span>
1201 
1202             fprintf(<span class="string">'   %s \n'</span>,lasterr);
1203             fprintf(<span class="string">'   Orbit correction setup failed due to error condition! \n\n'</span>);
1204             setpv(<span class="string">'SR_STATE'</span>,-4);
1205             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1206             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1207             <span class="keyword">if</span> StateNumber &gt;= 0
1208                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1209             <span class="keyword">else</span>
1210                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1211             <span class="keyword">end</span>
1212             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1213 
1214             <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1215             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1216             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1217             <span class="keyword">return</span>
1218         <span class="keyword">end</span>
1219 
1220         iNotHCMChicane = find(FB.HCMlist1(:,2) &lt; 10); <span class="comment">%used by steppv's for setting correctors in loop</span>
1221         iHCMChicane = find(FB.HCMlist1(:,2) == 10);
1222         iNotVCMChicane = find(FB.VCMlist1(:,2) &lt; 10);
1223         iVCMChicane = find(FB.VCMlist1(:,2) == 10);
1224 
1225         fprintf(<span class="string">'   Starting horizontal and vertical global orbit correction (SVD method).\n'</span>);
1226 
1227         <span class="keyword">for</span> iloop = 1:3
1228             <span class="keyword">try</span>
1229                 <span class="comment">% use the following to get corrector settings in OCS without setting them, so the values can be checked</span>
1230                 FB.OCSx = setorbit(FB.OCSx,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1231                 FB.OCSy = setorbit(FB.OCSy,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1232                 <span class="keyword">if</span> any(abs(FB.OCSx.CM.Delta(iNotHCMChicane)) &gt; 5)
1233                   disp(<span class="string">'   Orbit Correction is changing some horizontal corrector(s) &gt; 5A!!'</span>);
1234                 <span class="keyword">end</span>
1235                 <span class="keyword">if</span> any(abs(FB.OCSy.CM.Delta(iNotVCMChicane)) &gt; 5)
1236                   disp(<span class="string">'   Orbit Correction is changing some vertical corrector(s) &gt; 5A!!'</span>);
1237                 <span class="keyword">end</span>
1238                 <span class="keyword">if</span> any(abs(FB.OCSx.CM.Delta(iHCMChicane)) &gt; 10)
1239                   disp(<span class="string">'   Orbit Correction is changing some horizontal chicane corrector(s) &gt; 10A!!'</span>);
1240                 <span class="keyword">end</span>
1241                 <span class="keyword">if</span> any(abs(FB.OCSy.CM.Delta(iVCMChicane)) &gt; 10)
1242                     disp(<span class="string">'   Orbit Correction is changing some vertical chicane corrector(s) &gt; 10A!!'</span>);
1243                 <span class="keyword">end</span>
1244 
1245                 <span class="comment">% Correct RF</span>
1246                 rf0=getrf;
1247                 nRFsteps = ceil(abs(FB.OCSx.DeltaRF/10e-6));
1248                 <span class="keyword">if</span> nRFsteps &gt; 50
1249                     nRFsteps = 50;
1250                 <span class="keyword">end</span>
1251                 <span class="keyword">for</span> loop = 1:nRFsteps
1252                     steprf(FB.OCSx.DeltaRF/nRFsteps,0);
1253                 <span class="keyword">end</span>
1254                 fprintf(<span class="string">'   %d. nRFsteps = %d, DelRF = %.1f Hz\n'</span>,iloop, nRFsteps, FB.OCSx.DeltaRF*1e6);
1255 <span class="comment">%               fprintf('   %d. RF change = %.1f Hz, nRFsteps = %d, DelRF = %.1f Hz\n',iloop, (getrf-rf0)*1e6, nRFsteps, FB.OCSx.DeltaRF*1e6);</span>
1256 
1257                 <span class="comment">% Correct horizontal and vertical orbits</span>
1258                 <span class="comment">% calculate corrections</span>
1259                 FB.OCSx.CM.Data = FB.OCSx.CM.Data + FB.OCSx.CM.Delta;
1260                 FB.OCSy.CM.Data = FB.OCSy.CM.Data + FB.OCSy.CM.Delta;
1261                 <span class="comment">% start vertical correctors moving</span>
1262                 setpv(FB.OCSy.CM,0);
1263                 <span class="comment">% Correct horizontal</span>
1264                 setpv(FB.OCSx.CM,-1);
1265                 <span class="comment">% Correct vertical</span>
1266                 setpv(FB.OCSy.CM,-2);
1267 
1268                 <span class="comment">% Check for current in machine - stop orbit correction if DCCT &lt; 5mA</span>
1269                 <span class="keyword">if</span> (getdcct &lt; 4.5)
1270                     error(<span class="string">'**There is less than 5mA in the machine! Stopping orbit correction.'</span>);
1271                 <span class="keyword">end</span>
1272 
1273                 <span class="comment">% Check state of gaps - stop orbit correction if any are moving</span>
1274                 GAPrunflag = getpv(<span class="string">'ID'</span>,<span class="string">'RunFlag'</span>);
1275                 <span class="keyword">if</span> any(GAPrunflag-round(GAPrunflag))
1276                     error(<span class="string">'**One or more of the gaps are moving! Stopping orbit correction.'</span>);
1277                 <span class="keyword">end</span>
1278 
1279                 x = FB.OCSx.GoalOrbit - getx(FB.OCSx.BPM.DeviceList);
1280                 y = FB.OCSy.GoalOrbit - gety(FB.OCSy.BPM.DeviceList);
1281                 fprintf(<span class="string">'   %d. Horizontal RMS = %.3f mm\n'</span>, iloop, norm(x)/sqrt(length(x)));
1282                 fprintf(<span class="string">'   %d.   Vertical RMS = %.3f mm\n'</span>, iloop, norm(y)/sqrt(length(y)));
1283 
1284             <span class="keyword">catch</span>
1285                 <span class="comment">% fprintf('   %s \n',lasterr);</span>
1286                 fprintf(<span class="string">'   Orbit correction failed due to error condition!\n  Fix the problem, reload the lattice (srload), and try again.  \n\n'</span>);
1287                 setpv(<span class="string">'SR_STATE'</span>,-4);
1288                 set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1289                 [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1290                 <span class="keyword">if</span> StateNumber &gt;= 0
1291                     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1292                 <span class="keyword">else</span>
1293                     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1294                 <span class="keyword">end</span>
1295                 set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1296 
1297                 <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1298                 <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1299                 fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1300                 <span class="keyword">return</span>
1301             <span class="keyword">end</span>
1302         <span class="keyword">end</span>
1303 
1304 
1305         <span class="comment">% Set user bumps w/o sextupole correctors</span>
1306         <span class="keyword">try</span>
1307 
1308             <span class="comment">%turn up corrector speed here to quicken setting bumps</span>
1309             HCMramprate = getpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>);
1310             VCMramprate = getpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>);
1311             setpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>, 10, [], 0);
1312             setpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>, 10, [], 0);
1313             
1314             <span class="keyword">if</span> ~isempty(LocalBumplist)
1315                 fprintf(<span class="string">'   Setting local bumps in the straight sections.\n'</span>);
1316                 <span class="keyword">for</span> loop = 1:size(LocalBumplist,1)
1317 
1318                     <span class="comment">% Check for current in machine - stop orbit correction if DCCT &lt; 5mA</span>
1319                     <span class="keyword">if</span> (getdcct &lt; 5)
1320                         error(<span class="string">'** There is less than 5mA in the machine! Stopping local bumps.'</span>);
1321                     <span class="keyword">end</span>
1322 
1323                     <span class="comment">% Check state of gaps - stop setting bumps if any are moving</span>
1324                     GAPrunflag = getpv(<span class="string">'ID'</span>,<span class="string">'RunFlag'</span>);
1325                     <span class="keyword">if</span> any(GAPrunflag-round(GAPrunflag))
1326                         error(<span class="string">'** One or more of the gaps are moving! Stopping local bumps.'</span>);
1327                     <span class="keyword">end</span>
1328 
1329                     HCMoldsp = getsp(<span class="string">'HCM'</span>, FB.HCMlist1);
1330                     VCMoldsp = getsp(<span class="string">'VCM'</span>, FB.VCMlist1);
1331 
1332                     <span class="keyword">if</span> any(LocalBumplist(loop,1) == [4 6 11])
1333                         <span class="keyword">if</span> LocalBumplist(loop,2) == 0
1334                             <span class="comment">% Upstream bump</span>
1335                             [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1)-1 11;LocalBumplist(loop,1)-1 12;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1336                             <span class="keyword">if</span> isempty(iRemove)
1337                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1338                             <span class="keyword">else</span>
1339                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1340                             <span class="keyword">end</span>
1341                         <span class="keyword">elseif</span> LocalBumplist(loop,2) == 1
1342                             <span class="comment">% Upstream bump</span>
1343                             [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1)-1 11;],FB.OCSx.BPM.DeviceList);
1344                             <span class="keyword">if</span> isempty(iRemove)
1345                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1346                             <span class="keyword">else</span>
1347                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1348                             <span class="keyword">end</span>
1349                         <span class="keyword">else</span>
1350                             <span class="comment">% Downstream bump</span>
1351                             [i, iRemove] = findrowindex([LocalBumplist(loop,1)-1 12;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1352                             <span class="keyword">if</span> isempty(iRemove)
1353                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1354                             <span class="keyword">else</span>
1355                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1356                             <span class="keyword">end</span>
1357                         <span class="keyword">end</span>
1358                     <span class="keyword">else</span>
1359                         [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1360                         <span class="keyword">if</span> isempty(iRemove)
1361                             <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1362                         <span class="keyword">else</span>
1363                             fprintf(<span class="string">'\n   BPMs missing from Sector %02d - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,1));
1364                         <span class="keyword">end</span>
1365                     <span class="keyword">end</span>
1366                     
1367                     HCMnewsp = getsp(<span class="string">'HCM'</span>, FB.HCMlist1);
1368                     VCMnewsp = getsp(<span class="string">'VCM'</span>, FB.VCMlist1);
1369                     <span class="comment">% Remove center chicane trim from corrector check</span>
1370                     <span class="keyword">if</span> (max(abs(HCMoldsp(iNotHCMChicane)-HCMnewsp(iNotHCMChicane))) &gt; 5) || (max(abs(VCMoldsp(iNotVCMChicane)-VCMnewsp(iNotVCMChicane))) &gt; 10)
1371                         error(<span class="string">'**Setbumps caused some corrector magnet currents to change by more than 5(Horiz)/10(Vert) A!'</span>);
1372                     <span class="keyword">end</span>
1373                     <span class="comment">% Now check center chicane trims</span>
1374                     <span class="keyword">if</span> (max(abs(HCMoldsp(iNotHCMChicane)-HCMnewsp(iNotHCMChicane))) &gt; 10) || (max(abs(VCMoldsp(iNotVCMChicane)-VCMnewsp(iNotVCMChicane))) &gt; 15)
1375                         error(<span class="string">'**Setbumps caused some chicane trim magnet currents to change by more than 10(Horiz)/15(Vert) A!'</span>);
1376                     <span class="keyword">end</span>
1377                 <span class="keyword">end</span>
1378             <span class="keyword">end</span>
1379 
1380             <span class="comment">%restore corrector speeds</span>
1381             setpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>, HCMramprate, [], 0);
1382             setpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>, VCMramprate, [], 0);
1383 
1384         <span class="keyword">catch</span>
1385             fprintf(<span class="string">'   %s \n'</span>,lasterr);
1386             fprintf(<span class="string">'   Setbumps failed due to error condition!  Fix the problem, reload the lattice (srload), and try again.\n\n'</span>);
1387             setpv(<span class="string">'SR_STATE'</span>,-4);
1388             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1389             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1390             <span class="keyword">if</span> StateNumber &gt;= 0
1391                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1392             <span class="keyword">else</span>
1393                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1394             <span class="keyword">end</span>
1395             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1396 
1397             <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1398             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1399             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1400             <span class="keyword">return</span>
1401         <span class="keyword">end</span>
1402 
1403         <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1404         <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1405         fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1406 
1407         <span class="comment">% Turn feed forward back to it's original state</span>
1408         <span class="keyword">if</span> any(FFEnableBC)
1409             fprintf(<span class="string">'   Turning feed forward back on.\n'</span>);
1410             <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], FFEnableBC);
1411         <span class="keyword">end</span>
1412 
1413 
1414         a = clock;
1415         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1416         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1417         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1418         <span class="keyword">if</span> StateNumber &gt;= 0
1419             setpv(<span class="string">'SR_STATE'</span>,4.1);
1420             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1421             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1422             fprintf(<span class="string">'   *********************************\n'</span>);
1423             fprintf(<span class="string">'   **  Orbit Correction Complete  **\n'</span>);
1424             fprintf(<span class="string">'   *********************************\n\n'</span>);
1425         <span class="keyword">else</span>
1426             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1427             fprintf(<span class="string">'   *************************************\n'</span>);
1428             fprintf(<span class="string">'   **  Problem With Orbit Correction  **\n'</span>);
1429             fprintf(<span class="string">'   *************************************\n\n'</span>);
1430         <span class="keyword">end</span>
1431         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1432         pause(0);
1433 
1434 
1435     <span class="keyword">case</span> <span class="string">'OrbitCorrectionSetup'</span>
1436         InitFlag = Input2;           <span class="comment">% Input #2: if InitFlag, then initialize variables</span>
1437 
1438         <span class="keyword">if</span> InitFlag
1439             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1440             <span class="comment">% This setup is now done in ocsinit.m %</span>
1441             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1442             <span class="comment">% Setup feedback elements</span>
1443             <span class="comment">% disp('Orbit correction condition: InitFlag=1 -- debugging message');</span>
1444 
1445             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1446             <span class="comment">% Edit the following lists to change default configuration of Orbit Correction %</span>
1447             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1448 <span class="comment">%             hlist=[];vlist=[];</span>
1449 <span class="comment">%             for Sector =1:12</span>
1450 <span class="comment">%                 if Sector == 1</span>
1451 <span class="comment">%                     vlist = [vlist;Sector 2;Sector 4;Sector 5;Sector 8];</span>
1452 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7];</span>
1453 <span class="comment">%                 elseif Sector == 3</span>
1454 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];</span>
1455 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7;Sector 10];</span>
1456 <span class="comment">%                 elseif Sector == 5</span>
1457 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];</span>
1458 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7;Sector 10];</span>
1459 <span class="comment">% %                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8]; %remove HCM and VCM(5,10) since corrector is not controlling starting 4-6-07</span>
1460 <span class="comment">% %                     hlist = [hlist;Sector 2;Sector 7];</span>
1461 <span class="comment">%                 elseif Sector == 10</span>
1462 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];</span>
1463 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7;Sector 10];</span>
1464 <span class="comment">%                 elseif Sector == 12</span>
1465 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 7];</span>
1466 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7];</span>
1467 <span class="comment">%                 else</span>
1468 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8];</span>
1469 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7];</span>
1470 <span class="comment">%                 end</span>
1471 <span class="comment">%             end</span>
1472 <span class="comment">%             HCMlist1 = hlist;</span>
1473 <span class="comment">%             VCMlist1 = vlist;</span>
1474 <span class="comment">%</span>
1475 <span class="comment">%             BPMlist1 = [</span>
1476 <span class="comment">%                 1 2</span>
1477 <span class="comment">%                 1 5</span>
1478 <span class="comment">%                 1 6</span>
1479 <span class="comment">%                 1 10</span>
1480 <span class="comment">%                 2 1</span>
1481 <span class="comment">%                 2 5</span>
1482 <span class="comment">%                 2 6</span>
1483 <span class="comment">%                 2 9</span>
1484 <span class="comment">%                 3 2</span>
1485 <span class="comment">%                 3 5</span>
1486 <span class="comment">%                 3 6</span>
1487 <span class="comment">%                 3 10</span>
1488 <span class="comment">%                 3 11</span>
1489 <span class="comment">%                 3 12</span>
1490 <span class="comment">%                 4 1</span>
1491 <span class="comment">%                 4 5</span>
1492 <span class="comment">%                 4 6</span>
1493 <span class="comment">%                 4 10</span>
1494 <span class="comment">%                 5 1</span>
1495 <span class="comment">%                 5 5</span>
1496 <span class="comment">%                 5 6</span>
1497 <span class="comment">%                 5 10</span>
1498 <span class="comment">%                 5 11</span>
1499 <span class="comment">%                 5 12</span>
1500 <span class="comment">%                 6 1</span>
1501 <span class="comment">%                 6 5</span>
1502 <span class="comment">%                 6 6</span>
1503 <span class="comment">%                 6 10</span>
1504 <span class="comment">%                 7 1</span>
1505 <span class="comment">%                 7 5</span>
1506 <span class="comment">%                 7 6</span>
1507 <span class="comment">%                 7 10</span>
1508 <span class="comment">%                 8 1</span>
1509 <span class="comment">%                 8 5</span>
1510 <span class="comment">%                 8 6</span>
1511 <span class="comment">%                 8 10</span>
1512 <span class="comment">%                 9 1</span>
1513 <span class="comment">%                 9 5</span>
1514 <span class="comment">%                 9 6</span>
1515 <span class="comment">%                 9 10</span>
1516 <span class="comment">%                 10 1</span>
1517 <span class="comment">%                 10 5</span>
1518 <span class="comment">%                 10 6</span>
1519 <span class="comment">%                 10 10</span>
1520 <span class="comment">%                 10 11</span>
1521 <span class="comment">%                 10 12</span>
1522 <span class="comment">%                 11 1</span>
1523 <span class="comment">%                 11 5</span>
1524 <span class="comment">%                 11 6</span>
1525 <span class="comment">%                 11 10</span>
1526 <span class="comment">%                 12 1</span>
1527 <span class="comment">%                 12 5</span>
1528 <span class="comment">%                 12 6</span>
1529 <span class="comment">%                 12 9];</span>
1530 <span class="comment">%</span>
1531 <span class="comment">%             % SVD orbit correction</span>
1532 <span class="comment">%             Xivec = [1:28];</span>
1533 <span class="comment">%             Yivec = [1:51];</span>
1534 <span class="comment">%</span>
1535 <span class="comment">%</span>
1536 <span class="comment">%             % Look for bad status BPMs</span>
1537 <span class="comment">%             iStatus = family2status('BPMx', BPMlist1);</span>
1538 <span class="comment">%             iBad = find(~iStatus);</span>
1539 <span class="comment">%             BPMlist1 = BPMlist1(find(iStatus),:);</span>
1540 <span class="comment">%             if length(iBad)</span>
1541 <span class="comment">%                 fprintf('   Global Orbit Correction: %d BPMs removed for bad status\n', length(iBad));</span>
1542 <span class="comment">%                 Yivec = Yivec(1:end-length(iBad));</span>
1543 <span class="comment">%             end</span>
1544 <span class="comment">%</span>
1545 <span class="comment">%             iStatus = family2status('HCM', HCMlist1);</span>
1546 <span class="comment">%             iBad = find(~iStatus);</span>
1547 <span class="comment">%             HCMlist1 = HCMlist1(find(iStatus),:);</span>
1548 <span class="comment">%             if length(iBad)</span>
1549 <span class="comment">%                 fprintf('   Global Orbit Correction: %d HCMs removed for bad status\n', length(iBad));</span>
1550 <span class="comment">%             end</span>
1551 <span class="comment">%</span>
1552 <span class="comment">%             iStatus = family2status('VCM', VCMlist1);</span>
1553 <span class="comment">%             iBad = find(~iStatus);</span>
1554 <span class="comment">%             VCMlist1 = VCMlist1(find(iStatus),:);</span>
1555 <span class="comment">%             if length(iBad)</span>
1556 <span class="comment">%                 fprintf('   Global Orbit Correction: %d VCMs removed for bad status\n', length(iBad));</span>
1557 <span class="comment">%             end</span>
1558 
1559             <span class="comment">% Initialize RFCorrFlag</span>
1560             RFCorrFlag = <span class="string">'Yes'</span>;
1561 
1562             <span class="comment">% Get the device lists from oscsinit and convert to srcontrol variables</span>
1563             [HBPM, VBPM, HCM, VCM, HSV, VSV] = <a href="ocsinit.html" class="code" title="function [HBPM, VBPM, HCM, VCM, HSV, VSV] = ocsinit(MethodName)">ocsinit</a>(<span class="string">'TopOfFill'</span>);
1564             <span class="keyword">if</span> strcmpi(RFCorrFlag, <span class="string">'Yes'</span>)
1565                 Xivec = 1:HSV+1;
1566             <span class="keyword">else</span>
1567                 Xivec = 1:HSV;
1568             <span class="keyword">end</span>
1569             Yivec = 1:VSV;
1570             BPMlist1 = HBPM.DeviceList;
1571             HCMlist1 = HCM.DeviceList;
1572             VCMlist1 = VCM.DeviceList;
1573             
1574             
1575             LocalBumplist = [
1576               <span class="comment">% 1 1</span>
1577               <span class="comment">% 2 1</span>
1578               <span class="comment">% 3 1</span>
1579                 4 1
1580               <span class="comment">% 4 2</span>
1581                 5 1
1582               <span class="comment">% 6 1</span>
1583               <span class="comment">% 6 2</span>
1584                 7 1
1585                 8 1
1586                 9 1
1587                 10 1
1588                 11 1
1589                 11 2
1590                 12 1
1591                 ];
1592             <span class="comment">%LocalBumplist = []</span>
1593             
1594 
1595         <span class="keyword">else</span>
1596 
1597             <span class="comment">% Get vectors</span>
1598             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>);
1599             BPMlist1 = FB.BPMlist1;
1600             HCMlist1 = FB.HCMlist1;
1601             VCMlist1 = FB.VCMlist1;
1602             Xivec = FB.Xivec;
1603             Yivec = FB.Yivec;
1604             LocalBumplist = FB.LocalBumplist;
1605             Xgoal = FB.Xgoal;
1606             Ygoal = FB.Ygoal;
1607             RFCorrFlag = FB.RFCorrFlag;
1608 
1609             <span class="comment">% Add button to change #ivectors, CMs, IDBPMs,</span>
1610             EditFlag = 0;
1611             h_fig1 = figure;
1612             <span class="keyword">while</span> EditFlag ~= 8
1613 
1614                 <span class="comment">% Sensitivity matrix</span>
1615                 Sx = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
1616                 Sy = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
1617                 
1618                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1619                 <span class="comment">% Can the call below work for setting FOFB RF parameter? %</span>
1620                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1621                 <span class="keyword">if</span> strcmpi(RFCorrFlag, <span class="string">'Yes'</span>)
1622                     Sx = [Sx getdisp(<span class="string">'BPMx'</span>,BPMlist1)];
1623                 <span class="keyword">end</span>
1624                 
1625                 Sx(isnan(Sx)) = 0;
1626                 Sy(isnan(Sy)) = 0;
1627                                
1628                 [Ux, SVx, Vx] = svd(Sx);
1629                 [Uy, SVy, Vy] = svd(Sy);
1630 
1631 
1632                 <span class="comment">% Remove singular values greater than the actual number of singular values</span>
1633                 i = find(Xivec&gt;length(diag(SVx)));
1634                 <span class="keyword">if</span> ~isempty(i)
1635                     disp(<span class="string">'   Horizontal E-vector scaled since there were more elements in the vector than singular values.'</span>);
1636                     pause(0);
1637                     Xivec(i) = [];
1638                 <span class="keyword">end</span>
1639                 i = find(Yivec&gt;length(diag(SVy)));
1640                 <span class="keyword">if</span> ~isempty(i)
1641                     disp(<span class="string">'   Vertical E-vector scaled since there were more elements in the vector than singular values.'</span>);
1642                     pause(0);
1643                     Yivec(i) = [];
1644                 <span class="keyword">end</span>
1645 
1646 
1647                 Ax = Sx*Vx(:,Xivec);
1648                 Tx = inv(Ax'*Ax)*Ax';
1649 
1650                 Ay = Sy*Vy(:,Yivec);
1651                 Ty = inv(Ay'*Ay)*Ay';
1652 
1653 
1654                 figure(h_fig1);
1655                 subplot(2,1,1);
1656                 semilogy(diag(SVx),<span class="string">'b'</span>);
1657                 hold on;
1658                 semilogy(diag(SVx(Xivec,Xivec)),<span class="string">'xr'</span>);
1659                 ylabel(<span class="string">'Horizontal'</span>);
1660                 title(<span class="string">'Response Matrix Singular Values'</span>);
1661                 hold off;
1662                 subplot(2,1,2);
1663                 semilogy(diag(SVy),<span class="string">'b'</span>);
1664                 hold on;
1665                 semilogy(diag(SVy(Yivec,Yivec)),<span class="string">'xr'</span>);
1666                 xlabel(<span class="string">'Singular Value Number'</span>);
1667                 ylabel(<span class="string">'Vertical'</span>);
1668                 hold off;
1669                 drawnow;
1670 
1671                 <span class="keyword">if</span> strcmp(RFCorrFlag,<span class="string">'No'</span>)
1672                     RFCorrState = <span class="string">'NOT CORRECTED'</span>;
1673                 <span class="keyword">elseif</span> strcmp(RFCorrFlag,<span class="string">'Yes'</span>)
1674                     RFCorrState = <span class="string">'CORRECTED'</span>;
1675                 <span class="keyword">else</span>
1676                     RFCorrState = <span class="string">'???'</span>;
1677                 <span class="keyword">end</span>
1678 
1679                 <span class="comment">%         EditFlag = menu('Change Parameters?','Singular Values','HCM List','VCM List','HCM Chicane List','VCM Chicane List','IDBPM List','BBPM List','Change Golden Orbit',...</span>
1680                 <span class="comment">%            'Local Bump List',sprintf('RF Frequency (currently %s)',RFCorrState),'Continue');</span>
1681                 EditFlag = menu(<span class="string">'Change Parameters?'</span>,<span class="string">'Singular Values'</span>,<span class="string">'HCM List'</span>,<span class="string">'VCM List'</span>,<span class="string">'BPM List'</span>,<span class="string">'Change Golden Orbit'</span>,<span class="keyword">...</span>
1682                     <span class="string">'Local Bump List'</span>,sprintf(<span class="string">'RF Frequency (currently %s)'</span>,RFCorrState),<span class="string">'Continue'</span>);
1683 
1684                 <span class="keyword">if</span> EditFlag == 1
1685                     prompt={<span class="string">'Enter the horizontal E-vector numbers (Matlab vector format):'</span>,<span class="string">'Enter the vertical E-vector numbers (Matlab vector format):'</span>};
1686                     def={sprintf(<span class="string">'[%d:%d]'</span>,1,Xivec(end)),sprintf(<span class="string">'[%d:%d]'</span>,1,Yivec(end))};
1687                     titlestr=<span class="string">'SVD Orbit Feedback'</span>;
1688                     lineNo=1;
1689                     answer=inputdlg(prompt,titlestr,lineNo,def);
1690                     <span class="keyword">if</span> ~isempty(answer)
1691                         XivecNew = fix(str2num(answer{1}));
1692                         <span class="keyword">if</span> isempty(XivecNew)
1693                             disp(<span class="string">'   Horizontal E-vector cannot be empty.  No change made.'</span>);
1694                         <span class="keyword">else</span>
1695                             <span class="keyword">if</span> any(XivecNew&lt;=0) || max(XivecNew)&gt;length(diag(SVx))
1696                                 disp(<span class="string">'   Error reading horizontal E-vector.  No change made.'</span>);
1697                             <span class="keyword">else</span>
1698                                 Xivec = XivecNew;
1699                             <span class="keyword">end</span>
1700                         <span class="keyword">end</span>
1701                         YivecNew = fix(str2num(answer{2}));
1702                         <span class="keyword">if</span> isempty(YivecNew)
1703                             disp(<span class="string">'   Vertical E-vector cannot be empty.  No change made.'</span>);
1704                         <span class="keyword">else</span>
1705                             <span class="keyword">if</span> any(YivecNew&lt;=0) || max(YivecNew)&gt;length(diag(SVy))
1706                                 disp(<span class="string">'   Error reading vertical E-vector.  No change made.'</span>);
1707                             <span class="keyword">else</span>
1708                                 Yivec = YivecNew;
1709                             <span class="keyword">end</span>
1710                         <span class="keyword">end</span>
1711                     <span class="keyword">end</span>
1712                 <span class="keyword">end</span>
1713 
1714                 <span class="keyword">if</span> EditFlag == 2
1715                     List = getlist(<span class="string">'HCM'</span>);
1716                     CheckList = zeros(size(List,1));
1717                     Elem = dev2elem(<span class="string">'HCM'</span>, HCMlist1);
1718                     CheckList(Elem) = ones(size(Elem));
1719                     CheckList = CheckList(dev2elem(<span class="string">'HCM'</span>,List));
1720                     newList = editlist(List, <span class="string">'HCM'</span>, CheckList);
1721                     <span class="keyword">if</span> isempty(newList)
1722                         fprintf(<span class="string">'   Horizontal corrector magnet list cannot be empty.  No change made.\n'</span>);
1723                     <span class="keyword">else</span>
1724                         HCMlist1 = newList;
1725                     <span class="keyword">end</span>
1726                 <span class="keyword">end</span>
1727 
1728                 <span class="keyword">if</span> EditFlag == 3
1729                     List = getlist(<span class="string">'VCM'</span>);
1730                     CheckList = zeros(size(List,1));
1731                     Elem = dev2elem(<span class="string">'VCM'</span>, VCMlist1);
1732                     CheckList(Elem) = ones(size(Elem));
1733                     CheckList = CheckList(dev2elem(<span class="string">'VCM'</span>,List));
1734                     newList = editlist(List, <span class="string">'VCM'</span>, CheckList);
1735                     <span class="keyword">if</span> isempty(newList)
1736                         fprintf(<span class="string">'   Vertical corrector magnet cannot be empty.  No change made.\n'</span>);
1737                     <span class="keyword">else</span>
1738                         VCMlist1 = newList;
1739                     <span class="keyword">end</span>
1740                 <span class="keyword">end</span>
1741 
1742                 <span class="keyword">if</span> EditFlag == 4
1743                     ListOld = BPMlist1;
1744                     XgoalOld = Xgoal;
1745                     YgoalOld = Ygoal;
1746 
1747                     <span class="comment">% Full BPM list</span>
1748                     List = <a href="getbpmlist.html" class="code" title="function [DeviceList, Index] = getbpmlist(varargin)">getbpmlist</a>(<span class="string">'Bergoz'</span>);
1749 <span class="comment">%                     List = [</span>
1750 <span class="comment">%                         1 2</span>
1751 <span class="comment">%                         1 5</span>
1752 <span class="comment">%                         1 6</span>
1753 <span class="comment">%                         1 10</span>
1754 <span class="comment">%                         2 1</span>
1755 <span class="comment">%                         2 5</span>
1756 <span class="comment">%                         2 6</span>
1757 <span class="comment">%                         2 9</span>
1758 <span class="comment">%                         3 2</span>
1759 <span class="comment">%                         3 5</span>
1760 <span class="comment">%                         3 6</span>
1761 <span class="comment">%                         3 10</span>
1762 <span class="comment">%                         3 11</span>
1763 <span class="comment">%                         3 12</span>
1764 <span class="comment">%                         4 1</span>
1765 <span class="comment">%                         4 5</span>
1766 <span class="comment">%                         4 6</span>
1767 <span class="comment">%                         4 10</span>
1768 <span class="comment">%                         5 1</span>
1769 <span class="comment">%                         5 5</span>
1770 <span class="comment">%                         5 6</span>
1771 <span class="comment">%                         5 10</span>
1772 <span class="comment">%                         5 11</span>
1773 <span class="comment">%                         5 12</span>
1774 <span class="comment">%                         6 1</span>
1775 <span class="comment">%                         6 5</span>
1776 <span class="comment">%                         6 6</span>
1777 <span class="comment">%                         6 10</span>
1778 <span class="comment">%                         7 1</span>
1779 <span class="comment">%                         7 5</span>
1780 <span class="comment">%                         7 6</span>
1781 <span class="comment">%                         7 10</span>
1782 <span class="comment">%                         8 1</span>
1783 <span class="comment">%                         8 5</span>
1784 <span class="comment">%                         8 6</span>
1785 <span class="comment">%                         8 10</span>
1786 <span class="comment">%                         9 1</span>
1787 <span class="comment">%                         9 5</span>
1788 <span class="comment">%                         9 6</span>
1789 <span class="comment">%                         9 10</span>
1790 <span class="comment">%                         10 1</span>
1791 <span class="comment">%                         10 5</span>
1792 <span class="comment">%                         10 6</span>
1793 <span class="comment">%                         10 10</span>
1794 <span class="comment">%                         10 11</span>
1795 <span class="comment">%                         10 12</span>
1796 <span class="comment">%                         11 1</span>
1797 <span class="comment">%                         11 5</span>
1798 <span class="comment">%                         11 6</span>
1799 <span class="comment">%                         11 10</span>
1800 <span class="comment">%                         12 1</span>
1801 <span class="comment">%                         12 5</span>
1802 <span class="comment">%                         12 6</span>
1803 <span class="comment">%                         12 9</span>
1804 <span class="comment">%                         ];</span>
1805 
1806                     CheckList = zeros(size(List,1),1);
1807                     <span class="keyword">if</span> ~isempty(BPMlist1)
1808                         <span class="keyword">for</span> i = 1:size(List,1)
1809                             k = find(List(i,1)==BPMlist1(:,1));
1810                             l = find(List(i,2)==BPMlist1(k,2));
1811 
1812                             <span class="keyword">if</span> isempty(k) || isempty(l)
1813                                 <span class="comment">% Item not in list</span>
1814                             <span class="keyword">else</span>
1815                                 CheckList(i) = 1;
1816                             <span class="keyword">end</span>
1817                         <span class="keyword">end</span>
1818                     <span class="keyword">end</span>
1819 
1820                     newList = editlist(List, <span class="string">'BPM'</span>, CheckList);
1821                     <span class="keyword">if</span> isempty(newList)
1822                         fprintf(<span class="string">'   BPM list cannot be empty.  No change made.\n'</span>);
1823                     <span class="keyword">else</span>
1824                         BPMlist1 = newList;
1825                     <span class="keyword">end</span>
1826 
1827                     <span class="comment">% Set the goal orbit to the golden orbit</span>
1828                     Xgoal = getgolden(<span class="string">'BPMx'</span>, BPMlist1);
1829                     Ygoal = getgolden(<span class="string">'BPMy'</span>, BPMlist1);
1830 
1831 
1832                     <span class="comment">% If a new BPM is added, then set the goal orbit to the golden orbit</span>
1833                     <span class="keyword">for</span> i = 1:size(BPMlist1,1)
1834 
1835                         <span class="comment">% Is it a new BPM?</span>
1836                         k = find(BPMlist1(i,1)==ListOld(:,1));
1837                         l = find(BPMlist1(i,2)==ListOld(k,2));
1838 
1839                         <span class="keyword">if</span> isempty(k) || isempty(l)
1840                             <span class="comment">% New BPM</span>
1841                         <span class="keyword">else</span>
1842                             <span class="comment">% Use the old value for old BPM</span>
1843                             Xgoal(i) = XgoalOld(k(l));
1844                             Ygoal(i) = YgoalOld(k(l));
1845                         <span class="keyword">end</span>
1846                     <span class="keyword">end</span>
1847                 <span class="keyword">end</span>
1848 
1849                 <span class="keyword">if</span> EditFlag == 5
1850 
1851                     ChangeList = editlist(BPMlist1, <span class="string">'Change BPM'</span>, zeros(size(BPMlist1,1),1));
1852                     <span class="keyword">for</span> i = 1:size(ChangeList,1)
1853 
1854                         k = find(ChangeList(i,1)==BPMlist1(:,1));
1855                         l = find(ChangeList(i,2)==BPMlist1(k,2));
1856 
1857                         prompt = {sprintf(<span class="string">'Enter the new horizontal goal orbit for BPMx(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2)),sprintf(<span class="string">'Enter the new vertical goal orbit for BPMy(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2))};
1858                         def = {sprintf(<span class="string">'%f'</span>,Xgoal(k(l))),sprintf(<span class="string">'%f'</span>,Ygoal(k(l)))};
1859                         titlestr = <span class="string">'CHANGE THE GOAL ORBIT'</span>;
1860                         lineNo = 1;
1861                         answer = inputdlg(prompt, titlestr, lineNo, def);
1862 
1863                         <span class="keyword">if</span> isempty(answer)
1864                             <span class="comment">% No change</span>
1865                             fprintf(<span class="string">'   No change was made to the golden orbit.\n'</span>);
1866                         <span class="keyword">else</span>
1867                             Xgoalnew = str2num(answer{1});
1868                             <span class="keyword">if</span> isempty(Xgoalnew)
1869                                 fprintf(<span class="string">'   No change was made to the horizontal golden orbit.\n'</span>);
1870                             <span class="keyword">else</span>
1871                                 Xgoal(k(l)) = Xgoalnew;
1872                             <span class="keyword">end</span>
1873 
1874                             Ygoalnew = str2num(answer{2});
1875                             <span class="keyword">if</span> isempty(Ygoalnew)
1876                                 fprintf(<span class="string">'   No change was made to the vertical golden orbit.\n'</span>);
1877                             <span class="keyword">else</span>
1878                                 Ygoal(k(l)) = Ygoalnew;
1879                             <span class="keyword">end</span>
1880                         <span class="keyword">end</span>
1881                     <span class="keyword">end</span>
1882                     <span class="keyword">if</span> ~isempty(ChangeList)
1883                         fprintf(<span class="string">'   Note:  changing the goal orbit for &quot;Orbit Correction&quot; does not change the goal orbit for &quot;Slow Orbit Feedback.&quot;\n'</span>);
1884                         fprintf(<span class="string">'          Re-running srcontrol will restart the goal orbit to the golden orbit.&quot;\n'</span>);
1885                     <span class="keyword">end</span>
1886                 <span class="keyword">end</span>
1887 
1888                 <span class="keyword">if</span> EditFlag == 6
1889                     List = [
1890                         1 1
1891                         2 1
1892                         3 1
1893                         4 1
1894                         4 2
1895                         5 1
1896                         6 1
1897                         6 2
1898                         7 1
1899                         8 1
1900                         9 1
1901                         10 1
1902                         11 1
1903                         11 2
1904                         12 1];
1905                     CheckList = zeros(size(List,1),1);
1906                     <span class="keyword">if</span> ~isempty(LocalBumplist)
1907                         <span class="keyword">for</span> i = 1:size(List,1)
1908                             k = find(List(i,1)==LocalBumplist(:,1));
1909                             l = find(List(i,2)==LocalBumplist(k,2));
1910 
1911                             <span class="keyword">if</span> isempty(k) || isempty(l)
1912                                 <span class="comment">% Item not in list</span>
1913                             <span class="keyword">else</span>
1914                                 CheckList(i) = 1;
1915                             <span class="keyword">end</span>
1916                         <span class="keyword">end</span>
1917                     <span class="keyword">end</span>
1918                     LocalBumplist = editlist2(List, <span class="string">'Sector'</span>, CheckList);
1919                 <span class="keyword">end</span>
1920 
1921                 <span class="keyword">if</span> EditFlag == 7
1922                     RFCorrFlag = questdlg(sprintf(<span class="string">'Set RF Frequency during Orbit Correction?'</span>),<span class="string">'RF Frequency'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>, <span class="string">'No'</span>);
1923                     <span class="keyword">if</span> strcmp(RFCorrFlag,<span class="string">'No'</span>)
1924                         disp([<span class="string">'   RF Frequency will not be included in global orbit correction.'</span>]);
1925                     <span class="keyword">elseif</span> strcmp(RFCorrFlag,<span class="string">'Yes'</span>)
1926                         disp([<span class="string">'   RF Frequency will be included in global orbit correction.'</span>]);
1927                     <span class="keyword">end</span>
1928 
1929                 <span class="keyword">end</span>
1930             <span class="keyword">end</span>
1931             close(h_fig1);
1932         <span class="keyword">end</span>
1933 
1934         <span class="comment">%  ORBIT CORRECTION STRUCTURE (OCS)</span>
1935         <span class="comment">%    OCS.BPM (data structure)</span>
1936         <span class="comment">%    OCS.CM  (data structure)</span>
1937         <span class="comment">%    OCS.GoalOrbit</span>
1938         <span class="comment">%    OCS.NIter</span>
1939         <span class="comment">%    OCS.SVDIndex</span>
1940         <span class="comment">%    OCS.IncrementalFlag = 'Yes'/'No'</span>
1941         <span class="comment">%    OCS.BPMWeight</span>
1942         <span class="comment">%    OCS.Flags = { 'FitRF' , etc. }</span>
1943         OCSx.BPM = getx(BPMlist1, <span class="string">'struct'</span>);
1944         OCSx.CM = getsp(<span class="string">'HCM'</span>, HCMlist1, <span class="string">'struct'</span>);
1945         OCSx.GoalOrbit = getgolden(OCSx.BPM, <span class="string">'numeric'</span>);
1946         OCSx.NIter = 1;
1947         OCSx.SVDIndex = Xivec;
1948         OCSx.IncrementalFlag = <span class="string">'No'</span>;
1949         OCSx.FitRF = 1;
1950         OCSy.BPM = gety(BPMlist1, <span class="string">'struct'</span>);
1951         OCSy.CM = getsp(<span class="string">'VCM'</span>, VCMlist1, <span class="string">'struct'</span>);
1952         OCSy.GoalOrbit = getgolden(OCSy.BPM, <span class="string">'numeric'</span>);
1953         OCSy.NIter = 1;
1954         OCSy.SVDIndex = Yivec;
1955         OCSy.IncrementalFlag = <span class="string">'No'</span>;
1956         OCSy.FitRF = 0;
1957 
1958         <span class="comment">% Save vectors</span>
1959         FB.OCSx = OCSx;
1960         FB.OCSy = OCSy;
1961 
1962         FB.BPMlist1 = BPMlist1;
1963         FB.HCMlist1 = HCMlist1;
1964         FB.VCMlist1 = VCMlist1;
1965         FB.Xivec = Xivec;
1966         FB.Yivec = Yivec;
1967         FB.Xgoal = OCSx.GoalOrbit;
1968         FB.Ygoal = OCSy.GoalOrbit;
1969         FB.RFCorrFlag = RFCorrFlag;
1970         FB.LocalBumplist = LocalBumplist;
1971         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>,FB);
1972         
1973         
1974     <span class="keyword">case</span> <span class="string">'Feedback'</span>
1975 
1976         FBloopIter = 1;
1977         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxFOFB'</span>),<span class="string">'Value'</span>) == 1
1978             StartFOFBFlag = 1;
1979         <span class="keyword">else</span>
1980             StartFOFBFlag = 0;
1981         <span class="keyword">end</span>
1982 
1983         FEEDBACK_STOP_FLAG = 0;
1984         HWarnNum=0;
1985         VWarnNum=0;
1986 
1987         SR_GeV = getenergy;
1988         <span class="comment">% Feedback loop setup</span>
1989         PlotInfoFlag = 0;           <span class="comment">% Plot micado stuff</span>
1990         LoopDelay = 1.0;           <span class="comment">% Period of feedback loop [seconds], make sure the BPM averaging is correct</span>
1991         VCM_LSB = .00366211;
1992         VCMCHICANE_LSB = .002441;   <span class="comment">% 80 max?,  Note: not fully implemented</span>
1993 
1994         <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
1995             Xgain  = 0.2;
1996             Ygain  = 0.1;
1997         <span class="keyword">else</span>
1998             Xgain  = 0.8; <span class="comment">% raised 0.5-&gt;0.8 at 17:20, 3-2-05 to more quickly correct EPU4 fast switching orbit distortions</span>
1999             Ygain  = 0.8;
2000         <span class="keyword">end</span>
2001 
2002         <span class="comment">% Load lattice set for tune feed forward</span>
2003         ConfigSetpoint = getproductionlattice;
2004         <span class="comment">%load([getfamilydata('Directory','OpsData') getfamilydata('OpsData','LatticeFile')]);</span>
2005         QFsp = ConfigSetpoint.QF.Setpoint.Data;
2006         QDsp = ConfigSetpoint.QD.Setpoint.Data;
2007         TuneW16Min = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(5, 13.23, 1.8909);
2008         <span class="comment">% Tune response matrix</span>
2009         SR_TUNE_MATRIX = gettuneresp({<span class="string">'QF'</span>,<span class="string">'QD'</span>}, {[],[]}, getenergy(<span class="string">'Production'</span>));    <span class="comment">% Approx. [0.1944 -0.0286;-0.1182 0.1526];</span>
2010         <span class="comment">%SR_TUNE_MATRIX = [0.1641 -0.0245</span>
2011         <span class="comment">%                 -0.1149 0.1477];</span>
2012         
2013         SQSFsp = <a href="amp2k.html" class="code" title="function [k, B] = amp2k(Family, Field, Amps, DeviceList, Energy, BranchFlag)">amp2k</a>(<span class="string">'SQSF'</span>,<span class="string">'Setpoint'</span>,ConfigSetpoint.SQSF.Setpoint.Data);
2014         SQSDsp = <a href="amp2k.html" class="code" title="function [k, B] = amp2k(Family, Field, Amps, DeviceList, Energy, BranchFlag)">amp2k</a>(<span class="string">'SQSD'</span>,<span class="string">'Setpoint'</span>,ConfigSetpoint.SQSD.Setpoint.Data);
2015 
2016 <span class="comment">%         % tune FF for EPUs (data exist for 4 1 parallel, 11 1 parallel and antiparallel</span>
2017 <span class="comment">%         load '/home/als/physdata/matlab/srdata/gaptrack/EPU4-1_tunecomp/after_shimming/nux_map_withgaps.mat'</span>
2018 <span class="comment">%         dnux_epu_41_m0 = tunexmap(2:end,2:end)-tunexmap(2,12);</span>
2019 <span class="comment">%         [gap_epu_41,shift_epu_41]=meshgrid(tunexmap(2:end,1),tunexmap(1,2:end));</span>
2020 <span class="comment">%         load '/home/als/physdata/matlab/srdata/gaptrack/EPU4-1_tunecomp/after_shimming/nuy_map_withgaps.mat'</span>
2021 <span class="comment">%         dnuy_epu_41_m0 = tuneymap(2:end,2:end)-tuneymap(2,12);</span>
2022 <span class="comment">%</span>
2023 <span class="comment">%         load '/home/als/physdata/matlab/srdata/gaptrack/archive/epu11d1m0e19_2007-01-28.mat' tune_x tune_y Gaps GapsLongitudinal</span>
2024 <span class="comment">%         dnux_epu_111_m0 = tune_x-tune_x(1,11);</span>
2025 <span class="comment">%         [gap_epu_111,shift_epu_111]=meshgrid(Gaps,GapsLongitudinal);</span>
2026 <span class="comment">%         dnuy_epu_111_m0 = tune_y-tune_y(1,11);</span>
2027 <span class="comment">%         load '/home/als/physdata/matlab/srdata/gaptrack/archive/epu11d1m1e19_2007-01-28.mat' tune_x tune_y Gaps GapsLongitudinal</span>
2028 <span class="comment">%         dnux_epu_111_m1 = tune_x-tune_x(1,11);</span>
2029 <span class="comment">%         dnuy_epu_111_m1 = tune_y-tune_y(1,11);</span>
2030 
2031         <span class="comment">% tune FF for EPUs (data exist for 4 1 parallel, 11 1 parallel and antiparallel</span>
2032         load <span class="string">'/home/als/physdata/matlab/srdata/epu/tuneshift_2d_tables/epu_tunetables_2d_20070723.mat'</span>
2033         dnux41p = nux41p-nux41p(1,11);      
2034         dnuy41p = nuy41p-nuy41p(1,11);      
2035         dnux41a = nux41a-nux41a(1,11);      
2036         dnuy41a = nuy41a-nuy41a(1,11);      
2037         dnux111p = nux111p-nux111p(1,11);      
2038         dnuy111p = nuy111p-nuy111p(1,11);      
2039         dnux111a = nux111a-nux111a(1,11);      
2040         dnuy111a = nuy111a-nuy111a(1,11);      
2041         dnux112p = nux112p-nux112p(1,11);      
2042         dnuy112p = nuy112p-nuy112p(1,11);      
2043         dnux112a = nux112a-nux112a(1,11);      
2044         dnuy112a = nuy112a-nuy112a(1,11);      
2045         
2046         <span class="comment">% ID tune compensation does not work in the injection lattice, so ...</span>
2047         <span class="keyword">if</span> abs(SR_GEV - <a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>)&gt;  0.05     <span class="comment">% Don't use this routine for the injection lattice</span>
2048             fprintf(<span class="string">'   This routine should only be used for the production energy: Orbit feedback aborted\n'</span>);
2049             <span class="keyword">return</span>
2050         <span class="keyword">end</span>
2051 
2052         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
2053 
2054         <span class="keyword">try</span>
2055             fprintf(<span class="string">'\n'</span>);
2056             fprintf(<span class="string">'   *******************************\n'</span>);
2057             fprintf(<span class="string">'   **  Starting Orbit Feedback  **\n'</span>);
2058             fprintf(<span class="string">'   *******************************\n'</span>);
2059             a = clock;
2060             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2061             fprintf(<span class="string">'   Note: the Matlab command window will be used to display status information.\n'</span>);
2062             fprintf(<span class="string">'         It cannot be used to enter commands during slow orbit feedback.\n'</span>);
2063 
2064 
2065                 <span class="comment">% save current BPM timeconstant - will reset to this when feedback stops</span>
2066                 BPMtimeconstantOFB = <a href="getbpmtimeconstant.html" class="code" title="function [BPMTimeConstant, WarningFlag] = getbpmtimeconstant(varargin)">getbpmtimeconstant</a>;
2067                 fprintf(<span class="string">'   Current Bergoz BPM time constant is %.1fs\n'</span>, BPMtimeconstantOFB);
2068                 
2069             <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
2070             disp(<span class="string">'   Bergoz BPM time constant set to 0.2s.'</span>)
2071             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.2)
2072             pause(1.1);
2073 
2074             <span class="comment">% Check whether bumps and kickers are on and warn to turn off before starting feedback if necessary</span>
2075             <span class="keyword">try</span>
2076                 <span class="keyword">if</span> (getsp(<span class="string">'SR01S___BUMP1__BC21'</span>)==1 &amp;&amp; getsp(<span class="string">'SR01S___BUMP1P_BC22'</span>)==1) || (getsp(<span class="string">'SR01S___SEK____BC21'</span>)==1 &amp;&amp; getsp(<span class="string">'SR01S___SEK_P__BC23'</span>)==1) || (getsp(<span class="string">'SR01S___SEN____BC20'</span>)==1 &amp;&amp; getsp(<span class="string">'SR01S___SEN_P__BC22'</span>)==1)
2077                     soundtada;
2078                     fprintf(<span class="string">'   \n'</span>);
2079                     fprintf(<span class="string">'   *********************************************************************************\n'</span>);
2080                     fprintf(<span class="string">'   ** One or more of the pulsed SR injection magnets is still on!  Turn them off! **\n'</span>);
2081                     fprintf(<span class="string">'   *********************************************************************************\n'</span>);
2082                     fprintf(<span class="string">'   \n'</span>);
2083                 <span class="keyword">end</span>
2084             <span class="keyword">catch</span>
2085                 disp(<span class="string">'**Problem checking the state of the bumps and kickers - please check that they are not pulsing.'</span>);
2086             <span class="keyword">end</span>
2087 
2088             <span class="comment">% Get vectors</span>
2089 
2090             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
2091 
2092             BPMlist1 = FB.OCSx.BPM.DeviceList;
2093             <span class="comment">% FOFB_BPMlist =</span>
2094             HCMlist1 = FB.HCMlist1;
2095             VCMlist1 = FB.VCMlist1;
2096             Xivec = FB.Xivec;
2097             Yivec = FB.Yivec;
2098             Xgoal = FB.OCSx.GoalOrbit;
2099             Ygoal = FB.OCSy.GoalOrbit;
2100             FFTypeFlag = FB.FFTypeFlag;   <span class="comment">%local or global tune correction</span>
2101 
2102             iNotHCMChicane = find(HCMlist1(:,2) &lt; 10); <span class="comment">%used by steppv's for setting correctors in loop</span>
2103             iHCMChicane = find(HCMlist1(:,2) == 10);
2104             iNotVCMChicane = find(VCMlist1(:,2) &lt; 10);
2105             iVCMChicane = find(VCMlist1(:,2) == 10);
2106 
2107             <span class="comment">% Sensitivity matrix for setting fast feedback setpoints</span>
2108             Sx1 = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
2109             Sy1 = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
2110 
2111         <span class="keyword">catch</span>
2112             fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
2113 
2114             <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2115             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2116             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2117 
2118 
2119             a = clock;
2120             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2121             fprintf(<span class="string">'   *************************************************************\n'</span>);
2122             fprintf(<span class="string">'   **  Orbit feedback could not start due to error condition  **\n'</span>);
2123             fprintf(<span class="string">'   *************************************************************\n\n'</span>);
2124             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
2125             pause(0);
2126 
2127             <span class="keyword">return</span>
2128         <span class="keyword">end</span>
2129 
2130         StartFlag = questdlg(strvcat(<span class="string">''</span>,<span class="string">'Is it OK to start orbit feedback?'</span>),<span class="string">'Orbit Feedback'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
2131         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
2132             <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2133             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2134             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2135 
2136             a = clock;
2137             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2138             fprintf(<span class="string">'   ***************************\n'</span>);
2139             fprintf(<span class="string">'   **  Orbit Feedback Exit  **\n'</span>);
2140             fprintf(<span class="string">'   ***************************\n\n'</span>);
2141             pause(0);
2142             <span class="keyword">return</span>
2143         <span class="keyword">end</span>
2144 
2145         SR_STATE_OLD = scaget(<span class="string">'SR_STATE'</span>);
2146         setpv(<span class="string">'SR_STATE'</span>, 5);
2147         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
2148         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2149         <span class="keyword">if</span> StateNumber &gt;= 0
2150             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2151         <span class="keyword">else</span>
2152             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2153         <span class="keyword">end</span>
2154         fprintf(<span class="string">'   Using %d E-vectors horizontally.\n'</span>, length(Xivec));
2155         fprintf(<span class="string">'   Using %d E-vectors vertically.\n'</span>,   length(Yivec));
2156         fprintf(<span class="string">'   Starting slow orbit correction every %.1f seconds.\n'</span>, LoopDelay);
2157         <span class="comment">%  fprintf('   Resetting SR11 chicane motors every 20 seconds to fix drift problem.\n');</span>
2158 
2159         IDSector = getlist(<span class="string">'ID'</span>);
2160         EPUlist = find((IDSector(:,1)==4) | (IDSector(:,1)==11));
2161         oldgap=210*ones(size(IDSector,1),1);
2162         oldShift=zeros(size(oldgap));
2163           
2164         <span class="keyword">try</span>
2165             
2166             <span class="comment">% Get and display data</span>
2167             x = FB.OCSx.GoalOrbit - getx(FB.OCSx.BPM.DeviceList);
2168             y = FB.OCSy.GoalOrbit - gety(FB.OCSy.BPM.DeviceList);
2169             STDx = norm(x)/sqrt(length(x));
2170             STDy = norm(y)/sqrt(length(y));
2171             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = %.4f mm'</span>,STDx),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2172             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = %.4f mm'</span>,STDy),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2173 
2174             <span class="comment">% write goldenorbit values to Fast Orbit Feedback</span>
2175             <span class="keyword">try</span>
2176                 <a href="write_goldenorbit_ffb.html" class="code" title="function write_goldenorbit_ffb">write_goldenorbit_ffb</a>;
2177             <span class="keyword">catch</span>
2178                 disp(<span class="string">'write_goldenorbit_ffb did not work!'</span>);
2179             <span class="keyword">end</span>
2180             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2181             <span class="comment">%pause(0);</span>
2182 
2183             <span class="comment">%display state of FOFB system</span>
2184             FOFBStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2185                 getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2186                 getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2187                 getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2188             FOFBStatusStr = [<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>];
2189             <span class="keyword">for</span> loop = 1:size(FOFBStatus,2)
2190                 <span class="keyword">if</span> FOFBStatus(loop)==0
2191                     FOFBStatusStr(loop,:) = <span class="string">'OFF '</span>;
2192                 <span class="keyword">elseif</span> FOFBStatus(loop)==1
2193                     FOFBStatusStr(loop,:) = <span class="string">'ON  '</span>;
2194                 <span class="keyword">elseif</span> FOFBStatus(loop)==2
2195                     FOFBStatusStr(loop,:) = <span class="string">'OPEN'</span>;
2196                 <span class="keyword">else</span>
2197                     FOFBStatusStr(loop,:) = <span class="string">'BAD '</span>;
2198                 <span class="keyword">end</span>
2199             <span class="keyword">end</span>
2200             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 %s'</span>,FOFBStatusStr(1,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2201             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 %s'</span>,FOFBStatusStr(2,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2202             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 %s'</span>,FOFBStatusStr(3,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2203             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 %s'</span>,FOFBStatusStr(4,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2204             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 %s'</span>,FOFBStatusStr(5,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2205             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 %s'</span>,FOFBStatusStr(6,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2206             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 %s'</span>,FOFBStatusStr(7,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2207             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 %s'</span>,FOFBStatusStr(8,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2208             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 %s'</span>,FOFBStatusStr(9,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2209             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 %s'</span>,FOFBStatusStr(10,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2210             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 %s'</span>,FOFBStatusStr(11,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2211             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 %s'</span>,FOFBStatusStr(12,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2212 
2213         <span class="keyword">catch</span>
2214 
2215             fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
2216 
2217             <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2218             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2219             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2220 
2221 
2222             a = clock;
2223             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2224             fprintf(<span class="string">'   *************************************************************\n'</span>);
2225             fprintf(<span class="string">'   **  Orbit feedback could not start due to error condition  **\n'</span>);
2226             fprintf(<span class="string">'   *************************************************************\n\n'</span>);
2227 
2228             setpv(<span class="string">'SR_STATE'</span>,SR_STATE_OLD);
2229             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2230             <span class="keyword">if</span> StateNumber &gt;= 0
2231                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2232             <span class="keyword">else</span>
2233                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2234             <span class="keyword">end</span>
2235             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
2236             pause(0);
2237 
2238             <span class="keyword">return</span>
2239 
2240         <span class="keyword">end</span>
2241 
2242 
2243         <span class="comment">% Disable buttons</span>
2244         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
2245         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2246         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2247         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2248         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2249         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2250         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2251         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2252         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2253         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2254         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2255         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2256         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2257         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2258         pause(0);
2259 
2260 
2261         <span class="comment">% Initialize feedback loop</span>
2262         StartTime = gettime;
2263         StartErrorTime = gettime;
2264         Xold = getx(FB.OCSx.BPM.DeviceList);
2265         Yold = gety(FB.OCSy.BPM.DeviceList);
2266         HQMOFM_stalenum = 0;
2267         pause(LoopDelay);
2268 
2269         N_HCM = size(HCMlist1,1);
2270         N_VCM = size(VCMlist1,1);
2271 
2272         N_RFMO = 1;
2273 
2274         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
2275             [FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,<span class="string">'SetRF'</span>,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2276         <span class="keyword">else</span>
2277             [FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2278         <span class="keyword">end</span>
2279         [FB.OCSx, Smatx, Sx, Ux, Vx] = orbitcorrectionmethods(FB.OCSx);
2280 
2281         [FB.OCSy, junk, OCSy0] = setorbit(FB.OCSy,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2282         [FB.OCSy, Smaty, Sy, Uy, Vy] = orbitcorrectionmethods(FB.OCSy);
2283 
2284 
2285         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2286         <span class="comment">% Start feedback loop %</span>
2287         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2288 
2289         <span class="comment">% chicaneloop=1;  % loop variable for resetting drifting chicanes (see a few lines below)</span>
2290         <span class="comment">% fftest=figure;</span>
2291 
2292         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2); <span class="comment">% put FOFB in open loop so beamnoise gets recorded even if FOFB is not enabled</span>
2293 
2294         <span class="keyword">while</span> 1
2295             <span class="keyword">try</span>
2296                 t00 = gettime;
2297 
2298                 <span class="comment">%          if chicaneloop==20 % reset SR11 motor chicane setpoints every 20s due to drifting positions</span>
2299                 <span class="comment">%             setsp('HCMCHICANEM',HCMCHICANEMsp(6),[11 1],0);</span>
2300                 <span class="comment">%             setsp('HCMCHICANEM',HCMCHICANEMsp(7),[11 2],0);</span>
2301                 <span class="comment">%             chicaneloop = 1;</span>
2302                 <span class="comment">%          else</span>
2303                 <span class="comment">%             chicaneloop = chicaneloop + 1;</span>
2304                 <span class="comment">%          end</span>
2305 
2306                 <span class="comment">% Check if GUI has been closed</span>
2307                 <span class="keyword">if</span> isempty(gcbf)
2308                     FEEDBACK_STOP_FLAG = 1;
2309                     lasterr(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2310                     error(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2311                 <span class="keyword">end</span>
2312 
2313                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2314                 <span class="comment">% Fast orbit feedback %</span>
2315                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2316                 <span class="keyword">if</span> StartFOFBFlag == 1 &amp;&amp; FBloopIter &gt; 3
2317                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2318                     pause(0.5);
2319                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,1);
2320                     StartFOFBFlag = 0;
2321                     pause(1);
2322                     FOFBOnStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2323                         getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2324                         getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2325                         getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2326                     <span class="keyword">if</span> any(FOFBOnStatus==0) || any(FOFBOnStatus==2)
2327                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2); <span class="comment">% open FOFB loop</span>
2328                         disp(<span class="string">'************************************************************************************************************'</span>);
2329                         disp(<span class="string">'** Problem turning on Fast Orbit Feedback system...                                                       **'</span>);
2330                         disp(<span class="string">'** Check status of ffbsecXX crates - but remember that a crate reboot will turn off Quads in that sector! **'</span>);
2331                         disp(<span class="string">'** Suggest disabling the &quot;Fast Orbit Correction&quot; checkbox and starting Orbit Feedback again.              **'</span>);
2332                         disp(<span class="string">'************************************************************************************************************'</span>);
2333                     <span class="keyword">else</span>
2334                         fprintf(<span class="string">'   Starting Fast Orbit Feedback at %.0f Hz.\n'</span>, getpv(<span class="string">'SR01____FFBFREQAM00'</span>));
2335                     <span class="keyword">end</span>
2336                 <span class="keyword">end</span>
2337 
2338 
2339                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2340                 <span class="comment">% Horizontal plane &quot;feedback&quot; %</span>
2341                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2342 
2343                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxSOFB'</span>),<span class="string">'Value'</span>) == 1
2344 
2345                     <span class="comment">% Get orbit and check that the BPMs are different from the last update</span>
2346                     Xnew = getx(FB.OCSx.BPM.DeviceList);
2347 
2348                     <span class="comment">% Don't feedback if the current is too small</span>
2349                     <span class="keyword">if</span> getdcct &lt; 5
2350                         FEEDBACK_STOP_FLAG = 1;
2351                         fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2352                         <span class="keyword">break</span>;
2353                     <span class="keyword">end</span>
2354 
2355                     x = Xgoal - Xnew;
2356                     STDx = norm(x)/sqrt(length(x));
2357 
2358                     <span class="keyword">if</span> any(Xold == Xnew)
2359                         a = clock;
2360                         N_Stale_Data_Points = find((Xold==Xnew)==1);
2361                         <span class="keyword">for</span> loop = N_Stale_Data_Points'
2362                             fprintf(<span class="string">'   Stale data: BPMx(%2d,%d), feedback step skipped (%s %d:%d:%.0f). \n'</span>, FB.OCSx.BPM.DeviceList(loop,1), FB.OCSx.BPM.DeviceList(loop,2), date, a(4), a(5), a(6));
2363                         <span class="keyword">end</span>
2364                     <span class="keyword">else</span>
2365                         <span class="comment">% Compute horizontal correction</span>
2366                         <span class="comment">%%%OCSx0 = FB.OCSx;</span>
2367                         FB.OCSx.BPM.Data = Xnew;
2368                         FB.OCSx = orbitcorrectionmethods(FB.OCSx, Smatx, Sx, Ux, Vx);
2369 
2370                         <span class="comment">%%%[FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,'Nodisplay','Nosetsp');</span>
2371 
2372                         <span class="comment">% reduced feedback gain (implemented by Greg Portmann, December 2000)</span>
2373                         <span class="comment">% reduced to 0.1, C. Steier, 2001-09-04, IDBPMs are noisy at the moment</span>
2374                         <span class="comment">% increased back to 0.8 C. Steier, 2001-09-29, IDBPMs filtering + direct DAC read/write + all SVDs (no arc BPMs)</span>
2375                         <span class="comment">% increased to 1.0, C. Steier, 2002-05-04, trim DACs</span>
2376                                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2377                                 <span class="comment">% should probably actively allocate X's size to prevent possible memory leak %</span>
2378                                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2379                         X = [Xgain .* FB.OCSx.CM.Delta; 0.3*FB.OCSx.DeltaRF/4.988e-3];
2380                         
2381                         <span class="comment">%%%X = Xgain .* (FB.OCSx.CM.Data - OCSx0.CM.Data);</span>
2382 
2383                         <span class="comment">% check corrector trim values + next step values, warn or stop FB as necessary</span>
2384                         HCMtrimSP=getpv(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1);
2385                         HCMtrimSP_next = HCMtrimSP + X(1:N_HCM);
2386                         <span class="keyword">if</span> max(abs(HCMtrimSP_next)) &gt; 4
2387                             HCMtrimnum=find(abs(HCMtrimSP_next) &gt; 4);
2388 
2389                             <span class="comment">% print message to screen</span>
2390                             fprintf(<span class="string">'\n'</span>);
2391                             fprintf(<span class="string">'***One or more of the horizontal correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2392                             fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2393                             <span class="keyword">for</span> loop = HCMtrimnum'
2394                                 fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1(loop,:)));
2395                             <span class="keyword">end</span>
2396 
2397                             <span class="comment">% send alphapage to operator pager</span>
2398                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2399                             FEEDBACK_STOP_FLAG = 1;
2400 
2401                             setpv(<span class="string">'SR_STATE'</span>, -5);
2402                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2403                             <span class="keyword">if</span> StateNumber &gt;= 0
2404                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2405                             <span class="keyword">else</span>
2406                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2407                             <span class="keyword">end</span>
2408                         <span class="keyword">end</span>
2409 
2410                         <span class="comment">% check chicane trim coil values + next step values, warn or stop FB as necessary</span>
2411                         HCMCHICANEtrimSP=getpv(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>,HCMlist1(iHCMChicane,:));
2412                         HCMCHICANEtrimSP_next = HCMCHICANEtrimSP + X(iHCMChicane);
2413                         <span class="keyword">if</span> max(abs(HCMCHICANEtrimSP_next)) &gt; 19.9
2414                             HCMCHICANEtrimnum=find(abs(HCMCHICANEtrimSP_next) &gt; 19.9);
2415 
2416                             <span class="comment">% print message to screen</span>
2417                             fprintf(<span class="string">'\n'</span>);
2418                             fprintf(<span class="string">'***One or more of the horizontal chicane trim coil correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2419                             fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2420                             <span class="keyword">for</span> loop = HCMCHICANEtrimnum'
2421                                 fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>,HCMlist1(iHCMChicane(loop,:),:)));
2422                             <span class="keyword">end</span>
2423                             fprintf(<span class="string">'***Maybe try resetting the setpoints of the motor chicanes in case they are drifting...\n'</span>);
2424 
2425                             <span class="comment">% send alphapage to operator pager</span>
2426                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2427                             FEEDBACK_STOP_FLAG = 1;
2428 
2429                             setpv(<span class="string">'SR_STATE'</span>, -5);
2430                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2431                             <span class="keyword">if</span> StateNumber &gt;= 0
2432                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2433                             <span class="keyword">else</span>
2434                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2435                             <span class="keyword">end</span>
2436                         <span class="keyword">end</span>
2437 
2438                         <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2439                             <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2440                             <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2441                                 disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2442                             <span class="keyword">end</span>
2443                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2444                             pause(0.5);
2445                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2446                             <span class="keyword">break</span>;
2447                         <span class="keyword">end</span>
2448 
2449                         <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2450                         pause(0);
2451 
2452                         <span class="keyword">if</span> max(abs(HCMtrimSP_next) &gt; 3)
2453                             HCMtrimnum=find(abs(HCMtrimSP_next) &gt; 3);
2454                             HWarnNum=HWarnNum+1;
2455                             <span class="keyword">if</span> (HWarnNum==1 || rem(HWarnNum,120)==0)
2456 
2457                                 <span class="comment">% print message to screen every two minutes</span>
2458                                 fprintf(<span class="string">'\n'</span>);
2459                                 fprintf(<span class="string">'***One or more of the horizontal corrector trims is above 3A or below -3A! \n'</span>);
2460                                 fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2461                                 <span class="keyword">for</span> loop = HCMtrimnum'
2462                                     fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1(loop,:)));
2463                                 <span class="keyword">end</span>
2464                                 fprintf(<span class="string">'***The orbit feedback is still working but this problem should be investigated. \n'</span>);
2465 
2466                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2467                                 <span class="keyword">if</span> (HWarnNum==1 || HWarnNum==600)
2468                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageHCM.txt
2469                                 <span class="keyword">end</span>
2470                             <span class="keyword">end</span>
2471                         <span class="keyword">elseif</span> max(abs(HCMCHICANEtrimSP_next) &gt; 15)
2472                             HCMCHICANEtrimnum=find(abs(HCMCHICANEtrimSP_next) &gt; 15);
2473                             HWarnNum=HWarnNum+1;
2474                             <span class="keyword">if</span> (HWarnNum==1 || rem(HWarnNum,120)==0)
2475 
2476                                 <span class="comment">% print message to screen every two minutes</span>
2477                                 fprintf(<span class="string">'\n'</span>);
2478                                 fprintf(<span class="string">'***One or more of the horizontal chicane corrector trim coils is above 15A or below -15A! \n'</span>);
2479                                 fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2480                                 <span class="keyword">for</span> loop = HCMCHICANEtrimnum'
2481                                     fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>,HCMlist1(iHCMChicane(loop,:),:)));
2482                                 <span class="keyword">end</span>
2483                                 fprintf(<span class="string">'***The orbit feedback is still working but this problem should be investigated. \n'</span>);
2484                                 
2485                                 <span class="comment">%reset motor chicanes in case they are drifting</span>
2486                                 <span class="keyword">try</span>
2487                                         fprintf(<span class="string">'   Resetting the setpoints of the motor chicanes in case they are drifting...\n'</span>);
2488                                         setpv(<span class="string">'HCMCHICANEM'</span>,<span class="string">'Setpoint'</span>,ConfigSetpoint.HCMCHICANEM.Setpoint.Data,[],0);
2489                                 <span class="keyword">catch</span>
2490                                 <span class="keyword">end</span>
2491 
2492                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2493                                 <span class="keyword">if</span> (HWarnNum==1 || HWarnNum==600)
2494                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageHCMCHICANE.txt
2495                                 <span class="keyword">end</span>
2496                             <span class="keyword">end</span>
2497                         <span class="keyword">else</span>
2498                             HWarnNum=0;
2499                         <span class="keyword">end</span>
2500 
2501                         <span class="comment">% Don't feedback if the current is too small</span>
2502                         <span class="keyword">if</span> getdcct &lt; 5
2503                             FEEDBACK_STOP_FLAG = 1;
2504                             fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2505                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/beamisoff.txt
2506                             <span class="keyword">break</span>;
2507                         <span class="keyword">end</span>
2508 
2509                         <span class="keyword">if</span> N_HCM &gt; 0
2510                             steppv(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>, X(iNotHCMChicane), HCMlist1(iNotHCMChicane,:), 0);
2511                             steppv(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>, X(iHCMChicane), HCMlist1(iHCMChicane,:), 0);
2512                         <span class="keyword">end</span>
2513 
2514                         <span class="comment">% write fast orbit feedback setpoints</span>
2515                         <span class="keyword">if</span> 1
2516                             <span class="comment">%write_goldenorbit_ffb_2planes(1, Xnew(1:size(BPMlist1,1))+Sx1*X(1:N_HCM)+Sx3*X(length(X))/20, BPMlist1);</span>
2517                             <span class="comment">% should be corrected to include result of next frequency step ...</span>
2518                             <a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>(1,Xnew(1:size(BPMlist1,1))+Sx1*X(1:N_HCM),BPMlist1);
2519                         <span class="keyword">end</span>
2520 
2521                         <span class="comment">%fprintf('Horizontal Done: %f \n',gettime-t00);</span>
2522 
2523                         <span class="comment">% RF feedback</span>
2524                         HQMOFMsp_last = getpv(<span class="string">'EG______HQMOFM_AC01'</span>);
2525 
2526                         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
2527                             <span class="keyword">if</span> N_RFMO &gt; 0
2528                                 <span class="keyword">if</span> abs(X(end)) &lt; .01
2529                                     <span class="comment">% if abs(FB.OCSx.DeltaRF/3) &lt; .01</span>
2530                                     steppv(<span class="string">'EG______HQMOFM_AC01'</span>, X(end));
2531                                 <span class="keyword">else</span>
2532                                     steppv(<span class="string">'EG______HQMOFM_AC01'</span>, 0.01*sign(X(end)));
2533                                 <span class="keyword">end</span>
2534                             <span class="keyword">end</span>
2535 
2536                             HQMOFMsp_now = getpv(<span class="string">'EG______HQMOFM_AC01'</span>);
2537 
2538                             <span class="comment">% Check for stale RF feedback</span>
2539                             <span class="keyword">if</span> HQMOFMsp_last == HQMOFMsp_now
2540                                 HQMOFM_stalenum = HQMOFM_stalenum + 1;
2541                                 <span class="keyword">if</span> HQMOFM_stalenum == 30 <span class="comment">% warn and message to pager if stale for 30 secs</span>
2542                                     fprintf(<span class="string">'\n'</span>);
2543                                     fprintf(<span class="string">'***The RF is not responding to orbit feedback changes! \n'</span>);
2544                                     fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2545                                     fprintf(<span class="string">'***The orbit feedback is still working but this problem should be investigated. \n'</span>);
2546                                     fprintf(<span class="string">'***ILC 73 controls the EG______HQMOFM_AC01 channel, which sets the RF frequency. \n'</span>);
2547                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstaleRFmessage.txt
2548                                 <span class="keyword">end</span>
2549                                 <span class="keyword">if</span> rem(HQMOFM_stalenum,120)==0 <span class="comment">% message to screen every 2 minutes</span>
2550                                     fprintf(<span class="string">'\n'</span>);
2551                                     fprintf(<span class="string">'***The RF is not responding to orbit feedback changes! (%s)\n'</span>,datestr(now));
2552                                 <span class="keyword">end</span>
2553                             <span class="keyword">else</span>
2554                                 HQMOFM_stalenum = 0;
2555                             <span class="keyword">end</span>
2556 
2557                         <span class="keyword">end</span>
2558 
2559                         <span class="comment">%fprintf('RF Done: %f \n',gettime-t00);</span>
2560 
2561                         Xold = Xnew;
2562                     <span class="keyword">end</span> <span class="comment">% End horizontal correction</span>
2563 
2564 
2565                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2566                     <span class="comment">% Vertical plane &quot;feedback&quot; %</span>
2567                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2568 
2569                     <span class="comment">% Get orbit and check that the BPMs are different from the last update</span>
2570                     Ynew = gety(FB.OCSy.BPM.DeviceList);
2571 
2572                     <span class="comment">% Don't feedback if the current is too small</span>
2573                     <span class="keyword">if</span> getdcct &lt; 5
2574                         FEEDBACK_STOP_FLAG = 1;
2575                         fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2576                         <span class="keyword">break</span>;
2577                     <span class="keyword">end</span>
2578 
2579                     y = Ygoal - Ynew;
2580                     STDy = norm(y)/sqrt(length(y));
2581 
2582                     <span class="keyword">if</span> any(Yold == Ynew)
2583                         a = clock;
2584                         N_Stale_Data_Points = find((Yold==Ynew)==1);
2585                         <span class="keyword">for</span> loop = N_Stale_Data_Points'
2586                             fprintf(<span class="string">'   Stale data: BPMy(%2d,%d), feedback step skipped (%s %d:%d:%.0f). \n'</span>, FB.OCSy.BPM.DeviceList(loop,1), FB.OCSy.BPM.DeviceList(loop,2), date, a(4), a(5), a(6));
2587                         <span class="keyword">end</span>
2588 
2589                     <span class="keyword">else</span>
2590 
2591                         <span class="comment">% Compute vertical correction</span>
2592                         <span class="comment">%%%OCSy0 = FB.OCSy;</span>
2593                         FB.OCSy.BPM.Data = Ynew;
2594                         FB.OCSy = orbitcorrectionmethods(FB.OCSy, Smaty, Sy, Uy, Vy);
2595 
2596                         <span class="comment">%%%[FB.OCSy, RF, OCSy0] = setorbit(FB.OCSy,'Nodisplay','Nosetsp');</span>
2597 
2598                         <span class="comment">% reduced feedback gain, C. Steier, 2001-03-25</span>
2599                         <span class="comment">% reduced to 0.1, C. Steier, 2001-09-04, IDBPMs are noisy at the moment</span>
2600                         <span class="comment">% increased back to 0.8, C. Steier, 2001-09-29, IDBPMs filtering + direct DAC read/write + all SVDs (no arc BPMs)</span>
2601                         <span class="comment">% set to unity gain, C. Steier, 2002-05-04, trim DACs</span>
2602                         Y = Ygain .* FB.OCSy.CM.Delta;
2603                         <span class="comment">%%%Y = Ygain .* (FB.OCSy.CM.Data - OCSy0.CM.Data);</span>
2604 
2605                         <span class="comment">% Just SVD correction</span>
2606                         <span class="comment">% warning('Not using &quot;micado&quot; correction in the vertical plane.');</span>
2607 
2608                         <span class="comment">% check for trim values+next step values, warn or stop FB as necessary</span>
2609                         VCMtrimSP = getpv(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1);
2610                         VCMtrimSP_next = VCMtrimSP + Y(1:N_VCM);
2611                         <span class="keyword">if</span> max(abs(VCMtrimSP_next)) &gt; 12
2612                             VCMtrimnum=find(abs(VCMtrimSP_next) &gt; 12);
2613 
2614                             <span class="comment">% print message to screen</span>
2615                             fprintf(<span class="string">'\n'</span>);
2616                             fprintf(<span class="string">'***One or more of the vertical correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2617                             fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2618                             <span class="keyword">for</span> loop = VCMtrimnum'
2619                                 fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1(loop,:)));
2620                             <span class="keyword">end</span>
2621 
2622                             <span class="comment">% send alphapage to operator pager</span>
2623                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2624                             FEEDBACK_STOP_FLAG = 1;
2625 
2626                             setpv(<span class="string">'SR_STATE'</span>, -5);
2627                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2628                             <span class="keyword">if</span> StateNumber &gt;= 0
2629                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2630                             <span class="keyword">else</span>
2631                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2632                             <span class="keyword">end</span>
2633                         <span class="keyword">end</span>
2634 
2635                         <span class="comment">% check chicane trim coil values + next step values, warn or stop FB as necessary</span>
2636                         VCMCHICANEtrimSP=getpv(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>,VCMlist1(iVCMChicane,:));
2637                         VCMCHICANEtrimSP_next = VCMCHICANEtrimSP + Y(iVCMChicane);
2638                         <span class="keyword">if</span> max(abs(VCMCHICANEtrimSP_next)) &gt; 19.9
2639                             VCMCHICANEtrimnum=find(abs(VCMCHICANEtrimSP_next) &gt; 19.9);
2640 
2641                             <span class="comment">% print message to screen</span>
2642                             fprintf(<span class="string">'\n'</span>);
2643                             fprintf(<span class="string">'***One or more of the vertical chicane trim coil correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2644                             fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2645                             <span class="keyword">for</span> loop = VCMCHICANEtrimnum'
2646                                 fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>,VCMlist1(iVCMChicane(loop,:),:)));
2647                             <span class="keyword">end</span>
2648                             fprintf(<span class="string">'***Maybe try resetting the setpoints of the motor chicanes in case they are drifting...\n'</span>);
2649 
2650                             <span class="comment">% send alphapage to operator pager</span>
2651                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2652                             FEEDBACK_STOP_FLAG = 1;
2653 
2654                             setpv(<span class="string">'SR_STATE'</span>, -5);
2655                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2656                             <span class="keyword">if</span> StateNumber &gt;= 0
2657                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2658                             <span class="keyword">else</span>
2659                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2660                             <span class="keyword">end</span>
2661                         <span class="keyword">end</span>
2662 
2663                         <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2664                             <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2665                             <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2666                                 disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2667                             <span class="keyword">end</span>
2668                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2669                             pause(0.5);
2670                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2671                             <span class="keyword">break</span>;
2672                         <span class="keyword">end</span>
2673 
2674                         <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2675                         <span class="comment">% pause(0);</span>
2676 
2677                         <span class="keyword">if</span> max(abs(VCMtrimSP_next) &gt; 8) <span class="comment">% changed from 6A ~12/1/07 since orbit FB is going past 6A</span>
2678                             VCMtrimnum=find(abs(VCMtrimSP_next) &gt; 8);
2679                             VWarnNum=VWarnNum+1;
2680                             <span class="keyword">if</span> (VWarnNum==1 || rem(VWarnNum,120)==0)
2681 
2682                                 <span class="comment">% print message to screen every two minutes</span>
2683                                 fprintf(<span class="string">'\n'</span>);
2684                                 fprintf(<span class="string">'***One or more of the vertical corrector trims is above 8A or below -8A! \n'</span>);
2685                                 fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2686                                 <span class="keyword">for</span> loop = VCMtrimnum'
2687                                     fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1(loop,:)));
2688                                 <span class="keyword">end</span>
2689                                 fprintf(<span class="string">'***The orbit feedback is still working but this problem should be investigated. \n'</span>);
2690 
2691                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2692                                 <span class="keyword">if</span> (VWarnNum==1 || VWarnNum==600)
2693                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageVCM.txt
2694                                 <span class="keyword">end</span>
2695                             <span class="keyword">end</span>
2696                         <span class="keyword">elseif</span> max(abs(VCMCHICANEtrimSP_next) &gt; 15)
2697                             VCMCHICANEtrimnum=find(abs(VCMCHICANEtrimSP_next) &gt; 15);
2698                             VWarnNum=VWarnNum+1;
2699                             <span class="keyword">if</span> (VWarnNum==1 || rem(VWarnNum,120)==0)
2700 
2701                                 <span class="comment">% print message to screen every two minutes</span>
2702                                 fprintf(<span class="string">'\n'</span>);
2703                                 fprintf(<span class="string">'***One or more of the vertical chicane corrector trim coils is above 15A or below -15A! \n'</span>);
2704                                 fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2705                                 <span class="keyword">for</span> loop = VCMCHICANEtrimnum'
2706                                     fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>,VCMlist1(iVCMChicane(loop,:),:)));
2707                                 <span class="keyword">end</span>
2708                                 fprintf(<span class="string">'***The orbit feedback is still working but this problem should be investigated. \n'</span>);
2709 
2710                                 <span class="comment">%reset motor chicanes in case they are drifting</span>
2711                                 <span class="keyword">try</span>
2712                                         fprintf(<span class="string">'  Resetting the setpoints of the motor chicanes in case they are drifting...\n'</span>);
2713                                         setpv(<span class="string">'HCMCHICANEM'</span>,<span class="string">'Setpoint'</span>,ConfigSetpoint.HCMCHICANEM.Setpoint.Data,[],0);
2714                                 <span class="keyword">catch</span>
2715                                 <span class="keyword">end</span>
2716 
2717                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2718                                 <span class="keyword">if</span> (VWarnNum==1 || VWarnNum==600)
2719                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageVCMCHICANE.txt
2720                                 <span class="keyword">end</span>
2721                             <span class="keyword">end</span>
2722                         <span class="keyword">else</span>
2723                             VWarnNum=0;
2724                         <span class="keyword">end</span>
2725 
2726                         <span class="comment">% Don't feedback if the current is too small</span>
2727                         <span class="keyword">if</span> getdcct &lt; 5
2728                             FEEDBACK_STOP_FLAG = 1;
2729                             fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2730                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/beamisoff.txt
2731                             <span class="keyword">break</span>;
2732                         <span class="keyword">end</span>
2733 
2734                         <span class="keyword">if</span> N_VCM &gt; 0
2735                             steppv(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>, Y(iNotVCMChicane), VCMlist1(iNotVCMChicane,:), 0);
2736                             steppv(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>, Y(iVCMChicane), VCMlist1(iVCMChicane,:), 0);
2737                         <span class="keyword">end</span>
2738 
2739                         <span class="comment">% write fast orbit feedback setpoints</span>
2740                         <span class="keyword">if</span> 1
2741                             <a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>(2,Ynew(1:size(BPMlist1,1))+Sy1*Y(1:N_VCM),BPMlist1);
2742                         <span class="keyword">end</span>
2743 
2744                     <span class="keyword">end</span>
2745 
2746                     Yold = Ynew;
2747 
2748                     <span class="comment">%fprintf('Vertical Done: %f \n',gettime-t00);</span>
2749                 <span class="keyword">end</span> <span class="comment">% End vertical correction</span>
2750 
2751 
2752                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
2753                 <span class="comment">% Tune feed forward %</span>
2754                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
2755                 <span class="comment">% We should do a Sector limit check</span>
2756 
2757                 tic;
2758                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxTune'</span>),<span class="string">'Value'</span>) == 1
2759 
2760                     <span class="keyword">if</span> strcmp(SR_Mode, <span class="string">'1.9 GeV, High Tune'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Inject at 1.23'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Inject at 1.353'</span>) ||<span class="keyword">...</span>
2761                         strcmp(SR_Mode, <span class="string">'1.9 GeV, Two-Bunch'</span>)  || strcmp(SR_Mode, <span class="string">'1.5 GeV, Inject at 1.353'</span>)  || strcmp(SR_Mode, <span class="string">'1.9 GeV, TopOff'</span>)
2762 
2763                         addQFsp = zeros(24,1);
2764                         addQDsp = zeros(24,1);
2765 
2766                         <span class="keyword">if</span> strcmp(FFTypeFlag,<span class="string">'Local'</span>)
2767                             disp(<span class="string">'  No local tune compensation available - global is the default now.'</span>);
2768                         <span class="keyword">elseif</span> strcmp(FFTypeFlag,<span class="string">'Global'</span>)
2769 
2770                             <span class="comment">% The vectorized gets were put outside of loop for speed reasons</span>
2771                             <span class="comment">%</span>
2772                             <span class="comment">% should also set up QFfac, Quadelem, Quadlist structures outside loop</span>
2773                             actualgap = <a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>(IDSector);
2774                             [gapmin,gapmax] = <a href="gaplimit.html" class="code" title="function [GAPmin, GAPmax] = gaplimit(DeviceList)">gaplimit</a>(IDSector);
2775                             corrind = find(actualgap&lt;(gapmin-1));
2776                             actualgap(corrind)=gapmax(corrind);
2777                             Shift=zeros(size(actualgap));
2778                             Shift(EPUlist)=getpv(<span class="string">'EPU'</span>);
2779 
2780                             IDchangedList=find((abs(actualgap-oldgap)&gt;0.005) | (abs(Shift-oldShift)&gt;0.005));
2781 
2782                             <span class="keyword">if</span> ~isempty(IDchangedList)
2783 
2784                                 oldgap=actualgap;
2785                                 oldShift=Shift;
2786 
2787                                 <span class="comment">% EPUs excite nux = .25 resonance in vertical linear polarization mode!</span>
2788                                 <span class="comment">% therefore with EPU tune feedforward</span>
2789                                 <span class="comment">% running, we want to move our nominal working point away (just below) the .25 resonance.</span>
2790                                 <span class="comment">%</span>
2791                                 <span class="comment">% The following tune correction moves nominal</span>
2792                                 <span class="comment">% nu_x from .25 to .245 - this should be enough for well set up lattices.</span>
2793                                 <span class="comment">%</span>
2794                                 <span class="comment">% 24 QF+ 24 QD</span>
2795                                 DeltaAmps = inv(SR_TUNE_MATRIX) * [-0.005;0];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2796                                 addQFsp = addQFsp + DeltaAmps(1,:);
2797                                 addQDsp = addQDsp + DeltaAmps(2,:);
2798 
2799                                 <span class="keyword">for</span> gapnum = 1:length(actualgap)
2800 
2801                                     <span class="comment">% Change in tune and [QF;QD] from maximum gap</span>
2802 
2803                                     <span class="keyword">if</span> (IDSector(gapnum,1) == 4) || (IDSector(gapnum,1) == 11)
2804                                         <span class="keyword">if</span> IDSector(gapnum,2) == 1
2805                                             modenamestr = sprintf(<span class="string">'SR%02dU___ODS1M__DC00'</span>,IDSector(gapnum,1));
2806                                         <span class="keyword">else</span> <span class="comment">% if IDSector(gapnum,2) == 2</span>
2807                                             modenamestr = sprintf(<span class="string">'SR%02dU___ODS2M__DC00'</span>,IDSector(gapnum,1));
2808                                         <span class="keyword">end</span>
2809                                         epumode = getpv(modenamestr);
2810                                         <span class="keyword">if</span> (IDSector(gapnum,1) == 4) &amp;&amp; (IDSector(gapnum,2) == 1) 
2811                                             <span class="keyword">if</span> (epumode == 0)
2812 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_41,shift_epu_41,dnux_epu_41_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2813 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_41,shift_epu_41,dnuy_epu_41_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2814                                                 DeltaNuX = interp2(gap41p',shift41p',dnux41p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2815                                                 DeltaNuY = interp2(gap41p',shift41p',dnuy41p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2816                                             <span class="keyword">elseif</span> (epumode == 1)
2817 <span class="comment">%                                                 DeltaNux = 0;</span>
2818 <span class="comment">%                                                 DeltaNuY = gap2tune(IDSector(gapnum, :), actualgap(gapnum), SR_GeV);</span>
2819                                                 DeltaNuX = interp2(gap41a',shift41a',dnux41a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2820                                                 DeltaNuY = interp2(gap41a',shift41a',dnuy41a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2821                                             <span class="keyword">else</span>
2822                                                 DeltaNux = 0;
2823                                                 DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum, :), actualgap(gapnum), SR_GeV);  
2824                                             <span class="keyword">end</span>
2825                                         <span class="keyword">elseif</span> (IDSector(gapnum,1) == 11) &amp;&amp; (IDSector(gapnum,2) == 1) 
2826                                             <span class="keyword">if</span> (epumode == 0)
2827 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_111,shift_epu_111,dnux_epu_111_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2828 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_111,shift_epu_111,dnuy_epu_111_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2829                                                 DeltaNuX = interp2(gap111p',shift111p',dnux111p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2830                                                 DeltaNuY = interp2(gap111p',shift111p',dnuy111p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2831                                             <span class="keyword">elseif</span> (epumode == 1)
2832 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_111,shift_epu_111,dnux_epu_111_m1',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2833 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_111,shift_epu_111,dnuy_epu_111_m1',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2834                                                 DeltaNuX = interp2(gap111a',shift111a',dnux111a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2835                                                 DeltaNuY = interp2(gap111a',shift111a',dnuy111a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2836                                             <span class="keyword">else</span>
2837                                                 DeltaNuX = 0;
2838                                                 DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);   <span class="comment">% variation of vertical tune shift with phase is small for EPUs</span>
2839                                             <span class="keyword">end</span>
2840                                         <span class="keyword">elseif</span> (IDSector(gapnum,1) == 11) &amp;&amp; (IDSector(gapnum,2) == 2) 
2841                                             <span class="keyword">if</span> (epumode == 0)
2842 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_111,shift_epu_111,dnux_epu_111_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2843 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_111,shift_epu_111,dnuy_epu_111_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2844                                                 DeltaNuX = interp2(gap112p',shift112p',dnux112p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2845                                                 DeltaNuY = interp2(gap112p',shift112p',dnuy112p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2846                                             <span class="keyword">elseif</span> (epumode == 1)
2847 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_111,shift_epu_111,dnux_epu_111_m1',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2848 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_111,shift_epu_111,dnuy_epu_111_m1',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2849                                                 DeltaNuX = interp2(gap112a',shift112a',dnux112a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2850                                                 DeltaNuY = interp2(gap112a',shift112a',dnuy112a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2851                                             <span class="keyword">else</span>
2852                                                 DeltaNuX = 0;
2853                                                 DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);   <span class="comment">% variation of vertical tune shift with phase is small for EPUs</span>
2854                                             <span class="keyword">end</span>
2855                                         <span class="keyword">else</span>
2856                                             DeltaNuX = 0;
2857                                             DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);   
2858                                         <span class="keyword">end</span>
2859 
2860                                     <span class="keyword">else</span>
2861                                         DeltaNuX = 0;
2862                                         DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);
2863                                     <span class="keyword">end</span>
2864 
2865                                     DelQF = zeros(length(QFsp),1);
2866                                     DelQD = zeros(length(QFsp),1);
2867 
2868                                     fraccorr = 0.8*DeltaNuY ./ TuneW16Min;
2869 
2870                                     <span class="comment">% Find which quads to change (local beta beating correction</span>
2871                                     <span class="comment">% (horizontal for EPU, vertical otherwise)</span>
2872                                     QuadList = [IDSector(gapnum,1)-1 2; IDSector(gapnum,1) 1];
2873                                     QuadElem = dev2elem(<span class="string">'QF'</span>,QuadList); <span class="comment">% in reality use QF and QD ...</span>
2874 
2875                                     <span class="comment">% global vertical tune correction</span>
2876                                     <span class="comment">% 24 QF+ 24 QD</span>
2877                                     DeltaAmps = inv(SR_TUNE_MATRIX) * [(fraccorr*6.23e-4); fraccorr*(-0.05301)];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2878                                     DelQF = DelQF + DeltaAmps(1,:);
2879                                     DelQD = DelQD + DeltaAmps(2,:);
2880 
2881                                     <span class="comment">% local horizontal tune correction (is also nearly a beta beating correction) only nonzero for EPUs!</span>
2882                                     <span class="comment">% 2 QF + 2 QD</span>
2883                                     DeltaAmpsLocal = 12*inv(SR_TUNE_MATRIX) * [-DeltaNuX;0];                       <span class="comment">%  DelAmps =  [QF; QD];</span>
2884                                     DelQF(QuadElem) = DelQF(QuadElem)+DeltaAmpsLocal(1,1);
2885                                     DelQD(QuadElem) = DelQD(QuadElem)+DeltaAmpsLocal(2,1);
2886 
2887                                     <span class="comment">% local vertical beta beating correction (should be used together with above global tune correction)</span>
2888                                     <span class="comment">% set to zero for EPUs, since their vertical tune shift is small</span>
2889                                     <span class="comment">% 2 QF + 2QD</span>
2890                                     <span class="keyword">if</span> (IDSector(gapnum,1)==6) || (IDSector(gapnum,1)==7) || (IDSector(gapnum,1)==10) || (IDSector(gapnum,1)==11)
2891                                         QFfac = ([2.243127/2.237111; 2.243127/2.237111]-1) * fraccorr;
2892                                         QDfac = ([2.556392/2.511045; 2.556392/2.511045]-1) * fraccorr;
2893                                     <span class="keyword">elseif</span> (IDSector(gapnum,1)==5) || (IDSector(gapnum,1)==9)
2894                                         QFfac = ([2.225965/2.219784; 2.243096/2.237111]-1) * fraccorr;
2895                                         QDfac = ([2.528950/2.483259; 2.556345/2.511045]-1) * fraccorr;
2896                                     <span class="keyword">elseif</span> (IDSector(gapnum,1)==4) || (IDSector(gapnum,1)==8) || (IDSector(gapnum,1)==12)
2897                                         QFfac = ([2.243096/2.237111; 2.225965/2.219784]-1) * fraccorr;
2898                                         QDfac = ([2.556345/2.511045; 2.528950/2.483259]-1) * fraccorr;
2899                                     <span class="keyword">else</span>
2900                                         QFfac = zeros(2,1);
2901                                         QDfac = zeros(2,1);
2902                                     <span class="keyword">end</span>
2903 
2904                                     DelQF(QuadElem,:) = DelQF(QuadElem,:) + QFfac.*QFsp(QuadElem,:);
2905                                     DelQD(QuadElem,:) = DelQD(QuadElem,:) + QDfac.*QDsp(QuadElem,:);
2906 
2907                                     <span class="comment">% add all tune and beta beating corrections for this one ID to the summed up correction vectors for all IDs</span>
2908                                     addQFsp = addQFsp+DelQF;
2909                                     addQDsp = addQDsp+DelQD;
2910                                     
2911                                     
2912                                     <span class="comment">% Skew FF for IVID</span>
2913                                     <span class="keyword">if</span> (IDSector(gapnum,1)==6)
2914                                         scale=(<a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(6)/0.005)^(3/4)*0.16;
2915                                         [SQSFincr, SQSDincr] = <a href="set_etaywave_nuy9_20skews_skewFF.html" class="code" title="function [SQSFincr, SQSDincr] = set_etaywave_nuy9_20skews_skewFF(scale);">set_etaywave_nuy9_20skews_skewFF</a>(scale);
2916                                         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2917                                         <span class="comment">% should add a limit check here %</span>
2918                                         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2919                                         setpv(<span class="string">'SQSF'</span>, <span class="string">'Setpoint'</span>, SQSFsp+SQSFincr, [], 0, <span class="string">'Physics'</span>);
2920                                         setpv(<span class="string">'SQSD'</span>, <span class="string">'Setpoint'</span>, SQSDsp+SQSDincr, [], 0, <span class="string">'Physics'</span>);
2921                                     <span class="keyword">end</span>
2922 
2923                                 <span class="keyword">end</span>
2924 
2925                                 <span class="comment">% Set quadrupoles using main setpoint channels</span>
2926                                 setpv(<span class="string">'QF'</span>, QFsp+addQFsp,[], 0);
2927                                 setpv(<span class="string">'QD'</span>, QDsp+addQDsp,[], 0);
2928                                 <span class="comment">% % Set quadrupoles using FF setpoint channels</span>
2929                                 <span class="comment">% setpv('QF', 'FF', addQFsp, [], 0);</span>
2930                                 <span class="comment">% setpv('QD', 'FF', addQDsp, [], 0);</span>
2931                                 
2932                             <span class="keyword">end</span>
2933 
2934                         <span class="keyword">else</span>
2935                             error(<span class="string">'Unknown type selected for tune FF'</span>);
2936                         <span class="keyword">end</span>
2937 
2938                     <span class="keyword">else</span>
2939                         disp(<span class="string">'  No tune FF algorithm for non-production modes yet...'</span>);
2940                     <span class="keyword">end</span>
2941                 <span class="keyword">end</span>
2942 
2943                 ffdeltaquad_delay = toc;
2944                 <span class="comment">%fprintf('tune FF delay = %.1f seconds\n',ffdeltaquad_delay);</span>
2945                 <span class="comment">% fprintf('Tune Done: %f \n',gettime-t00);</span>
2946 
2947                 <span class="comment">% Output info to screen</span>
2948                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = %.4f mm'</span>,STDx),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2949                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = %.4f mm'</span>,STDy),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2950                 <span class="comment">%pause(0);</span>
2951 
2952                 FOFBStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2953                     getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2954                     getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2955                     getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2956                 <span class="keyword">for</span> loop = 1:size(FOFBStatus,2)
2957                     <span class="keyword">if</span> FOFBStatus(loop)==0
2958                         FOFBStatusStr(loop,:) = <span class="string">'OFF '</span>;
2959                     <span class="keyword">elseif</span> FOFBStatus(loop)==1
2960                         FOFBStatusStr(loop,:) = <span class="string">'ON  '</span>;
2961                     <span class="keyword">elseif</span> FOFBStatus(loop)==2
2962                         FOFBStatusStr(loop,:) = <span class="string">'OPEN'</span>;
2963                     <span class="keyword">else</span>
2964                         FOFBStatusStr(loop,:) = <span class="string">'BAD '</span>;
2965                     <span class="keyword">end</span>
2966                 <span class="keyword">end</span>
2967                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 %s'</span>,FOFBStatusStr(1,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2968                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 %s'</span>,FOFBStatusStr(2,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2969                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 %s'</span>,FOFBStatusStr(3,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2970                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 %s'</span>,FOFBStatusStr(4,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2971                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 %s'</span>,FOFBStatusStr(5,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2972                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 %s'</span>,FOFBStatusStr(6,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2973                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 %s'</span>,FOFBStatusStr(7,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2974                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 %s'</span>,FOFBStatusStr(8,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2975                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 %s'</span>,FOFBStatusStr(9,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2976                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 %s'</span>,FOFBStatusStr(10,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2977                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 %s'</span>,FOFBStatusStr(11,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2978                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 %s'</span>,FOFBStatusStr(12,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2979 
2980 
2981                 <span class="comment">%fprintf('End of feedback operations: %f \n\n',gettime-t00);</span>
2982 
2983                 <span class="comment">% Wait for next update time or stop request</span>
2984                 <span class="keyword">while</span> (gettime-t00) &lt; LoopDelay
2985                     <span class="comment">%disp('interval could be shorter')</span>
2986                     pause(.05);
2987                     <span class="comment">% Check if GUI has been closed</span>
2988                     <span class="keyword">if</span> isempty(gcbf)
2989                         FEEDBACK_STOP_FLAG = 1;
2990                         lasterr(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2991                         error(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2992                     <span class="keyword">end</span>
2993 
2994                     <span class="comment">% Check if Stop button was pressed</span>
2995                     <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2996                         <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2997                         <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2998                             disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2999                         <span class="keyword">end</span>
3000                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
3001                         pause(0.5);
3002                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
3003                         <span class="keyword">break</span>;
3004                     <span class="keyword">end</span>
3005                 <span class="keyword">end</span>
3006 
3007 
3008                 <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
3009                     <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
3010                     <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
3011                         disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
3012                     <span class="keyword">end</span>
3013                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
3014                     pause(0.5);
3015                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
3016                     <span class="keyword">break</span>;
3017                 <span class="keyword">end</span>
3018 
3019                 StartErrorTime = gettime;
3020 
3021             <span class="keyword">catch</span>
3022 
3023                 fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
3024 
3025                 <span class="comment">% Quit if error exists for more than 20 seconds</span>
3026                 <span class="keyword">if</span> gettime-StartErrorTime&gt;20 || FEEDBACK_STOP_FLAG==1
3027                     fprintf(<span class="string">'%s  Orbit feedback stopped due to error condition. \n\n'</span>,datestr(now));
3028 
3029                     <span class="comment">%send alphapage to operator pager</span>
3030                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
3031                     FEEDBACK_STOP_FLAG = 1;
3032 
3033                     setpv(<span class="string">'SR_STATE'</span>, -5);
3034                     [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
3035                     <span class="keyword">if</span> StateNumber &gt;= 0
3036                         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
3037                     <span class="keyword">else</span>
3038                         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
3039                     <span class="keyword">end</span>
3040                 <span class="keyword">else</span>
3041                     a = clock;
3042                     fprintf(<span class="string">'   Orbit feedback was paused due to error condition (%s %d:%d:%.0f). \n'</span>, date, a(4), a(5), a(6));
3043                     fprintf(<span class="string">'   Orbit feedback has automatically restarted and is running. \n\n'</span>);
3044                 <span class="keyword">end</span>
3045 
3046             <span class="keyword">end</span>
3047 
3048             <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
3049                 <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
3050                 <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
3051                     disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
3052                 <span class="keyword">end</span>
3053                 setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
3054                 pause(0.5);
3055                 setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
3056                 <span class="keyword">break</span>;
3057             <span class="keyword">end</span>
3058 
3059             <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
3060 
3061             <span class="comment">%pause(0);</span>
3062 
3063             <span class="comment">% this loop delays turn on of Fast Feedback system</span>
3064             <span class="keyword">if</span> FBloopIter &lt; 5
3065                 FBloopIter = FBloopIter + 1;
3066             <span class="keyword">end</span>
3067 
3068         <span class="keyword">end</span>  <span class="comment">% End of feedback loop</span>
3069 
3070 
3071         <span class="comment">% End feedback, reset all parameters</span>
3072         <span class="keyword">try</span>
3073 
3074             <span class="comment">% Enable buttons</span>
3075             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3076             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
3077             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3078             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3079             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3080             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3081             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3082             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3083             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3084             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3085             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3086             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3087             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3088 
3089             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = _____ mm'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3090             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = _____ mm'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3091 
3092             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3093             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3094             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3095             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3096             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3097             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3098             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3099             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3100             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3101             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3102             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3103             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3104 
3105             <span class="comment">%pause(0);</span>
3106 
3107         <span class="keyword">catch</span>
3108 
3109             <span class="comment">% GUI must have been closed</span>
3110 
3111         <span class="keyword">end</span>
3112 
3113 
3114         <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
3115         fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
3116         <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
3117 
3118 
3119         a = clock;
3120         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
3121         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
3122         <span class="keyword">if</span> StateNumber &gt;= 0
3123             setpv(<span class="string">'SR_STATE'</span>,5.1);
3124             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
3125             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
3126             fprintf(<span class="string">'   ******************************\n'</span>);
3127             fprintf(<span class="string">'   **  Orbit Feedback Stopped  **\n'</span>);
3128             fprintf(<span class="string">'   ******************************\n\n'</span>);
3129         <span class="keyword">else</span>
3130             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
3131             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
3132             fprintf(<span class="string">'   ****************************************\n'</span>);
3133             fprintf(<span class="string">'   **  Problem With Slow Orbit Feedback  **\n'</span>);
3134             fprintf(<span class="string">'   ****************************************\n\n'</span>);
3135         <span class="keyword">end</span>
3136         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
3137         pause(0);
3138 
3139 
3140     <span class="keyword">case</span> <span class="string">'FeedbackSetup'</span>
3141         InitFlag = Input2;           <span class="comment">% Input #2: if InitFlag, then initialize variables</span>
3142 
3143         <span class="keyword">if</span> InitFlag
3144             
3145            
3146             <span class="comment">% Get the device lists from oscsinit and convert to srcontrol variables</span>
3147             [HBPM, VBPM, HCM, VCM, HSV, VSV] = <a href="ocsinit.html" class="code" title="function [HBPM, VBPM, HCM, VCM, HSV, VSV] = ocsinit(MethodName)">ocsinit</a>(<span class="string">'SOFB'</span>);
3148             Xivec = 1:HSV;
3149             Yivec = 1:VSV;
3150             BPMlist1 = HBPM.DeviceList;
3151             HCMlist1 = HCM.DeviceList;
3152             VCMlist1 = VCM.DeviceList;           
3153             
3154             
3155             OCSx.BPM = getx(BPMlist1, <span class="string">'struct'</span>);
3156             OCSx.CM = getsp(<span class="string">'HCM'</span>, HCMlist1, <span class="string">'struct'</span>);
3157             OCSx.GoalOrbit = getgolden(OCSx.BPM, <span class="string">'numeric'</span>);
3158             OCSx.NIter = 1;
3159             OCSx.SVDIndex = Xivec;
3160             OCSx.IncrementalFlag = <span class="string">'No'</span>;
3161             OCSx.BPMWeight = {[]};
3162             OCSx.FitRF = 0;
3163             OCSy.BPM = gety(BPMlist1, <span class="string">'struct'</span>);
3164             OCSy.CM = getsp(<span class="string">'VCM'</span>, VCMlist1, <span class="string">'struct'</span>);
3165             OCSy.GoalOrbit = getgolden(OCSy.BPM, <span class="string">'numeric'</span>);
3166             OCSy.NIter = 1;
3167             OCSy.SVDIndex = Yivec;
3168             OCSy.IncrementalFlag = <span class="string">'No'</span>;
3169             OCSy.BPMWeight = {[]};
3170             OCSy.FitRF = 0;
3171             
3172             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
3173             <span class="comment">% do we need these Smat calls? %</span>
3174             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
3175             SXmat = getrespmat(OCSx.BPM, OCSx.CM, <span class="string">'numeric'</span>);
3176             SYmat = getrespmat(OCSy.BPM, OCSy.CM, <span class="string">'numeric'</span>);
3177             <span class="comment">% [OCSx, Sx, Ux, Vx] = orbitcorrectionmethods(OCSx, SXmat);</span>
3178             <span class="comment">% [OCSy, Sy, Uy, Vy] = orbitcorrectionmethods(OCSy, SYmat);</span>
3179 
3180             <span class="comment">% initialize FFTypeFlag</span>
3181             FFTypeFlag = <span class="string">'Global'</span>;
3182 
3183             <span class="comment">% Fit decision comes from check box</span>
3184             <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
3185                 OCSx.FitRF = 1;
3186                 Xivec = 1:HSV+1;
3187             <span class="keyword">end</span>
3188         
3189         <span class="keyword">else</span>
3190 
3191             <span class="comment">% Get vectors</span>
3192             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
3193             <span class="comment">% the two lines below seem to fix BPMlist editing problem</span>
3194             OCSx = FB.OCSx;
3195             OCSy = FB.OCSy;
3196             BPMlist1 = FB.BPMlist1;
3197             HCMlist1 = FB.HCMlist1;
3198             VCMlist1 = FB.VCMlist1;
3199             Xivec = FB.Xivec;
3200             Yivec = FB.Yivec;
3201             Xgoal = FB.OCSx.GoalOrbit;
3202             OCSx.GoalOrbit = Xgoal;
3203             Ygoal = FB.OCSy.GoalOrbit;
3204             OCSy.GoalOrbit = Ygoal;
3205             FFTypeFlag = FB.FFTypeFlag;
3206 
3207 
3208             <span class="comment">% FF corrector magnet list - only channels which are blocked when FF is running should be</span>
3209             <span class="comment">% listed</span>
3210             ListFF = [
3211                 4     2
3212                 4     8
3213                 5     1
3214                 5     7
3215 <span class="comment">%               5     8 % IVID is using digital FF, i.e. FF algorithm does not block</span>
3216 <span class="comment">%               6     1 % other access to PVs</span>
3217                 6     8
3218                 7     1
3219                 7     8
3220                 8     1
3221                 8     8
3222                 9     1
3223                 9     8
3224                 10    1
3225                 11    8
3226                 12    1];
3227             ElemFF = dev2elem(<span class="string">'HCM'</span>,ListFF);
3228 
3229 
3230             <span class="comment">% Add button to change #ivectors, cm, IDBPMs,</span>
3231             EditFlag = 0;
3232             h_fig1 = figure;
3233             <span class="keyword">while</span> EditFlag ~= 6
3234 
3235                 Sx = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
3236                 Sy = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
3237                 
3238                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
3239                     DispOrbit = getdisp(<span class="string">'BPMx'</span>, BPMlist1);
3240                     Sx = [Sx DispOrbit];
3241                 <span class="keyword">end</span>
3242                 
3243                 Sx(isnan(Sx)) = 0;
3244                 Sy(isnan(Sy)) = 0;
3245                 
3246                 [Ux, SVx, Vx] = svd(Sx);
3247                 [Uy, SVy, Vy] = svd(Sy);
3248 
3249                 
3250                 <span class="comment">% Remove singular values greater than the actual number of singular values</span>
3251                 i = find(Xivec&gt;length(diag(SVx)));
3252                 <span class="keyword">if</span> ~isempty(i)
3253                     disp(<span class="string">'   Horizontal E-vector scaled since there were more elements in the vector than singular values.'</span>);
3254                     pause(0);
3255                     Xivec(i) = [];
3256                 <span class="keyword">end</span>
3257                 i = find(Yivec&gt;length(diag(SVy)));
3258                 <span class="keyword">if</span> ~isempty(i)
3259                     disp(<span class="string">'   Vertical E-vector scaled since there were more elements in the vector than singular values.'</span>);
3260                     pause(0);
3261                     Yivec(i) = [];
3262                 <span class="keyword">end</span>
3263 
3264 
3265                 Ax = Sx*Vx(:,Xivec);
3266                 Tx = inv(Ax'*Ax)*Ax';
3267 
3268                 Ay = Sy*Vy(:,Yivec);
3269                 Ty = inv(Ay'*Ay)*Ay';
3270 
3271                 figure(h_fig1);
3272                 subplot(2,1,1);
3273                 semilogy(diag(SVx),<span class="string">'b'</span>);
3274                 hold on;
3275                 semilogy(diag(SVx(Xivec,Xivec)),<span class="string">'xr'</span>);
3276                 ylabel(<span class="string">'Horizontal'</span>);
3277                 title(<span class="string">'Response Matrix Singular Values'</span>);
3278                 hold off;
3279                 subplot(2,1,2);
3280                 semilogy(diag(SVy),<span class="string">'b'</span>);
3281                 hold on;
3282                 semilogy(diag(SVy(Yivec,Yivec)),<span class="string">'xr'</span>);
3283                 xlabel(<span class="string">'Singular Value Number'</span>);
3284                 ylabel(<span class="string">'Vertical'</span>);
3285                 hold off;
3286                 drawnow;
3287 
3288                 EditFlag = menu(<span class="string">'Change Parameters?'</span>,<span class="string">'Singular Values'</span>,<span class="string">'HCM List'</span>,<span class="string">'VCM List'</span>, <span class="keyword">...</span>
3289                     <span class="string">'BPM List'</span>,<span class="string">'Change the Goal Orbit'</span>,<span class="string">'Continue'</span>);
3290 
3291                 <span class="keyword">if</span> EditFlag == 1
3292                     prompt={<span class="string">'Enter the horizontal E-vector numbers (Matlab vector format):'</span>,<span class="string">'Enter the vertical E-vector numbers (Matlab vector format):'</span>};
3293                     def={sprintf(<span class="string">'[%d:%d]'</span>,1,Xivec(end)),sprintf(<span class="string">'[%d:%d]'</span>,1,Yivec(end))};
3294                     titlestr=<span class="string">'SVD Orbit Feedback'</span>;
3295                     lineNo=1;
3296                     answer=inputdlg(prompt,titlestr,lineNo,def);
3297                     <span class="keyword">if</span> ~isempty(answer)
3298                         XivecNew = fix(str2num(answer{1}));
3299                         <span class="keyword">if</span> isempty(XivecNew)
3300                             disp(<span class="string">'   Horizontal E-vector cannot be empty.  No change made.'</span>);
3301                         <span class="keyword">else</span>
3302                             <span class="keyword">if</span> any(XivecNew&lt;=0) || max(XivecNew)&gt;length(diag(SVx))
3303                                 disp(<span class="string">'   Error reading horizontal E-vector.  No change made.'</span>);
3304                             <span class="keyword">else</span>
3305                                 Xivec = XivecNew;
3306                             <span class="keyword">end</span>
3307                         <span class="keyword">end</span>
3308                         YivecNew = fix(str2num(answer{2}));
3309                         <span class="keyword">if</span> isempty(YivecNew)
3310                             disp(<span class="string">'   Vertical E-vector cannot be empty.  No change made.'</span>);
3311                         <span class="keyword">else</span>
3312                             <span class="keyword">if</span> any(YivecNew&lt;=0) || max(YivecNew)&gt;length(diag(SVy))
3313                                 disp(<span class="string">'   Error reading vertical E-vector.  No change made.'</span>);
3314                             <span class="keyword">else</span>
3315                                 Yivec = YivecNew;
3316                             <span class="keyword">end</span>
3317                         <span class="keyword">end</span>
3318                     <span class="keyword">end</span>
3319                 <span class="keyword">end</span>
3320 
3321                 <span class="keyword">if</span> EditFlag == 2
3322                     List= getlist(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>);
3323                     CheckList = zeros(96,1);
3324                     Elem = dev2elem(<span class="string">'HCM'</span>, HCMlist1);
3325                     CheckList(Elem) = ones(size(Elem));
3326                     CheckList = CheckList(dev2elem(<span class="string">'HCM'</span>,List));
3327 
3328                     <span class="comment">% Remove FF corrrectors</span>
3329                     <span class="comment">%           Elem = dev2elem('HCM',List);</span>
3330                     <span class="comment">%           for j = length(ElemFF):-1:1</span>
3331                     <span class="comment">%              i = find(Elem==ElemFF(j));</span>
3332                     <span class="comment">%              Elem(i,:) = [];</span>
3333                     <span class="comment">%              List(i,:) = [];</span>
3334                     <span class="comment">%              CheckList(i,:) = [];</span>
3335                     <span class="comment">%           end</span>
3336 
3337                     newList = editlist(List, <span class="string">'HCMtrim'</span>, CheckList);
3338 
3339                     <span class="keyword">if</span> isempty(newList)
3340                         fprintf(<span class="string">'   WARNING: Horizontal corrector magnet list is empty!\n'</span>);
3341                         HCMlist1 = newList;
3342                     <span class="keyword">else</span>
3343                         HCMlist1 = newList;
3344                     <span class="keyword">end</span>
3345                     OCSx.CM.DeviceList = HCMlist1;
3346                 <span class="keyword">end</span>
3347 
3348                 <span class="keyword">if</span> EditFlag == 3
3349                     List = getlist(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>);
3350                     CheckList = zeros(96,1);
3351                     Elem = dev2elem(<span class="string">'VCM'</span>, VCMlist1);
3352                     CheckList(Elem) = ones(size(Elem));
3353                     CheckList = CheckList(dev2elem(<span class="string">'VCM'</span>,List));
3354 
3355                     <span class="comment">% Remove FF corrrectors</span>
3356                     <span class="comment">%           Elem = dev2elem('VCM',List);</span>
3357                     <span class="comment">%           for j = length(ElemFF):-1:1</span>
3358                     <span class="comment">%              i = find(Elem==ElemFF(j));</span>
3359                     <span class="comment">%              Elem(i,:) = [];</span>
3360                     <span class="comment">%              List(i,:) = [];</span>
3361                     <span class="comment">%              CheckList(i,:) = [];</span>
3362                     <span class="comment">%           end</span>
3363 
3364                     newList = editlist(List, <span class="string">'VCMtrim'</span>, CheckList);
3365 
3366                     <span class="keyword">if</span> isempty(newList)
3367                         fprintf(<span class="string">'   WARNING: Vertical corrector magnet list is empty!\n'</span>);
3368                         VCMlist1 = newList;
3369                     <span class="keyword">else</span>
3370                         VCMlist1 = newList;
3371                     <span class="keyword">end</span>
3372                     OCSy.CM.DeviceList = VCMlist1;
3373                 <span class="keyword">end</span>
3374 
3375                 <span class="keyword">if</span> EditFlag == 4
3376                     ListOld = BPMlist1;
3377                     XgoalOld = Xgoal;
3378                     YgoalOld = Ygoal;
3379 
3380                     <span class="comment">% Full BPM list</span>
3381                     List = <a href="getbpmlist.html" class="code" title="function [DeviceList, Index] = getbpmlist(varargin)">getbpmlist</a>(<span class="string">'Bergoz'</span>);
3382 
3383                     CheckList = zeros(size(List,1),1);
3384                     <span class="keyword">if</span> ~isempty(BPMlist1)
3385                         <span class="keyword">for</span> i = 1:size(List,1)
3386                             k = find(List(i,1)==BPMlist1(:,1));
3387                             l = find(List(i,2)==BPMlist1(k,2));
3388 
3389                             <span class="keyword">if</span> isempty(k) || isempty(l)
3390                                 <span class="comment">% Item not in list</span>
3391                             <span class="keyword">else</span>
3392                                 CheckList(i) = 1;
3393                             <span class="keyword">end</span>
3394                         <span class="keyword">end</span>
3395                     <span class="keyword">end</span>
3396 
3397                     newList = editlist(List, <span class="string">'BPM'</span>, CheckList);
3398                     <span class="keyword">if</span> isempty(newList)
3399                         fprintf(<span class="string">'   BPM list cannot be empty.  No change made.\n'</span>);
3400                     <span class="keyword">else</span>
3401                         BPMlist1 = newList;
3402                     <span class="keyword">end</span>
3403 
3404                     <span class="comment">% Set the goal orbit to the golden orbit</span>
3405                     Xgoal = getgolden(<span class="string">'BPMx'</span>, BPMlist1);
3406                     Ygoal = getgolden(<span class="string">'BPMy'</span>, BPMlist1);
3407 
3408 
3409                     <span class="comment">% If a new BPM is added, then set the goal orbit to the golden orbit</span>
3410                     <span class="keyword">for</span> i = 1:size(BPMlist1,1)
3411 
3412                         <span class="comment">% Is it a new BPM?</span>
3413                         k = find(BPMlist1(i,1)==ListOld(:,1));
3414                         l = find(BPMlist1(i,2)==ListOld(k,2));
3415 
3416                         <span class="keyword">if</span> isempty(k) || isempty(l)
3417                             <span class="comment">% New BPM</span>
3418                         <span class="keyword">else</span>
3419                             <span class="comment">% Use the old value for old BPM</span>
3420                             Xgoal(i) = XgoalOld(k(l));
3421                             Ygoal(i) = YgoalOld(k(l));
3422                         <span class="keyword">end</span>
3423                     <span class="keyword">end</span>
3424                     OCSx.BPM.DeviceList = BPMlist1;
3425                     OCSy.BPM.DeviceList = BPMlist1;
3426                     OCSx.GoalOrbit = Xgoal;
3427                     OCSy.GoalOrbit = Ygoal;
3428                 <span class="keyword">end</span>
3429 
3430                 <span class="keyword">if</span> EditFlag == 5
3431                     ChangeList = editlist2(BPMlist1, <span class="string">'Change BPM'</span>, zeros(size(BPMlist1,1),1));
3432 
3433                     <span class="keyword">for</span> i = 1:size(ChangeList,1)
3434 
3435                         k = find(ChangeList(i,1)==BPMlist1(:,1));
3436                         l = find(ChangeList(i,2)==BPMlist1(k,2));
3437 
3438                         prompt={sprintf(<span class="string">'Enter the new horizontal goal orbit for BPMx(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2)),sprintf(<span class="string">'Enter the new vertical goal orbit for BPMy(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2))};
3439                         def={sprintf(<span class="string">'%f'</span>,Xgoal(k(l))),sprintf(<span class="string">'%f'</span>,Ygoal(k(l)))};
3440                         titlestr=<span class="string">'CHANGE THE GOAL ORBIT'</span>;
3441                         lineNo=1;
3442                         answer = inputdlg(prompt, titlestr, lineNo, def);
3443 
3444                         <span class="keyword">if</span> isempty(answer)
3445                             <span class="comment">% No change</span>
3446                             fprintf(<span class="string">'   No change was made to the golden orbit.\n'</span>);
3447                         <span class="keyword">else</span>
3448                             Xgoalnew = str2num(answer{1});
3449                             <span class="keyword">if</span> isempty(Xgoalnew)
3450                                 fprintf(<span class="string">'   No change was made to the horizontal golden orbit.\n'</span>);
3451                             <span class="keyword">else</span>
3452                                 Xgoal(k(l)) = Xgoalnew;
3453                             <span class="keyword">end</span>
3454 
3455                             Ygoalnew = str2num(answer{2});
3456                             <span class="keyword">if</span> isempty(Ygoalnew)
3457                                 fprintf(<span class="string">'   No change was made to the vertical golden orbit.\n'</span>);
3458                             <span class="keyword">else</span>
3459                                 Ygoal(k(l)) = Ygoalnew;
3460                             <span class="keyword">end</span>
3461                         <span class="keyword">end</span>
3462                     <span class="keyword">end</span>
3463                     <span class="keyword">if</span> ~isempty(ChangeList)
3464                         fprintf(<span class="string">'   Note:  Changing the goal orbit for &quot;Slow Orbit Feedback&quot; does not change the goal orbit for &quot;Orbit Correction.&quot;\n'</span>);
3465                         fprintf(<span class="string">'          Re-running srcontrol will restart the goal orbit to the golden orbit.&quot;\n'</span>);
3466                     <span class="keyword">end</span>
3467                     OCSx.GoalOrbit = Xgoal;
3468                     OCSy.GoalOrbit = Ygoal;
3469                 <span class="keyword">end</span>
3470 
3471 <span class="comment">%                 if EditFlag == 6</span>
3472 <span class="comment">%                     FFTypeFlag = questdlg(sprintf('Do you want to use a fully local or a combined local/global compensation of IDs? (nuy=9.2 only)'),'Tune FF','Local','Global', 'Global');</span>
3473 <span class="comment">%                     if strcmp(FFTypeFlag,'Local')</span>
3474 <span class="comment">%                         disp(['   The tune FF will use 8 local quadrupoles to compensate beta beating and tune shift']);</span>
3475 <span class="comment">%                         disp(['   from each ID.']);</span>
3476 <span class="comment">%                     elseif strcmp(FFTypeFlag,'Global')</span>
3477 <span class="comment">%                         disp(['   The tune FF will use 4 local quadrupoles to compensate beta beating and all QF+QD']);</span>
3478 <span class="comment">%                         disp(['   to compensate tune shift from each ID.']);</span>
3479 <span class="comment">%                     end</span>
3480 <span class="comment">%                 end</span>
3481 
3482             <span class="keyword">end</span>
3483             close(h_fig1);
3484         <span class="keyword">end</span>
3485 
3486         <span class="comment">% Save vectors</span>
3487         FB.Xivec = Xivec;
3488         FB.Yivec = Yivec;
3489         FB.HCMlist1 = HCMlist1;
3490         FB.VCMlist1 = VCMlist1;
3491         FB.BPMlist1 = BPMlist1;
3492 
3493         OCSx.SVDIndex = Xivec;
3494         OCSy.SVDIndex = Yivec;
3495         FB.OCSx = OCSx;
3496         FB.OCSy = OCSy;
3497 
3498         FB.FFTypeFlag = FFTypeFlag;
3499         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>,FB);
3500 
3501 
3502     <span class="keyword">case</span> <span class="string">'FastFeedbackSetup'</span>
3503 
3504         InitFlag = Input2;
3505 
3506         <span class="keyword">if</span> InitFlag
3507             FOFBFreq = 1000;
3508             <span class="comment">% user operations 9/14-10/17/04: P=0.5, I=120, D=0.0015 (for both planes)</span>
3509             <span class="comment">% below are known good values for user ops as of 8-1-05</span>
3510             HorP = 2;
3511             HorI = 300;
3512             HorD = 0.002;
3513             VertP = 1;
3514             VertI = 100;
3515             VertD = 0.0015;
3516 
3517             <span class="comment">% this initial set is now done in hwinit.m because it's not a good idea to set anything when srcontrol is launched</span>
3518             <span class="comment">% try</span>
3519             <span class="comment">%     setsp('SR01____FFBFREQAC00', FOFBFreq); % set freq</span>
3520             <span class="comment">%     write_pid_ffb2_patch(HorP, HorI, HorD, VertP, VertI, VertD);</span>
3521             <span class="comment">% catch</span>
3522             <span class="comment">%     disp('   Trouble setting Fast Orbit Feedback parameters!');</span>
3523             <span class="comment">% end</span>
3524 
3525         <span class="keyword">else</span>
3526             <span class="comment">% Get vectors</span>
3527             FOFB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
3528             FOFBFreq = FOFB.FOFBFreq;
3529             HorP  = FOFB.HorP;
3530             HorI  = FOFB.HorI;
3531             HorD  = FOFB.HorD;
3532             VertP = FOFB.VertP;
3533             VertI = FOFB.VertI;
3534             VertD = FOFB.VertD;
3535 
3536             <span class="comment">% Add button to change #ivectors, CMs, IDBPMs,</span>
3537             EditFlag = 0;
3538             <span class="comment">%h_fig1 = figure;</span>
3539             <span class="keyword">while</span> EditFlag ~= 3
3540 
3541                 <span class="comment">%EditFlag = menu('Change Parameters?', 'Fast Feedback Frequency', 'PID Values', 'HCM List', 'VCM List', ...</span>
3542                 <span class="comment">%   'IDBPM List', 'BBPM List', 'Continue');</span>
3543                 <span class="comment">% Use menu below until other FFB config routines work (then also uncomment options 3,4,5,6 below)</span>
3544                 EditFlag = menu(<span class="string">'Change Parameters?'</span>, <span class="string">'Fast Feedback Frequency'</span>, <span class="string">'PID Values'</span>, <span class="string">'Continue'</span>);
3545 
3546                 <span class="keyword">if</span> EditFlag == 1
3547                     <span class="comment">% change rate</span>
3548 
3549                     prompt={<span class="string">'Enter the desired Fast Feedback Frequency (1-1000 Hz)'</span>};
3550                     def={num2str(FOFBFreq)};
3551                     titlestr=<span class="string">'Fast Feedback Setup'</span>;
3552                     lineNo=1;
3553                     answer=inputdlg(prompt,titlestr,lineNo,def);
3554                     <span class="keyword">if</span> ~isempty(answer)
3555                         FOFBFreq = fix(str2num(answer{1}));
3556                         <span class="keyword">if</span> isempty(FOFBFreq)
3557                             disp(<span class="string">'   Frequency value cannot be empty.  No change made.'</span>);
3558                             FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3559                         <span class="keyword">else</span>
3560                             <span class="keyword">if</span> FOFBFreq &lt; 1 || FOFBFreq &gt; 1000
3561                                 disp(<span class="string">'   Frequency must be between 1 and 1000 Hz.  No change made.'</span>);
3562                                 FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3563                             <span class="keyword">end</span>
3564                         <span class="keyword">end</span>
3565                         setsp(<span class="string">'SR01____FFBFREQAC00'</span>,FOFBFreq   ); <span class="comment">% change freq</span>
3566                         pause(0.5);
3567                         fprintf(<span class="string">'   Fast orbit feedback frequency is running at %.0f Hz.\n'</span>, getpv(<span class="string">'SR01____FFBFREQAM00'</span>));
3568                     <span class="keyword">else</span>
3569                         FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3570                     <span class="keyword">end</span>
3571                 <span class="keyword">end</span>
3572 
3573                 <span class="keyword">if</span> EditFlag == 2
3574                     <span class="comment">% edit  PIDs</span>
3575                     <span class="comment">% User defaults are HorP=2, HorI=300, HorD=0.002, VertP=1, VertI=100, VertD=0.0015</span>
3576                     prompt={<span class="string">'P horizontal'</span>, <span class="string">'I horizontal'</span>, <span class="string">'D horizontal'</span>, <span class="string">'P vertical'</span>, <span class="string">'I vertical'</span>, <span class="string">'D vertical'</span>};
3577                     def={num2str(HorP), num2str(HorI), num2str(HorD), num2str(VertP), num2str(VertI), num2str(VertD)};
3578                     titlestr=<span class="string">'Fast Feedback PID Setup'</span>;
3579                     lineNo=1;
3580                     answer=inputdlg(prompt,titlestr,lineNo,def);
3581                     <span class="keyword">if</span> ~isempty(answer)
3582                         HorPnewnum = str2num(answer{1});
3583                         <span class="keyword">if</span> isempty(HorPnewnum)
3584                             disp(<span class="string">'   HorP value cannot be empty.  No change made.'</span>);
3585                         <span class="keyword">else</span>
3586                             HorP = HorPnewnum;
3587                         <span class="keyword">end</span>
3588                         HorInewnum = str2num(answer{2});
3589                         <span class="keyword">if</span> isempty(HorInewnum)
3590                             disp(<span class="string">'   HorI value cannot be empty.  No change made.'</span>);
3591                         <span class="keyword">else</span>
3592                             HorI = HorInewnum;
3593                         <span class="keyword">end</span>
3594                         HorDnewnum = str2num(answer{3});
3595                         <span class="keyword">if</span> isempty(HorDnewnum)
3596                             disp(<span class="string">'   HorD value cannot be empty.  No change made.'</span>);
3597                         <span class="keyword">else</span>
3598                             HorD = HorDnewnum;
3599                         <span class="keyword">end</span>
3600                         VertPnewnum = str2num(answer{4});
3601                         <span class="keyword">if</span> isempty(VertPnewnum)
3602                             disp(<span class="string">'   VertP value cannot be empty.  No change made.'</span>);
3603                         <span class="keyword">else</span>
3604                             VertP = VertPnewnum;
3605                         <span class="keyword">end</span>
3606                         VertInewnum = str2num(answer{5});
3607                         <span class="keyword">if</span> isempty(VertInewnum)
3608                             disp(<span class="string">'   VertI value cannot be empty.  No change made.'</span>);
3609                         <span class="keyword">else</span>
3610                             VertI = VertInewnum;
3611                         <span class="keyword">end</span>
3612                         VertDnewnum = str2num(answer{6});
3613                         <span class="keyword">if</span> isempty(VertDnewnum)
3614                             disp(<span class="string">'   VertD value cannot be empty.  No change made.'</span>);
3615                         <span class="keyword">else</span>
3616                             VertD = VertDnewnum;
3617                         <span class="keyword">end</span>
3618 
3619                         <span class="keyword">try</span>
3620                             write_pid_ffb2_patch(HorP, HorI, HorD, VertP, VertI, VertD);
3621                             fprintf(<span class="string">'   Setting FFB gains to Horizontal P=%.2f, I=%.1f, D=%.4f;  Vertical P=%.2f, I=%.1f, D=%.4f\n'</span>, HorP, HorI, HorD, VertP, VertI, VertD);
3622                         <span class="keyword">catch</span>
3623                             disp(<span class="string">'   Trouble setting Fast Orbit Feedback parameters!'</span>);
3624                         <span class="keyword">end</span>
3625                     <span class="keyword">end</span>
3626                 <span class="keyword">end</span>
3627 
3628                 <span class="comment">%if EditFlag == 3</span>
3629                 <span class="comment">%   disp('   This function not yet available.');</span>
3630                 <span class="comment">%   % change HCM List</span>
3631                 <span class="comment">%end</span>
3632                 <span class="comment">%</span>
3633                 <span class="comment">%if EditFlag == 4</span>
3634                 <span class="comment">%   disp('   This function not yet available.');</span>
3635                 <span class="comment">%   % change VCM List</span>
3636                 <span class="comment">%end</span>
3637                 <span class="comment">%</span>
3638                 <span class="comment">%if EditFlag == 5</span>
3639                 <span class="comment">%   disp('   This function not yet available.');</span>
3640                 <span class="comment">%   % change IDBPM List</span>
3641                 <span class="comment">%end</span>
3642                 <span class="comment">%</span>
3643                 <span class="comment">%if EditFlag == 6</span>
3644                 <span class="comment">%   disp('   This function not yet available.');</span>
3645                 <span class="comment">%   % change BBPM List</span>
3646                 <span class="comment">%end</span>
3647 
3648             <span class="keyword">end</span>
3649             <span class="comment">%close(h_fig1);</span>
3650         <span class="keyword">end</span>
3651 
3652         <span class="comment">% Save vectors</span>
3653         FOFB.FOFBFreq = FOFBFreq;
3654         FOFB.HorP = HorP;
3655         FOFB.HorI = HorI;
3656         FOFB.HorD = HorD;
3657         FOFB.VertP = VertP;
3658         FOFB.VertI = VertI;
3659         FOFB.VertD = VertD;
3660         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Userdata'</span>,FOFB);
3661 
3662     <span class="keyword">otherwise</span>
3663         fprintf(<span class="string">'   No action for %s.\n'</span>, action);
3664 <span class="keyword">end</span>   <span class="comment">% end case</span></pre></div>
<hr><address>Generated on Fri 01-Aug-2008 11:41:01 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>