<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of srcontrol5_includingEPUtuneFF</title>
  <meta name="keywords" content="srcontrol5_includingEPUtuneFF">
  <meta name="description" content="srcontrol5">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">ALS</a> &gt; <a href="index.html">StorageRing</a> &gt; srcontrol5_includingEPUtuneFF.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for ALS\StorageRing&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>srcontrol5_includingEPUtuneFF
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>srcontrol5</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function srcontrol5(action, Input2, Input3) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> srcontrol5
 Storage ring control program

 This program controls all storage ring magnets, performs orbit feedback and
 tune feedforward and helps to diagnose problems in routine user operation
 of the ALS storage ring. It includes a gui to simplify the use of this
 program.

 It was originally programmed by Greg Portmann (until December 2000) with input
 from Winfried Decking, David Robin, Christoph Steier, Ying Wu and others
 and is currently (July 2002) maintained by Christoph Steier and Tom Scarvie.

 The actual version of this program is srcontrol5 (is called by default if you call srcontrol).

 Christoph Steier, July 2002

 SRCONTROL5 is the newest versionof SRCONTROL, edited to work with G. Portmann's new (2005) Matlab middle layer.

 Tom Scarvie, April 2005</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>	BEND2GEV - Compute the energy based on the ramp tables</li><li><a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>	CHECKSRMAGS - Check SR power supplies against a lattice file</li><li><a href="checksrorbit.html" class="code" title="function ErrorNums = checksrorbit(SectorList, BPMxtol,BPMytol)">checksrorbit</a>	ErrorNums =checksrorbit(Sector, BPMxtolerance [.015 mm], [BPMytolerance [.015 mm]])</li><li><a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>	GAP2TUNE - Computes the vertical tune shift for a insertion device gap change.</li><li><a href="gaplimit.html" class="code" title="function [GAPmin, GAPmax] = gaplimit(Dev);">gaplimit</a>	[GapMin, GapMax] = gaplimit(ID_Number);</li><li><a href="getff.html" class="code" title="function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)">getff</a>	function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)</li><li><a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>	GETID - Get the insertion device position, velocity, run flag, and user requested gap</li><li><a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>	[StateNumber, StateString] = getsrstate</li><li><a href="set_alarmhandler_AHU_thresholds_inject.html" class="code" title="function set_alarmhandler_AHU_thresholds_inject">set_alarmhandler_AHU_thresholds_inject</a>	function set_alarmhandler_AHU_thresholds_inject</li><li><a href="set_alarmhandler_thresholds.html" class="code" title="function set_alarmhandler_thresholds">set_alarmhandler_thresholds</a>	set_alarmhandler_thresholds</li><li><a href="set_alarmhandler_thresholds_new.html" class="code" title="function set_alarmhandler_thresholds_new">set_alarmhandler_thresholds_new</a>	set_alarmhandler_thresholds_new</li><li><a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>	SETBPMTIMECONSTANT - Sets the timeconstants for the Bergoz style BPMs.</li><li><a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>	SETBUMPS - Make a straight section bump</li><li><a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>	function setff(Sector, FFEnableBC, GapEnableBC)</li><li><a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>	SETID - Set the insertion device vertical gap</li><li><a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>	</li><li><a href="shift2tune.html" class="code" title="function [Dnux, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = shift2tune(Sector, Gap, EPUshift, GeV)">shift2tune</a>	SHIFT2TUNE - Computes the horizontal tune shift for a EPU gap and horizontal shift</li><li><a href="srcycle.html" class="code" title="function FailFlag = srcycle(varargin)">srcycle</a>	SRCYCLE - Storage ring cycle</li><li><a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>	SRRAMP - Ramp the storage ring energy</li><li><a href="write_goldenorbit_ffb.html" class="code" title="function write_goldenorbit_ffb">write_goldenorbit_ffb</a>	function write_goldenorbit_ffb</li><li><a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>	WRITE_GOLDENORBIT_FFTB_2PLANES - Sets the BPM setpoints which are used by the fast feedback system</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function srcontrol5(action, Input2, Input3)</a>
0002 <span class="comment">% srcontrol5</span>
0003 <span class="comment">% Storage ring control program</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% This program controls all storage ring magnets, performs orbit feedback and</span>
0006 <span class="comment">% tune feedforward and helps to diagnose problems in routine user operation</span>
0007 <span class="comment">% of the ALS storage ring. It includes a gui to simplify the use of this</span>
0008 <span class="comment">% program.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% It was originally programmed by Greg Portmann (until December 2000) with input</span>
0011 <span class="comment">% from Winfried Decking, David Robin, Christoph Steier, Ying Wu and others</span>
0012 <span class="comment">% and is currently (July 2002) maintained by Christoph Steier and Tom Scarvie.</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% The actual version of this program is srcontrol5 (is called by default if you call srcontrol).</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% Christoph Steier, July 2002</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% SRCONTROL5 is the newest versionof SRCONTROL, edited to work with G. Portmann's new (2005) Matlab middle layer.</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% Tom Scarvie, April 2005</span>
0021 
0022 <span class="comment">% known bugs/problems (May 2001):</span>
0023 <span class="comment">% - IDBPM averaging might be a bit too long for orbit feedback</span>
0024 <span class="comment">%        solved after Superbend shutdown ... Instead of averaging, digital low pass filters are used</span>
0025 <span class="comment">% - gap2tune does not give correct answers for wiggler and potentially other IDs -&gt; orbit feedback</span>
0026 <span class="comment">%        seems to be OK for other IDs, has been corrected for wiggler (fit to insertion device</span>
0027 <span class="comment">%        compensation table)</span>
0028 <span class="comment">% - chicanes do not work in orbit feedback</span>
0029 <span class="comment">%        solved. One problem was that orbit response matrizes were mis-scaled by factor of two.</span>
0030 <span class="comment">%        Second problem was different time constant of power supply control. Solved by moving controls</span>
0031 <span class="comment">%        of center chicanes to cPCI (and magnets are fast, hysteresis free, aircore coils).</span>
0032 <span class="comment">%        Center chicane in sector 4 is now routinely used in orbit feedback. Sector 11 to follow soon.</span>
0033 <span class="comment">% - zero reading of ID gap dumps beam</span>
0034 <span class="comment">%        solved in srcontrol5, still a problem in srcontrol5_hightune (but that routine has to be completely</span>
0035 <span class="comment">%        rewritten because of all recent changes to srcontrol5, anyhow). For gap readings below the minimum</span>
0036 <span class="comment">%        allowed gap for a device, the tune feedforward disables itself.</span>
0037 <span class="comment">% - cycling of lattice causes frequent power supply failures</span>
0038 <span class="comment">%        solved by changing the cycling procedure. 1.5 GeV operation is now on the upper hysteresis branch</span>
0039 <span class="comment">%        as was the 1.9 GeV injection lattice before.</span>
0040 <span class="comment">% - frequently stalled data in IDBPM readout</span>
0041 <span class="comment">%        solved with new BPM readouts and digital filtering. Seems to have been a resolution problem</span>
0042 <span class="comment">%        of the digital averaging algorithm.</span>
0043 <span class="comment">% - magnet ramp tables are not in perfect agreement with magnetic measurements</span>
0044 <span class="comment">%        Does not appear to be a serious problem. Superbends are slightly out of sync with other magnets,</span>
0045 <span class="comment">%        but this does not cause any negative effects while ramping.</span>
0046 <span class="comment">% - no good way to operate with injection at 1.5 GeV and storage energy below that</span>
0047 <span class="comment">%        There now is a reasonable way to inject at 1.5 GeV and ramp down to lower storage energy. But</span>
0048 <span class="comment">%        it has to be tested again after implementing new (and more) chicanes ...</span>
0049 
0050 <span class="comment">% revision history</span>
0051 <span class="comment">% 2001-05-10, Christoph Steier</span>
0052 <span class="comment">% check whether readback from insertion device is significantly (more than 1 mm) below minimum</span>
0053 <span class="comment">% gap, to avoid false zero readings of insertion device gaps to cause the tune feed forward</span>
0054 <span class="comment">% to implement false huge correction (and dump the beam). If the insertion device gap readbacks</span>
0055 <span class="comment">% gets more than 1 mm below the nominal minimum gap, the routine now assumes the insertion device</span>
0056 <span class="comment">% to be open.</span>
0057 <span class="comment">%</span>
0058 <span class="comment">% 2001-08-30 and during Superbend commissioning, Christoph Steier, Tom Scarvie, Winni Decking</span>
0059 <span class="comment">% various changes have been made to incorporate the Superbends and some other new equipment</span>
0060 <span class="comment">% installed in the Superbend shutdown. This included some changes to programs being called by srcontrol</span>
0061 <span class="comment">% (like srload, srsave, srcycle, srramp, ...). The main changes within srcontrol were in the orbit</span>
0062 <span class="comment">% correction and slow orbit feedback routines (incorporating frequency feedback, ...)</span>
0063 <span class="comment">%</span>
0064 <span class="comment">% 2002-05-04, Christoph Steier</span>
0065 <span class="comment">% added new IDBPMs, modified orbit feedback to use trim DACs, removed LSB toggling in vertical</span>
0066 <span class="comment">% orbit feedback, ...</span>
0067 <span class="comment">%</span>
0068 
0069 <span class="comment">% 2002-07-29, T.Scarvie</span>
0070 <span class="comment">% added check of CM trim currents to warn of problems that might rail the orbit feedback</span>
0071 <span class="comment">%</span>
0072 <span class="comment">% 2002-07-31, Christoph Steier</span>
0073 <span class="comment">% increased the gain of the RF frequency feedback from 1/50 of the gain of the horizontal</span>
0074 <span class="comment">% orbit feedback to 1/20. Reason was that the frequency feedback was reacting a bit too slow if all</span>
0075 <span class="comment">% insertion device gaps are closed at once at high speed at the beginning of a fill.</span>
0076 <span class="comment">%</span>
0077 <span class="comment">% 2002-08-05, C.Steier, T.Scarvie</span>
0078 <span class="comment">% Added conditional to reduce orbit feedback gain if running in two-bunch mode</span>
0079 <span class="comment">%</span>
0080 <span class="comment">% 2003-06-02, T.Scarvie</span>
0081 <span class="comment">% Added loop inside orbit feedback to reset the SR11 chicane M1 and M2 motors every 20s to combat drift problem</span>
0082 <span class="comment">%</span>
0083 <span class="comment">% 2003-06-18, C. Steier</span>
0084 <span class="comment">% Disabled loop to periodically reset chicane in SR11. Al Robb replaced power supply, seems to be no problem anymore.</span>
0085 <span class="comment">%</span>
0086 <span class="comment">% 2004-05-10, C. Steier</span>
0087 <span class="comment">% The list of all BBPMs is now set up automatically be calling getlist('BBPMx'). This way, new BBPMs have to be added</span>
0088 <span class="comment">% at fewer places in the software. It should now be sufficient to modify getlist and run the orbit response matrix</span>
0089 <span class="comment">% rountine (getsmat) once to enable use of the new BBPMs.</span>
0090 <span class="comment">%</span>
0091 <span class="comment">% 2004-05-14, C. Steier</span>
0092 <span class="comment">% Modified parameters for ramprate reduction (in srramp and here). Previous parameters were slightly too</span>
0093 <span class="comment">% cautious. Increased initial slow ramprate to 0.4 A/s.</span>
0094 <span class="comment">%</span>
0095 <span class="comment">% 2004-05-14, C. Steier</span>
0096 <span class="comment">% Incorporated insertion device compensation schemes for nu_y = 9.2 lattice.</span>
0097 <span class="comment">%</span>
0098 <span class="comment">% 2004-06-14, T.Scarvie</span>
0099 <span class="comment">% Added controls for fast orbit feedback</span>
0100 <span class="comment">%</span>
0101 <span class="comment">% 2004-06-21, C. Steier</span>
0102 <span class="comment">% Added tune feedforward (in the global tune compensation scheme for the nu_y=9.2 lattice) for the shift</span>
0103 <span class="comment">% dependent tune shift of the EPUs, as well as a skew quadrupole feedforward for the EPU im sector 11</span>
0104 <span class="comment">% (both only active in parallel mode so far).</span>
0105 <span class="comment">%</span>
0106 <span class="comment">% 2005-02-13, T.Scarvie</span>
0107 <span class="comment">% Separated horizontal and vertical planes for setting Fast Feedback PIDs</span>
0108 
0109 
0110 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0111 <span class="comment">% NOTES for conversion to new Middle Layer %</span>
0112 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0113 <span class="comment">%</span>
0114 <span class="comment">% We never use the gap and bump control flags - the radio buttons have been disabled -</span>
0115 <span class="comment">%        should we try to keep the functionality?</span>
0116 <span class="comment">%</span>
0117 <span class="comment">% remove handle globals</span>
0118 <span class="comment">% set(0,'showhiddenhandles','on'); what does this do?</span>
0119 <span class="comment">% grampbsc -&gt; should be handled by new srramp (which uses k-values)</span>
0120 <span class="comment">% checksrmags</span>
0121 <span class="comment">% checksrorbit(...)</span>
0122 <span class="comment">% getdcct</span>
0123 <span class="comment">% setbpmtimeconstant</span>
0124 <span class="comment">% getsmatelements</span>
0125 <span class="comment">% Chicane trims are now part of the corrector family</span>
0126 <span class="comment">% getname('IDrunflag',...) family name change</span>
0127 <span class="comment">% write_goldenorbit_ffb, write_goldenorbit_ffb2</span>
0128 
0129 
0130 <span class="comment">% For the compiler</span>
0131 <span class="comment">%#function goldenpage</span>
0132 <span class="comment">%#function setoperationalmode</span>
0133 
0134 
0135 <span class="comment">% Check if the AO exists</span>
0136 checkforao;
0137 
0138 
0139 <span class="comment">%%%%%%%%%%%%%%</span>
0140 <span class="comment">% Initialize %</span>
0141 <span class="comment">%%%%%%%%%%%%%%</span>
0142 
0143 <span class="keyword">global</span> FEEDBACK_STOP_FLAG
0144 
0145 SR_Mode = getfamilydata(<span class="string">'OperationalMode'</span>);
0146 SR_GEV = getfamilydata(<span class="string">'Energy'</span>);
0147 
0148 BSCramprate = getfamilydata(<span class="string">'BSCRampRate'</span>);
0149 <span class="keyword">if</span> isnan(BSCramprate) || isempty(BSCramprate)
0150     BSCramprate = 0.4;
0151     setfamilydata(BSCramprate, <span class="string">'BSCRampRate'</span>);
0152 <span class="keyword">end</span>
0153 
0154 <span class="keyword">if</span> nargin &lt; 1
0155     action = <span class="string">'Initialize'</span>;
0156 <span class="keyword">end</span>
0157 <span class="keyword">if</span> nargin &lt; 2
0158     Input2 = 0;
0159 <span class="keyword">end</span>
0160 <span class="keyword">if</span> nargin &lt; 3
0161     Input3 = 0;
0162 <span class="keyword">end</span>
0163 
0164 <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
0165     FOFBcheckboxVal = 0;
0166 <span class="keyword">else</span>
0167     FOFBcheckboxVal = 1;
0168 <span class="keyword">end</span>
0169 
0170 <span class="comment">%%%%%%%%%%%%%%%%</span>
0171 <span class="comment">% Main Program %</span>
0172 <span class="comment">%%%%%%%%%%%%%%%%</span>
0173 
0174 <span class="keyword">switch</span>(action)
0175 
0176     <span class="keyword">case</span> <span class="string">'StopOrbitFeedback'</span>
0177 
0178         FEEDBACK_STOP_FLAG = 1;
0179 
0180     <span class="keyword">case</span> <span class="string">'Initialize'</span>
0181 
0182         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0183         <span class="comment">% GUI</span>
0184         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0185         ButtonWidth = 200;
0186         ButtonHeight  = 25;
0187 
0188         Offset1 = 8*25+12 + 47 + 25+25;
0189         Offset2 = 47+25+25;
0190         Offset3 = 45+25;
0191         Offset4 = 1;
0192         Offset5 = 30;
0193         FigWidth = ButtonWidth+6;
0194         FigHeight  = 3+7*(ButtonHeight+6)+24+Offset1;
0195         ButtonWidth = 200-6;
0196 
0197         <span class="comment">% Change figure position</span>
0198         set(0,<span class="string">'Units'</span>,<span class="string">'pixels'</span>);
0199         p=get(0,<span class="string">'screensize'</span>);
0200 
0201         h0 = figure( <span class="keyword">...</span>
0202             <span class="string">'Color'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0203             <span class="string">'HandleVisibility'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0204             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0205             <span class="string">'MenuBar'</span>,<span class="string">'none'</span>, <span class="keyword">...</span>
0206             <span class="string">'Name'</span>,<span class="string">'ALS SR CONTROL'</span>, <span class="keyword">...</span>
0207             <span class="string">'NumberTitle'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0208             <span class="string">'Units'</span>,<span class="string">'pixels'</span>, <span class="keyword">...</span>
0209             <span class="string">'Position'</span>,[30 p(4)-FigHeight-40 FigWidth FigHeight+Offset5], <span class="keyword">...</span>
0210             <span class="string">'Resize'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0211             <span class="string">'Tag'</span>,<span class="string">'SRCTRLFig1'</span>);
0212 
0213         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0214             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0215             <span class="string">'Callback'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0216             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0217             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0218             <span class="string">'FontWeight'</span>,<span class="string">'Bold'</span>, <span class="keyword">...</span>
0219             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0220             <span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>, <span class="keyword">...</span>
0221             <span class="string">'Position'</span>,[6 3+6*(ButtonHeight+3)+19+19+8+Offset1  ButtonWidth 20+Offset5], <span class="keyword">...</span>
0222             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0223             <span class="string">'String'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0224             <span class="string">'Tag'</span>,<span class="string">'SRCTRLTitle'</span>);
0225 
0226         <span class="comment">% Frame Box I</span>
0227         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0228             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0229             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0230             <span class="string">'Position'</span>,[3 3+1*(ButtonHeight+3)+Offset1-3+Offset5 ButtonWidth+6 7*ButtonHeight+18], <span class="keyword">...</span>
0231             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0232 
0233         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0234             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0235             <span class="string">'Callback'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0236             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0237             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0238             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0239             <span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>, <span class="keyword">...</span>
0240             <span class="string">'Position'</span>,[6 3+7*(ButtonHeight+3)+Offset1  ButtonWidth 15+Offset5], <span class="keyword">...</span>
0241             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0242             <span class="string">'String'</span>,<span class="string">'Lattice Setup Functions'</span>);
0243 
0244         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0245             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Cycle'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0246             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0247             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0248             <span class="string">'Position'</span>,[6 3+6*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0249             <span class="string">'String'</span>,<span class="string">'Cycle SR Lattice'</span>, <span class="keyword">...</span>
0250             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>);
0251 
0252         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0253             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Injection'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0254             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0255             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0256             <span class="string">'Position'</span>,[6 3+5*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0257             <span class="string">'String'</span>,<span class="string">'Injection'</span>, <span class="keyword">...</span>
0258             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>);
0259 
0260         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0261             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Production'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0262             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0263             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0264             <span class="string">'Position'</span>,[6 3+4*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0265             <span class="string">'String'</span>,<span class="string">'Production'</span>, <span class="keyword">...</span>
0266             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>);
0267 
0268         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0269             <span class="string">'Callback'</span>,[<span class="keyword">...</span>
0270             <span class="string">'fprintf(''\n'');'</span> <span class="keyword">...</span>
0271             <span class="string">'disp([''   **********************************************'']);'</span>, <span class="keyword">...</span>
0272             <span class="string">'disp([''   **  Changing Storage Ring Operational Mode  **'']);'</span>, <span class="keyword">...</span>
0273             <span class="string">'disp([''   **********************************************'']);'</span>, <span class="keyword">...</span>
0274             <span class="string">'setoperationalmode;'</span>, <span class="keyword">...</span>
0275             <span class="string">'srcontrol5(''CheckInputs'');'</span>, <span class="keyword">...</span>
0276             <span class="string">'disp([''   ****************************'']);'</span>, <span class="keyword">...</span>
0277             <span class="string">'disp([''   **  Mode Change Complete  **'']);'</span>, <span class="keyword">...</span>
0278             <span class="string">'disp([''   ****************************'']);'</span>, <span class="keyword">...</span>
0279             <span class="string">'fprintf(''\n'');'</span>], <span class="keyword">...</span>
0280             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0281             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0282             <span class="string">'Position'</span>,[6 3+3*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0283             <span class="string">'Value'</span>,1, <span class="keyword">...</span>
0284             <span class="string">'String'</span>,<span class="string">'Change Operational Mode'</span>, <span class="keyword">...</span>
0285             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>);
0286 
0287         h1 = uicontrol(<span class="keyword">...</span>
0288             <span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0289             <span class="string">'Callback'</span>, [<span class="keyword">...</span>
0290             <span class="string">'srcontrol5(''CheckInputs'');'</span>,<span class="keyword">...</span>
0291             <span class="string">'srcontrol5(''SRState'');'</span>], <span class="keyword">...</span>
0292             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0293             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0294             <span class="string">'Position'</span>,[6 3+2*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0295             <span class="string">'String'</span>,<span class="string">'Check For Problems'</span>, <span class="keyword">...</span>
0296             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>);
0297 
0298         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0299             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs''); goldenpage;'</span>, <span class="keyword">...</span>
0300             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0301             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0302             <span class="string">'Position'</span>,[6 3+1*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0303             <span class="string">'String'</span>,<span class="string">'Golden Page'</span>, <span class="keyword">...</span>
0304             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>);
0305 
0306 
0307         <span class="comment">% Frame Box II</span>
0308         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0309             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0310             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0311             <span class="string">'Position'</span>,[3 3+7*(ButtonHeight+3)-29+Offset2+Offset5 ButtonWidth+6 2*ButtonHeight+15], <span class="keyword">...</span>
0312             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0313         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0314             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0315             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0316             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0317             <span class="string">'Position'</span>,[6 3+8*(ButtonHeight+3)-10+Offset2 ButtonWidth .6*ButtonHeight+Offset5], <span class="keyword">...</span>
0318             <span class="string">'String'</span>,<span class="string">'Global/Local Orbit Correction'</span>, <span class="keyword">...</span>
0319             <span class="string">'Style'</span>,<span class="string">'text'</span>);
0320         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0321             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''OrbitCorrection'');'</span>, <span class="keyword">...</span>
0322             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0323             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0324             <span class="string">'Position'</span>,[6 3+7*(ButtonHeight+3)-6+Offset2+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0325             <span class="string">'String'</span>,<span class="string">'Correct Global Orbit w/ IDBPMs'</span>, <span class="keyword">...</span>
0326             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>);
0327         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0328             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''OrbitCorrectionSetup'',1);'</span>, <span class="keyword">...</span>
0329             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''OrbitCorrectionSetup'',0);'</span>, <span class="keyword">...</span>
0330             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0331             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0332             <span class="string">'Position'</span>,[6 7*(ButtonHeight+3)-22+Offset2+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0333             <span class="string">'String'</span>,<span class="string">'Edit IDBPM, CM, &amp; Local Bump Lists'</span>, <span class="keyword">...</span>
0334             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0335             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0336             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>);
0337 
0338 
0339         <span class="comment">% Frame Box III</span>
0340         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0341             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0342             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0343             <span class="string">'Position'</span>,[3 1.25*(ButtonHeight)+Offset3-45+Offset5 ButtonWidth+6 8*ButtonHeight+5], <span class="keyword">...</span>
0344             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0345         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0346             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0347             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0348             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0349             <span class="string">'Position'</span>,[6 3+7*(ButtonHeight+3)+Offset3-25 ButtonWidth .55*ButtonHeight+Offset5], <span class="keyword">...</span>
0350             <span class="string">'String'</span>,<span class="string">'Orbit Feedback'</span>, <span class="keyword">...</span>
0351             <span class="string">'Style'</span>,<span class="string">'text'</span>);
0352 
0353         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0354             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0355             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0356             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0357             <span class="string">'Position'</span>,[26 3+6*(ButtonHeight+3)+Offset3-18+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0358             <span class="string">'String'</span>,<span class="string">'Slow Orbit Correction'</span>, <span class="keyword">...</span>
0359             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0360             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0361             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxSOFB'</span>);
0362         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0363             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0364             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0365             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0366             <span class="string">'Position'</span>,[26 3+5*(ButtonHeight+3)+Offset3-9+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0367             <span class="string">'String'</span>,<span class="string">'Fast Orbit Correction'</span>, <span class="keyword">...</span>
0368             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0369             <span class="string">'Value'</span>,FOFBcheckboxVal,<span class="keyword">...</span>
0370             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxFOFB'</span>);
0371 
0372         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0373             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0374             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0375             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0376             <span class="string">'Position'</span>,[26 3+4*(ButtonHeight+3)+Offset3+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0377             <span class="string">'String'</span>,<span class="string">'Correct ID Tune Shift  '</span>, <span class="keyword">...</span>
0378             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0379             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0380             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxTune'</span>);
0381 
0382         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0383             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0384             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0385             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0386             <span class="string">'Position'</span>,[26 3+3*(ButtonHeight+3)+Offset3+9+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0387             <span class="string">'String'</span>,<span class="string">'Correct RF Frequency'</span>, <span class="keyword">...</span>
0388             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0389             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0390             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>);
0391 
0392         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0393             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''Feedback'');'</span>, <span class="keyword">...</span>
0394             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0395             <span class="string">'FontSize'</span>,12, <span class="keyword">...</span>
0396             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0397             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0398             <span class="string">'Position'</span>,[8 3+3*(ButtonHeight+3)+3+Offset3-25+Offset5 .5*ButtonWidth-6 1.0*ButtonHeight], <span class="keyword">...</span>
0399             <span class="string">'String'</span>,<span class="string">'Start FB'</span>, <span class="keyword">...</span>
0400             <span class="string">'Value'</span>,0, <span class="keyword">...</span>
0401             <span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>);
0402         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0403             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''StopOrbitFeedback'');pause(0);'</span>, <span class="keyword">...</span>
0404             <span class="string">'Enable'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0405             <span class="string">'FontSize'</span>,12, <span class="keyword">...</span>
0406             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0407             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0408             <span class="string">'Position'</span>,[.5*FigWidth+3 3+3*(ButtonHeight+3)+3+Offset3-25+Offset5 .5*ButtonWidth-6 1.0*ButtonHeight], <span class="keyword">...</span>
0409             <span class="string">'String'</span>,<span class="string">'Stop FB'</span>, <span class="keyword">...</span>
0410             <span class="string">'Value'</span>,0, <span class="keyword">...</span>
0411             <span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>);
0412 
0413         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0414             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0415             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0416             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0417             <span class="string">'Position'</span>,[14 3+2*(ButtonHeight)+14+Offset3-25+Offset5 ButtonWidth-14 .75*ButtonHeight], <span class="keyword">...</span>
0418             <span class="string">'String'</span>,<span class="string">'Horizontal RMS = _____ mm'</span>, <span class="keyword">...</span>
0419             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0420             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>);
0421         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0422             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0423             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0424             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0425             <span class="string">'Position'</span>,[26 3+1.25*(ButtonHeight)+16+Offset3-25+Offset5 ButtonWidth-26 .75*ButtonHeight], <span class="keyword">...</span>
0426             <span class="string">'String'</span>,<span class="string">'Vertical RMS = _____ mm'</span>, <span class="keyword">...</span>
0427             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0428             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>);
0429 
0430         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0431             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''FeedbackSetup'',1);'</span>, <span class="keyword">...</span>
0432             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''FeedbackSetup'',0);'</span>, <span class="keyword">...</span>
0433             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0434             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0435             <span class="string">'Position'</span>,[8 3+1.25*(ButtonHeight)+.5+Offset3-25+Offset5 ButtonWidth-5 .75*ButtonHeight], <span class="keyword">...</span>
0436             <span class="string">'String'</span>,<span class="string">'Edit SOFB Setup'</span>, <span class="keyword">...</span>
0437             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0438             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0439             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>);
0440 
0441         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0442             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''FastFeedbackSetup'',1);'</span>, <span class="keyword">...</span>
0443             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''FastFeedbackSetup'',0);'</span>, <span class="keyword">...</span>
0444             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0445             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0446             <span class="string">'Position'</span>,[8 3+1.25*(ButtonHeight)+.5+Offset3-45+Offset5 ButtonWidth-5 .75*ButtonHeight], <span class="keyword">...</span>
0447             <span class="string">'String'</span>,<span class="string">'Edit FOFB Setup'</span>, <span class="keyword">...</span>
0448             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0449             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0450             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>);
0451 
0452         <span class="comment">% Frame Box IV</span>
0453         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0454             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0455             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0456             <span class="string">'Position'</span>,[3 3+ButtonHeight+Offset4-14+Offset5 ButtonWidth+6 ButtonHeight+12], <span class="keyword">...</span>
0457             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0458         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0459             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0460             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0461             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0462             <span class="string">'Position'</span>,[6 3+1.75*ButtonHeight+5+Offset4-21+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0463             <span class="string">'String'</span>,<span class="string">'Storage Ring State'</span>, <span class="keyword">...</span>
0464             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0465             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHeader'</span>);
0466         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0467             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''CheckInputs'');'</span>, <span class="keyword">...</span>
0468             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0469             <span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>, <span class="keyword">...</span>
0470             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0471             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0472             <span class="string">'Position'</span>,[6 3+ButtonHeight+6+3+2+Offset4-22+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0473             <span class="string">'String'</span>,<span class="string">'   '</span>, <span class="keyword">...</span>
0474             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0475             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>);
0476 
0477 
0478         <span class="comment">% Frame Box &quot;Close&quot;</span>
0479         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0480             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0481             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0482             <span class="string">'Position'</span>,[3 8 ButtonWidth+6 ButtonHeight+8], <span class="keyword">...</span>
0483             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0484         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0485             <span class="string">'Callback'</span>,<span class="string">'close(gcbf);'</span>, <span class="keyword">...</span>
0486             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0487             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0488             <span class="string">'Position'</span>,[6 13 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0489             <span class="string">'String'</span>,<span class="string">'Close'</span>, <span class="keyword">...</span>
0490             <span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>);
0491 
0492 
0493         <span class="comment">% Update database channels</span>
0494         <a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>;
0495 
0496         <span class="keyword">if</span> nargout &gt; 0
0497             fig = h0;
0498         <span class="keyword">end</span>
0499 
0500 
0501     <span class="keyword">case</span> <span class="string">'Cycle'</span>
0502         GapFlag = Input2;
0503         BumpMagnetFlag = Input3;
0504 
0505         fprintf(<span class="string">'\n'</span>);
0506         disp(<span class="string">'   **************************'</span>);
0507         disp(<span class="string">'   **  Storage Ring Cycle  **'</span>);
0508         disp(<span class="string">'   **************************'</span>);
0509         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
0510 
0511         BSCFlag = questdlg(sprintf(<span class="string">'Cycle Superbend Magnets?'</span>),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0512         <span class="comment">%if strcmp(BSCFlag,'No')</span>
0513         <span class="comment">%    disp(['   ** Superbends will not be cycled. **']);</span>
0514         <span class="comment">%else</span>
0515         <span class="comment">%    disp(['   ** Superbends will be cycled during the second mini-cycle only. **']);</span>
0516         <span class="comment">%end</span>
0517 
0518         ChicSQFlag = questdlg(sprintf(<span class="string">'Cycle chicanes and skew quads and home motor chicanes?'</span>),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0519         <span class="comment">%if strcmp(ChicSQFlag,'No')</span>
0520         <span class="comment">%    disp(['   ** Chicanes and skew quads will not be cycled; motor chicanes will not be homed. **']);</span>
0521         <span class="comment">%else</span>
0522         <span class="comment">%    disp(['   ** Chicanes and skew quads will be cycled; motor chicanes will be homed. **']);</span>
0523         <span class="comment">%end</span>
0524 
0525 
0526         StartFlag = questdlg(sprintf(<span class="string">'Start %.1f GeV Cycle?'</span>,SR_GEV),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0527         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
0528             disp(<span class="string">'   ***************************'</span>);
0529             disp(<span class="string">'   **    Cycle  Canceled    **'</span>);
0530             disp(<span class="string">'   ***************************'</span>);
0531             fprintf(<span class="string">'\n'</span>);
0532             <span class="keyword">return</span>
0533         <span class="keyword">end</span>
0534 
0535         <span class="keyword">try</span>
0536             <span class="keyword">if</span> GapFlag
0537                 <span class="comment">% Make sure that the gaps are open with FF off</span>
0538                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0539                     <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0540                     disp(<span class="string">'   Insertion device gaps are not open.'</span>);
0541                     disp(<span class="string">'   Opening all gaps at maximum speed.'</span>);
0542                     <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0543                     disp(<span class="string">'   Gap control disabled.'</span>);
0544                     disp(<span class="string">'   Feed forward enabled.'</span>);
0545                     pause(1);
0546                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0547                     disp(<span class="string">'   Gaps opened.'</span>);
0548                     disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0549                     a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0550                 <span class="keyword">else</span>
0551                     disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0552                 <span class="keyword">end</span>
0553             <span class="keyword">else</span>
0554                 disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0555             <span class="keyword">end</span>
0556 
0557             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0558             pause(1);
0559             
0560             <a href="srcycle.html" class="code" title="function FailFlag = srcycle(varargin)">srcycle</a>(BSCFlag, ChicSQFlag);
0561 
0562             setpv(<span class="string">'SR_STATE'</span>,1);
0563 
0564         <span class="keyword">catch</span>
0565 
0566             fprintf(<span class="string">'   %s \n'</span>,lasterr);
0567             fprintf(<span class="string">'   Cycle failed due to error condition! \n\n'</span>);
0568             setpv(<span class="string">'SR_STATE'</span>,-1);
0569             
0570         <span class="keyword">end</span>
0571 
0572         date;
0573         a = clock;
0574         datestr1=date;
0575         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0576         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0577         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0578         <span class="keyword">if</span> StateNumber &gt;= 0
0579             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0580             disp(<span class="string">'   **********************************************'</span>);
0581             disp(<span class="string">'   **  SR Cycle complete, ready for injection  **'</span>);
0582             disp(<span class="string">'   **********************************************'</span>); fprintf(<span class="string">'\n'</span>);
0583         <span class="keyword">else</span>
0584             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0585             disp(<span class="string">'   **********************************'</span>);
0586             disp(<span class="string">'   **  Problem cycling SR lattice  **'</span>);
0587             disp(<span class="string">'   **********************************'</span>); fprintf(<span class="string">'\n'</span>);
0588         <span class="keyword">end</span>
0589         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0590         
0591 
0592     <span class="keyword">case</span> <span class="string">'Injection'</span>
0593         AD = getad;
0594         GapFlag = Input2;
0595         BumpMagnetFlag = Input3;
0596 
0597         fprintf(<span class="string">'\n'</span>);
0598         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0599 
0600         <span class="keyword">if</span> abs(AD.Energy - AD.InjectionEnergy) &gt; .05
0601             fprintf(<span class="string">'   ***************************************************\n'</span>);
0602             fprintf(<span class="string">'   **  Setup For %.2f GeV Injection (with ramping)  **\n'</span>, getfamilydata(<span class="string">'InjectionEnergy'</span>));
0603             fprintf(<span class="string">'   ***************************************************\n'</span>);
0604             <a href="set_alarmhandler_AHU_thresholds_inject.html" class="code" title="function set_alarmhandler_AHU_thresholds_inject">set_alarmhandler_AHU_thresholds_inject</a>;
0605             StartFlag = questdlg(sprintf(<span class="string">'Start setup for injection, %.2f GeV?'</span>,getfamilydata(<span class="string">'InjectionEnergy'</span>)),<span class="string">'Injection Setup'</span>,<span class="string">'Ramp quickly'</span>,<span class="string">'Ramp slowly'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0606         <span class="keyword">else</span>
0607             fprintf(<span class="string">'   *************************************************\n'</span>);
0608             fprintf(<span class="string">'   **  Setup For On Energy Injection at %.2f GeV  **\n'</span>, SR_GEV);
0609             fprintf(<span class="string">'   *************************************************\n'</span>);
0610             StartFlag = questdlg(sprintf(<span class="string">'Start setup for injection, %.2f GeV?'</span>,SR_GEV),<span class="string">'Injection Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0611         <span class="keyword">end</span>
0612         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'Cancel'</span>)
0613             disp(<span class="string">'   ********************************'</span>);
0614             disp(<span class="string">'   **  Injection Setup Canceled  **'</span>);
0615             disp(<span class="string">'   ********************************'</span>);
0616             <a href="set_alarmhandler_thresholds.html" class="code" title="function set_alarmhandler_thresholds">set_alarmhandler_thresholds</a>;
0617             fprintf(<span class="string">'\n'</span>);
0618             <span class="keyword">return</span>
0619         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp quickly'</span>)
0620             setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0621         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp slowly'</span>)
0622             setfamilydata(0.4, <span class="string">'BSCRampRate'</span>);
0623         <span class="keyword">end</span>
0624 
0625         <span class="keyword">try</span>
0626 
0627             <span class="keyword">if</span> GapFlag
0628                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([],1,0);
0629                 disp(<span class="string">'   Gap control disabled'</span>);
0630                 disp(<span class="string">'   Feed forward enabled'</span>);
0631                 pause(1);
0632 
0633                 <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0634                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0635                     disp(<span class="string">'   Opening all gaps'</span>);
0636                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0637                 <span class="keyword">end</span>
0638 
0639                 disp(<span class="string">'   Gaps are open'</span>);
0640                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0641                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0642             <span class="keyword">else</span>
0643                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0644             <span class="keyword">end</span>
0645 
0646             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0647             pause(1);
0648 
0649             <span class="keyword">if</span> (AD.Energy-AD.InjectionEnergy) &gt; 0.05
0650                 <span class="comment">% Ramp down to Injection Energy</span>
0651                 ErrorFlag = <a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>(<span class="string">'Injection'</span>);
0652                 <span class="keyword">if</span> ErrorFlag
0653                     error(<span class="string">'Superbends over temperature.'</span>);
0654                 <span class="keyword">end</span>
0655                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n\n'</span>,date, a(4), a(5), a(6));
0656 
0657             <span class="keyword">elseif</span> (AD.Energy-AD.InjectionEnergy) &lt; -0.05
0658 
0659                 <span class="comment">% first load injection lattice, then ramp to 1.9 GeV and back to 1.5 GeV to get onto same hysteresis branch</span>
0660 
0661                 srload(<span class="string">'Injection'</span>);
0662 
0663                 <span class="comment">% load 1.9 GeV lattice</span>
0664                 tempfilename = sprintf(<span class="string">'%s19nuy9prod.mat'</span>, getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>));
0665 
0666                 srload(tempfilename);
0667 
0668                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0669 
0670                 pause(5);
0671 
0672             <span class="keyword">end</span>
0673 
0674             srload(<span class="string">'Injection'</span>);
0675 
0676             setpv(<span class="string">'SR_STATE'</span>,2);
0677 
0678         <span class="keyword">catch</span>
0679 
0680             fprintf(<span class="string">'   %s \n'</span>,lasterr);
0681             fprintf(<span class="string">'   Injection lattice setup failed due to error condition! \n\n'</span>);
0682             setpv(<span class="string">'SR_STATE'</span>,-2);
0683 
0684         <span class="keyword">end</span>
0685 
0686 
0687         date;
0688         a = clock;
0689         datestr1=date;
0690         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0691         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0692         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0693         <span class="keyword">if</span> StateNumber &gt;= 0
0694             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0695             <span class="keyword">if</span> AD.Energy &lt;= 1.5
0696                 disp([<span class="string">'   *******************************************************************************'</span>]);
0697                 disp([<span class="string">'   **  Function complete:  the storage ring is setup for injection at '</span>,sprintf(<span class="string">'%.2f'</span>,SR_GEV),<span class="string">' GeV  **'</span>]);
0698                 disp([<span class="string">'   *******************************************************************************'</span>]); 
0699                 fprintf(<span class="string">'\n'</span>);
0700             <span class="keyword">else</span>
0701                 fprintf(<span class="string">'   **********************************************************************************************\n'</span>);
0702                 fprintf(<span class="string">'   **  Function complete:  the storage ring is setup for injection at %.2f GeV (upper branch)  **\n'</span>, getfamilydata(<span class="string">'InjectionEnergy'</span>));
0703                 fprintf(<span class="string">'   **********************************************************************************************\n'</span>); 
0704                 fprintf(<span class="string">'\n'</span>);
0705             <span class="keyword">end</span>
0706         <span class="keyword">else</span>
0707             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0708             disp(<span class="string">'   ************************************'</span>);
0709             disp(<span class="string">'   **  Problem with injection setup  **'</span>);
0710             disp(<span class="string">'   ************************************'</span>); 
0711             fprintf(<span class="string">'\n'</span>);
0712         <span class="keyword">end</span>
0713         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0714 
0715         <span class="comment">%soundchord;</span>
0716 
0717         setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0718 
0719 
0720     <span class="keyword">case</span> <span class="string">'Production'</span>
0721         GapFlag = Input2;
0722         BumpMagnetFlag = Input3;
0723         AD=getad;
0724         
0725         fprintf(<span class="string">'\n'</span>);
0726         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0727 
0728         <span class="keyword">if</span> abs(AD.Energy - AD.InjectionEnergy) &gt; .05
0729             disp(<span class="string">'   ********************************************************'</span>);
0730             disp(sprintf(<span class="string">'   **  Setup For %.2f GeV User Operation (with ramping)  **'</span>,SR_GEV));
0731             disp(<span class="string">'   ********************************************************'</span>);
0732             StartFlag = questdlg(sprintf(<span class="string">'Start setup for users, %.1f GeV?'</span>,SR_GEV),<span class="string">'User Setup'</span>,<span class="string">'Ramp quickly'</span>,<span class="string">'Ramp slowly'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0733         <span class="keyword">else</span>
0734             disp(<span class="string">'   *****************************************'</span>);
0735             disp(sprintf(<span class="string">'   **  Setup For %.2f GeV User Operation  **'</span>,SR_GEV));
0736             disp(<span class="string">'   *****************************************'</span>);
0737             StartFlag = questdlg(sprintf(<span class="string">'Start setup for users, %.1f GeV?'</span>,SR_GEV),<span class="string">'User Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0738         <span class="keyword">end</span>
0739 
0740         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'Cancel'</span>)
0741             disp(<span class="string">'   ***************************'</span>);
0742             disp(<span class="string">'   **  User Setup Canceled  **'</span>);
0743             disp(<span class="string">'   ***************************'</span>);
0744             fprintf(<span class="string">'\n'</span>);
0745             <span class="keyword">return</span>
0746         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp quickly'</span>)
0747             setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0748         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp slowly'</span>)
0749             setfamilydata(0.4, <span class="string">'BSCRampRate'</span>);
0750         <span class="keyword">end</span>
0751 
0752         <span class="keyword">try</span>
0753 
0754             <span class="keyword">if</span> GapFlag
0755                 <span class="comment">% Make sure that the gaps are open</span>
0756                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0757                     <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0758                     disp(<span class="string">'   Insertion device gaps are not open'</span>);
0759                     disp(<span class="string">'   Opening all gaps at maximum speed'</span>);
0760                     <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0761                     disp(<span class="string">'   Gap control disabled'</span>);
0762                     disp(<span class="string">'   Feed forward enabled'</span>);
0763                     pause(1);
0764                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0765                     disp(<span class="string">'   Gaps opened'</span>);
0766                     disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0767                     a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0768                 <span class="keyword">else</span>
0769                     disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0770                 <span class="keyword">end</span>
0771             <span class="keyword">else</span>
0772                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0773             <span class="keyword">end</span>
0774 
0775             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0776             pause(1);
0777 
0778             <span class="comment">% Ramp up to the production lattice</span>
0779             ErrorFlag = <a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>(<span class="string">'Production'</span>);
0780             <span class="keyword">if</span> ErrorFlag
0781                 error(<span class="string">'Superbends over temperature.'</span>);
0782             <span class="keyword">end</span>
0783             a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0784 
0785             srload(<span class="string">'Production'</span>);
0786 
0787             <span class="keyword">if</span> GapFlag
0788                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0789                 disp(<span class="string">'   Gap control disabled'</span>);
0790                 disp(<span class="string">'   Feed forward enable'</span>);
0791                 pause(1);
0792 
0793                 disp(<span class="string">'   Insertion device velocity profile boolean control off'</span>);
0794                 disp(<span class="string">'   Closing all gaps at maximum speed'</span>);
0795 
0796                 <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0797                 [Position, Velocity, RunFlag, UserGap] = <a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>;
0798 
0799                 <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], UserGap, maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0800 
0801                 <span class="comment">% Turn velocity profile on</span>
0802                 disp(<span class="string">'   Insertion device velocity profile boolean control is on'</span>);
0803                 <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], [], maxsp(<span class="string">'IDvel'</span>), 1, 1, 0);
0804 
0805                 disp(<span class="string">'   Gaps are closed'</span>);
0806                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([4;7;8;9;10;12], 1, 1);
0807                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>(5, 1, 0);
0808                 disp(<span class="string">'   Gap control enabled (except sector 5 (W16))'</span>);
0809             <span class="keyword">end</span>
0810 
0811             <a href="set_alarmhandler_thresholds_new.html" class="code" title="function set_alarmhandler_thresholds_new">set_alarmhandler_thresholds_new</a>;
0812             setpv(<span class="string">'SR_STATE'</span>,3);
0813 
0814         <span class="keyword">catch</span>
0815 
0816             fprintf(<span class="string">'   %s \n'</span>, lasterr);
0817             fprintf(<span class="string">'   User lattice setup failed due to error condition! \n\n'</span>);
0818             setpv(<span class="string">'SR_STATE'</span>,-3);
0819 
0820         <span class="keyword">end</span>
0821 
0822         a = clock;
0823         datestr1=date;
0824         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0825         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0826         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0827         <span class="keyword">if</span> StateNumber &gt;= 0
0828             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0829             disp([<span class="string">'   **************************************************************************'</span>]);
0830             disp([<span class="string">'   **  Function complete:  the storage ring is setup for users at '</span>,sprintf(<span class="string">'%.1f'</span>,SR_GEV),<span class="string">' GeV  **'</span>]);
0831             disp([<span class="string">'   **************************************************************************'</span>]); fprintf(<span class="string">'\n'</span>);
0832         <span class="keyword">else</span>
0833             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0834             disp([<span class="string">'   *************************************'</span>]);
0835             disp([<span class="string">'   **  Problem with production setup  **'</span>]);
0836             disp([<span class="string">'   *************************************'</span>]); fprintf(<span class="string">'\n'</span>);
0837         <span class="keyword">end</span>
0838         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0839 
0840         setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0841 
0842     <span class="keyword">case</span> <span class="string">'CheckInputs'</span>
0843 
0844         SR_GEV = getfamilydata(<span class="string">'Energy'</span>);
0845         AD=getad;
0846         <a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>; 
0847 
0848         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0849 
0850         <span class="keyword">if</span> AD.Energy &gt; 1.55
0851             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection (Ramp Down)'</span>]);
0852             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users (Ramp Up)'</span>]);
0853         <span class="keyword">elseif</span> AD.Energy &lt; 1.45
0854             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection (Ramp Up+cycle)'</span>]);
0855             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users, '</span>,num2str(round(10*SR_GEV)/10),<span class="string">' GeV (Ramp Down)'</span>]);
0856         <span class="keyword">else</span>
0857             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection'</span>]);
0858             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users, '</span>,num2str(round(10*SR_GEV)/10),<span class="string">' GeV'</span>]);
0859         <span class="keyword">end</span>
0860         set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLTitle'</span>),<span class="string">'String'</span>,SR_Mode);
0861 
0862         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0863         <span class="keyword">if</span> StateNumber &gt;= 0
0864             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0865         <span class="keyword">else</span>
0866             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0867         <span class="keyword">end</span>
0868 
0869         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0870 
0871 
0872     <span class="keyword">case</span> <span class="string">'SRState'</span>
0873         NumErrors = 0;
0874         fprintf(<span class="string">'\n'</span>);
0875         disp(<span class="string">'   ***********************************'</span>);
0876         disp(<span class="string">'   **  Checking Storage Ring State  **'</span>);
0877         disp(<span class="string">'   ***********************************'</span>);
0878         a = clock;
0879         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
0880 
0881         <span class="comment">%       FileName = getpv('SR_LATTICE_FILE','String');   % Last srload file name (in OLD MIDDLE LAYER nomenclature!!)</span>
0882 
0883         GeVnow = <a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>;
0884         <span class="keyword">if</span> GeVnow == getfamilydata(<span class="string">'Energy'</span>)
0885             [ConfigSetpoint, ConfigMonitor, FileName] = getproductionlattice;
0886         <span class="keyword">elseif</span> GeVnow == getfamilydata(<span class="string">'InjectionEnergy'</span>)
0887             [ConfigSetpoint, ConfigMonitor, FileName] = getinjectionlattice;
0888         <span class="keyword">else</span>
0889             FileName = <span class="string">''</span>;
0890         <span class="keyword">end</span>
0891 
0892         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0893         fprintf(<span class="string">'   Storage ring operational mode: %s\n'</span>, SR_Mode);
0894         <span class="keyword">if</span> StateNumber &lt; 0
0895             fprintf(<span class="string">'   Storage ring state error: %s\n'</span>, StateString);
0896             NumErrors = NumErrors + 1;
0897         <span class="keyword">else</span>
0898             fprintf(<span class="string">'   Storage ring state: %s\n'</span>, StateString);
0899         <span class="keyword">end</span>
0900         <span class="keyword">if</span> StateNumber==0
0901             <span class="comment">% Storage ring state unknown</span>
0902             NumErrors = NumErrors + 1;
0903         <span class="keyword">elseif</span> abs(StateNumber)==1 || abs(StateNumber)==2
0904             FileNameGoal = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>) getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'InjectionFile'</span>) <span class="string">'.mat'</span>];
0905             <span class="keyword">if</span> ~strcmp(FileName, FileNameGoal)
0906                 fprintf(<span class="string">'   Lattice file %s should be loaded but it appears that %s is loaded.\n'</span>, getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'InjectionFile'</span>), FileName);
0907                 NumErrors = NumErrors + 1;
0908             <span class="keyword">end</span>
0909         <span class="keyword">else</span>
0910             FileNameGoal = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>) getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'LatticeFile'</span>) <span class="string">'.mat'</span>];
0911             <span class="keyword">if</span> ~strcmp(FileName, FileNameGoal)
0912                 fprintf(<span class="string">'   Lattice file %s should be loaded but it appears that %s is loaded.\n'</span>, getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'LatticeFile'</span>), FileName);
0913                 NumErrors = NumErrors + 1;
0914             <span class="keyword">end</span>
0915         <span class="keyword">end</span>
0916 
0917 
0918         <span class="comment">% Check all SR magnets</span>
0919         <span class="keyword">if</span> isempty(FileName)
0920             fprintf(<span class="string">'   Goal setpoints will not be checked since the last lattice load is unknown.\n'</span>);
0921             NumErrors1 = <a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>(<span class="string">''</span>);
0922         <span class="keyword">else</span>
0923 <span class="comment">%            NumErrors1 = checksrmags([getfamilydata('Directory','OpsData') FileName]);</span>
0924             NumErrors1 = <a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>(FileName);
0925         <span class="keyword">end</span>
0926         <span class="keyword">if</span> NumErrors1 == 0
0927             fprintf(<span class="string">'   SR magnets power supplies are OK.\n'</span>);
0928         <span class="keyword">end</span>
0929         NumErrors = NumErrors + NumErrors1;
0930 
0931 
0932         <span class="comment">% Check RF frequency</span>
0933         <span class="keyword">if</span> isempty(FileName)
0934             fprintf(<span class="string">'   RF frequency will not be checked since the last lattice load is unknown.\n'</span>);
0935         <span class="keyword">else</span>
0936 <span class="comment">%            load([getfamilydata('Directory','OpsData'), FileName]);</span>
0937             load(FileName);
0938             [tmp, RFHPCounterPresent] = getrf;
0939             <span class="keyword">if</span> abs(RFHPCounterPresent-ConfigSetpoint.RF.Setpoint.Data) &gt; .002
0940                 NumErrors = NumErrors + 1;
0941                 fprintf(<span class="string">'   RF frequency should be %f, presently it is %f MHz (as measured by the HP counter).\n'</span>, ConfigSetpoint.RF.Setpoint.Data, RFHPCounterPresent);
0942             <span class="keyword">else</span>
0943                 fprintf(<span class="string">'   RF frequency is OK (HP counter is %f MHz, at the time of the lattice save it was %f MHz).\n'</span>, RFHPCounterPresent, ConfigSetpoint.RF.Setpoint.Data);
0944             <span class="keyword">end</span>
0945         <span class="keyword">end</span>
0946 
0947 
0948         <span class="comment">% Check for orbit problems</span>
0949         <span class="keyword">if</span> (StateNumber &gt;= 3) &amp;&amp; (getdcct &gt; 2)   <span class="comment">% Production lattice is loaded with beam in the machine</span>
0950             Xtol = 0.070;
0951             Ytol = 0.010;
0952             NumErrors1 = <a href="checksrorbit.html" class="code" title="function ErrorNums = checksrorbit(SectorList, BPMxtol,BPMytol)">checksrorbit</a>([],Xtol,Ytol);
0953             <span class="keyword">if</span> NumErrors1
0954                 fprintf(<span class="string">'   SR orbit in the ID straight sections or at Bergoz BPMs deviates more than allowed from the golden orbit.\n'</span>);
0955             <span class="keyword">else</span>
0956                 fprintf(<span class="string">'   SR orbit in the ID straight sections and at Bergoz BPMs is OK.\n'</span>);
0957                 fprintf(<span class="string">'   The orbit is within %.3f mm horizontally and %.3f mm vertically'</span>, Xtol, Ytol);
0958             <span class="keyword">end</span>
0959             NumErrors = NumErrors + NumErrors1;
0960         <span class="keyword">else</span>
0961             fprintf(<span class="string">'   Storage ring orbit was not checked.\n'</span>);
0962         <span class="keyword">end</span>
0963 
0964 
0965         a = clock;
0966         datestr1=date;
0967         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0968         <span class="keyword">if</span> NumErrors
0969             disp(<span class="string">'   *********************************'</span>);
0970             disp(<span class="string">'   **  Storage Ring Has Problems  **'</span>);
0971             disp(<span class="string">'   *********************************'</span>);
0972         <span class="keyword">else</span>
0973             disp(<span class="string">'   **********************************'</span>);
0974             disp(<span class="string">'   **  Storage Ring Lattice is OK  **'</span>);
0975             disp(<span class="string">'   **********************************'</span>);
0976         <span class="keyword">end</span>
0977         fprintf(<span class="string">'   \n'</span>);
0978 
0979         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0980         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0981         <span class="keyword">if</span> StateNumber &gt;= 0
0982             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0983         <span class="keyword">else</span>
0984             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0985         <span class="keyword">end</span>
0986         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0987 
0988 
0989     <span class="keyword">case</span> <span class="string">'OrbitCorrection'</span>
0990         fprintf(<span class="string">'\n'</span>);
0991         fprintf(<span class="string">'   *********************************\n'</span>);
0992         fprintf(<span class="string">'   **  Starting Orbit Correction  **\n'</span>);
0993         fprintf(<span class="string">'   *********************************\n'</span>);
0994         a = clock;
0995         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
0996 
0997         StartFlag = questdlg(sprintf(<span class="string">'Start orbit correction, %.1f GeV?'</span>,SR_GEV),<span class="string">'Orbit Correction'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0998         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
0999             disp(<span class="string">'   ********************************'</span>);
1000             disp(<span class="string">'   **  Orbit Correction Aborted  **'</span>);
1001             disp(<span class="string">'   ********************************'</span>);
1002             fprintf(<span class="string">'\n'</span>);
1003             <span class="keyword">return</span>
1004         <span class="keyword">end</span>
1005 
1006         <span class="keyword">if</span> getdcct &lt; 5     <span class="comment">% Don't correct the orbit if the current is too small</span>
1007             fprintf(<span class="string">'   Orbit not corrected due to small current.\n'</span>);
1008             <span class="keyword">return</span>
1009         <span class="keyword">end</span>
1010 
1011         <span class="keyword">if</span> abs(SR_GEV-<a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>(getpv(<span class="string">'BEND'</span>,[1 1])))&gt;  0.05     <span class="comment">% Don't use this routine for the injection lattice</span>
1012             fprintf(<span class="string">'   This routine should only be used for the production energy: Correction aborted\n'</span>);
1013             <span class="keyword">return</span>
1014         <span class="keyword">end</span>
1015 
1016         SR_STATE_OLD = scaget(<span class="string">'SR_STATE'</span>);
1017         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1018         setpv(<span class="string">'SR_STATE'</span>,4);
1019         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1020         <span class="keyword">if</span> StateNumber &gt;= 0
1021             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1022         <span class="keyword">else</span>
1023             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1024         <span class="keyword">end</span>
1025         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1026 
1027 
1028         <span class="keyword">try</span>
1029 
1030             <span class="comment">% 2 Hz update rate on IDBPMs</span>
1031             disp(<span class="string">'   IDBPM time constant set to 0.5s.'</span>)
1032             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.5)
1033             pause(2);
1034 
1035 
1036             <span class="comment">% Turn off feed forward</span>
1037             fprintf(<span class="string">'   Turning feed forward off.\n'</span>);
1038             [FFEnableBM, FFEnableBC] = <a href="getff.html" class="code" title="function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)">getff</a>;
1039             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0);
1040             scasleep(.2);
1041 
1042 
1043             <span class="comment">% Get vectors</span>
1044             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>);
1045             LocalBumplist = FB.LocalBumplist;
1046 
1047         <span class="keyword">catch</span>
1048 
1049             fprintf(<span class="string">'   %s \n'</span>,lasterr);
1050             fprintf(<span class="string">'   Orbit correction setup failed due to error condition! \n\n'</span>);
1051             setpv(<span class="string">'SR_STATE'</span>,-4);
1052             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1053             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1054             <span class="keyword">if</span> StateNumber &gt;= 0
1055                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1056             <span class="keyword">else</span>
1057                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1058             <span class="keyword">end</span>
1059             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1060             <span class="keyword">return</span>
1061 
1062         <span class="keyword">end</span>
1063 
1064         iNotHCMChicane = find(FB.HCMlist1(:,2) &lt; 10); <span class="comment">%used by steppv's for setting correctors in loop</span>
1065         iHCMChicane = find(FB.HCMlist1(:,2) == 10);
1066         iNotVCMChicane = find(FB.VCMlist1(:,2) &lt; 10);
1067         iVCMChicane = find(FB.VCMlist1(:,2) == 10);
1068 
1069         fprintf(<span class="string">'   Starting horizontal and vertical global orbit correction (SVD method).\n'</span>);
1070 
1071         <span class="keyword">for</span> iloop = 1:3
1072             <span class="keyword">try</span>
1073                 <span class="comment">% use the following to get corrector settings in OCS without setting them, so the values can be checked</span>
1074                 FB.OCSx = setorbit(FB.OCSx,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1075                 FB.OCSy = setorbit(FB.OCSy,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1076                 <span class="keyword">if</span> any(abs(FB.OCSx.CM.Delta(iNotHCMChicane)) &gt; 5)
1077                   disp(<span class="string">'   Orbit Correction is changing some horizontal corrector(s) &gt; 5A!!'</span>);
1078                 <span class="keyword">end</span>
1079                 <span class="keyword">if</span> any(abs(FB.OCSy.CM.Delta(iNotVCMChicane)) &gt; 5)
1080                   disp(<span class="string">'   Orbit Correction is changing some vertical corrector(s) &gt; 5A!!'</span>);
1081                 <span class="keyword">end</span>
1082                 <span class="keyword">if</span> any(abs(FB.OCSx.CM.Delta(iHCMChicane)) &gt; 10)
1083                   disp(<span class="string">'   Orbit Correction is changing some horizontal chicane corrector(s) &gt; 10A!!'</span>);
1084                 <span class="keyword">end</span>
1085                 <span class="keyword">if</span> any(abs(FB.OCSy.CM.Delta(iVCMChicane)) &gt; 10)
1086                   disp(<span class="string">'   Orbit Correction is changing some vertical chicane corrector(s) &gt; 10A!!'</span>);
1087                 <span class="keyword">end</span>
1088 
1089 
1090                 <span class="comment">% Correct horizontal orbit</span>
1091                 FB.OCSx = setorbit(FB.OCSx,<span class="string">'NoDisplay'</span>);
1092                 <span class="comment">% Correct vertical orbit</span>
1093                 FB.OCSy = setorbit(FB.OCSy,<span class="string">'NoDisplay'</span>);
1094 
1095 
1096                 <span class="comment">% Check for current in machine - stop orbit correction if DCCT &lt; 5mA</span>
1097                 <span class="keyword">if</span> (getdcct &lt; 4.5)
1098                     error(<span class="string">'**There is less than 5mA in the machine! Stopping orbit correction.'</span>);
1099                 <span class="keyword">end</span>
1100 
1101                 <span class="comment">% Check state of gaps - stop orbit correction if any are moving</span>
1102                 GAPrunflag = getpv(<span class="string">'ID'</span>,<span class="string">'RunFlag'</span>);
1103                 <span class="keyword">if</span> any(GAPrunflag-round(GAPrunflag))
1104                     error(<span class="string">'**One or more of the gaps are moving! Stopping orbit correction.'</span>);
1105                 <span class="keyword">end</span>
1106 
1107                 x = FB.OCSx.GoalOrbit - getx(FB.OCSx.BPM.DeviceList);
1108                 y = FB.OCSy.GoalOrbit - gety(FB.OCSy.BPM.DeviceList);
1109                 fprintf(<span class="string">'   %d. Horizontal RMS = %.3f mm\n'</span>, iloop, norm(x)/sqrt(length(x)));
1110                 fprintf(<span class="string">'   %d.   Vertical RMS = %.3f mm\n'</span>, iloop, norm(y)/sqrt(length(y)));
1111 
1112             <span class="keyword">catch</span>
1113                 <span class="comment">% fprintf('   %s \n',lasterr);</span>
1114                 fprintf(<span class="string">'   Orbit correction failed due to error condition!\n  Fix the problem, reload the lattice (srload), and try again.  \n\n'</span>);
1115                 setpv(<span class="string">'SR_STATE'</span>,-4);
1116                 set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1117                 [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1118                 <span class="keyword">if</span> StateNumber &gt;= 0
1119                     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1120                 <span class="keyword">else</span>
1121                     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1122                 <span class="keyword">end</span>
1123                 set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1124                 <span class="keyword">return</span>
1125             <span class="keyword">end</span>
1126         <span class="keyword">end</span>
1127 
1128 
1129         <span class="comment">% Set user bumps w/o sextupole correctors</span>
1130         <span class="keyword">try</span>
1131 
1132             <span class="comment">%turn up corrector speed here to quicken setting bumps</span>
1133             HCMramprate = getpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>);
1134             VCMramprate = getpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>);
1135             setpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>, 10, [], 0);
1136             setpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>, 10, [], 0);
1137             
1138             <span class="keyword">if</span> ~isempty(LocalBumplist)
1139                 fprintf(<span class="string">'   Setting local bumps in the straight sections.\n'</span>);
1140                 <span class="keyword">for</span> loop = 1:size(LocalBumplist,1)
1141 
1142                     <span class="comment">% Check for current in machine - stop orbit correction if DCCT &lt; 5mA</span>
1143                     <span class="keyword">if</span> (getdcct &lt; 5)
1144                         error(<span class="string">'** There is less than 5mA in the machine! Stopping local bumps.'</span>);
1145                     <span class="keyword">end</span>
1146 
1147                     <span class="comment">% Check state of gaps - stop setting bumps if any are moving</span>
1148                     GAPrunflag = getpv(<span class="string">'ID'</span>,<span class="string">'RunFlag'</span>);
1149                     <span class="keyword">if</span> any(GAPrunflag-round(GAPrunflag))
1150                         error(<span class="string">'** One or more of the gaps are moving! Stopping local bumps.'</span>);
1151                     <span class="keyword">end</span>
1152 
1153                     HCMoldsp = getsp(<span class="string">'HCM'</span>, FB.HCMlist1);
1154                     VCMoldsp = getsp(<span class="string">'VCM'</span>, FB.VCMlist1);
1155 
1156                     <span class="keyword">if</span> any(LocalBumplist(loop,1) == [4 6 11])
1157                         <span class="keyword">if</span> LocalBumplist(loop,2) == 0
1158                             <span class="comment">% Upstream bump</span>
1159                             [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1)-1 11;LocalBumplist(loop,1)-1 12;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1160                             <span class="keyword">if</span> isempty(iRemove)
1161                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1162                             <span class="keyword">else</span>
1163                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1164                             <span class="keyword">end</span>
1165                         <span class="keyword">elseif</span> LocalBumplist(loop,2) == 1
1166                             <span class="comment">% Upstream bump</span>
1167                             [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1)-1 11;],FB.OCSx.BPM.DeviceList);
1168                             <span class="keyword">if</span> isempty(iRemove)
1169                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1170                             <span class="keyword">else</span>
1171                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1172                             <span class="keyword">end</span>
1173                         <span class="keyword">else</span>
1174                             <span class="comment">% Downstream bump</span>
1175                             [i, iRemove] = findrowindex([LocalBumplist(loop,1)-1 12;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1176                             <span class="keyword">if</span> isempty(iRemove)
1177                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1178                             <span class="keyword">else</span>
1179                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1180                             <span class="keyword">end</span>
1181                         <span class="keyword">end</span>
1182                     <span class="keyword">else</span>
1183                         [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1184                         <span class="keyword">if</span> isempty(iRemove)
1185                             <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1186                         <span class="keyword">else</span>
1187                             fprintf(<span class="string">'\n   BPMs missing from Sector %02d - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,1));
1188                         <span class="keyword">end</span>
1189                     <span class="keyword">end</span>
1190                     
1191                     HCMnewsp = getsp(<span class="string">'HCM'</span>, FB.HCMlist1);
1192                     VCMnewsp = getsp(<span class="string">'VCM'</span>, FB.VCMlist1);
1193                     <span class="comment">% Remove center chicane trim from corrector check</span>
1194                     <span class="keyword">if</span> (max(abs(HCMoldsp(iNotHCMChicane)-HCMnewsp(iNotHCMChicane))) &gt; 5) || (max(abs(VCMoldsp(iNotVCMChicane)-VCMnewsp(iNotVCMChicane))) &gt; 10)
1195                         error(<span class="string">'**Setbumps caused some corrector magnet currents to change by more than 5(Horiz)/10(Vert) A!'</span>);
1196                     <span class="keyword">end</span>
1197                     <span class="comment">% Now check center chicane trims</span>
1198                     <span class="keyword">if</span> (max(abs(HCMoldsp(iNotHCMChicane)-HCMnewsp(iNotHCMChicane))) &gt; 10) || (max(abs(VCMoldsp(iNotVCMChicane)-VCMnewsp(iNotVCMChicane))) &gt; 15)
1199                         error(<span class="string">'**Setbumps caused some chicane trim magnet currents to change by more than 10(Horiz)/15(Vert) A!'</span>);
1200                     <span class="keyword">end</span>
1201                 <span class="keyword">end</span>
1202             <span class="keyword">end</span>
1203 
1204             <span class="comment">%restore corrector speeds</span>
1205             setpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>, HCMramprate, [], 0);
1206             setpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>, VCMramprate, [], 0);
1207 
1208         <span class="keyword">catch</span>
1209             fprintf(<span class="string">'   %s \n'</span>,lasterr);
1210             fprintf(<span class="string">'   Setbumps failed due to error condition!  Fix the problem, reload the lattice (srload), and try again.\n\n'</span>);
1211             setpv(<span class="string">'SR_STATE'</span>,-4);
1212             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1213             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1214             <span class="keyword">if</span> StateNumber &gt;= 0
1215                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1216             <span class="keyword">else</span>
1217                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1218             <span class="keyword">end</span>
1219             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1220             <span class="keyword">return</span>
1221         <span class="keyword">end</span>
1222 
1223 
1224         <span class="comment">% Turn feed forward back to it's original state</span>
1225         <span class="keyword">if</span> any(FFEnableBC)
1226             fprintf(<span class="string">'   Turning feed forward back on.\n'</span>);
1227             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], FFEnableBC);
1228         <span class="keyword">end</span>
1229 
1230 
1231         a = clock;
1232         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1233         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1234         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1235         <span class="keyword">if</span> StateNumber &gt;= 0
1236             setpv(<span class="string">'SR_STATE'</span>,4.1);
1237             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1238             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1239             fprintf(<span class="string">'   *********************************\n'</span>);
1240             fprintf(<span class="string">'   **  Orbit Correction Complete  **\n'</span>);
1241             fprintf(<span class="string">'   *********************************\n\n'</span>);
1242         <span class="keyword">else</span>
1243             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1244             fprintf(<span class="string">'   *************************************\n'</span>);
1245             fprintf(<span class="string">'   **  Problem With Orbit Correction  **\n'</span>);
1246             fprintf(<span class="string">'   *************************************\n\n'</span>);
1247         <span class="keyword">end</span>
1248         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1249         pause(0);
1250 
1251 
1252     <span class="keyword">case</span> <span class="string">'OrbitCorrectionSetup'</span>
1253         InitFlag = Input2;           <span class="comment">% Input #2: if InitFlag, then initialize variables</span>
1254 
1255         <span class="keyword">if</span> InitFlag
1256             <span class="comment">% Setup feedback elements</span>
1257             <span class="comment">% disp('Orbit correction condition: InitFlag=1 -- debugging message');</span>
1258 
1259             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1260             <span class="comment">% Edit the following lists to change default configuration of Orbit Correction %</span>
1261             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1262             hlist=[];vlist=[];
1263             <span class="keyword">for</span> Sector =1:12
1264                 <span class="keyword">if</span> Sector == 1
1265                     vlist = [vlist;Sector 2;Sector 4;Sector 5;Sector 8];
1266                     hlist = [hlist;Sector 2;Sector 7];
1267                 <span class="keyword">elseif</span> Sector == 3
1268                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];
1269                     hlist = [hlist;Sector 2;Sector 7;Sector 10];
1270                 <span class="keyword">elseif</span> Sector == 5
1271                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];
1272                     hlist = [hlist;Sector 2;Sector 7;Sector 10];
1273                 <span class="keyword">elseif</span> Sector == 10
1274                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];
1275                     hlist = [hlist;Sector 2;Sector 7;Sector 10];
1276                 <span class="keyword">elseif</span> Sector == 12
1277                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 7];
1278                     hlist = [hlist;Sector 2;Sector 7];
1279                 <span class="keyword">else</span>
1280                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8];
1281                     hlist = [hlist;Sector 2;Sector 7];
1282                 <span class="keyword">end</span>
1283             <span class="keyword">end</span>
1284             HCMlist1 = hlist;
1285             VCMlist1 = vlist;
1286 
1287             BPMlist1 = [
1288                 1 2
1289                 1 5
1290                 1 6
1291                 1 10
1292                 2 1
1293                 2 5
1294                 2 6
1295                 2 9
1296                 3 2
1297                 3 5
1298                 3 6
1299                 3 10
1300                 3 11
1301                 3 12
1302                 4 1
1303                 4 5
1304                 4 6
1305                 4 10
1306                 5 1
1307                 5 5
1308                 5 6
1309                 5 10
1310                 5 11
1311                 5 12
1312                 6 1
1313                 6 5
1314                 6 6
1315                 6 10
1316                 7 1
1317                 7 5
1318                 7 6
1319                 7 10
1320                 8 1
1321                 8 5
1322                 8 6
1323                 8 10
1324                 9 1
1325                 9 5
1326                 9 6
1327                 9 10
1328                 10 1
1329                 10 5
1330                 10 6
1331                 10 10
1332                 10 11
1333                 10 12
1334                 11 1
1335                 11 5
1336                 11 6
1337                 11 10
1338                 12 1
1339                 12 5
1340                 12 6
1341                 12 9];
1342 
1343             <span class="comment">% SVD orbit correction</span>
1344             Xivec = [1:28];
1345             Yivec = [1:48];
1346 
1347 
1348             LocalBumplist = [
1349               <span class="comment">% 1 1</span>
1350               <span class="comment">% 2 1</span>
1351               <span class="comment">% 3 1</span>
1352                 4 1
1353               <span class="comment">% 4 2</span>
1354                 5 1
1355                 6 1
1356               <span class="comment">% 6 2</span>
1357                 7 1
1358                 8 1
1359                 9 1
1360                 10 1
1361                 11 1
1362                 11 2
1363                 12 1
1364 ];
1365             <span class="comment">%LocalBumplist = []</span>
1366             
1367             <span class="comment">% initialize RFCorrFlag</span>
1368             RFCorrFlag = <span class="string">'Yes'</span>;
1369         <span class="keyword">else</span>
1370 
1371             <span class="comment">% Get vectors</span>
1372             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>);
1373             BPMlist1 = FB.BPMlist1;
1374             HCMlist1 = FB.HCMlist1;
1375             VCMlist1 = FB.VCMlist1;
1376             Xivec = FB.Xivec;
1377             Yivec = FB.Yivec;
1378             LocalBumplist = FB.LocalBumplist;
1379             Xgoal = FB.Xgoal;
1380             Ygoal = FB.Ygoal;
1381             RFCorrFlag = FB.RFCorrFlag;
1382 
1383             <span class="comment">% Add button to change #ivectors, CMs, IDBPMs,</span>
1384             EditFlag = 0;
1385             h_fig1 = figure;
1386             <span class="keyword">while</span> EditFlag ~= 8
1387 
1388                 <span class="comment">% Sensitivity matrix</span>
1389                 Sx = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
1390                 Sy = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
1391                 
1392                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1393                 <span class="comment">% Can the call below work for setting FOFB RF parameter? %</span>
1394                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1395                 <span class="keyword">if</span> strcmpi(RFCorrFlag, <span class="string">'Yes'</span>)
1396                     Sx = [Sx getdisp(<span class="string">'BPMx'</span>,BPMlist1)];
1397                 <span class="keyword">end</span>
1398                 
1399                 [Ux, SVx, Vx] = svd(Sx);
1400                 [Uy, SVy, Vy] = svd(Sy);
1401 
1402 
1403                 <span class="comment">% Remove singular values greater than the actual number of singular values</span>
1404                 i = find(Xivec&gt;length(diag(SVx)));
1405                 <span class="keyword">if</span> ~isempty(i)
1406                     disp(<span class="string">'   Horizontal E-vector scaled since there were more elements in the vector than singular values.'</span>);
1407                     pause(0);
1408                     Xivec(i) = [];
1409                 <span class="keyword">end</span>
1410                 i = find(Yivec&gt;length(diag(SVy)));
1411                 <span class="keyword">if</span> ~isempty(i)
1412                     disp(<span class="string">'   Vertical E-vector scaled since there were more elements in the vector than singular values.'</span>);
1413                     pause(0);
1414                     Yivec(i) = [];
1415                 <span class="keyword">end</span>
1416 
1417 
1418                 Ax = Sx*Vx(:,Xivec);
1419                 Tx = inv(Ax'*Ax)*Ax';
1420 
1421                 Ay = Sy*Vy(:,Yivec);
1422                 Ty = inv(Ay'*Ay)*Ay';
1423 
1424 
1425                 figure(h_fig1);
1426                 subplot(2,1,1);
1427                 semilogy(diag(SVx),<span class="string">'b'</span>);
1428                 hold on;
1429                 semilogy(diag(SVx(Xivec,Xivec)),<span class="string">'xr'</span>);
1430                 ylabel(<span class="string">'Horizontal'</span>);
1431                 title(<span class="string">'Response Matrix Singular Values'</span>);
1432                 hold off;
1433                 subplot(2,1,2);
1434                 semilogy(diag(SVy),<span class="string">'b'</span>);
1435                 hold on;
1436                 semilogy(diag(SVy(Yivec,Yivec)),<span class="string">'xr'</span>);
1437                 xlabel(<span class="string">'Singular Value Number'</span>);
1438                 ylabel(<span class="string">'Vertical'</span>);
1439                 hold off;
1440                 drawnow;
1441 
1442                 <span class="keyword">if</span> strcmp(RFCorrFlag,<span class="string">'No'</span>)
1443                     RFCorrState = <span class="string">'NOT CORRECTED'</span>;
1444                 <span class="keyword">elseif</span> strcmp(RFCorrFlag,<span class="string">'Yes'</span>)
1445                     RFCorrState = <span class="string">'CORRECTED'</span>;
1446                 <span class="keyword">else</span>
1447                     RFCorrState = <span class="string">'???'</span>;
1448                 <span class="keyword">end</span>
1449 
1450                 <span class="comment">%         EditFlag = menu('Change Parameters?','Singular Values','HCM List','VCM List','HCM Chicane List','VCM Chicane List','IDBPM List','BBPM List','Change Golden Orbit',...</span>
1451                 <span class="comment">%            'Local Bump List',sprintf('RF Frequency (currently %s)',RFCorrState),'Continue');</span>
1452                 EditFlag = menu(<span class="string">'Change Parameters?'</span>,<span class="string">'Singular Values'</span>,<span class="string">'HCM List'</span>,<span class="string">'VCM List'</span>,<span class="string">'BPM List'</span>,<span class="string">'Change Golden Orbit'</span>,<span class="keyword">...</span>
1453                     <span class="string">'Local Bump List'</span>,sprintf(<span class="string">'RF Frequency (currently %s)'</span>,RFCorrState),<span class="string">'Continue'</span>);
1454 
1455                 <span class="keyword">if</span> EditFlag == 1
1456                     prompt={<span class="string">'Enter the horizontal E-vector numbers (Matlab vector format):'</span>,<span class="string">'Enter the vertical E-vector numbers (Matlab vector format):'</span>};
1457                     def={sprintf(<span class="string">'[%d:%d]'</span>,1,Xivec(end)),sprintf(<span class="string">'[%d:%d]'</span>,1,Yivec(end))};
1458                     titlestr=<span class="string">'SVD Orbit Feedback'</span>;
1459                     lineNo=1;
1460                     answer=inputdlg(prompt,titlestr,lineNo,def);
1461                     <span class="keyword">if</span> ~isempty(answer)
1462                         XivecNew = fix(str2num(answer{1}));
1463                         <span class="keyword">if</span> isempty(XivecNew)
1464                             disp(<span class="string">'   Horizontal E-vector cannot be empty.  No change made.'</span>);
1465                         <span class="keyword">else</span>
1466                             <span class="keyword">if</span> any(XivecNew&lt;=0) || max(XivecNew)&gt;length(diag(SVx))
1467                                 disp(<span class="string">'   Error reading horizontal E-vector.  No change made.'</span>);
1468                             <span class="keyword">else</span>
1469                                 Xivec = XivecNew;
1470                             <span class="keyword">end</span>
1471                         <span class="keyword">end</span>
1472                         YivecNew = fix(str2num(answer{2}));
1473                         <span class="keyword">if</span> isempty(YivecNew)
1474                             disp(<span class="string">'   Vertical E-vector cannot be empty.  No change made.'</span>);
1475                         <span class="keyword">else</span>
1476                             <span class="keyword">if</span> any(YivecNew&lt;=0) || max(YivecNew)&gt;length(diag(SVy))
1477                                 disp(<span class="string">'   Error reading vertical E-vector.  No change made.'</span>);
1478                             <span class="keyword">else</span>
1479                                 Yivec = YivecNew;
1480                             <span class="keyword">end</span>
1481                         <span class="keyword">end</span>
1482                     <span class="keyword">end</span>
1483                 <span class="keyword">end</span>
1484 
1485                 <span class="keyword">if</span> EditFlag == 2
1486                     List = getlist(<span class="string">'HCM'</span>);
1487                     CheckList = zeros(size(List,1));
1488                     Elem = dev2elem(<span class="string">'HCM'</span>, HCMlist1);
1489                     CheckList(Elem) = ones(size(Elem));
1490                     CheckList = CheckList(dev2elem(<span class="string">'HCM'</span>,List));
1491                     newList = editlist(List, <span class="string">'HCM'</span>, CheckList);
1492                     <span class="keyword">if</span> isempty(newList)
1493                         fprintf(<span class="string">'   Horizontal corrector magnet list cannot be empty.  No change made.\n'</span>);
1494                     <span class="keyword">else</span>
1495                         HCMlist1 = newList;
1496                     <span class="keyword">end</span>
1497                 <span class="keyword">end</span>
1498 
1499                 <span class="keyword">if</span> EditFlag == 3
1500                     List = getlist(<span class="string">'VCM'</span>);
1501                     CheckList = zeros(size(List,1));
1502                     Elem = dev2elem(<span class="string">'VCM'</span>, VCMlist1);
1503                     CheckList(Elem) = ones(size(Elem));
1504                     CheckList = CheckList(dev2elem(<span class="string">'VCM'</span>,List));
1505                     newList = editlist(List, <span class="string">'VCM'</span>, CheckList);
1506                     <span class="keyword">if</span> isempty(newList)
1507                         fprintf(<span class="string">'   Vertical corrector magnet cannot be empty.  No change made.\n'</span>);
1508                     <span class="keyword">else</span>
1509                         VCMlist1 = newList;
1510                     <span class="keyword">end</span>
1511                 <span class="keyword">end</span>
1512 
1513                 <span class="keyword">if</span> EditFlag == 4
1514                     ListOld = BPMlist1;
1515                     XgoalOld = Xgoal;
1516                     YgoalOld = Ygoal;
1517 
1518                     <span class="comment">% Full BPM list</span>
1519                     List = [
1520                         1 2
1521                         1 5
1522                         1 6
1523                         1 10
1524                         2 1
1525                         2 5
1526                         2 6
1527                         2 9
1528                         3 2
1529                         3 5
1530                         3 6
1531                         3 10
1532                         3 11
1533                         3 12
1534                         4 1
1535                         4 5
1536                         4 6
1537                         4 10
1538                         5 1
1539                         5 5
1540                         5 6
1541                         5 10
1542                         5 11
1543                         5 12
1544                         6 1
1545                         6 5
1546                         6 6
1547                         6 10
1548                         7 1
1549                         7 5
1550                         7 6
1551                         7 10
1552                         8 1
1553                         8 5
1554                         8 6
1555                         8 10
1556                         9 1
1557                         9 5
1558                         9 6
1559                         9 10
1560                         10 1
1561                         10 5
1562                         10 6
1563                         10 10
1564                         10 11
1565                         10 12
1566                         11 1
1567                         11 5
1568                         11 6
1569                         11 10
1570                         12 1
1571                         12 5
1572                         12 6
1573                         12 9
1574                         ];
1575 
1576                     CheckList = zeros(size(List,1),1);
1577                     <span class="keyword">if</span> ~isempty(BPMlist1)
1578                         <span class="keyword">for</span> i = 1:size(List,1)
1579                             k = find(List(i,1)==BPMlist1(:,1));
1580                             l = find(List(i,2)==BPMlist1(k,2));
1581 
1582                             <span class="keyword">if</span> isempty(k) || isempty(l)
1583                                 <span class="comment">% Item not in list</span>
1584                             <span class="keyword">else</span>
1585                                 CheckList(i) = 1;
1586                             <span class="keyword">end</span>
1587                         <span class="keyword">end</span>
1588                     <span class="keyword">end</span>
1589 
1590                     newList = editlist(List, <span class="string">'BPM'</span>, CheckList);
1591                     <span class="keyword">if</span> isempty(newList)
1592                         fprintf(<span class="string">'   BPM list cannot be empty.  No change made.\n'</span>);
1593                     <span class="keyword">else</span>
1594                         BPMlist1 = newList;
1595                     <span class="keyword">end</span>
1596 
1597                     <span class="comment">% Set the goal orbit to the golden orbit</span>
1598                     Xgoal = getgolden(<span class="string">'BPMx'</span>, BPMlist1);
1599                     Ygoal = getgolden(<span class="string">'BPMy'</span>, BPMlist1);
1600 
1601 
1602                     <span class="comment">% If a new BPM is added, then set the goal orbit to the golden orbit</span>
1603                     <span class="keyword">for</span> i = 1:size(BPMlist1,1)
1604 
1605                         <span class="comment">% Is it a new BPM?</span>
1606                         k = find(BPMlist1(i,1)==ListOld(:,1));
1607                         l = find(BPMlist1(i,2)==ListOld(k,2));
1608 
1609                         <span class="keyword">if</span> isempty(k) || isempty(l)
1610                             <span class="comment">% New BPM</span>
1611                         <span class="keyword">else</span>
1612                             <span class="comment">% Use the old value for old BPM</span>
1613                             Xgoal(i) = XgoalOld(k(l));
1614                             Ygoal(i) = YgoalOld(k(l));
1615                         <span class="keyword">end</span>
1616                     <span class="keyword">end</span>
1617                 <span class="keyword">end</span>
1618 
1619                 <span class="keyword">if</span> EditFlag == 5
1620 
1621                     ChangeList = editlist(BPMlist1, <span class="string">'Change BPM'</span>, zeros(size(BPMlist1,1),1));
1622                     <span class="keyword">for</span> i = 1:size(ChangeList,1)
1623 
1624                         k = find(ChangeList(i,1)==BPMlist1(:,1));
1625                         l = find(ChangeList(i,2)==BPMlist1(k,2));
1626 
1627                         prompt = {sprintf(<span class="string">'Enter the new horizontal goal orbit for BPMx(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2)),sprintf(<span class="string">'Enter the new vertical goal orbit for BPMy(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2))};
1628                         def = {sprintf(<span class="string">'%f'</span>,Xgoal(k(l))),sprintf(<span class="string">'%f'</span>,Ygoal(k(l)))};
1629                         titlestr = <span class="string">'CHANGE THE GOAL ORBIT'</span>;
1630                         lineNo = 1;
1631                         answer = inputdlg(prompt, titlestr, lineNo, def);
1632 
1633                         <span class="keyword">if</span> isempty(answer)
1634                             <span class="comment">% No change</span>
1635                             fprintf(<span class="string">'   No change was made to the golden orbit.\n'</span>);
1636                         <span class="keyword">else</span>
1637                             Xgoalnew = str2num(answer{1});
1638                             <span class="keyword">if</span> isempty(Xgoalnew)
1639                                 fprintf(<span class="string">'   No change was made to the horizontal golden orbit.\n'</span>);
1640                             <span class="keyword">else</span>
1641                                 Xgoal(k(l)) = Xgoalnew;
1642                             <span class="keyword">end</span>
1643 
1644                             Ygoalnew = str2num(answer{2});
1645                             <span class="keyword">if</span> isempty(Ygoalnew)
1646                                 fprintf(<span class="string">'   No change was made to the vertical golden orbit.\n'</span>);
1647                             <span class="keyword">else</span>
1648                                 Ygoal(k(l)) = Ygoalnew;
1649                             <span class="keyword">end</span>
1650                         <span class="keyword">end</span>
1651                     <span class="keyword">end</span>
1652                     <span class="keyword">if</span> ~isempty(ChangeList)
1653                         fprintf(<span class="string">'   Note:  changing the goal orbit for &quot;Orbit Correction&quot; does not change the goal orbit for &quot;Slow Orbit Feedback.&quot;\n'</span>);
1654                         fprintf(<span class="string">'          Re-running srcontrol will restart the goal orbit to the golden orbit.&quot;\n'</span>);
1655                     <span class="keyword">end</span>
1656                 <span class="keyword">end</span>
1657 
1658                 <span class="keyword">if</span> EditFlag == 6
1659                     List = [
1660                         1 1
1661                         2 1
1662                         3 1
1663                         4 1
1664                         4 2
1665                         5 1
1666                         6 1
1667                         6 2
1668                         7 1
1669                         8 1
1670                         9 1
1671                         10 1
1672                         11 1
1673                         11 2
1674                         12 1];
1675                     CheckList = zeros(size(List,1),1);
1676                     <span class="keyword">if</span> ~isempty(LocalBumplist)
1677                         <span class="keyword">for</span> i = 1:size(List,1)
1678                             k = find(List(i,1)==LocalBumplist(:,1));
1679                             l = find(List(i,2)==LocalBumplist(k,2));
1680 
1681                             <span class="keyword">if</span> isempty(k) | isempty(l)
1682                                 <span class="comment">% Item not in list</span>
1683                             <span class="keyword">else</span>
1684                                 CheckList(i) = 1;
1685                             <span class="keyword">end</span>
1686                         <span class="keyword">end</span>
1687                     <span class="keyword">end</span>
1688                     LocalBumplist = editlist2(List, <span class="string">'Sector'</span>, CheckList);
1689                 <span class="keyword">end</span>
1690 
1691                 <span class="keyword">if</span> EditFlag == 7
1692                     RFCorrFlag = questdlg(sprintf(<span class="string">'Set RF Frequency during Orbit Correction?'</span>),<span class="string">'RF Frequency'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>, <span class="string">'No'</span>);
1693                     <span class="keyword">if</span> strcmp(RFCorrFlag,<span class="string">'No'</span>)
1694                         disp([<span class="string">'   RF Frequency will not be included in global orbit correction.'</span>]);
1695                     <span class="keyword">elseif</span> strcmp(RFCorrFlag,<span class="string">'Yes'</span>)
1696                         disp([<span class="string">'   RF Frequency will be included in global orbit correction.'</span>]);
1697                     <span class="keyword">end</span>
1698 
1699                 <span class="keyword">end</span>
1700             <span class="keyword">end</span>
1701             close(h_fig1);
1702         <span class="keyword">end</span>
1703         
1704 <span class="comment">%  ORBIT CORRECTION STRUCTURE (OCS)</span>
1705 <span class="comment">%    OCS.BPM (data structure)</span>
1706 <span class="comment">%    OCS.CM  (data structure)</span>
1707 <span class="comment">%    OCS.GoalOrbit</span>
1708 <span class="comment">%    OCS.NIter</span>
1709 <span class="comment">%    OCS.SVDIndex</span>
1710 <span class="comment">%    OCS.IncrementalFlag = 'Yes'/'No'</span>
1711 <span class="comment">%    OCS.BPMWeight</span>
1712 <span class="comment">%    OCS.Flags = { 'FitRF' , etc.  }</span>
1713         OCSx.BPM = getx(BPMlist1, <span class="string">'struct'</span>);
1714         OCSx.CM = getsp(<span class="string">'HCM'</span>, HCMlist1, <span class="string">'struct'</span>);
1715         OCSx.GoalOrbit = getgolden(OCSx.BPM, <span class="string">'numeric'</span>);
1716         OCSx.NIter = 1;
1717         OCSx.SVDIndex = Xivec;
1718         OCSx.IncrementalFlag = <span class="string">'No'</span>;
1719         OCSx.FitRF = 1;
1720         OCSy.BPM = gety(BPMlist1, <span class="string">'struct'</span>);
1721         OCSy.CM = getsp(<span class="string">'VCM'</span>, VCMlist1, <span class="string">'struct'</span>);
1722         OCSy.GoalOrbit = getgolden(OCSy.BPM, <span class="string">'numeric'</span>);
1723         OCSy.NIter = 1;
1724         OCSy.SVDIndex = Yivec;
1725         OCSy.IncrementalFlag = <span class="string">'No'</span>;
1726         OCSy.FitRF = 0;
1727 
1728         <span class="comment">% Save vectors</span>
1729         FB.OCSx = OCSx;
1730         FB.OCSy = OCSy;
1731 
1732         FB.BPMlist1 = BPMlist1;
1733         FB.HCMlist1 = HCMlist1;
1734         FB.VCMlist1 = VCMlist1;
1735         FB.Xivec = Xivec;
1736         FB.Yivec = Yivec;
1737         FB.Xgoal = OCSx.GoalOrbit;
1738         FB.Ygoal = OCSy.GoalOrbit;
1739         FB.RFCorrFlag = RFCorrFlag;
1740         FB.LocalBumplist = LocalBumplist;
1741         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>,FB);
1742         
1743         
1744     <span class="keyword">case</span> <span class="string">'Feedback'</span>
1745 
1746         FBloopIter = 1;
1747         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxFOFB'</span>),<span class="string">'Value'</span>) == 1
1748             StartFOFBFlag = 1;
1749         <span class="keyword">else</span>
1750             StartFOFBFlag = 0;
1751         <span class="keyword">end</span>
1752 
1753         FEEDBACK_STOP_FLAG = 0;
1754         HWarnNum=0;
1755         VWarnNum=0;
1756 
1757         SR_GeV = getenergy;
1758         <span class="comment">% Feedback loop setup</span>
1759         PlotInfoFlag = 0;           <span class="comment">% Plot micado stuff</span>
1760         LoopDelay = 2;           <span class="comment">% Period of feedback loop [seconds], make sure the BPM averaging is correct</span>
1761         VCM_LSB = .00366211;
1762         VCMCHICANE_LSB = .002441;   <span class="comment">% 80 max?,  Note: not fully implemented</span>
1763 
1764         <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
1765             Xgain  = 0.2;
1766             Ygain  = 0.1;
1767         <span class="keyword">else</span>
1768             Xgain  = 0.8; <span class="comment">% raised 0.5-&gt;0.8 at 17:20, 3-2-05 to more quickly correct EPU4 fast switching orbit distortions</span>
1769             Ygain  = 0.8;
1770         <span class="keyword">end</span>
1771 
1772         <span class="comment">% Load lattice set for tune feed forward</span>
1773         ConfigSetpoint = getproductionlattice;
1774         <span class="comment">%load([getfamilydata('Directory','OpsData') getfamilydata('OpsData','LatticeFile')]);</span>
1775         QFsp = ConfigSetpoint.QF.Setpoint.Data;
1776         QDsp = ConfigSetpoint.QD.Setpoint.Data;
1777         TuneW16Min = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(5, 13.23, 1.8909);
1778         <span class="comment">% Tune response matrix</span>
1779         SR_TUNE_MATRIX = gettuneresp({<span class="string">'QF'</span>,<span class="string">'QD'</span>}, {[],[]}, getenergy(<span class="string">'Production'</span>));    <span class="comment">% Approx. [0.1944 -0.0286;-0.1182 0.1526];</span>
1780         <span class="comment">%SR_TUNE_MATRIX = [0.1641 -0.0245</span>
1781         <span class="comment">%                 -0.1149 0.1477];</span>
1782 
1783         <span class="comment">% ID tune compensation does not work in the injection lattice, so ...</span>
1784         <span class="keyword">if</span> abs(SR_GEV - <a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>)&gt;  0.05     <span class="comment">% Don't use this routine for the injection lattice</span>
1785             fprintf(<span class="string">'   This routine should only be used for the production energy: Orbit feedback aborted\n'</span>);
1786             <span class="keyword">return</span>
1787         <span class="keyword">end</span>
1788 
1789         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1790 
1791         <span class="keyword">try</span>
1792             fprintf(<span class="string">'\n'</span>);
1793             fprintf(<span class="string">'   *******************************\n'</span>);
1794             fprintf(<span class="string">'   **  Starting Orbit Feedback  **\n'</span>);
1795             fprintf(<span class="string">'   *******************************\n'</span>);
1796             a = clock;
1797             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1798             fprintf(<span class="string">'   Note: the Matlab command window will be used to display status information.\n'</span>);
1799             fprintf(<span class="string">'         It cannot be used to enter commands during slow orbit feedback.\n'</span>);
1800 
1801 
1802             <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
1803             disp(<span class="string">'   IDBPM time constant set to 0.2s.'</span>)
1804             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.2)
1805             pause(1.1);
1806 
1807             <span class="comment">% Check whether bumps and kickers are on and warn to turn off before starting feedback if necessary</span>
1808             <span class="keyword">try</span>
1809                 <span class="keyword">if</span> (getsp(<span class="string">'SR01S___BUMP1__BC21'</span>)==1 &amp;&amp; getsp(<span class="string">'SR01S___BUMP1P_BC22'</span>)==1) || (getsp(<span class="string">'SR01S___SEK____BC21'</span>)==1 &amp;&amp; getsp(<span class="string">'SR01S___SEK_P__BC23'</span>)==1) || (getsp(<span class="string">'SR01S___SEN____BC20'</span>)==1 &amp;&amp; getsp(<span class="string">'SR01S___SEN_P__BC22'</span>)==1)
1810                     soundtada;
1811                     fprintf(<span class="string">'   \n'</span>);
1812                     fprintf(<span class="string">'   *********************************************************************************\n'</span>);
1813                     fprintf(<span class="string">'   ** One or more of the pulsed SR injection magnets is still on!  Turn them off! **\n'</span>);
1814                     fprintf(<span class="string">'   *********************************************************************************\n'</span>);
1815                     fprintf(<span class="string">'   \n'</span>);
1816                 <span class="keyword">end</span>
1817             <span class="keyword">catch</span>
1818                 disp(<span class="string">'**Problem checking the state of the bumps and kickers - please check that they are not pulsing.'</span>);
1819             <span class="keyword">end</span>
1820 
1821             <span class="comment">% Get vectors</span>
1822 
1823             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
1824 
1825             BPMlist1 = FB.OCSx.BPM.DeviceList;
1826             <span class="comment">% FOFB_BPMlist =</span>
1827             HCMlist1 = FB.HCMlist1;
1828             VCMlist1 = FB.VCMlist1;
1829             Xivec = FB.Xivec;
1830             Yivec = FB.Yivec;
1831             Xgoal = FB.OCSx.GoalOrbit;
1832             Ygoal = FB.OCSy.GoalOrbit;
1833             FFTypeFlag = FB.FFTypeFlag;   <span class="comment">%local or global tune correction</span>
1834 
1835             iNotHCMChicane = find(HCMlist1(:,2) &lt; 10); <span class="comment">%used by steppv's for setting correctors in loop</span>
1836             iHCMChicane = find(HCMlist1(:,2) == 10);
1837             iNotVCMChicane = find(VCMlist1(:,2) &lt; 10);
1838             iVCMChicane = find(VCMlist1(:,2) == 10);
1839 
1840             <span class="comment">% Sensitivity matrix for setting fast feedback setpoints</span>
1841             Sx1 = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
1842             Sy1 = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
1843 
1844         <span class="keyword">catch</span>
1845             fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
1846 
1847             <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
1848             disp(<span class="string">'   IDBPM time constant set to 0.25s.'</span>)
1849             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.25)
1850 
1851 
1852             a = clock;
1853             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1854             fprintf(<span class="string">'   *************************************************************\n'</span>);
1855             fprintf(<span class="string">'   **  Orbit feedback could not start due to error condition  **\n'</span>);
1856             fprintf(<span class="string">'   *************************************************************\n\n'</span>);
1857             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1858             pause(0);
1859 
1860             <span class="keyword">return</span>
1861         <span class="keyword">end</span>
1862 
1863         StartFlag = questdlg(strvcat(<span class="string">''</span>,<span class="string">'Is it OK to start orbit feedback?'</span>),<span class="string">'Orbit Feedback'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
1864         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
1865             <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
1866             disp(<span class="string">'   IDBPM time constant set to 0.25s.'</span>)
1867             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.25)
1868 
1869             a = clock;
1870             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1871             fprintf(<span class="string">'   ***************************\n'</span>);
1872             fprintf(<span class="string">'   **  Orbit Feedback Exit  **\n'</span>);
1873             fprintf(<span class="string">'   ***************************\n\n'</span>);
1874             pause(0);
1875             <span class="keyword">return</span>
1876         <span class="keyword">end</span>
1877 
1878         SR_STATE_OLD = scaget(<span class="string">'SR_STATE'</span>);
1879         setpv(<span class="string">'SR_STATE'</span>, 5);
1880         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1881         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1882         <span class="keyword">if</span> StateNumber &gt;= 0
1883             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1884         <span class="keyword">else</span>
1885             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1886         <span class="keyword">end</span>
1887         fprintf(<span class="string">'   Using %d E-vectors horizontally.\n'</span>, length(Xivec));
1888         fprintf(<span class="string">'   Using %d E-vectors vertically.\n'</span>,   length(Yivec));
1889         fprintf(<span class="string">'   Starting slow orbit correction every %.1f seconds.\n'</span>, LoopDelay);
1890         <span class="comment">%  fprintf('   Resetting SR11 chicane motors every 20 seconds to fix drift problem.\n');</span>
1891 
1892 
1893         <span class="keyword">try</span>
1894 
1895             <span class="comment">% Get and display data</span>
1896             x = FB.OCSx.GoalOrbit - getx(FB.OCSx.BPM.DeviceList);
1897             y = FB.OCSy.GoalOrbit - gety(FB.OCSy.BPM.DeviceList);
1898             STDx = norm(x)/sqrt(length(x));
1899             STDy = norm(y)/sqrt(length(y));
1900             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = %.4f mm'</span>,STDx),<span class="string">'ForegroundColor'</span>,[0 0 0]);
1901             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = %.4f mm'</span>,STDy),<span class="string">'ForegroundColor'</span>,[0 0 0]);
1902 
1903             <span class="comment">% write goldenorbit values to Fast Orbit Feedback</span>
1904             <span class="keyword">try</span>
1905                 <a href="write_goldenorbit_ffb.html" class="code" title="function write_goldenorbit_ffb">write_goldenorbit_ffb</a>;
1906             <span class="keyword">catch</span>
1907                 disp(<span class="string">'write_goldenorbit_ffb did not work!'</span>);
1908             <span class="keyword">end</span>
1909             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
1910             pause(0);
1911 
1912         <span class="keyword">catch</span>
1913 
1914             fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
1915 
1916             <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
1917             disp(<span class="string">'   IDBPM time constant set to 0.25s.'</span>)
1918             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.25);
1919 
1920 
1921             a = clock;
1922             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1923             fprintf(<span class="string">'   *************************************************************\n'</span>);
1924             fprintf(<span class="string">'   **  Orbit feedback could not start due to error condition  **\n'</span>);
1925             fprintf(<span class="string">'   *************************************************************\n\n'</span>);
1926 
1927             setpv(<span class="string">'SR_STATE'</span>,SR_STATE_OLD);
1928             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1929             <span class="keyword">if</span> StateNumber &gt;= 0
1930                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1931             <span class="keyword">else</span>
1932                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1933             <span class="keyword">end</span>
1934             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1935             pause(0);
1936 
1937             <span class="keyword">return</span>
1938 
1939         <span class="keyword">end</span>
1940 
1941 
1942         <span class="comment">% Disable buttons</span>
1943         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1944         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1945         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1946         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1947         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1948         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1949         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1950         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1951         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1952         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1953         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1954         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1955         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1956         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1957         pause(0);
1958 
1959 
1960         <span class="comment">% Initialize feedback loop</span>
1961         StartTime = gettime;
1962         StartErrorTime = gettime;
1963         Xold = getx(FB.OCSx.BPM.DeviceList);
1964         Yold = gety(FB.OCSy.BPM.DeviceList);
1965         HQMOFM_stalenum = 0;
1966         pause(LoopDelay);
1967 
1968         N_HCM = size(HCMlist1,1);
1969         N_VCM = size(VCMlist1,1);
1970 
1971         N_RFMO = 1;
1972         
1973         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
1974             [FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,<span class="string">'SetRF'</span>,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1975         <span class="keyword">else</span>
1976             [FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1977         <span class="keyword">end</span>
1978         [FB.OCSx, Smatx, Sx, Ux, Vx] = orbitcorrectionmethods(FB.OCSx);
1979             
1980         [FB.OCSy, junk, OCSy0] = setorbit(FB.OCSy,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1981         [FB.OCSy, Smaty, Sy, Uy, Vy] = orbitcorrectionmethods(FB.OCSy);
1982 
1983      
1984         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
1985         <span class="comment">% Start feedback loop %</span>
1986         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
1987 
1988         <span class="comment">% chicaneloop=1;  % loop variable for resetting drifting chicanes (see a few lines below)</span>
1989         <span class="comment">% fftest=figure;</span>
1990 
1991         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2); <span class="comment">% put FOFB in open loop so beamnoise gets recorded even if FOFB is not enabled</span>
1992 
1993         <span class="keyword">while</span> 1
1994             <span class="keyword">try</span>
1995                 t00 = gettime;
1996 
1997                 <span class="comment">%          if chicaneloop==20 % reset SR11 motor chicane setpoints every 20s due to drifting positions</span>
1998                 <span class="comment">%             setsp('HCMCHICANEM',HCMCHICANEMsp(6),[11 1],0);</span>
1999                 <span class="comment">%             setsp('HCMCHICANEM',HCMCHICANEMsp(7),[11 2],0);</span>
2000                 <span class="comment">%             chicaneloop = 1;</span>
2001                 <span class="comment">%          else</span>
2002                 <span class="comment">%             chicaneloop = chicaneloop + 1;</span>
2003                 <span class="comment">%          end</span>
2004 
2005                 <span class="comment">% Check if GUI has been closed</span>
2006                 <span class="keyword">if</span> isempty(gcbf)
2007                     FEEDBACK_STOP_FLAG = 1;
2008                     lasterr(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2009                     error(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2010                 <span class="keyword">end</span>
2011 
2012                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2013                 <span class="comment">% Fast orbit feedback %</span>
2014                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2015                 <span class="keyword">if</span> StartFOFBFlag == 1 &amp;&amp; FBloopIter &gt; 3
2016                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2017                     pause(0.5);
2018                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,1);
2019                     StartFOFBFlag = 0;
2020                     pause(1);
2021                     
2022                     FOFBOnStatus = [ <span class="keyword">...</span>
2023                         getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2024                         getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2025                         getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2026                         getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2027                     
2028                     <span class="keyword">if</span> any(FOFBOnStatus==0) || any(FOFBOnStatus==2)
2029                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2); <span class="comment">% open FOFB loop</span>
2030                         disp(<span class="string">'************************************************************************************************************'</span>);
2031                         disp(<span class="string">'** Problem turning on Fast Orbit Feedback system...                                                       **'</span>);
2032                         disp(<span class="string">'** Check status of ffbsecXX crates - but remember that a crate reboot will turn off Quads in that sector! **'</span>);
2033                         disp(<span class="string">'** Suggest disabling the &quot;Fast Orbit Correction&quot; checkbox and starting Orbit Feedback again.              **'</span>);
2034                         disp(<span class="string">'************************************************************************************************************'</span>);
2035                     <span class="keyword">else</span>
2036                         fprintf(<span class="string">'   Starting Fast Orbit Feedback at %.0f Hz.\n'</span>, getpv(<span class="string">'SR01____FFBFREQAM00'</span>));
2037                     <span class="keyword">end</span>
2038                 <span class="keyword">end</span>
2039 
2040 
2041                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2042                 <span class="comment">% Horizontal plane &quot;feedback&quot; %</span>
2043                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2044 
2045                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxSOFB'</span>),<span class="string">'Value'</span>) == 1
2046 
2047                     <span class="comment">% Get orbit and check that the BPMs are different from the last update</span>
2048                     Xnew = getx(FB.OCSx.BPM.DeviceList);
2049 
2050                     <span class="comment">% Don't feedback if the current is too small</span>
2051                     <span class="keyword">if</span> getdcct &lt; 5
2052                         FEEDBACK_STOP_FLAG = 1;
2053                         fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2054                         <span class="keyword">break</span>;
2055                     <span class="keyword">end</span>
2056 
2057                     x = Xgoal - Xnew;
2058                     STDx = norm(x)/sqrt(length(x));
2059 
2060                     <span class="keyword">if</span> any(Xold == Xnew)
2061                         a = clock;
2062                         N_Stale_Data_Points = find((Xold==Xnew)==1);
2063                         <span class="keyword">for</span> loop = N_Stale_Data_Points'
2064                             fprintf(<span class="string">'   Stale data: BPMx(%2d,%d), feedback step skipped (%s %d:%d:%.0f). \n'</span>, FB.OCSx.BPM.DeviceList(loop,1), FB.OCSx.BPM.DeviceList(loop,2), date, a(4), a(5), a(6));
2065                         <span class="keyword">end</span>
2066                     <span class="keyword">else</span>
2067                         <span class="comment">% Compute horizontal correction</span>
2068                         <span class="comment">%%%OCSx0 = FB.OCSx;</span>
2069                         FB.OCSx.BPM.Data = Xnew;
2070                         FB.OCSx = orbitcorrectionmethods(FB.OCSx, Smatx, Sx, Ux, Vx);
2071 
2072                         <span class="comment">%%%[FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,'Nodisplay','Nosetsp');</span>
2073 
2074                         <span class="comment">% reduced feedback gain (implemented by Greg Portmann, December 2000)</span>
2075                         <span class="comment">% reduced to 0.1, C. Steier, 2001-09-04, IDBPMs are noisy at the moment</span>
2076                         <span class="comment">% increased back to 0.8 C. Steier, 2001-09-29, IDBPMs filtering + direct DAC read/write + all SVDs (no arc BPMs)</span>
2077                         <span class="comment">% increased to 1.0, C. Steier, 2002-05-04, trim DACs</span>
2078                         X = Xgain .* FB.OCSx.CM.Delta;
2079                         X(N_HCM+1) = 0.3*FB.OCSx.DeltaRF/4.988e-3;
2080                         <span class="comment">%%%X = Xgain .* (FB.OCSx.CM.Data - OCSx0.CM.Data);</span>
2081 
2082                         <span class="comment">% check for trim values+next step values, warn or stop FB as necessary</span>
2083                         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2084                         <span class="comment">% need to extract Chicanes from this comparison or maybe check them first for range %</span>
2085                         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2086                         HCMtrimSP=getpv(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1);
2087                         HCMtrimSP_next = HCMtrimSP + X(1:N_HCM);
2088                         <span class="keyword">if</span> max(abs(HCMtrimSP_next)) &gt; 4
2089                             HCMtrimnum=find(abs(HCMtrimSP_next) &gt; 4);
2090 
2091                             <span class="comment">% print message to screen</span>
2092                             fprintf(<span class="string">'**One or more of the horizontal correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2093                             fprintf(<span class="string">'%s\n'</span>,datestr(now));
2094                             <span class="keyword">for</span> loop = HCMtrimnum'
2095                                 fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1(loop,:)));
2096                             <span class="keyword">end</span>
2097 
2098                             <span class="comment">% send alphapage to operator pager</span>
2099                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2100                             FEEDBACK_STOP_FLAG = 1;
2101 
2102                             setpv(<span class="string">'SR_STATE'</span>, -5);
2103                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2104                             <span class="keyword">if</span> StateNumber &gt;= 0
2105                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2106                             <span class="keyword">else</span>
2107                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2108                             <span class="keyword">end</span>
2109                         <span class="keyword">end</span>
2110 
2111                         <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2112                             <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2113                             <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2114                                 disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2115                             <span class="keyword">end</span>
2116                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2117                             pause(0.5);
2118                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2119                             <span class="keyword">break</span>;
2120                         <span class="keyword">end</span>
2121 
2122                         <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2123                         pause(0);
2124 
2125                         <span class="keyword">if</span> max(abs(HCMtrimSP_next) &gt; 3)
2126                             HCMtrimnum = find(abs(HCMtrimSP_next) &gt; 3);
2127                             HWarnNum = HWarnNum + 1;
2128                             <span class="keyword">if</span> HWarnNum==1 || rem(HWarnNum,120)==0
2129 
2130                                 <span class="comment">% print message to screen every two minutes</span>
2131                                 fprintf(<span class="string">'**One or more of the horizontal corrector trims is above 3A or below -3A! \n'</span>);
2132                                 fprintf(<span class="string">'%s\n'</span>,datestr(now));
2133                                 <span class="keyword">for</span> loop = HCMtrimnum'
2134                                     fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1(loop,:)));
2135                                 <span class="keyword">end</span>
2136                                 fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2137 
2138                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2139                                 <span class="keyword">if</span> (HWarnNum==1 || HWarnNum==600)
2140                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageHCM.txt
2141                                 <span class="keyword">end</span>
2142                             <span class="keyword">end</span>
2143                         <span class="keyword">else</span>
2144                             HWarnNum=0;
2145                         <span class="keyword">end</span>
2146 
2147                         <span class="comment">% Don't feedback if the current is too small</span>
2148                         <span class="keyword">if</span> getdcct &lt; 5
2149                             FEEDBACK_STOP_FLAG = 1;
2150                             fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2151                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/beamisoff.txt
2152                             <span class="keyword">break</span>;
2153                         <span class="keyword">end</span>
2154 
2155                         <span class="keyword">if</span> N_HCM &gt; 0
2156                             steppv(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>, X(iNotHCMChicane), HCMlist1(iNotHCMChicane,:), 0);
2157                             steppv(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>, X(iHCMChicane), HCMlist1(iHCMChicane,:), 0);
2158                         <span class="keyword">end</span>
2159 
2160                         <span class="comment">% write fast orbit feedback setpoints</span>
2161                         <span class="keyword">if</span> 1
2162                             <span class="comment">%write_goldenorbit_ffb_2planes(1, Xnew(1:size(BPMlist1,1))+Sx1*X(1:N_HCM)+Sx3*X(length(X))/20, BPMlist1);</span>
2163                             <span class="comment">% should be corrected to include result of next frequency step ...</span>
2164                             <a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>(1,Xnew(1:size(BPMlist1,1))+Sx1*X(1:N_HCM),BPMlist1);
2165                         <span class="keyword">end</span>
2166 
2167                         <span class="comment">%fprintf('Horizontal Done: %f \n',gettime-t00);</span>
2168 
2169                         <span class="comment">% RF feedback</span>
2170                         HQMOFMsp_last = getpv(<span class="string">'EG______HQMOFM_AC01'</span>);
2171 
2172                         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
2173                             <span class="keyword">if</span> N_RFMO &gt; 0
2174                                 <span class="keyword">if</span> abs(X(end)/3) &lt; .01
2175                                 <span class="comment">% if abs(FB.OCSx.DeltaRF/3) &lt; .01</span>
2176                                     steppv(<span class="string">'EG______HQMOFM_AC01'</span>, X(end));
2177                                 <span class="keyword">else</span>
2178                                     steppv(<span class="string">'EG______HQMOFM_AC01'</span>, 0.01*sign(X(end)));
2179                                 <span class="keyword">end</span>
2180                             <span class="keyword">end</span>
2181 
2182                             HQMOFMsp_now = getpv(<span class="string">'EG______HQMOFM_AC01'</span>);
2183 
2184                             <span class="comment">% Check for stale RF feedback</span>
2185                             <span class="keyword">if</span> HQMOFMsp_last == HQMOFMsp_now
2186                                 HQMOFM_stalenum = HQMOFM_stalenum + 1;
2187                                 <span class="keyword">if</span> HQMOFM_stalenum == 30 <span class="comment">% warn and message to pager if stale for 30 secs</span>
2188                                     fprintf(<span class="string">'**The RF is not responding to orbit feedback changes! \n'</span>);
2189                                     fprintf(<span class="string">'%s\n'</span>,datestr(now));
2190                                     fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2191                                     fprintf(<span class="string">'**ILC 73 controls the EG______HQMOFM_AC01 channel, which sets the RF frequency. \n'</span>);
2192                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstaleRFmessage.txt
2193                                 <span class="keyword">end</span>
2194                                 <span class="keyword">if</span> rem(HQMOFM_stalenum,120)==0 <span class="comment">% message to screen every 2 minutes</span>
2195                                     fprintf(<span class="string">'**The RF is not responding to orbit feedback changes! (%s)\n'</span>,datestr(now));
2196                                 <span class="keyword">end</span>
2197                             <span class="keyword">else</span>
2198                                 HQMOFM_stalenum = 0;
2199                             <span class="keyword">end</span>
2200 
2201                         <span class="keyword">end</span>
2202 
2203                         <span class="comment">%fprintf('RF Done: %f \n',gettime-t00);</span>
2204 
2205                         Xold = Xnew;
2206                     <span class="keyword">end</span> <span class="comment">% End horizontal correction</span>
2207 
2208 
2209                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2210                     <span class="comment">% Vertical plane &quot;feedback&quot; %</span>
2211                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2212 
2213                     <span class="comment">% Get orbit and check that the BPMs are different from the last update</span>
2214                     Ynew = gety(FB.OCSy.BPM.DeviceList);
2215 
2216                     <span class="comment">% Don't feedback if the current is too small</span>
2217                     <span class="keyword">if</span> getdcct &lt; 5
2218                         FEEDBACK_STOP_FLAG = 1;
2219                         fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2220                         <span class="keyword">break</span>;
2221                     <span class="keyword">end</span>
2222 
2223                     y = Ygoal - Ynew;
2224                     STDy = norm(y)/sqrt(length(y));
2225 
2226                     <span class="keyword">if</span> any(Yold == Ynew)
2227                         a = clock;
2228                         N_Stale_Data_Points = find((Yold==Ynew)==1);
2229                         <span class="keyword">for</span> loop = N_Stale_Data_Points'
2230                             fprintf(<span class="string">'   Stale data: BPMy(%2d,%d), feedback step skipped (%s %d:%d:%.0f). \n'</span>, FB.OCSy.BPM.DeviceList(loop,1), FB.OCSy.BPM.DeviceList(loop,2), date, a(4), a(5), a(6));
2231                         <span class="keyword">end</span>
2232 
2233                     <span class="keyword">else</span>
2234 
2235                         <span class="comment">% Compute vertical correction</span>
2236                         <span class="comment">%%%OCSy0 = FB.OCSy;</span>
2237                         FB.OCSy.BPM.Data = Ynew;
2238                         FB.OCSy = orbitcorrectionmethods(FB.OCSy, Smaty, Sy, Uy, Vy);
2239 
2240                         <span class="comment">%%%[FB.OCSy, RF, OCSy0] = setorbit(FB.OCSy,'Nodisplay','Nosetsp');</span>
2241 
2242                         <span class="comment">% reduced feedback gain, C. Steier, 2001-03-25</span>
2243                         <span class="comment">% reduced to 0.1, C. Steier, 2001-09-04, IDBPMs are noisy at the moment</span>
2244                         <span class="comment">% increased back to 0.8, C. Steier, 2001-09-29, IDBPMs filtering + direct DAC read/write + all SVDs (no arc BPMs)</span>
2245                         <span class="comment">% set to unity gain, C. Steier, 2002-05-04, trim DACs</span>
2246                         Y = Ygain .* FB.OCSy.CM.Delta;
2247                         <span class="comment">%%%Y = Ygain .* (FB.OCSy.CM.Data - OCSy0.CM.Data);</span>
2248 
2249                         <span class="comment">% Just SVD correction</span>
2250                         <span class="comment">% warning('Not using &quot;micado&quot; correction in the vertical plane.');</span>
2251 
2252                         <span class="comment">% check for trim values+next step values, warn or stop FB as necessary</span>
2253                         VCMtrimSP = getpv(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1);
2254                         VCMtrimSP_next = VCMtrimSP + Y(1:N_VCM);
2255                         <span class="keyword">if</span> max(abs(VCMtrimSP_next)) &gt; 12
2256                             VCMtrimnum=find(abs(VCMtrimSP_next) &gt; 12);
2257 
2258                             <span class="comment">% print message to screen</span>
2259                             fprintf(<span class="string">'**One or more of the vertical correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2260                             fprintf(<span class="string">'%s\n'</span>,datestr(now));
2261                             <span class="keyword">for</span> loop = VCMtrimnum'
2262                                 fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1(loop,:)));
2263                             <span class="keyword">end</span>
2264 
2265                             <span class="comment">% send alphapage to operator pager</span>
2266                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2267                             FEEDBACK_STOP_FLAG = 1;
2268 
2269                             setpv(<span class="string">'SR_STATE'</span>, -5);
2270                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2271                             <span class="keyword">if</span> StateNumber &gt;= 0
2272                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2273                             <span class="keyword">else</span>
2274                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2275                             <span class="keyword">end</span>
2276                         <span class="keyword">end</span>
2277 
2278                         <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2279                             <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2280                             <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2281                                 disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2282                             <span class="keyword">end</span>
2283                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2284                             pause(0.5);
2285                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2286                             <span class="keyword">break</span>;
2287                         <span class="keyword">end</span>
2288 
2289                         <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2290                         <span class="comment">% pause(0);</span>
2291 
2292                         <span class="keyword">if</span> max(abs(VCMtrimSP_next) &gt; 4)
2293                             VCMtrimnum=find(abs(VCMtrimSP_next) &gt; 4);
2294                             VWarnNum=VWarnNum+1;
2295                             <span class="keyword">if</span> (VWarnNum==1 | rem(VWarnNum,120)==0)
2296 
2297                                 <span class="comment">% print message to screen every two minutes</span>
2298                                 fprintf(<span class="string">'**One or more of the vertical corrector trims is above 4A or below -4A! \n'</span>);
2299                                 fprintf(<span class="string">'%s\n'</span>,datestr(now));
2300                                 <span class="keyword">for</span> loop = VCMtrimnum'
2301                                     fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1(loop,:)));
2302                                 <span class="keyword">end</span>
2303                                 fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2304 
2305                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2306                                 <span class="keyword">if</span> (VWarnNum==1 | VWarnNum==600)
2307                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageVCM.txt
2308                                 <span class="keyword">end</span>
2309                             <span class="keyword">end</span>
2310                         <span class="keyword">else</span>
2311                             VWarnNum=0;
2312                         <span class="keyword">end</span>
2313 
2314                         <span class="comment">% Don't feedback if the current is too small</span>
2315                         <span class="keyword">if</span> getdcct &lt; 5
2316                             FEEDBACK_STOP_FLAG = 1;
2317                             fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2318                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/beamisoff.txt
2319                             <span class="keyword">break</span>;
2320                         <span class="keyword">end</span>
2321 
2322                         <span class="keyword">if</span> N_VCM &gt; 0
2323                             steppv(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>, Y(iNotVCMChicane), VCMlist1(iNotVCMChicane,:), 0);
2324                             steppv(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>, Y(iVCMChicane), VCMlist1(iVCMChicane,:), 0);
2325                         <span class="keyword">end</span>
2326 
2327                         <span class="comment">% write fast orbit feedback setpoints</span>
2328                         <span class="keyword">if</span> 1
2329                             <a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>(2,Ynew(1:size(BPMlist1,1))+Sy1*Y(1:N_VCM),BPMlist1);
2330                         <span class="keyword">end</span>
2331 
2332                     <span class="keyword">end</span>
2333 
2334                     Yold = Ynew;
2335 
2336                     <span class="comment">%fprintf('Vertical Done: %f \n',gettime-t00);</span>
2337                 <span class="keyword">end</span> <span class="comment">% End vertical correction</span>
2338 
2339 
2340                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
2341                 <span class="comment">% Tune feed forward %</span>
2342                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
2343                 <span class="comment">% We should do a Sector limit check</span>
2344 
2345                 tic;
2346                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxTune'</span>),<span class="string">'Value'</span>) == 1
2347 
2348                     <span class="keyword">if</span> strcmp(SR_Mode, <span class="string">'1.9 GeV, High Tune'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Inject at 1.23'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Two-Bunch'</span>)
2349 
2350                         <span class="keyword">if</span> strcmp(FFTypeFlag,<span class="string">'Local'</span>)
2351                             disp(<span class="string">'  No local tune compensation available - global is the default now.'</span>);
2352                         <span class="keyword">elseif</span> strcmp(FFTypeFlag,<span class="string">'Global'</span>)
2353 
2354                             addQFsp = zeros(24,1);
2355                             addQDsp = zeros(24,1);
2356                             Sector = getlist(<span class="string">'ID'</span>);
2357                             <span class="keyword">for</span> gapnum = 1:size(Sector,1)
2358                                 <span class="comment">% Change in tune and [QF;QD] from maximum gap</span>
2359                                 actualgap = <a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>(Sector(gapnum,:));
2360                                 [gapmin,gapmax] = <a href="gaplimit.html" class="code" title="function [GAPmin, GAPmax] = gaplimit(Dev);">gaplimit</a>(Sector(gapnum,:));
2361                                 <span class="keyword">if</span> actualgap &lt; (gapmin-1)
2362                                     actualgap = gapmax;
2363                                 <span class="keyword">end</span>
2364 
2365                                 <span class="keyword">if</span> (Sector(gapnum,1) == 4) | (Sector(gapnum,1) == 11)
2366                                     Shift = getsp(<span class="string">'EPU'</span>, Sector);
2367                                     <span class="keyword">if</span> Sector(gapnum,2) == 1
2368                                         modenamestr = sprintf(<span class="string">'SR%02dU___ODS1M__DC00'</span>,Sector(gapnum,1));
2369                                     <span class="keyword">else</span> <span class="comment">% if Sector(gapnum,2) == 2</span>
2370                                         modenamestr = sprintf(<span class="string">'SR%02dU___ODS2M__DC00'</span>,Sector(gapnum,1));
2371                                     <span class="keyword">end</span>
2372                                     epumode = getpv(modenamestr);
2373 
2374                                     DelQF = zeros(length(QFsp),1);
2375                                     DelQD = zeros(length(QFsp),1);
2376 
2377                                     <span class="comment">% This subroutine call replaced by code in this routine for efficiency</span>
2378                                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2379                                     <span class="comment">% [DelQF, DelQD] = ...                                                                         %</span>
2380                                     <span class="comment">%      ffdeltaquadepu(Sector(gapnum,:), actualgap, getepu(Sector(gapnum,:)), epumode, SR_GeV); %</span>
2381                                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2382                                     <span class="keyword">if</span> strcmp(SR_Mode, <span class="string">'1.9 GeV, High Tune'</span>) ||  strcmp(SR_Mode, <span class="string">'1.9 GeV, Inject at 1.23'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Two-Bunch'</span>)
2383 
2384                                         <span class="keyword">if</span> strcmp(FFTypeFlag,<span class="string">'Local'</span>)
2385                                             <span class="comment">% Change in tune and [QF;QD] from maximum gap</span>
2386                                             DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(Sector(gapnum,:), actualgap, SR_GeV);
2387                                             fraccorr = 1.15 * DeltaNuY / TuneW16Min;
2388 
2389                                             <span class="comment">% Find which quads to change</span>
2390                                             QuadList = [Sector(gapnum,1)-1 1;Sector(gapnum,1)-1 2;Sector(gapnum,1) 1;Sector(gapnum,1) 2];
2391                                             QuadElem = dev2elem(<span class="string">'QF'</span>, QuadList);
2392 
2393                                             <span class="keyword">if</span> (Sector(gapnum,1)==7) | (Sector(gapnum,1)==10) | (Sector(gapnum,1)==11)
2394                                                 QFfac = ([2.227520/2.237111; 2.239570/2.237111; 2.239570/2.237111; 2.227520/2.237111]-1) * fraccorr;
2395                                                 QDfac = ([2.432264/2.511045; 2.543089/2.511045; 2.543080/2.511045; 2.432264/2.511045]-1) * fraccorr;
2396                                             <span class="keyword">elseif</span> (Sector(gapnum,1)==5) | (Sector(gapnum,1)==9)
2397                                                 QFfac = ([2.208418/2.219784; 2.225926/2.219784; 2.231777/2.237111; 2.233775/2.237111]-1) * fraccorr;
2398                                                 QDfac = ([2.386512/2.483259; 2.545907/2.483259; 2.474571/2.511045; 2.491079/2.511045]-1) * fraccorr;
2399                                             <span class="keyword">elseif</span> (Sector(gapnum,1)==4) | (Sector(gapnum,1)==8) | (Sector(gapnum,1)==12)
2400                                                 QFfac = ([2.233775/2.237111; 2.231777/2.237111; 2.225926/2.219784; 2.208418/2.219784]-1) * fraccorr;
2401                                                 QDfac = ([2.491079/2.511045; 2.474571/2.511045; 2.545907/2.483259; 2.386512/2.483259]-1) * fraccorr;
2402                                             <span class="keyword">else</span>
2403                                                 QFfac = zeros(4,size(actualgap,2));
2404                                                 QDfac = zeros(4,size(actualgap,2));
2405                                             <span class="keyword">end</span>
2406 
2407                                             DelQF(QuadElem,:) = DelQF(QuadElem,:) + QFfac.*QFsp(QuadElem,:);
2408                                             DelQD(QuadElem,:) = DelQD(QuadElem,:) + QDfac.*QDsp(QuadElem,:);
2409 
2410                                         <span class="keyword">elseif</span> strcmp(FFTypeFlag,<span class="string">'Global'</span>)
2411                                             <span class="comment">% Change in tune and [QF;QD] from maximum gap</span>
2412 
2413                                             DeltaNuX = 0;
2414                                             DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(Sector(gapnum,:), actualgap, SR_GeV);
2415 
2416                                             <span class="keyword">if</span> (Sector(gapnum,1) == 4) | (Sector(gapnum,1) == 11)
2417                                                 <span class="keyword">if</span> Sector(i,2)==2
2418                                                     longshift=3;
2419                                                 <span class="keyword">else</span>
2420                                                     longshift=0;
2421                                                 <span class="keyword">end</span>
2422                                                 <span class="keyword">if</span> mode(i)==0
2423                                                     DeltaNuX = <a href="shift2tune.html" class="code" title="function [Dnux, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = shift2tune(Sector, Gap, EPUshift, GeV)">shift2tune</a>(Sector(gapnum,1),actualgap,Shift(gapnum,:)+longshift,SR_GeV)+0.0015;
2424                                                     DeltaNuY = 0;   <span class="comment">% vertical tune shift of EPUs is very small</span>
2425                                                 <span class="keyword">else</span>
2426                                                     DeltaNuX = 0;
2427                                                     DeltaNuY = 0;
2428                                                 <span class="keyword">end</span>
2429                                             <span class="keyword">else</span>
2430                                                 DeltaNuX = 0;
2431                                             <span class="keyword">end</span>
2432 
2433 
2434                                             fraccorr = DeltaNuY ./ TuneW16Min;
2435 
2436                                             <span class="comment">% Find which quads to change</span>
2437                                             QuadList = [Sector(gapnum,1)-1 2; Sector(gapnum,1) 1];
2438                                             QuadElem = dev2elem(<span class="string">'QF'</span>,QuadList);
2439 
2440                                             DeltaAmps = inv(SR_TUNE_MATRIX) * [(fraccorr*6.23e-4); fraccorr*(-0.05301)];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2441 
2442                                             DelQF = DelQF + DeltaAmps(1,:);
2443                                             DelQD = DelQD + DeltaAmps(2,:);
2444 
2445                                             DeltaAmpsLocal = 12*inv(SR_TUNE_MATRIX) * [-0.8*DeltaNuX;0];                       <span class="comment">%  DelAmps =  [QF; QD];</span>
2446                                             DelQF(QuadElem) = DelQF(QuadElem)+DeltaAmpsLocal(1,1);
2447                                             DelQD(QuadElem) = DelQD(QuadElem)+DeltaAmpsLocal(2,1);
2448 
2449                                             <span class="keyword">if</span> (Sector(gapnum,1)==6) | (Sector(gapnum,1)==7) | (Sector(gapnum,1)==10) | (Sector(gapnum,1)==11)
2450                                                 QFfac = ([2.243127/2.237111; 2.243127/2.237111]-1) * fraccorr;
2451                                                 QDfac = ([2.556392/2.511045; 2.556392/2.511045]-1) * fraccorr;
2452                                             <span class="keyword">elseif</span> (Sector(gapnum,1)==5) | (Sector(gapnum,1)==9)
2453                                                 QFfac = ([2.225965/2.219784; 2.243096/2.237111]-1) * fraccorr;
2454                                                 QDfac = ([2.528950/2.483259; 2.556345/2.511045]-1) * fraccorr;
2455                                             <span class="keyword">elseif</span> (Sector(gapnum,1)==4) | (Sector(gapnum,1)==8) | (Sector(gapnum,1)==12)
2456                                                 QFfac = ([2.243096/2.237111; 2.225965/2.219784]-1) * fraccorr;
2457                                                 QDfac = ([2.556345/2.511045; 2.528950/2.483259]-1) * fraccorr;
2458                                             <span class="keyword">else</span>
2459                                                 QFfac = zeros(2,size(actualgap,2));
2460                                                 QDfac = zeros(2,size(actualgap,2));
2461                                             <span class="keyword">end</span>
2462 
2463                                             DelQF(QuadElem,:) = DelQF(QuadElem,:) + QFfac.*QFsp(QuadElem,:);
2464                                             DelQD(QuadElem,:) = DelQD(QuadElem,:) + QDfac.*QDsp(QuadElem,:);
2465 
2466                                         <span class="keyword">else</span>
2467                                             error(<span class="string">'Unknown type selected for tune FF'</span>);
2468                                         <span class="keyword">end</span>
2469 
2470                                     <span class="keyword">else</span>
2471 
2472                                         <span class="comment">% Change in tune and [QF;QD] from maximum gap</span>
2473                                         DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(Sector(gapnum,:), actualgap, SR_GeV);
2474 
2475                                         <span class="keyword">if</span> (Sector(gapnum,1)==7) | (Sector(gapnum,1)==10) | (Sector(gapnum,1)==11)
2476                                             DeltaAmps = inv(SR_TUNE_MATRIX/12) * [zeros(size(DeltaNuY)); -DeltaNuY];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2477                                             DeltaAmpsQF = [DeltaAmps(1,:); DeltaAmps(1,:)];
2478                                             DeltaAmpsQD = [DeltaAmps(2,:); DeltaAmps(2,:)];
2479                                         <span class="keyword">elseif</span> (Sector(gapnum,1)==5) | (Sector(gapnum,1)==9)
2480                                             DeltaAmpsQF = [-1.0637; -0.5132] * DeltaNuY / 0.0181 * 0.37;
2481                                             DeltaAmpsQD = [-6.6328; -3.3434] * DeltaNuY / 0.0181 * 0.37;
2482                                         <span class="keyword">elseif</span> (Sector(gapnum,1)==4) | (Sector(gapnum,1)==8) | (Sector(gapnum,1)==12)
2483                                             DeltaAmpsQF = [-0.5132; -1.0637] * DeltaNuY / 0.0181 * 0.37;
2484                                             DeltaAmpsQD = [-3.3434; -6.6328] * DeltaNuY / 0.0181 * 0.37;
2485                                         <span class="keyword">else</span>
2486                                             DeltaAmpsQF = zeros(2,size(actualgap,2));
2487                                             DeltaAmpsQD = zeros(2,size(actualgap,2));
2488                                         <span class="keyword">end</span>
2489 
2490                                         <span class="comment">% Find which quads to change</span>
2491                                         QuadList = [Sector(gapnum,1)-1 1;Sector(gapnum,1) 2];
2492                                         QuadElem = dev2elem(<span class="string">'QF'</span>, QuadList);
2493 
2494                                         DelQF(QuadElem,:) = DelQF(QuadElem,:) + DeltaAmpsQF;
2495                                         DelQD(QuadElem,:) = DelQD(QuadElem,:) + DeltaAmpsQD;
2496                                     <span class="keyword">end</span>
2497                                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2498                                     <span class="comment">% ffdeltaquadepu code ends here %</span>
2499                                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2500 
2501                                 <span class="keyword">else</span>
2502                                     <span class="comment">% This subroutine call replaced by code in this routine for efficiency</span>
2503                                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2504                                     <span class="comment">%[DelQF, DelQD] = ...                                  %</span>
2505                                     <span class="comment">%    ffdeltaquad(Sector(gapnum,:), actualgap, SR_GeV); %</span>
2506                                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2507 
2508                                     <span class="comment">% Initialize</span>
2509                                     DelQF  = zeros(length(QFsp), 1);
2510                                     DelQD  = zeros(length(QDsp), 1);
2511 
2512                                     <span class="keyword">if</span> strcmp(SR_Mode, <span class="string">'1.9 GeV, High Tune'</span>) ||  strcmp(SR_Mode, <span class="string">'1.9 GeV, Inject at 1.23'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Two-Bunch'</span>)
2513 
2514                                         <span class="keyword">if</span> strcmp(FFTypeFlag,<span class="string">'Local'</span>)
2515                                             <span class="comment">% Change in tune and [QF;QD] from maximum gap</span>
2516                                             DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(Sector(gapnum,:), actualgap, SR_GeV);
2517                                             fraccorr = 1.15 * DeltaNuY / TuneW16Min;
2518 
2519                                             <span class="comment">% Find which quads to change</span>
2520                                             QuadList = [Sector(gapnum,1)-1 1;Sector(gapnum,1)-1 2;Sector(gapnum,1) 1;Sector(gapnum,1) 2];
2521                                             QuadElem = dev2elem(<span class="string">'QF'</span>, QuadList);
2522 
2523                                             <span class="keyword">if</span> (Sector(gapnum,1)==7) | (Sector(gapnum,1)==10) | (Sector(gapnum,1)==11)
2524                                                 QFfac = ([2.227520/2.237111; 2.239570/2.237111; 2.239570/2.237111; 2.227520/2.237111]-1) * fraccorr;
2525                                                 QDfac = ([2.432264/2.511045; 2.543089/2.511045; 2.543080/2.511045; 2.432264/2.511045]-1) * fraccorr;
2526                                             <span class="keyword">elseif</span> (Sector(gapnum,1)==5) | (Sector(gapnum,1)==9)
2527                                                 QFfac = ([2.208418/2.219784; 2.225926/2.219784; 2.231777/2.237111; 2.233775/2.237111]-1) * fraccorr;
2528                                                 QDfac = ([2.386512/2.483259; 2.545907/2.483259; 2.474571/2.511045; 2.491079/2.511045]-1) * fraccorr;
2529                                             <span class="keyword">elseif</span> (Sector(gapnum,1)==4) | (Sector(gapnum,1)==8) | (Sector(gapnum,1)==12)
2530                                                 QFfac = ([2.233775/2.237111; 2.231777/2.237111; 2.225926/2.219784; 2.208418/2.219784]-1) * fraccorr;
2531                                                 QDfac = ([2.491079/2.511045; 2.474571/2.511045; 2.545907/2.483259; 2.386512/2.483259]-1) * fraccorr;
2532                                             <span class="keyword">else</span>
2533                                                 QFfac = zeros(4,size(actualgap,2));
2534                                                 QDfac = zeros(4,size(actualgap,2));
2535                                             <span class="keyword">end</span>
2536 
2537                                             DelQF(QuadElem,:) = DelQF(QuadElem,:) + QFfac.*QFsp(QuadElem,:);
2538                                             DelQD(QuadElem,:) = DelQD(QuadElem,:) + QDfac.*QDsp(QuadElem,:);
2539 
2540                                         <span class="keyword">elseif</span> strcmp(FFTypeFlag,<span class="string">'Global'</span>)
2541                                             <span class="comment">% Change in tune and [QF;QD] from maximum gap</span>
2542 
2543                                             DeltaNuX = 0;
2544                                             DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(Sector(gapnum,:), actualgap, SR_GeV);
2545 
2546                                             <span class="keyword">if</span> (Sector(gapnum,1) == 4) | (Sector(gapnum,1) == 11)
2547                                                 <span class="comment">% Remove sector 4 and 11 tune correction</span>
2548                                                 DeltaNuY = 0;
2549                                             <span class="keyword">end</span>
2550 
2551                                             fraccorr = DeltaNuY ./ TuneW16Min;
2552 
2553                                             <span class="comment">% Find which quads to change</span>
2554                                             QuadList = [Sector(gapnum,1)-1 2; Sector(gapnum,1) 1];
2555                                             QuadElem = dev2elem(<span class="string">'QF'</span>,QuadList);
2556 
2557                                             DeltaAmps = inv(SR_TUNE_MATRIX) * [(fraccorr*6.23e-4)-DeltaNuX; fraccorr*(-0.05301)];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2558 
2559                                             DelQF = DelQF + DeltaAmps(1,:);
2560                                             DelQD = DelQD + DeltaAmps(2,:);
2561 
2562                                             DeltaAmpsLocal = 12*inv(SR_TUNE_MATRIX) * [-DeltaNuX;0];                       <span class="comment">%  DelAmps =  [QF; QD];</span>
2563                                             DelQF(QuadElem) = DelQF(QuadElem)+DeltaAmpsLocal(1,1);
2564                                             DelQD(QuadElem) = DelQD(QuadElem)+DeltaAmpsLocal(2,1);
2565 
2566                                             <span class="keyword">if</span> (Sector(gapnum,1)==6) | (Sector(gapnum,1)==7) | (Sector(gapnum,1)==10) | (Sector(gapnum,1)==11)
2567                                                 QFfac = ([2.243127/2.237111; 2.243127/2.237111]-1) * fraccorr;
2568                                                 QDfac = ([2.556392/2.511045; 2.556392/2.511045]-1) * fraccorr;
2569                                             <span class="keyword">elseif</span> (Sector(gapnum,1)==5) | (Sector(gapnum,1)==9)
2570                                                 QFfac = ([2.225965/2.219784; 2.243096/2.237111]-1) * fraccorr;
2571                                                 QDfac = ([2.528950/2.483259; 2.556345/2.511045]-1) * fraccorr;
2572                                             <span class="keyword">elseif</span> (Sector(gapnum,1)==4) | (Sector(gapnum,1)==8) | (Sector(gapnum,1)==12)
2573                                                 QFfac = ([2.243096/2.237111; 2.225965/2.219784]-1) * fraccorr;
2574                                                 QDfac = ([2.556345/2.511045; 2.528950/2.483259]-1) * fraccorr;
2575                                             <span class="keyword">else</span>
2576                                                 QFfac = zeros(2,size(actualgap,2));
2577                                                 QDfac = zeros(2,size(actualgap,2));
2578                                             <span class="keyword">end</span>
2579 
2580                                             DelQF(QuadElem,:) = DelQF(QuadElem,:) + QFfac.*QFsp(QuadElem,:);
2581                                             DelQD(QuadElem,:) = DelQD(QuadElem,:) + QDfac.*QDsp(QuadElem,:);
2582 
2583                                         <span class="keyword">else</span>
2584                                             error(<span class="string">'Unknown type selected for tune FF'</span>);
2585                                         <span class="keyword">end</span>
2586 
2587                                     <span class="keyword">else</span>
2588 
2589                                         <span class="comment">% Change in tune and [QF;QD] from maximum gap</span>
2590                                         DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(Sector(gapnum,:), actualgap, SR_GeV);
2591 
2592                                         <span class="keyword">if</span> (Sector(gapnum,1)==7) | (Sector(gapnum,1)==10) | (Sector(gapnum,1)==11)
2593                                             DeltaAmps = inv(SR_TUNE_MATRIX/12) * [zeros(size(DeltaNuY)); -DeltaNuY];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2594                                             DeltaAmpsQF = [DeltaAmps(1,:); DeltaAmps(1,:)];
2595                                             DeltaAmpsQD = [DeltaAmps(2,:); DeltaAmps(2,:)];
2596                                         <span class="keyword">elseif</span> (Sector(gapnum,1)==5) | (Sector(gapnum,1)==9)
2597                                             DeltaAmpsQF = [-1.0637; -0.5132] * DeltaNuY / 0.0181 * 0.37;
2598                                             DeltaAmpsQD = [-6.6328; -3.3434] * DeltaNuY / 0.0181 * 0.37;
2599                                         <span class="keyword">elseif</span> (Sector(gapnum,1)==4) | (Sector(gapnum,1)==8) | (Sector(gapnum,1)==12)
2600                                             DeltaAmpsQF = [-0.5132; -1.0637] * DeltaNuY / 0.0181 * 0.37;
2601                                             DeltaAmpsQD = [-3.3434; -6.6328] * DeltaNuY / 0.0181 * 0.37;
2602                                         <span class="keyword">else</span>
2603                                             DeltaAmpsQF = zeros(2,size(actualgap,2));
2604                                             DeltaAmpsQD = zeros(2,size(actualgap,2));
2605                                         <span class="keyword">end</span>
2606 
2607                                         <span class="comment">% Find which quads to change</span>
2608                                         QuadList = [Sector(gapnum,1)-1 1;Sector(gapnum,1) 2];
2609                                         QuadElem = dev2elem(<span class="string">'QF'</span>, QuadList);
2610 
2611                                         DelQF(QuadElem,:) = DelQF(QuadElem,:) + DeltaAmpsQF;
2612                                         DelQD(QuadElem,:) = DelQD(QuadElem,:) + DeltaAmpsQD;
2613                                     <span class="keyword">end</span>
2614                                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2615                                     <span class="comment">% ffdeltaquad code ends here %</span>
2616                                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2617                                 <span class="keyword">end</span>
2618 
2619                                 addQFsp = addQFsp+DelQF;
2620                                 addQDsp = addQDsp+DelQD;
2621                             <span class="keyword">end</span>
2622                         <span class="keyword">else</span>
2623                             error(<span class="string">'Unknown type selected for tune FF'</span>);
2624                         <span class="keyword">end</span>
2625 
2626                         <span class="comment">% Set quadrupoles using main setpoint channels</span>
2627                         setpv(<span class="string">'QF'</span>, QFsp+addQFsp,[], 0);
2628                         setpv(<span class="string">'QD'</span>, QDsp+addQDsp,[], 0);
2629 
2630                         <span class="comment">% % Set quadrupoles using FF setpoint channels</span>
2631                         <span class="comment">% setpv('QF', 'FF', addQFsp, [], 0);</span>
2632                         <span class="comment">% setpv('QD', 'FF', addQDsp, [], 0);</span>
2633 
2634                     <span class="keyword">else</span>
2635                         disp(<span class="string">'  No tune FF algorithm for non-production modes yet...'</span>);
2636                     <span class="keyword">end</span>
2637                 <span class="keyword">end</span>
2638 
2639                 ffdeltaquad_delay = toc;
2640                 fprintf(<span class="string">'tune FF delay = %.1f seconds\n'</span>,ffdeltaquad_delay);
2641                 <span class="comment">% fprintf('Tune Done: %f \n',gettime-t00);</span>
2642 
2643                 <span class="comment">% Output info to screen</span>
2644                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = %.4f mm'</span>,STDx),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2645                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = %.4f mm'</span>,STDy),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2646                 pause(0);
2647 
2648 
2649                 fprintf(<span class="string">'End of feedback operations: %f \n\n'</span>,gettime-t00);
2650 
2651                 <span class="comment">% Wait for next update time or stop request</span>
2652                 <span class="keyword">while</span> (gettime-t00) &lt; LoopDelay
2653                     <span class="comment">%disp('interval could be shorter')</span>
2654                     pause(.05);
2655                     <span class="comment">% Check if GUI has been closed</span>
2656                     <span class="keyword">if</span> isempty(gcbf)
2657                         FEEDBACK_STOP_FLAG = 1;
2658                         lasterr(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2659                         error(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2660                     <span class="keyword">end</span>
2661 
2662                     <span class="comment">% Check if Stop button was pressed</span>
2663                     <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2664                         <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2665                         <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2666                             disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2667                         <span class="keyword">end</span>
2668                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2669                         pause(0.5);
2670                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2671                         <span class="keyword">break</span>;
2672                     <span class="keyword">end</span>
2673                 <span class="keyword">end</span>
2674                 
2675 
2676                 <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2677                     <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2678                     <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2679                         disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2680                     <span class="keyword">end</span>
2681                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2682                     pause(0.5);
2683                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2684                     <span class="keyword">break</span>;
2685                 <span class="keyword">end</span>
2686 
2687                 StartErrorTime = gettime;
2688 
2689             <span class="keyword">catch</span>
2690 
2691                 fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
2692 
2693                 <span class="comment">% Quit if error exists for more than 20 seconds</span>
2694                 <span class="keyword">if</span> gettime-StartErrorTime&gt;20 | FEEDBACK_STOP_FLAG==1
2695                     fprintf(<span class="string">'%s  Orbit feedback stopped due to error condition. \n\n'</span>,datestr(now));
2696 
2697                     <span class="comment">%send alphapage to operator pager</span>
2698                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2699                     FEEDBACK_STOP_FLAG = 1;
2700 
2701                     setpv(<span class="string">'SR_STATE'</span>, -5);
2702                     [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2703                     <span class="keyword">if</span> StateNumber &gt;= 0
2704                         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2705                     <span class="keyword">else</span>
2706                         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2707                     <span class="keyword">end</span>
2708                 <span class="keyword">else</span>
2709                     a = clock;
2710                     fprintf(<span class="string">'   Orbit feedback was paused due to error condition (%s %d:%d:%.0f). \n'</span>, date, a(4), a(5), a(6));
2711                     fprintf(<span class="string">'   Orbit feedback has automatically restarted and is running. \n\n'</span>);
2712                 <span class="keyword">end</span>
2713 
2714             <span class="keyword">end</span>
2715             
2716             <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2717                 <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2718                 <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2719                     disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2720                 <span class="keyword">end</span>
2721                 setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2722                 pause(0.5);
2723                 setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2724                 <span class="keyword">break</span>;
2725             <span class="keyword">end</span>
2726 
2727             <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2728 
2729             <span class="comment">%pause(0);</span>
2730 
2731             <span class="comment">% this loop delays turn on of Fast Feedback system</span>
2732             <span class="keyword">if</span> FBloopIter &lt; 5
2733                 FBloopIter = FBloopIter + 1;
2734             <span class="keyword">end</span>
2735 
2736         <span class="keyword">end</span>  <span class="comment">% End of feedback loop</span>
2737 
2738 
2739         <span class="comment">% End feedback, reset all parameters</span>
2740         <span class="keyword">try</span>
2741 
2742             <span class="comment">% Enable buttons</span>
2743             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2744             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2745             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2746             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2747             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2748             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2749             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2750             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2751             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2752             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2753             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2754             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2755             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2756 
2757             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = _____ mm'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2758             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = _____ mm'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2759             pause(0);
2760 
2761         <span class="keyword">catch</span>
2762 
2763             <span class="comment">% GUI must have been closed</span>
2764 
2765         <span class="keyword">end</span>
2766 
2767 
2768         <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
2769         disp(<span class="string">'   IDBPM time constant set to 0.25s.'</span>);
2770         <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.25);
2771 
2772 
2773         a = clock;
2774         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2775         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2776         <span class="keyword">if</span> StateNumber &gt;= 0
2777             setpv(<span class="string">'SR_STATE'</span>,5.1);
2778             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2779             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2780             fprintf(<span class="string">'   ******************************\n'</span>);
2781             fprintf(<span class="string">'   **  Orbit Feedback Stopped  **\n'</span>);
2782             fprintf(<span class="string">'   ******************************\n\n'</span>);
2783         <span class="keyword">else</span>
2784             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2785             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2786             fprintf(<span class="string">'   ****************************************\n'</span>);
2787             fprintf(<span class="string">'   **  Problem With Slow Orbit Feedback  **\n'</span>);
2788             fprintf(<span class="string">'   ****************************************\n\n'</span>);
2789         <span class="keyword">end</span>
2790         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
2791         pause(0);
2792 
2793 
2794     <span class="keyword">case</span> <span class="string">'FeedbackSetup'</span>
2795         InitFlag = Input2;           <span class="comment">% Input #2: if InitFlag, then initialize variables</span>
2796 
2797         <span class="keyword">if</span> InitFlag
2798             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2799             <span class="comment">% Edit the following lists to change default configuration of Orbit Correction %</span>
2800             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2801 
2802             <span class="comment">% Corrector magnets</span>
2803             listh=[
2804                 1 2;
2805                 1 8;
2806                 2 1;
2807                 2 8;
2808                 3 1;
2809                 3 8;
2810                 3 10; <span class="comment">%SR04U_HCM2 (chicane trim)</span>
2811                 4 1;
2812                 4 8;
2813                 5 1;
2814                 5 8;
2815                 5 10; <span class="comment">%SR06U_HCM2 (chicane trim)</span>
2816                 6 1;
2817                 6 8;
2818                 7 1;
2819                 7 8;
2820                 8 1;
2821                 8 8;
2822                 9 1;
2823                 9 8;
2824                 10 1;
2825                 10 8;
2826                 10 10; <span class="comment">%SR11U_HCM2 (chicane trim)</span>
2827                 11 1;
2828                 11 8;
2829                 12 1;
2830                 12 7];
2831             listv=[
2832                 1 2;
2833                 1 8;
2834                 2 1;
2835                 2 8;
2836                 3 1;
2837                 3 7;
2838                 3 8;
2839                 3 10; <span class="comment">%SR04U_VHCM2 (chicane trim)</span>
2840                 4 1;
2841                 4 7;
2842                 4 8;
2843                 5 1;
2844                 5 8;
2845                 5 10; <span class="comment">%SR06U_VHCM2 (chicane trim)</span>
2846                 6 1;
2847                 6 8;
2848                 7 1;
2849                 7 8;
2850                 8 1;
2851                 8 8;
2852                 9 1;
2853                 9 8;
2854                 10 1;
2855                 10 2;
2856                 10 7;
2857                 10 8;
2858                 10 10; <span class="comment">%SR11U_VHCM2 (chicane trim)</span>
2859                 11 1;
2860                 11 7;
2861                 11 8;
2862                 12 1;
2863                 12 7];
2864 
2865             Xivec = [1:28];
2866             Yivec = [1:32];
2867             HCMlist1 = listh;
2868             VCMlist1 = listv;
2869 
2870             <span class="comment">% Full BPM list</span>
2871             BPMlist1 = [
2872                 1 2
2873                 1 5
2874                 1 6
2875                 1 10
2876                 2 1
2877                 2 5
2878                 2 6
2879                 2 9
2880                 3 2
2881                 3 5
2882                 3 6
2883                 3 10
2884                 3 11
2885                 3 12
2886                 4 1
2887                 4 5
2888                 4 6
2889                 4 10
2890                 5 1
2891                 5 5
2892                 5 6
2893                 5 10
2894                 5 11
2895                 5 12
2896                 6 1
2897                 6 5
2898                 6 6
2899                 6 10
2900                 7 1
2901                 7 5
2902                 7 6
2903                 7 10
2904                 8 1
2905                 8 5
2906                 8 6
2907                 8 10
2908                 9 1
2909                 9 5
2910                 9 6
2911                 9 10
2912                 10 1
2913                 10 5
2914                 10 6
2915                 10 10
2916                 10 11
2917                 10 12
2918                 11 1
2919                 11 5
2920                 11 6
2921                 11 10
2922                 12 1
2923                 12 5
2924                 12 6
2925                 12 9
2926                 ];
2927 
2928             <span class="comment">% remove Bergoz BPMs in SR01 and SR03 for 2-bunch (noisy at low currents) and drop singular values</span>
2929             <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
2930                     BPMlist1 = [
2931                          <span class="comment">%1 2</span>
2932                          1 5
2933                          1 6
2934                          1 10
2935                          2 1
2936                          2 5
2937                          2 6
2938                          <span class="comment">%2 9</span>
2939                          <span class="comment">%3 2</span>
2940                          3 5
2941                          3 6
2942                          3 10
2943                          3 11
2944                          3 12
2945                          4 1
2946                          4 5
2947                          4 6
2948                          4 10
2949                          5 1
2950                          5 5
2951                          5 6
2952                          5 10
2953                          5 11
2954                          5 12
2955                          6 1
2956                          6 5
2957                          6 6
2958                          6 10
2959                          7 1
2960                          7 5
2961                          7 6
2962                          7 10
2963                          8 1
2964                          8 5
2965                          8 6
2966                          8 10
2967                          9 1
2968                          9 5
2969                          9 6
2970                          9 10
2971                          10 1
2972                          10 5
2973                          10 6
2974                          10 10
2975                          10 11
2976                          10 12
2977                          11 1
2978                          11 5
2979                          11 6
2980                          11 10
2981                          12 1
2982                          12 5
2983                          12 6
2984                          <span class="comment">%12 9</span>
2985                          ];
2986             <span class="keyword">end</span>
2987 
2988             OCSx.BPM = getx(BPMlist1, <span class="string">'struct'</span>);
2989             OCSx.CM = getsp(<span class="string">'HCM'</span>, HCMlist1, <span class="string">'struct'</span>);
2990             OCSx.GoalOrbit = getgolden(OCSx.BPM, <span class="string">'numeric'</span>);
2991             OCSx.NIter = 1;
2992             OCSx.SVDIndex = Xivec;
2993             OCSx.IncrementalFlag = <span class="string">'No'</span>;
2994             OCSx.BPMWeight = {[]};
2995             OCSx.FitRF = 0;
2996             OCSy.BPM = gety(BPMlist1, <span class="string">'struct'</span>);
2997             OCSy.CM = getsp(<span class="string">'VCM'</span>, VCMlist1, <span class="string">'struct'</span>);
2998             OCSy.GoalOrbit = getgolden(OCSy.BPM, <span class="string">'numeric'</span>);
2999             OCSy.NIter = 1;
3000             OCSy.SVDIndex = Yivec;
3001             OCSy.IncrementalFlag = <span class="string">'No'</span>;
3002             OCSy.BPMWeight = {[]};
3003             OCSy.FitRF = 0;
3004             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
3005             <span class="comment">% do we need these Smat calls? %</span>
3006             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
3007             SXmat = getrespmat(OCSx.BPM, OCSx.CM, <span class="string">'numeric'</span>);
3008             SYmat = getrespmat(OCSy.BPM, OCSy.CM, <span class="string">'numeric'</span>);
3009             <span class="comment">% [OCSx, Sx, Ux, Vx] = orbitcorrectionmethods(OCSx, SXmat);</span>
3010             <span class="comment">% [OCSy, Sy, Uy, Vy] = orbitcorrectionmethods(OCSy, SYmat);</span>
3011 
3012             <span class="comment">% initialize FFTypeFlag</span>
3013             FFTypeFlag = <span class="string">'Global'</span>;
3014 
3015         <span class="keyword">else</span>
3016 
3017             <span class="comment">% Get vectors</span>
3018             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
3019             <span class="comment">% the two lines below seem to fix BPMlist editing problem</span>
3020             OCSx = FB.OCSx;
3021             OCSy = FB.OCSy;
3022             BPMlist1 = FB.BPMlist1;
3023             HCMlist1 = FB.HCMlist1;
3024             VCMlist1 = FB.VCMlist1;
3025             Xivec = FB.Xivec;
3026             Yivec = FB.Yivec;
3027             Xgoal = FB.OCSx.GoalOrbit;
3028             OCSx.GoalOrbit = Xgoal;
3029             Ygoal = FB.OCSy.GoalOrbit;
3030             OCSy.GoalOrbit = Ygoal;
3031             FFTypeFlag = FB.FFTypeFlag;
3032 
3033 
3034             <span class="comment">% FF corrector magnet list</span>
3035             ListFF = [
3036                 4     2
3037                 4     8
3038                 5     1
3039                 5     7
3040 <span class="comment">%               5     8 % why are these out???</span>
3041 <span class="comment">%               6     1 % why are these out???</span>
3042                 6     8
3043                 7     1
3044                 7     8
3045                 8     1
3046                 8     8
3047                 9     1
3048                 9     8
3049                 10    1
3050                 11    8
3051                 12    1];
3052             ElemFF = dev2elem(<span class="string">'HCM'</span>,ListFF);
3053 
3054 
3055             <span class="comment">% Add button to change #ivectors, cm, IDBPMs,</span>
3056             EditFlag = 0;
3057             h_fig1 = figure;
3058             <span class="keyword">while</span> EditFlag ~= 7
3059 
3060                 Sx = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
3061                 Sy = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
3062                 
3063                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
3064                     DispOrbit = getdisp(<span class="string">'BPMx'</span>, BPMlist1);
3065                     Sx = [Sx DispOrbit];
3066                 <span class="keyword">end</span>
3067                 
3068                 [Ux, SVx, Vx] = svd(Sx);
3069                 [Uy, SVy, Vy] = svd(Sy);
3070 
3071                 
3072                 <span class="comment">% Remove singular values greater than the actual number of singular values</span>
3073                 i = find(Xivec&gt;length(diag(SVx)));
3074                 <span class="keyword">if</span> ~isempty(i)
3075                     disp(<span class="string">'   Horizontal E-vector scaled since there were more elements in the vector than singular values.'</span>);
3076                     pause(0);
3077                     Xivec(i) = [];
3078                 <span class="keyword">end</span>
3079                 i = find(Yivec&gt;length(diag(SVy)));
3080                 <span class="keyword">if</span> ~isempty(i)
3081                     disp(<span class="string">'   Vertical E-vector scaled since there were more elements in the vector than singular values.'</span>);
3082                     pause(0);
3083                     Yivec(i) = [];
3084                 <span class="keyword">end</span>
3085 
3086 
3087                 Ax = Sx*Vx(:,Xivec);
3088                 Tx = inv(Ax'*Ax)*Ax';
3089 
3090                 Ay = Sy*Vy(:,Yivec);
3091                 Ty = inv(Ay'*Ay)*Ay';
3092 
3093                 figure(h_fig1);
3094                 subplot(2,1,1);
3095                 semilogy(diag(SVx),<span class="string">'b'</span>);
3096                 hold on;
3097                 semilogy(diag(SVx(Xivec,Xivec)),<span class="string">'xr'</span>);
3098                 ylabel(<span class="string">'Horizontal'</span>);
3099                 title(<span class="string">'Response Matrix Singular Values'</span>);
3100                 hold off;
3101                 subplot(2,1,2);
3102                 semilogy(diag(SVy),<span class="string">'b'</span>);
3103                 hold on;
3104                 semilogy(diag(SVy(Yivec,Yivec)),<span class="string">'xr'</span>);
3105                 xlabel(<span class="string">'Singular Value Number'</span>);
3106                 ylabel(<span class="string">'Vertical'</span>);
3107                 hold off;
3108                 drawnow;
3109 
3110                 EditFlag = menu(<span class="string">'Change Parameters?'</span>,<span class="string">'Singular Values'</span>,<span class="string">'HCM List'</span>,<span class="string">'VCM List'</span>, <span class="keyword">...</span>
3111                     <span class="string">'BPM List'</span>,<span class="string">'Change the Goal Orbit'</span>, <span class="keyword">...</span>
3112                     <span class="string">'Change Tune FF Method (nuy=9.2 only)'</span>,<span class="string">'Continue'</span>);
3113 
3114                 <span class="keyword">if</span> EditFlag == 1
3115                     prompt={<span class="string">'Enter the horizontal E-vector numbers (Matlab vector format):'</span>,<span class="string">'Enter the vertical E-vector numbers (Matlab vector format):'</span>};
3116                     def={sprintf(<span class="string">'[%d:%d]'</span>,1,Xivec(end)),sprintf(<span class="string">'[%d:%d]'</span>,1,Yivec(end))};
3117                     titlestr=<span class="string">'SVD Orbit Feedback'</span>;
3118                     lineNo=1;
3119                     answer=inputdlg(prompt,titlestr,lineNo,def);
3120                     <span class="keyword">if</span> ~isempty(answer)
3121                         XivecNew = fix(str2num(answer{1}));
3122                         <span class="keyword">if</span> isempty(XivecNew)
3123                             disp(<span class="string">'   Horizontal E-vector cannot be empty.  No change made.'</span>);
3124                         <span class="keyword">else</span>
3125                             <span class="keyword">if</span> any(XivecNew&lt;=0) | max(XivecNew)&gt;length(diag(SVx))
3126                                 disp(<span class="string">'   Error reading horizontal E-vector.  No change made.'</span>);
3127                             <span class="keyword">else</span>
3128                                 Xivec = XivecNew;
3129                             <span class="keyword">end</span>
3130                         <span class="keyword">end</span>
3131                         YivecNew = fix(str2num(answer{2}));
3132                         <span class="keyword">if</span> isempty(YivecNew)
3133                             disp(<span class="string">'   Vertical E-vector cannot be empty.  No change made.'</span>);
3134                         <span class="keyword">else</span>
3135                             <span class="keyword">if</span> any(YivecNew&lt;=0) | max(YivecNew)&gt;length(diag(SVy))
3136                                 disp(<span class="string">'   Error reading vertical E-vector.  No change made.'</span>);
3137                             <span class="keyword">else</span>
3138                                 Yivec = YivecNew;
3139                             <span class="keyword">end</span>
3140                         <span class="keyword">end</span>
3141                     <span class="keyword">end</span>
3142                 <span class="keyword">end</span>
3143 
3144                 <span class="keyword">if</span> EditFlag == 2
3145                     List= getlist(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>);
3146                     CheckList = zeros(96,1);
3147                     Elem = dev2elem(<span class="string">'HCM'</span>, HCMlist1);
3148                     CheckList(Elem) = ones(size(Elem));
3149                     CheckList = CheckList(dev2elem(<span class="string">'HCM'</span>,List));
3150 
3151                     <span class="comment">% Remove FF corrrectors</span>
3152                     <span class="comment">%           Elem = dev2elem('HCM',List);</span>
3153                     <span class="comment">%           for j = length(ElemFF):-1:1</span>
3154                     <span class="comment">%              i = find(Elem==ElemFF(j));</span>
3155                     <span class="comment">%              Elem(i,:) = [];</span>
3156                     <span class="comment">%              List(i,:) = [];</span>
3157                     <span class="comment">%              CheckList(i,:) = [];</span>
3158                     <span class="comment">%           end</span>
3159 
3160                     newList = editlist(List, <span class="string">'HCMtrim'</span>, CheckList);
3161 
3162                     <span class="keyword">if</span> isempty(newList)
3163                         fprintf(<span class="string">'   WARNING: Horizontal corrector magnet list is empty!\n'</span>);
3164                         HCMlist1 = newList;
3165                     <span class="keyword">else</span>
3166                         HCMlist1 = newList;
3167                     <span class="keyword">end</span>
3168                 <span class="keyword">end</span>
3169 
3170                 <span class="keyword">if</span> EditFlag == 3
3171                     List = getlist(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>);
3172                     CheckList = zeros(96,1);
3173                     Elem = dev2elem(<span class="string">'VCM'</span>, VCMlist1);
3174                     CheckList(Elem) = ones(size(Elem));
3175                     CheckList = CheckList(dev2elem(<span class="string">'VCM'</span>,List));
3176 
3177                     <span class="comment">% Remove FF corrrectors</span>
3178                     <span class="comment">%           Elem = dev2elem('VCM',List);</span>
3179                     <span class="comment">%           for j = length(ElemFF):-1:1</span>
3180                     <span class="comment">%              i = find(Elem==ElemFF(j));</span>
3181                     <span class="comment">%              Elem(i,:) = [];</span>
3182                     <span class="comment">%              List(i,:) = [];</span>
3183                     <span class="comment">%              CheckList(i,:) = [];</span>
3184                     <span class="comment">%           end</span>
3185 
3186                     newList = editlist(List, <span class="string">'VCMtrim'</span>, CheckList);
3187 
3188                     <span class="keyword">if</span> isempty(newList)
3189                         fprintf(<span class="string">'   WARNING: Vertical corrector magnet list is empty!\n'</span>);
3190                         VCMlist1 = newList;
3191                     <span class="keyword">else</span>
3192                         VCMlist1 = newList;
3193                     <span class="keyword">end</span>
3194                 <span class="keyword">end</span>
3195 
3196                 <span class="keyword">if</span> EditFlag == 4
3197                     ListOld = BPMlist1;
3198                     XgoalOld = Xgoal;
3199                     YgoalOld = Ygoal;
3200 
3201                     <span class="comment">% Full BPM list</span>
3202                     List = [
3203                         1 2
3204                         1 5
3205                         1 6
3206                         1 10
3207                         2 1
3208                         2 5
3209                         2 6
3210                         2 9
3211                         3 2
3212                         3 5
3213                         3 6
3214                         3 10
3215                         3 11
3216                         3 12
3217                         4 1
3218                         4 5
3219                         4 6
3220                         4 10
3221                         5 1
3222                         5 5
3223                         5 6
3224                         5 10
3225                         5 11
3226                         5 12
3227                         6 1
3228                         6 5
3229                         6 6
3230                         6 10
3231                         7 1
3232                         7 5
3233                         7 6
3234                         7 10
3235                         8 1
3236                         8 5
3237                         8 6
3238                         8 10
3239                         9 1
3240                         9 5
3241                         9 6
3242                         9 10
3243                         10 1
3244                         10 5
3245                         10 6
3246                         10 10
3247                         10 11
3248                         10 12
3249                         11 1
3250                         11 5
3251                         11 6
3252                         11 10
3253                         12 1
3254                         12 5
3255                         12 6
3256                         12 9
3257                         ];
3258 
3259 
3260                     CheckList = zeros(size(List,1),1);
3261                     <span class="keyword">if</span> ~isempty(BPMlist1)
3262                         <span class="keyword">for</span> i = 1:size(List,1)
3263                             k = find(List(i,1)==BPMlist1(:,1));
3264                             l = find(List(i,2)==BPMlist1(k,2));
3265 
3266                             <span class="keyword">if</span> isempty(k) | isempty(l)
3267                                 <span class="comment">% Item not in list</span>
3268                             <span class="keyword">else</span>
3269                                 CheckList(i) = 1;
3270                             <span class="keyword">end</span>
3271                         <span class="keyword">end</span>
3272                     <span class="keyword">end</span>
3273 
3274                     newList = editlist(List, <span class="string">'BPM'</span>, CheckList);
3275                     <span class="keyword">if</span> isempty(newList)
3276                         fprintf(<span class="string">'   BPM list cannot be empty.  No change made.\n'</span>);
3277                     <span class="keyword">else</span>
3278                         BPMlist1 = newList;
3279                     <span class="keyword">end</span>
3280 
3281                     <span class="comment">% Set the goal orbit to the golden orbit</span>
3282                     Xgoal = getgolden(<span class="string">'BPMx'</span>, BPMlist1);
3283                     Ygoal = getgolden(<span class="string">'BPMy'</span>, BPMlist1);
3284 
3285 
3286                     <span class="comment">% If a new BPM is added, then set the goal orbit to the golden orbit</span>
3287                     <span class="keyword">for</span> i = 1:size(BPMlist1,1)
3288 
3289                         <span class="comment">% Is it a new BPM?</span>
3290                         k = find(BPMlist1(i,1)==ListOld(:,1));
3291                         l = find(BPMlist1(i,2)==ListOld(k,2));
3292 
3293                         <span class="keyword">if</span> isempty(k) | isempty(l)
3294                             <span class="comment">% New BPM</span>
3295                         <span class="keyword">else</span>
3296                             <span class="comment">% Use the old value for old BPM</span>
3297                             Xgoal(i) = XgoalOld(k(l));
3298                             Ygoal(i) = YgoalOld(k(l));
3299                         <span class="keyword">end</span>
3300                     <span class="keyword">end</span>
3301                     OCSx.BPM.DeviceList = BPMlist1;
3302                     OCSy.BPM.DeviceList = BPMlist1;
3303                     OCSx.GoalOrbit = Xgoal;
3304                     OCSy.GoalOrbit = Ygoal;
3305                 <span class="keyword">end</span>
3306 
3307                 <span class="keyword">if</span> EditFlag == 5
3308                     ChangeList = editlist2(BPMlist1, <span class="string">'Change BPM'</span>, zeros(size(BPMlist1,1),1));
3309 
3310                     <span class="keyword">for</span> i = 1:size(ChangeList,1)
3311 
3312                         k = find(ChangeList(i,1)==BPMlist1(:,1));
3313                         l = find(ChangeList(i,2)==BPMlist1(k,2));
3314 
3315                         prompt={sprintf(<span class="string">'Enter the new horizontal goal orbit for BPMx(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2)),sprintf(<span class="string">'Enter the new vertical goal orbit for BPMy(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2))};
3316                         def={sprintf(<span class="string">'%f'</span>,Xgoal(k(l))),sprintf(<span class="string">'%f'</span>,Ygoal(k(l)))};
3317                         titlestr=<span class="string">'CHANGE THE GOAL ORBIT'</span>;
3318                         lineNo=1;
3319                         answer = inputdlg(prompt, titlestr, lineNo, def);
3320 
3321                         <span class="keyword">if</span> isempty(answer)
3322                             <span class="comment">% No change</span>
3323                             fprintf(<span class="string">'   No change was made to the golden orbit.\n'</span>);
3324                         <span class="keyword">else</span>
3325                             Xgoalnew = str2num(answer{1});
3326                             <span class="keyword">if</span> isempty(Xgoalnew)
3327                                 fprintf(<span class="string">'   No change was made to the horizontal golden orbit.\n'</span>);
3328                             <span class="keyword">else</span>
3329                                 Xgoal(k(l)) = Xgoalnew;
3330                             <span class="keyword">end</span>
3331 
3332                             Ygoalnew = str2num(answer{2});
3333                             <span class="keyword">if</span> isempty(Ygoalnew)
3334                                 fprintf(<span class="string">'   No change was made to the vertical golden orbit.\n'</span>);
3335                             <span class="keyword">else</span>
3336                                 Ygoal(k(l)) = Ygoalnew;
3337                             <span class="keyword">end</span>
3338                         <span class="keyword">end</span>
3339                     <span class="keyword">end</span>
3340                     <span class="keyword">if</span> ~isempty(ChangeList)
3341                         fprintf(<span class="string">'   Note:  Changing the goal orbit for &quot;Slow Orbit Feedback&quot; does not change the goal orbit for &quot;Orbit Correction.&quot;\n'</span>);
3342                         fprintf(<span class="string">'          Re-running srcontrol will restart the goal orbit to the golden orbit.&quot;\n'</span>);
3343                     <span class="keyword">end</span>
3344                     OCSx.GoalOrbit = Xgoal;
3345                     OCSy.GoalOrbit = Ygoal;
3346                 <span class="keyword">end</span>
3347 
3348                 <span class="keyword">if</span> EditFlag == 6
3349                     FFTypeFlag = questdlg(sprintf(<span class="string">'Do you want to use a fully local or a combined local/global compensation of IDs? (nuy=9.2 only)'</span>),<span class="string">'Tune FF'</span>,<span class="string">'Local'</span>,<span class="string">'Global'</span>, <span class="string">'Global'</span>);
3350                     <span class="keyword">if</span> strcmp(FFTypeFlag,<span class="string">'Local'</span>)
3351                         disp([<span class="string">'   The tune FF will use 8 local quadrupoles to compensate beta beating and tune shift'</span>]);
3352                         disp([<span class="string">'   from each ID.'</span>]);
3353                     <span class="keyword">elseif</span> strcmp(FFTypeFlag,<span class="string">'Global'</span>)
3354                         disp([<span class="string">'   The tune FF will use 4 local quadrupoles to compensate beta beating and all QF+QD'</span>]);
3355                         disp([<span class="string">'   to compensate tune shift from each ID.'</span>]);
3356                     <span class="keyword">end</span>
3357 
3358                 <span class="keyword">end</span>
3359 
3360             <span class="keyword">end</span>
3361             close(h_fig1);
3362         <span class="keyword">end</span>
3363 
3364         <span class="comment">% Save vectors</span>
3365         FB.Xivec = Xivec;
3366         FB.Yivec = Yivec;
3367         FB.HCMlist1 = HCMlist1;
3368         FB.VCMlist1 = VCMlist1;
3369         FB.BPMlist1 = BPMlist1;
3370 
3371         OCSx.SVDIndex = Xivec;
3372         OCSy.SVDIndex = Yivec;
3373         FB.OCSx = OCSx;
3374         FB.OCSy = OCSy;
3375 
3376         FB.FFTypeFlag = FFTypeFlag;
3377         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>,FB);
3378 
3379 
3380     <span class="keyword">case</span> <span class="string">'FastFeedbackSetup'</span>
3381 
3382         InitFlag = Input2;
3383 
3384         <span class="keyword">if</span> InitFlag
3385             FOFBFreq = 1000;
3386             <span class="comment">% user operations 9/14-10/17/04: P=0.5, I=120, D=0.0015 (for both planes)</span>
3387             <span class="comment">% below are known good values for user ops as of 8-1-05</span>
3388             HorP = 2;
3389             HorI = 300;
3390             HorD = 0.002;
3391             VertP = 1;
3392             VertI = 100;
3393             VertD = 0.0015;
3394 
3395             <span class="comment">% this initial set is now done in hwinit.m because it's not a good idea to set anything when srcontrol is launched</span>
3396             <span class="comment">% try</span>
3397             <span class="comment">%     setsp('SR01____FFBFREQAC00', FOFBFreq); % set freq</span>
3398             <span class="comment">%     write_pid_ffb2_patch(HorP, HorI, HorD, VertP, VertI, VertD);</span>
3399             <span class="comment">% catch</span>
3400             <span class="comment">%     disp('   Trouble setting Fast Orbit Feedback parameters!');</span>
3401             <span class="comment">% end</span>
3402 
3403         <span class="keyword">else</span>
3404             <span class="comment">% Get vectors</span>
3405             FOFB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
3406             FOFBFreq = FOFB.FOFBFreq;
3407             HorP  = FOFB.HorP;
3408             HorI  = FOFB.HorI;
3409             HorD  = FOFB.HorD;
3410             VertP = FOFB.VertP;
3411             VertI = FOFB.VertI;
3412             VertD = FOFB.VertD;
3413 
3414             <span class="comment">% Add button to change #ivectors, CMs, IDBPMs,</span>
3415             EditFlag = 0;
3416             <span class="comment">%h_fig1 = figure;</span>
3417             <span class="keyword">while</span> EditFlag ~= 3
3418 
3419                 <span class="comment">%EditFlag = menu('Change Parameters?', 'Fast Feedback Frequency', 'PID Values', 'HCM List', 'VCM List', ...</span>
3420                 <span class="comment">%   'IDBPM List', 'BBPM List', 'Continue');</span>
3421                 <span class="comment">% Use menu below until other FFB config routines work (then also uncomment options 3,4,5,6 below)</span>
3422                 EditFlag = menu(<span class="string">'Change Parameters?'</span>, <span class="string">'Fast Feedback Frequency'</span>, <span class="string">'PID Values'</span>, <span class="string">'Continue'</span>);
3423 
3424                 <span class="keyword">if</span> EditFlag == 1
3425                     <span class="comment">% change rate</span>
3426 
3427                     prompt={<span class="string">'Enter the desired Fast Feedback Frequency (1-1000 Hz)'</span>};
3428                     def={num2str(FOFBFreq)};
3429                     titlestr=<span class="string">'Fast Feedback Setup'</span>;
3430                     lineNo=1;
3431                     answer=inputdlg(prompt,titlestr,lineNo,def);
3432                     <span class="keyword">if</span> ~isempty(answer)
3433                         FOFBFreq = fix(str2num(answer{1}));
3434                         <span class="keyword">if</span> isempty(FOFBFreq)
3435                             disp(<span class="string">'   Frequency value cannot be empty.  No change made.'</span>);
3436                             FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3437                         <span class="keyword">else</span>
3438                             <span class="keyword">if</span> FOFBFreq &lt; 1 | FOFBFreq &gt; 1000
3439                                 disp(<span class="string">'   Frequency must be between 1 and 1000 Hz.  No change made.'</span>);
3440                                 FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3441                             <span class="keyword">end</span>
3442                         <span class="keyword">end</span>
3443                         setsp(<span class="string">'SR01____FFBFREQAC00'</span>,FOFBFreq   ); <span class="comment">% change freq</span>
3444                         pause(0.5);
3445                         fprintf(<span class="string">'   Fast orbit feedback frequency is running at %.0f Hz.\n'</span>, getpv(<span class="string">'SR01____FFBFREQAM00'</span>));
3446                     <span class="keyword">else</span>
3447                         FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3448                     <span class="keyword">end</span>
3449                 <span class="keyword">end</span>
3450 
3451                 <span class="keyword">if</span> EditFlag == 2
3452                     <span class="comment">% edit  PIDs</span>
3453                     <span class="comment">% User defaults are HorP=2, HorI=300, HorD=0.002, VertP=1, VertI=100, VertD=0.0015</span>
3454                     prompt={<span class="string">'P horizontal'</span>, <span class="string">'I horizontal'</span>, <span class="string">'D horizontal'</span>, <span class="string">'P vertical'</span>, <span class="string">'I vertical'</span>, <span class="string">'D vertical'</span>};
3455                     def={num2str(HorP), num2str(HorI), num2str(HorD), num2str(VertP), num2str(VertI), num2str(VertD)};
3456                     titlestr=<span class="string">'Fast Feedback PID Setup'</span>;
3457                     lineNo=1;
3458                     answer=inputdlg(prompt,titlestr,lineNo,def);
3459                     <span class="keyword">if</span> ~isempty(answer)
3460                         HorPnewnum = str2num(answer{1});
3461                         <span class="keyword">if</span> isempty(HorPnewnum)
3462                             disp(<span class="string">'   HorP value cannot be empty.  No change made.'</span>);
3463                         <span class="keyword">else</span>
3464                             HorP = HorPnewnum;
3465                         <span class="keyword">end</span>
3466                         HorInewnum = str2num(answer{2});
3467                         <span class="keyword">if</span> isempty(HorInewnum)
3468                             disp(<span class="string">'   HorI value cannot be empty.  No change made.'</span>);
3469                         <span class="keyword">else</span>
3470                             HorI = HorInewnum;
3471                         <span class="keyword">end</span>
3472                         HorDnewnum = str2num(answer{3});
3473                         <span class="keyword">if</span> isempty(HorDnewnum)
3474                             disp(<span class="string">'   HorD value cannot be empty.  No change made.'</span>);
3475                         <span class="keyword">else</span>
3476                             HorD = HorDnewnum;
3477                         <span class="keyword">end</span>
3478                         VertPnewnum = str2num(answer{4});
3479                         <span class="keyword">if</span> isempty(VertPnewnum)
3480                             disp(<span class="string">'   VertP value cannot be empty.  No change made.'</span>);
3481                         <span class="keyword">else</span>
3482                             VertP = VertPnewnum;
3483                         <span class="keyword">end</span>
3484                         VertInewnum = str2num(answer{5});
3485                         <span class="keyword">if</span> isempty(VertInewnum)
3486                             disp(<span class="string">'   VertI value cannot be empty.  No change made.'</span>);
3487                         <span class="keyword">else</span>
3488                             VertI = VertInewnum;
3489                         <span class="keyword">end</span>
3490                         VertDnewnum = str2num(answer{6});
3491                         <span class="keyword">if</span> isempty(VertDnewnum)
3492                             disp(<span class="string">'   VertD value cannot be empty.  No change made.'</span>);
3493                         <span class="keyword">else</span>
3494                             VertD = VertDnewnum;
3495                         <span class="keyword">end</span>
3496 
3497                         <span class="keyword">try</span>
3498                             write_pid_ffb2_patch(HorP, HorI, HorD, VertP, VertI, VertD);
3499                             fprintf(<span class="string">'   Setting FFB gains to Horizontal P=%.2f, I=%.1f, D=%.4f;  Vertical P=%.2f, I=%.1f, D=%.4f\n'</span>, HorP, HorI, HorD, VertP, VertI, VertD);
3500                         <span class="keyword">catch</span>
3501                             disp(<span class="string">'   Trouble setting Fast Orbit Feedback parameters!'</span>);
3502                         <span class="keyword">end</span>
3503                     <span class="keyword">end</span>
3504                 <span class="keyword">end</span>
3505 
3506                 <span class="comment">%if EditFlag == 3</span>
3507                 <span class="comment">%   disp('   This function not yet available.');</span>
3508                 <span class="comment">%   % change HCM List</span>
3509                 <span class="comment">%end</span>
3510                 <span class="comment">%</span>
3511                 <span class="comment">%if EditFlag == 4</span>
3512                 <span class="comment">%   disp('   This function not yet available.');</span>
3513                 <span class="comment">%   % change VCM List</span>
3514                 <span class="comment">%end</span>
3515                 <span class="comment">%</span>
3516                 <span class="comment">%if EditFlag == 5</span>
3517                 <span class="comment">%   disp('   This function not yet available.');</span>
3518                 <span class="comment">%   % change IDBPM List</span>
3519                 <span class="comment">%end</span>
3520                 <span class="comment">%</span>
3521                 <span class="comment">%if EditFlag == 6</span>
3522                 <span class="comment">%   disp('   This function not yet available.');</span>
3523                 <span class="comment">%   % change BBPM List</span>
3524                 <span class="comment">%end</span>
3525 
3526             <span class="keyword">end</span>
3527             <span class="comment">%close(h_fig1);</span>
3528         <span class="keyword">end</span>
3529 
3530         <span class="comment">% Save vectors</span>
3531         FOFB.FOFBFreq = FOFBFreq;
3532         FOFB.HorP = HorP;
3533         FOFB.HorI = HorI;
3534         FOFB.HorD = HorD;
3535         FOFB.VertP = VertP;
3536         FOFB.VertI = VertI;
3537         FOFB.VertD = VertD;
3538         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Userdata'</span>,FOFB);
3539 
3540     <span class="keyword">otherwise</span>
3541         fprintf(<span class="string">'   No action for %s.\n'</span>, action);
3542 <span class="keyword">end</span>   <span class="comment">% end case</span></pre></div>
<hr><address>Generated on Thu 02-Aug-2007 13:16:07 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>