<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of srcontrol5_with_chicane_checks</title>
  <meta name="keywords" content="srcontrol5_with_chicane_checks">
  <meta name="description" content="srcontrol5">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">ALS</a> &gt; <a href="index.html">StorageRing</a> &gt; srcontrol5_with_chicane_checks.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for ALS\StorageRing&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>srcontrol5_with_chicane_checks
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>srcontrol5</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function srcontrol5(action, Input2, Input3) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> srcontrol5
 Storage ring control program

 This program controls all storage ring magnets, performs orbit feedback and
 tune feedforward and helps to diagnose problems in routine user operation
 of the ALS storage ring. It includes a gui to simplify the use of this
 program.

 It was originally programmed by Greg Portmann (until December 2000) with input
 from Winfried Decking, David Robin, Christoph Steier, Ying Wu and others
 and is currently (July 2002) maintained by Christoph Steier and Tom Scarvie.

 The actual version of this program is srcontrol5 (is called by default if you call srcontrol).

 Christoph Steier, July 2002

 SRCONTROL5 is the newest versionof SRCONTROL, edited to work with G. Portmann's new (2005) Matlab middle layer.

 Tom Scarvie, April 2005</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="amp2k.html" class="code" title="function [k, B] = amp2k(Family, Field, Amps, DeviceList, Energy, BranchFlag)">amp2k</a>	AMP2K - Converts amperes to simulator values</li><li><a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>	BEND2GEV - Compute the energy based on the ramp tables</li><li><a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>	CHECKSRMAGS - Check SR power supplies against a lattice file</li><li><a href="checksrorbit.html" class="code" title="function ErrorNums = checksrorbit(SectorList, BPMxtol,BPMytol)">checksrorbit</a>	ErrorNums =checksrorbit(Sector, BPMxtolerance [.015 mm], [BPMytolerance [.015 mm]])</li><li><a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>	GAP2TUNE - Computes the vertical tune shift for a insertion device gap change.</li><li><a href="gaplimit.html" class="code" title="function [GAPmin, GAPmax] = gaplimit(Dev);">gaplimit</a>	[GapMin, GapMax] = gaplimit(ID_Number);</li><li><a href="getbpmlist.html" class="code" title="function [DeviceList, Index] = getbpmlist(varargin)">getbpmlist</a>	GETBPMLIST - Return a BPM list based on key words and sector numbers</li><li><a href="getbpmtimeconstant.html" class="code" title="function [BPMTimeConstant, WarningFlag] = getbpmtimeconstant(varargin)">getbpmtimeconstant</a>	GETBPMTIMECONSTANT - Sets the timeconstants for the Bergoz style BPMs.</li><li><a href="getff.html" class="code" title="function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)">getff</a>	function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)</li><li><a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>	GETID - Get the insertion device position, velocity, run flag, and user requested gap</li><li><a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>	[StateNumber, StateString] = getsrstate</li><li><a href="ocsinit.html" class="code" title="function [HBPM, VBPM, HCM, VCM, HSV, VSV] = ocsinit(MethodName)">ocsinit</a>	OCSINIT - Corrector and BPM</li><li><a href="set_alarmhandler_AHU_thresholds_inject.html" class="code" title="function set_alarmhandler_AHU_thresholds_inject">set_alarmhandler_AHU_thresholds_inject</a>	function set_alarmhandler_AHU_thresholds_inject</li><li><a href="set_alarmhandler_thresholds.html" class="code" title="function set_alarmhandler_thresholds">set_alarmhandler_thresholds</a>	set_alarmhandler_thresholds</li><li><a href="set_alarmhandler_thresholds_new.html" class="code" title="function set_alarmhandler_thresholds_new">set_alarmhandler_thresholds_new</a>	set_alarmhandler_thresholds_new</li><li><a href="set_etaywave_nuy9_20skews_skewFF.html" class="code" title="function [SQSFincr, SQSDincr] = set_etaywave_nuy9_20skews_skewFF(scale);">set_etaywave_nuy9_20skews_skewFF</a>	function [SQSFincr, SQSDincr] = set_etaywave_nuy9_20skews_skewFF(scale);</li><li><a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>	SETBPMTIMECONSTANT - Sets the timeconstants for the Bergoz style BPMs.</li><li><a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>	SETBUMPS - Make a straight section bump</li><li><a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>	function setff(Sector, FFEnableBC, GapEnableBC)</li><li><a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>	SETID - Set the insertion device vertical gap</li><li><a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>	</li><li><a href="srcycle.html" class="code" title="function FailFlag = srcycle(varargin)">srcycle</a>	SRCYCLE - Storage ring cycle</li><li><a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>	SRRAMP - Ramp the storage ring energy</li><li><a href="write_goldenorbit_ffb.html" class="code" title="function write_goldenorbit_ffb">write_goldenorbit_ffb</a>	function write_goldenorbit_ffb</li><li><a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>	WRITE_GOLDENORBIT_FFTB_2PLANES - Sets the BPM setpoints which are used by the fast feedback system</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function srcontrol5(action, Input2, Input3)</a>
0002 <span class="comment">% srcontrol5</span>
0003 <span class="comment">% Storage ring control program</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% This program controls all storage ring magnets, performs orbit feedback and</span>
0006 <span class="comment">% tune feedforward and helps to diagnose problems in routine user operation</span>
0007 <span class="comment">% of the ALS storage ring. It includes a gui to simplify the use of this</span>
0008 <span class="comment">% program.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% It was originally programmed by Greg Portmann (until December 2000) with input</span>
0011 <span class="comment">% from Winfried Decking, David Robin, Christoph Steier, Ying Wu and others</span>
0012 <span class="comment">% and is currently (July 2002) maintained by Christoph Steier and Tom Scarvie.</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% The actual version of this program is srcontrol5 (is called by default if you call srcontrol).</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% Christoph Steier, July 2002</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% SRCONTROL5 is the newest versionof SRCONTROL, edited to work with G. Portmann's new (2005) Matlab middle layer.</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% Tom Scarvie, April 2005</span>
0021 
0022 <span class="comment">% known bugs/problems (May 2001):</span>
0023 <span class="comment">% - IDBPM averaging might be a bit too long for orbit feedback</span>
0024 <span class="comment">%        solved after Superbend shutdown ... Instead of averaging, digital low pass filters are used</span>
0025 <span class="comment">% - gap2tune does not give correct answers for wiggler and potentially other IDs -&gt; orbit feedback</span>
0026 <span class="comment">%        seems to be OK for other IDs, has been corrected for wiggler (fit to insertion device</span>
0027 <span class="comment">%        compensation table)</span>
0028 <span class="comment">% - chicanes do not work in orbit feedback</span>
0029 <span class="comment">%        solved. One problem was that orbit response matrizes were mis-scaled by factor of two.</span>
0030 <span class="comment">%        Second problem was different time constant of power supply control. Solved by moving controls</span>
0031 <span class="comment">%        of center chicanes to cPCI (and magnets are fast, hysteresis free, aircore coils).</span>
0032 <span class="comment">%        Center chicane in sector 4 is now routinely used in orbit feedback. Sector 11 to follow soon.</span>
0033 <span class="comment">% - zero reading of ID gap dumps beam</span>
0034 <span class="comment">%        solved in srcontrol5, still a problem in srcontrol5_hightune (but that routine has to be completely</span>
0035 <span class="comment">%        rewritten because of all recent changes to srcontrol5, anyhow). For gap readings below the minimum</span>
0036 <span class="comment">%        allowed gap for a device, the tune feedforward disables itself.</span>
0037 <span class="comment">% - cycling of lattice causes frequent power supply failures</span>
0038 <span class="comment">%        solved by changing the cycling procedure. 1.5 GeV operation is now on the upper hysteresis branch</span>
0039 <span class="comment">%        as was the 1.9 GeV injection lattice before.</span>
0040 <span class="comment">% - frequently stalled data in IDBPM readout</span>
0041 <span class="comment">%        solved with new BPM readouts and digital filtering. Seems to have been a resolution problem</span>
0042 <span class="comment">%        of the digital averaging algorithm.</span>
0043 <span class="comment">% - magnet ramp tables are not in perfect agreement with magnetic measurements</span>
0044 <span class="comment">%        Does not appear to be a serious problem. Superbends are slightly out of sync with other magnets,</span>
0045 <span class="comment">%        but this does not cause any negative effects while ramping.</span>
0046 <span class="comment">% - no good way to operate with injection at 1.5 GeV and storage energy below that</span>
0047 <span class="comment">%        There now is a reasonable way to inject at 1.5 GeV and ramp down to lower storage energy. But</span>
0048 <span class="comment">%        it has to be tested again after implementing new (and more) chicanes ...</span>
0049 
0050 <span class="comment">% revision history</span>
0051 <span class="comment">% 2001-05-10, Christoph Steier</span>
0052 <span class="comment">% check whether readback from insertion device is significantly (more than 1 mm) below minimum</span>
0053 <span class="comment">% gap, to avoid false zero readings of insertion device gaps to cause the tune feed forward</span>
0054 <span class="comment">% to implement false huge correction (and dump the beam). If the insertion device gap readbacks</span>
0055 <span class="comment">% gets more than 1 mm below the nominal minimum gap, the routine now assumes the insertion device</span>
0056 <span class="comment">% to be open.</span>
0057 <span class="comment">%</span>
0058 <span class="comment">% 2001-08-30 and during Superbend commissioning, Christoph Steier, Tom Scarvie, Winni Decking</span>
0059 <span class="comment">% various changes have been made to incorporate the Superbends and some other new equipment</span>
0060 <span class="comment">% installed in the Superbend shutdown. This included some changes to programs being called by srcontrol</span>
0061 <span class="comment">% (like srload, srsave, srcycle, srramp, ...). The main changes within srcontrol were in the orbit</span>
0062 <span class="comment">% correction and slow orbit feedback routines (incorporating frequency feedback, ...)</span>
0063 <span class="comment">%</span>
0064 <span class="comment">% 2002-05-04, Christoph Steier</span>
0065 <span class="comment">% added new IDBPMs, modified orbit feedback to use trim DACs, removed LSB toggling in vertical</span>
0066 <span class="comment">% orbit feedback, ...</span>
0067 <span class="comment">%</span>
0068 
0069 <span class="comment">% 2002-07-29, T.Scarvie</span>
0070 <span class="comment">% added check of CM trim currents to warn of problems that might rail the orbit feedback</span>
0071 <span class="comment">%</span>
0072 <span class="comment">% 2002-07-31, Christoph Steier</span>
0073 <span class="comment">% increased the gain of the RF frequency feedback from 1/50 of the gain of the horizontal</span>
0074 <span class="comment">% orbit feedback to 1/20. Reason was that the frequency feedback was reacting a bit too slow if all</span>
0075 <span class="comment">% insertion device gaps are closed at once at high speed at the beginning of a fill.</span>
0076 <span class="comment">%</span>
0077 <span class="comment">% 2002-08-05, C.Steier, T.Scarvie</span>
0078 <span class="comment">% Added conditional to reduce orbit feedback gain if running in two-bunch mode</span>
0079 <span class="comment">%</span>
0080 <span class="comment">% 2003-06-02, T.Scarvie</span>
0081 <span class="comment">% Added loop inside orbit feedback to reset the SR11 chicane M1 and M2 motors every 20s to combat drift problem</span>
0082 <span class="comment">%</span>
0083 <span class="comment">% 2003-06-18, C. Steier</span>
0084 <span class="comment">% Disabled loop to periodically reset chicane in SR11. Al Robb replaced power supply, seems to be no problem anymore.</span>
0085 <span class="comment">%</span>
0086 <span class="comment">% 2004-05-10, C. Steier</span>
0087 <span class="comment">% The list of all BBPMs is now set up automatically be calling getlist('BBPMx'). This way, new BBPMs have to be added</span>
0088 <span class="comment">% at fewer places in the software. It should now be sufficient to modify getlist and run the orbit response matrix</span>
0089 <span class="comment">% rountine (getsmat) once to enable use of the new BBPMs.</span>
0090 <span class="comment">%</span>
0091 <span class="comment">% 2004-05-14, C. Steier</span>
0092 <span class="comment">% Modified parameters for ramprate reduction (in srramp and here). Previous parameters were slightly too</span>
0093 <span class="comment">% cautious. Increased initial slow ramprate to 0.4 A/s.</span>
0094 <span class="comment">%</span>
0095 <span class="comment">% 2004-05-14, C. Steier</span>
0096 <span class="comment">% Incorporated insertion device compensation schemes for nu_y = 9.2 lattice.</span>
0097 <span class="comment">%</span>
0098 <span class="comment">% 2004-06-14, T.Scarvie</span>
0099 <span class="comment">% Added controls for fast orbit feedback</span>
0100 <span class="comment">%</span>
0101 <span class="comment">% 2004-06-21, C. Steier</span>
0102 <span class="comment">% Added tune feedforward (in the global tune compensation scheme for the nu_y=9.2 lattice) for the shift</span>
0103 <span class="comment">% dependent tune shift of the EPUs, as well as a skew quadrupole feedforward for the EPU im sector 11</span>
0104 <span class="comment">% (both only active in parallel mode so far).</span>
0105 <span class="comment">%</span>
0106 <span class="comment">% 2005-02-13, T.Scarvie</span>
0107 <span class="comment">% Separated horizontal and vertical planes for setting Fast Feedback PIDs</span>
0108 
0109 
0110 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0111 <span class="comment">% NOTES for conversion to new Middle Layer %</span>
0112 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0113 <span class="comment">%</span>
0114 <span class="comment">% We never use the gap and bump control flags - the radio buttons have been disabled -</span>
0115 <span class="comment">%        should we try to keep the functionality?</span>
0116 <span class="comment">%</span>
0117 <span class="comment">% checksrmags</span>
0118 <span class="comment">% checksrorbit(...)</span>
0119 
0120 
0121 <span class="comment">% For the compiler</span>
0122 <span class="comment">%#function goldenpage</span>
0123 <span class="comment">%#function setoperationalmode</span>
0124 
0125 
0126 <span class="comment">% Check if the AO exists</span>
0127 checkforao;
0128 
0129 
0130 <span class="comment">%%%%%%%%%%%%%%</span>
0131 <span class="comment">% Initialize %</span>
0132 <span class="comment">%%%%%%%%%%%%%%</span>
0133 
0134 <span class="keyword">global</span> FEEDBACK_STOP_FLAG
0135 
0136 SR_Mode = getfamilydata(<span class="string">'OperationalMode'</span>);
0137 SR_GEV = getfamilydata(<span class="string">'Energy'</span>);
0138 
0139 BSCramprate = getfamilydata(<span class="string">'BSCRampRate'</span>);
0140 <span class="keyword">if</span> isnan(BSCramprate) | isempty(BSCramprate)
0141     BSCramprate = 0.4;
0142     setfamilydata(BSCramprate, <span class="string">'BSCRampRate'</span>);
0143 <span class="keyword">end</span>
0144 
0145 <span class="keyword">if</span> nargin &lt; 1
0146     action = <span class="string">'Initialize'</span>;
0147 <span class="keyword">end</span>
0148 <span class="keyword">if</span> nargin &lt; 2
0149     Input2 = 0;
0150 <span class="keyword">end</span>
0151 <span class="keyword">if</span> nargin &lt; 3
0152     Input3 = 0;
0153 <span class="keyword">end</span>
0154 
0155 <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
0156     FOFBcheckboxVal = 0;
0157 <span class="keyword">else</span>
0158     FOFBcheckboxVal = 1;
0159 <span class="keyword">end</span>
0160 
0161 <span class="comment">%%%%%%%%%%%%%%%%</span>
0162 <span class="comment">% Main Program %</span>
0163 <span class="comment">%%%%%%%%%%%%%%%%</span>
0164 
0165 <span class="keyword">switch</span>(action)
0166 
0167     <span class="keyword">case</span> <span class="string">'StopOrbitFeedback'</span>
0168 
0169         FEEDBACK_STOP_FLAG = 1;
0170 
0171     <span class="keyword">case</span> <span class="string">'Initialize'</span>
0172 
0173         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0174         <span class="comment">% GUI</span>
0175         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0176         ButtonWidth = 200;
0177         ButtonHeight  = 25;
0178 
0179         Offset1 = 8*25+12 + 47 + 25+25;
0180         Offset2 = 47+25+25;
0181         Offset3 = 45+25;
0182         Offset4 = 1;
0183         Offset5 = 30;
0184         FigWidth = ButtonWidth+6;
0185         FigHeight  = 3+9*(ButtonHeight+6)+24+Offset1;
0186         ButtonWidth = 200-6;
0187 
0188         <span class="comment">% Change figure position</span>
0189         set(0,<span class="string">'Units'</span>,<span class="string">'pixels'</span>);
0190         p=get(0,<span class="string">'screensize'</span>);
0191 
0192         h0 = figure( <span class="keyword">...</span>
0193             <span class="string">'Color'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0194             <span class="string">'HandleVisibility'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0195             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0196             <span class="string">'MenuBar'</span>,<span class="string">'none'</span>, <span class="keyword">...</span>
0197             <span class="string">'Name'</span>,<span class="string">'ALS SR CONTROL'</span>, <span class="keyword">...</span>
0198             <span class="string">'NumberTitle'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0199             <span class="string">'Units'</span>,<span class="string">'pixels'</span>, <span class="keyword">...</span>
0200             <span class="string">'Position'</span>,[30 p(4)-FigHeight-40 FigWidth FigHeight+Offset5], <span class="keyword">...</span>
0201             <span class="string">'Resize'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0202             <span class="string">'Tag'</span>,<span class="string">'SRCTRLFig1'</span>);
0203 
0204         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0205             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0206             <span class="string">'Callback'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0207             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0208             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0209             <span class="string">'FontWeight'</span>,<span class="string">'Bold'</span>, <span class="keyword">...</span>
0210             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0211             <span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>, <span class="keyword">...</span>
0212             <span class="string">'Position'</span>,[6 3+8*(ButtonHeight+3)+19+19+8+Offset1  ButtonWidth 20+Offset5], <span class="keyword">...</span>
0213             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0214             <span class="string">'String'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0215             <span class="string">'Tag'</span>,<span class="string">'SRCTRLTitle'</span>);
0216 
0217         <span class="comment">% Frame Box I</span>
0218         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0219             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0220             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0221             <span class="string">'Position'</span>,[3 3+3*(ButtonHeight+3)+Offset1-3+Offset5 ButtonWidth+6 7*ButtonHeight+18], <span class="keyword">...</span>
0222             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0223 
0224         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0225             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0226             <span class="string">'Callback'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0227             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0228             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0229             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0230             <span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>, <span class="keyword">...</span>
0231             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)+Offset1  ButtonWidth 15+Offset5], <span class="keyword">...</span>
0232             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0233             <span class="string">'String'</span>,<span class="string">'Lattice Setup Functions'</span>);
0234 
0235         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0236             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Cycle'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0237             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0238             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0239             <span class="string">'Position'</span>,[6 3+8*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0240             <span class="string">'String'</span>,<span class="string">'Cycle SR Lattice'</span>, <span class="keyword">...</span>
0241             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>);
0242 
0243         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0244             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Injection'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0245             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0246             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0247             <span class="string">'Position'</span>,[6 3+7*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0248             <span class="string">'String'</span>,<span class="string">'Injection'</span>, <span class="keyword">...</span>
0249             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>);
0250 
0251         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0252             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Production'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0253             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0254             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0255             <span class="string">'Position'</span>,[6 3+6*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0256             <span class="string">'String'</span>,[<span class="string">'Production'</span>], <span class="keyword">...</span>
0257             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>);
0258 
0259         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0260             <span class="string">'Callback'</span>,[<span class="keyword">...</span>
0261             <span class="string">'fprintf(''\n'');'</span> <span class="keyword">...</span>
0262             <span class="string">'disp([''   **********************************************'']);'</span>, <span class="keyword">...</span>
0263             <span class="string">'disp([''   **  Changing Storage Ring Operational Mode  **'']);'</span>, <span class="keyword">...</span>
0264             <span class="string">'disp([''   **********************************************'']);'</span>, <span class="keyword">...</span>
0265             <span class="string">'setoperationalmode;'</span>, <span class="keyword">...</span>
0266             <span class="string">'srcontrol5(''CheckInputs'');'</span>, <span class="keyword">...</span>
0267             <span class="string">'disp([''   ****************************'']);'</span>, <span class="keyword">...</span>
0268             <span class="string">'disp([''   **  Mode Change Complete  **'']);'</span>, <span class="keyword">...</span>
0269             <span class="string">'disp([''   ****************************'']);'</span>, <span class="keyword">...</span>
0270             <span class="string">'fprintf(''\n'');'</span>], <span class="keyword">...</span>
0271             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0272             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0273             <span class="string">'Position'</span>,[6 3+5*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0274             <span class="string">'Value'</span>,1, <span class="keyword">...</span>
0275             <span class="string">'String'</span>,<span class="string">'Change Operational Mode'</span>, <span class="keyword">...</span>
0276             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>);
0277 
0278         h1 = uicontrol(<span class="keyword">...</span>
0279             <span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0280             <span class="string">'Callback'</span>, [<span class="keyword">...</span>
0281             <span class="string">'srcontrol5(''CheckInputs'');'</span>,<span class="keyword">...</span>
0282             <span class="string">'srcontrol5(''SRState'');'</span>], <span class="keyword">...</span>
0283             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0284             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0285             <span class="string">'Position'</span>,[6 3+4*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0286             <span class="string">'String'</span>,<span class="string">'Check For Problems'</span>, <span class="keyword">...</span>
0287             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>);
0288 
0289         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0290             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs''); goldenpage;'</span>, <span class="keyword">...</span>
0291             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0292             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0293             <span class="string">'Position'</span>,[6 3+3*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0294             <span class="string">'String'</span>,<span class="string">'Golden Page'</span>, <span class="keyword">...</span>
0295             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>);
0296 
0297 
0298         <span class="comment">% Frame Box II</span>
0299         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0300             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0301             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0302             <span class="string">'Position'</span>,[3 3+9*(ButtonHeight+3)-29+Offset2+Offset5 ButtonWidth+6 2*ButtonHeight+15], <span class="keyword">...</span>
0303             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0304         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0305             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0306             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0307             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0308             <span class="string">'Position'</span>,[6 3+10*(ButtonHeight+3)-10+Offset2 ButtonWidth .6*ButtonHeight+Offset5], <span class="keyword">...</span>
0309             <span class="string">'String'</span>,<span class="string">'Global/Local Orbit Correction'</span>, <span class="keyword">...</span>
0310             <span class="string">'Style'</span>,<span class="string">'text'</span>);
0311         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0312             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''OrbitCorrection'');'</span>, <span class="keyword">...</span>
0313             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0314             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0315             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)-6+Offset2+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0316             <span class="string">'String'</span>,<span class="string">'Correct Global Orbit w/ IDBPMs'</span>, <span class="keyword">...</span>
0317             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>);
0318         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0319             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''OrbitCorrectionSetup'',1);'</span>, <span class="keyword">...</span>
0320             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''OrbitCorrectionSetup'',0);'</span>, <span class="keyword">...</span>
0321             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0322             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0323             <span class="string">'Position'</span>,[6 9*(ButtonHeight+3)-22+Offset2+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0324             <span class="string">'String'</span>,<span class="string">'Edit IDBPM, CM, &amp; Local Bump Lists'</span>, <span class="keyword">...</span>
0325             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0326             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0327             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>);
0328 
0329 
0330         <span class="comment">% Frame Box III</span>
0331         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0332             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0333             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0334             <span class="string">'Position'</span>,[3 1*(ButtonHeight)+Offset3+Offset5-38 ButtonWidth+6 8*ButtonHeight+61], <span class="keyword">...</span>
0335             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0336         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0337             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0338             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0339             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0340             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)+Offset3-25 ButtonWidth .55*ButtonHeight+Offset5], <span class="keyword">...</span>
0341             <span class="string">'String'</span>,<span class="string">'Orbit Feedback'</span>, <span class="keyword">...</span>
0342             <span class="string">'Style'</span>,<span class="string">'text'</span>);
0343 
0344         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0345             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0346             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0347             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0348             <span class="string">'Position'</span>,[26 3+8*(ButtonHeight+3)+Offset3-18+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0349             <span class="string">'String'</span>,<span class="string">'Slow Orbit Correction'</span>, <span class="keyword">...</span>
0350             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0351             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0352             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxSOFB'</span>);
0353         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0354             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0355             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0356             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0357             <span class="string">'Position'</span>,[26 3+7*(ButtonHeight+3)+Offset3-9+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0358             <span class="string">'String'</span>,<span class="string">'Fast Orbit Correction'</span>, <span class="keyword">...</span>
0359             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0360             <span class="string">'Value'</span>,FOFBcheckboxVal,<span class="keyword">...</span>
0361             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxFOFB'</span>);
0362 
0363         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0364             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0365             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0366             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0367             <span class="string">'Position'</span>,[26 3+6*(ButtonHeight+3)+Offset3+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0368             <span class="string">'String'</span>,<span class="string">'Correct ID Tune Shift  '</span>, <span class="keyword">...</span>
0369             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0370             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0371             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxTune'</span>);
0372 
0373         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0374             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0375             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0376             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0377             <span class="string">'Position'</span>,[26 3+5*(ButtonHeight+3)+Offset3+9+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0378             <span class="string">'String'</span>,<span class="string">'Correct RF Frequency'</span>, <span class="keyword">...</span>
0379             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0380             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0381             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>);
0382 
0383         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0384             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''Feedback'');'</span>, <span class="keyword">...</span>
0385             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0386             <span class="string">'FontSize'</span>,12, <span class="keyword">...</span>
0387             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0388             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0389             <span class="string">'Position'</span>,[8 3+5*(ButtonHeight+3)+3+Offset3-25+Offset5 .5*ButtonWidth-6 1.0*ButtonHeight], <span class="keyword">...</span>
0390             <span class="string">'String'</span>,<span class="string">'Start FB'</span>, <span class="keyword">...</span>
0391             <span class="string">'Value'</span>,0, <span class="keyword">...</span>
0392             <span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>);
0393         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0394             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''StopOrbitFeedback'');pause(0);'</span>, <span class="keyword">...</span>
0395             <span class="string">'Enable'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0396             <span class="string">'FontSize'</span>,12, <span class="keyword">...</span>
0397             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0398             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0399             <span class="string">'Position'</span>,[.5*FigWidth+3 3+5*(ButtonHeight+3)+3+Offset3-25+Offset5 .5*ButtonWidth-6 1.0*ButtonHeight], <span class="keyword">...</span>
0400             <span class="string">'String'</span>,<span class="string">'Stop FB'</span>, <span class="keyword">...</span>
0401             <span class="string">'Value'</span>,0, <span class="keyword">...</span>
0402             <span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>);
0403 
0404         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0405             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0406             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0407             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0408             <span class="string">'Position'</span>,[14 4*(ButtonHeight)+Offset3+Offset5-3 ButtonWidth-14 .75*ButtonHeight], <span class="keyword">...</span>
0409             <span class="string">'String'</span>,<span class="string">'Horizontal RMS = _____ mm'</span>, <span class="keyword">...</span>
0410             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0411             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>);
0412         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0413             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0414             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0415             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0416             <span class="string">'Position'</span>,[26 3+3.5*(ButtonHeight)+16+Offset3-25+Offset5 ButtonWidth-26 .75*ButtonHeight], <span class="keyword">...</span>
0417             <span class="string">'String'</span>,<span class="string">'Vertical RMS = _____ mm'</span>, <span class="keyword">...</span>
0418             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0419             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>);
0420 
0421         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0422             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''FeedbackSetup'',1);'</span>, <span class="keyword">...</span>
0423             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''FeedbackSetup'',0);'</span>, <span class="keyword">...</span>
0424             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0425             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0426             <span class="string">'Position'</span>,[8 3+3.5*(ButtonHeight)+.5+Offset3-25+Offset5 ButtonWidth-5 .75*ButtonHeight], <span class="keyword">...</span>
0427             <span class="string">'String'</span>,<span class="string">'Edit SOFB Setup'</span>, <span class="keyword">...</span>
0428             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0429             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0430             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>);
0431 
0432         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0433             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0434             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0435             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0436             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0437             <span class="string">'String'</span>,<span class="string">'01 ____'</span>, <span class="keyword">...</span>
0438             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0439             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0440             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>);
0441 
0442         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0443             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0444             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0445             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0446             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0447             <span class="string">'String'</span>,<span class="string">'02 ____'</span>, <span class="keyword">...</span>
0448             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0449             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0450             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>);
0451 
0452         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0453             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0454             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0455             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0456             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0457             <span class="string">'String'</span>,<span class="string">'03 ____'</span>, <span class="keyword">...</span>
0458             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0459             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0460             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>);
0461 
0462         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0463             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0464             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0465             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0466             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0467             <span class="string">'String'</span>,<span class="string">'04 ____'</span>, <span class="keyword">...</span>
0468             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0469             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0470             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>);
0471 
0472         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0473             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0474             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0475             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0476             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0477             <span class="string">'String'</span>,<span class="string">'05 ____'</span>, <span class="keyword">...</span>
0478             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0479             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0480             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>);
0481 
0482         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0483             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0484             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0485             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0486             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0487             <span class="string">'String'</span>,<span class="string">'06 ____'</span>, <span class="keyword">...</span>
0488             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0489             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0490             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>);
0491 
0492         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0493             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0494             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0495             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0496             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0497             <span class="string">'String'</span>,<span class="string">'07 ____'</span>, <span class="keyword">...</span>
0498             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0499             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0500             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>);
0501 
0502         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0503             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0504             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0505             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0506             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0507             <span class="string">'String'</span>,<span class="string">'08 ____'</span>, <span class="keyword">...</span>
0508             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0509             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0510             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>);
0511 
0512         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0513             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0514             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0515             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0516             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0517             <span class="string">'String'</span>,<span class="string">'09 ____'</span>, <span class="keyword">...</span>
0518             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0519             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0520             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>);
0521 
0522         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0523             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0524             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0525             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0526             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0527             <span class="string">'String'</span>,<span class="string">'10 ____'</span>, <span class="keyword">...</span>
0528             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0529             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0530             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>);
0531 
0532         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0533             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0534             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0535             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0536             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0537             <span class="string">'String'</span>,<span class="string">'11 ____'</span>, <span class="keyword">...</span>
0538             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0539             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0540             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>);
0541 
0542         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0543             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0544             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0545             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0546             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0547             <span class="string">'String'</span>,<span class="string">'12 ____'</span>, <span class="keyword">...</span>
0548             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0549             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0550             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>);
0551 
0552         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0553             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''FastFeedbackSetup'',1);'</span>, <span class="keyword">...</span>
0554             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''FastFeedbackSetup'',0);'</span>, <span class="keyword">...</span>
0555             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0556             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0557             <span class="string">'Position'</span>,[8 1*(ButtonHeight)+Offset3-3 ButtonWidth-5 .75*ButtonHeight], <span class="keyword">...</span>
0558             <span class="string">'String'</span>,<span class="string">'Edit FOFB Setup'</span>, <span class="keyword">...</span>
0559             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0560             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0561             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>);
0562 
0563         <span class="comment">% Frame Box IV</span>
0564         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0565             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0566             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0567             <span class="string">'Position'</span>,[3 3+ButtonHeight+Offset4-14+Offset5 ButtonWidth+6 ButtonHeight+12], <span class="keyword">...</span>
0568             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0569         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0570             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0571             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0572             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0573             <span class="string">'Position'</span>,[6 3+1.75*ButtonHeight+5+Offset4-21+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0574             <span class="string">'String'</span>,<span class="string">'Storage Ring State'</span>, <span class="keyword">...</span>
0575             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0576             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHeader'</span>);
0577         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0578             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''CheckInputs'');'</span>, <span class="keyword">...</span>
0579             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0580             <span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>, <span class="keyword">...</span>
0581             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0582             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0583             <span class="string">'Position'</span>,[6 3+ButtonHeight+6+3+2+Offset4-22+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0584             <span class="string">'String'</span>,<span class="string">'   '</span>, <span class="keyword">...</span>
0585             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0586             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>);
0587 
0588 
0589         <span class="comment">% Frame Box &quot;Close&quot;</span>
0590         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0591             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0592             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0593             <span class="string">'Position'</span>,[3 8 ButtonWidth+6 ButtonHeight+8], <span class="keyword">...</span>
0594             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0595         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0596             <span class="string">'Callback'</span>,<span class="string">'close(gcbf);'</span>, <span class="keyword">...</span>
0597             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0598             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0599             <span class="string">'Position'</span>,[6 13 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0600             <span class="string">'String'</span>,<span class="string">'Close'</span>, <span class="keyword">...</span>
0601             <span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>);
0602 
0603 
0604         <span class="comment">% Update database channels</span>
0605         <a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>;
0606 
0607         <span class="keyword">if</span> nargout &gt; 0
0608             fig = h0;
0609         <span class="keyword">end</span>
0610 
0611 
0612     <span class="keyword">case</span> <span class="string">'Cycle'</span>
0613         GapFlag = Input2;
0614         BumpMagnetFlag = Input3;
0615 
0616         fprintf(<span class="string">'\n'</span>);
0617         disp(<span class="string">'   **************************'</span>);
0618         disp(<span class="string">'   **  Storage Ring Cycle  **'</span>);
0619         disp(<span class="string">'   **************************'</span>);
0620         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
0621 
0622         BSCFlag = questdlg(sprintf(<span class="string">'Cycle Superbend Magnets?'</span>),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0623         <span class="comment">%if strcmp(BSCFlag,'No')</span>
0624         <span class="comment">%    disp(['   ** Superbends will not be cycled. **']);</span>
0625         <span class="comment">%else</span>
0626         <span class="comment">%    disp(['   ** Superbends will be cycled during the second mini-cycle only. **']);</span>
0627         <span class="comment">%end</span>
0628 
0629         ChicSQFlag = questdlg(sprintf(<span class="string">'Cycle chicanes and skew quads and home motor chicanes?'</span>),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0630         <span class="comment">%if strcmp(ChicSQFlag,'No')</span>
0631         <span class="comment">%    disp(['   ** Chicanes and skew quads will not be cycled; motor chicanes will not be homed. **']);</span>
0632         <span class="comment">%else</span>
0633         <span class="comment">%    disp(['   ** Chicanes and skew quads will be cycled; motor chicanes will be homed. **']);</span>
0634         <span class="comment">%end</span>
0635 
0636 
0637         StartFlag = questdlg(sprintf(<span class="string">'Start %.1f GeV Cycle?'</span>,SR_GEV),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0638         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
0639             disp([<span class="string">'   ***************************'</span>]);
0640             disp([<span class="string">'   **    Cycle  Canceled    **'</span>]);
0641             disp([<span class="string">'   ***************************'</span>]);
0642             fprintf(<span class="string">'\n'</span>);
0643             <span class="keyword">return</span>
0644         <span class="keyword">end</span>
0645 
0646         <span class="keyword">try</span>
0647             <span class="keyword">if</span> GapFlag
0648                 <span class="comment">% Make sure that the gaps are open with FF off</span>
0649                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0650                     <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0651                     disp(<span class="string">'   Insertion device gaps are not open.'</span>);
0652                     disp(<span class="string">'   Opening all gaps at maximum speed.'</span>);
0653                     <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0654                     disp(<span class="string">'   Gap control disabled.'</span>);
0655                     disp(<span class="string">'   Feed forward enabled.'</span>);
0656                     pause(1);
0657                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0658                     disp(<span class="string">'   Gaps opened.'</span>);
0659                     disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0660                     a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0661                 <span class="keyword">else</span>
0662                     disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0663                 <span class="keyword">end</span>
0664             <span class="keyword">else</span>
0665                 disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0666             <span class="keyword">end</span>
0667 
0668             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0669             pause(1);
0670             
0671             <a href="srcycle.html" class="code" title="function FailFlag = srcycle(varargin)">srcycle</a>(BSCFlag, ChicSQFlag);
0672 
0673             setpv(<span class="string">'SR_STATE'</span>,1);
0674 
0675         <span class="keyword">catch</span>
0676 
0677             fprintf(<span class="string">'   %s \n'</span>,lasterr);
0678             fprintf(<span class="string">'   Cycle failed due to error condition! \n\n'</span>);
0679             setpv(<span class="string">'SR_STATE'</span>,-1);
0680             
0681         <span class="keyword">end</span>
0682 
0683         date;
0684         a = clock;
0685         datestr1=date;
0686         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0687         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0688         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0689         <span class="keyword">if</span> StateNumber &gt;= 0
0690             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0691             disp(<span class="string">'   **********************************************'</span>);
0692             disp(<span class="string">'   **  SR Cycle complete, ready for injection  **'</span>);
0693             disp(<span class="string">'   **********************************************'</span>); fprintf(<span class="string">'\n'</span>);
0694         <span class="keyword">else</span>
0695             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0696             disp(<span class="string">'   **********************************'</span>);
0697             disp(<span class="string">'   **  Problem cycling SR lattice  **'</span>);
0698             disp(<span class="string">'   **********************************'</span>); fprintf(<span class="string">'\n'</span>);
0699         <span class="keyword">end</span>
0700         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0701         
0702 
0703     <span class="keyword">case</span> <span class="string">'Injection'</span>
0704         AD = getad;
0705         GapFlag = Input2;
0706         BumpMagnetFlag = Input3;
0707 
0708         fprintf(<span class="string">'\n'</span>);
0709         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0710 
0711         <span class="keyword">if</span> abs(AD.Energy - AD.InjectionEnergy) &gt; .05
0712             fprintf(<span class="string">'   ***************************************************\n'</span>);
0713             fprintf(<span class="string">'   **  Setup For %.2f GeV Injection (with ramping)  **\n'</span>, getfamilydata(<span class="string">'InjectionEnergy'</span>));
0714             fprintf(<span class="string">'   ***************************************************\n'</span>);
0715             <a href="set_alarmhandler_AHU_thresholds_inject.html" class="code" title="function set_alarmhandler_AHU_thresholds_inject">set_alarmhandler_AHU_thresholds_inject</a>;
0716             StartFlag = questdlg(sprintf(<span class="string">'Start setup for injection, %.2f GeV?'</span>,getfamilydata(<span class="string">'InjectionEnergy'</span>)),<span class="string">'Injection Setup'</span>,<span class="string">'Ramp quickly'</span>,<span class="string">'Ramp slowly'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0717         <span class="keyword">else</span>
0718             fprintf(<span class="string">'   *************************************************\n'</span>);
0719             fprintf(<span class="string">'   **  Setup For On Energy Injection at %.2f GeV  **\n'</span>, SR_GEV);
0720             fprintf(<span class="string">'   *************************************************\n'</span>);
0721             StartFlag = questdlg(sprintf(<span class="string">'Start setup for injection, %.2f GeV?'</span>,SR_GEV),<span class="string">'Injection Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0722         <span class="keyword">end</span>
0723         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'Cancel'</span>)
0724             disp([<span class="string">'   ********************************'</span>]);
0725             disp([<span class="string">'   **  Injection Setup Canceled  **'</span>]);
0726             disp([<span class="string">'   ********************************'</span>]);
0727             <a href="set_alarmhandler_thresholds.html" class="code" title="function set_alarmhandler_thresholds">set_alarmhandler_thresholds</a>;
0728             fprintf(<span class="string">'\n'</span>);
0729             <span class="keyword">return</span>
0730         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp quickly'</span>)
0731             setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0732         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp slowly'</span>)
0733             setfamilydata(0.4, <span class="string">'BSCRampRate'</span>);
0734         <span class="keyword">end</span>
0735 
0736         <span class="keyword">try</span>
0737 
0738             <span class="keyword">if</span> GapFlag
0739                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([],1,0);
0740                 disp(<span class="string">'   Gap control disabled'</span>);
0741                 disp(<span class="string">'   Feed forward enabled'</span>);
0742                 pause(1);
0743 
0744                 <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0745                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0746                     disp(<span class="string">'   Opening all gaps'</span>);
0747                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0748                 <span class="keyword">end</span>
0749 
0750                 disp(<span class="string">'   Gaps are open'</span>);
0751                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0752                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0753             <span class="keyword">else</span>
0754                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0755             <span class="keyword">end</span>
0756 
0757             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0758             pause(1);
0759 
0760             <span class="keyword">if</span> (AD.Energy-AD.InjectionEnergy) &gt; 0.05
0761                 <span class="comment">% Ramp down to Injection Energy</span>
0762                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,<span class="string">'Ramping Down'</span>,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0763                 drawnow;
0764                 ErrorFlag = <a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>(<span class="string">'Injection'</span>);
0765                 <span class="keyword">if</span> ErrorFlag
0766                     error(<span class="string">'Superbends over temperature.'</span>);
0767                 <span class="keyword">end</span>
0768                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n\n'</span>,date, a(4), a(5), a(6));
0769 
0770             <span class="keyword">elseif</span> (AD.Energy-AD.InjectionEnergy) &lt; -0.05
0771 
0772                 <span class="comment">% first load injection lattice, then ramp to 1.9 GeV and back to 1.5 GeV to get onto same hysteresis branch</span>
0773 
0774                 srload(<span class="string">'Injection'</span>);
0775 
0776                 <span class="comment">% load 1.9 GeV lattice</span>
0777                 tempfilename = sprintf(<span class="string">'%s19nuy9prod.mat'</span>, getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>));
0778 
0779                 srload(tempfilename);
0780 
0781                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0782 
0783                 pause(5);
0784 
0785             <span class="keyword">end</span>
0786 
0787             srload(<span class="string">'Injection'</span>);
0788 
0789             setpv(<span class="string">'SR_STATE'</span>,2);
0790 
0791         <span class="keyword">catch</span>
0792 
0793             fprintf(<span class="string">'   %s \n'</span>,lasterr);
0794             fprintf(<span class="string">'   Injection lattice setup failed due to error condition! \n\n'</span>);
0795             setpv(<span class="string">'SR_STATE'</span>,-2);
0796 
0797         <span class="keyword">end</span>
0798 
0799 
0800         date;
0801         a = clock;
0802         datestr1=date;
0803         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0804         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0805         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0806         <span class="keyword">if</span> StateNumber &gt;= 0
0807             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0808             <span class="keyword">if</span> AD.Energy &lt;= 1.5
0809                 disp([<span class="string">'   *******************************************************************************'</span>]);
0810                 disp([<span class="string">'   **  Function complete:  the storage ring is setup for injection at '</span>,sprintf(<span class="string">'%.2f'</span>,SR_GEV),<span class="string">' GeV  **'</span>]);
0811                 disp([<span class="string">'   *******************************************************************************'</span>]); 
0812                 fprintf(<span class="string">'\n'</span>);
0813             <span class="keyword">else</span>
0814                 fprintf(<span class="string">'   **********************************************************************************************\n'</span>);
0815                 fprintf(<span class="string">'   **  Function complete:  the storage ring is setup for injection at %.2f GeV (upper branch)  **\n'</span>, getfamilydata(<span class="string">'InjectionEnergy'</span>));
0816                 fprintf(<span class="string">'   **********************************************************************************************\n'</span>); 
0817                 fprintf(<span class="string">'\n'</span>);
0818             <span class="keyword">end</span>
0819         <span class="keyword">else</span>
0820             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0821             disp([<span class="string">'   ************************************'</span>]);
0822             disp([<span class="string">'   **  Problem with injection setup  **'</span>]);
0823             disp([<span class="string">'   ************************************'</span>]); 
0824             fprintf(<span class="string">'\n'</span>);
0825         <span class="keyword">end</span>
0826         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0827 
0828         <span class="comment">%soundchord;</span>
0829 
0830         setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0831 
0832 
0833     <span class="keyword">case</span> <span class="string">'Production'</span>
0834         GapFlag = Input2;
0835         BumpMagnetFlag = Input3;
0836         AD=getad;
0837         
0838         fprintf(<span class="string">'\n'</span>);
0839         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0840 
0841         <span class="keyword">if</span> abs(AD.Energy - AD.InjectionEnergy) &gt; .05
0842             disp(<span class="string">'   ********************************************************'</span>);
0843             disp(sprintf(<span class="string">'   **  Setup For %.2f GeV User Operation (with ramping)  **'</span>,SR_GEV));
0844             disp(<span class="string">'   ********************************************************'</span>);
0845             StartFlag = questdlg(sprintf(<span class="string">'Start setup for users, %.1f GeV?'</span>,SR_GEV),<span class="string">'User Setup'</span>,<span class="string">'Ramp quickly'</span>,<span class="string">'Ramp slowly'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0846         <span class="keyword">else</span>
0847             disp(<span class="string">'   *****************************************'</span>);
0848             disp(sprintf(<span class="string">'   **  Setup For %.2f GeV User Operation  **'</span>,SR_GEV));
0849             disp(<span class="string">'   *****************************************'</span>);
0850             StartFlag = questdlg(sprintf(<span class="string">'Start setup for users, %.1f GeV?'</span>,SR_GEV),<span class="string">'User Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0851         <span class="keyword">end</span>
0852 
0853         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'Cancel'</span>)
0854             disp([<span class="string">'   ***************************'</span>]);
0855             disp([<span class="string">'   **  User Setup Canceled  **'</span>]);
0856             disp([<span class="string">'   ***************************'</span>]);
0857             fprintf(<span class="string">'\n'</span>);
0858             <span class="keyword">return</span>
0859         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp quickly'</span>)
0860             setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0861         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp slowly'</span>)
0862             setfamilydata(0.4, <span class="string">'BSCRampRate'</span>);
0863         <span class="keyword">end</span>
0864 
0865         <span class="keyword">try</span>
0866 
0867             <span class="keyword">if</span> GapFlag
0868                 <span class="comment">% Make sure that the gaps are open</span>
0869                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0870                     <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0871                     disp(<span class="string">'   Insertion device gaps are not open'</span>);
0872                     disp(<span class="string">'   Opening all gaps at maximum speed'</span>);
0873                     <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0874                     disp(<span class="string">'   Gap control disabled'</span>);
0875                     disp(<span class="string">'   Feed forward enabled'</span>);
0876                     pause(1);
0877                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0878                     disp(<span class="string">'   Gaps opened'</span>);
0879                     disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0880                     a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0881                 <span class="keyword">else</span>
0882                     disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0883                 <span class="keyword">end</span>
0884             <span class="keyword">else</span>
0885                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0886             <span class="keyword">end</span>
0887 
0888             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0889             pause(1);
0890 
0891             <span class="comment">% Ramp up to the production lattice</span>
0892             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,<span class="string">'Ramping Up'</span>,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0893             drawnow;
0894             ErrorFlag = <a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>(<span class="string">'Production'</span>);
0895             <span class="keyword">if</span> ErrorFlag
0896                 error(<span class="string">'Superbends over temperature.'</span>);
0897             <span class="keyword">end</span>
0898             a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0899 
0900             srload(<span class="string">'Production'</span>);
0901 
0902             <span class="keyword">if</span> GapFlag
0903                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0904                 disp(<span class="string">'   Gap control disabled'</span>);
0905                 disp(<span class="string">'   Feed forward enable'</span>);
0906                 pause(1);
0907 
0908                 disp(<span class="string">'   Insertion device velocity profile boolean control off'</span>);
0909                 disp(<span class="string">'   Closing all gaps at maximum speed'</span>);
0910 
0911                 <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0912                 [Position, Velocity, RunFlag, UserGap] = <a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>;
0913 
0914                 <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], UserGap, maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0915 
0916                 <span class="comment">% Turn velocity profile on</span>
0917                 disp(<span class="string">'   Insertion device velocity profile boolean control is on'</span>);
0918                 <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], [], maxsp(<span class="string">'IDvel'</span>), 1, 1, 0);
0919 
0920                 disp(<span class="string">'   Gaps are closed'</span>);
0921                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([4;7;8;9;10;12], 1, 1);
0922                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>(5, 1, 0);
0923                 disp(<span class="string">'   Gap control enabled (except sector 5 (W16))'</span>);
0924             <span class="keyword">end</span>
0925 
0926             <a href="set_alarmhandler_thresholds_new.html" class="code" title="function set_alarmhandler_thresholds_new">set_alarmhandler_thresholds_new</a>;
0927             setpv(<span class="string">'SR_STATE'</span>,3);
0928 
0929         <span class="keyword">catch</span>
0930 
0931             fprintf(<span class="string">'   %s \n'</span>, lasterr);
0932             fprintf(<span class="string">'   User lattice setup failed due to error condition! \n\n'</span>);
0933             setpv(<span class="string">'SR_STATE'</span>,-3);
0934 
0935         <span class="keyword">end</span>
0936 
0937         a = clock;
0938         datestr1=date;
0939         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0940         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0941         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0942         <span class="keyword">if</span> StateNumber &gt;= 0
0943             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0944             disp([<span class="string">'   **************************************************************************'</span>]);
0945             disp([<span class="string">'   **  Function complete:  the storage ring is setup for users at '</span>,sprintf(<span class="string">'%.1f'</span>,SR_GEV),<span class="string">' GeV  **'</span>]);
0946             disp([<span class="string">'   **************************************************************************'</span>]); fprintf(<span class="string">'\n'</span>);
0947         <span class="keyword">else</span>
0948             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0949             disp([<span class="string">'   *************************************'</span>]);
0950             disp([<span class="string">'   **  Problem with production setup  **'</span>]);
0951             disp([<span class="string">'   *************************************'</span>]); fprintf(<span class="string">'\n'</span>);
0952         <span class="keyword">end</span>
0953         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0954 
0955         setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0956 
0957 
0958 <span class="comment">%         % for BL6.0.x, set lower setpoint limit for IVID to 12.5mm until beamlines are surveyed below that value</span>
0959 <span class="comment">%         try</span>
0960 <span class="comment">%             scaput('SR06U___GDS1PS_AC00.DRVL',12.5);</span>
0961 <span class="comment">%             disp('  Setting SR06U___GDS1PS_AC00.DRVL to 12.5mm (lower limit for IVID');</span>
0962 <span class="comment">%         catch</span>
0963 <span class="comment">%             disp('  Trouble setting lower limit for IVID to 12.5mm!');</span>
0964 <span class="comment">%         end</span>
0965 
0966         
0967     <span class="keyword">case</span> <span class="string">'CheckInputs'</span>
0968 
0969         SR_GEV = getfamilydata(<span class="string">'Energy'</span>);
0970         AD=getad;
0971         <a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>; 
0972 
0973         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0974 
0975         <span class="keyword">if</span> AD.Energy &gt; 1.55
0976             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection (Ramp Down)'</span>]);
0977             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users (Ramp Up)'</span>]);
0978         <span class="keyword">elseif</span> AD.Energy &lt; 1.45
0979             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection (Ramp Up+cycle)'</span>]);
0980             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users, '</span>,num2str(round(10*SR_GEV)/10),<span class="string">' GeV (Ramp Down)'</span>]);
0981         <span class="keyword">else</span>
0982             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection'</span>]);
0983             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users, '</span>,num2str(round(10*SR_GEV)/10),<span class="string">' GeV'</span>]);
0984         <span class="keyword">end</span>
0985         set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLTitle'</span>),<span class="string">'String'</span>,SR_Mode);
0986 
0987         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0988         <span class="keyword">if</span> StateNumber &gt;= 0
0989             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0990         <span class="keyword">else</span>
0991             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0992         <span class="keyword">end</span>
0993 
0994         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0995 
0996 
0997     <span class="keyword">case</span> <span class="string">'SRState'</span>
0998         NumErrors = 0;
0999         fprintf(<span class="string">'\n'</span>);
1000         disp(<span class="string">'   ***********************************'</span>);
1001         disp(<span class="string">'   **  Checking Storage Ring State  **'</span>);
1002         disp(<span class="string">'   ***********************************'</span>);
1003         a = clock;
1004         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1005 
1006         <span class="comment">%       FileName = getpv('SR_LATTICE_FILE','String');   % Last srload file name (in OLD MIDDLE LAYER nomenclature!!)</span>
1007 
1008         GeVnow = <a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>;
1009         <span class="keyword">if</span> GeVnow == getfamilydata(<span class="string">'Energy'</span>)
1010             [ConfigSetpoint, ConfigMonitor, FileName] = getproductionlattice;
1011         <span class="keyword">elseif</span> GeVnow == getfamilydata(<span class="string">'InjectionEnergy'</span>)
1012             [ConfigSetpoint, ConfigMonitor, FileName] = getinjectionlattice;
1013         <span class="keyword">else</span>
1014             FileName = <span class="string">''</span>;
1015         <span class="keyword">end</span>
1016 
1017         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1018         fprintf(<span class="string">'   Storage ring operational mode: %s\n'</span>, SR_Mode);
1019         <span class="keyword">if</span> StateNumber &lt; 0
1020             fprintf(<span class="string">'   Storage ring state error: %s\n'</span>, StateString);
1021             NumErrors = NumErrors + 1;
1022         <span class="keyword">else</span>
1023             fprintf(<span class="string">'   Storage ring state: %s\n'</span>, StateString);
1024         <span class="keyword">end</span>
1025         <span class="keyword">if</span> StateNumber==0
1026             <span class="comment">% Storage ring state unknown</span>
1027             NumErrors = NumErrors + 1;
1028         <span class="keyword">elseif</span> abs(StateNumber)==1 || abs(StateNumber)==2
1029             FileNameGoal = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>) getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'InjectionFile'</span>) <span class="string">'.mat'</span>];
1030             <span class="keyword">if</span> ~strcmp(FileName, FileNameGoal)
1031                 fprintf(<span class="string">'   Lattice file %s should be loaded but it appears that %s is loaded.\n'</span>, getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'InjectionFile'</span>), FileName);
1032                 NumErrors = NumErrors + 1;
1033             <span class="keyword">end</span>
1034         <span class="keyword">else</span>
1035             FileNameGoal = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>) getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'LatticeFile'</span>) <span class="string">'.mat'</span>];
1036             <span class="keyword">if</span> ~strcmp(FileName, FileNameGoal)
1037                 fprintf(<span class="string">'   Lattice file %s should be loaded but it appears that %s is loaded.\n'</span>, getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'LatticeFile'</span>), FileName);
1038                 NumErrors = NumErrors + 1;
1039             <span class="keyword">end</span>
1040         <span class="keyword">end</span>
1041 
1042 
1043         <span class="comment">% Check all SR magnets</span>
1044         <span class="keyword">if</span> isempty(FileName)
1045             fprintf(<span class="string">'   Goal setpoints will not be checked since the last lattice load is unknown.\n'</span>);
1046             NumErrors1 = <a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>(<span class="string">''</span>);
1047         <span class="keyword">else</span>
1048 <span class="comment">%            NumErrors1 = checksrmags([getfamilydata('Directory','OpsData') FileName]);</span>
1049             NumErrors1 = <a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>(FileName);
1050         <span class="keyword">end</span>
1051         <span class="keyword">if</span> NumErrors1 == 0
1052             fprintf(<span class="string">'   SR magnets power supplies are OK.\n'</span>);
1053         <span class="keyword">end</span>
1054         NumErrors = NumErrors + NumErrors1;
1055 
1056 
1057         <span class="comment">% Check RF frequency</span>
1058         <span class="keyword">if</span> isempty(FileName)
1059             fprintf(<span class="string">'   RF frequency will not be checked since the last lattice load is unknown.\n'</span>);
1060         <span class="keyword">else</span>
1061 <span class="comment">%            load([getfamilydata('Directory','OpsData'), FileName]);</span>
1062             load(FileName);
1063             [tmp, RFHPCounterPresent] = getrf;
1064             <span class="keyword">if</span> abs(RFHPCounterPresent-ConfigSetpoint.RF.Setpoint.Data) &gt; .002
1065                 NumErrors = NumErrors + 1;
1066                 fprintf(<span class="string">'   RF frequency should be %f, presently it is %f MHz (as measured by the HP counter).\n'</span>, ConfigSetpoint.RF.Setpoint.Data, RFHPCounterPresent);
1067             <span class="keyword">else</span>
1068                 fprintf(<span class="string">'   RF frequency is OK (HP counter is %f MHz, at the time of the lattice save it was %f MHz).\n'</span>, RFHPCounterPresent, ConfigSetpoint.RF.Setpoint.Data);
1069             <span class="keyword">end</span>
1070         <span class="keyword">end</span>
1071 
1072 
1073         <span class="comment">% Check for orbit problems</span>
1074         <span class="keyword">if</span> (StateNumber &gt;= 3) &amp; (getdcct &gt; 2)   <span class="comment">% Production lattice is loaded with beam in the machine</span>
1075             Xtol = 0.070;
1076             Ytol = 0.010;
1077             NumErrors1 = <a href="checksrorbit.html" class="code" title="function ErrorNums = checksrorbit(SectorList, BPMxtol,BPMytol)">checksrorbit</a>([],Xtol,Ytol);
1078             <span class="keyword">if</span> NumErrors1
1079                 fprintf(<span class="string">'   SR orbit in the ID straight sections or at Bergoz BPMs deviates more than allowed from the golden orbit.\n'</span>);
1080             <span class="keyword">else</span>
1081                 fprintf(<span class="string">'   SR orbit in the ID straight sections and at Bergoz BPMs is OK.\n'</span>);
1082                 fprintf(<span class="string">'   The orbit is within %.3f mm horizontally and %.3f mm vertically'</span>, Xtol, Ytol);
1083             <span class="keyword">end</span>
1084             NumErrors = NumErrors + NumErrors1;
1085         <span class="keyword">else</span>
1086             fprintf(<span class="string">'   Storage ring orbit was not checked.\n'</span>);
1087         <span class="keyword">end</span>
1088 
1089 
1090         a = clock;
1091         datestr1=date;
1092         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
1093         <span class="keyword">if</span> NumErrors
1094             disp(<span class="string">'   *********************************'</span>);
1095             disp(<span class="string">'   **  Storage Ring Has Problems  **'</span>);
1096             disp(<span class="string">'   *********************************'</span>);
1097         <span class="keyword">else</span>
1098             disp(<span class="string">'   **********************************'</span>);
1099             disp(<span class="string">'   **  Storage Ring Lattice is OK  **'</span>);
1100             disp(<span class="string">'   **********************************'</span>);
1101         <span class="keyword">end</span>
1102         fprintf(<span class="string">'   \n'</span>);
1103 
1104         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1105         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1106         <span class="keyword">if</span> StateNumber &gt;= 0
1107             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1108         <span class="keyword">else</span>
1109             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1110         <span class="keyword">end</span>
1111         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1112 
1113 
1114     <span class="keyword">case</span> <span class="string">'OrbitCorrection'</span>
1115         fprintf(<span class="string">'\n'</span>);
1116         fprintf(<span class="string">'   *********************************\n'</span>);
1117         fprintf(<span class="string">'   **  Starting Orbit Correction  **\n'</span>);
1118         fprintf(<span class="string">'   *********************************\n'</span>);
1119         a = clock;
1120         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1121 
1122         StartFlag = questdlg(sprintf(<span class="string">'Start orbit correction, %.1f GeV?'</span>,SR_GEV),<span class="string">'Orbit Correction'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
1123         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
1124             disp([<span class="string">'   ********************************'</span>]);
1125             disp([<span class="string">'   **  Orbit Correction Aborted  **'</span>]);
1126             disp([<span class="string">'   ********************************'</span>]);
1127             fprintf(<span class="string">'\n'</span>);
1128             <span class="keyword">return</span>
1129         <span class="keyword">end</span>
1130 
1131         <span class="keyword">if</span> getdcct &lt; 5     <span class="comment">% Don't correct the orbit if the current is too small</span>
1132             fprintf(<span class="string">'   Orbit not corrected due to small current.\n'</span>);
1133             <span class="keyword">return</span>
1134         <span class="keyword">end</span>
1135 
1136         <span class="keyword">if</span> abs(SR_GEV-<a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>(getpv(<span class="string">'BEND'</span>,[1 1])))&gt;  0.05     <span class="comment">% Don't use this routine for the injection lattice</span>
1137             fprintf(<span class="string">'   This routine should only be used for the production energy: Correction aborted\n'</span>);
1138             <span class="keyword">return</span>
1139         <span class="keyword">end</span>
1140 
1141         SR_STATE_OLD = scaget(<span class="string">'SR_STATE'</span>);
1142         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1143         setpv(<span class="string">'SR_STATE'</span>,4);
1144         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1145         <span class="keyword">if</span> StateNumber &gt;= 0
1146             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1147         <span class="keyword">else</span>
1148             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1149         <span class="keyword">end</span>
1150         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1151 
1152 
1153         <span class="keyword">try</span>
1154             <span class="comment">% save current BPM timeconstant - will reset to this after correction</span>
1155             BPMtimeconstantOC = <a href="getbpmtimeconstant.html" class="code" title="function [BPMTimeConstant, WarningFlag] = getbpmtimeconstant(varargin)">getbpmtimeconstant</a>;
1156             fprintf(<span class="string">'   Current Bergoz BPM time constant is %.1fs\n'</span>, BPMtimeconstantOC);
1157 
1158             <span class="comment">% 2 Hz update rate on IDBPMs</span>
1159             disp(<span class="string">'   Bergoz BPM time constant set to 0.5s.'</span>)
1160             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.5)
1161             pause(2);
1162 
1163 
1164             <span class="comment">% Turn off feed forward</span>
1165             fprintf(<span class="string">'   Turning feed forward off.\n'</span>);
1166             [FFEnableBM, FFEnableBC] = <a href="getff.html" class="code" title="function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)">getff</a>;
1167             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0);
1168             scasleep(.2);
1169 
1170 
1171             <span class="comment">% Get vectors</span>
1172             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>);
1173             LocalBumplist = FB.LocalBumplist;
1174 
1175         <span class="keyword">catch</span>
1176 
1177             fprintf(<span class="string">'   %s \n'</span>,lasterr);
1178             fprintf(<span class="string">'   Orbit correction setup failed due to error condition! \n\n'</span>);
1179             setpv(<span class="string">'SR_STATE'</span>,-4);
1180             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1181             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1182             <span class="keyword">if</span> StateNumber &gt;= 0
1183                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1184             <span class="keyword">else</span>
1185                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1186             <span class="keyword">end</span>
1187             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1188 
1189             <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1190             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1191             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1192             <span class="keyword">return</span>
1193         <span class="keyword">end</span>
1194 
1195         iNotHCMChicane = find(FB.HCMlist1(:,2) &lt; 10); <span class="comment">%used by steppv's for setting correctors in loop</span>
1196         iHCMChicane = find(FB.HCMlist1(:,2) == 10);
1197         iNotVCMChicane = find(FB.VCMlist1(:,2) &lt; 10);
1198         iVCMChicane = find(FB.VCMlist1(:,2) == 10);
1199 
1200         fprintf(<span class="string">'   Starting horizontal and vertical global orbit correction (SVD method).\n'</span>);
1201 
1202         <span class="keyword">for</span> iloop = 1:3
1203             <span class="keyword">try</span>
1204                 <span class="comment">% use the following to get corrector settings in OCS without setting them, so the values can be checked</span>
1205                 FB.OCSx = setorbit(FB.OCSx,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1206                 FB.OCSy = setorbit(FB.OCSy,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1207                 <span class="keyword">if</span> any(abs(FB.OCSx.CM.Delta(iNotHCMChicane)) &gt; 5)
1208                   disp(<span class="string">'   Orbit Correction is changing some horizontal corrector(s) &gt; 5A!!'</span>);
1209                 <span class="keyword">end</span>
1210                 <span class="keyword">if</span> any(abs(FB.OCSy.CM.Delta(iNotVCMChicane)) &gt; 5)
1211                   disp(<span class="string">'   Orbit Correction is changing some vertical corrector(s) &gt; 5A!!'</span>);
1212                 <span class="keyword">end</span>
1213                 <span class="keyword">if</span> any(abs(FB.OCSx.CM.Delta(iHCMChicane)) &gt; 10)
1214                   disp(<span class="string">'   Orbit Correction is changing some horizontal chicane corrector(s) &gt; 10A!!'</span>);
1215                 <span class="keyword">end</span>
1216                 <span class="keyword">if</span> any(abs(FB.OCSy.CM.Delta(iVCMChicane)) &gt; 10)
1217                   disp(<span class="string">'   Orbit Correction is changing some vertical chicane corrector(s) &gt; 10A!!'</span>);
1218                 <span class="keyword">end</span>
1219 
1220 
1221                 <span class="comment">% Correct horizontal orbit</span>
1222                 FB.OCSx = setorbit(FB.OCSx,<span class="string">'NoDisplay'</span>);
1223                 <span class="comment">% Correct vertical orbit</span>
1224                 FB.OCSy = setorbit(FB.OCSy,<span class="string">'NoDisplay'</span>);
1225 
1226 
1227                 <span class="comment">% Check for current in machine - stop orbit correction if DCCT &lt; 5mA</span>
1228                 <span class="keyword">if</span> (getdcct &lt; 4.5)
1229                     error(<span class="string">'**There is less than 5mA in the machine! Stopping orbit correction.'</span>);
1230                 <span class="keyword">end</span>
1231 
1232                 <span class="comment">% Check state of gaps - stop orbit correction if any are moving</span>
1233                 GAPrunflag = getpv(<span class="string">'ID'</span>,<span class="string">'RunFlag'</span>);
1234                 <span class="keyword">if</span> any(GAPrunflag-round(GAPrunflag))
1235                     error(<span class="string">'**One or more of the gaps are moving! Stopping orbit correction.'</span>);
1236                 <span class="keyword">end</span>
1237 
1238                 x = FB.OCSx.GoalOrbit - getx(FB.OCSx.BPM.DeviceList);
1239                 y = FB.OCSy.GoalOrbit - gety(FB.OCSy.BPM.DeviceList);
1240                 fprintf(<span class="string">'   %d. Horizontal RMS = %.3f mm\n'</span>, iloop, norm(x)/sqrt(length(x)));
1241                 fprintf(<span class="string">'   %d.   Vertical RMS = %.3f mm\n'</span>, iloop, norm(y)/sqrt(length(y)));
1242 
1243             <span class="keyword">catch</span>
1244                 <span class="comment">% fprintf('   %s \n',lasterr);</span>
1245                 fprintf(<span class="string">'   Orbit correction failed due to error condition!\n  Fix the problem, reload the lattice (srload), and try again.  \n\n'</span>);
1246                 setpv(<span class="string">'SR_STATE'</span>,-4);
1247                 set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1248                 [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1249                 <span class="keyword">if</span> StateNumber &gt;= 0
1250                     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1251                 <span class="keyword">else</span>
1252                     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1253                 <span class="keyword">end</span>
1254                 set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1255 
1256                 <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1257                 <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1258                 fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1259                 <span class="keyword">return</span>
1260             <span class="keyword">end</span>
1261         <span class="keyword">end</span>
1262 
1263 
1264         <span class="comment">% Set user bumps w/o sextupole correctors</span>
1265         <span class="keyword">try</span>
1266 
1267             <span class="comment">%turn up corrector speed here to quicken setting bumps</span>
1268             HCMramprate = getpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>);
1269             VCMramprate = getpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>);
1270             setpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>, 10, [], 0);
1271             setpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>, 10, [], 0);
1272             
1273             <span class="keyword">if</span> ~isempty(LocalBumplist)
1274                 fprintf(<span class="string">'   Setting local bumps in the straight sections.\n'</span>);
1275                 <span class="keyword">for</span> loop = 1:size(LocalBumplist,1)
1276 
1277                     <span class="comment">% Check for current in machine - stop orbit correction if DCCT &lt; 5mA</span>
1278                     <span class="keyword">if</span> (getdcct &lt; 5)
1279                         error(<span class="string">'** There is less than 5mA in the machine! Stopping local bumps.'</span>);
1280                     <span class="keyword">end</span>
1281 
1282                     <span class="comment">% Check state of gaps - stop setting bumps if any are moving</span>
1283                     GAPrunflag = getpv(<span class="string">'ID'</span>,<span class="string">'RunFlag'</span>);
1284                     <span class="keyword">if</span> any(GAPrunflag-round(GAPrunflag))
1285                         error(<span class="string">'** One or more of the gaps are moving! Stopping local bumps.'</span>);
1286                     <span class="keyword">end</span>
1287 
1288                     HCMoldsp = getsp(<span class="string">'HCM'</span>, FB.HCMlist1);
1289                     VCMoldsp = getsp(<span class="string">'VCM'</span>, FB.VCMlist1);
1290 
1291                     <span class="keyword">if</span> any(LocalBumplist(loop,1) == [4 6 11])
1292                         <span class="keyword">if</span> LocalBumplist(loop,2) == 0
1293                             <span class="comment">% Upstream bump</span>
1294                             [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1)-1 11;LocalBumplist(loop,1)-1 12;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1295                             <span class="keyword">if</span> isempty(iRemove)
1296                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1297                             <span class="keyword">else</span>
1298                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1299                             <span class="keyword">end</span>
1300                         <span class="keyword">elseif</span> LocalBumplist(loop,2) == 1
1301                             <span class="comment">% Upstream bump</span>
1302                             [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1)-1 11;],FB.OCSx.BPM.DeviceList);
1303                             <span class="keyword">if</span> isempty(iRemove)
1304                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1305                             <span class="keyword">else</span>
1306                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1307                             <span class="keyword">end</span>
1308                         <span class="keyword">else</span>
1309                             <span class="comment">% Downstream bump</span>
1310                             [i, iRemove] = findrowindex([LocalBumplist(loop,1)-1 12;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1311                             <span class="keyword">if</span> isempty(iRemove)
1312                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1313                             <span class="keyword">else</span>
1314                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1315                             <span class="keyword">end</span>
1316                         <span class="keyword">end</span>
1317                     <span class="keyword">else</span>
1318                         [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1319                         <span class="keyword">if</span> isempty(iRemove)
1320                             <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1321                         <span class="keyword">else</span>
1322                             fprintf(<span class="string">'\n   BPMs missing from Sector %02d - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,1));
1323                         <span class="keyword">end</span>
1324                     <span class="keyword">end</span>
1325                     
1326                     HCMnewsp = getsp(<span class="string">'HCM'</span>, FB.HCMlist1);
1327                     VCMnewsp = getsp(<span class="string">'VCM'</span>, FB.VCMlist1);
1328                     <span class="comment">% Remove center chicane trim from corrector check</span>
1329                     <span class="keyword">if</span> (max(abs(HCMoldsp(iNotHCMChicane)-HCMnewsp(iNotHCMChicane))) &gt; 5) | (max(abs(VCMoldsp(iNotVCMChicane)-VCMnewsp(iNotVCMChicane))) &gt; 10)
1330                         error(<span class="string">'**Setbumps caused some corrector magnet currents to change by more than 5(Horiz)/10(Vert) A!'</span>);
1331                     <span class="keyword">end</span>
1332                     <span class="comment">% Now check center chicane trims</span>
1333                     <span class="keyword">if</span> (max(abs(HCMoldsp(iNotHCMChicane)-HCMnewsp(iNotHCMChicane))) &gt; 10) | (max(abs(VCMoldsp(iNotVCMChicane)-VCMnewsp(iNotVCMChicane))) &gt; 15)
1334                         error(<span class="string">'**Setbumps caused some chicane trim magnet currents to change by more than 10(Horiz)/15(Vert) A!'</span>);
1335                     <span class="keyword">end</span>
1336                 <span class="keyword">end</span>
1337             <span class="keyword">end</span>
1338 
1339             <span class="comment">%restore corrector speeds</span>
1340             setpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>, HCMramprate, [], 0);
1341             setpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>, VCMramprate, [], 0);
1342 
1343         <span class="keyword">catch</span>
1344             fprintf(<span class="string">'   %s \n'</span>,lasterr);
1345             fprintf(<span class="string">'   Setbumps failed due to error condition!  Fix the problem, reload the lattice (srload), and try again.\n\n'</span>);
1346             setpv(<span class="string">'SR_STATE'</span>,-4);
1347             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1348             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1349             <span class="keyword">if</span> StateNumber &gt;= 0
1350                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1351             <span class="keyword">else</span>
1352                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1353             <span class="keyword">end</span>
1354             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1355 
1356             <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1357             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1358             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1359             <span class="keyword">return</span>
1360         <span class="keyword">end</span>
1361 
1362         <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1363         <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1364         fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1365 
1366         <span class="comment">% Turn feed forward back to it's original state</span>
1367         <span class="keyword">if</span> any(FFEnableBC)
1368             fprintf(<span class="string">'   Turning feed forward back on.\n'</span>);
1369             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], FFEnableBC);
1370         <span class="keyword">end</span>
1371 
1372 
1373         a = clock;
1374         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1375         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1376         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1377         <span class="keyword">if</span> StateNumber &gt;= 0
1378             setpv(<span class="string">'SR_STATE'</span>,4.1);
1379             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1380             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1381             fprintf(<span class="string">'   *********************************\n'</span>);
1382             fprintf(<span class="string">'   **  Orbit Correction Complete  **\n'</span>);
1383             fprintf(<span class="string">'   *********************************\n\n'</span>);
1384         <span class="keyword">else</span>
1385             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1386             fprintf(<span class="string">'   *************************************\n'</span>);
1387             fprintf(<span class="string">'   **  Problem With Orbit Correction  **\n'</span>);
1388             fprintf(<span class="string">'   *************************************\n\n'</span>);
1389         <span class="keyword">end</span>
1390         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1391         pause(0);
1392 
1393 
1394     <span class="keyword">case</span> <span class="string">'OrbitCorrectionSetup'</span>
1395         InitFlag = Input2;           <span class="comment">% Input #2: if InitFlag, then initialize variables</span>
1396 
1397         <span class="keyword">if</span> InitFlag
1398             <span class="comment">% Setup feedback elements</span>
1399             <span class="comment">% disp('Orbit correction condition: InitFlag=1 -- debugging message');</span>
1400 
1401             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1402             <span class="comment">% Edit the following lists to change default configuration of Orbit Correction %</span>
1403             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1404 <span class="comment">%             hlist=[];vlist=[];</span>
1405 <span class="comment">%             for Sector =1:12</span>
1406 <span class="comment">%                 if Sector == 1</span>
1407 <span class="comment">%                     vlist = [vlist;Sector 2;Sector 4;Sector 5;Sector 8];</span>
1408 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7];</span>
1409 <span class="comment">%                 elseif Sector == 3</span>
1410 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];</span>
1411 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7;Sector 10];</span>
1412 <span class="comment">%                 elseif Sector == 5</span>
1413 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];</span>
1414 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7;Sector 10];</span>
1415 <span class="comment">% %                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8]; %remove HCM and VCM(5,10) since corrector is not controlling starting 4-6-07</span>
1416 <span class="comment">% %                     hlist = [hlist;Sector 2;Sector 7];</span>
1417 <span class="comment">%                 elseif Sector == 10</span>
1418 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];</span>
1419 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7;Sector 10];</span>
1420 <span class="comment">%                 elseif Sector == 12</span>
1421 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 7];</span>
1422 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7];</span>
1423 <span class="comment">%                 else</span>
1424 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8];</span>
1425 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7];</span>
1426 <span class="comment">%                 end</span>
1427 <span class="comment">%             end</span>
1428 <span class="comment">%             HCMlist1 = hlist;</span>
1429 <span class="comment">%             VCMlist1 = vlist;</span>
1430 <span class="comment">%</span>
1431 <span class="comment">%             BPMlist1 = [</span>
1432 <span class="comment">%                 1 2</span>
1433 <span class="comment">%                 1 5</span>
1434 <span class="comment">%                 1 6</span>
1435 <span class="comment">%                 1 10</span>
1436 <span class="comment">%                 2 1</span>
1437 <span class="comment">%                 2 5</span>
1438 <span class="comment">%                 2 6</span>
1439 <span class="comment">%                 2 9</span>
1440 <span class="comment">%                 3 2</span>
1441 <span class="comment">%                 3 5</span>
1442 <span class="comment">%                 3 6</span>
1443 <span class="comment">%                 3 10</span>
1444 <span class="comment">%                 3 11</span>
1445 <span class="comment">%                 3 12</span>
1446 <span class="comment">%                 4 1</span>
1447 <span class="comment">%                 4 5</span>
1448 <span class="comment">%                 4 6</span>
1449 <span class="comment">%                 4 10</span>
1450 <span class="comment">%                 5 1</span>
1451 <span class="comment">%                 5 5</span>
1452 <span class="comment">%                 5 6</span>
1453 <span class="comment">%                 5 10</span>
1454 <span class="comment">%                 5 11</span>
1455 <span class="comment">%                 5 12</span>
1456 <span class="comment">%                 6 1</span>
1457 <span class="comment">%                 6 5</span>
1458 <span class="comment">%                 6 6</span>
1459 <span class="comment">%                 6 10</span>
1460 <span class="comment">%                 7 1</span>
1461 <span class="comment">%                 7 5</span>
1462 <span class="comment">%                 7 6</span>
1463 <span class="comment">%                 7 10</span>
1464 <span class="comment">%                 8 1</span>
1465 <span class="comment">%                 8 5</span>
1466 <span class="comment">%                 8 6</span>
1467 <span class="comment">%                 8 10</span>
1468 <span class="comment">%                 9 1</span>
1469 <span class="comment">%                 9 5</span>
1470 <span class="comment">%                 9 6</span>
1471 <span class="comment">%                 9 10</span>
1472 <span class="comment">%                 10 1</span>
1473 <span class="comment">%                 10 5</span>
1474 <span class="comment">%                 10 6</span>
1475 <span class="comment">%                 10 10</span>
1476 <span class="comment">%                 10 11</span>
1477 <span class="comment">%                 10 12</span>
1478 <span class="comment">%                 11 1</span>
1479 <span class="comment">%                 11 5</span>
1480 <span class="comment">%                 11 6</span>
1481 <span class="comment">%                 11 10</span>
1482 <span class="comment">%                 12 1</span>
1483 <span class="comment">%                 12 5</span>
1484 <span class="comment">%                 12 6</span>
1485 <span class="comment">%                 12 9];</span>
1486 <span class="comment">%</span>
1487 <span class="comment">%             % SVD orbit correction</span>
1488 <span class="comment">%             Xivec = [1:28];</span>
1489 <span class="comment">%             Yivec = [1:51];</span>
1490 <span class="comment">%</span>
1491 <span class="comment">%</span>
1492 <span class="comment">%             % Look for bad status BPMs</span>
1493 <span class="comment">%             iStatus = family2status('BPMx', BPMlist1);</span>
1494 <span class="comment">%             iBad = find(~iStatus);</span>
1495 <span class="comment">%             BPMlist1 = BPMlist1(find(iStatus),:);</span>
1496 <span class="comment">%             if length(iBad)</span>
1497 <span class="comment">%                 fprintf('   Global Orbit Correction: %d BPMs removed for bad status\n', length(iBad));</span>
1498 <span class="comment">%                 Yivec = Yivec(1:end-length(iBad));</span>
1499 <span class="comment">%             end</span>
1500 <span class="comment">%</span>
1501 <span class="comment">%             iStatus = family2status('HCM', HCMlist1);</span>
1502 <span class="comment">%             iBad = find(~iStatus);</span>
1503 <span class="comment">%             HCMlist1 = HCMlist1(find(iStatus),:);</span>
1504 <span class="comment">%             if length(iBad)</span>
1505 <span class="comment">%                 fprintf('   Global Orbit Correction: %d HCMs removed for bad status\n', length(iBad));</span>
1506 <span class="comment">%             end</span>
1507 <span class="comment">%</span>
1508 <span class="comment">%             iStatus = family2status('VCM', VCMlist1);</span>
1509 <span class="comment">%             iBad = find(~iStatus);</span>
1510 <span class="comment">%             VCMlist1 = VCMlist1(find(iStatus),:);</span>
1511 <span class="comment">%             if length(iBad)</span>
1512 <span class="comment">%                 fprintf('   Global Orbit Correction: %d VCMs removed for bad status\n', length(iBad));</span>
1513 <span class="comment">%             end</span>
1514 
1515             <span class="comment">% Initialize RFCorrFlag</span>
1516             RFCorrFlag = <span class="string">'Yes'</span>;
1517 
1518             <span class="comment">% Get the device lists from oscsinit and convert to srcontrol variables</span>
1519             [HBPM, VBPM, HCM, VCM, HSV, VSV] = <a href="ocsinit.html" class="code" title="function [HBPM, VBPM, HCM, VCM, HSV, VSV] = ocsinit(MethodName)">ocsinit</a>(<span class="string">'TopOfFill'</span>);
1520             <span class="keyword">if</span> strcmpi(RFCorrFlag, <span class="string">'Yes'</span>)
1521                 Xivec = 1:HSV+1;
1522             <span class="keyword">else</span>
1523                 Xivec = 1:HSV;
1524             <span class="keyword">end</span>
1525             Yivec = 1:VSV;
1526             BPMlist1 = HBPM.DeviceList;
1527             HCMlist1 = HCM.DeviceList;
1528             VCMlist1 = VCM.DeviceList;
1529             
1530             
1531             LocalBumplist = [
1532               <span class="comment">% 1 1</span>
1533               <span class="comment">% 2 1</span>
1534               <span class="comment">% 3 1</span>
1535                 4 1
1536               <span class="comment">% 4 2</span>
1537                 5 1
1538               <span class="comment">% 6 1</span>
1539               <span class="comment">% 6 2</span>
1540                 7 1
1541                 8 1
1542                 9 1
1543                 10 1
1544                 11 1
1545                 11 2
1546                 12 1
1547                 ];
1548             <span class="comment">%LocalBumplist = []</span>
1549             
1550 
1551         <span class="keyword">else</span>
1552 
1553             <span class="comment">% Get vectors</span>
1554             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>);
1555             BPMlist1 = FB.BPMlist1;
1556             HCMlist1 = FB.HCMlist1;
1557             VCMlist1 = FB.VCMlist1;
1558             Xivec = FB.Xivec;
1559             Yivec = FB.Yivec;
1560             LocalBumplist = FB.LocalBumplist;
1561             Xgoal = FB.Xgoal;
1562             Ygoal = FB.Ygoal;
1563             RFCorrFlag = FB.RFCorrFlag;
1564 
1565             <span class="comment">% Add button to change #ivectors, CMs, IDBPMs,</span>
1566             EditFlag = 0;
1567             h_fig1 = figure;
1568             <span class="keyword">while</span> EditFlag ~= 8
1569 
1570                 <span class="comment">% Sensitivity matrix</span>
1571                 Sx = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
1572                 Sy = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
1573                 
1574                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1575                 <span class="comment">% Can the call below work for setting FOFB RF parameter? %</span>
1576                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1577                 <span class="keyword">if</span> strcmpi(RFCorrFlag, <span class="string">'Yes'</span>)
1578                     Sx = [Sx getdisp(<span class="string">'BPMx'</span>,BPMlist1)];
1579                 <span class="keyword">end</span>
1580                 
1581                 Sx(isnan(Sx)) = 0;
1582                 Sy(isnan(Sy)) = 0;
1583                                
1584                 [Ux, SVx, Vx] = svd(Sx);
1585                 [Uy, SVy, Vy] = svd(Sy);
1586 
1587 
1588                 <span class="comment">% Remove singular values greater than the actual number of singular values</span>
1589                 i = find(Xivec&gt;length(diag(SVx)));
1590                 <span class="keyword">if</span> ~isempty(i)
1591                     disp(<span class="string">'   Horizontal E-vector scaled since there were more elements in the vector than singular values.'</span>);
1592                     pause(0);
1593                     Xivec(i) = [];
1594                 <span class="keyword">end</span>
1595                 i = find(Yivec&gt;length(diag(SVy)));
1596                 <span class="keyword">if</span> ~isempty(i)
1597                     disp(<span class="string">'   Vertical E-vector scaled since there were more elements in the vector than singular values.'</span>);
1598                     pause(0);
1599                     Yivec(i) = [];
1600                 <span class="keyword">end</span>
1601 
1602 
1603                 Ax = Sx*Vx(:,Xivec);
1604                 Tx = inv(Ax'*Ax)*Ax';
1605 
1606                 Ay = Sy*Vy(:,Yivec);
1607                 Ty = inv(Ay'*Ay)*Ay';
1608 
1609 
1610                 figure(h_fig1);
1611                 subplot(2,1,1);
1612                 semilogy(diag(SVx),<span class="string">'b'</span>);
1613                 hold on;
1614                 semilogy(diag(SVx(Xivec,Xivec)),<span class="string">'xr'</span>);
1615                 ylabel(<span class="string">'Horizontal'</span>);
1616                 title(<span class="string">'Response Matrix Singular Values'</span>);
1617                 hold off;
1618                 subplot(2,1,2);
1619                 semilogy(diag(SVy),<span class="string">'b'</span>);
1620                 hold on;
1621                 semilogy(diag(SVy(Yivec,Yivec)),<span class="string">'xr'</span>);
1622                 xlabel(<span class="string">'Singular Value Number'</span>);
1623                 ylabel(<span class="string">'Vertical'</span>);
1624                 hold off;
1625                 drawnow;
1626 
1627                 <span class="keyword">if</span> strcmp(RFCorrFlag,<span class="string">'No'</span>)
1628                     RFCorrState = <span class="string">'NOT CORRECTED'</span>;
1629                 <span class="keyword">elseif</span> strcmp(RFCorrFlag,<span class="string">'Yes'</span>)
1630                     RFCorrState = <span class="string">'CORRECTED'</span>;
1631                 <span class="keyword">else</span>
1632                     RFCorrState = <span class="string">'???'</span>;
1633                 <span class="keyword">end</span>
1634 
1635                 <span class="comment">%         EditFlag = menu('Change Parameters?','Singular Values','HCM List','VCM List','HCM Chicane List','VCM Chicane List','IDBPM List','BBPM List','Change Golden Orbit',...</span>
1636                 <span class="comment">%            'Local Bump List',sprintf('RF Frequency (currently %s)',RFCorrState),'Continue');</span>
1637                 EditFlag = menu(<span class="string">'Change Parameters?'</span>,<span class="string">'Singular Values'</span>,<span class="string">'HCM List'</span>,<span class="string">'VCM List'</span>,<span class="string">'BPM List'</span>,<span class="string">'Change Golden Orbit'</span>,<span class="keyword">...</span>
1638                     <span class="string">'Local Bump List'</span>,sprintf(<span class="string">'RF Frequency (currently %s)'</span>,RFCorrState),<span class="string">'Continue'</span>);
1639 
1640                 <span class="keyword">if</span> EditFlag == 1
1641                     prompt={<span class="string">'Enter the horizontal E-vector numbers (Matlab vector format):'</span>,<span class="string">'Enter the vertical E-vector numbers (Matlab vector format):'</span>};
1642                     def={sprintf(<span class="string">'[%d:%d]'</span>,1,Xivec(end)),sprintf(<span class="string">'[%d:%d]'</span>,1,Yivec(end))};
1643                     titlestr=<span class="string">'SVD Orbit Feedback'</span>;
1644                     lineNo=1;
1645                     answer=inputdlg(prompt,titlestr,lineNo,def);
1646                     <span class="keyword">if</span> ~isempty(answer)
1647                         XivecNew = fix(str2num(answer{1}));
1648                         <span class="keyword">if</span> isempty(XivecNew)
1649                             disp(<span class="string">'   Horizontal E-vector cannot be empty.  No change made.'</span>);
1650                         <span class="keyword">else</span>
1651                             <span class="keyword">if</span> any(XivecNew&lt;=0) | max(XivecNew)&gt;length(diag(SVx))
1652                                 disp(<span class="string">'   Error reading horizontal E-vector.  No change made.'</span>);
1653                             <span class="keyword">else</span>
1654                                 Xivec = XivecNew;
1655                             <span class="keyword">end</span>
1656                         <span class="keyword">end</span>
1657                         YivecNew = fix(str2num(answer{2}));
1658                         <span class="keyword">if</span> isempty(YivecNew)
1659                             disp(<span class="string">'   Vertical E-vector cannot be empty.  No change made.'</span>);
1660                         <span class="keyword">else</span>
1661                             <span class="keyword">if</span> any(YivecNew&lt;=0) | max(YivecNew)&gt;length(diag(SVy))
1662                                 disp(<span class="string">'   Error reading vertical E-vector.  No change made.'</span>);
1663                             <span class="keyword">else</span>
1664                                 Yivec = YivecNew;
1665                             <span class="keyword">end</span>
1666                         <span class="keyword">end</span>
1667                     <span class="keyword">end</span>
1668                 <span class="keyword">end</span>
1669 
1670                 <span class="keyword">if</span> EditFlag == 2
1671                     List = getlist(<span class="string">'HCM'</span>);
1672                     CheckList = zeros(size(List,1));
1673                     Elem = dev2elem(<span class="string">'HCM'</span>, HCMlist1);
1674                     CheckList(Elem) = ones(size(Elem));
1675                     CheckList = CheckList(dev2elem(<span class="string">'HCM'</span>,List));
1676                     newList = editlist(List, <span class="string">'HCM'</span>, CheckList);
1677                     <span class="keyword">if</span> isempty(newList)
1678                         fprintf(<span class="string">'   Horizontal corrector magnet list cannot be empty.  No change made.\n'</span>);
1679                     <span class="keyword">else</span>
1680                         HCMlist1 = newList;
1681                     <span class="keyword">end</span>
1682                 <span class="keyword">end</span>
1683 
1684                 <span class="keyword">if</span> EditFlag == 3
1685                     List = getlist(<span class="string">'VCM'</span>);
1686                     CheckList = zeros(size(List,1));
1687                     Elem = dev2elem(<span class="string">'VCM'</span>, VCMlist1);
1688                     CheckList(Elem) = ones(size(Elem));
1689                     CheckList = CheckList(dev2elem(<span class="string">'VCM'</span>,List));
1690                     newList = editlist(List, <span class="string">'VCM'</span>, CheckList);
1691                     <span class="keyword">if</span> isempty(newList)
1692                         fprintf(<span class="string">'   Vertical corrector magnet cannot be empty.  No change made.\n'</span>);
1693                     <span class="keyword">else</span>
1694                         VCMlist1 = newList;
1695                     <span class="keyword">end</span>
1696                 <span class="keyword">end</span>
1697 
1698                 <span class="keyword">if</span> EditFlag == 4
1699                     ListOld = BPMlist1;
1700                     XgoalOld = Xgoal;
1701                     YgoalOld = Ygoal;
1702 
1703                     <span class="comment">% Full BPM list</span>
1704                     List = <a href="getbpmlist.html" class="code" title="function [DeviceList, Index] = getbpmlist(varargin)">getbpmlist</a>(<span class="string">'Bergoz'</span>);
1705 <span class="comment">%                     List = [</span>
1706 <span class="comment">%                         1 2</span>
1707 <span class="comment">%                         1 5</span>
1708 <span class="comment">%                         1 6</span>
1709 <span class="comment">%                         1 10</span>
1710 <span class="comment">%                         2 1</span>
1711 <span class="comment">%                         2 5</span>
1712 <span class="comment">%                         2 6</span>
1713 <span class="comment">%                         2 9</span>
1714 <span class="comment">%                         3 2</span>
1715 <span class="comment">%                         3 5</span>
1716 <span class="comment">%                         3 6</span>
1717 <span class="comment">%                         3 10</span>
1718 <span class="comment">%                         3 11</span>
1719 <span class="comment">%                         3 12</span>
1720 <span class="comment">%                         4 1</span>
1721 <span class="comment">%                         4 5</span>
1722 <span class="comment">%                         4 6</span>
1723 <span class="comment">%                         4 10</span>
1724 <span class="comment">%                         5 1</span>
1725 <span class="comment">%                         5 5</span>
1726 <span class="comment">%                         5 6</span>
1727 <span class="comment">%                         5 10</span>
1728 <span class="comment">%                         5 11</span>
1729 <span class="comment">%                         5 12</span>
1730 <span class="comment">%                         6 1</span>
1731 <span class="comment">%                         6 5</span>
1732 <span class="comment">%                         6 6</span>
1733 <span class="comment">%                         6 10</span>
1734 <span class="comment">%                         7 1</span>
1735 <span class="comment">%                         7 5</span>
1736 <span class="comment">%                         7 6</span>
1737 <span class="comment">%                         7 10</span>
1738 <span class="comment">%                         8 1</span>
1739 <span class="comment">%                         8 5</span>
1740 <span class="comment">%                         8 6</span>
1741 <span class="comment">%                         8 10</span>
1742 <span class="comment">%                         9 1</span>
1743 <span class="comment">%                         9 5</span>
1744 <span class="comment">%                         9 6</span>
1745 <span class="comment">%                         9 10</span>
1746 <span class="comment">%                         10 1</span>
1747 <span class="comment">%                         10 5</span>
1748 <span class="comment">%                         10 6</span>
1749 <span class="comment">%                         10 10</span>
1750 <span class="comment">%                         10 11</span>
1751 <span class="comment">%                         10 12</span>
1752 <span class="comment">%                         11 1</span>
1753 <span class="comment">%                         11 5</span>
1754 <span class="comment">%                         11 6</span>
1755 <span class="comment">%                         11 10</span>
1756 <span class="comment">%                         12 1</span>
1757 <span class="comment">%                         12 5</span>
1758 <span class="comment">%                         12 6</span>
1759 <span class="comment">%                         12 9</span>
1760 <span class="comment">%                         ];</span>
1761 
1762                     CheckList = zeros(size(List,1),1);
1763                     <span class="keyword">if</span> ~isempty(BPMlist1)
1764                         <span class="keyword">for</span> i = 1:size(List,1)
1765                             k = find(List(i,1)==BPMlist1(:,1));
1766                             l = find(List(i,2)==BPMlist1(k,2));
1767 
1768                             <span class="keyword">if</span> isempty(k) | isempty(l)
1769                                 <span class="comment">% Item not in list</span>
1770                             <span class="keyword">else</span>
1771                                 CheckList(i) = 1;
1772                             <span class="keyword">end</span>
1773                         <span class="keyword">end</span>
1774                     <span class="keyword">end</span>
1775 
1776                     newList = editlist(List, <span class="string">'BPM'</span>, CheckList);
1777                     <span class="keyword">if</span> isempty(newList)
1778                         fprintf(<span class="string">'   BPM list cannot be empty.  No change made.\n'</span>);
1779                     <span class="keyword">else</span>
1780                         BPMlist1 = newList;
1781                     <span class="keyword">end</span>
1782 
1783                     <span class="comment">% Set the goal orbit to the golden orbit</span>
1784                     Xgoal = getgolden(<span class="string">'BPMx'</span>, BPMlist1);
1785                     Ygoal = getgolden(<span class="string">'BPMy'</span>, BPMlist1);
1786 
1787 
1788                     <span class="comment">% If a new BPM is added, then set the goal orbit to the golden orbit</span>
1789                     <span class="keyword">for</span> i = 1:size(BPMlist1,1)
1790 
1791                         <span class="comment">% Is it a new BPM?</span>
1792                         k = find(BPMlist1(i,1)==ListOld(:,1));
1793                         l = find(BPMlist1(i,2)==ListOld(k,2));
1794 
1795                         <span class="keyword">if</span> isempty(k) | isempty(l)
1796                             <span class="comment">% New BPM</span>
1797                         <span class="keyword">else</span>
1798                             <span class="comment">% Use the old value for old BPM</span>
1799                             Xgoal(i) = XgoalOld(k(l));
1800                             Ygoal(i) = YgoalOld(k(l));
1801                         <span class="keyword">end</span>
1802                     <span class="keyword">end</span>
1803                 <span class="keyword">end</span>
1804 
1805                 <span class="keyword">if</span> EditFlag == 5
1806 
1807                     ChangeList = editlist(BPMlist1, <span class="string">'Change BPM'</span>, zeros(size(BPMlist1,1),1));
1808                     <span class="keyword">for</span> i = 1:size(ChangeList,1)
1809 
1810                         k = find(ChangeList(i,1)==BPMlist1(:,1));
1811                         l = find(ChangeList(i,2)==BPMlist1(k,2));
1812 
1813                         prompt = {sprintf(<span class="string">'Enter the new horizontal goal orbit for BPMx(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2)),sprintf(<span class="string">'Enter the new vertical goal orbit for BPMy(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2))};
1814                         def = {sprintf(<span class="string">'%f'</span>,Xgoal(k(l))),sprintf(<span class="string">'%f'</span>,Ygoal(k(l)))};
1815                         titlestr = <span class="string">'CHANGE THE GOAL ORBIT'</span>;
1816                         lineNo = 1;
1817                         answer = inputdlg(prompt, titlestr, lineNo, def);
1818 
1819                         <span class="keyword">if</span> isempty(answer)
1820                             <span class="comment">% No change</span>
1821                             fprintf(<span class="string">'   No change was made to the golden orbit.\n'</span>);
1822                         <span class="keyword">else</span>
1823                             Xgoalnew = str2num(answer{1});
1824                             <span class="keyword">if</span> isempty(Xgoalnew)
1825                                 fprintf(<span class="string">'   No change was made to the horizontal golden orbit.\n'</span>);
1826                             <span class="keyword">else</span>
1827                                 Xgoal(k(l)) = Xgoalnew;
1828                             <span class="keyword">end</span>
1829 
1830                             Ygoalnew = str2num(answer{2});
1831                             <span class="keyword">if</span> isempty(Ygoalnew)
1832                                 fprintf(<span class="string">'   No change was made to the vertical golden orbit.\n'</span>);
1833                             <span class="keyword">else</span>
1834                                 Ygoal(k(l)) = Ygoalnew;
1835                             <span class="keyword">end</span>
1836                         <span class="keyword">end</span>
1837                     <span class="keyword">end</span>
1838                     <span class="keyword">if</span> ~isempty(ChangeList)
1839                         fprintf(<span class="string">'   Note:  changing the goal orbit for &quot;Orbit Correction&quot; does not change the goal orbit for &quot;Slow Orbit Feedback.&quot;\n'</span>);
1840                         fprintf(<span class="string">'          Re-running srcontrol will restart the goal orbit to the golden orbit.&quot;\n'</span>);
1841                     <span class="keyword">end</span>
1842                 <span class="keyword">end</span>
1843 
1844                 <span class="keyword">if</span> EditFlag == 6
1845                     List = [
1846                         1 1
1847                         2 1
1848                         3 1
1849                         4 1
1850                         4 2
1851                         5 1
1852                         6 1
1853                         6 2
1854                         7 1
1855                         8 1
1856                         9 1
1857                         10 1
1858                         11 1
1859                         11 2
1860                         12 1];
1861                     CheckList = zeros(size(List,1),1);
1862                     <span class="keyword">if</span> ~isempty(LocalBumplist)
1863                         <span class="keyword">for</span> i = 1:size(List,1)
1864                             k = find(List(i,1)==LocalBumplist(:,1));
1865                             l = find(List(i,2)==LocalBumplist(k,2));
1866 
1867                             <span class="keyword">if</span> isempty(k) | isempty(l)
1868                                 <span class="comment">% Item not in list</span>
1869                             <span class="keyword">else</span>
1870                                 CheckList(i) = 1;
1871                             <span class="keyword">end</span>
1872                         <span class="keyword">end</span>
1873                     <span class="keyword">end</span>
1874                     LocalBumplist = editlist2(List, <span class="string">'Sector'</span>, CheckList);
1875                 <span class="keyword">end</span>
1876 
1877                 <span class="keyword">if</span> EditFlag == 7
1878                     RFCorrFlag = questdlg(sprintf(<span class="string">'Set RF Frequency during Orbit Correction?'</span>),<span class="string">'RF Frequency'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>, <span class="string">'No'</span>);
1879                     <span class="keyword">if</span> strcmp(RFCorrFlag,<span class="string">'No'</span>)
1880                         disp([<span class="string">'   RF Frequency will not be included in global orbit correction.'</span>]);
1881                     <span class="keyword">elseif</span> strcmp(RFCorrFlag,<span class="string">'Yes'</span>)
1882                         disp([<span class="string">'   RF Frequency will be included in global orbit correction.'</span>]);
1883                     <span class="keyword">end</span>
1884 
1885                 <span class="keyword">end</span>
1886             <span class="keyword">end</span>
1887             close(h_fig1);
1888         <span class="keyword">end</span>
1889 
1890         <span class="comment">%  ORBIT CORRECTION STRUCTURE (OCS)</span>
1891         <span class="comment">%    OCS.BPM (data structure)</span>
1892         <span class="comment">%    OCS.CM  (data structure)</span>
1893         <span class="comment">%    OCS.GoalOrbit</span>
1894         <span class="comment">%    OCS.NIter</span>
1895         <span class="comment">%    OCS.SVDIndex</span>
1896         <span class="comment">%    OCS.IncrementalFlag = 'Yes'/'No'</span>
1897         <span class="comment">%    OCS.BPMWeight</span>
1898         <span class="comment">%    OCS.Flags = { 'FitRF' , etc. }</span>
1899         OCSx.BPM = getx(BPMlist1, <span class="string">'struct'</span>);
1900         OCSx.CM = getsp(<span class="string">'HCM'</span>, HCMlist1, <span class="string">'struct'</span>);
1901         OCSx.GoalOrbit = getgolden(OCSx.BPM, <span class="string">'numeric'</span>);
1902         OCSx.NIter = 1;
1903         OCSx.SVDIndex = Xivec;
1904         OCSx.IncrementalFlag = <span class="string">'No'</span>;
1905         OCSx.FitRF = 1;
1906         OCSy.BPM = gety(BPMlist1, <span class="string">'struct'</span>);
1907         OCSy.CM = getsp(<span class="string">'VCM'</span>, VCMlist1, <span class="string">'struct'</span>);
1908         OCSy.GoalOrbit = getgolden(OCSy.BPM, <span class="string">'numeric'</span>);
1909         OCSy.NIter = 1;
1910         OCSy.SVDIndex = Yivec;
1911         OCSy.IncrementalFlag = <span class="string">'No'</span>;
1912         OCSy.FitRF = 0;
1913 
1914         <span class="comment">% Save vectors</span>
1915         FB.OCSx = OCSx;
1916         FB.OCSy = OCSy;
1917 
1918         FB.BPMlist1 = BPMlist1;
1919         FB.HCMlist1 = HCMlist1;
1920         FB.VCMlist1 = VCMlist1;
1921         FB.Xivec = Xivec;
1922         FB.Yivec = Yivec;
1923         FB.Xgoal = OCSx.GoalOrbit;
1924         FB.Ygoal = OCSy.GoalOrbit;
1925         FB.RFCorrFlag = RFCorrFlag;
1926         FB.LocalBumplist = LocalBumplist;
1927         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>,FB);
1928         
1929         
1930     <span class="keyword">case</span> <span class="string">'Feedback'</span>
1931 
1932         FBloopIter = 1;
1933         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxFOFB'</span>),<span class="string">'Value'</span>) == 1
1934             StartFOFBFlag = 1;
1935         <span class="keyword">else</span>
1936             StartFOFBFlag = 0;
1937         <span class="keyword">end</span>
1938 
1939         FEEDBACK_STOP_FLAG = 0;
1940         HWarnNum=0;
1941         VWarnNum=0;
1942 
1943         SR_GeV = getenergy;
1944         <span class="comment">% Feedback loop setup</span>
1945         PlotInfoFlag = 0;           <span class="comment">% Plot micado stuff</span>
1946         LoopDelay = 1.0;           <span class="comment">% Period of feedback loop [seconds], make sure the BPM averaging is correct</span>
1947         VCM_LSB = .00366211;
1948         VCMCHICANE_LSB = .002441;   <span class="comment">% 80 max?,  Note: not fully implemented</span>
1949 
1950         <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
1951             Xgain  = 0.2;
1952             Ygain  = 0.1;
1953         <span class="keyword">else</span>
1954             Xgain  = 0.8; <span class="comment">% raised 0.5-&gt;0.8 at 17:20, 3-2-05 to more quickly correct EPU4 fast switching orbit distortions</span>
1955             Ygain  = 0.8;
1956         <span class="keyword">end</span>
1957 
1958         <span class="comment">% Load lattice set for tune feed forward</span>
1959         ConfigSetpoint = getproductionlattice;
1960         <span class="comment">%load([getfamilydata('Directory','OpsData') getfamilydata('OpsData','LatticeFile')]);</span>
1961         QFsp = ConfigSetpoint.QF.Setpoint.Data;
1962         QDsp = ConfigSetpoint.QD.Setpoint.Data;
1963         TuneW16Min = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(5, 13.23, 1.8909);
1964         <span class="comment">% Tune response matrix</span>
1965         SR_TUNE_MATRIX = gettuneresp({<span class="string">'QF'</span>,<span class="string">'QD'</span>}, {[],[]}, getenergy(<span class="string">'Production'</span>));    <span class="comment">% Approx. [0.1944 -0.0286;-0.1182 0.1526];</span>
1966         <span class="comment">%SR_TUNE_MATRIX = [0.1641 -0.0245</span>
1967         <span class="comment">%                 -0.1149 0.1477];</span>
1968         
1969         SQSFsp = <a href="amp2k.html" class="code" title="function [k, B] = amp2k(Family, Field, Amps, DeviceList, Energy, BranchFlag)">amp2k</a>(<span class="string">'SQSF'</span>,<span class="string">'Setpoint'</span>,ConfigSetpoint.SQSF.Setpoint.Data);
1970         SQSDsp = <a href="amp2k.html" class="code" title="function [k, B] = amp2k(Family, Field, Amps, DeviceList, Energy, BranchFlag)">amp2k</a>(<span class="string">'SQSD'</span>,<span class="string">'Setpoint'</span>,ConfigSetpoint.SQSD.Setpoint.Data);
1971 
1972 <span class="comment">%         % tune FF for EPUs (data exist for 4 1 parallel, 11 1 parallel and antiparallel</span>
1973 <span class="comment">%         load '/home/als/physdata/matlab/srdata/gaptrack/EPU4-1_tunecomp/after_shimming/nux_map_withgaps.mat'</span>
1974 <span class="comment">%         dnux_epu_41_m0 = tunexmap(2:end,2:end)-tunexmap(2,12);</span>
1975 <span class="comment">%         [gap_epu_41,shift_epu_41]=meshgrid(tunexmap(2:end,1),tunexmap(1,2:end));</span>
1976 <span class="comment">%         load '/home/als/physdata/matlab/srdata/gaptrack/EPU4-1_tunecomp/after_shimming/nuy_map_withgaps.mat'</span>
1977 <span class="comment">%         dnuy_epu_41_m0 = tuneymap(2:end,2:end)-tuneymap(2,12);</span>
1978 <span class="comment">%</span>
1979 <span class="comment">%         load '/home/als/physdata/matlab/srdata/gaptrack/archive/epu11d1m0e19_2007-01-28.mat' tune_x tune_y Gaps GapsLongitudinal</span>
1980 <span class="comment">%         dnux_epu_111_m0 = tune_x-tune_x(1,11);</span>
1981 <span class="comment">%         [gap_epu_111,shift_epu_111]=meshgrid(Gaps,GapsLongitudinal);</span>
1982 <span class="comment">%         dnuy_epu_111_m0 = tune_y-tune_y(1,11);</span>
1983 <span class="comment">%         load '/home/als/physdata/matlab/srdata/gaptrack/archive/epu11d1m1e19_2007-01-28.mat' tune_x tune_y Gaps GapsLongitudinal</span>
1984 <span class="comment">%         dnux_epu_111_m1 = tune_x-tune_x(1,11);</span>
1985 <span class="comment">%         dnuy_epu_111_m1 = tune_y-tune_y(1,11);</span>
1986 
1987         <span class="comment">% tune FF for EPUs (data exist for 4 1 parallel, 11 1 parallel and antiparallel</span>
1988         load <span class="string">'/home/als/physdata/matlab/srdata/epu/tuneshift_2d_tables/epu_tunetables_2d_20070723.mat'</span>
1989         dnux41p = nux41p-nux41p(1,11);      
1990         dnuy41p = nuy41p-nuy41p(1,11);      
1991         dnux41a = nux41a-nux41a(1,11);      
1992         dnuy41a = nuy41a-nuy41a(1,11);      
1993         dnux111p = nux111p-nux111p(1,11);      
1994         dnuy111p = nuy111p-nuy111p(1,11);      
1995         dnux111a = nux111a-nux111a(1,11);      
1996         dnuy111a = nuy111a-nuy111a(1,11);      
1997         dnux112p = nux112p-nux112p(1,11);      
1998         dnuy112p = nuy112p-nuy112p(1,11);      
1999         dnux112a = nux112a-nux112a(1,11);      
2000         dnuy112a = nuy112a-nuy112a(1,11);      
2001         
2002         <span class="comment">% ID tune compensation does not work in the injection lattice, so ...</span>
2003         <span class="keyword">if</span> abs(SR_GEV - <a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>)&gt;  0.05     <span class="comment">% Don't use this routine for the injection lattice</span>
2004             fprintf(<span class="string">'   This routine should only be used for the production energy: Orbit feedback aborted\n'</span>);
2005             <span class="keyword">return</span>
2006         <span class="keyword">end</span>
2007 
2008         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
2009 
2010         <span class="keyword">try</span>
2011             fprintf(<span class="string">'\n'</span>);
2012             fprintf(<span class="string">'   *******************************\n'</span>);
2013             fprintf(<span class="string">'   **  Starting Orbit Feedback  **\n'</span>);
2014             fprintf(<span class="string">'   *******************************\n'</span>);
2015             a = clock;
2016             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2017             fprintf(<span class="string">'   Note: the Matlab command window will be used to display status information.\n'</span>);
2018             fprintf(<span class="string">'         It cannot be used to enter commands during slow orbit feedback.\n'</span>);
2019 
2020 
2021                 <span class="comment">% save current BPM timeconstant - will reset to this when feedback stops</span>
2022                 BPMtimeconstantOFB = <a href="getbpmtimeconstant.html" class="code" title="function [BPMTimeConstant, WarningFlag] = getbpmtimeconstant(varargin)">getbpmtimeconstant</a>;
2023                 fprintf(<span class="string">'   Current Bergoz BPM time constant is %.1fs\n'</span>, BPMtimeconstantOFB);
2024                 
2025             <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
2026             disp(<span class="string">'   Bergoz BPM time constant set to 0.2s.'</span>)
2027             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.2)
2028             pause(1.1);
2029 
2030             <span class="comment">% Check whether bumps and kickers are on and warn to turn off before starting feedback if necessary</span>
2031             <span class="keyword">try</span>
2032                 <span class="keyword">if</span> (getsp(<span class="string">'SR01S___BUMP1__BC21'</span>)==1 &amp; getsp(<span class="string">'SR01S___BUMP1P_BC22'</span>)==1) | (getsp(<span class="string">'SR01S___SEK____BC21'</span>)==1 &amp; getsp(<span class="string">'SR01S___SEK_P__BC23'</span>)==1) | (getsp(<span class="string">'SR01S___SEN____BC20'</span>)==1 &amp; getsp(<span class="string">'SR01S___SEN_P__BC22'</span>)==1)
2033                     soundtada;
2034                     fprintf(<span class="string">'   \n'</span>);
2035                     fprintf(<span class="string">'   *********************************************************************************\n'</span>);
2036                     fprintf(<span class="string">'   ** One or more of the pulsed SR injection magnets is still on!  Turn them off! **\n'</span>);
2037                     fprintf(<span class="string">'   *********************************************************************************\n'</span>);
2038                     fprintf(<span class="string">'   \n'</span>);
2039                 <span class="keyword">end</span>
2040             <span class="keyword">catch</span>
2041                 disp(<span class="string">'**Problem checking the state of the bumps and kickers - please check that they are not pulsing.'</span>);
2042             <span class="keyword">end</span>
2043 
2044             <span class="comment">% Get vectors</span>
2045 
2046             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
2047 
2048             BPMlist1 = FB.OCSx.BPM.DeviceList;
2049             <span class="comment">% FOFB_BPMlist =</span>
2050             HCMlist1 = FB.HCMlist1;
2051             VCMlist1 = FB.VCMlist1;
2052             Xivec = FB.Xivec;
2053             Yivec = FB.Yivec;
2054             Xgoal = FB.OCSx.GoalOrbit;
2055             Ygoal = FB.OCSy.GoalOrbit;
2056             FFTypeFlag = FB.FFTypeFlag;   <span class="comment">%local or global tune correction</span>
2057 
2058             iNotHCMChicane = find(HCMlist1(:,2) &lt; 10); <span class="comment">%used by steppv's for setting correctors in loop</span>
2059             iHCMChicane = find(HCMlist1(:,2) == 10);
2060             iNotVCMChicane = find(VCMlist1(:,2) &lt; 10);
2061             iVCMChicane = find(VCMlist1(:,2) == 10);
2062 
2063             <span class="comment">% Sensitivity matrix for setting fast feedback setpoints</span>
2064             Sx1 = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
2065             Sy1 = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
2066 
2067         <span class="keyword">catch</span>
2068             fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
2069 
2070             <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2071             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2072             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2073 
2074 
2075             a = clock;
2076             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2077             fprintf(<span class="string">'   *************************************************************\n'</span>);
2078             fprintf(<span class="string">'   **  Orbit feedback could not start due to error condition  **\n'</span>);
2079             fprintf(<span class="string">'   *************************************************************\n\n'</span>);
2080             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
2081             pause(0);
2082 
2083             <span class="keyword">return</span>
2084         <span class="keyword">end</span>
2085 
2086         StartFlag = questdlg(strvcat(<span class="string">''</span>,<span class="string">'Is it OK to start orbit feedback?'</span>),<span class="string">'Orbit Feedback'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
2087         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
2088             <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2089             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2090             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2091 
2092             a = clock;
2093             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2094             fprintf(<span class="string">'   ***************************\n'</span>);
2095             fprintf(<span class="string">'   **  Orbit Feedback Exit  **\n'</span>);
2096             fprintf(<span class="string">'   ***************************\n\n'</span>);
2097             pause(0);
2098             <span class="keyword">return</span>
2099         <span class="keyword">end</span>
2100 
2101         SR_STATE_OLD = scaget(<span class="string">'SR_STATE'</span>);
2102         setpv(<span class="string">'SR_STATE'</span>, 5);
2103         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
2104         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2105         <span class="keyword">if</span> StateNumber &gt;= 0
2106             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2107         <span class="keyword">else</span>
2108             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2109         <span class="keyword">end</span>
2110         fprintf(<span class="string">'   Using %d E-vectors horizontally.\n'</span>, length(Xivec));
2111         fprintf(<span class="string">'   Using %d E-vectors vertically.\n'</span>,   length(Yivec));
2112         fprintf(<span class="string">'   Starting slow orbit correction every %.1f seconds.\n'</span>, LoopDelay);
2113         <span class="comment">%  fprintf('   Resetting SR11 chicane motors every 20 seconds to fix drift problem.\n');</span>
2114 
2115         IDSector = getlist(<span class="string">'ID'</span>);
2116         EPUlist = find((IDSector(:,1)==4) | (IDSector(:,1)==11));
2117         oldgap=210*ones(size(IDSector,1),1);
2118         oldShift=zeros(size(oldgap));
2119           
2120         <span class="keyword">try</span>
2121             
2122             <span class="comment">% Get and display data</span>
2123             x = FB.OCSx.GoalOrbit - getx(FB.OCSx.BPM.DeviceList);
2124             y = FB.OCSy.GoalOrbit - gety(FB.OCSy.BPM.DeviceList);
2125             STDx = norm(x)/sqrt(length(x));
2126             STDy = norm(y)/sqrt(length(y));
2127             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = %.4f mm'</span>,STDx),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2128             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = %.4f mm'</span>,STDy),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2129 
2130             <span class="comment">% write goldenorbit values to Fast Orbit Feedback</span>
2131             <span class="keyword">try</span>
2132                 <a href="write_goldenorbit_ffb.html" class="code" title="function write_goldenorbit_ffb">write_goldenorbit_ffb</a>;
2133             <span class="keyword">catch</span>
2134                 disp(<span class="string">'write_goldenorbit_ffb did not work!'</span>);
2135             <span class="keyword">end</span>
2136             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2137             <span class="comment">%pause(0);</span>
2138 
2139             <span class="comment">%display state of FOFB system</span>
2140             FOFBStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2141                 getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2142                 getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2143                 getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2144             FOFBStatusStr = [<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>];
2145             <span class="keyword">for</span> loop = 1:size(FOFBStatus,2)
2146                 <span class="keyword">if</span> FOFBStatus(loop)==0
2147                     FOFBStatusStr(loop,:) = <span class="string">'OFF '</span>;
2148                 <span class="keyword">elseif</span> FOFBStatus(loop)==1
2149                     FOFBStatusStr(loop,:) = <span class="string">'ON  '</span>;
2150                 <span class="keyword">elseif</span> FOFBStatus(loop)==2
2151                     FOFBStatusStr(loop,:) = <span class="string">'OPEN'</span>;
2152                 <span class="keyword">else</span>
2153                     FOFBStatusStr(loop,:) = <span class="string">'BAD '</span>;
2154                 <span class="keyword">end</span>
2155             <span class="keyword">end</span>
2156             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 %s'</span>,FOFBStatusStr(1,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2157             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 %s'</span>,FOFBStatusStr(2,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2158             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 %s'</span>,FOFBStatusStr(3,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2159             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 %s'</span>,FOFBStatusStr(4,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2160             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 %s'</span>,FOFBStatusStr(5,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2161             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 %s'</span>,FOFBStatusStr(6,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2162             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 %s'</span>,FOFBStatusStr(7,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2163             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 %s'</span>,FOFBStatusStr(8,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2164             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 %s'</span>,FOFBStatusStr(9,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2165             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 %s'</span>,FOFBStatusStr(10,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2166             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 %s'</span>,FOFBStatusStr(11,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2167             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 %s'</span>,FOFBStatusStr(12,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2168 
2169         <span class="keyword">catch</span>
2170 
2171             fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
2172 
2173             <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2174             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2175             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2176 
2177 
2178             a = clock;
2179             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2180             fprintf(<span class="string">'   *************************************************************\n'</span>);
2181             fprintf(<span class="string">'   **  Orbit feedback could not start due to error condition  **\n'</span>);
2182             fprintf(<span class="string">'   *************************************************************\n\n'</span>);
2183 
2184             setpv(<span class="string">'SR_STATE'</span>,SR_STATE_OLD);
2185             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2186             <span class="keyword">if</span> StateNumber &gt;= 0
2187                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2188             <span class="keyword">else</span>
2189                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2190             <span class="keyword">end</span>
2191             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
2192             pause(0);
2193 
2194             <span class="keyword">return</span>
2195 
2196         <span class="keyword">end</span>
2197 
2198 
2199         <span class="comment">% Disable buttons</span>
2200         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
2201         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2202         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2203         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2204         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2205         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2206         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2207         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2208         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2209         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2210         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2211         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2212         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2213         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2214         pause(0);
2215 
2216 
2217         <span class="comment">% Initialize feedback loop</span>
2218         StartTime = gettime;
2219         StartErrorTime = gettime;
2220         Xold = getx(FB.OCSx.BPM.DeviceList);
2221         Yold = gety(FB.OCSy.BPM.DeviceList);
2222         HQMOFM_stalenum = 0;
2223         pause(LoopDelay);
2224 
2225         N_HCM = size(HCMlist1,1);
2226         N_VCM = size(VCMlist1,1);
2227 
2228         N_RFMO = 1;
2229 
2230         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
2231             [FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,<span class="string">'SetRF'</span>,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2232         <span class="keyword">else</span>
2233             [FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2234         <span class="keyword">end</span>
2235         [FB.OCSx, Smatx, Sx, Ux, Vx] = orbitcorrectionmethods(FB.OCSx);
2236 
2237         [FB.OCSy, junk, OCSy0] = setorbit(FB.OCSy,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2238         [FB.OCSy, Smaty, Sy, Uy, Vy] = orbitcorrectionmethods(FB.OCSy);
2239 
2240 
2241         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2242         <span class="comment">% Start feedback loop %</span>
2243         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2244 
2245         <span class="comment">% chicaneloop=1;  % loop variable for resetting drifting chicanes (see a few lines below)</span>
2246         <span class="comment">% fftest=figure;</span>
2247 
2248         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2); <span class="comment">% put FOFB in open loop so beamnoise gets recorded even if FOFB is not enabled</span>
2249 
2250         <span class="keyword">while</span> 1
2251             <span class="keyword">try</span>
2252                 t00 = gettime;
2253 
2254                 <span class="comment">%          if chicaneloop==20 % reset SR11 motor chicane setpoints every 20s due to drifting positions</span>
2255                 <span class="comment">%             setsp('HCMCHICANEM',HCMCHICANEMsp(6),[11 1],0);</span>
2256                 <span class="comment">%             setsp('HCMCHICANEM',HCMCHICANEMsp(7),[11 2],0);</span>
2257                 <span class="comment">%             chicaneloop = 1;</span>
2258                 <span class="comment">%          else</span>
2259                 <span class="comment">%             chicaneloop = chicaneloop + 1;</span>
2260                 <span class="comment">%          end</span>
2261 
2262                 <span class="comment">% Check if GUI has been closed</span>
2263                 <span class="keyword">if</span> isempty(gcbf)
2264                     FEEDBACK_STOP_FLAG = 1;
2265                     lasterr(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2266                     error(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2267                 <span class="keyword">end</span>
2268 
2269                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2270                 <span class="comment">% Fast orbit feedback %</span>
2271                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2272                 <span class="keyword">if</span> StartFOFBFlag == 1 &amp; FBloopIter &gt; 3
2273                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2274                     pause(0.5);
2275                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,1);
2276                     StartFOFBFlag = 0;
2277                     pause(1);
2278                     FOFBOnStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2279                         getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2280                         getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2281                         getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2282                     <span class="keyword">if</span> any(FOFBOnStatus==0) | any(FOFBOnStatus==2)
2283                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2); <span class="comment">% open FOFB loop</span>
2284                         disp(<span class="string">'************************************************************************************************************'</span>);
2285                         disp(<span class="string">'** Problem turning on Fast Orbit Feedback system...                                                       **'</span>);
2286                         disp(<span class="string">'** Check status of ffbsecXX crates - but remember that a crate reboot will turn off Quads in that sector! **'</span>);
2287                         disp(<span class="string">'** Suggest disabling the &quot;Fast Orbit Correction&quot; checkbox and starting Orbit Feedback again.              **'</span>);
2288                         disp(<span class="string">'************************************************************************************************************'</span>);
2289                     <span class="keyword">else</span>
2290                         fprintf(<span class="string">'   Starting Fast Orbit Feedback at %.0f Hz.\n'</span>, getpv(<span class="string">'SR01____FFBFREQAM00'</span>));
2291                     <span class="keyword">end</span>
2292                 <span class="keyword">end</span>
2293 
2294 
2295                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2296                 <span class="comment">% Horizontal plane &quot;feedback&quot; %</span>
2297                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2298 
2299                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxSOFB'</span>),<span class="string">'Value'</span>) == 1
2300 
2301                     <span class="comment">% Get orbit and check that the BPMs are different from the last update</span>
2302                     Xnew = getx(FB.OCSx.BPM.DeviceList);
2303 
2304                     <span class="comment">% Don't feedback if the current is too small</span>
2305                     <span class="keyword">if</span> getdcct &lt; 5
2306                         FEEDBACK_STOP_FLAG = 1;
2307                         fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2308                         <span class="keyword">break</span>;
2309                     <span class="keyword">end</span>
2310 
2311                     x = Xgoal - Xnew;
2312                     STDx = norm(x)/sqrt(length(x));
2313 
2314                     <span class="keyword">if</span> any(Xold == Xnew)
2315                         a = clock;
2316                         N_Stale_Data_Points = find((Xold==Xnew)==1);
2317                         <span class="keyword">for</span> loop = N_Stale_Data_Points'
2318                             fprintf(<span class="string">'   Stale data: BPMx(%2d,%d), feedback step skipped (%s %d:%d:%.0f). \n'</span>, FB.OCSx.BPM.DeviceList(loop,1), FB.OCSx.BPM.DeviceList(loop,2), date, a(4), a(5), a(6));
2319                         <span class="keyword">end</span>
2320                     <span class="keyword">else</span>
2321                         <span class="comment">% Compute horizontal correction</span>
2322                         <span class="comment">%%%OCSx0 = FB.OCSx;</span>
2323                         FB.OCSx.BPM.Data = Xnew;
2324                         FB.OCSx = orbitcorrectionmethods(FB.OCSx, Smatx, Sx, Ux, Vx);
2325 
2326                         <span class="comment">%%%[FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,'Nodisplay','Nosetsp');</span>
2327 
2328                         <span class="comment">% reduced feedback gain (implemented by Greg Portmann, December 2000)</span>
2329                         <span class="comment">% reduced to 0.1, C. Steier, 2001-09-04, IDBPMs are noisy at the moment</span>
2330                         <span class="comment">% increased back to 0.8 C. Steier, 2001-09-29, IDBPMs filtering + direct DAC read/write + all SVDs (no arc BPMs)</span>
2331                         <span class="comment">% increased to 1.0, C. Steier, 2002-05-04, trim DACs</span>
2332                         X = Xgain .* FB.OCSx.CM.Delta;
2333                         X(N_HCM+1) = 0.3*FB.OCSx.DeltaRF/4.988e-3;
2334                         <span class="comment">%%%X = Xgain .* (FB.OCSx.CM.Data - OCSx0.CM.Data);</span>
2335 
2336                         <span class="comment">% check corrector trim values + next step values, warn or stop FB as necessary</span>
2337                         HCMtrimSP=getpv(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1);
2338                         HCMtrimSP_next = HCMtrimSP + X(1:N_HCM);
2339                         <span class="keyword">if</span> max(abs(HCMtrimSP_next)) &gt; 4
2340                             HCMtrimnum=find(abs(HCMtrimSP_next) &gt; 4);
2341 
2342                             <span class="comment">% print message to screen</span>
2343                             fprintf(<span class="string">'**One or more of the horizontal correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2344                             fprintf(<span class="string">'%s\n'</span>,datestr(now));
2345                             <span class="keyword">for</span> loop = HCMtrimnum'
2346                                 fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1(loop,:)));
2347                             <span class="keyword">end</span>
2348 
2349                             <span class="comment">% send alphapage to operator pager</span>
2350                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2351                             FEEDBACK_STOP_FLAG = 1;
2352 
2353                             setpv(<span class="string">'SR_STATE'</span>, -5);
2354                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2355                             <span class="keyword">if</span> StateNumber &gt;= 0
2356                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2357                             <span class="keyword">else</span>
2358                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2359                             <span class="keyword">end</span>
2360                         <span class="keyword">end</span>
2361 
2362                         <span class="comment">% check chicane trim coil values + next step values, warn or stop FB as necessary</span>
2363                         HCMCHICANEtrimSP=getpv(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>,HCMlist1(iHCMChicane,:));
2364                         HCMCHICANEtrimSP_next = HCMCHICANEtrimSP + X(iHCMChicane);
2365                         <span class="keyword">if</span> max(abs(HCMCHICANEtrimSP_next)) &gt; 20
2366                             HCMCHICANEtrimnum=find(abs(HCMCHICANEtrimSP_next) &gt; 20);
2367 
2368                             <span class="comment">% print message to screen</span>
2369                             fprintf(<span class="string">'**One or more of the horizontal chicane trim coil correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2370                             fprintf(<span class="string">'%s\n'</span>,datestr(now));
2371                             <span class="keyword">for</span> loop = HCMCHICANEtrimnum'
2372                                 fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>,HCMlist1(loop,:)));
2373                             <span class="keyword">end</span>
2374                             fprintf(<span class="string">'**Maybe try resetting the setpoints of the motor chicanes in case they are drifting...\n'</span>);
2375 
2376                             <span class="comment">% send alphapage to operator pager</span>
2377                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2378                             FEEDBACK_STOP_FLAG = 1;
2379 
2380                             setpv(<span class="string">'SR_STATE'</span>, -5);
2381                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2382                             <span class="keyword">if</span> StateNumber &gt;= 0
2383                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2384                             <span class="keyword">else</span>
2385                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2386                             <span class="keyword">end</span>
2387                         <span class="keyword">end</span>
2388 
2389                         <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2390                             <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2391                             <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2392                                 disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2393                             <span class="keyword">end</span>
2394                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2395                             pause(0.5);
2396                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2397                             <span class="keyword">break</span>;
2398                         <span class="keyword">end</span>
2399 
2400                         <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2401                         pause(0);
2402 
2403                         <span class="keyword">if</span> max(abs(HCMtrimSP_next) &gt; 3)
2404                             HCMtrimnum=find(abs(HCMtrimSP_next) &gt; 3);
2405                             HWarnNum=HWarnNum+1;
2406                             <span class="keyword">if</span> (HWarnNum==1 | rem(HWarnNum,120)==0)
2407 
2408                                 <span class="comment">% print message to screen every two minutes</span>
2409                                 fprintf(<span class="string">'**One or more of the horizontal corrector trims is above 3A or below -3A! \n'</span>);
2410                                 fprintf(<span class="string">'%s\n'</span>,datestr(now));
2411                                 <span class="keyword">for</span> loop = HCMtrimnum'
2412                                     fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1(loop,:)));
2413                                 <span class="keyword">end</span>
2414                                 fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2415 
2416                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2417                                 <span class="keyword">if</span> (HWarnNum==1 | HWarnNum==600)
2418                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageHCM.txt
2419                                 <span class="keyword">end</span>
2420                             <span class="keyword">end</span>
2421                         <span class="keyword">elseif</span> max(abs(HCMCHICANEtrimSP_next) &gt; 15)
2422                             HCMCHICANEtrimnum=find(abs(HCMCHICANEtrimSP_next) &gt; 15);
2423                             HWarnNum=HWarnNum+1;
2424                             <span class="keyword">if</span> (HWarnNum==1 | rem(HWarnNum,120)==0)
2425 
2426                                 <span class="comment">% print message to screen every two minutes</span>
2427                                 fprintf(<span class="string">'**One or more of the horizontal chicane corrector trim coils is above 15A or below -15A! \n'</span>);
2428                                 fprintf(<span class="string">'%s\n'</span>,datestr(now));
2429                                 <span class="keyword">for</span> loop = HCMCHICANEtrimnum'
2430                                     fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>,HCMlist1(loop,:)));
2431                                 <span class="keyword">end</span>
2432                                 fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2433                                 
2434                                 <span class="comment">%reset motor chicanes in case they are drifting</span>
2435                                 <span class="comment">%try</span>
2436                                 <span class="comment">%        fprintf(' Resetting the setpoints of the motor chicanes in case they are drifting...\n');</span>
2437                                           <span class="comment">%        setpv('HCMCHICANEM','Setpoint',[],ConfigSetpoint.Setpoint.Data,0);</span>
2438                                           <span class="comment">%catch</span>
2439                                           <span class="comment">%end</span>
2440                                 
2441                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2442                                 <span class="keyword">if</span> (HWarnNum==1 | HWarnNum==600)
2443                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageHCMCHICANE.txt
2444                                 <span class="keyword">end</span>
2445                             <span class="keyword">end</span>
2446                         <span class="keyword">else</span>
2447                             HWarnNum=0;
2448                         <span class="keyword">end</span>
2449 
2450                         <span class="comment">% Don't feedback if the current is too small</span>
2451                         <span class="keyword">if</span> getdcct &lt; 5
2452                             FEEDBACK_STOP_FLAG = 1;
2453                             fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2454                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/beamisoff.txt
2455                             <span class="keyword">break</span>;
2456                         <span class="keyword">end</span>
2457 
2458                         <span class="keyword">if</span> N_HCM &gt; 0
2459                             steppv(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>, X(iNotHCMChicane), HCMlist1(iNotHCMChicane,:), 0);
2460                             steppv(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>, X(iHCMChicane), HCMlist1(iHCMChicane,:), 0);
2461                         <span class="keyword">end</span>
2462 
2463                         <span class="comment">% write fast orbit feedback setpoints</span>
2464                         <span class="keyword">if</span> 1
2465                             <span class="comment">%write_goldenorbit_ffb_2planes(1, Xnew(1:size(BPMlist1,1))+Sx1*X(1:N_HCM)+Sx3*X(length(X))/20, BPMlist1);</span>
2466                             <span class="comment">% should be corrected to include result of next frequency step ...</span>
2467                             <a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>(1,Xnew(1:size(BPMlist1,1))+Sx1*X(1:N_HCM),BPMlist1);
2468                         <span class="keyword">end</span>
2469 
2470                         <span class="comment">%fprintf('Horizontal Done: %f \n',gettime-t00);</span>
2471 
2472                         <span class="comment">% RF feedback</span>
2473                         HQMOFMsp_last = getpv(<span class="string">'EG______HQMOFM_AC01'</span>);
2474 
2475                         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
2476                             <span class="keyword">if</span> N_RFMO &gt; 0
2477                                 <span class="keyword">if</span> abs(X(end)) &lt; .01
2478                                     <span class="comment">% if abs(FB.OCSx.DeltaRF/3) &lt; .01</span>
2479                                     steppv(<span class="string">'EG______HQMOFM_AC01'</span>, X(end));
2480                                 <span class="keyword">else</span>
2481                                     steppv(<span class="string">'EG______HQMOFM_AC01'</span>, 0.01*sign(X(end)));
2482                                 <span class="keyword">end</span>
2483                             <span class="keyword">end</span>
2484 
2485                             HQMOFMsp_now = getpv(<span class="string">'EG______HQMOFM_AC01'</span>);
2486 
2487                             <span class="comment">% Check for stale RF feedback</span>
2488                             <span class="keyword">if</span> HQMOFMsp_last == HQMOFMsp_now
2489                                 HQMOFM_stalenum = HQMOFM_stalenum + 1;
2490                                 <span class="keyword">if</span> HQMOFM_stalenum == 30 <span class="comment">% warn and message to pager if stale for 30 secs</span>
2491                                     fprintf(<span class="string">'**The RF is not responding to orbit feedback changes! \n'</span>);
2492                                     fprintf(<span class="string">'%s\n'</span>,datestr(now));
2493                                     fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2494                                     fprintf(<span class="string">'**ILC 73 controls the EG______HQMOFM_AC01 channel, which sets the RF frequency. \n'</span>);
2495                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstaleRFmessage.txt
2496                                 <span class="keyword">end</span>
2497                                 <span class="keyword">if</span> rem(HQMOFM_stalenum,120)==0 <span class="comment">% message to screen every 2 minutes</span>
2498                                     fprintf(<span class="string">'**The RF is not responding to orbit feedback changes! (%s)\n'</span>,datestr(now));
2499                                 <span class="keyword">end</span>
2500                             <span class="keyword">else</span>
2501                                 HQMOFM_stalenum = 0;
2502                             <span class="keyword">end</span>
2503 
2504                         <span class="keyword">end</span>
2505 
2506                         <span class="comment">%fprintf('RF Done: %f \n',gettime-t00);</span>
2507 
2508                         Xold = Xnew;
2509                     <span class="keyword">end</span> <span class="comment">% End horizontal correction</span>
2510 
2511 
2512                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2513                     <span class="comment">% Vertical plane &quot;feedback&quot; %</span>
2514                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2515 
2516                     <span class="comment">% Get orbit and check that the BPMs are different from the last update</span>
2517                     Ynew = gety(FB.OCSy.BPM.DeviceList);
2518 
2519                     <span class="comment">% Don't feedback if the current is too small</span>
2520                     <span class="keyword">if</span> getdcct &lt; 5
2521                         FEEDBACK_STOP_FLAG = 1;
2522                         fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2523                         <span class="keyword">break</span>;
2524                     <span class="keyword">end</span>
2525 
2526                     y = Ygoal - Ynew;
2527                     STDy = norm(y)/sqrt(length(y));
2528 
2529                     <span class="keyword">if</span> any(Yold == Ynew)
2530                         a = clock;
2531                         N_Stale_Data_Points = find((Yold==Ynew)==1);
2532                         <span class="keyword">for</span> loop = N_Stale_Data_Points'
2533                             fprintf(<span class="string">'   Stale data: BPMy(%2d,%d), feedback step skipped (%s %d:%d:%.0f). \n'</span>, FB.OCSy.BPM.DeviceList(loop,1), FB.OCSy.BPM.DeviceList(loop,2), date, a(4), a(5), a(6));
2534                         <span class="keyword">end</span>
2535 
2536                     <span class="keyword">else</span>
2537 
2538                         <span class="comment">% Compute vertical correction</span>
2539                         <span class="comment">%%%OCSy0 = FB.OCSy;</span>
2540                         FB.OCSy.BPM.Data = Ynew;
2541                         FB.OCSy = orbitcorrectionmethods(FB.OCSy, Smaty, Sy, Uy, Vy);
2542 
2543                         <span class="comment">%%%[FB.OCSy, RF, OCSy0] = setorbit(FB.OCSy,'Nodisplay','Nosetsp');</span>
2544 
2545                         <span class="comment">% reduced feedback gain, C. Steier, 2001-03-25</span>
2546                         <span class="comment">% reduced to 0.1, C. Steier, 2001-09-04, IDBPMs are noisy at the moment</span>
2547                         <span class="comment">% increased back to 0.8, C. Steier, 2001-09-29, IDBPMs filtering + direct DAC read/write + all SVDs (no arc BPMs)</span>
2548                         <span class="comment">% set to unity gain, C. Steier, 2002-05-04, trim DACs</span>
2549                         Y = Ygain .* FB.OCSy.CM.Delta;
2550                         <span class="comment">%%%Y = Ygain .* (FB.OCSy.CM.Data - OCSy0.CM.Data);</span>
2551 
2552                         <span class="comment">% Just SVD correction</span>
2553                         <span class="comment">% warning('Not using &quot;micado&quot; correction in the vertical plane.');</span>
2554 
2555                         <span class="comment">% check for trim values+next step values, warn or stop FB as necessary</span>
2556                         VCMtrimSP = getpv(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1);
2557                         VCMtrimSP_next = VCMtrimSP + Y(1:N_VCM);
2558                         <span class="keyword">if</span> max(abs(VCMtrimSP_next)) &gt; 12
2559                             VCMtrimnum=find(abs(VCMtrimSP_next) &gt; 12);
2560 
2561                             <span class="comment">% print message to screen</span>
2562                             fprintf(<span class="string">'**One or more of the vertical correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2563                             fprintf(<span class="string">'%s\n'</span>,datestr(now));
2564                             <span class="keyword">for</span> loop = VCMtrimnum'
2565                                 fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1(loop,:)));
2566                             <span class="keyword">end</span>
2567 
2568                             <span class="comment">% send alphapage to operator pager</span>
2569                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2570                             FEEDBACK_STOP_FLAG = 1;
2571 
2572                             setpv(<span class="string">'SR_STATE'</span>, -5);
2573                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2574                             <span class="keyword">if</span> StateNumber &gt;= 0
2575                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2576                             <span class="keyword">else</span>
2577                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2578                             <span class="keyword">end</span>
2579                         <span class="keyword">end</span>
2580 
2581                         <span class="comment">% check chicane trim coil values + next step values, warn or stop FB as necessary</span>
2582                         VCMCHICANEtrimSP=getpv(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>,VCMlist1(iVCMChicane,:));
2583                         VCMCHICANEtrimSP_next = VCMCHICANEtrimSP + X(iVCMChicane);
2584                         <span class="keyword">if</span> max(abs(VCMCHICANEtrimSP_next)) &gt; 20
2585                             VCMCHICANEtrimnum=find(abs(VCMCHICANEtrimSP_next) &gt; 20);
2586 
2587                             <span class="comment">% print message to screen</span>
2588                             fprintf(<span class="string">'**One or more of the vertical chicane trim coil correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2589                             fprintf(<span class="string">'%s\n'</span>,datestr(now));
2590                             <span class="keyword">for</span> loop = VCMCHICANEtrimnum'
2591                                 fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>,VCMlist1(loop,:)));
2592                             <span class="keyword">end</span>
2593                             fprintf(<span class="string">'**Maybe try resetting the setpoints of the motor chicanes in case they are drifting...\n'</span>);
2594 
2595                             <span class="comment">% send alphapage to operator pager</span>
2596                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2597                             FEEDBACK_STOP_FLAG = 1;
2598 
2599                             setpv(<span class="string">'SR_STATE'</span>, -5);
2600                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2601                             <span class="keyword">if</span> StateNumber &gt;= 0
2602                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2603                             <span class="keyword">else</span>
2604                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2605                             <span class="keyword">end</span>
2606                         <span class="keyword">end</span>
2607 
2608                         <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2609                             <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2610                             <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2611                                 disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2612                             <span class="keyword">end</span>
2613                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2614                             pause(0.5);
2615                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2616                             <span class="keyword">break</span>;
2617                         <span class="keyword">end</span>
2618 
2619                         <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2620                         <span class="comment">% pause(0);</span>
2621 
2622                         <span class="keyword">if</span> max(abs(VCMtrimSP_next) &gt; 4)
2623                             VCMtrimnum=find(abs(VCMtrimSP_next) &gt; 4);
2624                             VWarnNum=VWarnNum+1;
2625                             <span class="keyword">if</span> (VWarnNum==1 | rem(VWarnNum,120)==0)
2626 
2627                                 <span class="comment">% print message to screen every two minutes</span>
2628                                 fprintf(<span class="string">'**One or more of the vertical corrector trims is above 4A or below -4A! \n'</span>);
2629                                 fprintf(<span class="string">'%s\n'</span>,datestr(now));
2630                                 <span class="keyword">for</span> loop = VCMtrimnum'
2631                                     fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1(loop,:)));
2632                                 <span class="keyword">end</span>
2633                                 fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2634 
2635                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2636                                 <span class="keyword">if</span> (VWarnNum==1 | VWarnNum==600)
2637                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageVCM.txt
2638                                 <span class="keyword">end</span>
2639                             <span class="keyword">end</span>
2640                         <span class="keyword">elseif</span> max(abs(VCMCHICANEtrimSP_next) &gt; 15)
2641                             VCMCHICANEtrimnum=find(abs(VCMCHICANEtrimSP_next) &gt; 15);
2642                             VWarnNum=VWarnNum+1;
2643                             <span class="keyword">if</span> (HWarnNum==1 | rem(HWarnNum,120)==0)
2644 
2645                                 <span class="comment">% print message to screen every two minutes</span>
2646                                 fprintf(<span class="string">'**One or more of the vertical chicane corrector trim coils is above 15A or below -15A! \n'</span>);
2647                                 fprintf(<span class="string">'%s\n'</span>,datestr(now));
2648                                 <span class="keyword">for</span> loop = VCMCHICANEtrimnum'
2649                                     fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>,VCMlist1(loop,:)));
2650                                 <span class="keyword">end</span>
2651                                 fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2652 
2653                                 <span class="comment">%reset motor chicanes in case they are drifting</span>
2654                                 <span class="comment">%try</span>
2655                                 <span class="comment">%        fprintf(' Resetting the setpoints of the motor chicanes in case they are drifting...\n');</span>
2656                                           <span class="comment">%        setpv('HCMCHICANEM','Setpoint',[],ConfigSetpoint.Setpoint.Data,0);</span>
2657                                           <span class="comment">%catch</span>
2658                                           <span class="comment">%end</span>
2659 
2660                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2661                                 <span class="keyword">if</span> (VWarnNum==1 | VWarnNum==600)
2662                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageVCMCHICANE.txt
2663                                 <span class="keyword">end</span>
2664                             <span class="keyword">end</span>
2665                         <span class="keyword">else</span>
2666                             VWarnNum=0;
2667                         <span class="keyword">end</span>
2668 
2669                         <span class="comment">% Don't feedback if the current is too small</span>
2670                         <span class="keyword">if</span> getdcct &lt; 5
2671                             FEEDBACK_STOP_FLAG = 1;
2672                             fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2673                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/beamisoff.txt
2674                             <span class="keyword">break</span>;
2675                         <span class="keyword">end</span>
2676 
2677                         <span class="keyword">if</span> N_VCM &gt; 0
2678                             steppv(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>, Y(iNotVCMChicane), VCMlist1(iNotVCMChicane,:), 0);
2679                             steppv(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>, Y(iVCMChicane), VCMlist1(iVCMChicane,:), 0);
2680                         <span class="keyword">end</span>
2681 
2682                         <span class="comment">% write fast orbit feedback setpoints</span>
2683                         <span class="keyword">if</span> 1
2684                             <a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>(2,Ynew(1:size(BPMlist1,1))+Sy1*Y(1:N_VCM),BPMlist1);
2685                         <span class="keyword">end</span>
2686 
2687                     <span class="keyword">end</span>
2688 
2689                     Yold = Ynew;
2690 
2691                     <span class="comment">%fprintf('Vertical Done: %f \n',gettime-t00);</span>
2692                 <span class="keyword">end</span> <span class="comment">% End vertical correction</span>
2693 
2694 
2695                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
2696                 <span class="comment">% Tune feed forward %</span>
2697                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
2698                 <span class="comment">% We should do a Sector limit check</span>
2699 
2700                 tic;
2701                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxTune'</span>),<span class="string">'Value'</span>) == 1
2702 
2703                     <span class="keyword">if</span> strcmp(SR_Mode, <span class="string">'1.9 GeV, High Tune'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Inject at 1.23'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Two-Bunch'</span>)
2704 
2705                         addQFsp = zeros(24,1);
2706                         addQDsp = zeros(24,1);
2707 
2708                         <span class="keyword">if</span> strcmp(FFTypeFlag,<span class="string">'Local'</span>)
2709                             disp(<span class="string">'  No local tune compensation available - global is the default now.'</span>);
2710                         <span class="keyword">elseif</span> strcmp(FFTypeFlag,<span class="string">'Global'</span>)
2711 
2712                             <span class="comment">% The vectorized gets were put outside of loop for speed reasons</span>
2713                             <span class="comment">%</span>
2714                             <span class="comment">% should also set up QFfac, Quadelem, Quadlist structures outside loop</span>
2715                             actualgap = <a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>(IDSector);
2716                             [gapmin,gapmax] = <a href="gaplimit.html" class="code" title="function [GAPmin, GAPmax] = gaplimit(Dev);">gaplimit</a>(IDSector);
2717                             corrind = find(actualgap&lt;(gapmin-1));
2718                             actualgap(corrind)=gapmax(corrind);
2719                             Shift=zeros(size(actualgap));
2720                             Shift(EPUlist)=getpv(<span class="string">'EPU'</span>);
2721 
2722                             IDchangedList=find((abs(actualgap-oldgap)&gt;0.005) | (abs(Shift-oldShift)&gt;0.005));
2723 
2724                             <span class="keyword">if</span> ~isempty(IDchangedList)
2725 
2726                                 oldgap=actualgap;
2727                                 oldShift=Shift;
2728 
2729                                 <span class="comment">% EPUs excite nux = .25 resonance in vertical linear polarization mode!</span>
2730                                 <span class="comment">% therefore with EPU tune feedforward</span>
2731                                 <span class="comment">% running, we want to move our nominal working point away (just below) the .25 resonance.</span>
2732                                 <span class="comment">%</span>
2733                                 <span class="comment">% The following tune correction moves nominal</span>
2734                                 <span class="comment">% nu_x from .25 to .245 - this should be enough for well set up lattices.</span>
2735                                 <span class="comment">%</span>
2736                                 <span class="comment">% 24 QF+ 24 QD</span>
2737                                 DeltaAmps = inv(SR_TUNE_MATRIX) * [-0.005;0];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2738                                 addQFsp = addQFsp + DeltaAmps(1,:);
2739                                 addQDsp = addQDsp + DeltaAmps(2,:);
2740 
2741                                 <span class="keyword">for</span> gapnum = 1:length(actualgap)
2742 
2743                                     <span class="comment">% Change in tune and [QF;QD] from maximum gap</span>
2744 
2745                                     <span class="keyword">if</span> (IDSector(gapnum,1) == 4) || (IDSector(gapnum,1) == 11)
2746                                         <span class="keyword">if</span> IDSector(gapnum,2) == 1
2747                                             modenamestr = sprintf(<span class="string">'SR%02dU___ODS1M__DC00'</span>,IDSector(gapnum,1));
2748                                         <span class="keyword">else</span> <span class="comment">% if IDSector(gapnum,2) == 2</span>
2749                                             modenamestr = sprintf(<span class="string">'SR%02dU___ODS2M__DC00'</span>,IDSector(gapnum,1));
2750                                         <span class="keyword">end</span>
2751                                         epumode = getpv(modenamestr);
2752                                         <span class="keyword">if</span> (IDSector(gapnum,1) == 4) &amp;&amp; (IDSector(gapnum,2) == 1) 
2753                                             <span class="keyword">if</span> (epumode == 0)
2754 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_41,shift_epu_41,dnux_epu_41_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2755 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_41,shift_epu_41,dnuy_epu_41_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2756                                                 DeltaNuX = interp2(gap41p',shift41p',dnux41p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2757                                                 DeltaNuY = interp2(gap41p',shift41p',dnuy41p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2758                                             <span class="keyword">elseif</span> (epumode == 1)
2759 <span class="comment">%                                                 DeltaNux = 0;</span>
2760 <span class="comment">%                                                 DeltaNuY = gap2tune(IDSector(gapnum, :), actualgap(gapnum), SR_GeV);</span>
2761                                                 DeltaNuX = interp2(gap41a',shift41a',dnux41a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2762                                                 DeltaNuY = interp2(gap41a',shift41a',dnuy41a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2763                                             <span class="keyword">else</span>
2764                                                 DeltaNux = 0;
2765                                                 DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum, :), actualgap(gapnum), SR_GeV);  
2766                                             <span class="keyword">end</span>
2767                                         <span class="keyword">elseif</span> (IDSector(gapnum,1) == 11) &amp;&amp; (IDSector(gapnum,2) == 1) 
2768                                             <span class="keyword">if</span> (epumode == 0)
2769 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_111,shift_epu_111,dnux_epu_111_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2770 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_111,shift_epu_111,dnuy_epu_111_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2771                                                 DeltaNuX = interp2(gap111p',shift111p',dnux111p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2772                                                 DeltaNuY = interp2(gap111p',shift111p',dnuy111p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2773                                             <span class="keyword">elseif</span> (epumode == 1)
2774 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_111,shift_epu_111,dnux_epu_111_m1',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2775 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_111,shift_epu_111,dnuy_epu_111_m1',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2776                                                 DeltaNuX = interp2(gap111a',shift111a',dnux111a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2777                                                 DeltaNuY = interp2(gap111a',shift111a',dnuy111a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2778                                             <span class="keyword">else</span>
2779                                                 DeltaNuX = 0;
2780                                                 DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);   <span class="comment">% variation of vertical tune shift with phase is small for EPUs</span>
2781                                             <span class="keyword">end</span>
2782                                         <span class="keyword">elseif</span> (IDSector(gapnum,1) == 11) &amp;&amp; (IDSector(gapnum,2) == 2) 
2783                                             <span class="keyword">if</span> (epumode == 0)
2784 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_111,shift_epu_111,dnux_epu_111_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2785 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_111,shift_epu_111,dnuy_epu_111_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2786                                                 DeltaNuX = interp2(gap112p',shift112p',dnux112p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2787                                                 DeltaNuY = interp2(gap112p',shift112p',dnuy112p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2788                                             <span class="keyword">elseif</span> (epumode == 1)
2789 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_111,shift_epu_111,dnux_epu_111_m1',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2790 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_111,shift_epu_111,dnuy_epu_111_m1',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2791                                                 DeltaNuX = interp2(gap112a',shift112a',dnux112a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2792                                                 DeltaNuY = interp2(gap112a',shift112a',dnuy112a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2793                                             <span class="keyword">else</span>
2794                                                 DeltaNuX = 0;
2795                                                 DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);   <span class="comment">% variation of vertical tune shift with phase is small for EPUs</span>
2796                                             <span class="keyword">end</span>
2797                                         <span class="keyword">else</span>
2798                                             DeltaNuX = 0;
2799                                             DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);   
2800                                         <span class="keyword">end</span>
2801 
2802                                     <span class="keyword">else</span>
2803                                         DeltaNuX = 0;
2804                                         DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);
2805                                     <span class="keyword">end</span>
2806 
2807                                     DelQF = zeros(length(QFsp),1);
2808                                     DelQD = zeros(length(QFsp),1);
2809 
2810                                     fraccorr = 0.8*DeltaNuY ./ TuneW16Min;
2811 
2812                                     <span class="comment">% Find which quads to change (local beta beating correction</span>
2813                                     <span class="comment">% (horizontal for EPU, vertical otherwise)</span>
2814                                     QuadList = [IDSector(gapnum,1)-1 2; IDSector(gapnum,1) 1];
2815                                     QuadElem = dev2elem(<span class="string">'QF'</span>,QuadList); <span class="comment">% in reality use QF and QD ...</span>
2816 
2817                                     <span class="comment">% global vertical tune correction</span>
2818                                     <span class="comment">% 24 QF+ 24 QD</span>
2819                                     DeltaAmps = inv(SR_TUNE_MATRIX) * [(fraccorr*6.23e-4); fraccorr*(-0.05301)];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2820                                     DelQF = DelQF + DeltaAmps(1,:);
2821                                     DelQD = DelQD + DeltaAmps(2,:);
2822 
2823                                     <span class="comment">% local horizontal tune correction (is also nearly a beta beating correction) only nonzero for EPUs!</span>
2824                                     <span class="comment">% 2 QF + 2 QD</span>
2825                                     DeltaAmpsLocal = 12*inv(SR_TUNE_MATRIX) * [-DeltaNuX;0];                       <span class="comment">%  DelAmps =  [QF; QD];</span>
2826                                     DelQF(QuadElem) = DelQF(QuadElem)+DeltaAmpsLocal(1,1);
2827                                     DelQD(QuadElem) = DelQD(QuadElem)+DeltaAmpsLocal(2,1);
2828 
2829                                     <span class="comment">% local vertical beta beating correction (should be used together with above global tune correction)</span>
2830                                     <span class="comment">% set to zero for EPUs, since their vertical tune shift is small</span>
2831                                     <span class="comment">% 2 QF + 2QD</span>
2832                                     <span class="keyword">if</span> (IDSector(gapnum,1)==6) | (IDSector(gapnum,1)==7) | (IDSector(gapnum,1)==10) | (IDSector(gapnum,1)==11)
2833                                         QFfac = ([2.243127/2.237111; 2.243127/2.237111]-1) * fraccorr;
2834                                         QDfac = ([2.556392/2.511045; 2.556392/2.511045]-1) * fraccorr;
2835                                     <span class="keyword">elseif</span> (IDSector(gapnum,1)==5) | (IDSector(gapnum,1)==9)
2836                                         QFfac = ([2.225965/2.219784; 2.243096/2.237111]-1) * fraccorr;
2837                                         QDfac = ([2.528950/2.483259; 2.556345/2.511045]-1) * fraccorr;
2838                                     <span class="keyword">elseif</span> (IDSector(gapnum,1)==4) | (IDSector(gapnum,1)==8) | (IDSector(gapnum,1)==12)
2839                                         QFfac = ([2.243096/2.237111; 2.225965/2.219784]-1) * fraccorr;
2840                                         QDfac = ([2.556345/2.511045; 2.528950/2.483259]-1) * fraccorr;
2841                                     <span class="keyword">else</span>
2842                                         QFfac = zeros(2,1);
2843                                         QDfac = zeros(2,1);
2844                                     <span class="keyword">end</span>
2845 
2846                                     DelQF(QuadElem,:) = DelQF(QuadElem,:) + QFfac.*QFsp(QuadElem,:);
2847                                     DelQD(QuadElem,:) = DelQD(QuadElem,:) + QDfac.*QDsp(QuadElem,:);
2848 
2849                                     <span class="comment">% add all tune and beta beating corrections for this one ID to the summed up correction vectors for all IDs</span>
2850                                     addQFsp = addQFsp+DelQF;
2851                                     addQDsp = addQDsp+DelQD;
2852                                     
2853                                     
2854                                     <span class="comment">% Skew FF for IVID</span>
2855                                     <span class="keyword">if</span> (IDSector(gapnum,1)==6)
2856                                         scale=(<a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(6)/0.005)^(3/4)*0.16;
2857                                         [SQSFincr, SQSDincr] = <a href="set_etaywave_nuy9_20skews_skewFF.html" class="code" title="function [SQSFincr, SQSDincr] = set_etaywave_nuy9_20skews_skewFF(scale);">set_etaywave_nuy9_20skews_skewFF</a>(scale);
2858                                         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2859                                         <span class="comment">% should add a limit check here %</span>
2860                                         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2861                                         setpv(<span class="string">'SQSF'</span>, <span class="string">'Setpoint'</span>, SQSFsp+SQSFincr, [], 0, <span class="string">'Physics'</span>);
2862                                         setpv(<span class="string">'SQSD'</span>, <span class="string">'Setpoint'</span>, SQSDsp+SQSDincr, [], 0, <span class="string">'Physics'</span>);
2863                                     <span class="keyword">end</span>
2864 
2865                                 <span class="keyword">end</span>
2866 
2867                                 <span class="comment">% Set quadrupoles using main setpoint channels</span>
2868                                 setpv(<span class="string">'QF'</span>, QFsp+addQFsp,[], 0);
2869                                 setpv(<span class="string">'QD'</span>, QDsp+addQDsp,[], 0);
2870                                 <span class="comment">% % Set quadrupoles using FF setpoint channels</span>
2871                                 <span class="comment">% setpv('QF', 'FF', addQFsp, [], 0);</span>
2872                                 <span class="comment">% setpv('QD', 'FF', addQDsp, [], 0);</span>
2873                                 
2874                             <span class="keyword">end</span>
2875 
2876                         <span class="keyword">else</span>
2877                             error(<span class="string">'Unknown type selected for tune FF'</span>);
2878                         <span class="keyword">end</span>
2879 
2880                     <span class="keyword">else</span>
2881                         disp(<span class="string">'  No tune FF algorithm for non-production modes yet...'</span>);
2882                     <span class="keyword">end</span>
2883                 <span class="keyword">end</span>
2884 
2885                 ffdeltaquad_delay = toc;
2886                 <span class="comment">%fprintf('tune FF delay = %.1f seconds\n',ffdeltaquad_delay);</span>
2887                 <span class="comment">% fprintf('Tune Done: %f \n',gettime-t00);</span>
2888 
2889                 <span class="comment">% Output info to screen</span>
2890                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = %.4f mm'</span>,STDx),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2891                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = %.4f mm'</span>,STDy),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2892                 <span class="comment">%pause(0);</span>
2893 
2894                 FOFBStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2895                     getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2896                     getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2897                     getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2898                 <span class="keyword">for</span> loop = 1:size(FOFBStatus,2)
2899                     <span class="keyword">if</span> FOFBStatus(loop)==0
2900                         FOFBStatusStr(loop,:) = <span class="string">'OFF '</span>;
2901                     <span class="keyword">elseif</span> FOFBStatus(loop)==1
2902                         FOFBStatusStr(loop,:) = <span class="string">'ON  '</span>;
2903                     <span class="keyword">elseif</span> FOFBStatus(loop)==2
2904                         FOFBStatusStr(loop,:) = <span class="string">'OPEN'</span>;
2905                     <span class="keyword">else</span>
2906                         FOFBStatusStr(loop,:) = <span class="string">'BAD '</span>;
2907                     <span class="keyword">end</span>
2908                 <span class="keyword">end</span>
2909                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 %s'</span>,FOFBStatusStr(1,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2910                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 %s'</span>,FOFBStatusStr(2,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2911                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 %s'</span>,FOFBStatusStr(3,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2912                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 %s'</span>,FOFBStatusStr(4,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2913                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 %s'</span>,FOFBStatusStr(5,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2914                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 %s'</span>,FOFBStatusStr(6,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2915                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 %s'</span>,FOFBStatusStr(7,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2916                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 %s'</span>,FOFBStatusStr(8,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2917                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 %s'</span>,FOFBStatusStr(9,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2918                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 %s'</span>,FOFBStatusStr(10,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2919                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 %s'</span>,FOFBStatusStr(11,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2920                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 %s'</span>,FOFBStatusStr(12,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2921 
2922 
2923                 <span class="comment">%fprintf('End of feedback operations: %f \n\n',gettime-t00);</span>
2924 
2925                 <span class="comment">% Wait for next update time or stop request</span>
2926                 <span class="keyword">while</span> (gettime-t00) &lt; LoopDelay
2927                     <span class="comment">%disp('interval could be shorter')</span>
2928                     pause(.05);
2929                     <span class="comment">% Check if GUI has been closed</span>
2930                     <span class="keyword">if</span> isempty(gcbf)
2931                         FEEDBACK_STOP_FLAG = 1;
2932                         lasterr(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2933                         error(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2934                     <span class="keyword">end</span>
2935 
2936                     <span class="comment">% Check if Stop button was pressed</span>
2937                     <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2938                         <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2939                         <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2940                             disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2941                         <span class="keyword">end</span>
2942                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2943                         pause(0.5);
2944                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2945                         <span class="keyword">break</span>;
2946                     <span class="keyword">end</span>
2947                 <span class="keyword">end</span>
2948 
2949 
2950                 <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2951                     <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2952                     <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2953                         disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2954                     <span class="keyword">end</span>
2955                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2956                     pause(0.5);
2957                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2958                     <span class="keyword">break</span>;
2959                 <span class="keyword">end</span>
2960 
2961                 StartErrorTime = gettime;
2962 
2963             <span class="keyword">catch</span>
2964 
2965                 fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
2966 
2967                 <span class="comment">% Quit if error exists for more than 20 seconds</span>
2968                 <span class="keyword">if</span> gettime-StartErrorTime&gt;20 | FEEDBACK_STOP_FLAG==1
2969                     fprintf(<span class="string">'%s  Orbit feedback stopped due to error condition. \n\n'</span>,datestr(now));
2970 
2971                     <span class="comment">%send alphapage to operator pager</span>
2972                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2973                     FEEDBACK_STOP_FLAG = 1;
2974 
2975                     setpv(<span class="string">'SR_STATE'</span>, -5);
2976                     [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2977                     <span class="keyword">if</span> StateNumber &gt;= 0
2978                         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2979                     <span class="keyword">else</span>
2980                         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2981                     <span class="keyword">end</span>
2982                 <span class="keyword">else</span>
2983                     a = clock;
2984                     fprintf(<span class="string">'   Orbit feedback was paused due to error condition (%s %d:%d:%.0f). \n'</span>, date, a(4), a(5), a(6));
2985                     fprintf(<span class="string">'   Orbit feedback has automatically restarted and is running. \n\n'</span>);
2986                 <span class="keyword">end</span>
2987 
2988             <span class="keyword">end</span>
2989 
2990             <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2991                 <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2992                 <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2993                     disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2994                 <span class="keyword">end</span>
2995                 setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2996                 pause(0.5);
2997                 setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2998                 <span class="keyword">break</span>;
2999             <span class="keyword">end</span>
3000 
3001             <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
3002 
3003             <span class="comment">%pause(0);</span>
3004 
3005             <span class="comment">% this loop delays turn on of Fast Feedback system</span>
3006             <span class="keyword">if</span> FBloopIter &lt; 5
3007                 FBloopIter = FBloopIter + 1;
3008             <span class="keyword">end</span>
3009 
3010         <span class="keyword">end</span>  <span class="comment">% End of feedback loop</span>
3011 
3012 
3013         <span class="comment">% End feedback, reset all parameters</span>
3014         <span class="keyword">try</span>
3015 
3016             <span class="comment">% Enable buttons</span>
3017             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3018             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
3019             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3020             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3021             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3022             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3023             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3024             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3025             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3026             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3027             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3028             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3029             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3030 
3031             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = _____ mm'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3032             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = _____ mm'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3033 
3034             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3035             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3036             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3037             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3038             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3039             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3040             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3041             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3042             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3043             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3044             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3045             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3046 
3047             <span class="comment">%pause(0);</span>
3048 
3049         <span class="keyword">catch</span>
3050 
3051             <span class="comment">% GUI must have been closed</span>
3052 
3053         <span class="keyword">end</span>
3054 
3055 
3056         <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
3057         fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
3058         <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
3059 
3060 
3061         a = clock;
3062         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
3063         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
3064         <span class="keyword">if</span> StateNumber &gt;= 0
3065             setpv(<span class="string">'SR_STATE'</span>,5.1);
3066             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
3067             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
3068             fprintf(<span class="string">'   ******************************\n'</span>);
3069             fprintf(<span class="string">'   **  Orbit Feedback Stopped  **\n'</span>);
3070             fprintf(<span class="string">'   ******************************\n\n'</span>);
3071         <span class="keyword">else</span>
3072             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
3073             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
3074             fprintf(<span class="string">'   ****************************************\n'</span>);
3075             fprintf(<span class="string">'   **  Problem With Slow Orbit Feedback  **\n'</span>);
3076             fprintf(<span class="string">'   ****************************************\n\n'</span>);
3077         <span class="keyword">end</span>
3078         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
3079         pause(0);
3080 
3081 
3082     <span class="keyword">case</span> <span class="string">'FeedbackSetup'</span>
3083         InitFlag = Input2;           <span class="comment">% Input #2: if InitFlag, then initialize variables</span>
3084 
3085         <span class="keyword">if</span> InitFlag
3086             
3087            
3088             <span class="comment">% Get the device lists from oscsinit and convert to srcontrol variables</span>
3089             [HBPM, VBPM, HCM, VCM, HSV, VSV] = <a href="ocsinit.html" class="code" title="function [HBPM, VBPM, HCM, VCM, HSV, VSV] = ocsinit(MethodName)">ocsinit</a>(<span class="string">'SOFB'</span>);
3090             Xivec = 1:HSV;
3091             Yivec = 1:VSV;
3092             BPMlist1 = HBPM.DeviceList;
3093             HCMlist1 = HCM.DeviceList;
3094             VCMlist1 = VCM.DeviceList;           
3095             
3096             
3097             OCSx.BPM = getx(BPMlist1, <span class="string">'struct'</span>);
3098             OCSx.CM = getsp(<span class="string">'HCM'</span>, HCMlist1, <span class="string">'struct'</span>);
3099             OCSx.GoalOrbit = getgolden(OCSx.BPM, <span class="string">'numeric'</span>);
3100             OCSx.NIter = 1;
3101             OCSx.SVDIndex = Xivec;
3102             OCSx.IncrementalFlag = <span class="string">'No'</span>;
3103             OCSx.BPMWeight = {[]};
3104             OCSx.FitRF = 0;
3105             OCSy.BPM = gety(BPMlist1, <span class="string">'struct'</span>);
3106             OCSy.CM = getsp(<span class="string">'VCM'</span>, VCMlist1, <span class="string">'struct'</span>);
3107             OCSy.GoalOrbit = getgolden(OCSy.BPM, <span class="string">'numeric'</span>);
3108             OCSy.NIter = 1;
3109             OCSy.SVDIndex = Yivec;
3110             OCSy.IncrementalFlag = <span class="string">'No'</span>;
3111             OCSy.BPMWeight = {[]};
3112             OCSy.FitRF = 0;
3113             
3114             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
3115             <span class="comment">% do we need these Smat calls? %</span>
3116             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
3117             SXmat = getrespmat(OCSx.BPM, OCSx.CM, <span class="string">'numeric'</span>);
3118             SYmat = getrespmat(OCSy.BPM, OCSy.CM, <span class="string">'numeric'</span>);
3119             <span class="comment">% [OCSx, Sx, Ux, Vx] = orbitcorrectionmethods(OCSx, SXmat);</span>
3120             <span class="comment">% [OCSy, Sy, Uy, Vy] = orbitcorrectionmethods(OCSy, SYmat);</span>
3121 
3122             <span class="comment">% initialize FFTypeFlag</span>
3123             FFTypeFlag = <span class="string">'Global'</span>;
3124 
3125             <span class="comment">% Fit decision comes from check box</span>
3126             <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
3127                 OCSx.FitRF = 1;
3128                 Xivec = 1:HSV+1;
3129             <span class="keyword">end</span>
3130         
3131         <span class="keyword">else</span>
3132 
3133             <span class="comment">% Get vectors</span>
3134             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
3135             <span class="comment">% the two lines below seem to fix BPMlist editing problem</span>
3136             OCSx = FB.OCSx;
3137             OCSy = FB.OCSy;
3138             BPMlist1 = FB.BPMlist1;
3139             HCMlist1 = FB.HCMlist1;
3140             VCMlist1 = FB.VCMlist1;
3141             Xivec = FB.Xivec;
3142             Yivec = FB.Yivec;
3143             Xgoal = FB.OCSx.GoalOrbit;
3144             OCSx.GoalOrbit = Xgoal;
3145             Ygoal = FB.OCSy.GoalOrbit;
3146             OCSy.GoalOrbit = Ygoal;
3147             FFTypeFlag = FB.FFTypeFlag;
3148 
3149 
3150             <span class="comment">% FF corrector magnet list - only channels which are blocked when FF is running should be</span>
3151             <span class="comment">% listed</span>
3152             ListFF = [
3153                 4     2
3154                 4     8
3155                 5     1
3156                 5     7
3157 <span class="comment">%               5     8 % IVID is using digital FF, i.e. FF algorithm does not block</span>
3158 <span class="comment">%               6     1 % other access to PVs</span>
3159                 6     8
3160                 7     1
3161                 7     8
3162                 8     1
3163                 8     8
3164                 9     1
3165                 9     8
3166                 10    1
3167                 11    8
3168                 12    1];
3169             ElemFF = dev2elem(<span class="string">'HCM'</span>,ListFF);
3170 
3171 
3172             <span class="comment">% Add button to change #ivectors, cm, IDBPMs,</span>
3173             EditFlag = 0;
3174             h_fig1 = figure;
3175             <span class="keyword">while</span> EditFlag ~= 6
3176 
3177                 Sx = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
3178                 Sy = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
3179                 
3180                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
3181                     DispOrbit = getdisp(<span class="string">'BPMx'</span>, BPMlist1);
3182                     Sx = [Sx DispOrbit];
3183                 <span class="keyword">end</span>
3184                 
3185                 Sx(isnan(Sx)) = 0;
3186                 Sy(isnan(Sy)) = 0;
3187                 
3188                 [Ux, SVx, Vx] = svd(Sx);
3189                 [Uy, SVy, Vy] = svd(Sy);
3190 
3191                 
3192                 <span class="comment">% Remove singular values greater than the actual number of singular values</span>
3193                 i = find(Xivec&gt;length(diag(SVx)));
3194                 <span class="keyword">if</span> ~isempty(i)
3195                     disp(<span class="string">'   Horizontal E-vector scaled since there were more elements in the vector than singular values.'</span>);
3196                     pause(0);
3197                     Xivec(i) = [];
3198                 <span class="keyword">end</span>
3199                 i = find(Yivec&gt;length(diag(SVy)));
3200                 <span class="keyword">if</span> ~isempty(i)
3201                     disp(<span class="string">'   Vertical E-vector scaled since there were more elements in the vector than singular values.'</span>);
3202                     pause(0);
3203                     Yivec(i) = [];
3204                 <span class="keyword">end</span>
3205 
3206 
3207                 Ax = Sx*Vx(:,Xivec);
3208                 Tx = inv(Ax'*Ax)*Ax';
3209 
3210                 Ay = Sy*Vy(:,Yivec);
3211                 Ty = inv(Ay'*Ay)*Ay';
3212 
3213                 figure(h_fig1);
3214                 subplot(2,1,1);
3215                 semilogy(diag(SVx),<span class="string">'b'</span>);
3216                 hold on;
3217                 semilogy(diag(SVx(Xivec,Xivec)),<span class="string">'xr'</span>);
3218                 ylabel(<span class="string">'Horizontal'</span>);
3219                 title(<span class="string">'Response Matrix Singular Values'</span>);
3220                 hold off;
3221                 subplot(2,1,2);
3222                 semilogy(diag(SVy),<span class="string">'b'</span>);
3223                 hold on;
3224                 semilogy(diag(SVy(Yivec,Yivec)),<span class="string">'xr'</span>);
3225                 xlabel(<span class="string">'Singular Value Number'</span>);
3226                 ylabel(<span class="string">'Vertical'</span>);
3227                 hold off;
3228                 drawnow;
3229 
3230                 EditFlag = menu(<span class="string">'Change Parameters?'</span>,<span class="string">'Singular Values'</span>,<span class="string">'HCM List'</span>,<span class="string">'VCM List'</span>, <span class="keyword">...</span>
3231                     <span class="string">'BPM List'</span>,<span class="string">'Change the Goal Orbit'</span>,<span class="string">'Continue'</span>);
3232 
3233                 <span class="keyword">if</span> EditFlag == 1
3234                     prompt={<span class="string">'Enter the horizontal E-vector numbers (Matlab vector format):'</span>,<span class="string">'Enter the vertical E-vector numbers (Matlab vector format):'</span>};
3235                     def={sprintf(<span class="string">'[%d:%d]'</span>,1,Xivec(end)),sprintf(<span class="string">'[%d:%d]'</span>,1,Yivec(end))};
3236                     titlestr=<span class="string">'SVD Orbit Feedback'</span>;
3237                     lineNo=1;
3238                     answer=inputdlg(prompt,titlestr,lineNo,def);
3239                     <span class="keyword">if</span> ~isempty(answer)
3240                         XivecNew = fix(str2num(answer{1}));
3241                         <span class="keyword">if</span> isempty(XivecNew)
3242                             disp(<span class="string">'   Horizontal E-vector cannot be empty.  No change made.'</span>);
3243                         <span class="keyword">else</span>
3244                             <span class="keyword">if</span> any(XivecNew&lt;=0) | max(XivecNew)&gt;length(diag(SVx))
3245                                 disp(<span class="string">'   Error reading horizontal E-vector.  No change made.'</span>);
3246                             <span class="keyword">else</span>
3247                                 Xivec = XivecNew;
3248                             <span class="keyword">end</span>
3249                         <span class="keyword">end</span>
3250                         YivecNew = fix(str2num(answer{2}));
3251                         <span class="keyword">if</span> isempty(YivecNew)
3252                             disp(<span class="string">'   Vertical E-vector cannot be empty.  No change made.'</span>);
3253                         <span class="keyword">else</span>
3254                             <span class="keyword">if</span> any(YivecNew&lt;=0) | max(YivecNew)&gt;length(diag(SVy))
3255                                 disp(<span class="string">'   Error reading vertical E-vector.  No change made.'</span>);
3256                             <span class="keyword">else</span>
3257                                 Yivec = YivecNew;
3258                             <span class="keyword">end</span>
3259                         <span class="keyword">end</span>
3260                     <span class="keyword">end</span>
3261                 <span class="keyword">end</span>
3262 
3263                 <span class="keyword">if</span> EditFlag == 2
3264                     List= getlist(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>);
3265                     CheckList = zeros(96,1);
3266                     Elem = dev2elem(<span class="string">'HCM'</span>, HCMlist1);
3267                     CheckList(Elem) = ones(size(Elem));
3268                     CheckList = CheckList(dev2elem(<span class="string">'HCM'</span>,List));
3269 
3270                     <span class="comment">% Remove FF corrrectors</span>
3271                     <span class="comment">%           Elem = dev2elem('HCM',List);</span>
3272                     <span class="comment">%           for j = length(ElemFF):-1:1</span>
3273                     <span class="comment">%              i = find(Elem==ElemFF(j));</span>
3274                     <span class="comment">%              Elem(i,:) = [];</span>
3275                     <span class="comment">%              List(i,:) = [];</span>
3276                     <span class="comment">%              CheckList(i,:) = [];</span>
3277                     <span class="comment">%           end</span>
3278 
3279                     newList = editlist(List, <span class="string">'HCMtrim'</span>, CheckList);
3280 
3281                     <span class="keyword">if</span> isempty(newList)
3282                         fprintf(<span class="string">'   WARNING: Horizontal corrector magnet list is empty!\n'</span>);
3283                         HCMlist1 = newList;
3284                     <span class="keyword">else</span>
3285                         HCMlist1 = newList;
3286                     <span class="keyword">end</span>
3287                     OCSx.CM.DeviceList = HCMlist1;
3288                 <span class="keyword">end</span>
3289 
3290                 <span class="keyword">if</span> EditFlag == 3
3291                     List = getlist(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>);
3292                     CheckList = zeros(96,1);
3293                     Elem = dev2elem(<span class="string">'VCM'</span>, VCMlist1);
3294                     CheckList(Elem) = ones(size(Elem));
3295                     CheckList = CheckList(dev2elem(<span class="string">'VCM'</span>,List));
3296 
3297                     <span class="comment">% Remove FF corrrectors</span>
3298                     <span class="comment">%           Elem = dev2elem('VCM',List);</span>
3299                     <span class="comment">%           for j = length(ElemFF):-1:1</span>
3300                     <span class="comment">%              i = find(Elem==ElemFF(j));</span>
3301                     <span class="comment">%              Elem(i,:) = [];</span>
3302                     <span class="comment">%              List(i,:) = [];</span>
3303                     <span class="comment">%              CheckList(i,:) = [];</span>
3304                     <span class="comment">%           end</span>
3305 
3306                     newList = editlist(List, <span class="string">'VCMtrim'</span>, CheckList);
3307 
3308                     <span class="keyword">if</span> isempty(newList)
3309                         fprintf(<span class="string">'   WARNING: Vertical corrector magnet list is empty!\n'</span>);
3310                         VCMlist1 = newList;
3311                     <span class="keyword">else</span>
3312                         VCMlist1 = newList;
3313                     <span class="keyword">end</span>
3314                     OCSy.CM.DeviceList = VCMlist1;
3315                 <span class="keyword">end</span>
3316 
3317                 <span class="keyword">if</span> EditFlag == 4
3318                     ListOld = BPMlist1;
3319                     XgoalOld = Xgoal;
3320                     YgoalOld = Ygoal;
3321 
3322                     <span class="comment">% Full BPM list</span>
3323                     List = <a href="getbpmlist.html" class="code" title="function [DeviceList, Index] = getbpmlist(varargin)">getbpmlist</a>(<span class="string">'Bergoz'</span>);
3324 
3325                     CheckList = zeros(size(List,1),1);
3326                     <span class="keyword">if</span> ~isempty(BPMlist1)
3327                         <span class="keyword">for</span> i = 1:size(List,1)
3328                             k = find(List(i,1)==BPMlist1(:,1));
3329                             l = find(List(i,2)==BPMlist1(k,2));
3330 
3331                             <span class="keyword">if</span> isempty(k) || isempty(l)
3332                                 <span class="comment">% Item not in list</span>
3333                             <span class="keyword">else</span>
3334                                 CheckList(i) = 1;
3335                             <span class="keyword">end</span>
3336                         <span class="keyword">end</span>
3337                     <span class="keyword">end</span>
3338 
3339                     newList = editlist(List, <span class="string">'BPM'</span>, CheckList);
3340                     <span class="keyword">if</span> isempty(newList)
3341                         fprintf(<span class="string">'   BPM list cannot be empty.  No change made.\n'</span>);
3342                     <span class="keyword">else</span>
3343                         BPMlist1 = newList;
3344                     <span class="keyword">end</span>
3345 
3346                     <span class="comment">% Set the goal orbit to the golden orbit</span>
3347                     Xgoal = getgolden(<span class="string">'BPMx'</span>, BPMlist1);
3348                     Ygoal = getgolden(<span class="string">'BPMy'</span>, BPMlist1);
3349 
3350 
3351                     <span class="comment">% If a new BPM is added, then set the goal orbit to the golden orbit</span>
3352                     <span class="keyword">for</span> i = 1:size(BPMlist1,1)
3353 
3354                         <span class="comment">% Is it a new BPM?</span>
3355                         k = find(BPMlist1(i,1)==ListOld(:,1));
3356                         l = find(BPMlist1(i,2)==ListOld(k,2));
3357 
3358                         <span class="keyword">if</span> isempty(k) || isempty(l)
3359                             <span class="comment">% New BPM</span>
3360                         <span class="keyword">else</span>
3361                             <span class="comment">% Use the old value for old BPM</span>
3362                             Xgoal(i) = XgoalOld(k(l));
3363                             Ygoal(i) = YgoalOld(k(l));
3364                         <span class="keyword">end</span>
3365                     <span class="keyword">end</span>
3366                     OCSx.BPM.DeviceList = BPMlist1;
3367                     OCSy.BPM.DeviceList = BPMlist1;
3368                     OCSx.GoalOrbit = Xgoal;
3369                     OCSy.GoalOrbit = Ygoal;
3370                 <span class="keyword">end</span>
3371 
3372                 <span class="keyword">if</span> EditFlag == 5
3373                     ChangeList = editlist2(BPMlist1, <span class="string">'Change BPM'</span>, zeros(size(BPMlist1,1),1));
3374 
3375                     <span class="keyword">for</span> i = 1:size(ChangeList,1)
3376 
3377                         k = find(ChangeList(i,1)==BPMlist1(:,1));
3378                         l = find(ChangeList(i,2)==BPMlist1(k,2));
3379 
3380                         prompt={sprintf(<span class="string">'Enter the new horizontal goal orbit for BPMx(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2)),sprintf(<span class="string">'Enter the new vertical goal orbit for BPMy(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2))};
3381                         def={sprintf(<span class="string">'%f'</span>,Xgoal(k(l))),sprintf(<span class="string">'%f'</span>,Ygoal(k(l)))};
3382                         titlestr=<span class="string">'CHANGE THE GOAL ORBIT'</span>;
3383                         lineNo=1;
3384                         answer = inputdlg(prompt, titlestr, lineNo, def);
3385 
3386                         <span class="keyword">if</span> isempty(answer)
3387                             <span class="comment">% No change</span>
3388                             fprintf(<span class="string">'   No change was made to the golden orbit.\n'</span>);
3389                         <span class="keyword">else</span>
3390                             Xgoalnew = str2num(answer{1});
3391                             <span class="keyword">if</span> isempty(Xgoalnew)
3392                                 fprintf(<span class="string">'   No change was made to the horizontal golden orbit.\n'</span>);
3393                             <span class="keyword">else</span>
3394                                 Xgoal(k(l)) = Xgoalnew;
3395                             <span class="keyword">end</span>
3396 
3397                             Ygoalnew = str2num(answer{2});
3398                             <span class="keyword">if</span> isempty(Ygoalnew)
3399                                 fprintf(<span class="string">'   No change was made to the vertical golden orbit.\n'</span>);
3400                             <span class="keyword">else</span>
3401                                 Ygoal(k(l)) = Ygoalnew;
3402                             <span class="keyword">end</span>
3403                         <span class="keyword">end</span>
3404                     <span class="keyword">end</span>
3405                     <span class="keyword">if</span> ~isempty(ChangeList)
3406                         fprintf(<span class="string">'   Note:  Changing the goal orbit for &quot;Slow Orbit Feedback&quot; does not change the goal orbit for &quot;Orbit Correction.&quot;\n'</span>);
3407                         fprintf(<span class="string">'          Re-running srcontrol will restart the goal orbit to the golden orbit.&quot;\n'</span>);
3408                     <span class="keyword">end</span>
3409                     OCSx.GoalOrbit = Xgoal;
3410                     OCSy.GoalOrbit = Ygoal;
3411                 <span class="keyword">end</span>
3412 
3413 <span class="comment">%                 if EditFlag == 6</span>
3414 <span class="comment">%                     FFTypeFlag = questdlg(sprintf('Do you want to use a fully local or a combined local/global compensation of IDs? (nuy=9.2 only)'),'Tune FF','Local','Global', 'Global');</span>
3415 <span class="comment">%                     if strcmp(FFTypeFlag,'Local')</span>
3416 <span class="comment">%                         disp(['   The tune FF will use 8 local quadrupoles to compensate beta beating and tune shift']);</span>
3417 <span class="comment">%                         disp(['   from each ID.']);</span>
3418 <span class="comment">%                     elseif strcmp(FFTypeFlag,'Global')</span>
3419 <span class="comment">%                         disp(['   The tune FF will use 4 local quadrupoles to compensate beta beating and all QF+QD']);</span>
3420 <span class="comment">%                         disp(['   to compensate tune shift from each ID.']);</span>
3421 <span class="comment">%                     end</span>
3422 <span class="comment">%                 end</span>
3423 
3424             <span class="keyword">end</span>
3425             close(h_fig1);
3426         <span class="keyword">end</span>
3427 
3428         <span class="comment">% Save vectors</span>
3429         FB.Xivec = Xivec;
3430         FB.Yivec = Yivec;
3431         FB.HCMlist1 = HCMlist1;
3432         FB.VCMlist1 = VCMlist1;
3433         FB.BPMlist1 = BPMlist1;
3434 
3435         OCSx.SVDIndex = Xivec;
3436         OCSy.SVDIndex = Yivec;
3437         FB.OCSx = OCSx;
3438         FB.OCSy = OCSy;
3439 
3440         FB.FFTypeFlag = FFTypeFlag;
3441         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>,FB);
3442 
3443 
3444     <span class="keyword">case</span> <span class="string">'FastFeedbackSetup'</span>
3445 
3446         InitFlag = Input2;
3447 
3448         <span class="keyword">if</span> InitFlag
3449             FOFBFreq = 1000;
3450             <span class="comment">% user operations 9/14-10/17/04: P=0.5, I=120, D=0.0015 (for both planes)</span>
3451             <span class="comment">% below are known good values for user ops as of 8-1-05</span>
3452             HorP = 2;
3453             HorI = 300;
3454             HorD = 0.002;
3455             VertP = 1;
3456             VertI = 100;
3457             VertD = 0.0015;
3458 
3459             <span class="comment">% this initial set is now done in hwinit.m because it's not a good idea to set anything when srcontrol is launched</span>
3460             <span class="comment">% try</span>
3461             <span class="comment">%     setsp('SR01____FFBFREQAC00', FOFBFreq); % set freq</span>
3462             <span class="comment">%     write_pid_ffb2_patch(HorP, HorI, HorD, VertP, VertI, VertD);</span>
3463             <span class="comment">% catch</span>
3464             <span class="comment">%     disp('   Trouble setting Fast Orbit Feedback parameters!');</span>
3465             <span class="comment">% end</span>
3466 
3467         <span class="keyword">else</span>
3468             <span class="comment">% Get vectors</span>
3469             FOFB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
3470             FOFBFreq = FOFB.FOFBFreq;
3471             HorP  = FOFB.HorP;
3472             HorI  = FOFB.HorI;
3473             HorD  = FOFB.HorD;
3474             VertP = FOFB.VertP;
3475             VertI = FOFB.VertI;
3476             VertD = FOFB.VertD;
3477 
3478             <span class="comment">% Add button to change #ivectors, CMs, IDBPMs,</span>
3479             EditFlag = 0;
3480             <span class="comment">%h_fig1 = figure;</span>
3481             <span class="keyword">while</span> EditFlag ~= 3
3482 
3483                 <span class="comment">%EditFlag = menu('Change Parameters?', 'Fast Feedback Frequency', 'PID Values', 'HCM List', 'VCM List', ...</span>
3484                 <span class="comment">%   'IDBPM List', 'BBPM List', 'Continue');</span>
3485                 <span class="comment">% Use menu below until other FFB config routines work (then also uncomment options 3,4,5,6 below)</span>
3486                 EditFlag = menu(<span class="string">'Change Parameters?'</span>, <span class="string">'Fast Feedback Frequency'</span>, <span class="string">'PID Values'</span>, <span class="string">'Continue'</span>);
3487 
3488                 <span class="keyword">if</span> EditFlag == 1
3489                     <span class="comment">% change rate</span>
3490 
3491                     prompt={<span class="string">'Enter the desired Fast Feedback Frequency (1-1000 Hz)'</span>};
3492                     def={num2str(FOFBFreq)};
3493                     titlestr=<span class="string">'Fast Feedback Setup'</span>;
3494                     lineNo=1;
3495                     answer=inputdlg(prompt,titlestr,lineNo,def);
3496                     <span class="keyword">if</span> ~isempty(answer)
3497                         FOFBFreq = fix(str2num(answer{1}));
3498                         <span class="keyword">if</span> isempty(FOFBFreq)
3499                             disp(<span class="string">'   Frequency value cannot be empty.  No change made.'</span>);
3500                             FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3501                         <span class="keyword">else</span>
3502                             <span class="keyword">if</span> FOFBFreq &lt; 1 | FOFBFreq &gt; 1000
3503                                 disp(<span class="string">'   Frequency must be between 1 and 1000 Hz.  No change made.'</span>);
3504                                 FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3505                             <span class="keyword">end</span>
3506                         <span class="keyword">end</span>
3507                         setsp(<span class="string">'SR01____FFBFREQAC00'</span>,FOFBFreq   ); <span class="comment">% change freq</span>
3508                         pause(0.5);
3509                         fprintf(<span class="string">'   Fast orbit feedback frequency is running at %.0f Hz.\n'</span>, getpv(<span class="string">'SR01____FFBFREQAM00'</span>));
3510                     <span class="keyword">else</span>
3511                         FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3512                     <span class="keyword">end</span>
3513                 <span class="keyword">end</span>
3514 
3515                 <span class="keyword">if</span> EditFlag == 2
3516                     <span class="comment">% edit  PIDs</span>
3517                     <span class="comment">% User defaults are HorP=2, HorI=300, HorD=0.002, VertP=1, VertI=100, VertD=0.0015</span>
3518                     prompt={<span class="string">'P horizontal'</span>, <span class="string">'I horizontal'</span>, <span class="string">'D horizontal'</span>, <span class="string">'P vertical'</span>, <span class="string">'I vertical'</span>, <span class="string">'D vertical'</span>};
3519                     def={num2str(HorP), num2str(HorI), num2str(HorD), num2str(VertP), num2str(VertI), num2str(VertD)};
3520                     titlestr=<span class="string">'Fast Feedback PID Setup'</span>;
3521                     lineNo=1;
3522                     answer=inputdlg(prompt,titlestr,lineNo,def);
3523                     <span class="keyword">if</span> ~isempty(answer)
3524                         HorPnewnum = str2num(answer{1});
3525                         <span class="keyword">if</span> isempty(HorPnewnum)
3526                             disp(<span class="string">'   HorP value cannot be empty.  No change made.'</span>);
3527                         <span class="keyword">else</span>
3528                             HorP = HorPnewnum;
3529                         <span class="keyword">end</span>
3530                         HorInewnum = str2num(answer{2});
3531                         <span class="keyword">if</span> isempty(HorInewnum)
3532                             disp(<span class="string">'   HorI value cannot be empty.  No change made.'</span>);
3533                         <span class="keyword">else</span>
3534                             HorI = HorInewnum;
3535                         <span class="keyword">end</span>
3536                         HorDnewnum = str2num(answer{3});
3537                         <span class="keyword">if</span> isempty(HorDnewnum)
3538                             disp(<span class="string">'   HorD value cannot be empty.  No change made.'</span>);
3539                         <span class="keyword">else</span>
3540                             HorD = HorDnewnum;
3541                         <span class="keyword">end</span>
3542                         VertPnewnum = str2num(answer{4});
3543                         <span class="keyword">if</span> isempty(VertPnewnum)
3544                             disp(<span class="string">'   VertP value cannot be empty.  No change made.'</span>);
3545                         <span class="keyword">else</span>
3546                             VertP = VertPnewnum;
3547                         <span class="keyword">end</span>
3548                         VertInewnum = str2num(answer{5});
3549                         <span class="keyword">if</span> isempty(VertInewnum)
3550                             disp(<span class="string">'   VertI value cannot be empty.  No change made.'</span>);
3551                         <span class="keyword">else</span>
3552                             VertI = VertInewnum;
3553                         <span class="keyword">end</span>
3554                         VertDnewnum = str2num(answer{6});
3555                         <span class="keyword">if</span> isempty(VertDnewnum)
3556                             disp(<span class="string">'   VertD value cannot be empty.  No change made.'</span>);
3557                         <span class="keyword">else</span>
3558                             VertD = VertDnewnum;
3559                         <span class="keyword">end</span>
3560 
3561                         <span class="keyword">try</span>
3562                             write_pid_ffb2_patch(HorP, HorI, HorD, VertP, VertI, VertD);
3563                             fprintf(<span class="string">'   Setting FFB gains to Horizontal P=%.2f, I=%.1f, D=%.4f;  Vertical P=%.2f, I=%.1f, D=%.4f\n'</span>, HorP, HorI, HorD, VertP, VertI, VertD);
3564                         <span class="keyword">catch</span>
3565                             disp(<span class="string">'   Trouble setting Fast Orbit Feedback parameters!'</span>);
3566                         <span class="keyword">end</span>
3567                     <span class="keyword">end</span>
3568                 <span class="keyword">end</span>
3569 
3570                 <span class="comment">%if EditFlag == 3</span>
3571                 <span class="comment">%   disp('   This function not yet available.');</span>
3572                 <span class="comment">%   % change HCM List</span>
3573                 <span class="comment">%end</span>
3574                 <span class="comment">%</span>
3575                 <span class="comment">%if EditFlag == 4</span>
3576                 <span class="comment">%   disp('   This function not yet available.');</span>
3577                 <span class="comment">%   % change VCM List</span>
3578                 <span class="comment">%end</span>
3579                 <span class="comment">%</span>
3580                 <span class="comment">%if EditFlag == 5</span>
3581                 <span class="comment">%   disp('   This function not yet available.');</span>
3582                 <span class="comment">%   % change IDBPM List</span>
3583                 <span class="comment">%end</span>
3584                 <span class="comment">%</span>
3585                 <span class="comment">%if EditFlag == 6</span>
3586                 <span class="comment">%   disp('   This function not yet available.');</span>
3587                 <span class="comment">%   % change BBPM List</span>
3588                 <span class="comment">%end</span>
3589 
3590             <span class="keyword">end</span>
3591             <span class="comment">%close(h_fig1);</span>
3592         <span class="keyword">end</span>
3593 
3594         <span class="comment">% Save vectors</span>
3595         FOFB.FOFBFreq = FOFBFreq;
3596         FOFB.HorP = HorP;
3597         FOFB.HorI = HorI;
3598         FOFB.HorD = HorD;
3599         FOFB.VertP = VertP;
3600         FOFB.VertI = VertI;
3601         FOFB.VertD = VertD;
3602         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Userdata'</span>,FOFB);
3603 
3604     <span class="keyword">otherwise</span>
3605         fprintf(<span class="string">'   No action for %s.\n'</span>, action);
3606 <span class="keyword">end</span>   <span class="comment">% end case</span></pre></div>
<hr><address>Generated on Thu 02-Aug-2007 13:16:07 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>