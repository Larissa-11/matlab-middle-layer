<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of setorbitgui</title>
  <meta name="keywords" content="setorbitgui">
  <meta name="description" content="SETORBITGUI - Orbit correction GUI">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">mml</a> &gt; setorbitgui.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>setorbitgui
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>SETORBITGUI - Orbit correction GUI</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function varargout = setorbitgui(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">SETORBITGUI - Orbit correction GUI

  See also <a href="setorbit.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbit(varargin)">setorbit</a>, <a href="orbitcorrectionmethods.html" class="code" title="function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)">orbitcorrectionmethods</a>, setorbitdefault, <a href="setorbitbump.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbitbump(varargin)">setorbitbump</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin)">family2dev</a>	FAMILY2DEV - Return the device list for a family</li><li><a href="getdata.html" class="code" title="function [S, FileName] = getdata(varargin)">getdata</a>	GETDATA - Searches through a file (or group of files) for a data structure which matches the family name</li><li><a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>	GETFAMILYDATA - Gets data associated with the accelerator control</li><li><a href="gethbpmfamily.html" class="code" title="function Family = gethbpmfamily(OneHit)">gethbpmfamily</a>	GETHBPMFAMILY - Return the default horizontal BPM family</li><li><a href="gethcmfamily.html" class="code" title="function Family = gethcmfamily(OneHit)">gethcmfamily</a>	GETHCMFAMILY - Returns the default horizontal corrector family</li><li><a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>	GETPV - Returns a variable from the online system or the model</li><li><a href="getrf.html" class="code" title="function [RFsp, RFam, DataTime, ErrorFlag] = getrf(varargin)">getrf</a>	GETRF - Gets the RF frequency</li><li><a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>	GETSP - Gets setpoint channels</li><li><a href="getvbpmfamily.html" class="code" title="function Family = getvbpmfamily(OneHit)">getvbpmfamily</a>	GETVBPMFAMILY - Return the default vertical BPM family</li><li><a href="getvcmfamily.html" class="code" title="function Family = getvcmfamily(OneHit)">getvcmfamily</a>	GETVCMFAMILY - Returns the default vertical corrector family</li><li><a href="getx.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getx(varargin)">getx</a>	GETX - Returns the horizontal orbit</li><li><a href="gety.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = gety(varargin)">gety</a>	GETY - Returns the vertical orbit</li><li><a href="setorbit.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbit(varargin)">setorbit</a>	SETORBIT - Orbit correction function</li><li><a href="setorbitsetup.html" class="code" title="function [BPM, CM, Flags, EVectors] = setorbitsetup(varargin)">setorbitsetup</a>	SETORBITSETUP - BPM & CM setup function for setorbitgui</li><li><a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>	SETPV - Setpoint change of the online system or model</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function varargout = setorbitgui_OutputFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub2" class="code">function varargout = CloseRequest_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub3" class="code">function setorbitgui_OpeningFcn(hObject, eventdata, handles, varargin)</a></li><li><a href="#_sub4" class="code">function SelectFlags_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub5" class="code">function CalcSVD(handles)</a></li><li><a href="#_sub6" class="code">function HorizontalPlane_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub7" class="code">function VerticalPlane_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub8" class="code">function SliderCMScaling_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub9" class="code">function EditCMScaling_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub10" class="code">function ScaleCorrectors_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub11" class="code">function EditDevice_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub12" class="code">function GetOrbit_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub13" class="code">function StopCorrection_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub14" class="code">function ApplyCorrection_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub15" class="code">function RemoveCorrection_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub16" class="code">function GetFile_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub17" class="code">function RadioButton_Offset_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub18" class="code">function RadioButton_Golden_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub19" class="code">function RadioButton_File_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub20" class="code">function RadioButton_Save_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub21" class="code">function SaveOrbit_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub22" class="code">function SaveOrbitToFile_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub23" class="code">function SaveOCS_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub24" class="code">function Graph_1_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub25" class="code">function Graph_2_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub26" class="code">function Graph_3_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub27" class="code">function Graph_4_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub28" class="code">function Graph_5_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub29" class="code">function Graph_6_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub30" class="code">function All_Graphs_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub31" class="code">function Edit_SVD_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub32" class="code">function RadioButton_RF_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub33" class="code">function Print_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub34" class="code">function Plots0_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub35" class="code">function Plots3_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub36" class="code">function Plots6_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub37" class="code">function FigResize_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub38" class="code">function UpdatePlots(handles)</a></li><li><a href="#_sub39" class="code">function MinimumPeriod_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub40" class="code">function CorrectorGain_Callback(hObject, eventdata, handles)</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function varargout = setorbitgui(varargin)</a>
0002 <span class="comment">%SETORBITGUI - Orbit correction GUI</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%  See also setorbit, orbitcorrectionmethods, setorbitdefault, setorbitbump</span>
0005 
0006 <span class="comment">%  Written by Jacob Pachikara and Greg Portmann</span>
0007 
0008 
0009 <span class="comment">% To do:</span>
0010 <span class="comment">% Stop blinking of legends during orbit feedback</span>
0011 <span class="comment">% Add ID tune feedforward, etc to setorbit?  (OCS.PreCorrectonFcn, OCS.PostCorrectonFcn)</span>
0012 <span class="comment">% Can setorbit working during a ramp?  (ie, check the bend magnet for a change?)</span>
0013 
0014 
0015 <span class="comment">% Last Modified by GUIDE v2.5 09-Jan-2007 11:53:49</span>
0016 
0017 
0018 <span class="comment">% Begin initialization code - DO NOT EDITMENU</span>
0019 gui_Singleton = 0;
0020 gui_State = struct(<span class="string">'gui_Name'</span>,       mfilename, <span class="keyword">...</span>
0021                    <span class="string">'gui_Singleton'</span>,  gui_Singleton, <span class="keyword">...</span>
0022                    <span class="string">'gui_OpeningFcn'</span>, @<a href="#_sub3" class="code" title="subfunction setorbitgui_OpeningFcn(hObject, eventdata, handles, varargin)">setorbitgui_OpeningFcn</a>, <span class="keyword">...</span>
0023                    <span class="string">'gui_OutputFcn'</span>,  @<a href="#_sub1" class="code" title="subfunction varargout = setorbitgui_OutputFcn(hObject, eventdata, handles)">setorbitgui_OutputFcn</a>, <span class="keyword">...</span>
0024                    <span class="string">'gui_LayoutFcn'</span>,  [] , <span class="keyword">...</span>
0025                    <span class="string">'gui_Callback'</span>,   []);
0026 <span class="keyword">if</span> nargin &amp;&amp; ischar(varargin{1})
0027     gui_State.gui_Callback = str2func(varargin{1});
0028 <span class="keyword">end</span>
0029 
0030 <span class="keyword">if</span> nargout
0031     [varargout{1:nargout}] = gui_mainfcn(gui_State, varargin{:});
0032 <span class="keyword">else</span>
0033     gui_mainfcn(gui_State, varargin{:});
0034 <span class="keyword">end</span>
0035 <span class="comment">% End initialization code - DO NOT EDITMENU</span>
0036 
0037 
0038 
0039 <span class="comment">% --- Outputs from this function are returned to the command line.</span>
0040 <a name="_sub1" href="#_subfunctions" class="code">function varargout = setorbitgui_OutputFcn(hObject, eventdata, handles) </a>
0041 <span class="comment">% Get default command line output from handles structure</span>
0042 varargout{1} = handles.output;
0043 
0044 
0045 
0046 <span class="comment">% --- Outputs from this function are returned to the command line.</span>
0047 <a name="_sub2" href="#_subfunctions" class="code">function varargout = CloseRequest_Callback(hObject, eventdata, handles) </a>
0048 
0049 RingSetOrbit.RunFlag = -1;
0050 setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
0051 pause(.1);
0052 
0053 delete(handles.figure1);
0054 
0055 
0056 
0057 <span class="comment">% --- Executes just before setorbitgui is made visible.</span>
0058 <a name="_sub3" href="#_subfunctions" class="code">function setorbitgui_OpeningFcn(hObject, eventdata, handles, varargin)</a>
0059 <span class="comment">% This function has no output args, see OutputFcn.</span>
0060 <span class="comment">% hObject    handle to figure</span>
0061 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0062 <span class="comment">% handles    structure with handles and user data (see GUIDATA)7</span>
0063 <span class="comment">% varargin   command line arguments to setorbitgui (see VARARGIN)</span>
0064 
0065 <span class="comment">% Choose default command line output for setorbitgui</span>
0066 handles.output = hObject;
0067 
0068 <span class="comment">% Update handles structure</span>
0069 guidata(hObject, handles);
0070 
0071 <span class="comment">% UIWAIT makes setorbitgui wait for user response (see UIRESUME)</span>
0072 <span class="comment">% uiwait(handles.figure1);</span>
0073 
0074 
0075 set(handles.RadioButton_Golden,<span class="string">'Value'</span>, 1);
0076 set(handles.HorizontalPlane,<span class="string">'Value'</span>, 1);
0077 set(handles.VerticalPlane,<span class="string">'Value'</span>, 1);
0078 set(handles.ApplyCorrection,<span class="string">'Enable'</span>,<span class="string">'Off'</span>);
0079 set(handles.RemoveCorrection,<span class="string">'Enable'</span>,<span class="string">'Off'</span>);
0080 set(handles.PopUpMenu_Iterations,<span class="string">'Value'</span>,1);
0081 set(handles.SaveOrbit,<span class="string">'Enable'</span>,<span class="string">'Off'</span>);
0082 set(handles.RadioButton_Save,<span class="string">'Enable'</span>,<span class="string">'Off'</span>);
0083 set(handles.RadioButton_File,<span class="string">'Enable'</span>,<span class="string">'Off'</span>);
0084 set(handles.SliderCMScaling,<span class="string">'Value'</span>,100.0);
0085 
0086 
0087 <span class="comment">% The BPM and CM devices</span>
0088 <span class="keyword">try</span>
0089     [BPM, CM, Flags, EVectors] = <a href="setorbitsetup.html" class="code" title="function [BPM, CM, Flags, EVectors] = setorbitsetup(varargin)">setorbitsetup</a>;
0090 
0091 <span class="keyword">catch</span>
0092 
0093     Flags{1}.NIter = 3;
0094     Flags{1}.SVDIndex = [];
0095     Flags{1}.GoalOrbit = <span class="string">'Golden'</span>;
0096     Flags{1}.PlaneFlag = 0;
0097 
0098     BPM.BPMxString{1} = sprintf(<span class="string">'%s'</span>, <a href="gethbpmfamily.html" class="code" title="function Family = gethbpmfamily(OneHit)">gethbpmfamily</a>);
0099     BPM.BPMyString{1} = sprintf(<span class="string">'%s'</span>, <a href="getvbpmfamily.html" class="code" title="function Family = getvbpmfamily(OneHit)">getvbpmfamily</a>);
0100     BPM.BPMx{1} = <a href="getx.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getx(varargin)">getx</a>(<span class="string">'Struct'</span>);
0101     BPM.BPMy{1} = <a href="gety.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = gety(varargin)">gety</a>(<span class="string">'Struct'</span>);
0102         
0103     CM.HCMString{1} = sprintf(<span class="string">'%s'</span>, <a href="gethcmfamily.html" class="code" title="function Family = gethcmfamily(OneHit)">gethcmfamily</a>);
0104     CM.VCMString{1} = sprintf(<span class="string">'%s'</span>, <a href="getvcmfamily.html" class="code" title="function Family = getvcmfamily(OneHit)">getvcmfamily</a>);
0105     CM.HCM{1} = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(<a href="gethcmfamily.html" class="code" title="function Family = gethcmfamily(OneHit)">gethcmfamily</a>, <span class="string">'Struct'</span>);
0106     CM.VCM{1} = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(<a href="getvcmfamily.html" class="code" title="function Family = getvcmfamily(OneHit)">getvcmfamily</a>, <span class="string">'Struct'</span>);
0107     
0108     EVectors = [];
0109 <span class="keyword">end</span>
0110 
0111 
0112 <span class="comment">% Add number of devices to pulldown lists</span>
0113 <span class="keyword">for</span> i = 1:length(BPM.BPMxString)
0114     Data = BPM.BPMx{i};
0115     <span class="keyword">if</span> iscell(Data)
0116         NumberOfDevices = 0;
0117         <span class="keyword">for</span> j = 1:length(BPM.BPMxString)
0118             NumberOfDevices = NumberOfDevices + size(Data{j}.DeviceList,1);
0119         <span class="keyword">end</span>
0120     <span class="keyword">else</span>
0121         NumberOfDevices = size(Data.DeviceList,1);
0122     <span class="keyword">end</span>
0123     BPM.BPMxString{i} = sprintf(<span class="string">'%s  (%d)'</span>, BPM.BPMxString{i}, NumberOfDevices);
0124 <span class="keyword">end</span>
0125 <span class="keyword">for</span> i = 1:length(BPM.BPMyString)
0126     Data = BPM.BPMy{i};
0127     <span class="keyword">if</span> iscell(Data)
0128         NumberOfDevices = 0;
0129         <span class="keyword">for</span> j = 1:length(BPM.BPMyString)
0130             NumberOfDevices = NumberOfDevices + size(Data{j}.DeviceList,1);
0131         <span class="keyword">end</span>
0132     <span class="keyword">else</span>
0133         NumberOfDevices = size(Data.DeviceList,1);
0134     <span class="keyword">end</span>
0135     BPM.BPMyString{i} = sprintf(<span class="string">'%s  (%d)'</span>, BPM.BPMyString{i}, NumberOfDevices);
0136 <span class="keyword">end</span>
0137 <span class="keyword">for</span> i = 1:length(CM.HCMString)
0138     Data = CM.HCM{i};
0139     <span class="keyword">if</span> iscell(Data)
0140         NumberOfDevices = 0;
0141         <span class="keyword">for</span> j = 1:length(CM.HCMString)
0142             NumberOfDevices = NumberOfDevices + size(Data{j}.DeviceList,1);
0143         <span class="keyword">end</span>
0144     <span class="keyword">else</span>
0145         NumberOfDevices = size(Data.DeviceList,1);
0146     <span class="keyword">end</span>
0147     CM.HCMString{i} = sprintf(<span class="string">'%s  (%d)'</span>, CM.HCMString{i}, NumberOfDevices);
0148 <span class="keyword">end</span>
0149 <span class="keyword">for</span> i = 1:length(CM.VCMString)
0150     Data = CM.VCM{i};
0151     <span class="keyword">if</span> iscell(Data)
0152         NumberOfDevices = 0;
0153         <span class="keyword">for</span> j = 1:length(CM.VCMString)
0154             NumberOfDevices = NumberOfDevices + size(Data{j}.DeviceList,1);
0155         <span class="keyword">end</span>
0156     <span class="keyword">else</span>
0157         NumberOfDevices = size(Data.DeviceList,1);
0158     <span class="keyword">end</span>
0159     CM.VCMString{i} = sprintf(<span class="string">'%s  (%d)'</span>, CM.VCMString{i}, NumberOfDevices);
0160 <span class="keyword">end</span>
0161 
0162 <span class="comment">% Set pull down strings</span>
0163 set(handles.SelectBPMx, <span class="string">'String'</span>, BPM.BPMxString);
0164 set(handles.SelectBPMy, <span class="string">'String'</span>, BPM.BPMyString);
0165 set(handles.SelectHCM,  <span class="string">'String'</span>, CM.HCMString);
0166 set(handles.SelectVCM,  <span class="string">'String'</span>, CM.VCMString);
0167 
0168     
0169 <span class="comment">% Initialize variables</span>
0170 setappdata(handles.figure1, <span class="string">'BPMxCell'</span>, BPM.BPMx);
0171 setappdata(handles.figure1, <span class="string">'BPMxCellOriginal'</span>, BPM.BPMx);
0172 setappdata(handles.figure1, <span class="string">'BPMyCell'</span>, BPM.BPMy);
0173 setappdata(handles.figure1, <span class="string">'BPMyCellOriginal'</span>, BPM.BPMy);
0174 setappdata(handles.figure1, <span class="string">'HCMCell'</span>, CM.HCM);
0175 setappdata(handles.figure1, <span class="string">'HCMCellOriginal'</span>, CM.HCM);
0176 setappdata(handles.figure1, <span class="string">'VCMCell'</span>, CM.VCM);
0177 setappdata(handles.figure1, <span class="string">'VCMCellOriginal'</span>, CM.VCM);
0178 setappdata(handles.figure1, <span class="string">'FlagsCell'</span>, Flags);
0179 setappdata(handles.figure1, <span class="string">'EVectors'</span>, EVectors);
0180 
0181 setappdata(handles.figure1, <span class="string">'OCS'</span>, <span class="string">''</span>);
0182 
0183 
0184 <span class="comment">% Set the edit box equal to the slider value</span>
0185 set(handles.EditCMScaling, <span class="string">'String'</span>, sprintf(<span class="string">'%.1f'</span>,get(handles.SliderCMScaling,<span class="string">'Value'</span>)));
0186 
0187 
0188 <span class="comment">% Resize to less plots</span>
0189 <span class="comment">%set(handles.Plots0, 'Checked', 'Off');</span>
0190 <span class="comment">%set(handles.Plots3, 'Checked', 'On');</span>
0191 <span class="comment">%set(handles.Plots6, 'Checked', 'Off');</span>
0192 <a href="#_sub37" class="code" title="subfunction FigResize_Callback(hObject, eventdata, handles)">FigResize_Callback</a>(hObject, eventdata, handles);
0193 
0194 
0195 <span class="comment">% Update</span>
0196 <a href="#_sub4" class="code" title="subfunction SelectFlags_Callback(hObject, eventdata, handles)">SelectFlags_Callback</a>(handles.HorizontalPlane, eventdata, handles);
0197 
0198 
0199 <span class="comment">% --------------------------------------------------------------------</span>
0200 <a name="_sub4" href="#_subfunctions" class="code">function SelectFlags_Callback(hObject, eventdata, handles)</a>
0201 <span class="comment">% Plane</span>
0202 
0203 <span class="comment">% Family = get(hObject,'Tag');</span>
0204 <span class="comment">% Family(1:6) = '';</span>
0205 <span class="comment">% UpdateFlag = 1;</span>
0206 <span class="comment">% if strcmpi(Family, 'BPMx') &amp; ~get(handles.HorizontalPlane, 'Value')</span>
0207 <span class="comment">%    UpdateFlag = 0;</span>
0208 <span class="comment">% elseif strcmpi(Family, 'HCM') &amp; ~get(handles.HorizontalPlane, 'Value')</span>
0209 <span class="comment">%    UpdateFlag = 0;</span>
0210 <span class="comment">% elseif strcmpi(Family, 'BPMy') &amp; ~get(handles.VerticalPlane, 'Value')</span>
0211 <span class="comment">%    UpdateFlag = 0;</span>
0212 <span class="comment">% elseif strcmpi(Family, 'VCM') &amp; ~get(handles.VerticalPlane, 'Value')</span>
0213 <span class="comment">%    UpdateFlag = 0;</span>
0214 <span class="comment">% end</span>
0215 
0216 
0217 <span class="comment">% Orbit (Default, can get over written by FlagsCell)</span>
0218 set(handles.RadioButton_Golden, <span class="string">'Value'</span>, 1);
0219 set(handles.RadioButton_Offset, <span class="string">'Value'</span>, 0);
0220 set(handles.RadioButton_File,   <span class="string">'Value'</span>, 0);
0221 set(handles.RadioButton_Save,   <span class="string">'Value'</span>, 0);
0222 
0223 
0224 FlagsCell = getappdata(handles.figure1, <span class="string">'FlagsCell'</span>);
0225 <span class="keyword">if</span> ~isempty(FlagsCell)
0226 
0227     <span class="keyword">if</span> iscell(FlagsCell)
0228         i = get(hObject, <span class="string">'Value'</span>);
0229         <span class="keyword">if</span> length(FlagsCell) == 1
0230             Flags = FlagsCell{1};
0231         <span class="keyword">else</span>
0232             Flags = FlagsCell{i};
0233         <span class="keyword">end</span>
0234     <span class="keyword">else</span>
0235         Flags = FlagsCell;
0236     <span class="keyword">end</span>
0237     
0238     <span class="comment">% Plane</span>
0239     <span class="comment">%if isfield(Flags, 'PlaneFlag')</span>
0240     <span class="comment">%    if Flags.PlaneFlag == 1</span>
0241     <span class="comment">%        set(handles.HorizontalPlane, 'Value', 1);</span>
0242     <span class="comment">%        set(handles.VerticalPlane,   'Value', 0);</span>
0243     <span class="comment">%    elseif Flags.PlaneFlag == 2</span>
0244     <span class="comment">%        set(handles.HorizontalPlane, 'Value', 0);</span>
0245     <span class="comment">%        set(handles.VerticalPlane,   'Value', 1);</span>
0246     <span class="comment">%    end</span>
0247     <span class="comment">%end</span>
0248 
0249    
0250     <span class="comment">% Orbit</span>
0251     <span class="keyword">if</span> isfield(Flags, <span class="string">'GoalOrbit'</span>)
0252         <span class="keyword">if</span> strcmpi(Flags.GoalOrbit, <span class="string">'Golden'</span>)
0253             set(handles.RadioButton_Golden, <span class="string">'Value'</span>, 1);
0254             set(handles.RadioButton_Offset, <span class="string">'Value'</span>, 0);
0255             set(handles.RadioButton_File,   <span class="string">'Value'</span>, 0);
0256             set(handles.RadioButton_Save,   <span class="string">'Value'</span>, 0);
0257         <span class="keyword">elseif</span> strcmpi(Flags.GoalOrbit, <span class="string">'Offset'</span>)
0258             set(handles.RadioButton_Golden, <span class="string">'Value'</span>, 0);
0259             set(handles.RadioButton_Offset, <span class="string">'Value'</span>, 1);
0260             set(handles.RadioButton_File,   <span class="string">'Value'</span>, 0);
0261             set(handles.RadioButton_Save,   <span class="string">'Value'</span>, 0);
0262         <span class="keyword">end</span>
0263     <span class="keyword">end</span>
0264 
0265     <span class="comment">% Interations</span>
0266     <span class="keyword">if</span> isfield(Flags, <span class="string">'NIter'</span>)
0267         Flags.NIter = round(Flags.NIter);
0268         
0269         <span class="keyword">if</span> Flags.NIter&gt;15 &amp;&amp; Flags.NIter~=Inf
0270             Flags.NIter = 15;
0271         <span class="keyword">end</span>
0272         <span class="keyword">if</span> Flags.NIter &lt; 1
0273             Flags.NIter = 1;
0274         <span class="keyword">end</span>
0275         <span class="keyword">if</span> Flags.NIter == Inf
0276             set(handles.PopUpMenu_Iterations, <span class="string">'Value'</span>, 16);
0277         <span class="keyword">else</span>
0278             set(handles.PopUpMenu_Iterations, <span class="string">'Value'</span>, Flags.NIter);
0279         <span class="keyword">end</span>
0280     <span class="keyword">end</span>
0281 <span class="keyword">end</span>
0282 
0283 
0284 <span class="comment">% Update the number of SV to use</span>
0285 <a href="#_sub5" class="code" title="subfunction CalcSVD(handles)">CalcSVD</a>(handles);
0286 
0287 
0288 set(handles.GetOrbit,<span class="string">'Enable'</span>,<span class="string">'On'</span>)
0289 <span class="keyword">if</span> get(handles.HorizontalPlane,<span class="string">'Value'</span>) == 1
0290     set(handles.SelectBPMx, <span class="string">'Enable'</span>, <span class="string">'On'</span>)
0291     set(handles.SelectHCM,  <span class="string">'Enable'</span>, <span class="string">'On'</span>)
0292 <span class="keyword">else</span>
0293     set(handles.SelectBPMx, <span class="string">'Enable'</span>, <span class="string">'Off'</span>)
0294     set(handles.SelectHCM,  <span class="string">'Enable'</span>, <span class="string">'Off'</span>)
0295     <span class="keyword">if</span> get(handles.VerticalPlane,<span class="string">'Value'</span>) == 0
0296         set(handles.GetOrbit, <span class="string">'Enable'</span>, <span class="string">'Off'</span>)
0297     <span class="keyword">end</span>
0298 <span class="keyword">end</span>
0299 
0300 <span class="comment">% if get(handles.VerticalPlane,'Value') == 1</span>
0301 <span class="comment">%     set(handles.SelectBPMy, 'Enable', 'On')</span>
0302 <span class="comment">%     set(handles.SelectVCM,  'Enable', 'On')</span>
0303 <span class="comment">% else</span>
0304 <span class="comment">%     set(handles.SelectBPMy, 'Enable', 'Off')</span>
0305 <span class="comment">%     set(handles.SelectVCM,  'Enable', 'Off')</span>
0306 <span class="comment">%     if get(handles.HorizontalPlane,'Value') == 0</span>
0307 <span class="comment">%         set(handles.GetOrbit, 'Enable', 'Off')</span>
0308 <span class="comment">%     end</span>
0309 <span class="comment">% end</span>
0310 
0311 
0312 <span class="comment">% Update the plots</span>
0313 <a href="#_sub12" class="code" title="subfunction GetOrbit_Callback(hObject, eventdata, handles)">GetOrbit_Callback</a>(hObject, eventdata, handles);
0314 
0315 
0316 
0317 <a name="_sub5" href="#_subfunctions" class="code">function CalcSVD(handles)</a>
0318 <span class="comment">% SVD</span>
0319 
0320 SVDStart = str2num(get(handles.Edit_SVD, <span class="string">'String'</span>));
0321 
0322 <span class="keyword">try</span>
0323     SVDIndex = 0;
0324     EVectors = getappdata(handles.figure1, <span class="string">'EVectors'</span>);
0325     <span class="keyword">if</span> isstruct(EVectors)
0326         <span class="keyword">if</span> get(handles.HorizontalPlane, <span class="string">'Value'</span>) == 1
0327             SVDIndex = SVDIndex + EVectors.BPMx(get(handles.SelectBPMx,<span class="string">'Value'</span>));
0328             SVDIndex = SVDIndex + EVectors.HCM(get(handles.SelectHCM,<span class="string">'Value'</span>));
0329         <span class="keyword">end</span>
0330         <span class="keyword">if</span> get(handles.VerticalPlane, <span class="string">'Value'</span>) == 1
0331             SVDIndex = SVDIndex + EVectors.BPMy(get(handles.SelectBPMy,<span class="string">'Value'</span>));
0332             SVDIndex = SVDIndex + EVectors.VCM(get(handles.SelectVCM,<span class="string">'Value'</span>));
0333         <span class="keyword">end</span>
0334     <span class="keyword">else</span>
0335         <span class="keyword">if</span> all(size(EVectors)==[1 1])
0336             SVDIndex = EVectors;
0337         <span class="keyword">else</span>
0338             SVDIndex = SVDStart;
0339         <span class="keyword">end</span>
0340     <span class="keyword">end</span>
0341 <span class="keyword">catch</span>
0342     SVDIndex = SVDStart;
0343 <span class="keyword">end</span>
0344 
0345 set(handles.Edit_SVD, <span class="string">'String'</span>, num2str(SVDIndex));
0346 
0347 
0348 
0349 <span class="comment">% --------------------------------------------------------------------</span>
0350 <a name="_sub6" href="#_subfunctions" class="code">function HorizontalPlane_Callback(hObject, eventdata, handles)</a>
0351 
0352 <span class="keyword">if</span> get(hObject,<span class="string">'Value'</span>)
0353     set(handles.SelectBPMx, <span class="string">'Enable'</span>, <span class="string">'On'</span>)
0354     set(handles.SelectHCM,  <span class="string">'Enable'</span>, <span class="string">'On'</span>)
0355     set(handles.GetOrbit,   <span class="string">'Enable'</span>, <span class="string">'On'</span>)
0356 <span class="keyword">else</span>
0357     set(handles.SelectBPMx, <span class="string">'Enable'</span>, <span class="string">'Off'</span>)
0358     set(handles.SelectHCM,  <span class="string">'Enable'</span>, <span class="string">'Off'</span>)
0359 
0360     <span class="comment">% Make sure the RF is out of the fit if the horizontal plane is off</span>
0361     set(handles.RadioButton_RF, <span class="string">'Value'</span>, 0);
0362 <span class="keyword">end</span>
0363 
0364 
0365 <span class="keyword">if</span> ~get(hObject,<span class="string">'Value'</span>) &amp;&amp; ~get(handles.VerticalPlane,<span class="string">'Value'</span>)
0366     set(handles.GetOrbit,<span class="string">'Enable'</span>,<span class="string">'Off'</span>)
0367 <span class="keyword">end</span>
0368 
0369 <span class="comment">% Update the number of SV to use</span>
0370 <a href="#_sub5" class="code" title="subfunction CalcSVD(handles)">CalcSVD</a>(handles);
0371 
0372 <span class="comment">% Update the plots</span>
0373 <a href="#_sub12" class="code" title="subfunction GetOrbit_Callback(hObject, eventdata, handles)">GetOrbit_Callback</a>(hObject, eventdata, handles);
0374 
0375 
0376 
0377 <span class="comment">% --------------------------------------------------------------------</span>
0378 <a name="_sub7" href="#_subfunctions" class="code">function VerticalPlane_Callback(hObject, eventdata, handles)</a>
0379 
0380 <span class="keyword">if</span> get(handles.VerticalPlane,<span class="string">'Value'</span>)
0381     set(handles.SelectBPMy, <span class="string">'Enable'</span>, <span class="string">'On'</span>)
0382     set(handles.SelectVCM,  <span class="string">'Enable'</span>, <span class="string">'On'</span>)
0383     set(handles.GetOrbit,   <span class="string">'Enable'</span>, <span class="string">'On'</span>)
0384 <span class="keyword">else</span>
0385     set(handles.SelectBPMy, <span class="string">'Enable'</span>, <span class="string">'Off'</span>)
0386     set(handles.SelectVCM,  <span class="string">'Enable'</span>, <span class="string">'Off'</span>)
0387 <span class="keyword">end</span>
0388 
0389 <span class="keyword">if</span> ~get(hObject,<span class="string">'Value'</span>) &amp;&amp; ~get(handles.HorizontalPlane,<span class="string">'Value'</span>)
0390     set(handles.GetOrbit,<span class="string">'Enable'</span>,<span class="string">'Off'</span>)
0391 <span class="keyword">end</span>
0392 
0393 <span class="comment">% Update the number of SV to use</span>
0394 <a href="#_sub5" class="code" title="subfunction CalcSVD(handles)">CalcSVD</a>(handles);
0395 
0396 <span class="comment">% Update the plots</span>
0397 <a href="#_sub12" class="code" title="subfunction GetOrbit_Callback(hObject, eventdata, handles)">GetOrbit_Callback</a>(hObject, eventdata, handles);
0398 
0399 
0400 
0401 <span class="comment">% --------------------------------------------------------------------</span>
0402 <a name="_sub8" href="#_subfunctions" class="code">function SliderCMScaling_Callback(hObject, eventdata, handles)</a>
0403 set(handles.EditCMScaling, <span class="string">'String'</span>, sprintf(<span class="string">'%.1f'</span>,get(handles.SliderCMScaling,<span class="string">'Value'</span>)));
0404 
0405 
0406 <span class="comment">% --------------------------------------------------------------------</span>
0407 <a name="_sub9" href="#_subfunctions" class="code">function EditCMScaling_Callback(hObject, eventdata, handles)</a>
0408 val = str2num(get(handles.EditCMScaling,<span class="string">'String'</span>));
0409 <span class="comment">% Determine whether val is a number between 0 and 1</span>
0410 <span class="keyword">if</span> isnumeric(val) &amp;&amp; length(val)==1 &amp;&amp; <span class="keyword">...</span>
0411     val &gt;= get(handles.SliderCMScaling,<span class="string">'Min'</span>) &amp;&amp; <span class="keyword">...</span>
0412     val &lt;= get(handles.SliderCMScaling,<span class="string">'Max'</span>)
0413     set(handles.SliderCMScaling,<span class="string">'Value'</span>,val);
0414 <span class="keyword">end</span>
0415 
0416 
0417 <span class="comment">% --------------------------------------------------------------------</span>
0418 <a name="_sub10" href="#_subfunctions" class="code">function ScaleCorrectors_Callback(hObject, eventdata, handles)</a>
0419 
0420 Gain = get(handles.SliderCMScaling,<span class="string">'Value'</span>)/100;
0421 
0422 <span class="keyword">if</span> Gain == 1
0423     <span class="keyword">return</span>;
0424 <span class="keyword">end</span>
0425 
0426 
0427 <span class="comment">% Disable buttons during setpoint change</span>
0428 set(handles.GetOrbit,              <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0429 set(handles.ApplyCorrection,       <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0430 set(handles.RemoveCorrection,      <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0431 set(handles.ScaleCorrectors,       <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0432 set(handles.FileMenu,              <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0433 set(handles.EditMenu,              <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0434 set(handles.LatticeMenu,           <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0435 set(handles.RadioButton_Golden,    <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0436 set(handles.RadioButton_Offset,    <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0437 set(handles.RadioButton_File,      <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0438 set(handles.RadioButton_Save,      <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0439 set(handles.GetFile,               <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0440 set(handles.SaveOrbit,             <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0441 set(handles.Edit_SVD,              <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0442 set(handles.HorizontalPlane,       <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0443 set(handles.VerticalPlane,         <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0444 set(handles.SelectBPMx,            <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0445 set(handles.SelectBPMy,            <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0446 set(handles.SelectHCM,             <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0447 set(handles.SelectVCM,             <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0448 set(handles.PopUpMenu_Iterations,  <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0449 drawnow;
0450 
0451 
0452 i = 0;
0453 <span class="keyword">if</span> get(handles.HorizontalPlane,<span class="string">'Value'</span>) == 1 
0454     CMCell = getappdata(handles.figure1, <span class="string">'HCMCell'</span>);
0455     iCell = get(handles.SelectHCM,<span class="string">'Value'</span>);
0456     Data = CMCell{iCell};
0457     <span class="keyword">if</span> iscell(Data)
0458         <span class="comment">% Cells</span>
0459         <span class="keyword">for</span> j = 1:length(Data)
0460             i = i + 1;
0461             SP{i} = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(Data{j}, <span class="string">'Struct'</span>);
0462         <span class="keyword">end</span>
0463     <span class="keyword">else</span>
0464         <span class="comment">% Data structure</span>
0465         i = i + 1;
0466         SP{i} = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(Data, <span class="string">'Struct'</span>);
0467     <span class="keyword">end</span>
0468 <span class="keyword">end</span>
0469 
0470 <span class="keyword">if</span> get(handles.VerticalPlane,<span class="string">'Value'</span>) == 1
0471     CMCell = getappdata(handles.figure1, <span class="string">'VCMCell'</span>);
0472     iCell = get(handles.SelectHCM,<span class="string">'Value'</span>);
0473     Data = CMCell{iCell};
0474     <span class="keyword">if</span> iscell(Data)
0475         <span class="comment">% Cells</span>
0476         <span class="keyword">for</span> j = 1:length(Data)
0477             i = i + 1;
0478             SP{i} = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(Data{j}, <span class="string">'Struct'</span>);
0479         <span class="keyword">end</span>
0480     <span class="keyword">else</span>
0481         <span class="comment">% Data structure</span>
0482         i = i + 1;
0483         SP{i} = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(Data, <span class="string">'Struct'</span>);
0484     <span class="keyword">end</span>
0485 <span class="keyword">end</span>
0486 
0487 
0488 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0489 <span class="comment">% SaveOrbit the prsent setpoints %</span>
0490 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0491 SP_History = getappdata(handles.figure1, <span class="string">'SP_History'</span>);
0492 SPwithRF = SP;
0493 SPwithRF{length(SPwithRF)+1} = <a href="getrf.html" class="code" title="function [RFsp, RFam, DataTime, ErrorFlag] = getrf(varargin)">getrf</a>(<span class="string">'Struct'</span>);
0494 SP_History{length(SP_History)+1} = SPwithRF;
0495 setappdata(handles.figure1, <span class="string">'SP_History'</span>, SP_History);
0496 set(handles.RemoveCorrection, <span class="string">'String'</span>, sprintf(<span class="string">'Remove Correction %d'</span>,length(SP_History)))
0497 
0498 
0499 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0500 <span class="comment">% Set everything again with a wait flag of 0 then -1 %</span>
0501 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0502 <span class="keyword">if</span> exist(<span class="string">'turnoff'</span>,<span class="string">'file'</span>) == 2
0503     <span class="keyword">for</span> i = 1:length(SP)
0504         turnoff(SP{i}.FamilyName, SP{i}.DeviceList, Gain);
0505     <span class="keyword">end</span>
0506 <span class="keyword">else</span>
0507     <span class="keyword">for</span> i = 1:length(SP)
0508         SP{i}.Data = Gain * SP{i}.Data;
0509         <a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>(SP{i}, 0);
0510     <span class="keyword">end</span>
0511     <span class="keyword">for</span> i = 1:length(SP)
0512         <a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>(SP{i}, -1);
0513     <span class="keyword">end</span>
0514 <span class="keyword">end</span>
0515 
0516 <span class="comment">% Get new BPM data and update plots</span>
0517 <a href="#_sub12" class="code" title="subfunction GetOrbit_Callback(hObject, eventdata, handles)">GetOrbit_Callback</a>(hObject, eventdata, handles);
0518 
0519 <span class="comment">% Re-enable buttons</span>
0520 set(handles.GetOrbit,              <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0521 set(handles.ApplyCorrection,       <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0522 set(handles.RemoveCorrection,      <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0523 set(handles.ScaleCorrectors,       <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0524 set(handles.FileMenu,              <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0525 set(handles.EditMenu,              <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0526 set(handles.LatticeMenu,           <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0527 set(handles.RadioButton_Golden,    <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0528 set(handles.RadioButton_Offset,    <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0529 set(handles.RadioButton_File,      <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0530 set(handles.RadioButton_Save,      <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0531 set(handles.GetFile,               <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0532 set(handles.SaveOrbit,             <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0533 set(handles.Edit_SVD,              <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0534 set(handles.HorizontalPlane,       <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0535 set(handles.VerticalPlane,         <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0536 set(handles.SelectBPMx,            <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0537 set(handles.SelectBPMy,            <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0538 set(handles.SelectHCM,             <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0539 set(handles.SelectVCM,             <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0540 set(handles.PopUpMenu_Iterations,  <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0541 
0542 
0543 
0544 <span class="comment">% --------------------------------------------------------------------</span>
0545 <a name="_sub11" href="#_subfunctions" class="code">function EditDevice_Callback(hObject, eventdata, handles)</a>
0546 <span class="comment">%Family = 'BPMx';</span>
0547 Family = get(hObject,<span class="string">'Tag'</span>);
0548 Family(1:4) = <span class="string">''</span>;
0549 
0550 DataCell         = getappdata(handles.figure1, [Family, <span class="string">'Cell'</span>]);
0551 DataCellOriginal = getappdata(handles.figure1, [Family, <span class="string">'CellOriginal'</span>]);
0552 iCell = get(handles.([<span class="string">'Select'</span>,Family]), <span class="string">'Value'</span>);
0553 
0554 Data = DataCell{iCell};
0555 DataOriginal = DataCellOriginal{iCell};
0556 NumberOfDevices = 0;
0557 <span class="keyword">if</span> iscell(DataOriginal)
0558     <span class="comment">% Cell array</span>
0559     <span class="keyword">for</span> i = 1:length(DataOriginal)
0560         DeviceListTotal = <a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin)">family2dev</a>(DataOriginal{i}.FamilyName);
0561         <span class="comment">%DeviceListTotal = DataOriginal{i}.DeviceList;</span>
0562         CheckList = zeros(size(DeviceListTotal,1),1);
0563         iDev = findrowindex(Data{i}.DeviceList, DeviceListTotal);
0564         CheckList(iDev) = 1;
0565         Data{i}.DeviceList = editlist(DeviceListTotal, Data{i}.FamilyName, CheckList);
0566         NumberOfDevices = NumberOfDevices + size(Data{i}.DeviceList,1);
0567     <span class="keyword">end</span>
0568 <span class="keyword">else</span>
0569     <span class="comment">% Data structure</span>
0570     DeviceListTotal = <a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin)">family2dev</a>(DataOriginal.FamilyName);
0571     <span class="comment">%DeviceListTotal = DataOriginal.DeviceList;</span>
0572     CheckList = zeros(size(DeviceListTotal,1),1);
0573     iDev = findrowindex(Data.DeviceList, DeviceListTotal);
0574     CheckList(iDev) = 1;
0575     Data.DeviceList = editlist(DeviceListTotal, Data.FamilyName, CheckList);
0576     NumberOfDevices = NumberOfDevices + size(Data.DeviceList,1);
0577 <span class="keyword">end</span>
0578 
0579 DataCell{iCell} = Data;
0580 setappdata(handles.figure1, [Family, <span class="string">'Cell'</span>], DataCell);
0581 
0582 <span class="comment">% Change the number of devices in the pulldown string</span>
0583 <span class="keyword">try</span>
0584     StringCell = get(handles.([<span class="string">'Select'</span>,Family]), <span class="string">'String'</span>);
0585     TitleString = StringCell{iCell};
0586     i = findstr(TitleString,<span class="string">'('</span>);
0587     <span class="keyword">if</span> ~isempty(i)
0588         TitleString = sprintf(<span class="string">'%s  (%d)'</span>, TitleString(1:i(end)-1), NumberOfDevices);
0589         StringCell{iCell} = TitleString;
0590         set(handles.([<span class="string">'Select'</span>,Family]), <span class="string">'String'</span>, StringCell);
0591     <span class="keyword">end</span>
0592 <span class="keyword">catch</span>
0593 <span class="keyword">end</span>
0594 
0595 <a href="#_sub12" class="code" title="subfunction GetOrbit_Callback(hObject, eventdata, handles)">GetOrbit_Callback</a>(hObject, eventdata, handles);
0596 
0597 
0598 
0599 <span class="comment">% --------------------------------------------------------------------</span>
0600 <a name="_sub12" href="#_subfunctions" class="code">function GetOrbit_Callback(hObject, eventdata, handles)</a>
0601 <span class="comment">% setorbit(goalorbit,getx('Struct'),getsp('HCM','struct'),'NoSetSP','FigureHandles',[handles.axes1;handles.axes2;handles.axes3]);</span>
0602 
0603 RemoveCorrectionEnable = get(handles.RemoveCorrection, <span class="string">'Enable'</span>);
0604 set(handles.MinimumPeriod,    <span class="string">'Enable'</span>, <span class="string">'Off'</span>);
0605 set(handles.RemoveCorrection, <span class="string">'Enable'</span>, <span class="string">'Off'</span>);
0606 set(handles.ApplyCorrection,  <span class="string">'Enable'</span>, <span class="string">'Off'</span>);
0607 set(handles.GetOrbit,         <span class="string">'Enable'</span>, <span class="string">'Off'</span>);
0608 drawnow;
0609 
0610 
0611 OCS = getappdata(handles.figure1, <span class="string">'OCS'</span>);
0612 OCS.BPM       = [];
0613 OCS.BPMWeight = [];
0614 OCS.CM        = [];
0615 OCS.CMWeight  = [];
0616 
0617 
0618 i = 0;
0619 <span class="keyword">if</span> get(handles.HorizontalPlane,<span class="string">'Value'</span>) == 1 
0620     i = i + 1;
0621 
0622     BPMCell = getappdata(handles.figure1, <span class="string">'BPMxCell'</span>);
0623     j = get(handles.SelectBPMx,<span class="string">'Value'</span>);
0624     <span class="keyword">if</span> iscell(BPMCell{j})
0625         OCS.BPM = BPMCell{j};
0626     <span class="keyword">else</span>
0627         OCS.BPM{i} = BPMCell{j};
0628     <span class="keyword">end</span>
0629 
0630     CMCell = getappdata(handles.figure1, <span class="string">'HCMCell'</span>);
0631     j = get(handles.SelectHCM,<span class="string">'Value'</span>);
0632     <span class="keyword">if</span> iscell(CMCell{j})
0633         OCS.CM = CMCell{j};
0634     <span class="keyword">else</span>
0635         OCS.CM{i} = CMCell{j};
0636     <span class="keyword">end</span>
0637 
0638     <span class="comment">% Use default column weights</span>
0639     OCS.CMWeight{i} = [];
0640 <span class="keyword">end</span>
0641 
0642 <span class="keyword">if</span> get(handles.VerticalPlane,<span class="string">'Value'</span>) == 1
0643     i = i + 1;
0644 
0645     BPMCell = getappdata(handles.figure1, <span class="string">'BPMyCell'</span>);
0646     j = get(handles.SelectBPMy,<span class="string">'Value'</span>);
0647     <span class="keyword">if</span> iscell(BPMCell{j})
0648         OCS.BPM = [OCS.BPM BPMCell{j}];
0649     <span class="keyword">else</span>
0650         OCS.BPM{i} = BPMCell{j};
0651     <span class="keyword">end</span>
0652     
0653     CMCell = getappdata(handles.figure1, <span class="string">'VCMCell'</span>);
0654     j = get(handles.SelectVCM,<span class="string">'Value'</span>);   
0655     <span class="keyword">if</span> iscell(CMCell{j})
0656         OCS.CM = [OCS.CM CMCell{j}];
0657     <span class="keyword">else</span>
0658         OCS.CM{i} = CMCell{j};
0659     <span class="keyword">end</span>
0660 
0661     <span class="comment">% Use default column weights</span>
0662     OCS.CMWeight{i} = [];
0663 <span class="keyword">end</span>
0664 
0665 <span class="keyword">if</span> i==0
0666     <span class="keyword">return</span>;
0667 <span class="keyword">end</span>
0668 
0669 
0670 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
0671 <span class="comment">% Find the goal orbit %</span>
0672 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
0673 
0674 <span class="comment">% Goal orbit: golden orbit</span>
0675 <span class="keyword">if</span> get(handles.RadioButton_Golden,<span class="string">'Value'</span>) == 1 
0676     OCS.GoalOrbit = <span class="string">'Golden'</span>;
0677 <span class="keyword">end</span>
0678 
0679 <span class="comment">% Goal orbit: offset orbit</span>
0680 <span class="keyword">if</span> get(handles.RadioButton_Offset,<span class="string">'Value'</span>) == 1 
0681     OCS.GoalOrbit = <span class="string">'Offset'</span>;
0682 <span class="keyword">end</span>
0683 
0684 <span class="comment">% Goal orbit: saved orbit</span>
0685 <span class="keyword">if</span> get(handles.RadioButton_Save,<span class="string">'Value'</span>) == 1
0686     OCS.GoalOrbit = [];
0687     bpmsave = getappdata(handles.figure1,<span class="string">'bpmsave'</span>);
0688     ErrorFlag = 0;
0689     <span class="keyword">for</span> i = 1:length(OCS.BPM)
0690         <span class="keyword">for</span> j = 1:length(bpmsave)
0691             <span class="keyword">if</span> strcmp(OCS.BPM{i}.FamilyName, bpmsave{j}.FamilyName)
0692                 [k, iNotFound] = findrowindex(OCS.BPM{i}.DeviceList, bpmsave{j}.DeviceList);
0693                 <span class="keyword">if</span> isempty(iNotFound)
0694                     OCS.GoalOrbit{i} = bpmsave{j}.Data(k);
0695                 <span class="keyword">else</span>
0696                     uiwait(warndlg({<span class="string">'BPMs not found in the save!'</span>,<span class="string">'Setting the goal orbit to the golden orbit.'</span>},<span class="string">'SETORBIT'</span>,<span class="string">'Modal'</span>));
0697                     set(handles.RadioButton_Golden,<span class="string">'Value'</span>, 1)
0698                     set(handles.RadioButton_Save,<span class="string">'Value'</span>, 0)
0699                     OCS.GoalOrbit = <span class="string">'golden'</span>;
0700                     ErrorFlag = 1;
0701                     <span class="keyword">break</span>;
0702                 <span class="keyword">end</span>
0703             <span class="keyword">end</span>
0704         <span class="keyword">end</span>
0705         <span class="keyword">if</span> ErrorFlag
0706             <span class="keyword">break</span>;
0707         <span class="keyword">end</span>
0708     <span class="keyword">end</span>
0709 <span class="keyword">end</span>
0710 
0711 <span class="comment">% Goal orbit from file</span>
0712 <span class="keyword">if</span> get(handles.RadioButton_File,<span class="string">'Value'</span>) == 1
0713     FileName = getappdata(handles.figure1, <span class="string">'FileName'</span>);
0714     OCS.GoalOrbit = [];
0715     <span class="keyword">for</span> i = 1:length(OCS.BPM)
0716         OCS.GoalOrbit{i} = <a href="getdata.html" class="code" title="function [S, FileName] = getdata(varargin)">getdata</a>(OCS.BPM{i}, FileName, <span class="string">'Numeric'</span>);
0717         <span class="keyword">if</span> any(isnan(OCS.GoalOrbit{i}))
0718             uiwait(warndlg({<span class="string">'BPMs not found in the file!'</span>,<span class="string">'Setting the goal orbit to the golden orbit.'</span>},<span class="string">'SETORBIT'</span>,<span class="string">'Modal'</span>));
0719             set(handles.RadioButton_Golden,<span class="string">'Value'</span>, 1)
0720             set(handles.RadioButton_Save,<span class="string">'Value'</span>, 0)
0721             OCS.GoalOrbit = <span class="string">'golden'</span>;
0722             <span class="keyword">break</span>;
0723         <span class="keyword">end</span>
0724     <span class="keyword">end</span>
0725 <span class="keyword">end</span>
0726 
0727 OCS.SVDIndex = str2num(get(handles.Edit_SVD,<span class="string">'String'</span>));
0728 
0729 
0730 <span class="comment">% Remove flags for now</span>
0731 <span class="keyword">if</span> isfield(OCS, <span class="string">'BPMWeight'</span>)
0732     OCS = rmfield(OCS, <span class="string">'BPMWeight'</span>);
0733 <span class="keyword">end</span>
0734 
0735 
0736 <span class="comment">% RF flag</span>
0737 <span class="keyword">if</span> get(handles.RadioButton_RF,<span class="string">'Value'</span>) == 1
0738     OCS.FitRF = 1;
0739 <span class="keyword">else</span>
0740     OCS.FitRF = 0;
0741 <span class="keyword">end</span>
0742 
0743 
0744 <span class="comment">% Update the BPM, CM, and RF</span>
0745 <span class="keyword">for</span> i = 1:length(OCS.BPM)
0746     OCS.BPM{i} = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(OCS.BPM{i});
0747 <span class="keyword">end</span>
0748 <span class="keyword">for</span> i = 1:length(OCS.CM)
0749     OCS.CM{i} = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(OCS.CM{i});
0750 <span class="keyword">end</span>
0751 OCS.RF = <a href="getrf.html" class="code" title="function [RFsp, RFam, DataTime, ErrorFlag] = getrf(varargin)">getrf</a>(<span class="string">'Struct'</span>);
0752 
0753 
0754 <span class="comment">% Iterations</span>
0755 NIter = get(handles.PopUpMenu_Iterations,<span class="string">'Value'</span>);
0756 <span class="keyword">if</span> NIter == 16
0757     NIter = Inf;
0758 <span class="keyword">end</span>
0759 OCS.NIter = NIter;
0760 
0761 
0762 <span class="comment">% Update plots</span>
0763 OCS.Handles.TimeStamp = handles.GetOrbit;
0764 setappdata(handles.figure1,<span class="string">'OCS'</span>,OCS);
0765 <a href="#_sub38" class="code" title="subfunction UpdatePlots(handles)">UpdatePlots</a>(handles);
0766 OCS = getappdata(handles.figure1, <span class="string">'OCS'</span>);
0767 
0768 set(handles.ApplyCorrection, <span class="string">'String'</span>, <span class="string">'Apply Correction'</span>);
0769 set(handles.GetOrbit,        <span class="string">'String'</span>, sprintf(<span class="string">'Get Orbit: %s'</span>,datestr(OCS.BPM{1}.TimeStamp,0)),<span class="string">'FontSize'</span>,9.0);
0770 set(handles.GetOrbit,         <span class="string">'Enable'</span>, <span class="string">'On'</span>);
0771 set(handles.MinimumPeriod,    <span class="string">'Enable'</span>, <span class="string">'On'</span>);
0772 set(handles.ApplyCorrection,  <span class="string">'Enable'</span>, <span class="string">'On'</span>);
0773 set(handles.SaveOrbit,        <span class="string">'Enable'</span>, <span class="string">'On'</span>);
0774 set(handles.RemoveCorrection, <span class="string">'Enable'</span>, RemoveCorrectionEnable);
0775 
0776 
0777 
0778 <span class="comment">% --------------------------------------------------------------------</span>
0779 <a name="_sub13" href="#_subfunctions" class="code">function StopCorrection_Callback(hObject, eventdata, handles)</a>
0780 <span class="comment">% Stop corrector goes to the matlab command window</span>
0781 RingSetOrbit.RunFlag = -1;
0782 setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
0783 
0784 
0785 <span class="comment">% --------------------------------------------------------------------</span>
0786 <a name="_sub14" href="#_subfunctions" class="code">function ApplyCorrection_Callback(hObject, eventdata, handles)</a>
0787 
0788 set(handles.figure1, <span class="string">'HandleVisibility'</span>,<span class="string">'Callback'</span>);
0789 
0790 
0791 RingSetOrbit.RunFlag = 1;
0792 setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
0793 
0794 OCS = getappdata(handles.figure1, <span class="string">'OCS'</span>);
0795 
0796 
0797 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0798 <span class="comment">% SaveOrbit the present setpoints %</span>
0799 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0800 CM = OCS.CM;
0801 CM{length(CM)+1} = OCS.RF;
0802 SP_History = getappdata(handles.figure1, <span class="string">'SP_History'</span>);
0803 SP_History{length(SP_History)+1} = CM;
0804 setappdata(handles.figure1, <span class="string">'SP_History'</span>, SP_History);
0805 set(handles.RemoveCorrection, <span class="string">'String'</span>, sprintf(<span class="string">'Remove Correction %d'</span>,length(SP_History)))
0806 
0807 
0808 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0809 <span class="comment">% Make the corrector starting with the present OCS setpoints %</span>
0810 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0811 set(handles.FileMenu,              <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0812 set(handles.EditBPMx,              <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0813 set(handles.EditBPMy,              <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0814 set(handles.EditHCM,               <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0815 set(handles.EditVCM,               <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0816 set(handles.LatticeMenu,           <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0817 set(handles.RadioButton_Golden,    <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0818 set(handles.RadioButton_Offset,    <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0819 set(handles.RadioButton_File,      <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0820 set(handles.RadioButton_Save,      <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0821 set(handles.GetFile,               <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0822 set(handles.SaveOrbit,             <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0823 set(handles.Edit_SVD,              <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0824 set(handles.HorizontalPlane,       <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0825 set(handles.VerticalPlane,         <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0826 set(handles.SelectBPMx,            <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0827 set(handles.SelectBPMy,            <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0828 set(handles.SelectHCM,             <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0829 set(handles.SelectVCM,             <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0830 set(handles.PopUpMenu_Iterations,  <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0831 set(handles.ScaleCorrectors,       <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0832 set(handles.GetOrbit,              <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0833 set(handles.RemoveCorrection,      <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0834 
0835 
0836 NIter = get(handles.PopUpMenu_Iterations,<span class="string">'Value'</span>);
0837 <span class="keyword">if</span> NIter == 16
0838     NIter = Inf;
0839 <span class="keyword">end</span>
0840 OCS.NIter = NIter;
0841 <span class="keyword">if</span> NIter &gt; 1
0842     set(handles.GetOrbit,         <span class="string">'String'</span>,  <span class="string">'GetOrbit'</span>);
0843     set(handles.ApplyCorrection,  <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0844     set(handles.ApplyCorrection,  <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
0845     set(handles.StopCorrection,   <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0846     set(handles.StopCorrection,   <span class="string">'Visible'</span>, <span class="string">'On'</span>);
0847 <span class="keyword">else</span>
0848     set(handles.ApplyCorrection,  <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0849 <span class="keyword">end</span>
0850 drawnow;
0851 
0852 
0853 <span class="comment">% MinimumPeriodString = get(handles.MinimumPeriod,'String');</span>
0854 <span class="comment">% if isempty(MinimumPeriodString)</span>
0855 <span class="comment">%     OCS.MinimumPeriod = [];</span>
0856 <span class="comment">% else</span>
0857 <span class="comment">%     OCS.MinimumPeriod = str2num(MinimumPeriodString);</span>
0858 <span class="comment">% end</span>
0859 <span class="comment">% if isempty(OCS.MinimumPeriod) || OCS.MinimumPeriod &lt; 0</span>
0860 <span class="comment">%     OCS.MinimumPeriod = 0;</span>
0861 <span class="comment">% end</span>
0862 
0863 
0864 AxesHandles = [handles.axes1;handles.axes2;handles.axes3;];
0865 <span class="keyword">if</span> strcmpi(get(handles.Plots0,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
0866     OCS = <a href="setorbit.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbit(varargin)">setorbit</a>(OCS, <span class="string">'NoGetPV'</span>, <span class="string">'NoDisplay'</span>);
0867 <span class="keyword">else</span>
0868     <span class="keyword">if</span> strcmpi(get(handles.Plots6,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
0869         <span class="comment">% Only update 6 plots if GetOrbit was not already called</span>
0870         <span class="keyword">if</span> isempty(findstr(get(get(handles.axes3,<span class="string">'YLabel'</span>),<span class="string">'String'</span>),<span class="string">'Residual'</span>))
0871             AxesHandles = [handles.axes1;handles.axes2;handles.axes3;handles.axes4;handles.axes5;handles.axes6;];
0872         <span class="keyword">end</span>
0873     <span class="keyword">end</span>
0874     OCS = <a href="setorbit.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbit(varargin)">setorbit</a>(OCS, <span class="string">'NoGetPV'</span>, <span class="string">'FigureHandles'</span>, AxesHandles);
0875 <span class="keyword">end</span>
0876 
0877 <span class="keyword">try</span>
0878     <span class="comment">% If the figure was closed then handles is on longer valie</span>
0879     setappdata(handles.figure1, <span class="string">'OCS'</span>, OCS);
0880 
0881 
0882     <span class="comment">%%%%%%%%%%%%%%%%%</span>
0883     <span class="comment">% Update figure %</span>
0884     <span class="comment">%%%%%%%%%%%%%%%%%</span>
0885     set(handles.FileMenu,              <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0886     set(handles.EditBPMx,              <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0887     set(handles.EditBPMy,              <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0888     set(handles.EditHCM,               <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0889     set(handles.EditVCM,               <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0890     set(handles.LatticeMenu,           <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0891     set(handles.RadioButton_Golden,    <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0892     set(handles.RadioButton_Offset,    <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0893     set(handles.RadioButton_File,      <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0894     set(handles.RadioButton_Save,      <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0895     set(handles.GetFile,               <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0896     set(handles.SaveOrbit,             <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0897     set(handles.Edit_SVD,              <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0898     set(handles.HorizontalPlane,       <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0899     set(handles.VerticalPlane,         <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0900     set(handles.SelectBPMx,            <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0901     set(handles.SelectBPMy,            <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0902     set(handles.SelectHCM,             <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0903     set(handles.SelectVCM,             <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0904     set(handles.PopUpMenu_Iterations,  <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0905     set(handles.ScaleCorrectors,       <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0906     set(handles.RemoveCorrection,      <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0907 
0908     set(handles.StopCorrection,   <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
0909     set(handles.StopCorrection,   <span class="string">'Enable'</span>,  <span class="string">'Off'</span>);
0910 
0911     set(handles.ApplyCorrection,  <span class="string">'Visible'</span>, <span class="string">'On'</span>);
0912     set(handles.ApplyCorrection,  <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0913 
0914     set(handles.GetOrbit,         <span class="string">'Enable'</span>,  <span class="string">'On'</span>);
0915     set(handles.GetOrbit,         <span class="string">'String'</span>, sprintf(<span class="string">'Get Orbit: %s'</span>,datestr(OCS.BPM{1}.TimeStamp,0)),<span class="string">'FontSize'</span>,9.0);
0916     drawnow;
0917 <span class="keyword">catch</span>
0918 <span class="keyword">end</span>
0919 
0920 
0921 set(handles.figure1, <span class="string">'HandleVisibility'</span>,<span class="string">'Off'</span>);
0922 
0923 
0924 
0925 <span class="comment">% --------------------------------------------------------------------</span>
0926 <a name="_sub15" href="#_subfunctions" class="code">function RemoveCorrection_Callback(hObject, eventdata, handles)</a>
0927 CM = getappdata(handles.figure1, <span class="string">'SP_History'</span>);
0928 <span class="keyword">if</span> ~isempty(CM)
0929 
0930     set(handles.GetOrbit,         <span class="string">'Enable'</span>, <span class="string">'Off'</span>);
0931     set(handles.ApplyCorrection,  <span class="string">'Enable'</span>, <span class="string">'Off'</span>);
0932     set(handles.RemoveCorrection, <span class="string">'Enable'</span>, <span class="string">'Off'</span>);
0933     drawnow;
0934 
0935     <span class="comment">% Set (note: RF could be one the CM structures)</span>
0936     CMlast = CM{end};
0937     <span class="keyword">for</span> i = 1:length(CMlast)
0938         <a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>(CMlast{i},  0);
0939     <span class="keyword">end</span>
0940     <span class="keyword">for</span> i = 1:length(CMlast)
0941         <a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>(CMlast{i}, -1);
0942     <span class="keyword">end</span>
0943     
0944     <span class="comment">% Remove the last set</span>
0945     CM(end) = [];
0946     setappdata(handles.figure1, <span class="string">'SP_History'</span>, CM);
0947 
0948     <span class="comment">% Get new BPM data and update plots</span>
0949     <a href="#_sub12" class="code" title="subfunction GetOrbit_Callback(hObject, eventdata, handles)">GetOrbit_Callback</a>(hObject, eventdata, handles);
0950 
0951     <span class="keyword">if</span> isempty(CM)
0952         set(handles.RemoveCorrection, <span class="string">'Enable'</span>, <span class="string">'Off'</span>);
0953         set(handles.RemoveCorrection, <span class="string">'String'</span>, <span class="string">'Remove Correction'</span>);
0954     <span class="keyword">else</span>
0955         set(handles.RemoveCorrection, <span class="string">'Enable'</span>, <span class="string">'On'</span>);
0956         set(handles.RemoveCorrection, <span class="string">'String'</span>, sprintf(<span class="string">'Remove Correction %d'</span>,length(CM)));
0957     <span class="keyword">end</span>
0958     drawnow;
0959 <span class="keyword">end</span>
0960 
0961 
0962 
0963 <span class="comment">% --------------------------------------------------------------------</span>
0964 <a name="_sub16" href="#_subfunctions" class="code">function GetFile_Callback(hObject, eventdata, handles)</a>
0965 
0966 DirectoryName = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Directory'</span>,<span class="string">'DataRoot'</span>);
0967 [FileName, DirectoryName] = uigetfile(<span class="string">'*.mat'</span>, <span class="string">'Select a File'</span>, DirectoryName);
0968 <span class="keyword">if</span> FileName == 0 
0969     <span class="keyword">return</span>
0970 <span class="keyword">end</span>
0971 setappdata(handles.figure1, <span class="string">'FileName'</span>, [DirectoryName FileName]);
0972 set(handles.GetFile, <span class="string">'String'</span>, sprintf(<span class="string">'File:%s'</span>, FileName), <span class="string">'FontSize'</span>, 8.0);
0973 set(handles.RadioButton_File,<span class="string">'Enable'</span>,<span class="string">'On'</span>);
0974 
0975 
0976 <span class="comment">% % Automatically set the filemenu radio button</span>
0977 <span class="comment">% set(handles.RadioButton_File,'Value', 1);</span>
0978 <span class="comment">% RadioButton_File_Callback(hObject, eventdata, handles);</span>
0979 
0980 
0981 <span class="comment">% --------------------------------------------------------------------</span>
0982 <a name="_sub17" href="#_subfunctions" class="code">function RadioButton_Offset_Callback(hObject, eventdata, handles)</a>
0983 set(handles.RadioButton_Golden,<span class="string">'Value'</span>, 0);
0984 set(handles.RadioButton_File,<span class="string">'Value'</span>, 0);
0985 set(handles.RadioButton_Save,<span class="string">'Value'</span>, 0);
0986 set(handles.RadioButton_Offset,<span class="string">'Value'</span>, 1);
0987 
0988 OCS = getappdata(handles.figure1, <span class="string">'OCS'</span>);
0989 <span class="keyword">if</span> ~isfield(OCS,<span class="string">'BPM'</span>)
0990     <span class="keyword">return</span>;
0991 <span class="keyword">end</span>
0992 OCS.GoalOrbit = <span class="string">'Offset'</span>;
0993 
0994 <span class="comment">% Update plots</span>
0995 setappdata(handles.figure1,<span class="string">'OCS'</span>,OCS);
0996 <a href="#_sub38" class="code" title="subfunction UpdatePlots(handles)">UpdatePlots</a>(handles);
0997 
0998 
0999 
1000 <span class="comment">% --------------------------------------------------------------------</span>
1001 <a name="_sub18" href="#_subfunctions" class="code">function RadioButton_Golden_Callback(hObject, eventdata, handles)</a>
1002 set(handles.RadioButton_Offset,<span class="string">'Value'</span>, 0);
1003 set(handles.RadioButton_File,<span class="string">'Value'</span>, 0);
1004 set(handles.RadioButton_Save,<span class="string">'Value'</span>, 0);
1005 set(handles.RadioButton_Golden,<span class="string">'Value'</span>, 1);
1006 
1007 OCS = getappdata(handles.figure1, <span class="string">'OCS'</span>);
1008 <span class="keyword">if</span> ~isfield(OCS,<span class="string">'BPM'</span>)
1009     <span class="keyword">return</span>;
1010 <span class="keyword">end</span>
1011 OCS.GoalOrbit = <span class="string">'Golden'</span>;
1012 
1013 <span class="comment">% Update plots</span>
1014 setappdata(handles.figure1,<span class="string">'OCS'</span>,OCS);
1015 <a href="#_sub38" class="code" title="subfunction UpdatePlots(handles)">UpdatePlots</a>(handles);
1016 
1017 
1018 
1019 <span class="comment">% --------------------------------------------------------------------</span>
1020 <a name="_sub19" href="#_subfunctions" class="code">function RadioButton_File_Callback(hObject, eventdata, handles)</a>
1021 set(handles.RadioButton_Offset,<span class="string">'Value'</span>, 0);
1022 set(handles.RadioButton_File,<span class="string">'Value'</span>, 1);
1023 set(handles.RadioButton_Save,<span class="string">'Value'</span>, 0);
1024 set(handles.RadioButton_Golden,<span class="string">'Value'</span>, 0);
1025 
1026 OCS = getappdata(handles.figure1,<span class="string">'OCS'</span>);
1027 <span class="keyword">if</span> ~isfield(OCS,<span class="string">'BPM'</span>)
1028     <span class="keyword">return</span>;
1029 <span class="keyword">end</span>
1030 FileName = getappdata(handles.figure1, <span class="string">'FileName'</span>);
1031 OCS.GoalOrbit = [];
1032 <span class="keyword">for</span> i = 1:length(OCS.BPM)
1033     OCS.GoalOrbit{i} = <a href="getdata.html" class="code" title="function [S, FileName] = getdata(varargin)">getdata</a>(OCS.BPM{i}, FileName, <span class="string">'Numeric'</span>);
1034     <span class="keyword">if</span> any(isnan(OCS.GoalOrbit{i}))
1035         uiwait(warndlg({<span class="string">'BPMs not found in the file!'</span>,<span class="string">'Setting the goal orbit to the golden orbit.'</span>},<span class="string">'SETORBIT'</span>,<span class="string">'Modal'</span>));
1036         set(handles.RadioButton_Golden,<span class="string">'Value'</span>, 1)
1037         set(handles.RadioButton_File,<span class="string">'Value'</span>, 0)
1038             OCS.GoalOrbit = <span class="string">'golden'</span>;
1039             <span class="keyword">break</span>;
1040     <span class="keyword">end</span>
1041 <span class="keyword">end</span>
1042 
1043 setappdata(handles.figure1,<span class="string">'OCS'</span>,OCS);
1044 
1045 <span class="comment">% Update plots</span>
1046 <a href="#_sub38" class="code" title="subfunction UpdatePlots(handles)">UpdatePlots</a>(handles);
1047 
1048 
1049 
1050 <span class="comment">% --------------------------------------------------------------------</span>
1051 <a name="_sub20" href="#_subfunctions" class="code">function RadioButton_Save_Callback(hObject, eventdata, handles)</a>
1052 set(handles.RadioButton_Golden,<span class="string">'Value'</span>, 0);           
1053 set(handles.RadioButton_File,<span class="string">'Value'</span>, 0);
1054 set(handles.RadioButton_Offset,<span class="string">'Value'</span>, 0);
1055 set(handles.RadioButton_Save,<span class="string">'Value'</span>, 1);
1056 
1057 OCS = getappdata(handles.figure1,<span class="string">'OCS'</span>);
1058 <span class="keyword">if</span> ~isfield(OCS,<span class="string">'BPM'</span>)
1059     <span class="keyword">return</span>;
1060 <span class="keyword">end</span>
1061 OCS.GoalOrbit = [];
1062 bpmsave = getappdata(handles.figure1,<span class="string">'bpmsave'</span>);
1063 ErrorFlag = 0;
1064 <span class="keyword">for</span> i = 1:length(OCS.BPM)
1065     <span class="keyword">for</span> j = 1:length(bpmsave)
1066         <span class="keyword">if</span> strcmp(OCS.BPM{i}.FamilyName, bpmsave{j}.FamilyName)
1067             [k, iNotFound] = findrowindex(OCS.BPM{i}.DeviceList, bpmsave{j}.DeviceList);
1068             <span class="keyword">if</span> isempty(iNotFound)
1069                 OCS.GoalOrbit{i} = bpmsave{j}.Data(k);
1070             <span class="keyword">else</span>
1071                 uiwait(warndlg({<span class="string">'BPMs not found in the save!'</span>,<span class="string">'Setting the goal orbit to the golden orbit.'</span>},<span class="string">'SETORBIT'</span>,<span class="string">'Modal'</span>));
1072                 set(handles.RadioButton_Golden,<span class="string">'Value'</span>, 1)
1073                 set(handles.RadioButton_Save,<span class="string">'Value'</span>, 0)
1074                 OCS.GoalOrbit = <span class="string">'golden'</span>;
1075                 ErrorFlag = 1;
1076                 <span class="keyword">break</span>;
1077             <span class="keyword">end</span>
1078         <span class="keyword">end</span>
1079     <span class="keyword">end</span>
1080     <span class="keyword">if</span> ErrorFlag
1081         <span class="keyword">break</span>;
1082     <span class="keyword">end</span>
1083 <span class="keyword">end</span>
1084 
1085 setappdata(handles.figure1,<span class="string">'OCS'</span>,OCS);
1086 
1087 <span class="comment">% Update plots</span>
1088 <a href="#_sub38" class="code" title="subfunction UpdatePlots(handles)">UpdatePlots</a>(handles);
1089 
1090 
1091 <span class="comment">% --------------------------------------------------------------------</span>
1092 <a name="_sub21" href="#_subfunctions" class="code">function SaveOrbit_Callback(hObject, eventdata, handles)</a>
1093 
1094 OCS = getappdata(handles.figure1, <span class="string">'OCS'</span>);
1095 set(handles.SaveOrbit,<span class="string">'String'</span>, sprintf(<span class="string">'Save: %s'</span>,datestr(OCS.CM{1}.TimeStamp,0)),<span class="string">'FontSize'</span>,9.0);
1096 bpmsave = OCS.BPM;
1097 setappdata(handles.figure1,<span class="string">'bpmsave'</span>,bpmsave);
1098 
1099 <span class="keyword">if</span> get(handles.RadioButton_Save,<span class="string">'Value'</span>) == 1                      
1100     <a href="#_sub20" class="code" title="subfunction RadioButton_Save_Callback(hObject, eventdata, handles)">RadioButton_Save_Callback</a>(hObject, eventdata, handles);                                                         
1101 <span class="keyword">end</span>                                                           
1102 set(handles.RadioButton_Save,<span class="string">'Enable'</span>,<span class="string">'On'</span>);
1103 <span class="comment">% set(handles.SaveOrbit,'Enable','Off');</span>
1104 
1105 <span class="comment">% % Automatically set the save radio button</span>
1106 <span class="comment">% set(handles.RadioButton_Save,'Value', 1);</span>
1107 <span class="comment">% RadioButton_Save_Callback(hObject, eventdata, handles);</span>
1108 
1109 
1110 
1111 <span class="comment">% --------------------------------------------------------------------</span>
1112 <a name="_sub22" href="#_subfunctions" class="code">function SaveOrbitToFile_Callback(hObject, eventdata, handles)</a>
1113 
1114 OCS = getappdata(handles.figure1, <span class="string">'OCS'</span>);
1115 BPMData = OCS.BPM;
1116 
1117 DirStart = pwd;
1118 FileName = appendtimestamp(<span class="string">'BPMData'</span>, BPMData{1}.TimeStamp);
1119 DirectoryName = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Directory'</span>, <span class="string">'DataRoot'</span>);
1120 [FileName, DirectoryName] = uiputfile(<span class="string">'*.mat'</span>, <span class="string">'Select File (Cancel to not save to a file)'</span>, [DirectoryName FileName, <span class="string">'.mat'</span>]);
1121 <span class="keyword">if</span> FileName == 0
1122     <span class="keyword">return</span>
1123 <span class="keyword">end</span>
1124 
1125 [DirectoryName, ErrorFlag] = gotodirectory(DirectoryName);
1126 save(FileName, <span class="string">'BPMData'</span>);
1127 cd(DirStart);
1128 fprintf(<span class="string">'   BPM data saved to %s\n'</span>, [DirectoryName FileName]);
1129 
1130 
1131 <span class="comment">% --------------------------------------------------------------------</span>
1132 <a name="_sub23" href="#_subfunctions" class="code">function SaveOCS_Callback(hObject, eventdata, handles)</a>
1133 OCS = getappdata(handles.figure1, <span class="string">'OCS'</span>);
1134 
1135 DirStart = pwd;
1136 FileName = appendtimestamp(<span class="string">'OCS'</span>, OCS.BPM{1}.TimeStamp);
1137 DirectoryName = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Directory'</span>, <span class="string">'DataRoot'</span>);
1138 [FileName, DirectoryName] = uiputfile(<span class="string">'*.mat'</span>, <span class="string">'Select File (Cancel to not save to a file)'</span>, [DirectoryName FileName, <span class="string">'.mat'</span>]);
1139 <span class="keyword">if</span> FileName == 0
1140     <span class="keyword">return</span>
1141 <span class="keyword">end</span>
1142 
1143 [DirectoryName, ErrorFlag] = gotodirectory(DirectoryName);
1144 save(FileName, <span class="string">'OCS'</span>);
1145 cd(DirStart);
1146 fprintf(<span class="string">'   OCS structure saved to %s\n'</span>, [DirectoryName FileName]);
1147 
1148 
1149 
1150 
1151 <span class="comment">%%%%%%%%%%%%%</span>
1152 <span class="comment">% Pop Plots %</span>
1153 <span class="comment">%%%%%%%%%%%%%</span>
1154 <a name="_sub24" href="#_subfunctions" class="code">function Graph_1_Callback(hObject, eventdata, handles)</a>
1155 a = figure;
1156 b = copyobj(handles.axes1, a); 
1157 set(b, <span class="string">'Position'</span>, [0.1300    0.1100    0.7750    .93*0.8150]);
1158 
1159 <a name="_sub25" href="#_subfunctions" class="code">function Graph_2_Callback(hObject, eventdata, handles)</a>
1160 a = figure;
1161 b = copyobj(handles.axes2, a); 
1162 set(b, <span class="string">'Position'</span>, [0.1300    0.1100    0.7750    0.8150]);
1163 
1164 <a name="_sub26" href="#_subfunctions" class="code">function Graph_3_Callback(hObject, eventdata, handles)</a>
1165 a = figure;
1166 b = copyobj(handles.axes3, a); 
1167 set(b, <span class="string">'Position'</span>, [0.1300    0.1100    0.7750    0.8150]);
1168 
1169 <a name="_sub27" href="#_subfunctions" class="code">function Graph_4_Callback(hObject, eventdata, handles)</a>
1170 a = figure;
1171 b = copyobj(handles.axes4, a); 
1172 set(b, <span class="string">'Position'</span>, [0.1300    0.1100    0.7750    .93*0.8150]);
1173 
1174 <a name="_sub28" href="#_subfunctions" class="code">function Graph_5_Callback(hObject, eventdata, handles)</a>
1175 a = figure;
1176 b = copyobj(handles.axes5, a); 
1177 set(b, <span class="string">'Position'</span>, [0.1300    0.1100    0.7750    0.8150]);
1178 
1179 <a name="_sub29" href="#_subfunctions" class="code">function Graph_6_Callback(hObject, eventdata, handles)</a>
1180 a = figure;
1181 b = copyobj(handles.axes6, a); 
1182 set(b, <span class="string">'Position'</span>, [0.1300    0.1100    0.7750    0.8150]);
1183 
1184 
1185 <a name="_sub30" href="#_subfunctions" class="code">function All_Graphs_Callback(hObject, eventdata, handles)</a>
1186 <span class="keyword">if</span> strcmpi(get(handles.Plots3,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
1187     a = figure;
1188     b = copyobj(handles.axes1, a);
1189     set(b, <span class="string">'Position'</span>, [0.1300    0.7093    0.7750    0.2157]);
1190 
1191     b = copyobj(handles.axes2, a);
1192     set(b, <span class="string">'Position'</span>, [0.1300    0.4096    0.7750    0.2157]);
1193 
1194     b = copyobj(handles.axes3, a);
1195     set(b, <span class="string">'Position'</span>, [0.1300    0.1100    0.7750    0.2157]);
1196     
1197     Data = getappdata(handles.figure1, <span class="string">'OCS'</span>);
1198     <span class="keyword">if</span> isfield(Data, <span class="string">'TimeStamp'</span>)
1199         addlabel(1,0,datestr(OCS.CM{1}.TimeStamp,21));
1200     <span class="keyword">end</span>
1201     orient tall
1202     
1203 <span class="keyword">elseif</span> strcmpi(get(handles.Plots6,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
1204     a = figure;
1205     b = copyobj(handles.axes1, a);
1206     set(b, <span class="string">'Position'</span>, [0.1300    0.7093    0.3347    0.2157]);
1207 
1208     b = copyobj(handles.axes2, a);
1209     set(b, <span class="string">'Position'</span>, [0.1300    0.4096    0.3347    0.2157]);
1210 
1211     b = copyobj(handles.axes3, a);
1212     set(b, <span class="string">'Position'</span>, [0.1300    0.1100    0.3347    0.2157]);
1213 
1214     b = copyobj(handles.axes4, a);
1215     set(b, <span class="string">'Position'</span>, [0.5703    0.7093    0.3347    0.2157]);
1216 
1217     b = copyobj(handles.axes5, a);
1218     set(b, <span class="string">'Position'</span>, [0.5703    0.4096    0.3347    0.2157]);
1219 
1220     b = copyobj(handles.axes6, a);
1221     set(b, <span class="string">'Position'</span>, [0.5703    0.1100    0.3347    0.2157]);
1222 
1223     Data = getappdata(handles.figure1, <span class="string">'OCS'</span>);
1224     <span class="keyword">if</span> isfield(Data, <span class="string">'TimeStamp'</span>)
1225         addlabel(1,0,datestr(OCS.CM{1}.TimeStamp,21));
1226     <span class="keyword">end</span>
1227     
1228     orient tall
1229 <span class="keyword">end</span>
1230 
1231 
1232 <span class="comment">% --------------------------------------------------------------------</span>
1233 <a name="_sub31" href="#_subfunctions" class="code">function Edit_SVD_Callback(hObject, eventdata, handles)</a>
1234 OCS = getappdata(handles.figure1,<span class="string">'OCS'</span>);
1235 
1236 a = get(handles.Edit_SVD,<span class="string">'String'</span>);
1237 <span class="keyword">if</span> isempty(a)
1238     OCS.SVDIndex = [];
1239 <span class="keyword">else</span>
1240     val = str2num(a);
1241     <span class="keyword">if</span> isempty(val) || val &lt; 0 || val == 0
1242         uiwait(warndlg({<span class="string">'Invalid Singular Value'</span>,<span class="string">'Setting the value to default'</span>},<span class="string">'SINGULAR VALUE'</span>,<span class="string">'Modal'</span>));
1243         OCS.SVDIndex = [];
1244         set(handles.Edit_SVD,<span class="string">'String'</span>,<span class="string">''</span>);
1245     <span class="keyword">elseif</span> val &lt; 1
1246         OCS.SVDIndex = val;
1247     <span class="keyword">else</span>
1248         val = ceil(val);
1249         set(handles.Edit_SVD,<span class="string">'String'</span>,num2str(val));
1250         OCS.SVDIndex = (1:val)';
1251     <span class="keyword">end</span>
1252 <span class="keyword">end</span>
1253 
1254 
1255 <span class="comment">% Update plots</span>
1256 <span class="keyword">if</span> ~isfield(OCS,<span class="string">'BPM'</span>)
1257     <span class="keyword">return</span>;
1258 <span class="keyword">end</span>
1259 setappdata(handles.figure1,<span class="string">'OCS'</span>,OCS);
1260 <a href="#_sub38" class="code" title="subfunction UpdatePlots(handles)">UpdatePlots</a>(handles);
1261 
1262 
1263 <span class="comment">% --------------------------------------------------------------------</span>
1264 <a name="_sub32" href="#_subfunctions" class="code">function RadioButton_RF_Callback(hObject, eventdata, handles)</a>
1265 
1266 RingSetOrbit = getappdata(0, <span class="string">'RingSetOrbit'</span>);
1267 
1268 <span class="keyword">if</span> isfield(RingSetOrbit,<span class="string">'RunFlag'</span>) &amp;&amp; RingSetOrbit.RunFlag == 1
1269 
1270     <span class="comment">% Orbit correction is running.  Request an RF change.</span>
1271     <span class="keyword">if</span> get(handles.RadioButton_RF,<span class="string">'Value'</span>) == 1
1272         RingSetOrbit.FitRF = 1;
1273     <span class="keyword">else</span>
1274         RingSetOrbit.FitRF = 0;
1275     <span class="keyword">end</span>
1276     setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
1277 
1278 <span class="keyword">else</span>
1279 
1280     OCS = getappdata(handles.figure1, <span class="string">'OCS'</span>);
1281 
1282     <span class="comment">% Save the starting RF frequency</span>
1283     OCS.RF = <a href="getrf.html" class="code" title="function [RFsp, RFam, DataTime, ErrorFlag] = getrf(varargin)">getrf</a>(<span class="string">'Struct'</span>);
1284 
1285     <span class="keyword">if</span> ~isfield(OCS,<span class="string">'BPM'</span>)
1286         <span class="keyword">return</span>;
1287     <span class="keyword">end</span>
1288     <span class="keyword">if</span> get(handles.RadioButton_RF,<span class="string">'Value'</span>) == 1
1289         OCS.FitRF = 1;
1290     <span class="keyword">else</span>
1291         OCS.FitRF = 0;
1292     <span class="keyword">end</span>
1293     setappdata(handles.figure1,<span class="string">'OCS'</span>,OCS);
1294 
1295     <span class="comment">% Update plots</span>
1296     <a href="#_sub37" class="code" title="subfunction FigResize_Callback(hObject, eventdata, handles)">FigResize_Callback</a>(hObject, eventdata, handles);
1297     <a href="#_sub38" class="code" title="subfunction UpdatePlots(handles)">UpdatePlots</a>(handles);
1298 <span class="keyword">end</span>
1299 
1300 
1301 
1302 <span class="comment">% --------------------------------------------------------------------</span>
1303 <a name="_sub33" href="#_subfunctions" class="code">function Print_Callback(hObject, eventdata, handles)</a>
1304 
1305 printdlg(handles.figure1)
1306 
1307 
1308 
1309 
1310 <span class="comment">% --------------------------------------------------------------------</span>
1311 <a name="_sub34" href="#_subfunctions" class="code">function Plots0_Callback(hObject, eventdata, handles)</a>
1312 
1313 <span class="keyword">if</span> strcmpi(get(handles.Plots0,<span class="string">'Checked'</span>),<span class="string">'Off'</span>)
1314     <span class="comment">% Set the menus and graphs</span>
1315     set(handles.Plots0, <span class="string">'Checked'</span>, <span class="string">'On'</span>);
1316     set(handles.Plots3, <span class="string">'Checked'</span>, <span class="string">'Off'</span>);
1317     set(handles.Plots6, <span class="string">'Checked'</span>, <span class="string">'Off'</span>);
1318     set(handles.Graph_1, <span class="string">'Enable'</span>, <span class="string">'Off'</span>);
1319     set(handles.Graph_2, <span class="string">'Enable'</span>, <span class="string">'Off'</span>);
1320     set(handles.Graph_3, <span class="string">'Enable'</span>, <span class="string">'Off'</span>);
1321     set(handles.Graph_4, <span class="string">'Enable'</span>, <span class="string">'Off'</span>);
1322     set(handles.Graph_5, <span class="string">'Enable'</span>, <span class="string">'Off'</span>);
1323     set(handles.Graph_6, <span class="string">'Enable'</span>, <span class="string">'Off'</span>);
1324 
1325     <span class="comment">% Save the figure width</span>
1326     set(handles.figure1, <span class="string">'Units'</span>, <span class="string">'Characters'</span>);
1327     Pcharacters = get(handles.figure1, <span class="string">'Position'</span>);
1328     setappdata(handles.figure1, <span class="string">'FigurePosition'</span>, Pcharacters);
1329 
1330     <span class="comment">% Get the goal orbit panal position</span>
1331     set(handles.figure1, <span class="string">'Units'</span>, <span class="string">'Characters'</span>);
1332     Pcharacters = get(handles.figure1, <span class="string">'Position'</span>);
1333 
1334     <span class="comment">% Change the figure size</span>
1335     Units = get(handles.PanelGoalOrbit, <span class="string">'Units'</span>);
1336     set(handles.PanelGoalOrbit, <span class="string">'Units'</span>, <span class="string">'Characters'</span>);
1337     pPanal = get(handles.PanelGoalOrbit, <span class="string">'Position'</span>);
1338     set(handles.PanelGoalOrbit, <span class="string">'Units'</span>, Units);
1339 
1340     <span class="comment">% This also forces a FigResize_Callback</span>
1341     set(handles.figure1, <span class="string">'Units'</span>, <span class="string">'Characters'</span>);
1342     set(handles.figure1, <span class="string">'Position'</span>, [Pcharacters(1) Pcharacters(2) 2*pPanal(1)+pPanal(3) Pcharacters(4)]);set(handles.PanelGoalOrbit, <span class="string">'Units'</span>, Units);
1343 
1344     <span class="comment">% Figure resize off</span>
1345     set(handles.figure1, <span class="string">'Resize'</span>, <span class="string">'Off'</span>);
1346     
1347     RingSetOrbit = getappdata(0, <span class="string">'RingSetOrbit'</span>);
1348     <span class="keyword">if</span> isfield(RingSetOrbit,<span class="string">'RunFlag'</span>) &amp;&amp; RingSetOrbit.RunFlag == 1
1349         <span class="comment">% If orbit correction is running, change the display</span>
1350         RingSetOrbit.Display = 0;
1351         setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
1352     <span class="keyword">end</span>
1353 
1354     <span class="comment">%OCS = getappdata(handles.figure1, 'OCS');</span>
1355     <span class="comment">%if isfield(OCS, 'BPM')</span>
1356     <span class="comment">%    UpdatePlots(handles);</span>
1357     <span class="comment">%end</span>
1358 <span class="keyword">end</span>
1359 
1360 
1361 
1362 
1363 <span class="comment">% --------------------------------------------------------------------</span>
1364 <a name="_sub35" href="#_subfunctions" class="code">function Plots3_Callback(hObject, eventdata, handles)</a>
1365 
1366 <span class="keyword">if</span> strcmpi(get(handles.Plots3,<span class="string">'Checked'</span>),<span class="string">'Off'</span>)
1367     <span class="keyword">if</span> strcmpi(get(handles.Plots0,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
1368         ChangeWidthFlag = 1;
1369     <span class="keyword">else</span>
1370         ChangeWidthFlag = 0;
1371     <span class="keyword">end</span>
1372     
1373     set(handles.Plots0, <span class="string">'Checked'</span>, <span class="string">'Off'</span>);
1374     set(handles.Plots3, <span class="string">'Checked'</span>, <span class="string">'On'</span>);
1375     set(handles.Plots6, <span class="string">'Checked'</span>, <span class="string">'Off'</span>);
1376     set(handles.Graph_1, <span class="string">'Enable'</span>, <span class="string">'On'</span>);
1377     set(handles.Graph_2, <span class="string">'Enable'</span>, <span class="string">'On'</span>);
1378     set(handles.Graph_3, <span class="string">'Enable'</span>, <span class="string">'On'</span>);
1379     set(handles.Graph_4, <span class="string">'Enable'</span>, <span class="string">'Off'</span>);
1380     set(handles.Graph_5, <span class="string">'Enable'</span>, <span class="string">'Off'</span>);
1381     set(handles.Graph_6, <span class="string">'Enable'</span>, <span class="string">'Off'</span>);
1382 
1383     <span class="keyword">if</span> ChangeWidthFlag
1384         <span class="comment">% This also forces a FigResize_Callback</span>
1385         FigurePositionOld = getappdata(handles.figure1, <span class="string">'FigurePosition'</span>);
1386         set(handles.figure1, <span class="string">'Units'</span>, <span class="string">'Characters'</span>);
1387         Pcharacters = get(handles.figure1, <span class="string">'Position'</span>);
1388         set(handles.figure1, <span class="string">'Position'</span>, [Pcharacters(1) Pcharacters(2) FigurePositionOld(3) Pcharacters(4)]);
1389     <span class="keyword">else</span>
1390         <a href="#_sub37" class="code" title="subfunction FigResize_Callback(hObject, eventdata, handles)">FigResize_Callback</a>(hObject, eventdata, handles);
1391     <span class="keyword">end</span>
1392     
1393     <span class="comment">% Figure resize on</span>
1394     set(handles.figure1, <span class="string">'Resize'</span>, <span class="string">'On'</span>);
1395 
1396     RingSetOrbit = getappdata(0, <span class="string">'RingSetOrbit'</span>);
1397     <span class="keyword">if</span> isfield(RingSetOrbit,<span class="string">'RunFlag'</span>) &amp;&amp; RingSetOrbit.RunFlag == 1
1398         <span class="comment">% If orbit correction is running, ask setorbit to change the display</span>
1399         RingSetOrbit.Display = 1;
1400         RingSetOrbit.FigureHandles = [handles.axes1; handles.axes2; handles.axes3;];
1401         setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
1402     <span class="keyword">else</span>
1403         <span class="comment">% Update plots</span>
1404         OCS = getappdata(handles.figure1, <span class="string">'OCS'</span>);
1405         <span class="keyword">if</span> isfield(OCS, <span class="string">'BPM'</span>)
1406             <a href="#_sub38" class="code" title="subfunction UpdatePlots(handles)">UpdatePlots</a>(handles);
1407         <span class="keyword">end</span>
1408     <span class="keyword">end</span>
1409 <span class="keyword">end</span>
1410 
1411 
1412 <span class="comment">% --------------------------------------------------------------------</span>
1413 <a name="_sub36" href="#_subfunctions" class="code">function Plots6_Callback(hObject, eventdata, handles)</a>
1414 
1415 <span class="keyword">if</span> strcmpi(get(handles.Plots6,<span class="string">'Checked'</span>),<span class="string">'Off'</span>)
1416     <span class="keyword">if</span> strcmpi(get(handles.Plots0,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
1417         ChangeWidthFlag = 1;
1418     <span class="keyword">else</span>
1419         ChangeWidthFlag = 0;
1420     <span class="keyword">end</span>
1421     
1422     set(handles.Plots0, <span class="string">'Checked'</span>, <span class="string">'Off'</span>);
1423     set(handles.Plots3, <span class="string">'Checked'</span>, <span class="string">'Off'</span>);
1424     set(handles.Plots6, <span class="string">'Checked'</span>, <span class="string">'On'</span>);
1425     set(handles.Graph_1, <span class="string">'Enable'</span>, <span class="string">'On'</span>);
1426     set(handles.Graph_2, <span class="string">'Enable'</span>, <span class="string">'On'</span>);
1427     set(handles.Graph_3, <span class="string">'Enable'</span>, <span class="string">'On'</span>);
1428     set(handles.Graph_4, <span class="string">'Enable'</span>, <span class="string">'On'</span>);
1429     set(handles.Graph_5, <span class="string">'Enable'</span>, <span class="string">'On'</span>);
1430     set(handles.Graph_6, <span class="string">'Enable'</span>, <span class="string">'On'</span>);
1431 
1432     <span class="keyword">if</span> ChangeWidthFlag
1433         <span class="comment">% This also forces a FigResize_Callback</span>
1434         FigurePositionOld = getappdata(handles.figure1, <span class="string">'FigurePosition'</span>);
1435         set(handles.figure1, <span class="string">'Units'</span>, <span class="string">'Characters'</span>);
1436         Pcharacters = get(handles.figure1, <span class="string">'Position'</span>);
1437         set(handles.figure1, <span class="string">'Position'</span>, [Pcharacters(1) Pcharacters(2) FigurePositionOld(3) Pcharacters(4)]);
1438     <span class="keyword">else</span>
1439         <a href="#_sub37" class="code" title="subfunction FigResize_Callback(hObject, eventdata, handles)">FigResize_Callback</a>(hObject, eventdata, handles);
1440     <span class="keyword">end</span>
1441 
1442     <span class="comment">% Figure resize on</span>
1443     set(handles.figure1, <span class="string">'Resize'</span>, <span class="string">'On'</span>);
1444 
1445     RingSetOrbit = getappdata(0, <span class="string">'RingSetOrbit'</span>);
1446     <span class="keyword">if</span> isfield(RingSetOrbit,<span class="string">'RunFlag'</span>) &amp;&amp; RingSetOrbit.RunFlag == 1
1447         <span class="comment">% If orbit correction is running, ask setorbit to change the display</span>
1448         RingSetOrbit.Display = 1;
1449         RingSetOrbit.FigureHandles = [handles.axes1; handles.axes2; handles.axes3; handles.axes4; handles.axes5; handles.axes6;];
1450         setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
1451     <span class="keyword">else</span>
1452         <span class="comment">% Update plots</span>
1453         OCS = getappdata(handles.figure1, <span class="string">'OCS'</span>);
1454         <span class="keyword">if</span> isfield(OCS, <span class="string">'BPM'</span>)
1455             <a href="#_sub38" class="code" title="subfunction UpdatePlots(handles)">UpdatePlots</a>(handles);
1456         <span class="keyword">end</span>
1457     <span class="keyword">end</span>
1458 <span class="keyword">end</span>
1459         
1460 
1461 <span class="comment">% --------------------------------------------------------------------</span>
1462 <a name="_sub37" href="#_subfunctions" class="code">function FigResize_Callback(hObject, eventdata, handles)</a>
1463 
1464 <span class="keyword">if</span> ~isempty(handles)
1465     <span class="comment">% Minimum figure width</span>
1466     <span class="keyword">if</span> ~strcmpi(get(handles.Plots0, <span class="string">'Checked'</span>), <span class="string">'On'</span>)
1467         FigureMinWidth = 130;
1468         set(handles.figure1, <span class="string">'Units'</span>, <span class="string">'Characters'</span>);
1469         Pcharacters = get(handles.figure1,<span class="string">'Position'</span>);
1470         <span class="keyword">if</span> Pcharacters(3) &lt; FigureMinWidth
1471             set(handles.figure1, <span class="string">'Position'</span>, [Pcharacters(1) Pcharacters(2) FigureMinWidth Pcharacters(4)]);
1472         <span class="keyword">end</span>
1473     <span class="keyword">end</span>
1474 
1475     set(handles.axes1, <span class="string">'Units'</span>, <span class="string">'Normalized'</span>);
1476     set(handles.axes2, <span class="string">'Units'</span>, <span class="string">'Normalized'</span>);
1477     set(handles.axes3, <span class="string">'Units'</span>, <span class="string">'Normalized'</span>);
1478     set(handles.axes4, <span class="string">'Units'</span>, <span class="string">'Normalized'</span>);
1479     set(handles.axes5, <span class="string">'Units'</span>, <span class="string">'Normalized'</span>);
1480     set(handles.axes6, <span class="string">'Units'</span>, <span class="string">'Normalized'</span>);
1481     
1482     set(handles.figure1, <span class="string">'Units'</span>, <span class="string">'Normalized'</span>);
1483     P = get(handles.figure1,<span class="string">'Position'</span>);
1484 
1485     Units = get(handles.PanelGoalOrbit, <span class="string">'Units'</span>);
1486     set(handles.PanelGoalOrbit, <span class="string">'Units'</span>, <span class="string">'Normalized'</span>);
1487     pPanal = get(handles.PanelGoalOrbit, <span class="string">'Position'</span>);
1488     set(handles.PanelGoalOrbit, <span class="string">'Units'</span>, Units);
1489 
1490     Width = 1 - (pPanal(1) + pPanal(3));    
1491     
1492     XBuffer1 = .075;
1493     
1494     
1495     <span class="keyword">if</span> strcmpi(get(handles.Plots0,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
1496 
1497         <span class="comment">% No plots</span>
1498         set(handles.Graph_1, <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1499         set(handles.Graph_2, <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1500         set(handles.Graph_2, <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1501         set(handles.Graph_4, <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1502         set(handles.Graph_5, <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1503         set(handles.Graph_6, <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1504         
1505         set(handles.axes1,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1506         h = get(handles.axes1,<span class="string">'Children'</span>);
1507         <span class="keyword">for</span> i = 1:length(h)
1508             set(h(i), <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1509         <span class="keyword">end</span>
1510 
1511         set(handles.axes2,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1512         h = get(handles.axes2,<span class="string">'Children'</span>);
1513         <span class="keyword">for</span> i = 1:length(h)
1514             set(h(i), <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1515         <span class="keyword">end</span>
1516 
1517         set(handles.axes3,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1518         h = get(handles.axes3,<span class="string">'Children'</span>);
1519         <span class="keyword">for</span> i = 1:length(h)
1520             set(h(i), <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1521         <span class="keyword">end</span>
1522 
1523         set(handles.axes4,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1524         h = get(handles.axes4,<span class="string">'Children'</span>);
1525         <span class="keyword">for</span> i = 1:length(h)
1526             set(h(i), <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1527         <span class="keyword">end</span>
1528 
1529         set(handles.axes5,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1530         h = get(handles.axes5,<span class="string">'Children'</span>);
1531         <span class="keyword">for</span> i = 1:length(h)
1532             set(h(i), <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1533         <span class="keyword">end</span>
1534 
1535         set(handles.axes6,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1536         h = get(handles.axes6,<span class="string">'Children'</span>);
1537         <span class="keyword">for</span> i = 1:length(h)
1538             set(h(i), <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1539         <span class="keyword">end</span>
1540        
1541         <span class="comment">% Legends</span>
1542         h = findobj(handles.figure1,<span class="string">'tag'</span>,<span class="string">'legend'</span>);
1543         <span class="keyword">for</span> i = 1:length(h)
1544             set(h(i), <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1545         <span class="keyword">end</span>
1546     
1547     <span class="keyword">elseif</span> strcmpi(get(handles.Plots6,<span class="string">'Checked'</span>),<span class="string">'On'</span>)
1548 
1549         <span class="comment">% Find the RF plot if it exists</span>
1550         <span class="keyword">if</span> get(handles.RadioButton_RF,<span class="string">'Value'</span>) == 1
1551             XBuffer2 = .05;
1552         <span class="keyword">else</span>
1553             XBuffer2 = .02;
1554         <span class="keyword">end</span>
1555 
1556         <span class="comment">% Find the RF plot if it exists</span>
1557         hyy = [];
1558         <span class="keyword">if</span> get(handles.RadioButton_RF,<span class="string">'Value'</span>) == 1
1559             h = get(handles.figure1,<span class="string">'children'</span>);
1560 
1561             <span class="keyword">for</span> i = 1:length(h);
1562                 <span class="keyword">try</span>
1563                     <span class="keyword">if</span> findstr(get(get(h(i),<span class="string">'ylabel'</span>),<span class="string">'string'</span>),<span class="string">'RF'</span>);
1564                         hyy = h(i);
1565                         <span class="keyword">break</span>;
1566                     <span class="keyword">end</span>
1567                 <span class="keyword">catch</span>
1568                 <span class="keyword">end</span>
1569             <span class="keyword">end</span>
1570         <span class="keyword">end</span>
1571 
1572         <span class="keyword">if</span> (Width/2-XBuffer1-XBuffer2) &lt; 0
1573             <span class="keyword">return</span>;
1574         <span class="keyword">end</span>
1575 
1576         a = [pPanal(1)+pPanal(3)+XBuffer1                    .075 (Width/2-XBuffer1-XBuffer2/2) .25];
1577         set(handles.axes1, <span class="string">'Position'</span>, a + [0 .6 0 0]);
1578         set(handles.axes2, <span class="string">'Position'</span>, a + [0 .3 0 0]);
1579         set(handles.axes3, <span class="string">'Position'</span>, a);
1580 
1581         a = [pPanal(1)+pPanal(3)+XBuffer1+Width/2-XBuffer2/2 .075 (Width/2-XBuffer1-XBuffer2/2) .25];
1582         set(handles.axes4, <span class="string">'Position'</span>, a + [0 .6 0 0]);
1583         set(handles.axes5, <span class="string">'Position'</span>, a + [0 .3 0 0]);
1584         set(handles.axes6, <span class="string">'Position'</span>, a);
1585 
1586         <span class="keyword">if</span> ~isempty(hyy)
1587             set(hyy, <span class="string">'Position'</span>, a + [0 .6 0 0]);
1588         <span class="keyword">end</span>
1589         
1590         set(handles.Graph_1, <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1591         set(handles.Graph_2, <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1592         set(handles.Graph_2, <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1593         set(handles.Graph_4, <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1594         set(handles.Graph_5, <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1595         set(handles.Graph_6, <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1596 
1597         set(handles.axes1,<span class="string">'Visible'</span>,<span class="string">'On'</span>);
1598         h = get(handles.axes1,<span class="string">'Children'</span>);
1599         <span class="keyword">for</span> i = 1:length(h)
1600             set(h(i), <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1601         <span class="keyword">end</span>
1602 
1603         set(handles.axes2,<span class="string">'Visible'</span>,<span class="string">'On'</span>);
1604         h = get(handles.axes2,<span class="string">'Children'</span>);
1605         <span class="keyword">for</span> i = 1:length(h)
1606             set(h(i), <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1607         <span class="keyword">end</span>
1608 
1609         set(handles.axes3,<span class="string">'Visible'</span>,<span class="string">'On'</span>);
1610         h = get(handles.axes3,<span class="string">'Children'</span>);
1611         <span class="keyword">for</span> i = 1:length(h)
1612             set(h(i), <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1613         <span class="keyword">end</span>
1614 
1615         set(handles.axes4,<span class="string">'Visible'</span>,<span class="string">'On'</span>);
1616         h = get(handles.axes4,<span class="string">'Children'</span>);
1617         <span class="keyword">for</span> i = 1:length(h)
1618             set(h(i), <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1619         <span class="keyword">end</span>
1620 
1621         set(handles.axes5,<span class="string">'Visible'</span>,<span class="string">'On'</span>);
1622         h = get(handles.axes5,<span class="string">'Children'</span>);
1623         <span class="keyword">for</span> i = 1:length(h)
1624             set(h(i), <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1625         <span class="keyword">end</span>
1626 
1627         set(handles.axes6,<span class="string">'Visible'</span>,<span class="string">'On'</span>);
1628         h = get(handles.axes6,<span class="string">'Children'</span>);
1629         <span class="keyword">for</span> i = 1:length(h)
1630             set(h(i), <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1631         <span class="keyword">end</span>
1632 
1633        
1634         <span class="comment">% Legends</span>
1635         h = findobj(handles.figure1,<span class="string">'tag'</span>,<span class="string">'legend'</span>);
1636         <span class="keyword">for</span> i = 1:length(h)
1637             set(h(i), <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1638         <span class="keyword">end</span>
1639 
1640     <span class="keyword">else</span>
1641 
1642         <span class="comment">% 3 Plots</span>
1643         XBuffer2 = .02;
1644 
1645         set(handles.Graph_1, <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1646         set(handles.Graph_2, <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1647         set(handles.Graph_2, <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1648         set(handles.Graph_4, <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1649         set(handles.Graph_5, <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1650         set(handles.Graph_6, <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1651         
1652         set(handles.axes1,<span class="string">'Visible'</span>,<span class="string">'On'</span>);
1653         h = get(handles.axes1,<span class="string">'Children'</span>);
1654         <span class="keyword">for</span> i = 1:length(h)
1655             set(h(i), <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1656         <span class="keyword">end</span>
1657 
1658         set(handles.axes2,<span class="string">'Visible'</span>,<span class="string">'On'</span>);
1659         h = get(handles.axes2,<span class="string">'Children'</span>);
1660         <span class="keyword">for</span> i = 1:length(h)
1661             set(h(i), <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1662         <span class="keyword">end</span>
1663 
1664         set(handles.axes3,<span class="string">'Visible'</span>,<span class="string">'On'</span>);
1665         h = get(handles.axes3,<span class="string">'Children'</span>);
1666         <span class="keyword">for</span> i = 1:length(h)
1667             set(h(i), <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1668         <span class="keyword">end</span>
1669 
1670         set(handles.axes4,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1671         h = get(handles.axes4,<span class="string">'Children'</span>);
1672         <span class="keyword">for</span> i = 1:length(h)
1673             set(h(i), <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1674         <span class="keyword">end</span>
1675 
1676         set(handles.axes5,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1677         h = get(handles.axes5,<span class="string">'Children'</span>);
1678         <span class="keyword">for</span> i = 1:length(h)
1679             set(h(i), <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1680         <span class="keyword">end</span>
1681 
1682         set(handles.axes6,<span class="string">'Visible'</span>,<span class="string">'Off'</span>);
1683         h = get(handles.axes6,<span class="string">'Children'</span>);
1684         <span class="keyword">for</span> i = 1:length(h)
1685             set(h(i), <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1686         <span class="keyword">end</span>
1687 
1688 
1689         <span class="comment">% Legends</span>
1690         h = findobj(handles.figure1,<span class="string">'tag'</span>,<span class="string">'legend'</span>);
1691         <span class="keyword">for</span> i = 1:length(h)
1692             UserData = get(h(i),<span class="string">'UserData'</span>);
1693             <span class="keyword">if</span> isstruct(UserData)
1694                 <span class="keyword">if</span> any(strcmpi(UserData, {<span class="string">'Axes1'</span>,<span class="string">'Axes2'</span>,<span class="string">'Axes3'</span>}))
1695                     set(h(i), <span class="string">'Visible'</span>, <span class="string">'On'</span>);
1696                 <span class="keyword">else</span>
1697                     set(h(i), <span class="string">'Visible'</span>, <span class="string">'Off'</span>);
1698                 <span class="keyword">end</span>
1699             <span class="keyword">end</span>
1700         <span class="keyword">end</span>
1701 
1702 
1703         <span class="keyword">if</span> (Width-XBuffer1-XBuffer2) &lt; 0
1704             <span class="keyword">return</span>;
1705         <span class="keyword">end</span>
1706         a = [pPanal(1)+pPanal(3)+XBuffer1 .075 (Width-XBuffer1-XBuffer2) .25];
1707         set(handles.axes1, <span class="string">'Position'</span>, a + [0 .6 0 0]);
1708         set(handles.axes2, <span class="string">'Position'</span>, a + [0 .3 0 0]);
1709         set(handles.axes3, <span class="string">'Position'</span>, a);
1710     <span class="keyword">end</span>
1711 <span class="keyword">end</span>
1712 
1713 drawnow;
1714 
1715 <span class="comment">%cla(handles.axes4, 'reset');</span>
1716 <span class="comment">%cla(handles.axes5, 'reset');</span>
1717 <span class="comment">%cla(handles.axes6, 'reset');</span>
1718 
1719      
1720 
1721 <span class="comment">% --------------------------------------------------------------------</span>
1722 <a name="_sub38" href="#_subfunctions" class="code">function UpdatePlots(handles)</a>
1723 
1724 set(handles.figure1, <span class="string">'HandleVisibility'</span>,<span class="string">'On'</span>);
1725 
1726 OCS = getappdata(handles.figure1,<span class="string">'OCS'</span>);
1727 
1728 <span class="keyword">if</span> strcmpi(get(handles.Plots6,<span class="string">'Checked'</span>), <span class="string">'On'</span>)
1729     OCS = <a href="setorbit.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbit(varargin)">setorbit</a>(OCS, <span class="string">'NoSetSP'</span>, <span class="string">'NoGetPV'</span>, <span class="string">'FigureHandles'</span>, [handles.axes1;handles.axes2;handles.axes3;handles.axes4;handles.axes5;handles.axes6;]);
1730 <span class="keyword">elseif</span> strcmpi(get(handles.Plots3,<span class="string">'Checked'</span>), <span class="string">'On'</span>)
1731     OCS = <a href="setorbit.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbit(varargin)">setorbit</a>(OCS, <span class="string">'NoSetSP'</span>, <span class="string">'NoGetPV'</span>, <span class="string">'FigureHandles'</span>, [handles.axes1;handles.axes2;handles.axes3;]);
1732 <span class="keyword">elseif</span> strcmpi(get(handles.Plots0,<span class="string">'Checked'</span>), <span class="string">'On'</span>)
1733     OCS = <a href="setorbit.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbit(varargin)">setorbit</a>(OCS, <span class="string">'NoSetSP'</span>, <span class="string">'NoGetPV'</span>, <span class="string">'NoDisplay'</span>, <span class="string">'FigureHandles'</span>, [handles.axes1;handles.axes2;handles.axes3;]);
1734 <span class="keyword">end</span>
1735 
1736 setappdata(handles.figure1,<span class="string">'OCS'</span>,OCS);
1737 
1738 set(handles.figure1, <span class="string">'HandleVisibility'</span>,<span class="string">'Off'</span>);
1739 
1740 
1741 
1742 <span class="comment">% --------------------------------------------------------------------</span>
1743 <a name="_sub39" href="#_subfunctions" class="code">function MinimumPeriod_Callback(hObject, eventdata, handles)</a>
1744 
1745 MinimumPeriodString = get(handles.MinimumPeriod, <span class="string">'String'</span>);
1746 <span class="keyword">if</span> isempty(MinimumPeriodString)
1747     MinimumPeriod = [];
1748 <span class="keyword">else</span>
1749     MinimumPeriod = str2num(MinimumPeriodString);
1750     <span class="keyword">if</span> MinimumPeriod &lt; 0
1751         MinimumPeriod = 0;
1752     <span class="keyword">end</span>
1753 <span class="keyword">end</span>
1754 set(handles.MinimumPeriod, <span class="string">'String'</span>, num2str(MinimumPeriod));
1755 
1756 
1757 RingSetOrbit = getappdata(0, <span class="string">'RingSetOrbit'</span>);
1758 <span class="keyword">if</span> isfield(RingSetOrbit,<span class="string">'RunFlag'</span>) &amp;&amp; RingSetOrbit.RunFlag == 1
1759     <span class="comment">% Orbit correction is running.  Request an MinimumPeriod change.</span>
1760     RingSetOrbit.MinimumPeriod = MinimumPeriod;
1761     setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
1762 <span class="keyword">else</span>
1763     OCS = getappdata(handles.figure1, <span class="string">'OCS'</span>);
1764     OCS.MinimumPeriod = MinimumPeriod;
1765     setappdata(handles.figure1, <span class="string">'OCS'</span>, OCS);
1766 <span class="keyword">end</span>
1767 
1768 
1769 
1770 <span class="comment">% --------------------------------------------------------------------</span>
1771 <a name="_sub40" href="#_subfunctions" class="code">function CorrectorGain_Callback(hObject, eventdata, handles)</a>
1772 
1773 CorrectorGain = str2num(get(handles.CorrectorGain,<span class="string">'String'</span>));
1774 <span class="keyword">if</span> isnumeric(CorrectorGain) &amp;&amp; length(CorrectorGain)==1 &amp;&amp; CorrectorGain &gt;= 0 &amp;&amp; CorrectorGain &lt;= 100
1775     set(handles.CorrectorGain, <span class="string">'Value'</span>, CorrectorGain);
1776 <span class="keyword">else</span>
1777     set(handles.CorrectorGain, <span class="string">'String'</span>, <span class="string">'100'</span>);
1778 <span class="keyword">end</span>
1779 
1780 RingSetOrbit = getappdata(0, <span class="string">'RingSetOrbit'</span>);
1781 <span class="keyword">if</span> isfield(RingSetOrbit,<span class="string">'RunFlag'</span>) &amp;&amp; RingSetOrbit.RunFlag == 1
1782     <span class="comment">% Orbit correction is running.  Request an CorrectorGain change.</span>
1783     RingSetOrbit.CorrectorGain = CorrectorGain/100;
1784     setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
1785 <span class="keyword">else</span>
1786     OCS = getappdata(handles.figure1, <span class="string">'OCS'</span>);
1787     OCS.CorrectorGain = CorrectorGain/100;
1788     setappdata(handles.figure1, <span class="string">'OCS'</span>, OCS);
1789 <span class="keyword">end</span>
1790 
1791 
1792 
1793</pre></div>
<hr><address>Generated on Fri 01-Aug-2008 10:57:33 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>