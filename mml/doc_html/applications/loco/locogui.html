<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of locogui</title>
  <meta name="keywords" content="locogui">
  <meta name="description" content="LOCOGUI - Graphical interface for running the LOCO algorithm">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">applications</a> &gt; <a href="index.html">loco</a> &gt; locogui.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for applications\loco&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>locogui
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>LOCOGUI - Graphical interface for running the LOCO algorithm</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function varargout = locogui(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">LOCOGUI - Graphical interface for running the LOCO algorithm

  There are a number of inputs when running LOCO.

  I. File menu
  A.  Open -&gt; open a loco data file. The input file can be a .mat file or a .m script.  
  B.  Save as -&gt; save file to a different name.
  C.  Save as (one iteration) -&gt; saves only one iteration.
  D.  Print,
  E.  Pop Plot #1 -&gt; copies plot #1 in locogui to a Matlab figure so that it can 
                 be modified in any way the user wants.  Locogui has the axes 
                 handles hiddlen.  If a user wants to change this issue, 
                 set(0,'ShowHiddenHandles','on') (at your own risk).   
  E.  Pop Plot #2 -&gt; copies plot #2 in locogui to a Matlab figure.
  F.  Diary -&gt; Starts/Ends a diary file.
  
  All the information for each iteration is saved in the data file.  Anytime a selection 
  is made from the &quot;Start From&quot; popup menu, all the items in the input menu are restored.  
  This includes the BPM and CM lists.  One potential awkwardness in this application is 
  respect to viewing the BPM and CM lists.  If one edits a BPM or CM list, then the displayed 
  list is relative to the &quot;Start From&quot; popup menu and not the &quot;Plot Iteration&quot; popup menu.
  
  II. Input menu
  A.  Auto-Correct deltas
  LocoFlags.AutoCorrectDelta = 'Yes' or 'No'
  
  Automatically adjust the delta used to compute the response matrix gradient.  
  If AutoCorrectDeltaFlag = 'Yes', then the parameter deltas are adjusted to 
  keep the RMS change in the response matrix change equal to 1 micron.  
  If the RMS is within a factor of ten, then the delta is corrected but 
  the response matrix is not recomputed.  Note: if FitParameters.Deltas = NaN 
  and Autocorrect is off, then Fdelta will still be autocorrected once.
 
  B. Options for selecting the number of singular values
  LocoFlags.SVmethod = 'Rank,' [], threshold, or an index vector
 
  If SVmethod is a scalar, then all singular values will be greater than Smax * SVmethod.
  If SVmethod is empty, then singular values will be choosen manually (graphically).
  If SVmethod is a vector, then that vector corresponds to the index of singular values.
  If SVmethod is 'Rank', then singular values are removed if a Matlab warning for rank tolerance is exceeded.
 
  C. Include dispersion as a column of the response matrix
  LocoFlags.Dispersion = 'Yes' or 'No'
 
  D. Use the fully coupled response matrix
  LocoFlags.Coupling = 'Yes' or 'No'
 
  E. Normalize the parameter fit response matrix to the same RMS as the model response matrix
  LocoFlags.Normalization.Flag = 'Yes' or 'No'
  Note: if the RF frequency is fit, it is always normalized.
 
  F. Use linear response matrix calculator 
  LocoFlags.ResponseMatrixCalculator = 'Linear'
 
  G. Outlier rejection 
  LocoFlags.OutlierFactor = number of sigma

  H.  Output U,S,V, and A matrices to a file
  LocoFlags.SVDDataFileName = Directory\FileName or [] (ignored if empty)
 
  NOTE 
  1. When saving A, S, V, U the outliers have been removed, however, 
     the saved response matrix (measured and model) do not.

  See LocoManual.doc, James SaFranek (the LOCO creator), Andrei Terebilo, or Greg Portmann for more information.
 
  Writen by Greg Portmann</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="loco.html" class="code" title="function [LocoModel, BPMData, CMData, FitParameters, LocoFlags, RINGData] = loco(LocoMeasData, BPMData, CMData, FitParameters, LocoFlags, RINGData)">loco</a>	LOCO - Main routine for the LOCO algorithm</li><li><a href="lococalcdeltachi2.html" class="code" title="function [dChi2_FitParameter, dChi2_FitParameterGroup, dChi2_BPMGroup, dChi2_CMGroup, Chi2_Nominal] = lococalcdeltachi2(varargin)">lococalcdeltachi2</a>	LOCOCALCDeltaCHI2 - Calculate the contribution to chi2 of each fit parameter in LOCO</li><li><a href="locodata.html" class="code" title="function varargout = locodata(FileName, IterationNumber, varargin)">locodata</a>	LOCODATA - Extracts data from a LOCO file</li><li><a href="locoeditlist.html" class="code" title="function newList = locoeditlist(List, ListName, CheckList)">locoeditlist</a>	LOCOEDITLIST - Device list editor</li><li><a href="locofilecheck.html" class="code" title="function [BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData] = locofilecheck(FileName)">locofilecheck</a>	LOCOFILECHECK - Consistence check for the LOCO input file</li><li><a href="locomcf.html" class="code" title="function Alpha = locomcf(RINGData)">locomcf</a>	LOCOMCF - Returns the momentum compaction factor</li><li><a href="locoplot.html" class="code" title="function ElementsInput = locoplot(FileName, IterationNumber, PlotString, PlaneString, ElementsInput)">locoplot</a>	LOCOPLOT - Subroutines for plotting LOCO output</li><li><a href="locoplotrms.html" class="code" title="function locoplotrms(FileName, IterationNumber, PlotType)">locoplotrms</a>	LOCOPLOTRMS - Plots the RMS of the LOCO fits</li><li><a href="locoresponsematrix.html" class="code" title="function RM = locoresponsematrix(RINGData, BPMData, CMData, varargin)">locoresponsematrix</a>	LOCORESPONSEMATRIX - Calculate the BPM response matrix and dispersion function</li><li><a href="locosetlatticeparam.html" class="code" title="function RINGData = locosetlatticeparam(RINGData, LocoParams, LocoValues)">locosetlatticeparam</a>	LOCOSETLATTICEPARAM - Set the AT lattice from the LOCO fit parameters</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="loco.html" class="code" title="function [LocoModel, BPMData, CMData, FitParameters, LocoFlags, RINGData] = loco(LocoMeasData, BPMData, CMData, FitParameters, LocoFlags, RINGData)">loco</a>	LOCO - Main routine for the LOCO algorithm</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function varargout = Start_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub2" class="code">function varargout = LevenbergMarquardt_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub3" class="code">function varargout = ScaledLevenbergMarquardt_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub4" class="code">function varargout = CostScaleFactor_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub5" class="code">function varargout = LambdaLM_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub6" class="code">function varargout = MaxIterLM_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub7" class="code">function varargout = PlotIteration_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub8" class="code">function varargout = OpenFile_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub9" class="code">function varargout = SVDDataSave_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub10" class="code">function varargout = Diary_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub11" class="code">function varargout = NewMeasRespMat_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub12" class="code">function varargout = SaveAs_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub13" class="code">function varargout = MenuUserInput_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub14" class="code">function varargout = MenuThreshold_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub15" class="code">function varargout = Outlier_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub16" class="code">function varargout = HorizontalDispersion_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub17" class="code">function varargout = VerticalDispersion_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub18" class="code">function varargout = HBPMIndex_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub19" class="code">function varargout = VBPMIndex_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub20" class="code">function varargout = HCMIndex_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub21" class="code">function varargout = VCMIndex_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub22" class="code">function varargout = StartFrom_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub23" class="code">function setmenuinputs(BPMData, CMData, LocoFlags, FitParameters, handles)</a></li><li><a href="#_sub24" class="code">function varargout = MenuAxes_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub25" class="code">function locoplots(PlotNumber, FieldName)</a></li><li><a href="#_sub26" class="code">function varargout = ContextCostFunctionPlot_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub27" class="code">function PlotCostFunction</a></li><li><a href="#_sub28" class="code">function varargout = ContextPartialChi2Plot_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub29" class="code">function PlotPartialChi2</a></li><li><a href="#_sub30" class="code">function varargout = ContextMenuPlot_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub31" class="code">function varargout = ContextMenuSurfPlot_Callback(h, eventdata, handles, varargin)</a></li><li><a href="#_sub32" class="code">function [Mmodel, Dispersion, ChiSquare] = getmodelresponsematrix(BPMData, CMData, FitParameters, LocoFlags, LocoMeasData, RINGData)</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function varargout = locogui(varargin)</a>
0002 <span class="comment">%LOCOGUI - Graphical interface for running the LOCO algorithm</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%  There are a number of inputs when running LOCO.</span>
0005 <span class="comment">%</span>
0006 <span class="comment">%  I. File menu</span>
0007 <span class="comment">%  A.  Open -&gt; open a loco data file. The input file can be a .mat file or a .m script.</span>
0008 <span class="comment">%  B.  Save as -&gt; save file to a different name.</span>
0009 <span class="comment">%  C.  Save as (one iteration) -&gt; saves only one iteration.</span>
0010 <span class="comment">%  D.  Print,</span>
0011 <span class="comment">%  E.  Pop Plot #1 -&gt; copies plot #1 in locogui to a Matlab figure so that it can</span>
0012 <span class="comment">%                 be modified in any way the user wants.  Locogui has the axes</span>
0013 <span class="comment">%                 handles hiddlen.  If a user wants to change this issue,</span>
0014 <span class="comment">%                 set(0,'ShowHiddenHandles','on') (at your own risk).</span>
0015 <span class="comment">%  E.  Pop Plot #2 -&gt; copies plot #2 in locogui to a Matlab figure.</span>
0016 <span class="comment">%  F.  Diary -&gt; Starts/Ends a diary file.</span>
0017 <span class="comment">%</span>
0018 <span class="comment">%  All the information for each iteration is saved in the data file.  Anytime a selection</span>
0019 <span class="comment">%  is made from the &quot;Start From&quot; popup menu, all the items in the input menu are restored.</span>
0020 <span class="comment">%  This includes the BPM and CM lists.  One potential awkwardness in this application is</span>
0021 <span class="comment">%  respect to viewing the BPM and CM lists.  If one edits a BPM or CM list, then the displayed</span>
0022 <span class="comment">%  list is relative to the &quot;Start From&quot; popup menu and not the &quot;Plot Iteration&quot; popup menu.</span>
0023 <span class="comment">%</span>
0024 <span class="comment">%  II. Input menu</span>
0025 <span class="comment">%  A.  Auto-Correct deltas</span>
0026 <span class="comment">%  LocoFlags.AutoCorrectDelta = 'Yes' or 'No'</span>
0027 <span class="comment">%</span>
0028 <span class="comment">%  Automatically adjust the delta used to compute the response matrix gradient.</span>
0029 <span class="comment">%  If AutoCorrectDeltaFlag = 'Yes', then the parameter deltas are adjusted to</span>
0030 <span class="comment">%  keep the RMS change in the response matrix change equal to 1 micron.</span>
0031 <span class="comment">%  If the RMS is within a factor of ten, then the delta is corrected but</span>
0032 <span class="comment">%  the response matrix is not recomputed.  Note: if FitParameters.Deltas = NaN</span>
0033 <span class="comment">%  and Autocorrect is off, then Fdelta will still be autocorrected once.</span>
0034 <span class="comment">%</span>
0035 <span class="comment">%  B. Options for selecting the number of singular values</span>
0036 <span class="comment">%  LocoFlags.SVmethod = 'Rank,' [], threshold, or an index vector</span>
0037 <span class="comment">%</span>
0038 <span class="comment">%  If SVmethod is a scalar, then all singular values will be greater than Smax * SVmethod.</span>
0039 <span class="comment">%  If SVmethod is empty, then singular values will be choosen manually (graphically).</span>
0040 <span class="comment">%  If SVmethod is a vector, then that vector corresponds to the index of singular values.</span>
0041 <span class="comment">%  If SVmethod is 'Rank', then singular values are removed if a Matlab warning for rank tolerance is exceeded.</span>
0042 <span class="comment">%</span>
0043 <span class="comment">%  C. Include dispersion as a column of the response matrix</span>
0044 <span class="comment">%  LocoFlags.Dispersion = 'Yes' or 'No'</span>
0045 <span class="comment">%</span>
0046 <span class="comment">%  D. Use the fully coupled response matrix</span>
0047 <span class="comment">%  LocoFlags.Coupling = 'Yes' or 'No'</span>
0048 <span class="comment">%</span>
0049 <span class="comment">%  E. Normalize the parameter fit response matrix to the same RMS as the model response matrix</span>
0050 <span class="comment">%  LocoFlags.Normalization.Flag = 'Yes' or 'No'</span>
0051 <span class="comment">%  Note: if the RF frequency is fit, it is always normalized.</span>
0052 <span class="comment">%</span>
0053 <span class="comment">%  F. Use linear response matrix calculator</span>
0054 <span class="comment">%  LocoFlags.ResponseMatrixCalculator = 'Linear'</span>
0055 <span class="comment">%</span>
0056 <span class="comment">%  G. Outlier rejection</span>
0057 <span class="comment">%  LocoFlags.OutlierFactor = number of sigma</span>
0058 <span class="comment">%</span>
0059 <span class="comment">%  H.  Output U,S,V, and A matrices to a file</span>
0060 <span class="comment">%  LocoFlags.SVDDataFileName = Directory\FileName or [] (ignored if empty)</span>
0061 <span class="comment">%</span>
0062 <span class="comment">%  NOTE</span>
0063 <span class="comment">%  1. When saving A, S, V, U the outliers have been removed, however,</span>
0064 <span class="comment">%     the saved response matrix (measured and model) do not.</span>
0065 <span class="comment">%</span>
0066 <span class="comment">%  See LocoManual.doc, James SaFranek (the LOCO creator), Andrei Terebilo, or Greg Portmann for more information.</span>
0067 <span class="comment">%</span>
0068 <span class="comment">%  Writen by Greg Portmann</span>
0069 
0070 
0071 <span class="comment">% LOCOGUI Application M-file for locogui.fig</span>
0072 <span class="comment">%    FIG = LOCOGUI launch locogui GUI.</span>
0073 <span class="comment">%    LOCOGUI('callback_name', ...) invoke the named callback.</span>
0074 
0075 <span class="comment">% Last Modified by GUIDE v2.0 21-Nov-2001 16:26:19</span>
0076 
0077 <span class="keyword">if</span> nargin == 0  <span class="comment">% LAUNCH GUI</span>
0078 
0079     fig = openfig(mfilename,<span class="string">'new'</span>);  <span class="comment">% 'reuse'</span>
0080 
0081     <span class="comment">% Use system color scheme for figure (this seems to create platform dependent problems)</span>
0082     <span class="comment">%set(fig,'Color',get(0,'defaultUicontrolBackgroundColor'));</span>
0083 
0084     <span class="comment">% Generate a structure of handles to pass to callbacks, and store it.</span>
0085     handles = guihandles(fig);
0086     guidata(fig, handles);
0087     
0088     <span class="keyword">if</span> nargout &gt; 0
0089         varargout{1} = fig;
0090     <span class="keyword">end</span>
0091 
0092         
0093     <span class="comment">% Change menu locations</span>
0094     <span class="comment">% set(findobj(fig,'tag','FileName'),'Position',1);</span>
0095     <span class="comment">% set(findobj(fig,'tag','FileName'),'Separator','Off');</span>
0096     <span class="comment">% set(findobj(fig,'tag','FileName'),'Interruptible','Off');</span>
0097     <span class="comment">% set(findobj(fig,'tag','Flags'),'Position',2);</span>
0098     <span class="comment">% set(findobj(fig,'tag','Flags'),'Separator','On');</span>
0099     <span class="comment">% set(findobj(fig,'tag','Flags'),'Interruptible','Off');</span>
0100     <span class="comment">% set(findobj(fig,'tag','Help'),'Interruptible','Off');</span>
0101     
0102     <span class="comment">% set(findobj(gcf,'tag','linear'),'enable','off')</span>
0103 
0104     
0105 <span class="keyword">elseif</span> ischar(varargin{1}) <span class="comment">% INVOKE NAMED SUBFUNCTION OR CALLBACK</span>
0106 
0107     <span class="keyword">try</span>
0108         [varargout{1:nargout}] = feval(varargin{:}); <span class="comment">% FEVAL switchyard</span>
0109     <span class="keyword">catch</span>
0110         disp(lasterr);
0111     <span class="keyword">end</span>
0112 
0113 <span class="keyword">end</span>
0114 
0115 
0116 <span class="comment">%| ABOUT CALLBACKS:</span>
0117 <span class="comment">%| GUIDE automatically appends subfunction prototypes to this file, and</span>
0118 <span class="comment">%| sets objects' callback properties to call them through the FEVAL</span>
0119 <span class="comment">%| switchyard above. This comment describes that mechanism.</span>
0120 <span class="comment">%|</span>
0121 <span class="comment">%| Each callback subfunction declaration has the following form:</span>
0122 <span class="comment">%| &lt;SUBFUNCTION_NAME&gt;(H, EVENTDATA, HANDLES, VARARGIN)</span>
0123 <span class="comment">%|</span>
0124 <span class="comment">%| The subfunction name is composed using the object's Tag and the</span>
0125 <span class="comment">%| callback type separated by '_', e.g. 'slider2_Callback',</span>
0126 <span class="comment">%| 'figure1_CloseRequestFcn', 'axis1_ButtondownFcn'.</span>
0127 <span class="comment">%|</span>
0128 <span class="comment">%| H is the callback object's handle (obtained using GCBO).</span>
0129 <span class="comment">%|</span>
0130 <span class="comment">%| EVENTDATA is empty, but reserved for future use.</span>
0131 <span class="comment">%|</span>
0132 <span class="comment">%| HANDLES is a structure containing handles of components in GUI using</span>
0133 <span class="comment">%| tags as fieldnames, e.g. handles.figure1, handles.slider2. This</span>
0134 <span class="comment">%| structure is created at GUI startup using GUIHANDLES and stored in</span>
0135 <span class="comment">%| the figure's application data using GUIDATA. A copy of the structure</span>
0136 <span class="comment">%| is passed to each callback.  You can store additional information in</span>
0137 <span class="comment">%| this structure at GUI startup, and you can change the structure</span>
0138 <span class="comment">%| during callbacks.  Call guidata(h, handles) after changing your</span>
0139 <span class="comment">%| copy to replace the stored original so that subsequent callbacks see</span>
0140 <span class="comment">%| the updates. Type &quot;help guihandles&quot; and &quot;help guidata&quot; for more</span>
0141 <span class="comment">%| information.</span>
0142 <span class="comment">%|</span>
0143 <span class="comment">%| VARARGIN contains any extra arguments you have passed to the</span>
0144 <span class="comment">%| callback. Specify the extra arguments by editing the callback</span>
0145 <span class="comment">%| property in the inspector. By default, GUIDE sets the property to:</span>
0146 <span class="comment">%| &lt;MFILENAME&gt;('&lt;SUBFUNCTION_NAME&gt;', gcbo, [], guidata(gcbo))</span>
0147 <span class="comment">%| Add any extra arguments after the last argument, before the final</span>
0148 <span class="comment">%| closing parenthesis.</span>
0149 
0150 
0151 <span class="comment">% --------------------------------------------------------------------</span>
0152 <a name="_sub1" href="#_subfunctions" class="code">function varargout = Start_Callback(h, eventdata, handles, varargin)</a>
0153 
0154 <span class="comment">% Get filename and try to load</span>
0155 FileName = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FileName'</span>),<span class="string">'Userdata'</span>);
0156 <span class="keyword">try</span>
0157     load(FileName);
0158     FileName = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FileName'</span>),<span class="string">'Userdata'</span>);     <span class="comment">% Just in case FileName happens to be saved in the .mat file</span>
0159 <span class="keyword">catch</span>
0160     fprintf(<span class="string">'   File does not exist or is not a *.mat file type.\n'</span>);
0161     axes(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Axes1'</span>));
0162     set(gca,<span class="string">'XTick'</span>,[]); set(gca,<span class="string">'YTick'</span>,[]); cla; title(<span class="string">' '</span>); xlabel(<span class="string">' '</span>); ylabel(<span class="string">' '</span>);
0163     axes(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Axes2'</span>));
0164     set(gca,<span class="string">'XTick'</span>,[]); set(gca,<span class="string">'YTick'</span>,[]); cla; title(<span class="string">' '</span>); xlabel(<span class="string">' '</span>); ylabel(<span class="string">' '</span>);
0165     <span class="keyword">return</span>
0166 <span class="keyword">end</span>
0167 
0168 
0169 <span class="comment">% Check inputs and add defaults (should already be done)</span>
0170 <span class="comment">%[BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData] = locofilecheck({BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData});</span>
0171 
0172 
0173 StartFrom  = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'StartFrom'</span>),<span class="string">'Value'</span>)-1;
0174 Iterations = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Iterations'</span>),<span class="string">'Value'</span>);
0175 
0176     
0177 <span class="comment">% Clear old iterations if they exist</span>
0178 <span class="keyword">if</span> StartFrom+2 &lt;= length(FitParameters)
0179     fprintf(<span class="string">'   Note:  You are writing over previous iterations.\n'</span>);
0180     LocoFlags(StartFrom+2:end) = [];
0181     BPMData(StartFrom+2:end) = [];
0182     CMData(StartFrom+2:end) = [];
0183     FitParameters(StartFrom+2:end) = [];
0184     LocoModel(:,StartFrom+2:end) = [];
0185 <span class="keyword">end</span>
0186 
0187 
0188 <span class="keyword">for</span> i = StartFrom+2:(StartFrom+2+Iterations-1)
0189     fprintf(<span class="string">'   Iteration #%d\n'</span>, i-1);
0190     
0191     <span class="comment">% Start with the old values</span>
0192     BPMData(i) = BPMData(i-1);
0193     CMData(i) = CMData(i-1);
0194     FitParameters(i) = FitParameters(i-1);
0195     LocoFlags(i) = LocoFlags(i-1);
0196     
0197     <span class="comment">% Check for a new (user input) BPM and CM good data lists</span>
0198     <span class="keyword">if</span> ~isempty(get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'HBPMIndex'</span>), <span class="string">'Userdata'</span>))
0199         <span class="comment">%fprintf('   Horizontal BPM list changed based on user input.\n');</span>
0200         BPMData(i).HBPMGoodDataIndex = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'HBPMIndex'</span>), <span class="string">'Userdata'</span>);
0201     <span class="keyword">end</span>
0202     <span class="keyword">if</span> ~isempty(get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'VBPMIndex'</span>), <span class="string">'Userdata'</span>))
0203         <span class="comment">%fprintf('   Vertical BPM list changed based on user input.\n');</span>
0204         BPMData(i).VBPMGoodDataIndex = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'VBPMIndex'</span>), <span class="string">'Userdata'</span>);
0205     <span class="keyword">end</span>
0206     <span class="keyword">if</span> ~isempty(get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'HCMIndex'</span>), <span class="string">'Userdata'</span>))
0207         <span class="comment">%fprintf('   Horizontal corrector magnet list changed based on user input.\n');</span>
0208         CMData(i).HCMGoodDataIndex = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'HCMIndex'</span>), <span class="string">'Userdata'</span>);
0209     <span class="keyword">end</span>
0210     <span class="keyword">if</span> ~isempty(get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'VCMIndex'</span>), <span class="string">'Userdata'</span>))
0211         <span class="comment">%fprintf('   Vertical corrector magnet list changed based on user input.\n');</span>
0212         CMData(i).VCMGoodDataIndex = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'VCMIndex'</span>), <span class="string">'Userdata'</span>);
0213     <span class="keyword">end</span>
0214 
0215 
0216     <span class="comment">% Get flags</span>
0217     <span class="keyword">if</span> strcmpi((get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Rank'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>) 
0218         <span class="comment">% Rank method</span>
0219         LocoFlags(i).SVmethod = <span class="string">'Rank'</span>;
0220     <span class="keyword">elseif</span> strcmpi((get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Threshold'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0221         <span class="comment">% Threshold method</span>
0222         LocoFlags(i).SVmethod = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Threshold'</span>),<span class="string">'Userdata'</span>);
0223     <span class="keyword">elseif</span> strcmpi((get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Interactive'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0224         <span class="comment">% Interactive method</span>
0225         LocoFlags(i).SVmethod = [];
0226     <span class="keyword">elseif</span> strcmpi((get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'UserInput'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0227         <span class="comment">% User Input method</span>
0228         LocoFlags(i).SVmethod = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'UserInput'</span>),<span class="string">'Userdata'</span>);
0229     <span class="keyword">else</span>
0230         <span class="comment">% Threshold method</span>
0231         LocoFlags(i).SVmethod = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Threshold'</span>),<span class="string">'Userdata'</span>);        
0232     <span class="keyword">end</span>
0233     
0234     LocoFlags(i).Threshold = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Threshold'</span>),<span class="string">'Userdata'</span>);
0235     LocoFlags(i).OutlierFactor = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Outlier'</span>),<span class="string">'Userdata'</span>);
0236     LocoFlags(i).HorizontalDispersionWeight = getappdata(gcbf,<span class="string">'HorizontalDispersionWeight'</span>);
0237     LocoFlags(i).VerticalDispersionWeight = getappdata(gcbf,<span class="string">'VerticalDispersionWeight'</span>);
0238 
0239     <span class="keyword">if</span> strcmpi((get(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'AutoCorrect'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0240         LocoFlags(i).AutoCorrectDelta = <span class="string">'Yes'</span>;
0241     <span class="keyword">else</span>
0242         LocoFlags(i).AutoCorrectDelta = <span class="string">'No'</span>;
0243     <span class="keyword">end</span>
0244         
0245     <span class="keyword">if</span> strcmpi((get(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'Coupling'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0246         LocoFlags(i).Coupling = <span class="string">'Yes'</span>;
0247     <span class="keyword">else</span>
0248         LocoFlags(i).Coupling = <span class="string">'No'</span>;
0249     <span class="keyword">end</span>
0250     
0251     <span class="keyword">if</span> strcmpi((get(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'Normalize'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0252         LocoFlags(i).Normalization.Flag = <span class="string">'Yes'</span>;
0253     <span class="keyword">else</span>
0254         LocoFlags(i).Normalization.Flag = <span class="string">'No'</span>;
0255     <span class="keyword">end</span>
0256     
0257     <span class="keyword">if</span> strcmpi((get(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'Dispersion'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0258         LocoFlags(i).Dispersion = <span class="string">'Yes'</span>;
0259     <span class="keyword">else</span>
0260         LocoFlags(i).Dispersion = <span class="string">'No'</span>;
0261     <span class="keyword">end</span>
0262     
0263     <span class="keyword">if</span> strcmpi((get(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'FitHCMEnergyShift'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0264         CMData(i).FitHCMEnergyShift = <span class="string">'Yes'</span>;
0265     <span class="keyword">else</span>
0266         CMData(i).FitHCMEnergyShift = <span class="string">'No'</span>;
0267     <span class="keyword">end</span>
0268 
0269     <span class="keyword">if</span> strcmpi((get(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'FitVCMEnergyShift'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0270         CMData(i).FitVCMEnergyShift = <span class="string">'Yes'</span>;
0271     <span class="keyword">else</span>
0272         CMData(i).FitVCMEnergyShift = <span class="string">'No'</span>;
0273     <span class="keyword">end</span>
0274 
0275     <span class="keyword">if</span> strcmpi((get(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'Linear'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0276         LocoFlags(i).ResponseMatrixCalculator = <span class="string">'Linear'</span>;
0277     <span class="keyword">else</span> <span class="comment">%strcmpi((get(findobj(gcf,'Tag','Full'),'Checked')),'on')</span>
0278         LocoFlags(i).ResponseMatrixCalculator = <span class="string">'Full'</span>;
0279     <span class="keyword">end</span>
0280 
0281     <span class="keyword">if</span> strcmpi((get(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'CM'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0282         LocoFlags(i).ClosedOrbitType = <span class="string">'FixedMomentum'</span>;
0283     <span class="keyword">else</span> <span class="comment">%strcmpi((get(findobj(gcf,'Tag','CPL'),'Checked')),'on')</span>
0284         LocoFlags(i).ClosedOrbitType = <span class="string">'FixedPathLength'</span>;
0285     <span class="keyword">end</span>
0286 
0287     <span class="keyword">if</span> strcmpi((get(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'RespMatBiDirectional'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0288         LocoFlags(i).ResponseMatrixMeasurement = <span class="string">'BiDirectional'</span>;
0289     <span class="keyword">else</span> <span class="comment">%strcmpi((get(findobj(gcf,'Tag','RespMatOneWay'),'Checked')),'on')</span>
0290         LocoFlags(i).ResponseMatrixMeasurement = <span class="string">'OneWay'</span>;
0291     <span class="keyword">end</span>
0292 
0293     <span class="keyword">if</span> strcmpi((get(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'DispBiDirectional'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0294         LocoFlags(i).DispersionMeasurement = <span class="string">'BiDirectional'</span>;
0295     <span class="keyword">else</span> <span class="comment">%strcmpi((get(findobj(gcf,'Tag','DispOneWay'),'Checked')),'on')</span>
0296         LocoFlags(i).DispersionMeasurement = <span class="string">'OneWay'</span>;
0297     <span class="keyword">end</span>
0298     
0299     <span class="keyword">if</span> strcmpi((get(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'ErrorBars'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0300         LocoFlags(i).CalculateSigma = <span class="string">'Yes'</span>;
0301     <span class="keyword">else</span>
0302         LocoFlags(i).CalculateSigma = <span class="string">'No'</span>;
0303     <span class="keyword">end</span>
0304 
0305     <span class="keyword">if</span> strcmpi((get(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'SinglePrecision'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0306         LocoFlags(i).SinglePrecision = <span class="string">'Yes'</span>;
0307     <span class="keyword">else</span>
0308         LocoFlags(i).SinglePrecision = <span class="string">'No'</span>;
0309     <span class="keyword">end</span>
0310 
0311     <span class="keyword">if</span> strcmpi((get(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'SVD_FileName'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0312         LocoFlags(i).SVDDataFileName = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SVD_FileName'</span>),<span class="string">'Userdata'</span>);
0313     <span class="keyword">else</span>
0314         LocoFlags(i).SVDDataFileName = <span class="string">''</span>;
0315     <span class="keyword">end</span>
0316             
0317     <span class="keyword">if</span> strcmpi((get(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'FitRF'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0318         FitParameters(i).FitRFFrequency = <span class="string">'Yes'</span>;
0319     <span class="keyword">else</span>
0320         FitParameters(i).FitRFFrequency = <span class="string">'No'</span>;
0321     <span class="keyword">end</span>
0322 
0323     <span class="keyword">if</span> strcmpi((get(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'BPMGains'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0324         BPMData(i).FitGains = <span class="string">'Yes'</span>;
0325     <span class="keyword">else</span>
0326         BPMData(i).FitGains = <span class="string">'No'</span>;
0327     <span class="keyword">end</span>
0328 
0329     <span class="keyword">if</span> strcmpi((get(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'BPMCoupling'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0330         BPMData(i).FitCoupling = <span class="string">'Yes'</span>;
0331     <span class="keyword">else</span>
0332         BPMData(i).FitCoupling = <span class="string">'No'</span>;
0333     <span class="keyword">end</span>
0334     
0335     <span class="keyword">if</span> strcmpi((get(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'CMKicks'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0336         CMData(i).FitKicks = <span class="string">'Yes'</span>;
0337     <span class="keyword">else</span>
0338         CMData(i).FitKicks = <span class="string">'No'</span>;
0339     <span class="keyword">end</span>
0340 
0341     <span class="keyword">if</span> strcmpi((get(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'CMRolls'</span>),<span class="string">'Checked'</span>)),<span class="string">'on'</span>)
0342         CMData(i).FitCoupling = <span class="string">'Yes'</span>;
0343     <span class="keyword">else</span>
0344         CMData(i).FitCoupling = <span class="string">'No'</span>;
0345     <span class="keyword">end</span>    
0346     
0347     <span class="keyword">if</span> strcmpi(get(handles.GaussNewton,<span class="string">'Checked'</span>),<span class="string">'on'</span>)
0348         LocoFlags(i).Method.Name    = <span class="string">'Gauss-Newton'</span>;
0349     <span class="keyword">elseif</span> strcmpi(get(handles.GaussNewtonWithCost,<span class="string">'Checked'</span>),<span class="string">'on'</span>)
0350         LocoFlags(i).Method.Name    = <span class="string">'Gauss-Newton With Cost Function'</span>;
0351         LocoFlags(i).Method.CostScaleFactor  = get(handles.CostScaleFactor,<span class="string">'Userdata'</span>);
0352     <span class="keyword">elseif</span> strcmpi(get(handles.LevenbergMarquardt,<span class="string">'Checked'</span>),<span class="string">'on'</span>)
0353         LocoFlags(i).Method.Name    = <span class="string">'Levenberg-Marquardt'</span>;
0354         LocoFlags(i).Method.MaxIter = get(handles.MaxIterLM,<span class="string">'Userdata'</span>);
0355         LocoFlags(i).Method.Lambda  = get(handles.LambdaLM,<span class="string">'Userdata'</span>);
0356     <span class="keyword">elseif</span> strcmpi(get(handles.ScaledLevenbergMarquardt,<span class="string">'Checked'</span>),<span class="string">'on'</span>)
0357         LocoFlags(i).Method.Name    = <span class="string">'Scaled Levenberg-Marquardt'</span>;
0358         LocoFlags(i).Method.MaxIter = get(handles.MaxIterLM,<span class="string">'Userdata'</span>);
0359         LocoFlags(i).Method.Lambda  = get(handles.LambdaLM,<span class="string">'Userdata'</span>);
0360     <span class="keyword">else</span>
0361         error(<span class="string">'Method unknown'</span>);
0362     <span class="keyword">end</span>
0363     
0364     
0365     <span class="comment">% Run loco</span>
0366     [LocoModel(i), BPMData(i), CMData(i), FitParameters(i), LocoFlags(i), RINGData] = <a href="loco.html" class="code" title="function [LocoModel, BPMData, CMData, FitParameters, LocoFlags, RINGData] = loco(LocoMeasData, BPMData, CMData, FitParameters, LocoFlags, RINGData)">loco</a>(LocoMeasData, BPMData(i), CMData(i), FitParameters(i), LocoFlags(i), RINGData);
0367 
0368     <span class="comment">% Was a better solution found?</span>
0369     <span class="keyword">if</span> any(strcmpi(LocoFlags(i).Method.Name, {<span class="string">'Levenberg-Marquardt'</span>, <span class="string">'Scaled Levenberg-Marquardt'</span>}))
0370         <span class="keyword">if</span> strcmpi(LocoFlags(i).Method.BetterSolution, <span class="string">'No'</span>)
0371             <span class="comment">% not needed: LocoModel(i) = []; BPMData(i) = []; CMData(i) = []; FitParameters(i) = []; LocoFlags(i) = [];</span>
0372             fprintf(<span class="string">'\n   Stopping at iteration %d since no better solution was found.\n\n'</span>, i-1);
0373             iLast = i-1;
0374             <span class="keyword">break</span>;
0375         <span class="keyword">end</span>
0376     <span class="keyword">end</span>
0377     iLast = i;
0378     
0379     save(FileName, <span class="string">'LocoModel'</span>, <span class="string">'FitParameters'</span>, <span class="string">'BPMData'</span>, <span class="string">'CMData'</span>, <span class="string">'RINGData'</span>, <span class="string">'LocoMeasData'</span>, <span class="string">'LocoFlags'</span>);
0380     setappdata(gcbf, <span class="string">'LocoDataCell'</span>, {BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData});
0381     
0382     <span class="comment">% Plot</span>
0383     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotIteration'</span>),<span class="string">'String'</span>,num2str((0:iLast-1)'));
0384     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotIteration'</span>),<span class="string">'Value'</span>, iLast); 
0385     <a href="#_sub24" class="code" title="subfunction varargout = MenuAxes_Callback(h, eventdata, handles, varargin)">MenuAxes_Callback</a>(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotMenu1'</span>));
0386     <a href="#_sub24" class="code" title="subfunction varargout = MenuAxes_Callback(h, eventdata, handles, varargin)">MenuAxes_Callback</a>(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotMenu2'</span>));
0387     load(FileName);
0388     drawnow;
0389 <span class="keyword">end</span>
0390 
0391 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'StartFrom'</span>),<span class="string">'String'</span>,num2str((0:iLast-1)'));
0392 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'StartFrom'</span>),<span class="string">'Value'</span>,iLast);
0393 
0394 <span class="comment">% Update menu items in case something was changed in loco</span>
0395 <a href="#_sub23" class="code" title="subfunction setmenuinputs(BPMData, CMData, LocoFlags, FitParameters, handles)">setmenuinputs</a>(BPMData(end), CMData(end), LocoFlags(end), FitParameters(end), handles);
0396 
0397 
0398 <span class="comment">% --------------------------------------------------------------------</span>
0399 <a name="_sub2" href="#_subfunctions" class="code">function varargout = LevenbergMarquardt_Callback(h, eventdata, handles, varargin)</a>
0400 set(handles.GaussNewton,             <span class="string">'Checked'</span>,<span class="string">'off'</span>); 
0401 set(handles.GaussNewtonWithCost,     <span class="string">'Checked'</span>,<span class="string">'off'</span>); 
0402 set(handles.LevenbergMarquardt,      <span class="string">'Checked'</span>,<span class="string">'on'</span>); 
0403 set(handles.ScaledLevenbergMarquardt,<span class="string">'Checked'</span>,<span class="string">'off'</span>); 
0404 set(handles.CostScaleFactor, <span class="string">'Enable'</span>,<span class="string">'off'</span>); 
0405 set(handles.LambdaLM,        <span class="string">'Enable'</span>,<span class="string">'on'</span>); 
0406 set(handles.MaxIterLM,       <span class="string">'Enable'</span>,<span class="string">'on'</span>);
0407 
0408 <span class="comment">%set(handles.LambdaLM, 'Label',['    Lambda = ',            num2str(get(handles.LambdaLM, 'Userdata'))]);</span>
0409 <span class="comment">%set(handles.MaxIterLM,'Label',['    Maximum Iterations = ',num2str(get(handles.MaxIterLM,'Userdata'))]);</span>
0410 
0411 <span class="comment">% --------------------------------------------------------------------</span>
0412 <a name="_sub3" href="#_subfunctions" class="code">function varargout = ScaledLevenbergMarquardt_Callback(h, eventdata, handles, varargin)</a>
0413 set(handles.GaussNewton,             <span class="string">'Checked'</span>,<span class="string">'off'</span>); 
0414 set(handles.GaussNewtonWithCost,     <span class="string">'Checked'</span>,<span class="string">'off'</span>); 
0415 set(handles.LevenbergMarquardt,      <span class="string">'Checked'</span>,<span class="string">'off'</span>); 
0416 set(handles.ScaledLevenbergMarquardt,<span class="string">'Checked'</span>,<span class="string">'on'</span>); 
0417 set(handles.CostScaleFactor, <span class="string">'Enable'</span>,<span class="string">'off'</span>); 
0418 set(handles.LambdaLM,        <span class="string">'Enable'</span>,<span class="string">'on'</span>); 
0419 set(handles.MaxIterLM,       <span class="string">'Enable'</span>,<span class="string">'on'</span>);
0420 
0421 <span class="comment">%set(handles.LambdaLM, 'Label',['    Lambda = ',            num2str(get(handles.LambdaLM, 'Userdata'))]);</span>
0422 <span class="comment">%set(handles.MaxIterLM,'Label',['    Maximum Iterations = ',num2str(get(handles.MaxIterLM,'Userdata'))]);</span>
0423 
0424 
0425 <span class="comment">% --------------------------------------------------------------------</span>
0426 <a name="_sub4" href="#_subfunctions" class="code">function varargout = CostScaleFactor_Callback(h, eventdata, handles, varargin)</a>
0427 
0428 CostScaleFactor = get(handles.CostScaleFactor,<span class="string">'Userdata'</span>);
0429 <span class="keyword">if</span> isempty(CostScaleFactor)
0430     CostScaleFactor = 1;
0431 <span class="keyword">end</span>
0432 
0433 AnswerString = inputdlg({<span class="string">'CostScaleFactor (Levenberg-Marquardt):'</span>},<span class="string">'LOCO'</span>,1,{num2str(CostScaleFactor)});
0434 <span class="keyword">if</span> ~isempty(AnswerString); 
0435     CostScaleFactor = str2num(AnswerString{1}); 
0436     set(handles.CostScaleFactor, <span class="string">'Label'</span>, [<span class="string">'    Cost Scale Factor = '</span>,num2str(CostScaleFactor)]); 
0437     set(handles.CostScaleFactor, <span class="string">'Userdata'</span>, CostScaleFactor); 
0438 <span class="keyword">end</span>
0439 
0440 <span class="comment">% --------------------------------------------------------------------</span>
0441 <a name="_sub5" href="#_subfunctions" class="code">function varargout = LambdaLM_Callback(h, eventdata, handles, varargin)</a>
0442 
0443 LambdaLM = get(handles.LambdaLM,<span class="string">'Userdata'</span>);
0444 <span class="keyword">if</span> isempty(LambdaLM)
0445     LambdaLM = .001;
0446 <span class="keyword">end</span>
0447 
0448 AnswerString = inputdlg({<span class="string">'Lambda (Levenberg-Marquardt):'</span>},<span class="string">'LOCO'</span>,1,{num2str(LambdaLM)});
0449 <span class="keyword">if</span> ~isempty(AnswerString); 
0450     LambdaLM = str2num(AnswerString{1}); 
0451     set(handles.LambdaLM, <span class="string">'Label'</span>, [<span class="string">'    Lambda = '</span>,num2str(LambdaLM)]); 
0452     set(handles.LambdaLM, <span class="string">'Userdata'</span>, LambdaLM); 
0453 <span class="keyword">end</span>
0454 
0455 
0456 <span class="comment">% --------------------------------------------------------------------</span>
0457 <a name="_sub6" href="#_subfunctions" class="code">function varargout = MaxIterLM_Callback(h, eventdata, handles, varargin)</a>
0458 MaxIterLM = get(handles.MaxIterLM, <span class="string">'Userdata'</span>);
0459 <span class="keyword">if</span> isempty(MaxIterLM)
0460     MaxIterLM = 10;
0461 <span class="keyword">end</span>
0462 
0463 AnswerString = inputdlg({<span class="string">'Maximum Iterations (Levenberg-Marquardt):'</span>},<span class="string">'LOCO'</span>,1,{num2str(MaxIterLM)});
0464 <span class="keyword">if</span> ~isempty(AnswerString); 
0465     MaxIterLM = ceil(str2num(AnswerString{1})); 
0466     set(handles.MaxIterLM, <span class="string">'Label'</span>, [<span class="string">'   Maximum Iterations = '</span>,num2str(MaxIterLM)]); 
0467     set(handles.MaxIterLM, <span class="string">'Userdata'</span>, MaxIterLM); 
0468 <span class="keyword">end</span>
0469 
0470 
0471 <span class="comment">% --------------------------------------------------------------------</span>
0472 <a name="_sub7" href="#_subfunctions" class="code">function varargout = PlotIteration_Callback(h, eventdata, handles, varargin)</a>
0473 <a href="#_sub24" class="code" title="subfunction varargout = MenuAxes_Callback(h, eventdata, handles, varargin)">MenuAxes_Callback</a>(handles.PlotMenu1);
0474 <a href="#_sub24" class="code" title="subfunction varargout = MenuAxes_Callback(h, eventdata, handles, varargin)">MenuAxes_Callback</a>(handles.PlotMenu2);
0475 
0476 
0477 <span class="comment">% --------------------------------------------------------------------</span>
0478 <a name="_sub8" href="#_subfunctions" class="code">function varargout = OpenFile_Callback(h, eventdata, handles, varargin)</a>
0479 
0480 <span class="comment">% Get filename and try to load</span>
0481 <span class="comment">%FileName = deblank(get(h,'String'));</span>
0482 [FileName, PathName] = uigetfile({<span class="string">'*.*'</span>}, <span class="string">'Choose the desired loco data file'</span>);
0483 <span class="keyword">if</span> isequal(FileName,0) || isequal(PathName,0)
0484     <span class="keyword">return</span>
0485 <span class="keyword">end</span>
0486 
0487 set(gcbf,<span class="string">'Pointer'</span>,<span class="string">'watch'</span>);
0488 
0489 axes(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Axes1'</span>));
0490 cla
0491 set(gca, <span class="string">'UIContextMenu'</span>, []);   <span class="comment">% Clear content menu</span>
0492 set(gca,<span class="string">'XTick'</span>,[]); set(gca,<span class="string">'YTick'</span>,[]); cla; title(<span class="string">' '</span>); xlabel(<span class="string">' '</span>); ylabel(<span class="string">' '</span>);
0493 axes(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Axes2'</span>));
0494 cla
0495 set(gca, <span class="string">'UIContextMenu'</span>, []);  <span class="comment">% Clear content menu</span>
0496 set(gca,<span class="string">'XTick'</span>,[]); set(gca,<span class="string">'YTick'</span>,[]); cla; title(<span class="string">' '</span>); xlabel(<span class="string">' '</span>); ylabel(<span class="string">' '</span>);
0497 
0498 <span class="keyword">try</span>
0499     idot = find(FileName==<span class="string">'.'</span>);
0500     
0501     <span class="comment">% If the variable exist as a matlab script file, just read it</span>
0502     <span class="keyword">if</span> strcmp(FileName(idot:end),<span class="string">'.m'</span>) 
0503         <span class="comment">% Convert .m file to a .mat file</span>
0504         PresentDirectory = pwd;
0505         cd(PathName);
0506         eval(FileName(1:end-2));
0507         cd(PresentDirectory);
0508         FileName = [PathName,FileName,<span class="string">'at'</span>];   <span class="comment">% Make a mat file</span>
0509         save(FileName, <span class="string">'LocoModel'</span>, <span class="string">'FitParameters'</span>, <span class="string">'BPMData'</span>, <span class="string">'CMData'</span>, <span class="string">'RINGData'</span>, <span class="string">'LocoMeasData'</span>, <span class="string">'LocoFlags'</span>);
0510     <span class="keyword">elseif</span> strcmp(FileName(idot:end),<span class="string">'.mat'</span>) 
0511         <span class="comment">% .mat file</span>
0512         FileName = [PathName, FileName];
0513         <span class="comment">%load(FileName);</span>
0514     <span class="keyword">else</span>
0515         fprintf(<span class="string">'   File must be of type .mat or .m.\n'</span>);
0516         error(<span class="string">'  '</span>);
0517     <span class="keyword">end</span>
0518 <span class="keyword">catch</span>
0519     fprintf(<span class="string">'   File open problem\n'</span>);
0520     axes(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Axes1'</span>)); 
0521     cla; 
0522     axes(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Axes2'</span>)); 
0523     cla;
0524     set(gcbf,<span class="string">'Pointer'</span>,<span class="string">'arrow'</span>);
0525     <span class="keyword">return</span>
0526 <span class="keyword">end</span>
0527 
0528 <span class="comment">% Check the file then reload</span>
0529 <span class="keyword">try</span>
0530     [BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData] = <a href="locofilecheck.html" class="code" title="function [BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData] = locofilecheck(FileName)">locofilecheck</a>(FileName);
0531     <span class="comment">%[BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData] = locofilecheck({BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData});</span>
0532     <span class="comment">%save(FileName, 'LocoModel', 'FitParameters', 'BPMData', 'CMData', 'RINGData', 'LocoMeasData', 'LocoFlags');</span>
0533     setappdata(gcbf, <span class="string">'LocoDataCell'</span>, {BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData});
0534 <span class="keyword">catch</span>
0535     fprintf(<span class="string">'   File open problem.\n'</span>);
0536     axes(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Axes1'</span>)); 
0537     cla; 
0538     axes(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Axes2'</span>)); 
0539     cla;
0540     fprintf(<span class="string">'%s\n'</span>, lasterr);    
0541     set(gcbf,<span class="string">'Pointer'</span>,<span class="string">'arrow'</span>);
0542     <span class="keyword">return</span>
0543 <span class="keyword">end</span>
0544 
0545 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FileName'</span>),<span class="string">'Userdata'</span>,FileName);
0546 set(gcbf,<span class="string">'Name'</span>,[<span class="string">'LOCO:  '</span>,FileName]);
0547 
0548 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotIteration'</span>),<span class="string">'String'</span>,num2str([0:length(CMData)-1]'));
0549 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotIteration'</span>),<span class="string">'Value'</span>, length(CMData)); 
0550 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'StartFrom'</span>),<span class="string">'String'</span>,num2str([0:length(CMData)-1]'));
0551 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'StartFrom'</span>),<span class="string">'Value'</span>,length(CMData));
0552 
0553 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'HBPMIndex'</span>), <span class="string">'Userdata'</span>, []); 
0554 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'VBPMIndex'</span>), <span class="string">'Userdata'</span>, []); 
0555 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'HCMIndex'</span>), <span class="string">'Userdata'</span>, []); 
0556 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'VCMIndex'</span>), <span class="string">'Userdata'</span>, []); 
0557 
0558 
0559 <span class="comment">% Force plot #2 and #3 to avoid an error with response matrix plots which cache the filename</span>
0560 StringCell = get(handles.PlotMenu1,<span class="string">'String'</span>);
0561 StringNumber = get(handles.PlotMenu1,<span class="string">'Value'</span>);
0562 <span class="keyword">if</span> ~isempty(strfind(<span class="string">'response matrix'</span>,lower(StringCell{StringNumber})))
0563     set(handles.PlotMenu1,<span class="string">'Value'</span>, 2);
0564 <span class="keyword">end</span>
0565 StringCell = get(handles.PlotMenu2,<span class="string">'String'</span>);
0566 StringNumber = get(handles.PlotMenu2,<span class="string">'Value'</span>);
0567 <span class="keyword">if</span> ~isempty(strfind(<span class="string">'response matrix'</span>,lower(StringCell{StringNumber})))
0568     set(handles.PlotMenu2,<span class="string">'Value'</span>, 3);
0569 <span class="keyword">end</span>
0570 <a href="#_sub24" class="code" title="subfunction varargout = MenuAxes_Callback(h, eventdata, handles, varargin)">MenuAxes_Callback</a>(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotMenu1'</span>), 1);
0571 <a href="#_sub24" class="code" title="subfunction varargout = MenuAxes_Callback(h, eventdata, handles, varargin)">MenuAxes_Callback</a>(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotMenu2'</span>), 1);
0572 
0573 <span class="comment">% Update menu items</span>
0574 <a href="#_sub23" class="code" title="subfunction setmenuinputs(BPMData, CMData, LocoFlags, FitParameters, handles)">setmenuinputs</a>(BPMData(end), CMData(end), LocoFlags(end), FitParameters(end), handles);
0575 
0576 set(gcbf,<span class="string">'Pointer'</span>,<span class="string">'arrow'</span>);
0577 
0578 
0579 <span class="comment">% --------------------------------------------------------------------</span>
0580 <a name="_sub9" href="#_subfunctions" class="code">function varargout = SVDDataSave_Callback(h, eventdata, handles, varargin)</a>
0581 
0582 <span class="keyword">if</span> strcmpi((get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SVD_FileName'</span>),<span class="string">'Checked'</span>)), <span class="string">'on'</span>)
0583     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SVD_FileName'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
0584     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SVD_FileName'</span>),<span class="string">'Label'</span>,[<span class="string">'Save A,S,V,U,CovFit to File'</span>]);
0585     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SVD_FileName'</span>),<span class="string">'Userdata'</span>,[]);    
0586 <span class="keyword">else</span>
0587     [FileName, PathName] = uiputfile(<span class="string">'*.mat'</span>, <span class="string">'SVD data file name'</span>);
0588     <span class="keyword">if</span> isequal(FileName,0) || isequal(PathName,0)
0589         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SVD_FileName'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
0590         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SVD_FileName'</span>),<span class="string">'Label'</span>,[<span class="string">'Save A,S,V,U,CovFit to File'</span>]);
0591         <span class="keyword">return</span>
0592     <span class="keyword">end</span>
0593     FileName = [PathName,FileName];
0594     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SVD_FileName'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
0595     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SVD_FileName'</span>),<span class="string">'Label'</span>,[<span class="string">'Save A,S,V,U,CovFit to File: '</span>, FileName]);
0596     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SVD_FileName'</span>),<span class="string">'Userdata'</span>,FileName);
0597 <span class="keyword">end</span>
0598 
0599 
0600 <span class="comment">% --------------------------------------------------------------------</span>
0601 <a name="_sub10" href="#_subfunctions" class="code">function varargout = Diary_Callback(h, eventdata, handles, varargin)</a>
0602 
0603 <span class="keyword">if</span> strcmpi((get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Diary'</span>),<span class="string">'Checked'</span>)), <span class="string">'on'</span>)
0604     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Diary'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
0605     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Diary'</span>),<span class="string">'Label'</span>,<span class="string">'Diary'</span>);
0606     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Diary'</span>),<span class="string">'Userdata'</span>,[]);
0607     diary off
0608 <span class="keyword">else</span>
0609     [FileName, PathName] = uiputfile(<span class="string">'*.*'</span>, <span class="string">'Diary file name'</span>);
0610     <span class="keyword">if</span> isequal(FileName,0) || isequal(PathName,0)
0611         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Diary'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
0612         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Diary'</span>),<span class="string">'Label'</span>,<span class="string">'Diary'</span>);
0613         <span class="keyword">return</span>
0614     <span class="keyword">end</span>
0615     FileName = [PathName,FileName];
0616     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Diary'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
0617     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Diary'</span>),<span class="string">'Label'</span>,[<span class="string">'Diary: '</span>, FileName]);
0618     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Diary'</span>),<span class="string">'Userdata'</span>,FileName);
0619     diary(FileName);
0620 <span class="keyword">end</span>
0621 
0622 
0623 <span class="comment">% --------------------------------------------------------------------</span>
0624 <a name="_sub11" href="#_subfunctions" class="code">function varargout = NewMeasRespMat_Callback(h, eventdata, handles, varargin)</a>
0625 FileName = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FileName'</span>),<span class="string">'Userdata'</span>);
0626 <span class="keyword">if</span> isempty(FileName)
0627     fprintf(<span class="string">'   LOCO data file does not exist (use File-&gt;Open).\n'</span>);
0628     <span class="keyword">return</span>
0629 <span class="keyword">end</span>
0630 
0631 <span class="comment">% Get response matrix filename and try to load</span>
0632 fprintf(<span class="string">'\n'</span>);
0633 [FileNameMeas, PathNameMeas] = uigetfile(<span class="string">'*.mat'</span>, <span class="string">'New LOCO response mastrix data file name'</span>);
0634 <span class="keyword">if</span> isequal(FileNameMeas,0) || isequal(PathNameMeas,0)
0635     fprintf(<span class="string">'   Measured response data file does not exist.\n\n'</span>);
0636     <span class="keyword">return</span>
0637 <span class="keyword">end</span>
0638 <span class="keyword">try</span>
0639     load(FileNameMeas);    
0640     <span class="comment">%if ~exist('LocoMeasData','var')</span>
0641     <span class="comment">%    fprintf('   LocoMeasData variable does not exist.\n');</span>
0642     <span class="comment">%    return</span>
0643     <span class="comment">%end</span>
0644     <span class="keyword">if</span> exist(<span class="string">'LocoMeasData'</span>,<span class="string">'var'</span>)
0645         fprintf(<span class="string">'   LocoMeasData will be replaced\n'</span>);
0646     <span class="keyword">end</span>
0647     <span class="keyword">if</span> exist(<span class="string">'BPMData'</span>,<span class="string">'var'</span>)
0648         fprintf(<span class="string">'   BPMData will be replaced\n'</span>);
0649     <span class="keyword">end</span>
0650     <span class="keyword">if</span> exist(<span class="string">'CMData'</span>,<span class="string">'var'</span>)
0651         fprintf(<span class="string">'   CMData will be replaced\n'</span>);
0652     <span class="keyword">end</span>
0653     <span class="keyword">if</span> exist(<span class="string">'FitParameters'</span>,<span class="string">'var'</span>)
0654         fprintf(<span class="string">'   FitParameters will be replaced\n'</span>);
0655     <span class="keyword">end</span>
0656     <span class="keyword">if</span> exist(<span class="string">'LocoFlags'</span>,<span class="string">'var'</span>)
0657         fprintf(<span class="string">'   LocoFlags will be replaced\n'</span>);
0658     <span class="keyword">end</span>
0659     <span class="keyword">if</span> exist(<span class="string">'RINGData'</span>,<span class="string">'var'</span>)
0660         fprintf(<span class="string">'   RINGData will be replaced\n'</span>);
0661     <span class="keyword">end</span>
0662     <span class="comment">%if exist('LocoModel','var')</span>
0663     <span class="comment">%    fprintf('   LocoModel will be replaced\n');</span>
0664     <span class="comment">%end</span>
0665 <span class="keyword">catch</span>
0666     fprintf(<span class="string">'   Measured response data file does not exist or is not a *.mat file type\n\n'</span>);
0667     <span class="keyword">return</span>
0668 <span class="keyword">end</span>
0669 
0670 AllExistFlag = (exist(<span class="string">'LocoMeasData'</span>,<span class="string">'var'</span>) &amp; exist(<span class="string">'BPMData'</span>,<span class="string">'var'</span>) &amp; exist(<span class="string">'CMData'</span>,<span class="string">'var'</span>) &amp; exist(<span class="string">'LocoModel'</span>,<span class="string">'var'</span>) &amp; exist(<span class="string">'FitParameters'</span>,<span class="string">'var'</span>) &amp; exist(<span class="string">'LocoFlags'</span>,<span class="string">'var'</span>) &amp; exist(<span class="string">'RINGData'</span>,<span class="string">'var'</span>));
0671 NoneExistFlag = (~exist(<span class="string">'LocoMeasData'</span>,<span class="string">'var'</span>) &amp; ~exist(<span class="string">'BPMData'</span>,<span class="string">'var'</span>) &amp; ~exist(<span class="string">'CMData'</span>,<span class="string">'var'</span>) &amp; ~exist(<span class="string">'LocoModel'</span>,<span class="string">'var'</span>) &amp; ~exist(<span class="string">'FitParameters'</span>,<span class="string">'var'</span>) &amp; ~exist(<span class="string">'LocoFlags'</span>,<span class="string">'var'</span>) &amp; ~exist(<span class="string">'RINGData'</span>,<span class="string">'var'</span>));
0672 
0673 <span class="keyword">if</span> NoneExistFlag
0674     fprintf(<span class="string">'   No LOCO variable found in this file\n\n'</span>);
0675     <span class="keyword">return</span>;
0676 <span class="keyword">end</span>
0677 
0678 fprintf(<span class="string">'   LocoModel will be recomputed\n'</span>);
0679 <span class="keyword">if</span> AllExistFlag
0680     <span class="comment">% Replace all variables (just like a OPEN)</span>
0681 <span class="keyword">else</span>
0682     <span class="comment">% Get filename and try to load</span>
0683     <span class="keyword">try</span>
0684         load(FileName);
0685     <span class="keyword">catch</span>
0686         fprintf(<span class="string">'   LOCO file does not exist or is not a *.mat file type\n\n'</span>);
0687         cla;
0688         <span class="keyword">return</span>
0689     <span class="keyword">end</span>
0690     
0691     <span class="comment">% Which iteration do you want to associate the measured response matrix with</span>
0692     <span class="keyword">if</span> length(CMData) &gt; 1
0693         <span class="keyword">for</span> i = 1:length(CMData)
0694             NumList{i} = num2str(i-1);
0695         <span class="keyword">end</span>
0696         IterNum = menu({<span class="string">'Which iteration # do you want the '</span>,<span class="string">'new data associated with?'</span>}, NumList);
0697         <span class="keyword">if</span> IterNum == 0
0698             fprintf(<span class="string">'   No change made to the measured response matrix\n\n'</span>);
0699             <span class="keyword">return</span>
0700         <span class="keyword">end</span>
0701     <span class="keyword">else</span>
0702         IterNum = 1;
0703     <span class="keyword">end</span>
0704     
0705     FitParameters = FitParameters(IterNum);
0706     BPMData = BPMData(IterNum);
0707     CMData = CMData(IterNum);
0708     <span class="comment">%LocoModel = LocoModel(IterNum);</span>
0709     LocoFlags = LocoFlags(IterNum);
0710 <span class="keyword">end</span>
0711 
0712 <span class="comment">% Write over with the new data</span>
0713 load(FileNameMeas);    
0714 
0715 
0716 <span class="comment">% Double check length of new variables (should be one if adding new variables)</span>
0717 <span class="keyword">if</span> ~AllExistFlag
0718     <span class="keyword">if</span> length(CMData) &gt; 1
0719         <span class="keyword">for</span> i = 1:length(CMData)
0720             NumList{i} = num2str(i-1);
0721         <span class="keyword">end</span>
0722         IterNum = menu({<span class="string">'New data has more than one iteration #'</span>,<span class="string">'Which iteration do you want to use?'</span>}, NumList);
0723         <span class="keyword">if</span> IterNum == 0
0724             fprintf(<span class="string">'   No change made to the LOCO input file.\n'</span>);
0725             <span class="keyword">return</span>
0726         <span class="keyword">end</span>
0727         
0728         NewFileFlag = questdlg({sprintf(<span class="string">'Only iteration #%d will be saved.'</span>,IterNum-1),<span class="string">'Do you want to change the LOCO file name?'</span>},<span class="string">'New Response Matrix'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0729         <span class="keyword">if</span> strcmp(NewFileFlag,<span class="string">'Yes'</span>)
0730             [FileName, PathName] = uiputfile(<span class="string">'*.mat'</span>, <span class="string">'New LOCO data file name'</span>);
0731             <span class="keyword">if</span> isequal(FileName,0) || isequal(PathName,0)
0732                 axes(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Axes1'</span>));
0733                 cla;
0734                 axes(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Axes2'</span>));
0735                 cla;
0736                 <span class="keyword">return</span>
0737             <span class="keyword">end</span>
0738             FileName = [PathName,FileName];
0739         <span class="keyword">end</span>
0740     <span class="keyword">else</span>
0741         IterNum = 1;
0742     <span class="keyword">end</span>
0743     
0744     FitParameters = FitParameters(IterNum);
0745     BPMData = BPMData(IterNum);
0746     CMData = CMData(IterNum);
0747     <span class="comment">%LocoModel = LocoModel(IterNum);</span>
0748     LocoFlags = LocoFlags(IterNum);
0749 <span class="keyword">end</span>
0750 
0751 <span class="keyword">try</span>
0752     LocoModel = [];   <span class="comment">% Clear the model because the RINGData, BPMData, or CMData may be different</span>
0753     [BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData] = <a href="locofilecheck.html" class="code" title="function [BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData] = locofilecheck(FileName)">locofilecheck</a>({BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData});
0754 <span class="keyword">catch</span>
0755     fprintf(<span class="string">'   There were problems with the input file, so no changes were made.\n'</span>);
0756     <span class="keyword">return</span>
0757 <span class="keyword">end</span>
0758 
0759 fprintf(<span class="string">'\n'</span>);
0760 
0761 save(FileName, <span class="string">'LocoModel'</span>, <span class="string">'FitParameters'</span>, <span class="string">'BPMData'</span>, <span class="string">'CMData'</span>, <span class="string">'RINGData'</span>, <span class="string">'LocoMeasData'</span>, <span class="string">'LocoFlags'</span>);
0762 setappdata(gcbf, <span class="string">'LocoDataCell'</span>, {BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData});
0763 
0764 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FileName'</span>),<span class="string">'Userdata'</span>,FileName);
0765 set(gcbf,<span class="string">'Name'</span>,[<span class="string">'LOCO:  '</span>,FileName]);
0766 
0767 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'HBPMIndex'</span>), <span class="string">'Userdata'</span>, []); 
0768 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'VBPMIndex'</span>), <span class="string">'Userdata'</span>, []); 
0769 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'HCMIndex'</span>), <span class="string">'Userdata'</span>, []); 
0770 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'VCMIndex'</span>), <span class="string">'Userdata'</span>, []); 
0771 
0772 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotIteration'</span>),<span class="string">'String'</span>,num2str([0:length(CMData)-1]'));
0773 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotIteration'</span>),<span class="string">'Value'</span>, length(CMData)); 
0774 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'StartFrom'</span>),<span class="string">'String'</span>,num2str([0:length(CMData)-1]'));
0775 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'StartFrom'</span>),<span class="string">'Value'</span>,length(CMData));
0776 
0777 <a href="#_sub24" class="code" title="subfunction varargout = MenuAxes_Callback(h, eventdata, handles, varargin)">MenuAxes_Callback</a>(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotMenu1'</span>));
0778 <a href="#_sub24" class="code" title="subfunction varargout = MenuAxes_Callback(h, eventdata, handles, varargin)">MenuAxes_Callback</a>(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotMenu2'</span>));
0779 
0780 
0781 <span class="comment">% --------------------------------------------------------------------</span>
0782 <a name="_sub12" href="#_subfunctions" class="code">function varargout = SaveAs_Callback(h, eventdata, handles, varargin)</a>
0783 
0784 <span class="comment">% Get filename and try to load</span>
0785 FileName = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FileName'</span>),<span class="string">'Userdata'</span>);
0786 <span class="keyword">if</span> isempty(FileName)
0787     fprintf(<span class="string">'   Old data file does not exist.\n'</span>);
0788     <span class="keyword">return</span>
0789 <span class="keyword">end</span>
0790 <span class="keyword">try</span>
0791     load(FileName);
0792 <span class="keyword">catch</span>
0793     fprintf(<span class="string">'   Old data file does not exist or is not a *.mat file type.\n'</span>);
0794     cla;
0795     <span class="keyword">return</span>
0796 <span class="keyword">end</span>
0797 
0798 <span class="keyword">if</span> strcmp(get(h,<span class="string">'Tag'</span>),<span class="string">'SaveAsLastIteration'</span>)
0799     <span class="keyword">if</span> length(CMData) &gt; 1
0800         <span class="keyword">for</span> i = 1:length(CMData)
0801             NumList{i} = num2str(i-1);
0802         <span class="keyword">end</span>
0803         
0804         IterNum = menu(<span class="string">'Which iteration #'</span>, NumList);
0805         <span class="keyword">if</span> IterNum == 0
0806             fprintf(<span class="string">'   Save aborted.\n'</span>);
0807             <span class="keyword">return</span>
0808         <span class="keyword">end</span>
0809 
0810         <span class="comment">% Always keep the first iteration</span>
0811         <span class="keyword">if</span> IterNum ~= 1
0812             IterNum = [1 IterNum];
0813         <span class="keyword">end</span>
0814         
0815         FitParameters = FitParameters(IterNum);
0816         BPMData = BPMData(IterNum);
0817         CMData = CMData(IterNum);
0818         LocoModel = LocoModel(IterNum);
0819         LocoFlags = LocoFlags(IterNum);
0820     <span class="keyword">end</span>
0821 <span class="keyword">end</span>
0822 
0823 [FileName, PathName] = uiputfile(<span class="string">'*.mat'</span>, <span class="string">'Loco data file name'</span>);
0824 <span class="keyword">if</span> isequal(FileName,0) || isequal(PathName,0)
0825     axes(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Axes1'</span>));
0826     cla;
0827     axes(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Axes2'</span>));
0828     cla;
0829     <span class="keyword">return</span>
0830 <span class="keyword">end</span>
0831 FileName = [PathName,FileName];
0832 
0833 save(FileName, <span class="string">'LocoModel'</span>, <span class="string">'FitParameters'</span>, <span class="string">'BPMData'</span>, <span class="string">'CMData'</span>, <span class="string">'RINGData'</span>, <span class="string">'LocoMeasData'</span>, <span class="string">'LocoFlags'</span>);
0834 setappdata(gcbf, <span class="string">'LocoDataCell'</span>, {BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData});
0835 
0836 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FileName'</span>),<span class="string">'Userdata'</span>,FileName);
0837 set(gcbf,<span class="string">'Name'</span>,[<span class="string">'LOCO:  '</span>,FileName]);
0838 
0839 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotIteration'</span>),<span class="string">'String'</span>,num2str([0:length(CMData)-1]'));
0840 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotIteration'</span>),<span class="string">'Value'</span>, length(CMData)); 
0841 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'StartFrom'</span>),<span class="string">'String'</span>,num2str([0:length(CMData)-1]'));
0842 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'StartFrom'</span>),<span class="string">'Value'</span>,length(CMData));
0843 
0844 <a href="#_sub24" class="code" title="subfunction varargout = MenuAxes_Callback(h, eventdata, handles, varargin)">MenuAxes_Callback</a>(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotMenu1'</span>));
0845 <a href="#_sub24" class="code" title="subfunction varargout = MenuAxes_Callback(h, eventdata, handles, varargin)">MenuAxes_Callback</a>(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotMenu2'</span>));
0846 
0847 
0848 <span class="comment">% --------------------------------------------------------------------</span>
0849 <a name="_sub13" href="#_subfunctions" class="code">function varargout = MenuUserInput_Callback(h, eventdata, handles, varargin)</a>
0850 AnswerString=inputdlg({<span class="string">'Which singular values:'</span>},<span class="string">'LOCO'</span>,1,{sprintf(<span class="string">'[%d:1]'</span>,1)});
0851 <span class="keyword">if</span> ~isempty(AnswerString); 
0852     Ivec = str2num(AnswerString{1}); 
0853     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'UserInput'</span>),<span class="string">'Userdata'</span>,Ivec); 
0854     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'UserInput'</span>),<span class="string">'Checked'</span>,<span class="string">'on'</span>); 
0855     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Rank'</span>),<span class="string">'Checked'</span>,<span class="string">'off'</span>);
0856     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Threshold'</span>),<span class="string">'Checked'</span>,<span class="string">'off'</span>); 
0857     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Interactive'</span>),<span class="string">'Checked'</span>,<span class="string">'off'</span>);
0858 <span class="keyword">end</span>
0859 
0860 <span class="comment">% --------------------------------------------------------------------</span>
0861 <a name="_sub14" href="#_subfunctions" class="code">function varargout = MenuThreshold_Callback(h, eventdata, handles, varargin)</a>
0862 Threshold = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Threshold'</span>),<span class="string">'Userdata'</span>); 
0863 
0864 AnswerString=inputdlg({<span class="string">'Threshold:'</span>},<span class="string">'LOCO'</span>,1,{num2str(Threshold)});
0865 <span class="keyword">if</span> ~isempty(AnswerString); 
0866     Threshold = str2num(AnswerString{1}); 
0867     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Threshold'</span>),<span class="string">'Label'</span>,[<span class="string">'Threshold ('</span>,num2str(Threshold),<span class="string">')'</span>]); 
0868     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Threshold'</span>),<span class="string">'Userdata'</span>,Threshold); 
0869     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'UserInput'</span>),<span class="string">'Checked'</span>,<span class="string">'off'</span>); 
0870     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Rank'</span>),<span class="string">'Checked'</span>,<span class="string">'off'</span>);
0871     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Threshold'</span>),<span class="string">'Checked'</span>,<span class="string">'on'</span>); 
0872     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Interactive'</span>),<span class="string">'Checked'</span>,<span class="string">'off'</span>);
0873 <span class="keyword">end</span>
0874 
0875 <span class="comment">% --------------------------------------------------------------------</span>
0876 <a name="_sub15" href="#_subfunctions" class="code">function varargout = Outlier_Callback(h, eventdata, handles, varargin)</a>
0877 OutlierFactor = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Outlier'</span>),<span class="string">'Userdata'</span>);
0878 
0879 AnswerString=inputdlg({<span class="string">'Outlier Factor: enter the # of sigma'</span>},<span class="string">'LOCO'</span>,1,{num2str(OutlierFactor)});
0880 <span class="keyword">if</span> ~isempty(AnswerString)
0881     OutlierFactor = str2num(AnswerString{1}); 
0882     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Outlier'</span>),<span class="string">'Label'</span>,[<span class="string">'Outlier Rejection ('</span>,num2str(OutlierFactor),<span class="string">' sigma)'</span>]); 
0883     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Outlier'</span>),<span class="string">'Userdata'</span>, OutlierFactor); 
0884     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Outlier'</span>),<span class="string">'Checked'</span>, <span class="string">'on'</span>); 
0885 <span class="keyword">end</span>
0886 
0887 
0888 <span class="comment">% --------------------------------------------------------------------</span>
0889 <a name="_sub16" href="#_subfunctions" class="code">function varargout = HorizontalDispersion_Callback(h, eventdata, handles, varargin)</a>
0890 HorizontalDispersionWeight = getappdata(gcbf, <span class="string">'HorizontalDispersionWeight'</span>);
0891 
0892 AnswerString = inputdlg({<span class="string">'Horizontal Dispersion Weight'</span>},<span class="string">'LOCO'</span>,1,{num2str(HorizontalDispersionWeight)});
0893 <span class="keyword">if</span> ~isempty(AnswerString)
0894     HorizontalDispersionWeight = abs(str2num(AnswerString{1})); 
0895     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'HorizontalDispersionWeight'</span>),<span class="string">'Label'</span>, sprintf(<span class="string">'    Weigh for Horizontal Dispersion = %f'</span>, HorizontalDispersionWeight)); 
0896     setappdata(gcbf,<span class="string">'HorizontalDispersionWeight'</span>, HorizontalDispersionWeight); 
0897 <span class="keyword">end</span>
0898 
0899 <span class="comment">% --------------------------------------------------------------------</span>
0900 <a name="_sub17" href="#_subfunctions" class="code">function varargout = VerticalDispersion_Callback(h, eventdata, handles, varargin)</a>
0901 VerticalDispersionWeight = getappdata(gcbf, <span class="string">'VerticalDispersionWeight'</span>);
0902 
0903 AnswerString = inputdlg({<span class="string">'Vertical Dispersion Weight'</span>},<span class="string">'LOCO'</span>,1,{num2str(VerticalDispersionWeight)});
0904 <span class="keyword">if</span> ~isempty(AnswerString)
0905     VerticalDispersionWeight = abs(str2num(AnswerString{1})); 
0906     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'VerticalDispersionWeight'</span>),<span class="string">'Label'</span>, sprintf(<span class="string">'    Weigh for Vertical     Dispersion = %f'</span>, VerticalDispersionWeight)); 
0907     setappdata(gcbf,<span class="string">'VerticalDispersionWeight'</span>, VerticalDispersionWeight); 
0908 <span class="keyword">end</span>
0909 
0910 
0911 <span class="comment">% --------------------------------------------------------------------</span>
0912 <a name="_sub18" href="#_subfunctions" class="code">function varargout = HBPMIndex_Callback(h, eventdata, handles, varargin)</a>
0913 
0914 LocoDataCell = getappdata(gcbf, <span class="string">'LocoDataCell'</span>);
0915 <span class="keyword">if</span> isempty(LocoDataCell)
0916     FileName = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FileName'</span>),<span class="string">'Userdata'</span>);
0917     <span class="keyword">if</span> isempty(FileName)
0918         fprintf(<span class="string">'   File does not exist.\n'</span>);
0919         <span class="keyword">return</span>
0920     <span class="keyword">end</span>
0921     <span class="keyword">try</span>
0922         load(FileName);
0923     <span class="keyword">catch</span>
0924         fprintf(<span class="string">'   File does not exist or is not a *.mat file type.\n'</span>);
0925         cla;
0926         <span class="keyword">return</span>
0927     <span class="keyword">end</span>
0928 <span class="keyword">else</span>
0929     BPMData = LocoDataCell{1};
0930 <span class="keyword">end</span>
0931 
0932 StartFrom = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'StartFrom'</span>),<span class="string">'Value'</span>);
0933 
0934 <span class="keyword">if</span> isempty(get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'HBPMIndex'</span>), <span class="string">'Userdata'</span>))
0935     Index = BPMData(StartFrom).HBPMGoodDataIndex;
0936 <span class="keyword">else</span>
0937     Index = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'HBPMIndex'</span>), <span class="string">'Userdata'</span>);
0938 <span class="keyword">end</span>
0939 
0940 Checked = zeros(size(BPMData(StartFrom).HBPMIndex));
0941 Checked(Index) = 1; 
0942 
0943 tmp = BPMData(StartFrom).BPMIndex(BPMData(StartFrom).HBPMIndex);
0944 Index = <a href="locoeditlist.html" class="code" title="function newList = locoeditlist(List, ListName, CheckList)">locoeditlist</a>([(1:length(BPMData(StartFrom).HBPMIndex))' tmp(:)], <span class="string">'BPM'</span>, Checked);
0945 Index = Index(:,1);
0946 
0947 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'HBPMIndex'</span>), <span class="string">'Userdata'</span>, Index); 
0948 
0949 <span class="comment">% --------------------------------------------------------------------</span>
0950 <a name="_sub19" href="#_subfunctions" class="code">function varargout = VBPMIndex_Callback(h, eventdata, handles, varargin)</a>
0951 
0952 LocoDataCell = getappdata(gcbf, <span class="string">'LocoDataCell'</span>);
0953 <span class="keyword">if</span> isempty(LocoDataCell)
0954     FileName = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FileName'</span>),<span class="string">'Userdata'</span>);
0955     <span class="keyword">if</span> isempty(FileName)
0956         fprintf(<span class="string">'   File does not exist.\n'</span>);
0957         <span class="keyword">return</span>
0958     <span class="keyword">end</span>
0959     <span class="keyword">try</span>
0960         load(FileName);
0961     <span class="keyword">catch</span>
0962         fprintf(<span class="string">'   File does not exist or is not a *.mat file type.\n'</span>);
0963         cla;
0964         <span class="keyword">return</span>
0965     <span class="keyword">end</span>
0966 <span class="keyword">else</span>
0967     BPMData = LocoDataCell{1};
0968 <span class="keyword">end</span>
0969 
0970 StartFrom = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'StartFrom'</span>),<span class="string">'Value'</span>);
0971 
0972 <span class="keyword">if</span> isempty(get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'VBPMIndex'</span>), <span class="string">'Userdata'</span>))
0973     Index = BPMData(StartFrom).VBPMGoodDataIndex;
0974 <span class="keyword">else</span>
0975     Index = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'VBPMIndex'</span>), <span class="string">'Userdata'</span>);
0976 <span class="keyword">end</span>
0977 
0978 Checked = zeros(size(BPMData(StartFrom).VBPMIndex));
0979 Checked(Index) = 1; 
0980 
0981 tmp = BPMData(StartFrom).BPMIndex(BPMData(StartFrom).VBPMIndex);
0982 Index = <a href="locoeditlist.html" class="code" title="function newList = locoeditlist(List, ListName, CheckList)">locoeditlist</a>([(1:length(BPMData(StartFrom).VBPMIndex))' tmp(:)], <span class="string">'BPM'</span>, Checked);
0983 Index = Index(:,1);
0984 
0985 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'VBPMIndex'</span>), <span class="string">'Userdata'</span>, Index); 
0986 
0987 
0988 <span class="comment">% --------------------------------------------------------------------</span>
0989 <a name="_sub20" href="#_subfunctions" class="code">function varargout = HCMIndex_Callback(h, eventdata, handles, varargin)</a>
0990 
0991 LocoDataCell = getappdata(gcbf, <span class="string">'LocoDataCell'</span>);
0992 <span class="keyword">if</span> isempty(LocoDataCell)
0993     FileName = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FileName'</span>),<span class="string">'Userdata'</span>);
0994     <span class="keyword">if</span> isempty(FileName)
0995         fprintf(<span class="string">'   File does not exist.\n'</span>);
0996         <span class="keyword">return</span>
0997     <span class="keyword">end</span>
0998     <span class="keyword">try</span>
0999         load(FileName);
1000     <span class="keyword">catch</span>
1001         fprintf(<span class="string">'   File does not exist or is not a *.mat file type.\n'</span>);
1002         cla;
1003         <span class="keyword">return</span>
1004     <span class="keyword">end</span>
1005 <span class="keyword">else</span>
1006     CMData = LocoDataCell{2};
1007 <span class="keyword">end</span>
1008 
1009 StartFrom = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'StartFrom'</span>),<span class="string">'Value'</span>);
1010 
1011 <span class="keyword">if</span> isempty(get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'HCMIndex'</span>), <span class="string">'Userdata'</span>))
1012     Index = CMData(StartFrom).HCMGoodDataIndex;
1013 <span class="keyword">else</span>
1014     Index = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'HCMIndex'</span>), <span class="string">'Userdata'</span>);
1015 <span class="keyword">end</span>
1016 
1017 Checked = zeros(size(CMData(StartFrom).HCMIndex));
1018 Checked(Index) = 1; 
1019 
1020 Index = <a href="locoeditlist.html" class="code" title="function newList = locoeditlist(List, ListName, CheckList)">locoeditlist</a>([(1:length(CMData(StartFrom).HCMIndex))'  CMData(StartFrom).HCMIndex(:)], <span class="string">'HCM'</span>, Checked);
1021 Index = Index(:,1);
1022 
1023 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'HCMIndex'</span>), <span class="string">'Userdata'</span>, Index); 
1024 
1025 
1026 <span class="comment">% --------------------------------------------------------------------</span>
1027 <a name="_sub21" href="#_subfunctions" class="code">function varargout = VCMIndex_Callback(h, eventdata, handles, varargin)</a>
1028 
1029 LocoDataCell = getappdata(gcbf, <span class="string">'LocoDataCell'</span>);
1030 <span class="keyword">if</span> isempty(LocoDataCell)
1031     FileName = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FileName'</span>),<span class="string">'Userdata'</span>);
1032     <span class="keyword">if</span> isempty(FileName)
1033         fprintf(<span class="string">'   File does not exist.\n'</span>);
1034         <span class="keyword">return</span>
1035     <span class="keyword">end</span>
1036     <span class="keyword">try</span>
1037         load(FileName);
1038     <span class="keyword">catch</span>
1039         fprintf(<span class="string">'   File does not exist or is not a *.mat file type.\n'</span>);
1040         cla;
1041         <span class="keyword">return</span>
1042     <span class="keyword">end</span>
1043 <span class="keyword">else</span>
1044     CMData = LocoDataCell{2};
1045 <span class="keyword">end</span>
1046 
1047 StartFrom = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'StartFrom'</span>),<span class="string">'Value'</span>);
1048 
1049 <span class="keyword">if</span> isempty(get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'VCMIndex'</span>), <span class="string">'Userdata'</span>))
1050     Index = CMData(StartFrom).VCMGoodDataIndex;
1051 <span class="keyword">else</span>
1052     Index = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'VCMIndex'</span>), <span class="string">'Userdata'</span>);
1053 <span class="keyword">end</span>
1054 
1055 Checked = zeros(size(CMData(StartFrom).VCMIndex));
1056 Checked(Index) = 1; 
1057 
1058 Index = <a href="locoeditlist.html" class="code" title="function newList = locoeditlist(List, ListName, CheckList)">locoeditlist</a>([(1:length(CMData(StartFrom).VCMIndex))'  CMData(StartFrom).VCMIndex(:)], <span class="string">'VCM'</span>, Checked);
1059 Index = Index(:,1);
1060 
1061 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'VCMIndex'</span>), <span class="string">'Userdata'</span>, Index); 
1062 
1063 
1064 <span class="comment">% --------------------------------------------------------------------</span>
1065 <a name="_sub22" href="#_subfunctions" class="code">function varargout = StartFrom_Callback(h, eventdata, handles, varargin)</a>
1066 LocoDataCell = getappdata(gcbf, <span class="string">'LocoDataCell'</span>);
1067 <span class="keyword">if</span> isempty(LocoDataCell)
1068     FileName = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FileName'</span>),<span class="string">'Userdata'</span>);
1069     <span class="keyword">if</span> isempty(FileName)
1070         fprintf(<span class="string">'   File does not exist.\n'</span>);
1071         <span class="keyword">return</span>
1072     <span class="keyword">end</span>
1073     <span class="keyword">try</span>
1074         load(FileName);
1075     <span class="keyword">catch</span>
1076         fprintf(<span class="string">'   File does not exist or is not a *.mat file type.\n'</span>);
1077         cla;
1078         <span class="keyword">return</span>
1079     <span class="keyword">end</span>
1080 <span class="keyword">else</span>
1081     BPMData       = LocoDataCell{1};
1082     CMData        = LocoDataCell{2};
1083     FitParameters = LocoDataCell{5};
1084     LocoFlags     = LocoDataCell{6};
1085 <span class="keyword">end</span>
1086 
1087 StartFrom = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'StartFrom'</span>),<span class="string">'Value'</span>) + 1;
1088 StartFromSize = size(get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'StartFrom'</span>),<span class="string">'String'</span>),1);
1089 <span class="keyword">if</span> StartFrom &gt; StartFromSize
1090     StartFrom = StartFromSize;
1091 <span class="keyword">end</span>
1092 <a href="#_sub23" class="code" title="subfunction setmenuinputs(BPMData, CMData, LocoFlags, FitParameters, handles)">setmenuinputs</a>(BPMData(StartFrom), CMData(StartFrom), LocoFlags(StartFrom), FitParameters(StartFrom), handles);
1093 
1094 
1095 <span class="comment">% --------------------------------------------------------------------</span>
1096 <a name="_sub23" href="#_subfunctions" class="code">function setmenuinputs(BPMData, CMData, LocoFlags, FitParameters, handles)</a>
1097 
1098 <span class="comment">% Set BPM Indexes</span>
1099 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'HBPMIndex'</span>), <span class="string">'Userdata'</span>, BPMData.HBPMGoodDataIndex);
1100 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'VBPMIndex'</span>), <span class="string">'Userdata'</span>, BPMData.VBPMGoodDataIndex);
1101 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'HCMIndex'</span>),  <span class="string">'Userdata'</span>, CMData.HCMGoodDataIndex);
1102 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'VCMIndex'</span>),  <span class="string">'Userdata'</span>, CMData.VCMGoodDataIndex);
1103 
1104 
1105 <span class="comment">% Set flags</span>
1106 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Rank'</span>),       <span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1107 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Threshold'</span>),  <span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1108 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Interactive'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1109 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'UserInput'</span>),  <span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1110 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Threshold'</span>),  <span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1111 <span class="keyword">if</span> strcmpi((LocoFlags.SVmethod),<span class="string">'rank'</span>)
1112     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Rank'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1113 <span class="keyword">elseif</span> length(LocoFlags.SVmethod) &gt; 1
1114     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'UserInput'</span>),<span class="string">'Userdata'</span>,LocoFlags.SVmethod); 
1115     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'UserInput'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1116 <span class="keyword">elseif</span>  length(LocoFlags.SVmethod) == 1
1117     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Threshold'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1118 <span class="keyword">elseif</span>  isempty(LocoFlags.SVmethod)
1119     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Interactive'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1120 <span class="keyword">else</span>
1121     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Threshold'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);    
1122 <span class="keyword">end</span>
1123 
1124 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Threshold'</span>),<span class="string">'Userdata'</span>, LocoFlags.Threshold);
1125 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Threshold'</span>),<span class="string">'Label'</span>,[<span class="string">'Threshold ('</span>,num2str(LocoFlags.Threshold),<span class="string">')'</span>]); 
1126 
1127 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Outlier'</span>),<span class="string">'Userdata'</span>,LocoFlags.OutlierFactor); 
1128 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Outlier'</span>),<span class="string">'Label'</span>,[<span class="string">'Outlier Rejection ('</span>,num2str(LocoFlags.OutlierFactor),<span class="string">' sigma)'</span>]); 
1129 
1130 setappdata(gcbf,<span class="string">'HorizontalDispersionWeight'</span>, LocoFlags.HorizontalDispersionWeight);
1131 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'HorizontalDispersionWeight'</span>),<span class="string">'Label'</span>, sprintf(<span class="string">'    Weight for Horizontal Dispersion = %f'</span>, LocoFlags.HorizontalDispersionWeight)); 
1132 
1133 setappdata(gcbf,<span class="string">'VerticalDispersionWeight'</span>, LocoFlags.VerticalDispersionWeight);
1134 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'VerticalDispersionWeight'</span>),<span class="string">'Label'</span>, sprintf(<span class="string">'    Weight for Vertical     Dispersion = %f'</span>, LocoFlags.VerticalDispersionWeight)); 
1135 
1136 <span class="keyword">if</span> ischar(LocoFlags.Coupling)
1137     <span class="keyword">if</span> strcmpi((LocoFlags.Coupling),<span class="string">'yes'</span>)
1138         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Coupling'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1139     <span class="keyword">else</span>
1140         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Coupling'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1141     <span class="keyword">end</span>
1142 <span class="keyword">end</span>
1143 
1144 <span class="keyword">if</span> ischar(LocoFlags.AutoCorrectDelta)
1145     <span class="keyword">if</span> strcmpi((LocoFlags.AutoCorrectDelta),<span class="string">'yes'</span>)
1146         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'AutoCorrect'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1147     <span class="keyword">else</span>
1148         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'AutoCorrect'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1149     <span class="keyword">end</span>
1150 <span class="keyword">end</span>
1151 
1152 <span class="keyword">if</span> ischar(LocoFlags.Normalization.Flag)
1153     <span class="keyword">if</span> strcmpi((LocoFlags.Normalization.Flag),<span class="string">'yes'</span>)
1154         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Normalize'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1155     <span class="keyword">else</span>
1156         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Normalize'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1157     <span class="keyword">end</span>
1158 <span class="keyword">end</span>
1159 
1160 <span class="keyword">if</span> ischar(LocoFlags.Dispersion)
1161     <span class="keyword">if</span> strcmpi((LocoFlags.Dispersion),<span class="string">'yes'</span>)
1162         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Dispersion'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1163     <span class="keyword">else</span>
1164         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Dispersion'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1165     <span class="keyword">end</span>
1166 <span class="keyword">end</span>
1167 
1168 <span class="keyword">if</span> ischar(CMData.FitHCMEnergyShift)
1169     <span class="keyword">if</span> strcmpi((CMData.FitHCMEnergyShift),<span class="string">'yes'</span>)
1170         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FitHCMEnergyShift'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1171     <span class="keyword">else</span>
1172         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FitHCMEnergyShift'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1173     <span class="keyword">end</span>
1174 <span class="keyword">end</span>
1175 
1176 <span class="keyword">if</span> ischar(CMData.FitVCMEnergyShift)
1177     <span class="keyword">if</span> strcmpi((CMData.FitVCMEnergyShift),<span class="string">'yes'</span>)
1178         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FitVCMEnergyShift'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1179     <span class="keyword">else</span>
1180         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FitVCMEnergyShift'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1181     <span class="keyword">end</span>
1182 <span class="keyword">end</span>
1183 
1184 <span class="keyword">if</span> ischar(LocoFlags.ResponseMatrixCalculator)
1185     <span class="keyword">if</span> strcmpi((LocoFlags.ResponseMatrixCalculator),<span class="string">'linear'</span>)
1186         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Linear'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1187         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Full'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1188     <span class="keyword">else</span> <span class="comment">%strcmpi((LocoFlags.ResponseMatrixCalculator),'full')</span>
1189         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Linear'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1190         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'Full'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1191     <span class="keyword">end</span>
1192 <span class="keyword">end</span>
1193 
1194 <span class="keyword">if</span> ischar(LocoFlags.ClosedOrbitType)
1195     <span class="keyword">if</span> strcmpi((LocoFlags.ClosedOrbitType),<span class="string">'fixedmomentum'</span>)
1196         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'CM'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1197         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'CPL'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1198     <span class="keyword">else</span> <span class="comment">%strcmpi((LocoFlags.ClosedOrbitType),'fixedpathlength')</span>
1199         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'CM'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1200         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'CPL'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1201     <span class="keyword">end</span>
1202 <span class="keyword">end</span>
1203     
1204 <span class="keyword">if</span> ischar(LocoFlags.ResponseMatrixMeasurement)
1205     <span class="keyword">if</span> strcmpi((LocoFlags.ResponseMatrixMeasurement),<span class="string">'bidirectional'</span>)
1206         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'RespMatBiDirectional'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1207         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'RespMatOneWay'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1208     <span class="keyword">else</span> <span class="comment">%strcmpi((LocoFlags.ResponseMatrixMeasurement),'oneway')</span>
1209         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'RespMatBiDirectional'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1210         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'RespMatOneWay'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1211     <span class="keyword">end</span>
1212 <span class="keyword">end</span>
1213 
1214 <span class="keyword">if</span> ischar(LocoFlags.DispersionMeasurement)
1215     <span class="keyword">if</span> strcmpi((LocoFlags.DispersionMeasurement),<span class="string">'bidirectional'</span>)
1216         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'DispBiDirectional'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1217         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'DispOneWay'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1218     <span class="keyword">else</span> <span class="comment">%strcmpi((LocoFlags.DispersionMeasurement),'oneway')</span>
1219         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'DispBiDirectional'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1220         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'DispOneWay'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1221     <span class="keyword">end</span>
1222 <span class="keyword">end</span>
1223 
1224 <span class="keyword">if</span> isfield(LocoFlags, <span class="string">'CalculateSigma'</span>)
1225     <span class="keyword">if</span> ischar(LocoFlags.CalculateSigma)
1226         <span class="keyword">if</span> strcmpi(LocoFlags.CalculateSigma, <span class="string">'Yes'</span>)
1227             set(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'ErrorBars'</span>),<span class="string">'Checked'</span>,<span class="string">'on'</span>);
1228         <span class="keyword">else</span>
1229             set(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'ErrorBars'</span>),<span class="string">'Checked'</span>,<span class="string">'off'</span>);
1230         <span class="keyword">end</span>
1231     <span class="keyword">end</span>
1232 <span class="keyword">end</span>
1233 
1234 <span class="keyword">if</span> isfield(LocoFlags, <span class="string">'SinglePrecision'</span>)
1235     <span class="keyword">if</span> ischar(LocoFlags.SinglePrecision)
1236         <span class="keyword">if</span> strcmpi(LocoFlags.SinglePrecision, <span class="string">'Yes'</span>)
1237             set(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'SinglePrecision'</span>),<span class="string">'Checked'</span>,<span class="string">'on'</span>);
1238         <span class="keyword">else</span>
1239             set(findobj(gcf,<span class="string">'Tag'</span>,<span class="string">'SinglePrecision'</span>),<span class="string">'Checked'</span>,<span class="string">'off'</span>);
1240         <span class="keyword">end</span>
1241     <span class="keyword">end</span>
1242 <span class="keyword">end</span>
1243 
1244 <span class="keyword">if</span> ~isempty(LocoFlags.SVDDataFileName) &amp;&amp; ischar(LocoFlags.SVDDataFileName)
1245     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SVD_FileName'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1246     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SVD_FileName'</span>),<span class="string">'Userdata'</span>,LocoFlags.SVDDataFileName);   
1247     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SVD_FileName'</span>),<span class="string">'Label'</span>,[<span class="string">'Save A,S,V,U,CovFit to File: '</span>, LocoFlags.SVDDataFileName]);
1248 <span class="keyword">else</span>
1249     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SVD_FileName'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1250     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SVD_FileName'</span>),<span class="string">'Userdata'</span>,[]);    
1251     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SVD_FileName'</span>),<span class="string">'Label'</span>,[<span class="string">'Save A,S,V,U,CovFit to File: '</span>, LocoFlags.SVDDataFileName]);
1252     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SVD_FileName'</span>),<span class="string">'Label'</span>,[<span class="string">'Save A,S,V,U,CovFit to File'</span>]);
1253 <span class="keyword">end</span>
1254 
1255 <span class="keyword">if</span> ischar(FitParameters.FitRFFrequency)
1256     <span class="keyword">if</span> strcmpi((FitParameters.FitRFFrequency),<span class="string">'yes'</span>)
1257         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FitRF'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1258     <span class="keyword">else</span>
1259         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FitRF'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1260     <span class="keyword">end</span>
1261 <span class="keyword">end</span>
1262 
1263 <span class="keyword">if</span> ischar(BPMData.FitGains)
1264     <span class="keyword">if</span> strcmpi((BPMData.FitGains),<span class="string">'yes'</span>)
1265         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'BPMGains'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1266     <span class="keyword">else</span>
1267         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'BPMGains'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1268     <span class="keyword">end</span>
1269 <span class="keyword">end</span>
1270 
1271 <span class="keyword">if</span> ischar(BPMData.FitCoupling)
1272     <span class="keyword">if</span> strcmpi((BPMData.FitCoupling),<span class="string">'yes'</span>)
1273         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'BPMCoupling'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1274     <span class="keyword">else</span>
1275         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'BPMCoupling'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1276     <span class="keyword">end</span>
1277 <span class="keyword">end</span>
1278 
1279 <span class="keyword">if</span> ischar(CMData.FitKicks)
1280     <span class="keyword">if</span> strcmpi((CMData.FitKicks),<span class="string">'yes'</span>)
1281         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'CMKicks'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1282     <span class="keyword">else</span>
1283         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'CMKicks'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1284     <span class="keyword">end</span>
1285 <span class="keyword">end</span>
1286 
1287 <span class="keyword">if</span> ischar(CMData.FitCoupling)
1288     <span class="keyword">if</span> strcmpi((CMData.FitCoupling),<span class="string">'yes'</span>)
1289         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'CMRolls'</span>),<span class="string">'Checked'</span>,<span class="string">'On'</span>);
1290     <span class="keyword">else</span>
1291         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'CMRolls'</span>),<span class="string">'Checked'</span>,<span class="string">'Off'</span>);
1292     <span class="keyword">end</span>
1293 <span class="keyword">end</span>
1294 
1295 <span class="keyword">if</span> isfield(LocoFlags,<span class="string">'Method'</span>)
1296     <span class="keyword">if</span> strcmpi(LocoFlags.Method.Name, <span class="string">'Gauss-Newton'</span>)
1297         set(handles.GaussNewton,             <span class="string">'Checked'</span>,<span class="string">'on'</span>);
1298         set(handles.GaussNewtonWithCost,     <span class="string">'Checked'</span>,<span class="string">'off'</span>);
1299         set(handles.LevenbergMarquardt,      <span class="string">'Checked'</span>,<span class="string">'off'</span>);
1300         set(handles.ScaledLevenbergMarquardt,<span class="string">'Checked'</span>,<span class="string">'off'</span>);
1301         set(handles.CostScaleFactor, <span class="string">'Enable'</span>,<span class="string">'off'</span>);
1302         set(handles.LambdaLM,        <span class="string">'Enable'</span>,<span class="string">'off'</span>);
1303         set(handles.MaxIterLM,       <span class="string">'Enable'</span>,<span class="string">'off'</span>);
1304     <span class="keyword">elseif</span> strcmpi(LocoFlags.Method.Name, <span class="string">'Gauss-Newton With Cost Function'</span>)
1305         set(handles.GaussNewton,             <span class="string">'Checked'</span>,<span class="string">'off'</span>);
1306         set(handles.GaussNewtonWithCost,     <span class="string">'Checked'</span>,<span class="string">'on'</span>);
1307         set(handles.LevenbergMarquardt,      <span class="string">'Checked'</span>,<span class="string">'off'</span>);
1308         set(handles.ScaledLevenbergMarquardt,<span class="string">'Checked'</span>,<span class="string">'off'</span>);
1309         set(handles.CostScaleFactor, <span class="string">'Enable'</span>,<span class="string">'on'</span>);
1310         set(handles.LambdaLM,        <span class="string">'Enable'</span>,<span class="string">'off'</span>);
1311         set(handles.MaxIterLM,       <span class="string">'Enable'</span>,<span class="string">'off'</span>);
1312     <span class="keyword">elseif</span> strcmpi(LocoFlags.Method.Name, <span class="string">'Levenberg-Marquardt'</span>)
1313         set(handles.GaussNewton,             <span class="string">'Checked'</span>,<span class="string">'off'</span>);
1314         set(handles.GaussNewtonWithCost,     <span class="string">'Checked'</span>,<span class="string">'off'</span>);
1315         set(handles.LevenbergMarquardt,      <span class="string">'Checked'</span>,<span class="string">'on'</span>);
1316         set(handles.ScaledLevenbergMarquardt,<span class="string">'Checked'</span>,<span class="string">'off'</span>);
1317         set(handles.CostScaleFactor, <span class="string">'Enable'</span>,<span class="string">'off'</span>);
1318         set(handles.LambdaLM,        <span class="string">'Enable'</span>,<span class="string">'on'</span>);
1319         set(handles.MaxIterLM,       <span class="string">'Enable'</span>,<span class="string">'on'</span>);
1320     <span class="keyword">elseif</span> strcmpi(LocoFlags.Method.Name, <span class="string">'Scaled Levenberg-Marquardt'</span>)
1321         set(handles.GaussNewton,             <span class="string">'Checked'</span>,<span class="string">'off'</span>);
1322         set(handles.GaussNewtonWithCost,     <span class="string">'Checked'</span>,<span class="string">'off'</span>);
1323         set(handles.LevenbergMarquardt,      <span class="string">'Checked'</span>,<span class="string">'off'</span>);
1324         set(handles.ScaledLevenbergMarquardt,<span class="string">'Checked'</span>,<span class="string">'on'</span>);
1325         set(handles.CostScaleFactor, <span class="string">'Enable'</span>,<span class="string">'off'</span>);
1326         set(handles.LambdaLM,        <span class="string">'Enable'</span>,<span class="string">'on'</span>);
1327         set(handles.MaxIterLM,       <span class="string">'Enable'</span>,<span class="string">'on'</span>);
1328     <span class="keyword">end</span>
1329 
1330     <span class="keyword">if</span> isfield(LocoFlags(end),<span class="string">'Method'</span>) &amp;&amp; isfield(LocoFlags.Method,<span class="string">'Lambda'</span>) &amp;&amp;  ~isempty(LocoFlags.Method.Lambda)
1331         set(handles.LambdaLM, <span class="string">'Userdata'</span>, LocoFlags.Method.Lambda);
1332         set(handles.MaxIterLM,<span class="string">'Userdata'</span>, LocoFlags.Method.MaxIter);
1333     <span class="keyword">end</span>
1334     set(handles.LambdaLM, <span class="string">'Label'</span>,[<span class="string">'    Lambda = '</span>,num2str(get(handles.LambdaLM, <span class="string">'Userdata'</span>))]);
1335     set(handles.MaxIterLM,<span class="string">'Label'</span>,[<span class="string">'    Maximum Iterations = '</span>,num2str(get(handles.MaxIterLM,<span class="string">'Userdata'</span>))]);
1336 
1337     <span class="keyword">if</span> isfield(LocoFlags,<span class="string">'Method'</span>) &amp;&amp; isfield(LocoFlags.Method,<span class="string">'CostScaleFactor'</span>) &amp;&amp;  ~isempty(LocoFlags.Method.CostScaleFactor)
1338         set(handles.CostScaleFactor, <span class="string">'Userdata'</span>, LocoFlags.Method.CostScaleFactor);
1339     <span class="keyword">end</span>
1340     set(handles.CostScaleFactor, <span class="string">'Label'</span>,[<span class="string">'    Cost Scale Factor = '</span>,num2str(get(handles.CostScaleFactor, <span class="string">'Userdata'</span>))]);
1341 <span class="keyword">end</span>
1342 
1343 
1344 <span class="comment">% --------------------------------------------------------------------</span>
1345 <a name="_sub24" href="#_subfunctions" class="code">function varargout = MenuAxes_Callback(h, eventdata, handles, varargin)</a>
1346 
1347 <span class="keyword">if</span> nargin &gt; 1 
1348     setappdata(gcbf,<span class="string">'OtherParameterPlot1'</span>,[]);
1349     setappdata(gcbf,<span class="string">'OtherParameterPlot2'</span>,[]);
1350 <span class="keyword">end</span>
1351 
1352 TagString = get(h,<span class="string">'Userdata'</span>);            <span class="comment">% Axis tag is storage in the menu pulldown</span>
1353 PlotNumber = get(h,<span class="string">'Value'</span>);
1354 h_axis = findobj(gcbf,<span class="string">'Tag'</span>,TagString);
1355 axes(h_axis);
1356 <a href="#_sub25" class="code" title="subfunction locoplots(PlotNumber, FieldName)">locoplots</a>(PlotNumber);
1357 set(h_axis,<span class="string">'Tag'</span>,TagString);                 <span class="comment">% axes tag is lost if plot function is used</span>
1358 set(h_axis,<span class="string">'HandleVisibility'</span>,<span class="string">'Callback'</span>);   <span class="comment">% So no one else can plot to it.</span>
1359 <span class="comment">%axes(h_axis);</span>
1360 <span class="comment">%legend</span>
1361 <span class="comment">%set(gca,'Tag',TagString);                 % axes tag is lost if plot function is used</span>
1362 <span class="comment">%set(gca,'HandleVisibility','Callback');   % So no one else can plot to it.</span>
1363 
1364 
1365 <span class="comment">% -------------------------------------------------------------------</span>
1366 <a name="_sub25" href="#_subfunctions" class="code">function locoplots(PlotNumber, FieldName)</a>
1367 
1368 <span class="comment">% Save the current axes</span>
1369 H_Axes = gca;
1370 
1371 <span class="keyword">if</span> nargin &lt; 2
1372     FieldName = [];
1373 <span class="keyword">end</span>
1374 
1375 LocoDataCell = getappdata(gcbf, <span class="string">'LocoDataCell'</span>);
1376 <span class="keyword">if</span> isempty(LocoDataCell)
1377     FileName = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FileName'</span>),<span class="string">'Userdata'</span>);
1378     <span class="keyword">if</span> isempty(FileName)
1379         fprintf(<span class="string">'   File does not exist.\n'</span>);
1380         <span class="keyword">return</span>
1381     <span class="keyword">end</span>
1382     <span class="keyword">try</span>
1383         load(FileName);
1384     <span class="keyword">catch</span>
1385         fprintf(<span class="string">'   File does not exist or is not a *.mat file type.\n'</span>);
1386         cla;
1387         <span class="keyword">return</span>
1388     <span class="keyword">end</span>
1389 <span class="keyword">else</span>
1390     BPMData       = LocoDataCell{1};
1391     CMData        = LocoDataCell{2};
1392     LocoMeasData  = LocoDataCell{3};
1393     LocoModel     = LocoDataCell{4};
1394     FitParameters = LocoDataCell{5};
1395     LocoFlags     = LocoDataCell{6};
1396     RINGData      = LocoDataCell{7};
1397 <span class="keyword">end</span>
1398 
1399 <span class="comment">% Get the iteration number to plot</span>
1400 i = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotIteration'</span>),<span class="string">'Value'</span>);  <span class="comment">% The first point in the array is starting point</span>
1401 
1402 
1403 <span class="comment">% If the LocoModel does not exist, then compute it</span>
1404 <span class="keyword">if</span> isempty(LocoModel(i).M) || isempty(LocoModel(i).ChiSquare)
1405     AxesTag = get(H_Axes,<span class="string">'Tag'</span>);
1406     [LocoModel(i).M, LocoModel(i).Eta, LocoModel(i).ChiSquare] = <a href="#_sub32" class="code" title="subfunction [Mmodel, Dispersion, ChiSquare] = getmodelresponsematrix(BPMData, CMData, FitParameters, LocoFlags, LocoMeasData, RINGData)">getmodelresponsematrix</a>(BPMData(i), CMData(i), FitParameters(i), LocoFlags(i), LocoMeasData, RINGData);
1407     FileName = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FileName'</span>),<span class="string">'Userdata'</span>);
1408     save(FileName, <span class="string">'LocoModel'</span>, <span class="string">'FitParameters'</span>, <span class="string">'BPMData'</span>, <span class="string">'CMData'</span>, <span class="string">'RINGData'</span>, <span class="string">'LocoMeasData'</span>, <span class="string">'LocoFlags'</span>);
1409     setappdata(gcbf, <span class="string">'LocoDataCell'</span>, {BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData});
1410     set(H_Axes, <span class="string">'Tag'</span>, AxesTag);
1411 <span class="keyword">end</span>
1412 
1413 
1414 <span class="comment">% Compute Chi2 verses parameter and save data</span>
1415 <span class="keyword">if</span> PlotNumber == 16
1416     <span class="keyword">if</span> ~isfield(LocoFlags(i),<span class="string">'Method'</span>) || ~isfield(LocoFlags(i).Method,<span class="string">'DeltaChi2'</span>) || ~isfield(LocoFlags(i).Method.DeltaChi2,<span class="string">'FitParameter'</span>) <span class="keyword">...</span>
1417             || isempty(LocoFlags(i).Method.DeltaChi2.FitParameter) || length(LocoFlags(i).Method.DeltaChi2.FitParameter)~=length(FitParameters(i).Values)
1418         LocoFlags(i).Method.DeltaChi2 = <a href="lococalcdeltachi2.html" class="code" title="function [dChi2_FitParameter, dChi2_FitParameterGroup, dChi2_BPMGroup, dChi2_CMGroup, Chi2_Nominal] = lococalcdeltachi2(varargin)">lococalcdeltachi2</a>(LocoModel, LocoMeasData, BPMData, CMData, FitParameters, LocoFlags, RINGData,i-1, <span class="string">'Display'</span>);
1419         FileName = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FileName'</span>),<span class="string">'Userdata'</span>);
1420         save(FileName, <span class="string">'LocoModel'</span>, <span class="string">'FitParameters'</span>, <span class="string">'BPMData'</span>, <span class="string">'CMData'</span>, <span class="string">'RINGData'</span>, <span class="string">'LocoMeasData'</span>, <span class="string">'LocoFlags'</span>);
1421         setappdata(gcbf, <span class="string">'LocoDataCell'</span>, {BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData});
1422     <span class="keyword">end</span>
1423 <span class="keyword">end</span>
1424 
1425 
1426 <span class="comment">% Patch for a iteration zero bug fixed on 1-29-2004</span>
1427 NHBPM = length(BPMData(i).HBPMGoodDataIndex);
1428 NVBPM = length(BPMData(i).VBPMGoodDataIndex);
1429 NBPM  = NHBPM + NVBPM;
1430 NHCM = length(CMData(i).HCMGoodDataIndex);
1431 NVCM = length(CMData(i).VCMGoodDataIndex);
1432 <span class="keyword">if</span> any(size(LocoModel(i).M) ~= [NBPM NHCM+NVCM])
1433     AxesTag = get(H_Axes,<span class="string">'Tag'</span>);
1434     [LocoModel(i).M, LocoModel(i).Eta, LocoModel(i).ChiSquare] = <a href="#_sub32" class="code" title="subfunction [Mmodel, Dispersion, ChiSquare] = getmodelresponsematrix(BPMData, CMData, FitParameters, LocoFlags, LocoMeasData, RINGData)">getmodelresponsematrix</a>(BPMData(i), CMData(i), FitParameters(i), LocoFlags(i), LocoMeasData, RINGData);
1435     FileName = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FileName'</span>),<span class="string">'Userdata'</span>);
1436     save(FileName, <span class="string">'LocoModel'</span>, <span class="string">'FitParameters'</span>, <span class="string">'BPMData'</span>, <span class="string">'CMData'</span>, <span class="string">'RINGData'</span>, <span class="string">'LocoMeasData'</span>, <span class="string">'LocoFlags'</span>);
1437     setappdata(gcbf, <span class="string">'LocoDataCell'</span>, {BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData});
1438     set(H_Axes, <span class="string">'Tag'</span>, AxesTag);
1439 <span class="keyword">end</span>
1440 
1441 Mmodel = LocoModel(i).M;
1442 
1443 <span class="comment">% Clear content menu</span>
1444 set(H_Axes, <span class="string">'UIContextMenu'</span>, []);
1445 
1446 legend off
1447 
1448 <span class="keyword">try</span>
1449     <span class="keyword">switch</span> PlotNumber
1450         <span class="keyword">case</span> 1
1451             plot(H_Axes,[0 1],[0 1],<span class="string">'w'</span>);
1452             title(H_Axes,<span class="string">'LOCO Input Parameter'</span>);
1453             set(H_Axes,<span class="string">'box'</span>,<span class="string">'on'</span>);
1454             set(H_Axes,<span class="string">'XTick'</span>,[]);
1455             set(H_Axes,<span class="string">'YTick'</span>,[]);
1456             
1457             N = 1;
1458             <span class="keyword">if</span> exist(<span class="string">'LocoFlags'</span>,<span class="string">'var'</span>)
1459                 <span class="keyword">if</span> ~isempty(LocoFlags)
1460                     
1461                     <span class="keyword">if</span> isfield(LocoFlags(i), <span class="string">'SinglePrecision'</span>)
1462                         <span class="keyword">if</span> ischar(LocoFlags(i).SinglePrecision)
1463                             text(2,N,sprintf(<span class="string">'Single Precision = %s'</span>, LocoFlags(i).SinglePrecision),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1464                             N = N + 1;
1465                         <span class="keyword">end</span>
1466                     <span class="keyword">end</span>
1467 
1468                     <span class="keyword">if</span> isfield(LocoFlags(i), <span class="string">'CalculateSigma'</span>)
1469                         <span class="keyword">if</span> ischar(LocoFlags(i).CalculateSigma)
1470                             text(2,N,sprintf(<span class="string">'Calculate Error Bars = %s'</span>, LocoFlags(i).CalculateSigma),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1471                             N = N + 1;
1472                         <span class="keyword">end</span>
1473                     <span class="keyword">end</span>
1474                     
1475                     <span class="keyword">if</span> isfield(LocoFlags(i),<span class="string">'Dispersion'</span>)
1476                         text(2,N,sprintf(<span class="string">'Include Dispersion = %s'</span>, LocoFlags(i).Dispersion),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1477                         N = N + 1;
1478                     <span class="keyword">end</span>
1479                     <span class="keyword">if</span> isfield(LocoFlags(i),<span class="string">'AutoCorrectDelta'</span>)
1480                         text(2,N,sprintf(<span class="string">'Auto Correct Deltas = %s'</span>, LocoFlags(i).AutoCorrectDelta),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1481                         N = N + 1;
1482                     <span class="keyword">end</span>
1483                     <span class="keyword">if</span> isfield(LocoFlags(i),<span class="string">'Coupling'</span>)
1484                         text(2,N,sprintf(<span class="string">'Include Off-Diagonal Terms = %s'</span>, LocoFlags(i).Coupling),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1485                         N = N + 1;
1486                     <span class="keyword">end</span>
1487                     <span class="keyword">if</span> isfield(LocoFlags(i),<span class="string">'ResponseMatrixCalculator'</span>)
1488                         text(2,N,sprintf(<span class="string">'Response Matrix Calculator = %s'</span>, LocoFlags(i).ResponseMatrixCalculator),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1489                         N = N + 1;
1490                     <span class="keyword">end</span>
1491                     <span class="keyword">if</span> isfield(LocoFlags(i),<span class="string">'ClosedOrbitType'</span>)
1492                         text(2,N,sprintf(<span class="string">'Response Matrix Closed Orbit = %s'</span>, LocoFlags(i).ClosedOrbitType),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1493                         N = N + 1;
1494                     <span class="keyword">end</span>
1495                     <span class="keyword">if</span> isfield(LocoFlags(i),<span class="string">'SVmethod'</span>)
1496                         <span class="keyword">if</span> isempty(LocoFlags(i))
1497                             text(2,N,sprintf(<span class="string">'Singular Value Selection = '</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1498                         <span class="keyword">elseif</span> isempty(LocoFlags(i).SVmethod)
1499                             text(2,N,sprintf(<span class="string">'Singular Value Selection = Interactive'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1500                         <span class="keyword">elseif</span> strcmpi((LocoFlags(i).SVmethod),<span class="string">'rank'</span>)
1501                             text(2,N,sprintf(<span class="string">'Singular Value Selection = Rank'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1502                         <span class="keyword">elseif</span> length(LocoFlags(i).SVmethod) &gt; 1
1503                             text(2,N,sprintf(<span class="string">'Singular Value Selection = User Input'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1504                         <span class="keyword">else</span>   
1505                             text(2,N,sprintf(<span class="string">'Singular Value Selection = Threshold (%f)'</span>,LocoFlags(i).Threshold),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1506                         <span class="keyword">end</span>
1507                         N = N + 1;
1508                     <span class="keyword">end</span>
1509                     <span class="keyword">if</span> isfield(LocoFlags(i),<span class="string">'Normalize'</span>)
1510                         text(2,N,sprintf(<span class="string">'Normalize = %s'</span>, LocoFlags(i).Normalization.Flag),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1511                         N = N + 1;
1512                     <span class="keyword">end</span>
1513                 <span class="keyword">end</span>
1514             <span class="keyword">end</span>    
1515             <span class="keyword">if</span> isfield(FitParameters(i),<span class="string">'FitRFFrequency'</span>)
1516                 text(2,N,sprintf(<span class="string">'Fit RF Frequency = %s'</span>, FitParameters(i).FitRFFrequency),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1517                 N = N + 1;
1518             <span class="keyword">end</span>
1519             <span class="keyword">if</span> isfield(CMData(i),<span class="string">'FitVCMEnergyShift'</span>)
1520                 text(2,N,sprintf(<span class="string">'Fit Energy Shifts at VCM = %s'</span>, CMData(i).FitVCMEnergyShift),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1521                 N = N + 1;
1522             <span class="keyword">end</span>
1523             <span class="keyword">if</span> isfield(CMData(i),<span class="string">'FitHCMEnergyShift'</span>)
1524                 text(2,N,sprintf(<span class="string">'Fit Energy Shifts at HCM = %s'</span>, CMData(i).FitHCMEnergyShift),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1525                 N = N + 1;
1526             <span class="keyword">end</span>
1527             <span class="keyword">if</span> isfield(CMData(i),<span class="string">'FitKicks'</span>)
1528                 text(2,N,sprintf(<span class="string">'Fit Corrector Magnet Gains = %s'</span>, CMData(i).FitKicks),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1529                 N = N + 1;
1530             <span class="keyword">end</span>
1531             <span class="keyword">if</span> isfield(CMData(i),<span class="string">'FitCoupling'</span>)
1532                 text(2,N,sprintf(<span class="string">'Fit Corrector Magnet Rolls = %s'</span>, CMData(i).FitCoupling),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1533                 N = N + 1;
1534             <span class="keyword">end</span>
1535             <span class="keyword">if</span> isfield(BPMData(i),<span class="string">'FitGains'</span>)
1536                 text(2,N,sprintf(<span class="string">'Fit BPM Gains = %s'</span>, BPMData(i).FitGains),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1537                 N = N + 1;
1538             <span class="keyword">end</span>
1539             <span class="keyword">if</span> isfield(BPMData(i),<span class="string">'FitCoupling'</span>)
1540                 text(2,N,sprintf(<span class="string">'Fit BPM Coupling = %s'</span>, BPMData(i).FitCoupling),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1541                 N = N + 1;
1542             <span class="keyword">end</span>    
1543             <span class="keyword">if</span> isfield(CMData(i),<span class="string">'VCMGoodDataIndex'</span>)
1544                 text(2,N,sprintf(<span class="string">'%d horizontal %d vertical CMs'</span>, length(CMData(i).HCMGoodDataIndex), length(CMData(i).VCMGoodDataIndex)),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1545                 N = N + 1;
1546             <span class="keyword">end</span>
1547             <span class="keyword">if</span> isfield(BPMData(i),<span class="string">'HBPMGoodDataIndex'</span>)
1548                 text(2,N,sprintf(<span class="string">'%d horizontal %d vertical BPMs'</span>, length(BPMData(i).HBPMGoodDataIndex), length(BPMData(i).VBPMGoodDataIndex)),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1549                 N = N + 1;
1550             <span class="keyword">end</span>
1551             
1552         <span class="keyword">case</span> 2        
1553             x = 1:length(CMData(i).HCMKicks);
1554             <span class="keyword">if</span> isempty(CMData(i).HCMKicksSTD)
1555                 plot(x(CMData(i).HCMGoodDataIndex), CMData(i).HCMKicks(CMData(i).HCMGoodDataIndex));
1556             <span class="keyword">else</span>
1557                 errorbar(x(CMData(i).HCMGoodDataIndex), CMData(i).HCMKicks(CMData(i).HCMGoodDataIndex), CMData(i).HCMKicksSTD(CMData(i).HCMGoodDataIndex));
1558             <span class="keyword">end</span>
1559             title(sprintf(<span class="string">'Corrector Magnet Parameter Fits (%d)'</span>,length(CMData(i).HCMKicks(CMData(i).HCMGoodDataIndex))));
1560             ylabel(H_Axes,<span class="string">'Horizontal Kick [mrad]'</span>);
1561             xlabel(H_Axes,<span class="string">'Horizontal Corrector Number'</span>);
1562             axis tight
1563             
1564         <span class="keyword">case</span> 3
1565             x = 1:length(CMData(i).VCMKicks);
1566             <span class="keyword">if</span> isempty(CMData(i).VCMKicksSTD)
1567                 plot(x(CMData(i).VCMGoodDataIndex), CMData(i).VCMKicks(CMData(i).VCMGoodDataIndex));
1568             <span class="keyword">else</span>
1569                 errorbar(x(CMData(i).VCMGoodDataIndex), CMData(i).VCMKicks(CMData(i).VCMGoodDataIndex), CMData(i).VCMKicksSTD(CMData(i).VCMGoodDataIndex));
1570             <span class="keyword">end</span>
1571             title(sprintf(<span class="string">'Corrector Magnet Parameter Fits (%d)'</span>,length(CMData(i).VCMKicks(CMData(i).VCMGoodDataIndex))));
1572             ylabel(H_Axes,<span class="string">'Vertical Kick [mrad]'</span>);
1573             xlabel(H_Axes,<span class="string">'Vertical Corrector Number'</span>);
1574             axis tight;
1575             
1576         <span class="keyword">case</span> 4
1577             <span class="keyword">if</span> ~isempty(CMData(i).HCMCoupling)
1578                 x = 1:length(CMData(i).HCMCoupling);
1579                 <span class="keyword">if</span> isempty(CMData(i).HCMCouplingSTD)
1580                     plot(x(CMData(i).HCMGoodDataIndex), CMData(i).HCMCoupling(CMData(i).HCMGoodDataIndex));
1581                 <span class="keyword">else</span>
1582                     errorbar(x(CMData(i).HCMGoodDataIndex), CMData(i).HCMCoupling(CMData(i).HCMGoodDataIndex), CMData(i).HCMCouplingSTD(CMData(i).HCMGoodDataIndex));
1583                 <span class="keyword">end</span>
1584                 title(sprintf(<span class="string">'Corrector Magnet Parameter Fits (%d)'</span>,length(CMData(i).HCMCoupling(CMData(i).HCMGoodDataIndex))));
1585                 ylabel(H_Axes,<span class="string">'Horizontal Coupling'</span>);
1586                 xlabel(H_Axes,<span class="string">'Horizontal Corrector Number'</span>);
1587                 axis tight
1588             <span class="keyword">else</span>
1589                 set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
1590             <span class="keyword">end</span>
1591             
1592         <span class="keyword">case</span> 5
1593             <span class="keyword">if</span> ~isempty(CMData(i).VCMCoupling)
1594                 x = 1:length(CMData(i).VCMCoupling);
1595                 <span class="keyword">if</span> isempty(CMData(i).VCMCouplingSTD)
1596                     plot(x(CMData(i).VCMGoodDataIndex), CMData(i).VCMCoupling(CMData(i).VCMGoodDataIndex));
1597                 <span class="keyword">else</span>    
1598                     errorbar(x(CMData(i).VCMGoodDataIndex), CMData(i).VCMCoupling(CMData(i).VCMGoodDataIndex), CMData(i).VCMCouplingSTD(CMData(i).VCMGoodDataIndex));
1599                 <span class="keyword">end</span>
1600                 title(sprintf(<span class="string">'Corrector Magnet Parameter Fits (%d)'</span>,length(CMData(i).VCMCoupling(CMData(i).VCMGoodDataIndex))));
1601                 ylabel(H_Axes,<span class="string">'Vertical Coupling'</span>);
1602                 xlabel(H_Axes,<span class="string">'Vertical Corrector Number'</span>);
1603                 axis tight;
1604             <span class="keyword">else</span>
1605                 set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
1606             <span class="keyword">end</span>
1607             
1608         <span class="keyword">case</span> 6   
1609             <span class="keyword">if</span> ~isempty(CMData(i).HCMEnergyShift)
1610                 x = 1:length(CMData(i).HCMEnergyShift);
1611                 <span class="keyword">if</span> isempty(CMData(i).HCMEnergyShiftSTD)
1612                     plot(x(CMData(i).HCMGoodDataIndex), CMData(i).HCMEnergyShift(CMData(i).HCMGoodDataIndex));
1613                 <span class="keyword">else</span>
1614                     errorbar(x(CMData(i).HCMGoodDataIndex), CMData(i).HCMEnergyShift(CMData(i).HCMGoodDataIndex), CMData(i).HCMEnergyShiftSTD(CMData(i).HCMGoodDataIndex));
1615                 <span class="keyword">end</span>
1616                 title(sprintf(<span class="string">'Corrector Magnet Parameter Fits (%d)'</span>,length(CMData(i).HCMEnergyShift(CMData(i).HCMGoodDataIndex))));
1617                 ylabel(H_Axes,<span class="string">'Horizontal Energy Shift'</span>);
1618                 xlabel(H_Axes,<span class="string">'Horizontal Corrector Number'</span>);
1619                 axis tight
1620             <span class="keyword">else</span>
1621                 set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
1622             <span class="keyword">end</span>
1623             
1624         <span class="keyword">case</span> 7
1625             <span class="keyword">if</span> ~isempty(CMData(i).VCMEnergyShift)
1626                 x = 1:length(CMData(i).VCMEnergyShift);
1627                 <span class="keyword">if</span> isempty(CMData(i).VCMEnergyShiftSTD)
1628                     plot(x(CMData(i).VCMGoodDataIndex), CMData(i).VCMEnergyShift(CMData(i).VCMGoodDataIndex));
1629                 <span class="keyword">else</span>
1630                     errorbar(x(CMData(i).VCMGoodDataIndex), CMData(i).VCMEnergyShift(CMData(i).VCMGoodDataIndex), CMData(i).VCMEnergyShiftSTD(CMData(i).VCMGoodDataIndex));
1631                 <span class="keyword">end</span>
1632                 title(sprintf(<span class="string">'Corrector Magnet Parameter Fits (%d)'</span>,length(CMData(i).VCMEnergyShift(CMData(i).VCMGoodDataIndex))));
1633                 ylabel(H_Axes,<span class="string">'Vertical Energy Shift'</span>);
1634                 xlabel(H_Axes,<span class="string">'Vertical Corrector Number'</span>);
1635                 axis tight
1636             <span class="keyword">else</span>
1637                 set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
1638             <span class="keyword">end</span>
1639             
1640         <span class="keyword">case</span> 8
1641             x = 1:length(BPMData(i).HBPMGain);
1642             <span class="keyword">if</span> isempty(BPMData(i).HBPMGainSTD)
1643                 plot(x(BPMData(i).HBPMGoodDataIndex), BPMData(i).HBPMGain(BPMData(i).HBPMGoodDataIndex));
1644             <span class="keyword">else</span>
1645                 errorbar(x(BPMData(i).HBPMGoodDataIndex), BPMData(i).HBPMGain(BPMData(i).HBPMGoodDataIndex), BPMData(i).HBPMGainSTD(BPMData(i).HBPMGoodDataIndex));
1646             <span class="keyword">end</span>
1647             title(sprintf(<span class="string">'BPM Parameter Fits (%d)'</span>,length(BPMData(i).HBPMGain(BPMData(i).HBPMGoodDataIndex))));
1648             ylabel(H_Axes,<span class="string">'BPMx Gain'</span>);
1649             xlabel(H_Axes,<span class="string">'Horizontal BPM Number'</span>);
1650             axis tight
1651             
1652         <span class="keyword">case</span> 9
1653             x = 1:length(BPMData(i).VBPMGain);
1654             <span class="keyword">if</span> isempty(BPMData(i).VBPMGainSTD)
1655                 plot(x(BPMData(i).VBPMGoodDataIndex), BPMData(i).VBPMGain(BPMData(i).VBPMGoodDataIndex));
1656             <span class="keyword">else</span>
1657                 errorbar(x(BPMData(i).VBPMGoodDataIndex), BPMData(i).VBPMGain(BPMData(i).VBPMGoodDataIndex), BPMData(i).VBPMGainSTD(BPMData(i).VBPMGoodDataIndex));
1658             <span class="keyword">end</span>
1659             title(sprintf(<span class="string">'BPM Parameter Fits (%d)'</span>,length(BPMData(i).VBPMGain(BPMData(i).VBPMGoodDataIndex))));
1660             ylabel(H_Axes,<span class="string">'BPMy Gain'</span>);
1661             xlabel(H_Axes,<span class="string">'Vertical BPM Number'</span>);
1662             axis tight;
1663             
1664         <span class="keyword">case</span> 10
1665             x = 1:length(BPMData(i).HBPMCoupling);
1666             <span class="keyword">if</span> ~isempty(BPMData(i).HBPMCoupling)
1667                 <span class="keyword">if</span> isempty(BPMData(i).HBPMCouplingSTD)
1668                     plot(x(BPMData(i).HBPMGoodDataIndex), BPMData(i).HBPMCoupling(BPMData(i).HBPMGoodDataIndex));
1669                 <span class="keyword">else</span>
1670                     errorbar(x(BPMData(i).HBPMGoodDataIndex), BPMData(i).HBPMCoupling(BPMData(i).HBPMGoodDataIndex), BPMData(i).HBPMCouplingSTD(BPMData(i).HBPMGoodDataIndex));
1671                 <span class="keyword">end</span>
1672                 title(sprintf(<span class="string">'BPM Parameter Fits (%d)'</span>,length(BPMData(i).HBPMCoupling(BPMData(i).HBPMGoodDataIndex))));
1673                 ylabel(H_Axes,<span class="string">'BPMx Coupling'</span>);
1674                 xlabel(H_Axes,<span class="string">'Horizontal BPM Number'</span>);
1675                 axis tight
1676             <span class="keyword">else</span>
1677                 set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
1678             <span class="keyword">end</span>
1679             
1680         <span class="keyword">case</span> 11
1681             x = 1:length(BPMData(i).VBPMCoupling);
1682             <span class="keyword">if</span> ~isempty(BPMData(i).VBPMCoupling)
1683                 <span class="keyword">if</span> isempty(BPMData(i).VBPMCouplingSTD)
1684                     plot(x(BPMData(i).VBPMGoodDataIndex), BPMData(i).VBPMCoupling(BPMData(i).VBPMGoodDataIndex));
1685                 <span class="keyword">else</span>
1686                     errorbar(x(BPMData(i).VBPMGoodDataIndex), BPMData(i).VBPMCoupling(BPMData(i).VBPMGoodDataIndex), BPMData(i).VBPMCouplingSTD(BPMData(i).VBPMGoodDataIndex));
1687                 <span class="keyword">end</span>
1688                 title(sprintf(<span class="string">'BPM Parameter Fits (%d)'</span>,length(BPMData(i).VBPMCoupling(BPMData(i).VBPMGoodDataIndex))));
1689                 ylabel(H_Axes,<span class="string">'BPMy Coupling'</span>);
1690                 xlabel(H_Axes,<span class="string">'Vertical BPM Number'</span>);
1691                 axis tight;
1692             <span class="keyword">else</span>
1693                 set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
1694             <span class="keyword">end</span>
1695 
1696         <span class="keyword">case</span> 12
1697             <span class="comment">% HBPM Standard Deviations</span>
1698             BPMstd = LocoMeasData.BPMSTD(BPMData(i).HBPMGoodDataIndex);
1699             
1700             <span class="comment">%BPMstd = LocoMeasData.BPMSTD([BPMData(i).HBPMGoodDataIndex length(BPMData(i).HBPMIndex)+BPMData(i).VBPMGoodDataIndex]);</span>
1701             <span class="comment">%if ~isempty(BPMstd)</span>
1702             <span class="comment">%    plot(BPMstd)</span>
1703             <span class="comment">%    ylabel(H_Axes,'Standard Deviation [mm]');</span>
1704             <span class="comment">%    axis tight</span>
1705             <span class="comment">%</span>
1706             <span class="comment">%    % Change label to BPM numbers</span>
1707             <span class="comment">%    Nx = length(BPMstd);</span>
1708             <span class="comment">%    Ticks = 1:ceil(Nx/10):Nx;</span>
1709             <span class="comment">%    set(H_Axes, 'XTick', Ticks);</span>
1710             <span class="comment">%    TickNumber = [BPMData(i).HBPMGoodDataIndex BPMData(i).VBPMGoodDataIndex];</span>
1711             <span class="comment">%    TickNumber = TickNumber(Ticks);</span>
1712             <span class="comment">%    set(H_Axes, 'XTickLabel', num2cell(TickNumber));</span>
1713             <span class="comment">%    xlabel(H_Axes,'HBPM# and VBPM#');</span>
1714             <span class="comment">%end</span>
1715             
1716             <span class="keyword">if</span> ~isempty(BPMstd)                
1717                 plot(BPMstd);
1718                 title(H_Axes,<span class="string">'Horizontal BPM Standard Deviations'</span>);
1719                 ylabel(H_Axes,<span class="string">'Standard Deviation [mm]'</span>);
1720                 xlabel(H_Axes,<span class="string">'BPM Number'</span>);
1721                 axis tight
1722             <span class="keyword">end</span>
1723 
1724         <span class="keyword">case</span> 13
1725             <span class="comment">% VBPM Standard Deviations</span>
1726             BPMstd = LocoMeasData.BPMSTD(length(BPMData(i).HBPMIndex)+BPMData(i).VBPMGoodDataIndex);
1727             
1728             <span class="keyword">if</span> ~isempty(BPMstd)                
1729                 plot(BPMstd);
1730                 title(H_Axes,<span class="string">'Vertical BPM Standard Deviations'</span>);
1731                 ylabel(H_Axes,<span class="string">'Standard Deviation [mm]'</span>);
1732                 xlabel(H_Axes,<span class="string">'BPM Number'</span>);
1733                 axis tight
1734             <span class="keyword">end</span>
1735 
1736         <span class="keyword">case</span> 14
1737             <span class="keyword">if</span> isempty(FitParameters(i).DeltaRF)
1738                 set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
1739             <span class="keyword">else</span>
1740                 plot(H_Axes,[0 1],[0 1],<span class="string">'w'</span>);
1741                 title(H_Axes,<span class="string">'RF Frequency'</span>);
1742                 set(H_Axes,<span class="string">'box'</span>,<span class="string">'on'</span>);
1743                 set(H_Axes,<span class="string">'XTick'</span>,[]);
1744                 set(H_Axes,<span class="string">'YTick'</span>,[]);
1745                 text(4,10,sprintf(<span class="string">'Dispersion Measurement'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1746                 text(4,9,sprintf(<span class="string">'RF Frequency Change:'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1747                 text(4,8,sprintf(<span class="string">'%8.3f Hz Measured'</span>,  LocoMeasData.DeltaRF),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1748                 text(4,7,sprintf(<span class="string">'%8.3f Hz Model'</span>, FitParameters(i).DeltaRF),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1749                 
1750                 text(4,6,sprintf(<span class="string">'%10.5f Hz \\sigma-Model'</span>, FitParameters(i).DeltaRFSTD),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1751                 <span class="keyword">if</span> isfield(FitParameters(i),<span class="string">'FitRFFrequency'</span>)
1752                     text(4,5,sprintf(<span class="string">'Fit Delta RF Frequency = %s'</span>, FitParameters(i).FitRFFrequency),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1753                 <span class="keyword">end</span>    
1754                 <span class="keyword">if</span> isfield(LocoMeasData,<span class="string">'RF'</span>)
1755                     text(4,3,sprintf(<span class="string">'RF Frequency = %.1f Hz (Measured)'</span>, LocoMeasData.RF),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1756                 <span class="keyword">end</span>    
1757                 <span class="keyword">if</span> isfield(RINGData,<span class="string">'CavityFrequency'</span>)
1758                     text(4,2,sprintf(<span class="string">'RF Frequency = %.1f Hz (Model)'</span>, RINGData.CavityFrequency'),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1759                 <span class="keyword">end</span>    
1760             <span class="keyword">end</span>            
1761             
1762         <span class="keyword">case</span> 15
1763             <span class="comment">% Other parameters</span>
1764             <span class="keyword">if</span> isempty(FitParameters(i).Values)
1765                 set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
1766                 <span class="keyword">return</span>;
1767             <span class="keyword">elseif</span> length(FitParameters(i).Values) &gt; 1
1768                 ATFlag = 0;
1769                 <span class="keyword">if</span> iscell(RINGData.Lattice)
1770                     <span class="keyword">if</span> isfield(RINGData.Lattice{1},<span class="string">'FamName'</span>) 
1771                         ATFlag = 1;
1772                     <span class="keyword">end</span>
1773                 <span class="keyword">end</span>
1774                 
1775                 AxesTag = get(H_Axes,<span class="string">'Tag'</span>);
1776                 <span class="keyword">if</span> strcmp(AxesTag,<span class="string">'Axes1'</span>)
1777                     FieldName = getappdata(gcbf,<span class="string">'OtherParameterPlot1'</span>);
1778                 <span class="keyword">elseif</span> strcmp(AxesTag,<span class="string">'Axes2'</span>)
1779                     FieldName = getappdata(gcbf,<span class="string">'OtherParameterPlot2'</span>);
1780                 <span class="keyword">end</span>
1781                 
1782                 <span class="keyword">if</span> isempty(FieldName) || strcmp(FieldName, <span class="string">'All'</span>)
1783                     <span class="keyword">if</span> isempty(FitParameters(i).ValuesSTD) || all(isnan(FitParameters(i).ValuesSTD))
1784                         plot(1:length(FitParameters(i).Values), FitParameters(i).Values, <span class="string">'.-b'</span>);
1785                     <span class="keyword">else</span>
1786                         errorbar(1:length(FitParameters(i).Values), FitParameters(i).Values, FitParameters(i).ValuesSTD);
1787                     <span class="keyword">end</span>
1788                     title(H_Axes,<span class="string">'LOCO Parameter Fits'</span>);
1789                     ylabel(H_Axes,<span class="string">''</span>);
1790                     xlabel(H_Axes,<span class="string">'Parameter Number'</span>);
1791                     axis tight
1792                     <span class="comment">%fprintf('   Right click in the axis to select different parameter plots.\n');</span>
1793                     
1794                 <span class="keyword">else</span>
1795                     ParameterNumber = [];Values=[]; ValuesSTD=[];
1796                     <span class="keyword">for</span> j = 1:length(FitParameters(i).Params)
1797                         <span class="keyword">if</span> ATFlag
1798                             Name = RINGData.Lattice{FitParameters(i).Params{j}(1).ElemIndex}.FamName;
1799                             SubField = FitParameters(i).Params{j}(1).FieldName;
1800                             Name = [Name,<span class="string">'.'</span>,SubField];
1801                         <span class="keyword">else</span>
1802                             Name = FitParameters(i).Params{j}(1).FieldName;
1803                         <span class="keyword">end</span>
1804                         
1805                         <span class="keyword">if</span> strcmp(Name, FieldName)
1806                             Values = [Values FitParameters(i).Values(j)];
1807                             ParameterNumber = [ParameterNumber j];
1808                             <span class="keyword">if</span> isempty(FitParameters(i).ValuesSTD)
1809                                 ValuesSTD = [];
1810                             <span class="keyword">else</span>
1811                                 ValuesSTD = [ValuesSTD FitParameters(i).ValuesSTD(j)];
1812                             <span class="keyword">end</span>
1813                         <span class="keyword">end</span>
1814                     <span class="keyword">end</span>
1815                     <span class="keyword">if</span> isempty(ValuesSTD) || all(isnan(ValuesSTD))
1816                         <span class="keyword">if</span> length(Values) == 1
1817                             plot(ParameterNumber, Values, <span class="string">'squareb'</span>,<span class="string">'MarkerFaceColor'</span>,<span class="string">'b'</span>);
1818                         <span class="keyword">else</span>
1819                             <span class="comment">%plot(1:length(Values), Values);</span>
1820                             plot(ParameterNumber, Values, <span class="string">'.-b'</span>);
1821                         <span class="keyword">end</span>
1822                     <span class="keyword">else</span>
1823                         <span class="comment">%errorbar(1:length(Values), Values, ValuesSTD);</span>
1824                         errorbar(ParameterNumber, Values, ValuesSTD);
1825                     <span class="keyword">end</span>
1826                     title(H_Axes,[<span class="string">'LOCO Parameter Fits for Field: '</span>, FieldName]);
1827                     ylabel(H_Axes,<span class="string">''</span>);
1828                     xlabel(H_Axes,<span class="string">'Parameter Number'</span>);
1829                     axis tight
1830                 <span class="keyword">end</span>
1831                 
1832                 <span class="comment">% Add a context menu</span>
1833                 hcmenu = uicontextmenu;
1834                 
1835                 <span class="comment">% Define the line and associate it with the context menu</span>
1836                 set(H_Axes, <span class="string">'UIContextMenu'</span>, hcmenu);
1837                 
1838                 <span class="comment">% Define the context menu items</span>
1839                 cb = <span class="string">'locogui(''ContextMenuPlot_Callback'',gcbo,[],[])'</span>;
1840                 h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'All'</span>, <span class="string">'Callback'</span>, cb);
1841                 set(h,<span class="string">'Userdata'</span>,<span class="string">'All'</span>);
1842                 <span class="keyword">if</span> ATFlag
1843                     <span class="comment">% When using the AT model this will work</span>
1844                     j = 1;
1845                     cb = <span class="string">'locogui(''ContextMenuPlot_Callback'',gcbo,[],[])'</span>;
1846                     NameNew = RINGData.Lattice{FitParameters(i).Params{j}(1).ElemIndex}.FamName;
1847                     SubField = FitParameters(i).Params{j}(1).FieldName;
1848                     <span class="comment">%h = uimenu(hcmenu, 'Label', NameNew, 'Callback', cb);</span>
1849                     h = uimenu(hcmenu, <span class="string">'Label'</span>,[NameNew,<span class="string">'.'</span>,SubField], <span class="string">'Callback'</span>, cb);
1850                     <span class="comment">%set(h,'Userdata',NameNew);</span>
1851                     set(h,<span class="string">'Userdata'</span>,[NameNew,<span class="string">'.'</span>,SubField]);
1852                     <span class="comment">%Names{1} = NameNew;</span>
1853                     Names{1} = [NameNew,<span class="string">'.'</span>,SubField];
1854                     <span class="keyword">for</span> j = 2:length(FitParameters(i).Params)
1855                         NameNew = RINGData.Lattice{FitParameters(i).Params{j}(1).ElemIndex}.FamName;
1856                         SubField = FitParameters(i).Params{j}(1).FieldName;
1857                         <span class="comment">%if ~any(strcmp(NameNew, Names))</span>
1858                         <span class="keyword">if</span> ~any(strcmp([NameNew,<span class="string">'.'</span>,SubField], Names))
1859                             <span class="comment">%Names{end+1} = NameNew;</span>
1860                             Names{end+1} = [NameNew,<span class="string">'.'</span>,SubField];
1861                             cb = <span class="string">'locogui(''ContextMenuPlot_Callback'',gcbo,[],[])'</span>;
1862                             <span class="comment">%h = uimenu(hcmenu, 'Label', NameNew, 'Callback', cb);</span>
1863                             h = uimenu(hcmenu, <span class="string">'Label'</span>,[NameNew,<span class="string">'.'</span>,SubField], <span class="string">'Callback'</span>, cb);
1864                             <span class="comment">%set(h,'Userdata',NameNew);</span>
1865                             set(h,<span class="string">'Userdata'</span>,[NameNew,<span class="string">'.'</span>,SubField]);
1866                         <span class="keyword">end</span>
1867                     <span class="keyword">end</span>
1868                 <span class="keyword">else</span>
1869                     <span class="comment">% Base names on paramgroup</span>
1870                     j = 1;
1871                     cb = <span class="string">'locogui(''ContextMenuPlot_Callback'',gcbo,[],[])'</span>;
1872                     h = uimenu(hcmenu, <span class="string">'Label'</span>, FitParameters(i).Params{1}(1).FieldName, <span class="string">'Callback'</span>, cb);
1873                     set(h,<span class="string">'Userdata'</span>,FitParameters(i).Params{j}(1).FieldName);
1874                     <span class="keyword">for</span> j = 2:length(FitParameters(i).Params)
1875                         <span class="keyword">if</span> ~strcmp(FitParameters(i).Params{j}(1).FieldName, FitParameters(i).Params{j-1}(1).FieldName)
1876                             cb = <span class="string">'locogui(''ContextMenuPlot_Callback'',gcbo,[],[])'</span>;
1877                             h = uimenu(hcmenu, <span class="string">'Label'</span>, FitParameters(i).Params{j}(1).FieldName, <span class="string">'Callback'</span>, cb);
1878                             set(h,<span class="string">'Userdata'</span>,FitParameters(i).Params{j}(1).FieldName);
1879                         <span class="keyword">end</span>
1880                     <span class="keyword">end</span>
1881                 <span class="keyword">end</span>
1882                 
1883             <span class="keyword">else</span>
1884                 plot(H_Axes,[0 1],[0 1],<span class="string">'w'</span>);
1885                 title(H_Axes,<span class="string">'LOCO Parameter Fits'</span>);
1886                 set(H_Axes,<span class="string">'box'</span>,<span class="string">'on'</span>);
1887                 set(H_Axes,<span class="string">'XTick'</span>,[]);
1888                 set(H_Axes,<span class="string">'YTick'</span>,[]);
1889                 text(4,6,sprintf(<span class="string">'Parameter Fit #1'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1890                 text(4,5,sprintf(<span class="string">'Value = %f'</span>, FitParameters(i).Values),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1891                 text(4,4,sprintf(<span class="string">'\\sigma = %f'</span>, FitParameters(i).ValuesSTD),<span class="string">'units'</span>,<span class="string">'characters'</span>);
1892                 <span class="comment">%text(.05,.6,sprintf('Parameter Fit #1:  Value = %f, \\sigma = %f', FitParameters(i).Values, FitParameters(i).Values));</span>
1893             <span class="keyword">end</span>
1894 
1895         <span class="keyword">case</span> 16
1896             <span class="comment">% Plot delta chi^2 w.r.t. fit parameter</span>
1897             <span class="keyword">if</span> isfield(LocoFlags(i),<span class="string">'Method'</span>) &amp;&amp; isfield(LocoFlags(i).Method,<span class="string">'DeltaChi2'</span>) &amp;&amp; isfield(LocoFlags(i).Method.DeltaChi2,<span class="string">'FitParameter'</span>) &amp;&amp; ~isempty(LocoFlags(i).Method.DeltaChi2.FitParameter)
1898                 axes(H_Axes);
1899                 <span class="keyword">if</span> 0
1900                     plot(1:length(LocoFlags(i).Method.DeltaChi2.FitParameter), LocoFlags(i).Method.DeltaChi2.FitParameter,<span class="string">'.-'</span>);
1901                     ylabel(H_Axes,<span class="string">'\Delta \chi^2'</span>, <span class="string">'FontSize'</span>, 14);
1902                 <span class="keyword">else</span>
1903                     semilogy(1:length(LocoFlags(i).Method.DeltaChi2.FitParameter), abs(LocoFlags(i).Method.DeltaChi2.FitParameter),<span class="string">'.-'</span>);
1904                     ylabel(H_Axes,<span class="string">'\mid\Delta \chi^2\mid'</span>, <span class="string">'FontSize'</span>, 14);
1905                 <span class="keyword">end</span>
1906                 title(H_Axes,<span class="string">''</span>);
1907                 xlabel(H_Axes,<span class="string">'Fit Parameter Index'</span>, <span class="string">'FontSize'</span>, 10);
1908                 title(H_Axes,<span class="string">'\Delta \chi^2 vs Fit Parameter'</span>, <span class="string">'FontSize'</span>, 10);
1909                 <span class="comment">%grid  on;</span>
1910                 axis tight;
1911                 d = .08;
1912                 text(.03,.9-0*d, sprintf(<span class="string">'\\Delta \\chi^2(All BPMs) = %.1f'</span>,          LocoFlags(i).Method.DeltaChi2.BPMGroup),          <span class="string">'FontSize'</span>, 10, <span class="string">'Units'</span>,<span class="string">'Normalized'</span>);
1913                 text(.03,.9-1*d, sprintf(<span class="string">'\\Delta \\chi^2(All CMs)  = %.1f'</span>,          LocoFlags(i).Method.DeltaChi2.CMGroup),           <span class="string">'FontSize'</span>, 10, <span class="string">'Units'</span>,<span class="string">'Normalized'</span>);
1914                 text(.03,.9-2*d, sprintf(<span class="string">'\\Delta \\chi^2(All FitParameters) = %.1f'</span>, LocoFlags(i).Method.DeltaChi2.FitParameterGroup), <span class="string">'FontSize'</span>, 10, <span class="string">'Units'</span>,<span class="string">'Normalized'</span>);
1915             <span class="keyword">else</span>
1916                 <span class="comment">% No data probably because delta chi^2 calculation was canceled</span>
1917                 cla;
1918                 plot(H_Axes,[0 1],[0 1],<span class="string">'w'</span>);
1919                 set(H_Axes,<span class="string">'XTick'</span>,[]);
1920                 set(H_Axes,<span class="string">'YTick'</span>,[]);
1921                 title(H_Axes,<span class="string">' '</span>);
1922                 xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
1923                 text(.45,.5,sprintf(<span class="string">'No Data'</span>),<span class="string">'Units'</span>,<span class="string">'Normalized'</span>);
1924                 <span class="keyword">return</span>
1925             <span class="keyword">end</span>
1926 
1927         <span class="keyword">case</span> 17
1928             <span class="comment">% Plot partial chi^2 w.r.t. fit parameter</span>
1929             <span class="keyword">if</span> isfield(LocoFlags(i),<span class="string">'Method'</span>) &amp;&amp; isfield(LocoFlags(i).Method,<span class="string">'PartialChi2'</span>) &amp;&amp; ~isempty(fieldnames(LocoFlags(i).Method.PartialChi2))
1930                 AxesTag = get(H_Axes,<span class="string">'Tag'</span>);
1931                 <span class="keyword">if</span> strcmp(AxesTag,<span class="string">'Axes1'</span>)
1932                     Userdata = getappdata(gcbf, <span class="string">'PartialChi2Plot1'</span>);
1933                 <span class="keyword">elseif</span> strcmp(AxesTag,<span class="string">'Axes2'</span>)
1934                     Userdata = getappdata(gcbf, <span class="string">'PartialChi2Plot2'</span>);
1935                 <span class="keyword">end</span>
1936                 <span class="keyword">if</span> isempty(Userdata)
1937                     Userdata = {<span class="string">'All'</span>, H_Axes};
1938                     <span class="keyword">if</span> strcmp(AxesTag,<span class="string">'Axes1'</span>)
1939                         setappdata(gcbf, <span class="string">'PartialChi2Plot1'</span>, Userdata);
1940                     <span class="keyword">elseif</span> strcmp(AxesTag,<span class="string">'Axes2'</span>)
1941                         setappdata(gcbf, <span class="string">'PartialChi2Plot2'</span>, Userdata);
1942                     <span class="keyword">end</span>
1943                 <span class="keyword">end</span>
1944 
1945                 <a href="#_sub29" class="code" title="subfunction PlotPartialChi2">PlotPartialChi2</a>;
1946                 
1947                 <span class="comment">% Define the context menu for the plot</span>
1948                 hcmenu = uicontextmenu(<span class="string">'Tag'</span>,<span class="string">'PartialChi2Plot'</span>);
1949                 set(H_Axes, <span class="string">'UIContextMenu'</span>, hcmenu);
1950                 h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'All'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextPartialChi2Plot_Callback'',gcbo,[],[])'</span>);
1951                 set(h,<span class="string">'Userdata'</span>,{<span class="string">'All'</span>, H_Axes});
1952                 FieldCell = fieldnames(LocoFlags(i).Method.PartialChi2);
1953                 <span class="keyword">for</span> ifield = 1:length(FieldCell)
1954                     h = uimenu(hcmenu, <span class="string">'Label'</span>, FieldCell{ifield}, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextPartialChi2Plot_Callback'',gcbo,[],[])'</span>);
1955                     set(h,<span class="string">'Userdata'</span>,{FieldCell{ifield}, H_Axes});
1956                 <span class="keyword">end</span>
1957                 <span class="comment">%fprintf('   Right click in the axis to select different plots.\n');</span>
1958 
1959             <span class="keyword">else</span>
1960                 <span class="comment">% No data</span>
1961                 cla;
1962                 plot(H_Axes,[0 1],[0 1],<span class="string">'w'</span>);
1963                 set(H_Axes,<span class="string">'XTick'</span>,[]);
1964                 set(H_Axes,<span class="string">'YTick'</span>,[]);
1965                 title(H_Axes,<span class="string">' '</span>);
1966                 xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
1967                 text(.35,.5,sprintf(<span class="string">'No  \\partial\\chi^2 / \\partialFitParamter Data'</span>),<span class="string">'Units'</span>,<span class="string">'Normalized'</span>);
1968                 <span class="keyword">return</span>
1969             <span class="keyword">end</span>
1970             
1971                         
1972         <span class="keyword">case</span> 18
1973             <span class="comment">% Plot cost function</span>
1974             <span class="keyword">if</span> isfield(LocoFlags(i),<span class="string">'Method'</span>) &amp;&amp; isfield(LocoFlags(i).Method,<span class="string">'Cost'</span>)&amp;&amp; isstruct(LocoFlags(i).Method.Cost) &amp;&amp; ~isempty(fieldnames(LocoFlags(i).Method.Cost))
1975                 AxesTag = get(H_Axes,<span class="string">'Tag'</span>);
1976                 <span class="keyword">if</span> strcmp(AxesTag,<span class="string">'Axes1'</span>)
1977                     Userdata = getappdata(gcbf, <span class="string">'CostFunctionPlot1'</span>);
1978                 <span class="keyword">elseif</span> strcmp(AxesTag,<span class="string">'Axes2'</span>)
1979                     Userdata = getappdata(gcbf, <span class="string">'CostFunctionPlot2'</span>);
1980                 <span class="keyword">end</span>
1981                 <span class="keyword">if</span> isempty(Userdata)
1982                     Userdata = {<span class="string">'All'</span>, H_Axes};
1983                     <span class="keyword">if</span> strcmp(AxesTag,<span class="string">'Axes1'</span>)
1984                         setappdata(gcbf, <span class="string">'CostFunctionPlot1'</span>, Userdata);
1985                     <span class="keyword">elseif</span> strcmp(AxesTag,<span class="string">'Axes2'</span>)
1986                         setappdata(gcbf, <span class="string">'CostFunctionPlot2'</span>, Userdata);
1987                     <span class="keyword">end</span>
1988                 <span class="keyword">end</span>
1989 
1990                 <a href="#_sub27" class="code" title="subfunction PlotCostFunction">PlotCostFunction</a>;
1991                 
1992                 <span class="comment">% Define the context menu for the plot</span>
1993                 hcmenu = uicontextmenu(<span class="string">'Tag'</span>,<span class="string">'PlotCostFunction'</span>);
1994                 set(H_Axes, <span class="string">'UIContextMenu'</span>, hcmenu);
1995                 h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'All'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextCostFunctionPlot_Callback'',gcbo,[],[])'</span>);
1996                 set(h,<span class="string">'Userdata'</span>,{<span class="string">'All'</span>, H_Axes});
1997                 FieldCell = fieldnames(LocoFlags(i).Method.Cost);
1998                 <span class="keyword">for</span> ifield = 1:length(FieldCell)
1999                     h = uimenu(hcmenu, <span class="string">'Label'</span>, FieldCell{ifield}, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextCostFunctionPlot_Callback'',gcbo,[],[])'</span>);
2000                     set(h,<span class="string">'Userdata'</span>,{FieldCell{ifield}, H_Axes});
2001                 <span class="keyword">end</span>
2002                 <span class="comment">%fprintf('   Right click in the axis to select different parameter costs.\n');</span>
2003 
2004             <span class="keyword">else</span>
2005                 <span class="comment">% No data</span>
2006                 cla;
2007                 plot(H_Axes,[0 1],[0 1],<span class="string">'w'</span>);
2008                 set(H_Axes,<span class="string">'XTick'</span>,[]);
2009                 set(H_Axes,<span class="string">'YTick'</span>,[]);
2010                 title(H_Axes,<span class="string">' '</span>);
2011                 xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
2012                 text(.35,.5,sprintf(<span class="string">'No Cost Function Data'</span>),<span class="string">'Units'</span>,<span class="string">'Normalized'</span>);
2013                 <span class="keyword">return</span>
2014             <span class="keyword">end</span>
2015        
2016         <span class="keyword">case</span> 19
2017             <span class="keyword">if</span> ~exist(<span class="string">'LocoFlags'</span>,<span class="string">'var'</span>) || ~isfield(LocoFlags(i), <span class="string">'Method'</span>) || ~isfield(LocoFlags(i).Method, <span class="string">'SV'</span>) || isempty(LocoFlags(i).Method.SV)
2018                 cla;
2019                 plot(H_Axes,[0 1],[0 1],<span class="string">'w'</span>);
2020                 set(H_Axes,<span class="string">'XTick'</span>,[]);
2021                 set(H_Axes,<span class="string">'YTick'</span>,[]);
2022                 title(H_Axes,<span class="string">' '</span>);
2023                 xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
2024                 text(.45,.5,sprintf(<span class="string">'No Data'</span>),<span class="string">'Units'</span>,<span class="string">'Normalized'</span>);
2025                 <span class="keyword">return</span>
2026             <span class="keyword">else</span>
2027                 SValues = LocoFlags(i).Method.SV;
2028                 Ivec = LocoFlags(i).Method.SVIndex;
2029                 
2030                 semilogy(SValues,<span class="string">'b'</span>);
2031                 hold on; 
2032                 semilogy(Ivec, SValues(Ivec),<span class="string">'og'</span>,<span class="string">'MarkerSize'</span>,2); 
2033                 axis([1 length(SValues) min(SValues) max(SValues)]);
2034                 
2035                 x=1:length(SValues);
2036                 x(Ivec)=[];
2037                 SValues(Ivec)=[];
2038                 semilogy(x, SValues,<span class="string">'xr'</span>,<span class="string">'MarkerSize'</span>,4); 
2039                 hold off
2040                 
2041                 title(H_Axes,<span class="string">'Singular Values'</span>);
2042                 xlabel(H_Axes,<span class="string">'Singular Value Number'</span>);
2043                 ylabel(H_Axes,<span class="string">'Magnitude'</span>);
2044             <span class="keyword">end</span>
2045             
2046         <span class="keyword">case</span> 20
2047             <span class="comment">% Response matrix plot</span>
2048             
2049             AxesTag = get(H_Axes,<span class="string">'Tag'</span>);
2050             <span class="keyword">if</span> strcmp(AxesTag,<span class="string">'Axes1'</span>)
2051                 h = findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SurfPlot1'</span>);
2052                 FieldName = get(h,<span class="string">'Userdata'</span>);
2053             <span class="keyword">elseif</span> strcmp(AxesTag,<span class="string">'Axes2'</span>)
2054                 h = findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SurfPlot2'</span>);
2055                 FieldName = get(h,<span class="string">'Userdata'</span>);
2056             <span class="keyword">end</span>
2057             
2058             <span class="keyword">if</span> ~iscell(FieldName)
2059                 FieldName = {<span class="string">'Model'</span>, <span class="string">'All'</span>};
2060                 <span class="comment">%FieldName = {'Measured', 'All'};</span>
2061                 <span class="comment">%fprintf('   Right click in the axis to select different plots.\n');</span>
2062             <span class="keyword">else</span>
2063                 <span class="comment">% Force the field to Model when a new file or one of the pulldown menus is selected</span>
2064                 <span class="comment">%FieldName = {'Model', 'All'};</span>
2065             <span class="keyword">end</span>
2066             
2067             
2068             PlotString  = FieldName{1};
2069             PlaneString = FieldName{2}; 
2070             <span class="keyword">if</span> length(FieldName) &gt; 2 
2071                 ElementsInput = FieldName{3};
2072             <span class="keyword">else</span>
2073                 ElementsInput = [];
2074             <span class="keyword">end</span>
2075             
2076             set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
2077             FieldName{3} = <a href="locoplot.html" class="code" title="function ElementsInput = locoplot(FileName, IterationNumber, PlotString, PlaneString, ElementsInput)">locoplot</a>({BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData}, i-1, PlotString, PlaneString, ElementsInput);
2078             <span class="comment">% if isempty(Mmodel)</span>
2079             <span class="comment">%     set(H_Axes,'XTick',[]); set(H_Axes,'YTick',[]); cla; title(H_Axes,' '); xlabel(H_Axes,' '); ylabel(H_Axes,' ');</span>
2080             <span class="comment">%     return</span>
2081             <span class="comment">% end</span>
2082             set(h,<span class="string">'Userdata'</span>, FieldName);
2083             
2084             
2085             <span class="comment">% Define the context menu items for surf plot</span>
2086             hcmenu = uicontextmenu(<span class="string">'Tag'</span>,<span class="string">'3dsurfplot'</span>);
2087             set(H_Axes, <span class="string">'UIContextMenu'</span>, hcmenu);
2088             
2089             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model: 3-D, All'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2090             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model'</span>,<span class="string">'All'</span>});
2091             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model: 3-D, HBPM vs HCM'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2092             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model'</span>,<span class="string">'XX'</span>});
2093             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model: 3-D, HBPM vs VCM'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2094             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model'</span>,<span class="string">'XY'</span>});
2095             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model: 3-D, VBPM vs VCM'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2096             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model'</span>,<span class="string">'YY'</span>});
2097             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model: 3-D, VBPM vs HCM'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2098             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model'</span>,<span class="string">'YX'</span>});
2099             
2100             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model: 2-D, HBPM (Rows)'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2101             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model'</span>,<span class="string">'HBPM'</span>});
2102             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model: 2-D, VBPM (Rows)'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2103             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model'</span>,<span class="string">'VBPM'</span>});
2104             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model: 2-D, HCM (Columns)'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2105             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model'</span>,<span class="string">'HCM'</span>});
2106             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model: 2-D, VCM (Columns)'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2107             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model'</span>,<span class="string">'VCM'</span>});
2108             
2109             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">' '</span>, <span class="string">'Callback'</span>, <span class="string">''</span>);
2110             
2111             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Measured: 3-D, All'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2112             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Measured'</span>,<span class="string">'All'</span>});
2113             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Measured: 3-D, HBPM vs HCM'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2114             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Measured'</span>,<span class="string">'XX'</span>});
2115             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Measured: 3-D, HBPM vs VCM'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2116             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Measured'</span>,<span class="string">'XY'</span>});
2117             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Measured: 3-D, VBPM vs VCM'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2118             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Measured'</span>,<span class="string">'YY'</span>});
2119             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Measured: 3-D, VBPM vs HCM'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2120             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Measured'</span>,<span class="string">'YX'</span>});
2121             
2122             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Measured: 2-D, HBPM (Rows)'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2123             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Measured'</span>,<span class="string">'HBPM'</span>});
2124             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Measured: 2-D, VBPM (Rows)'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2125             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Measured'</span>,<span class="string">'VBPM'</span>});
2126             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Measured: 2-D, HCM (Columns)'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2127             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Measured'</span>,<span class="string">'HCM'</span>});
2128             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Measured: 2-D, VCM (Columns)'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2129             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Measured'</span>,<span class="string">'VCM'</span>});
2130             
2131             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">' '</span>, <span class="string">'Callback'</span>, <span class="string">''</span>);
2132             
2133             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model-Measured: 3-D, All'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2134             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model-Measured'</span>,<span class="string">'All'</span>});
2135             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model-Measured: 3-D, HBPM vs HCM'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2136             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model-Measured'</span>,<span class="string">'XX'</span>});
2137             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model-Measured: 3-D, HBPM vs VCM'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2138             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model-Measured'</span>,<span class="string">'XY'</span>});
2139             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model-Measured: 3-D, VBPM vs VCM'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2140             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model-Measured'</span>,<span class="string">'YY'</span>});
2141             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model-Measured: 3-D, VBPM vs HCM'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2142             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model-Measured'</span>,<span class="string">'YX'</span>});
2143             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model-Measured: 2-D, HBPM (Rows)'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2144             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model-Measured'</span>,<span class="string">'HBPM'</span>});
2145             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model-Measured: 2-D, VBPM (Rows)'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2146             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model-Measured'</span>,<span class="string">'VBPM'</span>});
2147             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model-Measured: 2-D, HCM (Columns)'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2148             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model-Measured'</span>,<span class="string">'HCM'</span>});
2149             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model-Measured: 2-D, VCM (Columns)'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2150             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model-Measured'</span>,<span class="string">'VCM'</span>});
2151             
2152             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">' '</span>, <span class="string">'Callback'</span>, <span class="string">''</span>);
2153             
2154             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model-Measured+EnergyShifts: 3-D, All'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2155             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model-Measured+EnergyShifts'</span>,<span class="string">'All'</span>});
2156             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model-Measured+EnergyShifts: 3-D, HBPM vs HCM'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2157             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model-Measured+EnergyShifts'</span>,<span class="string">'XX'</span>});
2158             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model-Measured+EnergyShifts: 3-D, HBPM vs VCM'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2159             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model-Measured+EnergyShifts'</span>,<span class="string">'XY'</span>});
2160             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model-Measured+EnergyShifts: 3-D, VBPM vs VCM'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2161             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model-Measured+EnergyShifts'</span>,<span class="string">'YY'</span>});
2162             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model-Measured+EnergyShifts: 3-D, VBPM vs HCM'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2163             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model-Measured+EnergyShifts'</span>,<span class="string">'YX'</span>});
2164             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model-Measured+EnergyShifts: 2-D, HBPM (Rows)'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2165             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model-Measured+EnergyShifts'</span>,<span class="string">'HBPM'</span>});
2166             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model-Measured+EnergyShifts: 2-D, VBPM (Rows)'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2167             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model-Measured+EnergyShifts'</span>,<span class="string">'VBPM'</span>});
2168             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model-Measured+EnergyShifts: 2-D, HCM (Columns)'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2169             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model-Measured+EnergyShifts'</span>,<span class="string">'HCM'</span>});
2170             h = uimenu(hcmenu, <span class="string">'Label'</span>, <span class="string">'Model-Measured+EnergyShifts: 2-D, VCM (Columns)'</span>, <span class="string">'Callback'</span>, <span class="string">'locogui(''ContextMenuSurfPlot_Callback'',gcbo,[],[])'</span>);
2171             set(h,<span class="string">'Userdata'</span>,{<span class="string">'Model-Measured+EnergyShifts'</span>,<span class="string">'VCM'</span>});
2172             
2173         <span class="keyword">case</span> 21
2174             <span class="comment">% Error function histogram</span>
2175             plot(0,0); set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
2176             
2177             ErrorFunction = <a href="locodata.html" class="code" title="function varargout = locodata(FileName, IterationNumber, varargin)">locodata</a>({BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData}, i-1, <span class="string">'ErrorDistribution'</span>);
2178             <span class="keyword">if</span> ~isempty(ErrorFunction)
2179                 hist(ErrorFunction,2000);
2180                 xlabel(H_Axes,<span class="string">'Error in Units of Standard Deviations'</span>);
2181                 ylabel(H_Axes,[<span class="string">'Number of Points ('</span>,num2str(length(ErrorFunction)),<span class="string">' total points)'</span>]);
2182                 <span class="comment">%title(texlabel(['Histogram: (M_meas - M_model)']));</span>
2183                 title(texlabel([<span class="string">'Histogram: (M_meas - M_model) / sigma_bpm'</span>]));
2184                 <span class="comment">%title(texlabel(['Histogram: (M_meas - M_model)^2 / sigma^2_bpm']));</span>
2185                 
2186                 a = axis;
2187                 axis([a(1)-(a(2)-a(1))/60 a(2) a(3) a(4)]);
2188                 <span class="comment">%OutlierFactor = LocoFlags(i).OutlierFactor;</span>
2189             <span class="keyword">end</span>
2190 
2191         <span class="keyword">case</span> 22
2192             <span class="comment">% Horizontal dispersion function</span>
2193             plot(0,0); set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
2194             
2195             <span class="keyword">if</span> 1
2196                 <span class="comment">% Only plotting horizontal dispersion</span>
2197                 NHBPM = length(BPMData(i).HBPMGoodDataIndex);
2198                 x = 1:length(BPMData(i).HBPMIndex);
2199                 x = x(BPMData(i).HBPMGoodDataIndex);
2200                 
2201                 <span class="keyword">if</span> isempty(LocoModel(i).Eta)
2202                     EtaModel = NaN*ones(size(x))';
2203                     fprintf(<span class="string">'   Model dispersion is empty.\n'</span>);
2204                 <span class="keyword">else</span>
2205                     EtaModel = LocoModel(i).Eta(1:NHBPM);                   
2206                 <span class="keyword">end</span>
2207                 <span class="keyword">if</span> isempty(LocoMeasData.Eta)
2208                     EtaMeas = NaN*ones(size(x))';
2209                     fprintf(<span class="string">'   Measured dispersion is empty.\n'</span>);
2210                 <span class="keyword">else</span>
2211                     EtaMeas = LocoMeasData.Eta(BPMData(i).HBPMGoodDataIndex);
2212                 <span class="keyword">end</span>
2213                 
2214                 plot(x, EtaMeas,<span class="string">'-b'</span>);
2215                 hold on;
2216                 plot(x, EtaModel,<span class="string">'--r'</span>);        
2217                 
2218                 <span class="comment">% Add circles for the outliers</span>
2219                 EtaOutliers = LocoModel(i).EtaOutlierIndex;
2220                 j = find(EtaOutliers &lt;= NHBPM);      <span class="comment">% Only horizontal data</span>
2221                 <span class="keyword">if</span> ~isempty(j)
2222                     plot(x(EtaOutliers(j)),EtaMeas(EtaOutliers(j)),<span class="string">'og'</span>,<span class="string">'MarkerSize'</span>,2);
2223                     legend(<span class="string">'Measured'</span>,<span class="string">'Model'</span>,<span class="string">'Outliers'</span>,0);
2224                 <span class="keyword">else</span>
2225                     legend(<span class="string">'Measured'</span>,<span class="string">'Model'</span>,0);
2226                 <span class="keyword">end</span>
2227                 
2228                 hold off
2229                 title(sprintf(<span class="string">'&quot;Dispersion&quot; Function (%d BPMs)'</span>,length(EtaModel)));
2230                 ylabel(H_Axes,<span class="string">'&quot;Dispersion&quot; [mm]'</span>);
2231                 xlabel(H_Axes,<span class="string">'Horizontal BPM Number'</span>);
2232                 axis tight
2233             <span class="keyword">else</span>
2234                 <span class="comment">% Horizontal and vertical dispersion</span>
2235                 NHBPM = length(BPMData(i).HBPMGoodDataIndex);
2236                 NVBPM = length(BPMData(i).VBPMGoodDataIndex);
2237                 NBPM  = NHBPM + NVBPM;
2238                 NHCM = length(CMData(i).HCMGoodDataIndex);
2239                 NVCM = length(CMData(i).VCMGoodDataIndex);
2240                 
2241                 <span class="keyword">if</span> isempty(LocoModel(i).Eta)
2242                     EtaModel = NaN;
2243                     fprintf(<span class="string">'   Model dispersion is empty.\n'</span>);
2244                 <span class="keyword">else</span>
2245                     EtaModel = LocoModel(i).Eta;                   
2246                 <span class="keyword">end</span>
2247                 <span class="keyword">if</span> isempty(LocoMeasData.Eta)
2248                     EtaMeas = NaN;
2249                     fprintf(<span class="string">'   Measured dispersion is empty.\n'</span>);
2250                 <span class="keyword">else</span>
2251                     EtaMeas = LocoMeasData.Eta([BPMData(i).HBPMGoodDataIndex length(BPMData(i).HBPMIndex)+BPMData(i).VBPMGoodDataIndex]);
2252                 <span class="keyword">end</span>
2253                 
2254                 plot(EtaMeas,<span class="string">'-b'</span>);
2255                 hold on;
2256                 plot(EtaModel,<span class="string">'--r'</span>);        
2257                 
2258                 <span class="comment">% Add circles for the outliers</span>
2259                 EtaOutliers = LocoModel(i).EtaOutlierIndex;
2260                 x = 1:length(EtaMeas);
2261                 <span class="keyword">if</span> ~isempty(EtaOutliers)
2262                     plot(x(EtaOutliers),EtaMeas(EtaOutliers),<span class="string">'ob'</span>,<span class="string">'MarkerSize'</span>,2);
2263                     <span class="keyword">if</span> all(isnan(EtaModel))
2264                         fprintf(<span class="string">'   Model dispersion is NaN.\n'</span>);
2265                         legend(<span class="string">'Measured'</span>,<span class="string">'Outliers'</span>,0);
2266                     <span class="keyword">else</span>
2267                         legend(<span class="string">'Measured'</span>,<span class="string">'Model'</span>,<span class="string">'Outliers'</span>,0);
2268                     <span class="keyword">end</span>
2269                 <span class="keyword">else</span>
2270                     <span class="keyword">if</span> all(isnan(EtaModel))
2271                         fprintf(<span class="string">'   Model dispersion is NaN.\n'</span>);
2272                         <span class="comment">%legend off</span>
2273                         legend(<span class="string">'Measured'</span>,0);
2274                     <span class="keyword">else</span>
2275                         legend(<span class="string">'Measured'</span>,<span class="string">'Model'</span>,0);
2276                     <span class="keyword">end</span>
2277                 <span class="keyword">end</span>
2278                 
2279                 hold off
2280                 title(sprintf(<span class="string">'&quot;Dispersion&quot; Function (%d BPMs)'</span>,length(EtaModel)));
2281                 ylabel(H_Axes,<span class="string">'&quot;Dispersion&quot; [mm]'</span>);
2282                 xlabel(H_Axes,<span class="string">'BPM Number'</span>);
2283                 
2284                 <span class="comment">% Change label to BPM numbers</span>
2285                 Nx = length(EtaMeas);
2286                 Ticks = 1:ceil(Nx/10):Nx;
2287                 set(H_Axes, <span class="string">'XTick'</span>, Ticks);      
2288                 TickNumber = [BPMData(i).HBPMGoodDataIndex BPMData(i).VBPMGoodDataIndex];
2289                 TickNumber = TickNumber(Ticks);
2290                 set(H_Axes, <span class="string">'XTickLabel'</span>, num2cell(TickNumber));         
2291                 xlabel(H_Axes,<span class="string">'HBPM# and VBPM#'</span>);
2292                 
2293                 axis tight
2294             <span class="keyword">end</span>
2295             
2296         <span class="keyword">case</span> 23
2297             <span class="comment">% Vertical dispersion function</span>
2298             plot(0,0); set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
2299             
2300             <span class="comment">% Only plotting vertical dispersion</span>
2301             NHBPM = length(BPMData(i).HBPMGoodDataIndex);
2302             NVBPM = length(BPMData(i).VBPMGoodDataIndex);
2303             NBPM  = NHBPM + NVBPM;
2304             NHCM = length(CMData(i).HCMGoodDataIndex);
2305             NVCM = length(CMData(i).VCMGoodDataIndex);
2306             
2307             x = 1:length(BPMData(i).VBPMIndex);
2308             x = x(BPMData(i).VBPMGoodDataIndex);
2309             
2310             <span class="keyword">if</span> isempty(LocoModel(i).Eta)
2311                 EtaModel = NaN*ones(size(x))';
2312                 fprintf(<span class="string">'   Model dispersion is empty.\n'</span>);
2313             <span class="keyword">else</span>
2314                 EtaModel = LocoModel(i).Eta(NHBPM+(1:NVBPM));
2315             <span class="keyword">end</span>
2316             <span class="keyword">if</span> isempty(LocoMeasData.Eta)
2317                 EtaMeas = NaN*ones(size(x))';
2318                 fprintf(<span class="string">'   Measured dispersion is empty.\n'</span>);
2319             <span class="keyword">else</span>
2320                 EtaMeas = LocoMeasData.Eta(length(BPMData(i).HBPMIndex)+BPMData(i).VBPMGoodDataIndex);
2321             <span class="keyword">end</span>
2322             
2323             plot(x, EtaMeas,<span class="string">'-b'</span>);
2324             hold on;
2325             plot(x, EtaModel,<span class="string">'--r'</span>);        
2326             
2327             <span class="comment">% Add circles for the outliers</span>
2328             EtaOutliers = LocoModel(i).EtaOutlierIndex;
2329             j = find(EtaOutliers &gt; NHBPM);      <span class="comment">% Only vertical data</span>
2330             EtaOutliers = EtaOutliers(j) - NHBPM;
2331             <span class="keyword">if</span> ~isempty(j)
2332                 hold on
2333                 plot(x(EtaOutliers), EtaMeas(EtaOutliers), <span class="string">'og'</span>, <span class="string">'MarkerSize'</span>,2);
2334                 hold off
2335                 legend(<span class="string">'Measured'</span>, <span class="string">'Model'</span>, <span class="string">'Outliers'</span>, 0);
2336             <span class="keyword">else</span>
2337                 legend(<span class="string">'Measured'</span>,<span class="string">'Model'</span>,0);
2338             <span class="keyword">end</span>
2339             
2340             hold off
2341             title(sprintf(<span class="string">'&quot;Dispersion&quot; Function (%d BPMs)'</span>,length(EtaModel)));
2342             ylabel(H_Axes,<span class="string">'&quot;Dispersion&quot; [mm]'</span>);
2343             xlabel(H_Axes,<span class="string">'Vertical BPM Number'</span>);
2344             axis tight
2345             
2346         <span class="keyword">case</span> 24  
2347             <span class="comment">% Dispersion function error</span>
2348             plot(0,0); set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
2349             
2350             <span class="comment">% Horizontal dispersion</span>
2351             <span class="keyword">if</span> 1
2352                 <span class="comment">% Only plot horizontal dispersion</span>
2353                 NHBPM = length(BPMData(i).HBPMGoodDataIndex);
2354                 x = 1:length(BPMData(i).HBPMIndex);
2355                 x = x(BPMData(i).HBPMGoodDataIndex);
2356                 
2357                 <span class="keyword">if</span> isempty(LocoModel(i).Eta)
2358                     EtaModel = NaN*ones(size(x))';
2359                     fprintf(<span class="string">'   Model dispersion is empty.\n'</span>);
2360                 <span class="keyword">else</span>
2361                     EtaModel = LocoModel(i).Eta(1:NHBPM);                   
2362                 <span class="keyword">end</span>
2363                 <span class="keyword">if</span> isempty(LocoMeasData.Eta)
2364                     EtaMeas = NaN*ones(size(x))';
2365                     fprintf(<span class="string">'   Measured dispersion is empty.\n'</span>);
2366                 <span class="keyword">else</span>
2367                     EtaMeas = LocoMeasData.Eta(BPMData(i).HBPMGoodDataIndex);
2368                 <span class="keyword">end</span>
2369                 
2370                 plot(x, EtaMeas-EtaModel,<span class="string">'-b'</span>);
2371                 
2372                 <span class="comment">% Add circles for the outliers</span>
2373                 EtaOutliers = LocoModel(i).EtaOutlierIndex;
2374                 j = find(EtaOutliers &lt;= NHBPM);      <span class="comment">% Only horizontal data</span>
2375                 <span class="keyword">if</span> ~isempty(j)
2376                     hold on;
2377                     plot(x(EtaOutliers(j)),EtaMeas(EtaOutliers(j))-EtaModel(EtaOutliers(j)),<span class="string">'og'</span>,<span class="string">'MarkerSize'</span>,2);
2378                     hold off;
2379                     legend(<span class="string">'Measured-Model'</span>,<span class="string">'Outliers'</span>,0);
2380                 <span class="keyword">end</span>
2381                 
2382                 <span class="keyword">if</span> all(isnan(EtaModel))
2383                     fprintf(<span class="string">'   Model dispersion is NaN.\n'</span>);
2384                     legend off
2385                 <span class="keyword">end</span>
2386                 
2387                 hold off
2388                 title(sprintf(<span class="string">'&quot;Dispersion&quot; Function Error (%d BPMs)'</span>,length(EtaModel)));
2389                 ylabel(H_Axes,<span class="string">'&quot;Dispersion&quot; Error [mm]'</span>);
2390                 xlabel(H_Axes,<span class="string">'Horizontal BPM Number'</span>);
2391                 axis tight
2392             <span class="keyword">else</span>
2393                 <span class="comment">% Horizontal and vertical dispersion</span>
2394                 NHBPM = length(BPMData(i).HBPMGoodDataIndex);
2395                 NVBPM = length(BPMData(i).VBPMGoodDataIndex);
2396                 NBPM  = NHBPM + NVBPM;
2397                 NHCM = length(CMData(i).HCMGoodDataIndex);
2398                 NVCM = length(CMData(i).VCMGoodDataIndex);
2399                 
2400                 <span class="keyword">if</span> isempty(LocoModel(i).Eta)
2401                     EtaModel = NaN;
2402                     fprintf(<span class="string">'   Model dispersion is empty.\n'</span>);
2403                 <span class="keyword">else</span>
2404                     EtaModel = LocoModel(i).Eta;                   
2405                 <span class="keyword">end</span>
2406                 <span class="keyword">if</span> isempty(LocoMeasData.Eta)
2407                     EtaMeas = NaN;
2408                     fprintf(<span class="string">'   Measured dispersion is empty.\n'</span>);
2409                 <span class="keyword">else</span>
2410                     EtaMeas = LocoMeasData.Eta([BPMData(i).HBPMGoodDataIndex length(BPMData(i).HBPMIndex)+BPMData(i).VBPMGoodDataIndex]);
2411                 <span class="keyword">end</span>
2412                 
2413                 plot(EtaMeas-EtaModel,<span class="string">'-b'</span>);
2414                 
2415                 <span class="comment">% Add circles for the outliers</span>
2416                 EtaOutliers = LocoModel(i).EtaOutlierIndex;
2417                 x = 1:length(EtaMeas);
2418                 <span class="keyword">if</span> ~isempty(EtaOutliers)
2419                     hold on;
2420                     plot(x(EtaOutliers),EtaMeas(EtaOutliers)-EtaModel(EtaOutliers),<span class="string">'og'</span>,<span class="string">'MarkerSize'</span>,2);
2421                     hold off;
2422                     legend(<span class="string">'Measured-Model'</span>,<span class="string">'Outliers'</span>,0);
2423                 <span class="keyword">end</span>
2424                 
2425                 hold off
2426                 title(sprintf(<span class="string">'&quot;Dispersion&quot; Function Error (%d BPMs)'</span>,length(EtaModel)));
2427                 ylabel(H_Axes,<span class="string">'&quot;Dispersion&quot; Error [mm]'</span>);
2428                 xlabel(H_Axes,<span class="string">'BPM Number'</span>);
2429                 
2430                 <span class="comment">% Change label to BPM numbers</span>
2431                 Nx = length(EtaMeas);
2432                 Ticks = 1:ceil(Nx/10):Nx;
2433                 set(H_Axes, <span class="string">'XTick'</span>, Ticks);      
2434                 TickNumber = [BPMData(i).HBPMGoodDataIndex BPMData(i).VBPMGoodDataIndex];
2435                 TickNumber = TickNumber(Ticks);
2436                 set(H_Axes, <span class="string">'XTickLabel'</span>, num2cell(TickNumber));         
2437                 xlabel(H_Axes,<span class="string">'HBPM# and VBPM#'</span>);
2438                 
2439                 axis tight
2440             <span class="keyword">end</span>
2441             
2442         <span class="keyword">case</span> 25
2443             <span class="comment">% Vertical dispersion error function</span>
2444             plot(0,0); set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
2445             
2446             <span class="comment">% Only plotting vertical dispersion</span>
2447             NHBPM = length(BPMData(i).HBPMGoodDataIndex);
2448             NVBPM = length(BPMData(i).VBPMGoodDataIndex);
2449             NBPM  = NHBPM + NVBPM;
2450             NHCM = length(CMData(i).HCMGoodDataIndex);
2451             NVCM = length(CMData(i).VCMGoodDataIndex);
2452             
2453             x = 1:length(BPMData(i).VBPMIndex);
2454             x = x(BPMData(i).VBPMGoodDataIndex);
2455             
2456             <span class="keyword">if</span> isempty(LocoModel(i).Eta)
2457                 EtaModel = NaN*ones(size(x))';
2458                 fprintf(<span class="string">'   Model dispersion is empty.\n'</span>);
2459             <span class="keyword">else</span>
2460                 EtaModel = LocoModel(i).Eta(NHBPM+(1:NVBPM));
2461             <span class="keyword">end</span>
2462             <span class="keyword">if</span> isempty(LocoMeasData.Eta)
2463                 EtaMeas = NaN*ones(size(x))';
2464                 fprintf(<span class="string">'   Measured dispersion is empty.\n'</span>);
2465             <span class="keyword">else</span>
2466                 EtaMeas = LocoMeasData.Eta(length(BPMData(i).HBPMIndex)+BPMData(i).VBPMGoodDataIndex);
2467             <span class="keyword">end</span>
2468             
2469             plot(x, EtaMeas-EtaModel,<span class="string">'-b'</span>);
2470             
2471             <span class="comment">% Add circles for the outliers</span>
2472             EtaOutliers = LocoModel(i).EtaOutlierIndex;
2473             j = find(EtaOutliers &gt; NHBPM);      <span class="comment">% Only vertical data</span>
2474             EtaOutliers = EtaOutliers(j) - NHBPM;
2475             <span class="keyword">if</span> ~isempty(j)
2476                 hold on
2477                 plot(x(EtaOutliers), EtaMeas(EtaOutliers)-EtaModel(EtaOutliers), <span class="string">'og'</span>, <span class="string">'MarkerSize'</span>,2);
2478                 hold off
2479                 legend(<span class="string">'Measured-Model'</span>,<span class="string">'Outliers'</span>,0);
2480             <span class="keyword">end</span>
2481             
2482             title(sprintf(<span class="string">'&quot;Dispersion&quot; Function Error (%d BPMs)'</span>,length(EtaModel)));
2483             ylabel(H_Axes,<span class="string">'&quot;Dispersion&quot; Error [mm]'</span>);
2484             xlabel(H_Axes,<span class="string">'Vertical BPM Number'</span>);
2485             axis tight
2486             
2487         <span class="keyword">case</span> 26
2488             <span class="comment">% Horizontal Beta</span>
2489             plot(H_Axes,[0 1],[0 1],<span class="string">'w'</span>); set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
2490             set(H_Axes,<span class="string">'box'</span>,<span class="string">'on'</span>);
2491             text(4,11,sprintf(<span class="string">'Please wait ...'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
2492             text(4, 9,sprintf(<span class="string">'Computing Beta Functions'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
2493             drawnow;
2494             
2495             [Beta1, Tune1] = <a href="locodata.html" class="code" title="function varargout = locodata(FileName, IterationNumber, varargin)">locodata</a>({BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData}, i-1, <span class="string">'Beta'</span>,[],<span class="string">'Tune'</span>,[]);
2496             <span class="keyword">if</span> ~isempty(Beta1) &amp;&amp; isreal(Beta1)
2497                 plot(Beta1(:,3), Beta1(:,1), <span class="string">'b'</span>);
2498                 xlabel(H_Axes,<span class="string">'Position [meters]'</span>);
2499                 ylabel(H_Axes,<span class="string">'Horizontal Beta Function [meters]'</span>);
2500                 title(texlabel(sprintf(<span class="string">'Model Beta Function (nu_x=%.4f)'</span>,Tune1(1))));
2501                 <span class="keyword">try</span>
2502                     L = findspos(RINGData.Lattice,length(RINGData.Lattice)+1);
2503                     <span class="keyword">if</span> ~isempty(Beta1)
2504                         set(H_Axes, <span class="string">'XLim'</span>, [0 L]);
2505                     <span class="keyword">end</span>
2506                 <span class="keyword">catch</span>
2507                 <span class="keyword">end</span>
2508             <span class="keyword">else</span>
2509                 plot(H_Axes,[0 1],[0 1],<span class="string">'w'</span>);
2510                 title(H_Axes,<span class="string">''</span>);
2511                 set(H_Axes,<span class="string">'box'</span>,<span class="string">'on'</span>);
2512                 set(H_Axes,<span class="string">'XTick'</span>,[]);
2513                 set(H_Axes,<span class="string">'YTick'</span>,[]);
2514                 text(4, 9,sprintf(<span class="string">'There was a problem computing the beta function.'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
2515                 drawnow;
2516             <span class="keyword">end</span>
2517             
2518         <span class="keyword">case</span> 27
2519             <span class="comment">% Vertical Beta</span>
2520             plot(H_Axes,[0 1],[0 1],<span class="string">'w'</span>); set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
2521             set(H_Axes,<span class="string">'box'</span>,<span class="string">'on'</span>);
2522             text(4,11,sprintf(<span class="string">'Please wait ...'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
2523             text(4, 9,sprintf(<span class="string">'Computing Beta Functions'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
2524             drawnow;
2525             
2526             [Beta1, Tune1] = <a href="locodata.html" class="code" title="function varargout = locodata(FileName, IterationNumber, varargin)">locodata</a>({BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData}, i-1, <span class="string">'Beta'</span>,[],<span class="string">'Tune'</span>,[]);
2527             <span class="keyword">if</span> ~isempty(Beta1) &amp;&amp; isreal(Beta1)
2528                 plot(Beta1(:,3), Beta1(:,2), <span class="string">'b'</span>); 
2529                 xlabel(H_Axes,<span class="string">'Position [meters]'</span>);
2530                 ylabel(H_Axes,<span class="string">'Vertical Beta Function [meters]'</span>);
2531                 title(texlabel(sprintf(<span class="string">'Model Beta Function (nu_y=%.4f)'</span>, Tune1(2))));
2532                 <span class="keyword">try</span>
2533                     L = findspos(RINGData.Lattice,length(RINGData.Lattice)+1);
2534                     <span class="keyword">if</span> ~isempty(Beta1)
2535                         set(H_Axes, <span class="string">'XLim'</span>, [0 L]);
2536                     <span class="keyword">end</span>
2537                 <span class="keyword">catch</span>
2538                 <span class="keyword">end</span>
2539             <span class="keyword">else</span>
2540                 plot(H_Axes,[0 1],[0 1],<span class="string">'w'</span>);
2541                 title(H_Axes,<span class="string">''</span>);
2542                 set(H_Axes,<span class="string">'box'</span>,<span class="string">'on'</span>);
2543                 set(H_Axes,<span class="string">'XTick'</span>,[]);
2544                 set(H_Axes,<span class="string">'YTick'</span>,[]);
2545                 text(4, 9,sprintf(<span class="string">'There was a problem computing the beta function.'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
2546                 drawnow;
2547             <span class="keyword">end</span>
2548 
2549         <span class="keyword">case</span> 28
2550             <span class="comment">% Horizontal Beta Beat</span>
2551             plot(H_Axes,[0 1],[0 1],<span class="string">'w'</span>); set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
2552             set(H_Axes,<span class="string">'box'</span>,<span class="string">'on'</span>);
2553             text(4,11,sprintf(<span class="string">'Please wait ...'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
2554             text(4, 9,sprintf(<span class="string">'Computing Beta Functions'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
2555             drawnow;
2556             
2557             [Beta1, Tune1] = <a href="locodata.html" class="code" title="function varargout = locodata(FileName, IterationNumber, varargin)">locodata</a>({BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData}, i-1, <span class="string">'Beta'</span>,[],<span class="string">'Tune'</span>,[]);
2558             [Beta0, Tune0] = <a href="locodata.html" class="code" title="function varargout = locodata(FileName, IterationNumber, varargin)">locodata</a>({BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData},   0, <span class="string">'Beta'</span>,[],<span class="string">'Tune'</span>,[]);
2559             <span class="keyword">if</span> ~isempty(Beta1) &amp;&amp; ~isempty(Beta0) &amp;&amp; isreal(Beta1) &amp;&amp; isreal(Beta0)
2560                 <span class="comment">%plot(Beta1(:,3), Beta1(:,1)-Beta0(:,1), 'b');</span>
2561                 <span class="comment">%ylabel(sprintf('Horizontal Beta(%d)-Beta(0) [meters]',i-1));</span>
2562                 plot(Beta1(:,3), Beta1(:,1)./Beta0(:,1), <span class="string">'b'</span>);
2563                 ylabel(sprintf(<span class="string">'Horizontal Beta(%d)/Beta(0)'</span>,i-1));
2564                 xlabel(H_Axes,<span class="string">'BPM Position [meters]'</span>);
2565                 title(texlabel(sprintf(<span class="string">'Beta Beat (nu_x(%d)=%.4f, nu_x(0)=%.4f)'</span>,i-1, Tune1(1),Tune0(1))));
2566                 <span class="keyword">try</span>
2567                     L = findspos(RINGData.Lattice,length(RINGData.Lattice)+1);
2568                     <span class="keyword">if</span> ~isempty(Beta1)
2569                         set(H_Axes, <span class="string">'XLim'</span>, [0 L]);
2570                     <span class="keyword">end</span>
2571                 <span class="keyword">catch</span>
2572                 <span class="keyword">end</span>
2573             <span class="keyword">else</span>
2574                 plot(H_Axes,[0 1],[0 1],<span class="string">'w'</span>);
2575                 title(H_Axes,<span class="string">''</span>);
2576                 set(H_Axes,<span class="string">'box'</span>,<span class="string">'on'</span>);
2577                 set(H_Axes,<span class="string">'XTick'</span>,[]);
2578                 set(H_Axes,<span class="string">'YTick'</span>,[]);
2579                 text(4, 9,sprintf(<span class="string">'There was a problem computing the beta function.'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
2580                 drawnow;
2581             <span class="keyword">end</span>
2582 
2583             <span class="comment">%h = uimenu(hcmenu, 'Label', 'Beta Beat', 'Callback', 'locogui(''ContextMenuBetaBeat_Callback'',gcbo,[],[])');</span>
2584             <span class="comment">%set(h,'Userdata',{'Model-Measured','VCM'});</span>
2585             
2586         <span class="keyword">case</span> 29
2587             <span class="comment">% Vertical Beta Beat</span>
2588             plot(H_Axes,[0 1],[0 1],<span class="string">'w'</span>); set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
2589             set(H_Axes,<span class="string">'box'</span>,<span class="string">'on'</span>);
2590             text(4,11,sprintf(<span class="string">'Please wait ...'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
2591             text(4, 9,sprintf(<span class="string">'Computing Beta Functions'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
2592             drawnow;
2593             
2594             [Beta1, Tune1] = <a href="locodata.html" class="code" title="function varargout = locodata(FileName, IterationNumber, varargin)">locodata</a>({BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData}, i-1, <span class="string">'Beta'</span>,[],<span class="string">'Tune'</span>,[]);
2595             [Beta0, Tune0] = <a href="locodata.html" class="code" title="function varargout = locodata(FileName, IterationNumber, varargin)">locodata</a>({BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData},   0, <span class="string">'Beta'</span>,[],<span class="string">'Tune'</span>,[]);
2596             <span class="keyword">if</span> ~isempty(Beta1) &amp;&amp; ~isempty(Beta0) &amp;&amp; isreal(Beta1) &amp;&amp; isreal(Beta0)
2597                 <span class="comment">%plot(Beta1(:,3), Beta1(:,2)-Beta0(:,2), 'b');</span>
2598                 <span class="comment">%ylabel(sprintf('Vertical Beta(%d)-Beta(0) [meters]',i-1));</span>
2599                 plot(Beta1(:,3), Beta1(:,2)./Beta0(:,2), <span class="string">'b'</span>); 
2600                 ylabel(sprintf(<span class="string">'Vertical Beta(%d)/Beta(0)'</span>,i-1));
2601                 xlabel(H_Axes,<span class="string">'BPM Position [meters]'</span>);
2602                 title(texlabel(sprintf(<span class="string">'Beta Beat (nu_y(%d)=%.4f, nu_y(0)=%.4f)'</span>,i-1, Tune1(2),Tune0(2))));
2603                 <span class="keyword">try</span>
2604                     L = findspos(RINGData.Lattice,length(RINGData.Lattice)+1);
2605                     <span class="keyword">if</span> ~isempty(Beta1)
2606                         set(H_Axes, <span class="string">'XLim'</span>, [0 L]);
2607                     <span class="keyword">end</span>
2608                 <span class="keyword">catch</span>
2609                 <span class="keyword">end</span>
2610             <span class="keyword">else</span>
2611                 plot(H_Axes,[0 1],[0 1],<span class="string">'w'</span>);
2612                 title(H_Axes,<span class="string">''</span>);
2613                 set(H_Axes,<span class="string">'box'</span>,<span class="string">'on'</span>);
2614                 set(H_Axes,<span class="string">'XTick'</span>,[]);
2615                 set(H_Axes,<span class="string">'YTick'</span>,[]);
2616                 text(4, 9,sprintf(<span class="string">'There was a problem computing the beta function.'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
2617                 drawnow;
2618             <span class="keyword">end</span>
2619             
2620         <span class="keyword">case</span> 30
2621             <span class="keyword">if</span> isempty(Mmodel)
2622                 set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
2623             <span class="keyword">else</span>
2624                 <a href="locoplotrms.html" class="code" title="function locoplotrms(FileName, IterationNumber, PlotType)">locoplotrms</a>({BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData}, i-1, 1);
2625             <span class="keyword">end</span>
2626         <span class="keyword">case</span> 31
2627             <span class="keyword">if</span> isempty(Mmodel)
2628                 set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
2629             <span class="keyword">else</span>
2630                 <a href="locoplotrms.html" class="code" title="function locoplotrms(FileName, IterationNumber, PlotType)">locoplotrms</a>({BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData}, i-1, 3);
2631             <span class="keyword">end</span>
2632 
2633         <span class="keyword">case</span> 32
2634             <span class="keyword">if</span> isempty(Mmodel)
2635                 set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
2636             <span class="keyword">else</span>
2637                 <a href="locoplotrms.html" class="code" title="function locoplotrms(FileName, IterationNumber, PlotType)">locoplotrms</a>({BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData}, i-1, 2);
2638             <span class="keyword">end</span>
2639         <span class="keyword">case</span> 33
2640             <span class="keyword">if</span> isempty(Mmodel)
2641                 set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
2642             <span class="keyword">else</span>
2643                 <a href="locoplotrms.html" class="code" title="function locoplotrms(FileName, IterationNumber, PlotType)">locoplotrms</a>({BPMData, CMData, LocoMeasData, LocoModel, FitParameters, LocoFlags, RINGData}, i-1, 4);
2644             <span class="keyword">end</span>
2645     <span class="keyword">end</span>
2646     
2647 <span class="keyword">catch</span>
2648     set(H_Axes,<span class="string">'XTick'</span>,[]); set(H_Axes,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
2649     fprintf(<span class="string">'Plot failed: %s\n'</span>, lasterr);
2650 <span class="keyword">end</span>
2651 
2652 axes(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'ChiSquare'</span>));
2653 cla;
2654 <span class="keyword">if</span> ~isempty(LocoModel(i).ChiSquare)
2655     <span class="keyword">if</span> LocoModel(i).ChiSquare~=0
2656         text(0,.5,sprintf(<span class="string">'\\fontsize{12}\\chi^{2}_{\\fontsize{8}total} \\fontsize{9}/ D.O.F \\fontsize{10}= %f'</span>, LocoModel(i).ChiSquare));
2657     <span class="keyword">end</span>
2658 <span class="keyword">end</span>
2659 
2660 drawnow;
2661 
2662 
2663 <span class="comment">% % --------------------------------------------------------------------</span>
2664 <span class="comment">% function varargout = ContextMenuBetaBeat_Callback(h, eventdata, handles, varargin)</span>
2665 <span class="comment">% %FieldName = get(h,'Userdata');</span>
2666 <span class="comment">%</span>
2667 <span class="comment">% FileName = get(findobj(gcbf,'Tag','FileName'),'Userdata');</span>
2668 <span class="comment">% if isempty(FileName)</span>
2669 <span class="comment">%     return</span>
2670 <span class="comment">% end</span>
2671 <span class="comment">% try</span>
2672 <span class="comment">%     load(FileName);</span>
2673 <span class="comment">% catch</span>
2674 <span class="comment">%     fprintf('   File does not exist or is not a *.mat file type.\n');</span>
2675 <span class="comment">%     cla;</span>
2676 <span class="comment">%     return</span>
2677 <span class="comment">% end</span>
2678 <span class="comment">%</span>
2679 <span class="comment">% i = get(findobj(gcbf,'Tag','PlotIteration'),'Value');  % The first point in the array is starting point</span>
2680 
2681 
2682 
2683 <span class="comment">% --------------------------------------------------------------------</span>
2684 <a name="_sub26" href="#_subfunctions" class="code">function varargout = ContextCostFunctionPlot_Callback(h, eventdata, handles, varargin)</a>
2685 Userdata = get(h,<span class="string">'Userdata'</span>);
2686 FieldName = Userdata{1};
2687 H_Axes = Userdata{2};
2688 
2689 AxesTag = get(gca,<span class="string">'Tag'</span>);
2690 <span class="keyword">if</span> strcmp(AxesTag,<span class="string">'Axes1'</span>)
2691     setappdata(gcbf, <span class="string">'CostFunctionPlot1'</span>, Userdata);
2692 <span class="keyword">elseif</span> strcmp(AxesTag,<span class="string">'Axes2'</span>)
2693     setappdata(gcbf, <span class="string">'CostFunctionPlot2'</span>, Userdata);
2694 <span class="keyword">end</span>
2695 
2696 <a href="#_sub27" class="code" title="subfunction PlotCostFunction">PlotCostFunction</a>;
2697 
2698 
2699 <a name="_sub27" href="#_subfunctions" class="code">function PlotCostFunction</a>
2700 
2701 LogPlotFlag = 1;
2702 
2703 AxesTag = get(gca,<span class="string">'Tag'</span>);
2704 <span class="keyword">if</span> strcmp(AxesTag,<span class="string">'Axes1'</span>)
2705     Userdata = getappdata(gcbf, <span class="string">'CostFunctionPlot1'</span>);
2706     TagString = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotMenu1'</span>),<span class="string">'Userdata'</span>);   <span class="comment">% Axis tag is storage in the menu pulldown</span>
2707 <span class="keyword">elseif</span> strcmp(AxesTag,<span class="string">'Axes2'</span>)
2708     Userdata = getappdata(gcbf, <span class="string">'CostFunctionPlot2'</span>);
2709     TagString = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotMenu2'</span>),<span class="string">'Userdata'</span>);   <span class="comment">% Axis tag is storage in the menu pulldown</span>
2710 <span class="keyword">end</span>
2711 
2712 FieldName = Userdata{1};
2713 H_Axes = Userdata{2};
2714 
2715 FileName = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FileName'</span>),<span class="string">'Userdata'</span>);
2716 <span class="keyword">if</span> isempty(FileName)
2717     <span class="keyword">return</span>
2718 <span class="keyword">end</span>
2719 <span class="keyword">try</span>
2720     load(FileName);
2721 <span class="keyword">catch</span>
2722     fprintf(<span class="string">'   File does not exist or is not a *.mat file type.\n'</span>);
2723     cla;
2724     <span class="keyword">return</span>
2725 <span class="keyword">end</span>
2726 i = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotIteration'</span>),<span class="string">'Value'</span>);  <span class="comment">% The first point in the array is starting point</span>
2727 
2728 axes(H_Axes);
2729 
2730 
2731 CostScaleFactor = 1;
2732 <span class="keyword">if</span> strcmpi(LocoFlags(i).Method.Name, <span class="string">'Gauss-Newton With Cost Function'</span>) &amp;&amp; isfield(LocoFlags(i).Method, <span class="string">'CostScaleFactor'</span>) &amp;&amp; ~isempty(LocoFlags(i).Method.CostScaleFactor)
2733     CostScaleFactor = LocoFlags(i).Method.CostScaleFactor;
2734 <span class="keyword">end</span>
2735 
2736 
2737 <span class="keyword">if</span> strcmpi(FieldName, <span class="string">'All'</span>)
2738     FieldCell = fieldnames(LocoFlags(i).Method.Cost);
2739     Total = [];
2740     <span class="keyword">for</span> ifield = 1:length(FieldCell)
2741         NewData = LocoFlags(i).Method.Cost.(FieldCell{ifield});
2742         Total = [Total; NewData(:)];
2743     <span class="keyword">end</span>
2744     axes(H_Axes);
2745     <span class="keyword">if</span> LogPlotFlag &amp;&amp; all(Total&gt;0)
2746         semilogy(1:length(Total), CostScaleFactor * Total);
2747     <span class="keyword">else</span>
2748         plot(1:length(Total), CostScaleFactor * Total);
2749     <span class="keyword">end</span>
2750     title(H_Axes,<span class="string">''</span>);
2751     xlabel(H_Axes,<span class="string">'All Fit Parameters'</span>, <span class="string">'FontSize'</span>, 10);
2752     ylabel(H_Axes,<span class="string">'Cost'</span>);
2753     title(H_Axes,<span class="string">'Parameter Cost'</span>, <span class="string">'FontSize'</span>, 10);
2754 <span class="keyword">else</span>
2755     <span class="keyword">if</span> LogPlotFlag &amp;&amp; all(LocoFlags(i).Method.Cost.(FieldName)&gt;0)
2756         semilogy(1:length(LocoFlags(i).Method.Cost.(FieldName)), CostScaleFactor * LocoFlags(i).Method.Cost.(FieldName));
2757     <span class="keyword">else</span>
2758         plot(1:length(LocoFlags(i).Method.Cost.(FieldName)), CostScaleFactor * LocoFlags(i).Method.Cost.(FieldName));
2759     <span class="keyword">end</span>
2760     title(H_Axes,<span class="string">''</span>);
2761     xlabel(H_Axes,sprintf(<span class="string">'%s Number'</span>, FieldName), <span class="string">'FontSize'</span>, 10);
2762     ylabel(H_Axes,<span class="string">'Cost'</span>);
2763     title(H_Axes,sprintf(<span class="string">'Parameter Cost for %s'</span>, FieldName), <span class="string">'FontSize'</span>, 10);
2764 <span class="keyword">end</span>
2765 <span class="comment">%grid  on;</span>
2766 a1 = axis;
2767 axis tight;
2768 a2 = axis;
2769 axis([a2(1:2) a1(3:4)]);
2770 
2771 set(gca,<span class="string">'Tag'</span>,TagString);                 <span class="comment">% axes tag is lost if plot function is used</span>
2772 set(gca,<span class="string">'HandleVisibility'</span>,<span class="string">'Callback'</span>);   <span class="comment">% So no one else can plot to it.</span>
2773 
2774 
2775 
2776 
2777 <span class="comment">% --------------------------------------------------------------------</span>
2778 <a name="_sub28" href="#_subfunctions" class="code">function varargout = ContextPartialChi2Plot_Callback(h, eventdata, handles, varargin)</a>
2779 Userdata = get(h,<span class="string">'Userdata'</span>);
2780 FieldName = Userdata{1};
2781 H_Axes = Userdata{2};
2782 
2783 AxesTag = get(gca,<span class="string">'Tag'</span>);
2784 <span class="keyword">if</span> strcmp(AxesTag,<span class="string">'Axes1'</span>)
2785     setappdata(gcbf, <span class="string">'PartialChi2Plot1'</span>, Userdata);
2786 <span class="keyword">elseif</span> strcmp(AxesTag,<span class="string">'Axes2'</span>)
2787     setappdata(gcbf, <span class="string">'PartialChi2Plot2'</span>, Userdata);
2788 <span class="keyword">end</span>
2789 
2790 <a href="#_sub29" class="code" title="subfunction PlotPartialChi2">PlotPartialChi2</a>;
2791 
2792 
2793 <a name="_sub29" href="#_subfunctions" class="code">function PlotPartialChi2</a>
2794 
2795 LogPlotFlag = 1;
2796 
2797 AxesTag = get(gca,<span class="string">'Tag'</span>);
2798 <span class="keyword">if</span> strcmp(AxesTag,<span class="string">'Axes1'</span>)
2799     Userdata = getappdata(gcbf, <span class="string">'PartialChi2Plot1'</span>);
2800     TagString = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotMenu1'</span>),<span class="string">'Userdata'</span>);   <span class="comment">% Axis tag is storage in the menu pulldown</span>
2801 <span class="keyword">elseif</span> strcmp(AxesTag,<span class="string">'Axes2'</span>)
2802     Userdata = getappdata(gcbf, <span class="string">'PartialChi2Plot2'</span>);
2803     TagString = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotMenu2'</span>),<span class="string">'Userdata'</span>);   <span class="comment">% Axis tag is storage in the menu pulldown</span>
2804 <span class="keyword">end</span>
2805 
2806 FieldName = Userdata{1};
2807 H_Axes = Userdata{2};
2808 
2809 FileName = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'FileName'</span>),<span class="string">'Userdata'</span>);
2810 <span class="keyword">if</span> isempty(FileName)
2811     <span class="keyword">return</span>
2812 <span class="keyword">end</span>
2813 <span class="keyword">try</span>
2814     load(FileName);
2815 <span class="keyword">catch</span>
2816     fprintf(<span class="string">'   File does not exist or is not a *.mat file type.\n'</span>);
2817     cla;
2818     <span class="keyword">return</span>
2819 <span class="keyword">end</span>
2820 i = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotIteration'</span>),<span class="string">'Value'</span>);  <span class="comment">% The first point in the array is starting point</span>
2821 
2822 axes(H_Axes);
2823 
2824 <span class="keyword">if</span> strcmpi(FieldName, <span class="string">'All'</span>)
2825     FieldCell = fieldnames(LocoFlags(i).Method.PartialChi2);
2826     Total = [];
2827     <span class="keyword">for</span> ifield = 1:length(FieldCell)
2828         NewData = LocoFlags(i).Method.PartialChi2.(FieldCell{ifield});
2829         Total = [Total; NewData(:)];
2830     <span class="keyword">end</span>
2831     axes(H_Axes);
2832     <span class="keyword">if</span> LogPlotFlag
2833         semilogy(1:length(Total), Total);
2834     <span class="keyword">else</span>
2835         plot(1:length(Total), Total);
2836     <span class="keyword">end</span>
2837     title(H_Axes,<span class="string">''</span>);
2838     xlabel(H_Axes,<span class="string">'All Fit Parameters'</span>, <span class="string">'FontSize'</span>, 10);
2839     ylabel(H_Axes,<span class="string">'\fontsize{14}\partial \chi^2 / \partial \fontsize{9}Fit Parameter'</span>);
2840     title(H_Axes,<span class="string">'Change in \chi^2 w.r.t. Each Fit Parameter'</span>, <span class="string">'FontSize'</span>, 10);
2841 <span class="keyword">else</span>
2842     <span class="keyword">if</span> LogPlotFlag
2843         semilogy(1:length(LocoFlags(i).Method.PartialChi2.(FieldName)), LocoFlags(i).Method.PartialChi2.(FieldName));
2844     <span class="keyword">else</span>
2845         plot(1:length(LocoFlags(i).Method.PartialChi2.(FieldName)), LocoFlags(i).Method.PartialChi2.(FieldName));
2846     <span class="keyword">end</span>
2847     title(H_Axes,<span class="string">''</span>);
2848     xlabel(H_Axes,sprintf(<span class="string">'%s Number'</span>, FieldName), <span class="string">'FontSize'</span>, 10);
2849     ylabel(H_Axes,sprintf(<span class="string">'\\fontsize{14}\\partial \\chi^2 / \\partial \\fontsize{10}%s'</span>, FieldName));
2850     title(H_Axes,sprintf(<span class="string">'Change in \\chi^2 w.r.t. Each %s Fit Parameter'</span>, FieldName), <span class="string">'FontSize'</span>, 10);
2851 <span class="keyword">end</span>
2852 <span class="comment">%grid  on;</span>
2853 a1 = axis;
2854 axis tight;
2855 a2 = axis;
2856 axis([a2(1:2) a1(3:4)]);
2857 
2858 set(gca,<span class="string">'Tag'</span>,TagString);                 <span class="comment">% axes tag is lost if plot function is used</span>
2859 set(gca,<span class="string">'HandleVisibility'</span>,<span class="string">'Callback'</span>);   <span class="comment">% So no one else can plot to it.</span>
2860 
2861 
2862 <span class="comment">% --------------------------------------------------------------------</span>
2863 <a name="_sub30" href="#_subfunctions" class="code">function varargout = ContextMenuPlot_Callback(h, eventdata, handles, varargin)</a>
2864 FieldName = get(h,<span class="string">'Userdata'</span>);
2865 
2866 AxesTag = get(gca,<span class="string">'Tag'</span>);
2867 <span class="keyword">if</span> strcmp(AxesTag,<span class="string">'Axes1'</span>)
2868     TagString = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotMenu1'</span>),<span class="string">'Userdata'</span>);   <span class="comment">% Axis tag is storage in the menu pulldown</span>
2869     setappdata(gcbf,<span class="string">'OtherParameterPlot1'</span>,FieldName);
2870 <span class="keyword">elseif</span> strcmp(AxesTag,<span class="string">'Axes2'</span>)
2871     TagString = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotMenu2'</span>),<span class="string">'Userdata'</span>);   <span class="comment">% Axis tag is storage in the menu pulldown</span>
2872     setappdata(gcbf,<span class="string">'OtherParameterPlot2'</span>,FieldName);
2873 <span class="keyword">else</span>
2874     <span class="comment">%error('problem with AxesTag name')</span>
2875 <span class="keyword">end</span>
2876 h_axis = findobj(gcbf,<span class="string">'Tag'</span>,TagString);
2877 axes(h_axis);
2878 <a href="#_sub25" class="code" title="subfunction locoplots(PlotNumber, FieldName)">locoplots</a>(15, FieldName);
2879 
2880 axes(h_axis);
2881 legend
2882 set(gca,<span class="string">'Tag'</span>,TagString);                 <span class="comment">% axes tag is lost if plot function is used</span>
2883 set(gca,<span class="string">'HandleVisibility'</span>,<span class="string">'Callback'</span>);   <span class="comment">% So no one else can plot to it.</span>
2884 
2885 
2886 <span class="comment">% --------------------------------------------------------------------</span>
2887 <a name="_sub31" href="#_subfunctions" class="code">function varargout = ContextMenuSurfPlot_Callback(h, eventdata, handles, varargin)</a>
2888 FieldName = get(h,<span class="string">'Userdata'</span>);
2889 
2890 AxesTag = get(gca,<span class="string">'Tag'</span>);
2891 <span class="keyword">if</span> strcmp(AxesTag,<span class="string">'Axes1'</span>)
2892     TagString = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotMenu1'</span>),<span class="string">'Userdata'</span>);   <span class="comment">% Axis tag is storage in the menu pulldown</span>
2893     h1 = findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SurfPlot1'</span>);
2894     set(h1,<span class="string">'Userdata'</span>, FieldName);
2895 <span class="keyword">elseif</span> strcmp(AxesTag,<span class="string">'Axes2'</span>)
2896     TagString = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotMenu2'</span>),<span class="string">'Userdata'</span>);   <span class="comment">% Axis tag is storage in the menu pulldown</span>
2897     h1 = findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SurfPlot2'</span>);
2898     set(h1,<span class="string">'Userdata'</span>, FieldName);
2899 <span class="keyword">else</span>
2900     <span class="comment">%error('problem with AxesTag name')</span>
2901 <span class="keyword">end</span>
2902 
2903 h_axis = findobj(gcbf,<span class="string">'Tag'</span>,TagString);
2904 axes(h_axis);
2905 
2906 <span class="comment">%FileName = get(findobj(gcbf,'Tag','FileName'),'Userdata');</span>
2907 LocoDataCell = getappdata(gcbf, <span class="string">'LocoDataCell'</span>);
2908 Iteration = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'PlotIteration'</span>),<span class="string">'Value'</span>)-1;
2909 ElementsInput = <a href="locoplot.html" class="code" title="function ElementsInput = locoplot(FileName, IterationNumber, PlotString, PlaneString, ElementsInput)">locoplot</a>(LocoDataCell, Iteration, FieldName{1}, FieldName{2});
2910 
2911 FieldName{3} = ElementsInput; 
2912 set(h1,<span class="string">'Userdata'</span>, FieldName);
2913 
2914 set(gca,<span class="string">'Tag'</span>,TagString);                 <span class="comment">% axes tag is lost if plot function is used</span>
2915 set(gca,<span class="string">'HandleVisibility'</span>,<span class="string">'Callback'</span>);   <span class="comment">% So no one else can plot to it.</span>
2916 
2917 
2918 
2919 <a name="_sub32" href="#_subfunctions" class="code">function [Mmodel, Dispersion, ChiSquare] = getmodelresponsematrix(BPMData, CMData, FitParameters, LocoFlags, LocoMeasData, RINGData)</a>
2920 
2921 <span class="comment">% Save the current axes</span>
2922 H_Axes = gca;
2923 
2924 <span class="comment">% UNITS CONVERSIONS (to be combatible with tracking code)</span>
2925 <span class="comment">% Convert corrector kicks used in the response matrix to radians</span>
2926 CMData.HCMKicks = CMData.HCMKicks(:) / 1000;   <span class="comment">% milliradian to radians (column vector)</span>
2927 CMData.VCMKicks = CMData.VCMKicks(:) / 1000;   <span class="comment">% milliradian to radians (column vector)</span>
2928 
2929 <span class="comment">% Convert the measured response matrix to meters</span>
2930 LocoMeasData.M = LocoMeasData.M / 1000;
2931 
2932 <span class="comment">% Convert the BPMSTD to meters and make the same size as a response matrix</span>
2933 LocoMeasData.BPMSTD = LocoMeasData.BPMSTD / 1000;    <span class="comment">% mm to meters</span>
2934 
2935 <span class="comment">% Convert orbit for &quot;dispersion&quot; in meters in column vector format</span>
2936 LocoMeasData.Eta = LocoMeasData.Eta(:) / 1000;       <span class="comment">% mm to meters</span>
2937 <span class="comment">% END UNITS CONVERTSION</span>
2938 
2939 
2940 <span class="comment">% % Check for a new (user input) BPM and CM good data lists</span>
2941 <span class="comment">% if ~isempty(get(findobj(gcbf,'Tag','HBPMIndex'), 'Userdata'))</span>
2942 <span class="comment">%     BPMData.HBPMGoodDataIndex = get(findobj(gcf,'Tag','HBPMIndex'), 'Userdata');</span>
2943 <span class="comment">% end</span>
2944 <span class="comment">% if ~isempty(get(findobj(gcbf,'Tag','VBPMIndex'), 'Userdata'))</span>
2945 <span class="comment">%     BPMData.VBPMGoodDataIndex = get(findobj(gcf,'Tag','VBPMIndex'), 'Userdata');</span>
2946 <span class="comment">% end</span>
2947 <span class="comment">% if ~isempty(get(findobj(gcbf,'Tag','HCMIndex'), 'Userdata'))</span>
2948 <span class="comment">%     CMData.HCMGoodDataIndex = get(findobj(gcf,'Tag','HCMIndex'), 'Userdata');</span>
2949 <span class="comment">% end</span>
2950 <span class="comment">% if ~isempty(get(findobj(gcbf,'Tag','VCMIndex'), 'Userdata'))</span>
2951 <span class="comment">%     CMData.VCMGoodDataIndex = get(findobj(gcf,'Tag','VCMIndex'), 'Userdata');</span>
2952 <span class="comment">% end</span>
2953 
2954 
2955 <span class="comment">% Limit the correctors to the good ones</span>
2956 <span class="keyword">if</span> isfield(CMData, <span class="string">'FamName'</span>)
2957     CMDataRM.FamName = CMData.FamName;
2958 <span class="keyword">end</span>
2959 CMDataRM.HCMIndex = CMData.HCMIndex(CMData.HCMGoodDataIndex);
2960 CMDataRM.VCMIndex = CMData.VCMIndex(CMData.VCMGoodDataIndex);
2961 CMDataRM.HCMKicks = CMData.HCMKicks(CMData.HCMGoodDataIndex);
2962 CMDataRM.VCMKicks = CMData.VCMKicks(CMData.VCMGoodDataIndex);
2963 CMDataRM.HCMCoupling = CMData.HCMCoupling(CMData.HCMGoodDataIndex);
2964 CMDataRM.VCMCoupling = CMData.VCMCoupling(CMData.VCMGoodDataIndex);
2965 CMDataRM.HCMEnergyShift = CMData.HCMEnergyShift(CMData.HCMGoodDataIndex);
2966 CMDataRM.VCMEnergyShift = CMData.VCMEnergyShift(CMData.VCMGoodDataIndex);
2967 
2968 <span class="comment">% Set the lattice model to the starting LocoValues</span>
2969 <span class="keyword">for</span> i = 1:length(FitParameters.Params)
2970     RINGData = <a href="locosetlatticeparam.html" class="code" title="function RINGData = locosetlatticeparam(RINGData, LocoParams, LocoValues)">locosetlatticeparam</a>(RINGData, FitParameters.Params{i}, FitParameters.Values(i));
2971 <span class="keyword">end</span>
2972 
2973 plot(H_Axes,[0 1],[0 1],<span class="string">'w'</span>);
2974 title(H_Axes,<span class="string">'RF Frequency'</span>);
2975 set(gca,<span class="string">'box'</span>,<span class="string">'on'</span>);
2976 set(gca,<span class="string">'XTick'</span>,[]);
2977 set(gca,<span class="string">'YTick'</span>,[]);
2978 text(4,11,sprintf(<span class="string">'Please wait ...'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
2979 text(4, 9,sprintf(<span class="string">'Computing nominal response matrix'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
2980 text(4, 8,sprintf(<span class="string">'                   and dispersion.'</span>),<span class="string">'units'</span>,<span class="string">'characters'</span>);
2981 drawnow;
2982 
2983 <span class="comment">% Find nominal response matrix and dispersion</span>
2984 <span class="keyword">if</span> isempty(FitParameters.DeltaRF)
2985     fprintf(<span class="string">'   Computing nominal response matrix (%s, %s) ... '</span>, LocoFlags.ResponseMatrixCalculator, LocoFlags.ClosedOrbitType); tic
2986     LocoFlags.Dispersion = <span class="string">'no'</span>;
2987     LocoFlags.ClosedOrbitType = <span class="string">'FixedPathLength'</span>;
2988     Mmodel = <a href="locoresponsematrix.html" class="code" title="function RM = locoresponsematrix(RINGData, BPMData, CMData, varargin)">locoresponsematrix</a>(RINGData, BPMData, CMDataRM, LocoFlags);
2989 <span class="keyword">else</span>
2990     fprintf(<span class="string">'   Computing nominal response matrix and dispersion (%s, %s) ... '</span>, LocoFlags.ResponseMatrixCalculator, LocoFlags.ClosedOrbitType); tic
2991     Mmodel = <a href="locoresponsematrix.html" class="code" title="function RM = locoresponsematrix(RINGData, BPMData, CMData, varargin)">locoresponsematrix</a>(RINGData, BPMData, CMDataRM, LocoFlags, <span class="string">'RF'</span>, FitParameters.DeltaRF);
2992 <span class="keyword">end</span>
2993 fprintf(<span class="string">'%f seconds. \n'</span>,toc);
2994 
2995 <span class="keyword">if</span> isempty(LocoMeasData.Eta) || any(isnan(LocoMeasData.Eta))
2996     <span class="comment">% Don't computer Chi^2 for with dispersion if the measured dispersion is emmpty or NaN</span>
2997     LocoFlags.Dispersion = <span class="string">'no'</span>;
2998 <span class="keyword">end</span>
2999 
3000 plot(0,0); set(gca,<span class="string">'XTick'</span>,[]); set(gca,<span class="string">'YTick'</span>,[]); cla; title(H_Axes,<span class="string">' '</span>); xlabel(H_Axes,<span class="string">' '</span>); ylabel(H_Axes,<span class="string">' '</span>);
3001 
3002 <span class="comment">% Rotate Mmodel and remove BPMs not in the measured response matrix</span>
3003 C11 = ones(length(BPMData.BPMIndex),1);
3004 C11(BPMData.HBPMIndex(BPMData.HBPMGoodDataIndex)) = BPMData.HBPMGain(BPMData.HBPMGoodDataIndex);
3005 
3006 C12 = zeros(length(BPMData.BPMIndex),1);
3007 C12(BPMData.HBPMIndex(BPMData.HBPMGoodDataIndex)) = BPMData.HBPMCoupling(BPMData.HBPMGoodDataIndex);
3008 
3009 C21 = zeros(length(BPMData.BPMIndex),1);
3010 C21(BPMData.VBPMIndex(BPMData.VBPMGoodDataIndex)) = BPMData.VBPMCoupling(BPMData.VBPMGoodDataIndex);
3011 
3012 C22 = ones(length(BPMData.BPMIndex),1);
3013 C22(BPMData.VBPMIndex(BPMData.VBPMGoodDataIndex)) = BPMData.VBPMGain(BPMData.VBPMGoodDataIndex);
3014 
3015 C = [diag(C11) diag(C12)
3016      diag(C21) diag(C22)];
3017 
3018 Mmodel = C * Mmodel;
3019 
3020 clear C C11 C12 C21 C22  
3021 
3022 <span class="comment">% Remove unwanted BPMs  (Change by James S.  3-17-2006)</span>
3023 <span class="comment">%Mmodel = Mmodel([BPMData.HBPMGoodDataIndex length(BPMData.HBPMIndex)+BPMData.VBPMGoodDataIndex], :);</span>
3024 BPMIndexShortX = BPMData.HBPMIndex(BPMData.HBPMGoodDataIndex);
3025 BPMIndexShortY = BPMData.VBPMIndex(BPMData.VBPMGoodDataIndex) + length(BPMData.BPMIndex);
3026 BPMIndexShort = [BPMIndexShortX(:)' BPMIndexShortY(:)'];
3027 Mmodel = Mmodel(BPMIndexShort,:); 
3028 
3029 <span class="keyword">if</span> isempty(FitParameters.DeltaRF)
3030     Dispersion = [];
3031 <span class="keyword">else</span>
3032     Dispersion = Mmodel(:,end);
3033 <span class="keyword">end</span>
3034 
3035 
3036 <span class="comment">% When using the fixed momentum response matrix calculator, the merit function becomes:</span>
3037 <span class="comment">%              Merit = Mmeas_ij - Mmod_ij - Dp/p_j * eta_i</span>
3038 <span class="comment">%              where eta_i is the measured eta (not the model eta)</span>
3039 <span class="comment">% This is done by changing Mmodel to (Mmodel_ij + Dp/p_j * eta_i)</span>
3040 <span class="comment">%if strcmpi((CMData.FitHCMEnergyShift),'yes') | strcmpi((CMData.FitVCMEnergyShift),'yes')</span>
3041 <span class="keyword">if</span> strcmpi((LocoFlags.ClosedOrbitType), <span class="string">'fixedmomentum'</span>)
3042     HCMEnergyShift = CMData.HCMEnergyShift(CMData.HCMGoodDataIndex);
3043     VCMEnergyShift = CMData.VCMEnergyShift(CMData.VCMGoodDataIndex);
3044     
3045     AlphaMCF = <a href="locomcf.html" class="code" title="function Alpha = locomcf(RINGData)">locomcf</a>(RINGData);
3046     EtaXmcf = -AlphaMCF * LocoMeasData.RF * LocoMeasData.Eta(BPMData.HBPMGoodDataIndex) / LocoMeasData.DeltaRF;
3047     EtaYmcf = -AlphaMCF * LocoMeasData.RF * LocoMeasData.Eta(length(BPMData.HBPMIndex)+BPMData.VBPMGoodDataIndex) / LocoMeasData.DeltaRF;
3048     
3049     <span class="keyword">for</span> i = 1:length(HCMEnergyShift)
3050         Mmodel(:,i) = Mmodel(:,i) + HCMEnergyShift(i) * [EtaXmcf; EtaYmcf];
3051     <span class="keyword">end</span>
3052     
3053     NHCM = length(HCMEnergyShift);
3054     <span class="keyword">for</span> i = 1:length(VCMEnergyShift)
3055         Mmodel(:,NHCM+i) = Mmodel(:,NHCM+i) + VCMEnergyShift(i) * [EtaXmcf; EtaYmcf];
3056     <span class="keyword">end</span>
3057 <span class="keyword">end</span>
3058 
3059 
3060 <span class="comment">% Compute chi-squared based on new model</span>
3061 Mmeas = LocoMeasData.M;
3062 Mmeas = Mmeas([BPMData.HBPMGoodDataIndex length(BPMData.HBPMIndex)+BPMData.VBPMGoodDataIndex], [CMData.HCMGoodDataIndex length(CMData.HCMIndex)+CMData.VCMGoodDataIndex]); 
3063 
3064 Mstd = LocoMeasData.BPMSTD * ones(1,size(LocoMeasData.M,2));
3065 Mstd = Mstd ([BPMData.HBPMGoodDataIndex length(BPMData.HBPMIndex)+BPMData.VBPMGoodDataIndex], [CMData.HCMGoodDataIndex length(CMData.HCMIndex)+CMData.VCMGoodDataIndex]); 
3066 
3067 Xstd = LocoMeasData.BPMSTD(BPMData.HBPMGoodDataIndex);
3068 Ystd = LocoMeasData.BPMSTD(length(BPMData.HBPMIndex)+BPMData.VBPMGoodDataIndex);
3069 
3070 <span class="keyword">if</span> isempty(LocoMeasData.Eta) 
3071     EtaX = NaN * ones(length(BPMData.HBPMGoodDataIndex),1);
3072     EtaY = NaN * ones(length(BPMData.VBPMGoodDataIndex),1);
3073 <span class="keyword">else</span>
3074     EtaX = LocoMeasData.Eta(BPMData.HBPMGoodDataIndex);
3075     EtaY = LocoMeasData.Eta(length(BPMData.HBPMIndex)+BPMData.VBPMGoodDataIndex);
3076 <span class="keyword">end</span>
3077     
3078 Mstd  = Mstd(:);
3079 Mmeas = Mmeas(:);
3080 
3081 <span class="keyword">if</span> strcmpi((LocoFlags.Dispersion),<span class="string">'yes'</span>)
3082     Mstd  = [Mstd;  [Xstd; Ystd]];
3083     Mmeas = [Mmeas; [EtaX; EtaY]];
3084 <span class="keyword">else</span>
3085     <span class="comment">% Remove dispersion from the model for ChiSquare</span>
3086     <span class="keyword">if</span> ~isempty(FitParameters.DeltaRF)
3087         Mmodel = Mmodel(:,1:end-1);
3088     <span class="keyword">end</span>
3089 <span class="keyword">end</span>
3090 
3091 <span class="comment">% Without NumberOfParameters (since no fits were done yet, but this is a little confusing to some)</span>
3092 ChiSquare = sum(((Mmeas - Mmodel(:)) ./ Mstd) .^ 2) / length(Mstd);
3093 
3094 
3095 <span class="comment">% Remove the disperion for the output is it has not been already removed</span>
3096 <span class="keyword">if</span> strcmpi((LocoFlags.Dispersion),<span class="string">'yes'</span>)  
3097     Mmodel = Mmodel(:,1:end-1);
3098 <span class="keyword">end</span>
3099 
3100 
3101 <span class="comment">% Unit conversions (back to LOCO units)</span>
3102 <span class="comment">%CMData.HCMKicks = 1000*CMData.HCMKicks;        % radian to milliradians</span>
3103 <span class="comment">%CMData.VCMKicks = 1000*CMData.VCMKicks;        % radian to milliradians</span>
3104 Mmodel     = 1000 * Mmodel;         <span class="comment">% meters to millimeters</span>
3105 Dispersion = 1000 * Dispersion;     <span class="comment">% meters to millimeters</span>
3106</pre></div>
<hr><address>Generated on Fri 01-Aug-2008 10:57:33 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>