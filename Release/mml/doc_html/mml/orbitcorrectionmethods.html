<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of orbitcorrectionmethods</title>
  <meta name="keywords" content="orbitcorrectionmethods">
  <meta name="description" content="ORBITCORRECTIONMETHODS - Some the orbit correction methods used on light sources">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">mml</a> &gt; orbitcorrectionmethods.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>orbitcorrectionmethods
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>ORBITCORRECTIONMETHODS - Some the orbit correction methods used on light sources</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">ORBITCORRECTIONMETHODS - Some the orbit correction methods used on light sources

  [OCS, Smat, S, U, V] = orbitcorrectionmethods(OCS)                 % Get response matrix &amp; compute SVD correction
  [OCS, Smat, S, U, V] = orbitcorrectionmethods(OCS, Smat)           % Compute SVD &amp; correction
  [OCS, Smat, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)  % Compute correction

  OCS.FitRF - Determines which RF freqency method to use
  See setorbit for information on all the different flags.
  
  NOTES
  1. OCS.CM.Data is not changed by this function
     OCS.CM.Delta is the delta correction
  2. Both row and column weighting of the response matrix can be done.
     The default is unity row weights and column weight by the std of each column.

  See also <a href="setorbit.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbit(varargin)">setorbit</a>, <a href="setorbitbump.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbitbump(varargin)">setorbitbump</a>, <a href="rmdisp.html" class="code" title="function [DeltaRF, BPM, c, DispOrbit] = rmdisp(varargin)">rmdisp</a>, <a href="plotcm.html" class="code" title="function [DeltaRF, HCMEnergyChangeTotal, DeltaL] = plotcm(varargin)">plotcm</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="getdisp.html" class="code" title="function [Data, FileName] = getdisp(varargin)">getdisp</a>	GETDISP - Returns the dispersion for a BPM family (from file)</li><li><a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>	GETFAMILYDATA - Gets data associated with the accelerator control</li><li><a href="gethbpmfamily.html" class="code" title="function Family = gethbpmfamily(OneHit)">gethbpmfamily</a>	GETHBPMFAMILY - Return the default horizontal BPM family</li><li><a href="gethcmfamily.html" class="code" title="function Family = gethcmfamily(OneHit)">gethcmfamily</a>	GETHCMFAMILY - Returns the default horizontal corrector family</li><li><a href="getmcf.html" class="code" title="function Alpha = getmcf(ModelString)">getmcf</a>	GETMCF - Returns the momentum compaction factor (MCF) stored in the AD or the model</li><li><a href="getrespmat.html" class="code" title="function [S, FileName] = getrespmat(varargin)">getrespmat</a>	GETRESPMAT - Get response matrix data from a file</li><li><a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>	GETSP - Gets setpoint channels</li><li><a href="getvbpmfamily.html" class="code" title="function Family = getvbpmfamily(OneHit)">getvbpmfamily</a>	GETVBPMFAMILY - Return the default vertical BPM family</li><li><a href="getvcmfamily.html" class="code" title="function Family = getvcmfamily(OneHit)">getvcmfamily</a>	GETVCMFAMILY - Returns the default vertical corrector family</li><li><a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>	HW2PHYSICS - Converts from 'Hardware' units to 'Physics' units</li><li><a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>	ISMEMBEROF - Returns turn if the membership information of a family (cell of strings)</li><li><a href="measbpmresp.html" class="code" title="function [Rmat, OutputFileName] = measbpmresp(varargin)">measbpmresp</a>	MEASBPMRESP - Measures the BPM response matrix in the horizontal and vertical planes</li><li><a href="measdisp.html" class="code" title="function [Dx, Dy, FileName] = measdisp(varargin)">measdisp</a>	MEASDISP - Measures the dispersion function</li><li><a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>	PHYSICS2HW - Converts from 'Physics' units to 'Hardware' units</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="setorbit.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbit(varargin)">setorbit</a>	SETORBIT - Orbit correction function</li></ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)</a>
0002 <span class="comment">%ORBITCORRECTIONMETHODS - Some the orbit correction methods used on light sources</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%  [OCS, Smat, S, U, V] = orbitcorrectionmethods(OCS)                 % Get response matrix &amp; compute SVD correction</span>
0005 <span class="comment">%  [OCS, Smat, S, U, V] = orbitcorrectionmethods(OCS, Smat)           % Compute SVD &amp; correction</span>
0006 <span class="comment">%  [OCS, Smat, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)  % Compute correction</span>
0007 <span class="comment">%</span>
0008 <span class="comment">%  OCS.FitRF - Determines which RF freqency method to use</span>
0009 <span class="comment">%  See setorbit for information on all the different flags.</span>
0010 <span class="comment">%</span>
0011 <span class="comment">%  NOTES</span>
0012 <span class="comment">%  1. OCS.CM.Data is not changed by this function</span>
0013 <span class="comment">%     OCS.CM.Delta is the delta correction</span>
0014 <span class="comment">%  2. Both row and column weighting of the response matrix can be done.</span>
0015 <span class="comment">%     The default is unity row weights and column weight by the std of each column.</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%  See also setorbit, setorbitbump, rmdisp, plotcm</span>
0018 
0019 <span class="comment">%  Written by Greg Portmann</span>
0020 
0021 
0022 <span class="comment">%  T = V(:,OCS.SVDIndex) * diag(S(OCS.SVDIndex).^(-1)) * U(:,OCS.SVDIndex)';</span>
0023 <span class="comment">%  Delcm = T * (BPMWeight .* (GoalOrbitVec - StartOrbitVec));</span>
0024 
0025 
0026 <span class="comment">% Initialize</span>
0027 FitRFDefault = 0;
0028 
0029 
0030 <span class="comment">% Input checking (should add more)</span>
0031 <span class="keyword">if</span> nargin &lt; 2
0032     Smat = [];
0033 <span class="keyword">end</span>
0034 <span class="keyword">if</span> nargin &lt; 3
0035     S = [];
0036     U = [];
0037     V = [];
0038 <span class="keyword">end</span>
0039 
0040 
0041 <span class="comment">% This function expects .BPM and .CM to be cell arrays.</span>
0042 <span class="comment">% This gets put back at the end of the function.</span>
0043 <span class="keyword">if</span> ~iscell(OCS.BPM)
0044     NoCellBPMFlag = 1;
0045     OCS.BPM = {OCS.BPM};
0046     OCS.GoalOrbit = {OCS.GoalOrbit};
0047     <span class="keyword">if</span> isfield(OCS, <span class="string">'BPMWeight'</span>)
0048         OCS.BPMWeight = {OCS.BPMWeight};
0049     <span class="keyword">end</span>
0050 <span class="keyword">else</span>
0051     NoCellBPMFlag = 0;
0052 <span class="keyword">end</span>
0053 <span class="keyword">if</span> ~iscell(OCS.CM)
0054     NoCellCMFlag = 1;
0055     OCS.CM = {OCS.CM};
0056     <span class="keyword">if</span> isfield(OCS, <span class="string">'CMWeight'</span>)
0057         <span class="keyword">if</span> ~iscell(OCS.CMWeight)
0058             OCS.CMWeight = {OCS.CMWeight};
0059         <span class="keyword">end</span>
0060     <span class="keyword">end</span>
0061 <span class="keyword">else</span>
0062     NoCellCMFlag = 0;
0063 <span class="keyword">end</span>
0064 
0065 
0066 <span class="comment">% RF frequency methods in orbit correction</span>
0067 <span class="keyword">if</span> ~isfield(OCS, <span class="string">'FitRF'</span>)
0068     OCS.FitRF = FitRFDefault;
0069 <span class="keyword">end</span>
0070 <span class="keyword">if</span> isempty(OCS.FitRF)
0071     OCS.FitRF = FitRFDefault;
0072 <span class="keyword">end</span>
0073 
0074 
0075 <span class="comment">%%%%%%%%%%%%%%%%</span>
0076 <span class="comment">% The SVD Part %</span>
0077 <span class="comment">%%%%%%%%%%%%%%%%</span>
0078 <span class="keyword">if</span> isempty(U)
0079     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0080     <span class="comment">% Get the response matrix %</span>
0081     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0082     <span class="keyword">if</span> isempty(Smat)
0083         <span class="keyword">for</span> i = 1:length(OCS.BPM)
0084             Srow = [];
0085             <span class="keyword">for</span> j = 1:length(OCS.CM)
0086                 <span class="comment">%if ModelRespFlag == 1</span>
0087                 <span class="keyword">if</span> any(strcmpi(OCS.Flags,<span class="string">'ModelResp'</span>))
0088                     <span class="comment">% When using measbpmresp('Model')</span>
0089                     <span class="comment">% Rmat(1,1) is always horizontal</span>
0090                     <span class="comment">% Rmat(2,2) is always vertical</span>
0091                     Rmat = <a href="measbpmresp.html" class="code" title="function [Rmat, OutputFileName] = measbpmresp(varargin)">measbpmresp</a>(<span class="string">'model'</span>,OCS.BPM{i},OCS.BPM{i}, OCS.CM{j},OCS.CM{j}, OCS.BPM{i}.Units);
0092                     <span class="keyword">if</span> <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.BPM{i}.FamilyName, <a href="gethbpmfamily.html" class="code" title="function Family = gethbpmfamily(OneHit)">gethbpmfamily</a>) &amp;&amp; <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.CM{j}.FamilyName,<a href="gethcmfamily.html" class="code" title="function Family = gethcmfamily(OneHit)">gethcmfamily</a>)
0093                         S = Rmat(1,1).Data;
0094                     <span class="keyword">elseif</span> <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.BPM{i}.FamilyName, <a href="getvbpmfamily.html" class="code" title="function Family = getvbpmfamily(OneHit)">getvbpmfamily</a>) &amp;&amp; <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.CM{j}.FamilyName,<a href="gethcmfamily.html" class="code" title="function Family = gethcmfamily(OneHit)">gethcmfamily</a>)
0095                         S = Rmat(2,1).Data;               
0096                     <span class="keyword">elseif</span> <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.BPM{i}.FamilyName, <a href="gethbpmfamily.html" class="code" title="function Family = gethbpmfamily(OneHit)">gethbpmfamily</a>) &amp;&amp; <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.CM{j}.FamilyName,<a href="getvcmfamily.html" class="code" title="function Family = getvcmfamily(OneHit)">getvcmfamily</a>)
0097                         S = Rmat(1,2).Data;
0098                     <span class="keyword">elseif</span> <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.BPM{i}.FamilyName, <a href="getvbpmfamily.html" class="code" title="function Family = getvbpmfamily(OneHit)">getvbpmfamily</a>) &amp;&amp; <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.CM{j}.FamilyName,<a href="getvcmfamily.html" class="code" title="function Family = getvcmfamily(OneHit)">getvcmfamily</a>)
0099                         S = Rmat(2,2).Data;
0100                     <span class="keyword">else</span>
0101                         error(<span class="string">'Problem getting the model response matrix'</span>);
0102                     <span class="keyword">end</span>
0103                 <span class="keyword">else</span>
0104                     <span class="comment">% Get the golden BPM response matrix</span>
0105                     [S, FileName] = <a href="getrespmat.html" class="code" title="function [S, FileName] = getrespmat(varargin)">getrespmat</a>(OCS.BPM{i}, OCS.CM{j}, <span class="string">'Numeric'</span>);
0106                     <span class="keyword">if</span> any(find(isnan(S)))
0107                         error(<span class="string">'Not all BPMs and correctors exist in the response matrix.'</span>);
0108                     <span class="keyword">end</span>
0109                 <span class="keyword">end</span>
0110                 <span class="keyword">if</span> length(OCS.GoalOrbit{i}) ~= size(S,1)
0111                     error(<span class="string">'The goal orbit vector length does not equal the response matrix row length'</span>);
0112                 <span class="keyword">end</span>
0113 
0114                 Srow = [Srow S];
0115             <span class="keyword">end</span>
0116             Smat = [Smat; Srow];
0117         <span class="keyword">end</span>
0118         <span class="comment">%SmatCheck = measbpmresp('Model','Numeric');</span>
0119 
0120 
0121         <span class="comment">%%%%%%%%%%%%%%%%%%</span>
0122         <span class="comment">% Get Dispersion %</span>
0123         <span class="comment">%%%%%%%%%%%%%%%%%%</span>
0124         Eta = [];
0125         <span class="keyword">if</span> OCS.FitRF
0126             <span class="keyword">for</span> i = 1:length(OCS.BPM)
0127                 <span class="keyword">if</span> any(strcmpi(OCS.Flags,<span class="string">'ModelDisp'</span>))
0128                     <span class="comment">%if strcmpi(DispFlag,'ModelDisp')</span>
0129                     DispOrbit = <a href="measdisp.html" class="code" title="function [Dx, Dy, FileName] = measdisp(varargin)">measdisp</a>(OCS.BPM{i}, <span class="string">'Hardware'</span>, <span class="string">'Numeric'</span>, <span class="string">'Model'</span>);
0130                 <span class="keyword">elseif</span> any(strcmpi(OCS.Flags,<span class="string">'MeasDisp'</span>))
0131                     <span class="comment">%elseif strcmpi(DispFlag,'MeasDisp')</span>
0132                     DispOrbit = <a href="measdisp.html" class="code" title="function [Dx, Dy, FileName] = measdisp(varargin)">measdisp</a>(OCS.BPM{i}, <span class="string">'Hardware'</span>, <span class="string">'Numeric'</span>);
0133                 <span class="keyword">elseif</span> any(strcmpi(OCS.Flags,<span class="string">'GoldenDisp'</span>))
0134                     <span class="comment">%elseif strcmpi(DispFlag,'GoldenDisp')</span>
0135                     DispOrbit = <a href="getdisp.html" class="code" title="function [Data, FileName] = getdisp(varargin)">getdisp</a>(OCS.BPM{i}, <span class="string">'Hardware'</span>, <span class="string">'Numeric'</span>);
0136                 <span class="keyword">end</span>
0137                 
0138                 <span class="keyword">if</span> strcmpi(OCS.BPM{i}.Units, <span class="string">'Physics'</span>)
0139                     <span class="comment">% Put the RF change in physics units, not energy change</span>
0140                     RFhw = <a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>(OCS.RF);
0141                     DispOrbit = DispOrbit / (OCS.RF.Data / RFhw.Data);
0142                 <span class="keyword">end</span>
0143                 
0144                 <span class="keyword">if</span> isempty(DispOrbit)
0145                     error(<span class="string">'Did not find or generate dispersion orbit properly'</span>);
0146                 <span class="keyword">end</span>
0147                 <span class="keyword">if</span> any(isnan(DispOrbit))
0148                     error(<span class="string">'The dispersion data has at least one NaN.'</span>);
0149                 <span class="keyword">end</span>
0150                 
0151                 Eta = [Eta; DispOrbit];
0152             <span class="keyword">end</span>
0153         <span class="keyword">end</span>
0154         OCS.Eta = Eta;
0155     <span class="keyword">end</span>
0156 <span class="keyword">end</span>
0157 
0158 
0159 <span class="comment">% Save a weight free response matrix</span>
0160 SmatNoWeights = Smat;
0161 
0162 
0163 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0164 <span class="comment">% Build the orbit vectors %</span>
0165 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0166 StartOrbitVec = [];
0167 GoalOrbitVec = [];
0168 BPMWeight = [];
0169 <span class="keyword">for</span> i = 1:length(OCS.BPM)
0170     StartOrbitVec = [StartOrbitVec; OCS.BPM{i}.Data(:)];
0171     GoalOrbitVec  = [GoalOrbitVec; OCS.GoalOrbit{i}(:)];
0172 
0173     <span class="keyword">if</span> ~isfield(OCS, <span class="string">'BPMWeight'</span>) || isempty(OCS.BPMWeight{i})
0174         BPMWeight = [BPMWeight; ones(length(OCS.BPM{i}.Data),1)];
0175     <span class="keyword">elseif</span> isscalar(OCS.BPMWeight{i})
0176         BPMWeight = [BPMWeight; ones(length(OCS.BPM{i}.Data),1) * OCS.BPMWeight{i}];
0177     <span class="keyword">else</span>
0178         BPMWeight = [BPMWeight; OCS.BPMWeight{i}(:)];
0179     <span class="keyword">end</span>
0180 <span class="keyword">end</span>
0181 
0182 
0183 <span class="comment">% Build column weight vector</span>
0184 CMWeight = [];
0185 <span class="keyword">for</span> i = 1:length(OCS.CM)
0186     <span class="keyword">if</span> ~isfield(OCS, <span class="string">'CMWeight'</span>) || isempty(OCS.CMWeight{i})
0187         <span class="comment">% When using all singular values this does not do anything (besides numerical precision)</span>
0188         <span class="comment">% The amp to radian conversion is probably a better normalizer</span>
0189         <span class="comment">%CMWeight = 1 ./ sqrt(sum(Smat.^2));</span>
0190         CMWeight = 1./std(Smat)';
0191 
0192         <span class="comment">% No weight</span>
0193         <span class="comment">%CMWeight = ones(size(Smat,2),1);</span>
0194 
0195         <span class="keyword">break</span>;
0196         <span class="comment">%CMWeight = [CMWeight; ones(length(OCS.CM{i}.Data),1)];</span>
0197 
0198     <span class="keyword">elseif</span> isscalar(OCS.CMWeight{i})
0199         CMWeight = [CMWeight; ones(length(OCS.CM{i}.Data),1) * OCS.CMWeight{i}];
0200 
0201     <span class="keyword">else</span>
0202         CMWeight = [CMWeight; OCS.CMWeight{i}(:)];
0203     <span class="keyword">end</span>
0204 <span class="keyword">end</span>
0205 
0206 
0207 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0208 <span class="comment">% Add a column weight to the response matrix %</span>
0209 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0210 <span class="comment">%if isempty(U)</span>
0211     <span class="keyword">for</span> j = 1:length(CMWeight)
0212         Smat(:,j) = Smat(:,j) * CMWeight(j);
0213     <span class="keyword">end</span>
0214 <span class="comment">%end</span>
0215 
0216 
0217 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0218 <span class="comment">% Add a weighted disperion as a column of the response matrix %</span>
0219 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0220 <span class="keyword">if</span> OCS.FitRF == 0
0221     <span class="comment">% Don't fit the RF frequency</span>
0222     OCS.DeltaRF = 0;
0223 <span class="keyword">elseif</span> any(OCS.FitRF == [1 2 3 4 5])
0224     <span class="comment">% Column weighting (changing the units or sensitivity) seems to be a good thing.</span>
0225     <span class="comment">% (At least at the ALS working in hardware units.)</span>
0226     <span class="comment">% Weight by more than the average std of Smat also seems to give good results but</span>
0227     <span class="comment">% I'm not sure it's necessary or should be done.</span>
0228     RFWeight = 10 * mean(std(Smat)) / std(OCS.Eta);
0229     <span class="keyword">if</span> isinf(RFWeight) || isnan(RFWeight) || RFWeight==0
0230         RFWeight = 1;
0231     <span class="keyword">end</span>
0232     Smat = [Smat RFWeight*OCS.Eta];
0233 <span class="keyword">else</span>
0234     error(<span class="string">'Unknown RF correction method.'</span>);
0235 <span class="keyword">end</span>
0236 
0237 
0238 
0239 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0240 <span class="comment">% Add a row weight to the response matrix %</span>
0241 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0242 <span class="comment">% Weighted LS</span>
0243 <span class="comment">% Weighted LS was developed for heteroscedastic errors but it's used here for other reasons</span>
0244 <span class="comment">% W*(Mmeas - Mmodel) = W*A*b + W*e,  where the e's are gausian, zero mean, independent, but not constant variance</span>
0245 <span class="comment">% W is chosen to make E(Wee'W') = sigma * I  (ie, W * e has a constant variance)</span>
0246 <span class="comment">%</span>
0247 <span class="comment">% The new LS equations are,</span>
0248 <span class="comment">% b = inv(Amod'*W' * W*Amod) * Amod'*W' * W*(Xgoal - Xmeasured);      % Parameter fit</span>
0249 <span class="comment">% b = V(:,Ivec) * b;</span>
0250 <span class="comment">% bvar = inv(Amod'*W'*W*Amod);</span>
0251 <span class="comment">%</span>
0252 <span class="comment">% Since the weight matrix, W, is only going to be diagonal, it is less memory</span>
0253 <span class="comment">% to scaled Amod and (Mmeas-Model) by the diagonal term and not create the matrix W</span>
0254 <span class="keyword">if</span> ~all(BPMWeight == 1)
0255     <span class="keyword">for</span> i = 1:size(Smat,1)
0256         Smat(i,:) = BPMWeight(i) * Smat(i,:);
0257     <span class="keyword">end</span>
0258 <span class="keyword">end</span>
0259 
0260 
0261 <span class="comment">%%%%%%%%%%%%%%%%</span>
0262 <span class="comment">% The SVD Part %</span>
0263 <span class="comment">%%%%%%%%%%%%%%%%</span>
0264 <span class="keyword">if</span> isempty(U)
0265     <span class="keyword">if</span> any(any(isnan(Smat)))
0266         error(<span class="string">'The response matrix has at least one NaN.'</span>);
0267     <span class="keyword">end</span>
0268 
0269     <span class="comment">% Do the SVD</span>
0270     [U, S, V] = svd(Smat, 0);  <span class="comment">%'econ');</span>
0271     S = diag(S);
0272 <span class="keyword">end</span>
0273 
0274 
0275 <span class="comment">% Determine the singular vector and error check</span>
0276 <span class="keyword">if</span> isnumeric(OCS.SVDIndex)
0277     <span class="keyword">if</span> length(OCS.SVDIndex) == 1
0278         <span class="keyword">if</span> rem(OCS.SVDIndex,1) == 0
0279             OCS.SVDIndex = 1:OCS.SVDIndex;
0280         <span class="keyword">else</span>
0281             <span class="comment">% Use threshold</span>
0282             Ivec = find(S &gt; max(S)*OCS.SVDIndex);
0283             OCS.SVDIndex = Ivec;
0284         <span class="keyword">end</span>
0285     <span class="keyword">end</span>
0286 <span class="keyword">elseif</span> ischar(OCS.SVDIndex)
0287     <span class="keyword">if</span> strcmpi(OCS.SVDIndex, <span class="string">'All'</span>)
0288         OCS.SVDIndex = 1:length(S);
0289     <span class="keyword">else</span>
0290         error(<span class="string">'OCS.SVDIndex unknown'</span>);
0291     <span class="keyword">end</span>
0292 <span class="keyword">else</span>
0293     error(<span class="string">'OCS.SVDIndex unknown'</span>);
0294 <span class="keyword">end</span>
0295 
0296 <span class="comment">% Nothing greater then the total number is singular values</span>
0297 i = find(OCS.SVDIndex &gt; length(S));
0298 <span class="keyword">if</span> ~isempty(i)
0299     warning(<span class="string">'Requested number of singular values is greater than the total.  Removing %d values.'</span>,length(i));
0300     OCS.SVDIndex(i) = length(S);
0301 <span class="keyword">end</span>
0302 
0303 <span class="comment">% No non-integers</span>
0304 OCS.SVDIndex = round(OCS.SVDIndex);
0305 
0306 <span class="comment">% Nothing less than zero</span>
0307 i = find(OCS.SVDIndex &lt;= 0);
0308 OCS.SVDIndex(i) = length(S);
0309 
0310 <span class="comment">% No repeats</span>
0311 OCS.SVDIndex = sort(OCS.SVDIndex);
0312 i = find(diff(OCS.SVDIndex)==0);
0313 OCS.SVDIndex(i) = [];
0314 
0315 <span class="keyword">if</span> isempty(OCS.SVDIndex)
0316     error(<span class="string">'Singular values vector is empty'</span>);
0317 <span class="keyword">end</span>
0318 
0319 
0320 <span class="keyword">if</span> OCS.FitRF == 2 || OCS.FitRF == 3
0321     <span class="comment">% Constrained L.S. with SVD</span>
0322     <span class="comment">% Constraint: Sum of the energy change to zero</span>
0323     <span class="comment">% Note: Model required</span>
0324     
0325     R = [];
0326     HCMEnergyChangeTotal = 0;
0327     <span class="keyword">for</span> i = 1:length(OCS.CM)
0328         <span class="keyword">if</span> <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.CM{i}.FamilyName, <span class="string">'HCM'</span>)
0329             L = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Circumference'</span>);
0330 
0331             <span class="keyword">if</span> ~isfield(OCS.CM{i}, <span class="string">'Dispersion'</span>)
0332                 <span class="comment">% Dispersion at the correctors in physics units</span>
0333                 [OCS.CM{i}.Dispersion, DyHCM] = modeldisp([], OCS.CM{i}.FamilyName, OCS.CM{i}.DeviceList, <span class="string">'Numeric'</span>, <span class="string">'Physics'</span>);
0334             <span class="keyword">end</span>
0335             
0336             <span class="comment">% Present corrector setpoint in physics units</span>
0337             HCM = <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(OCS.CM{i});
0338 
0339             
0340             <span class="comment">% Move ALS specific code to setorbitdefault ???</span>
0341             <span class="keyword">if</span> strcmpi(<a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Machine'</span>),<span class="string">'ALS'</span>)
0342                 <span class="comment">% For the ALS, either the HCMCHICANE families need to be included or</span>
0343                 <span class="comment">% the chicane &quot;part&quot; of the HCMs needs to be removed.  This will remove the chicane.</span>
0344                 Energy = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Energy'</span>);
0345 
0346                 <span class="comment">% Sector 6</span>
0347                 <span class="comment">%                   Off    1.9 GeV   1.5 GeV</span>
0348                 <span class="comment">% HCMCHICANEM(6,1)  80.0    18.0       ?</span>
0349                 <span class="comment">% HCMCHICANEM(6,1)  80.0    20.0       ?</span>
0350                 <span class="comment">% HCM(6,1)           0.0    18.8       ?</span>
0351                 ihcm = findrowindex([6 1], OCS.CM{i}.DeviceList);
0352                 <span class="keyword">if</span> length(ihcm) == 1
0353                     <span class="keyword">try</span>
0354                         <span class="keyword">if</span> <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(<span class="string">'HCMCHICANEM'</span>,[6 1]) &lt; 70
0355                             <span class="comment">% Assume sector 6 chicane is on</span>
0356                             <span class="keyword">if</span> Energy == 1.9
0357                                 HCM.Data(ihcm) = HCM.Data(ihcm) + <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(OCS.CM{i}.FamilyName, OCS.CM{i}.Field, -18.8, [6 1]);
0358                             <span class="keyword">else</span>
0359                                 HCM.Data(ihcm) = HCM.Data(ihcm) + <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(OCS.CM{i}.FamilyName, OCS.CM{i}.Field,  -18.8*1.5/1.9, [6 1]);
0360                             <span class="keyword">end</span>
0361                         <span class="keyword">end</span>
0362                     <span class="keyword">catch</span>
0363                         fprintf(<span class="string">'%s\n'</span>, lasterr);
0364                         fprintf(<span class="string">'Problem reading HCMCHICANEM(6,1).  The chicane &quot;offset&quot; on HCM(6,1) will not be removed.\n\n'</span>);
0365                     <span class="keyword">end</span>
0366                 <span class="keyword">end</span>
0367 
0368                 <span class="comment">% Sector 11</span>
0369                 <span class="comment">%                    Off    1.9 GeV   1.5 GeV</span>
0370                 <span class="comment">% HCMCHICANEM(11,1)  80.0    40.5      52.0</span>
0371                 <span class="comment">% HCMCHICANEM(11,1)  80.0    40.5      52.0</span>
0372                 <span class="comment">% HCM(10,8)           0.0   -17.0     -14.0</span>
0373                 <span class="comment">% HCM(11,1)           0.0   -17.0     -14.0</span>
0374                 ihcm = findrowindex([10 8], OCS.CM{i}.DeviceList);
0375                 <span class="keyword">if</span> length(ihcm) == 1
0376                     <span class="keyword">try</span>
0377                         <span class="keyword">if</span> <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(<span class="string">'HCMCHICANEM'</span>,[11 1]) &lt; 60
0378                             <span class="comment">% Assume sector 11 chicane is on</span>
0379                             <span class="keyword">if</span> Energy == 1.9
0380                                 HCM.Data(ihcm) = HCM.Data(ihcm) + <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(OCS.CM{i}.FamilyName, OCS.CM{i}.Field, [17; 17], [10 8;11 1]);
0381                             <span class="keyword">else</span>
0382                                 HCM.Data(ihcm) = HCM.Data(ihcm) + <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(OCS.CM{i}.FamilyName, OCS.CM{i}.Field, [14; 14], [10 8;11 1]);
0383                             <span class="keyword">end</span>
0384                         <span class="keyword">end</span>
0385                     <span class="keyword">catch</span>
0386                         fprintf(<span class="string">'%s\n'</span>, lasterr);
0387                         fprintf(<span class="string">'Due to an error, the chicane &quot;offset&quot; on HCM(10,8) will not be removed.n\n'</span>);
0388                     <span class="keyword">end</span>
0389                 <span class="keyword">end</span>
0390                 ihcm = findrowindex([11 1], OCS.CM{i}.DeviceList);
0391                 <span class="keyword">if</span> length(ihcm) == 1
0392                     <span class="keyword">try</span>
0393                         <span class="keyword">if</span> <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(<span class="string">'HCMCHICANEM'</span>,[11 1]) &lt; 60
0394                             <span class="comment">% Assume sector 11 chicane is on</span>
0395                             <span class="keyword">if</span> Energy == 1.9
0396                                 HCM.Data(ihcm) = HCM.Data(ihcm) + <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(OCS.CM{i}.FamilyName, OCS.CM{i}.Field, [17; 17], [10 8;11 1]);
0397                             <span class="keyword">else</span>
0398                                 HCM.Data(ihcm) = HCM.Data(ihcm) + <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(OCS.CM{i}.FamilyName, OCS.CM{i}.Field, [14; 14], [10 8;11 1]);
0399                             <span class="keyword">end</span>
0400                         <span class="keyword">end</span>
0401                     <span class="keyword">catch</span>
0402                         fprintf(<span class="string">'%s\n'</span>, lasterr);
0403                         fprintf(<span class="string">'Due to an error, the chicane &quot;offset&quot; on HCM(11,1) will not be removed.n\n'</span>);
0404                     <span class="keyword">end</span>
0405                 <span class="keyword">end</span>
0406             <span class="keyword">end</span>
0407             <span class="comment">% END ALS only</span>
0408             
0409             
0410             <span class="comment">% Energy change to remove</span>
0411             HCMEnergyChangeTotal = HCMEnergyChangeTotal + sum(-1 * HCM.Data .* OCS.CM{i}.Dispersion / <a href="getmcf.html" class="code" title="function Alpha = getmcf(ModelString)">getmcf</a> / L);
0412             
0413             <span class="comment">% Energy scaling must be in physics units, hence the (HCM.Data./OCS.CM{i}.Data)</span>
0414             <span class="keyword">if</span> strcmpi(OCS.CM{i}.Units, <span class="string">'Hardware'</span>)
0415                 <span class="comment">% PhyicsUnitsScaling = (HCM.Data./OCS.CM{i}.Data);  %This does not work for zero setpoints</span>
0416                 PhyicsUnitsScaling = <a href="hw2physics.html" class="code" title="function S = hw2physics(Family, Field, value, DeviceList, Energy)">hw2physics</a>(OCS.CM{i}. FamilyName,OCS.CM{i}.Field, 1, OCS.CM{i}.DeviceList); 
0417             <span class="keyword">else</span>
0418                 PhyicsUnitsScaling = 1;
0419             <span class="keyword">end</span>
0420             HCMEnergyChangeScalar = -1 * PhyicsUnitsScaling .* OCS.CM{i}.Dispersion / <a href="getmcf.html" class="code" title="function Alpha = getmcf(ModelString)">getmcf</a> / L;
0421             R = [R HCMEnergyChangeScalar(:)'];
0422             
0423             <span class="comment">% Sum of correctors to zero</span>
0424             <span class="comment">%R = [R ones(size(HCMEnergyChange(:)'))];</span>
0425         <span class="keyword">else</span>
0426             R = [R zeros(1,size(OCS.CM{i}.DeviceList,1))];
0427         <span class="keyword">end</span>
0428     <span class="keyword">end</span>
0429     
0430     <span class="keyword">if</span> OCS.FitRF == 2
0431         <span class="comment">% Also remove the energy change due to the present corrector setpoints</span>
0432         r = -HCMEnergyChangeTotal/2;    <span class="comment">% Not sure about the divide by 2</span>
0433     <span class="keyword">elseif</span> OCS.FitRF == 3
0434         <span class="comment">% Only remove energy change due to the incremental change in the correctors</span>
0435         r = 0;
0436     <span class="keyword">end</span>
0437     
0438     <span class="comment">% Add a zero for no constaint on the RF</span>
0439     R = [R 0];
0440     
0441 
0442     <span class="comment">% Projection onto the columns of Smat*V (or U)</span>
0443     <span class="comment">% Since the correctors are V*b, the restriction in corrector strength is R*V</span>
0444     X = Smat * V(:,OCS.SVDIndex);
0445     R = R * V(:,OCS.SVDIndex);
0446     b = inv(X'*X)*X' * (BPMWeight .* (GoalOrbitVec - StartOrbitVec));
0447     br = b - inv(X'*X)*R'*inv(R*inv(X'*X)*R')*(R*b-r);
0448     Delcm = V(:,OCS.SVDIndex) * br;
0449 
0450 <span class="keyword">elseif</span> OCS.FitRF == 4
0451     <span class="comment">% Constrained L.S. with SVD</span>
0452     <span class="comment">% Constraint: dot(DisperionX,   Smat * dHCM) = 0</span>
0453     <span class="comment">%         or  dot(DisperionX' * Smat,  dHCM) = 0 or total dot(DisperionX, Smat * HCM)</span>
0454     R = [];
0455     DispDotSmatHCM = 0;
0456     <span class="keyword">for</span> i = 1:length(OCS.BPM)
0457         <span class="keyword">if</span> strcmpi(OCS.BPM{i}.FamilyName, <span class="string">'BPMx'</span>) || <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.BPM{i}.FamilyName, <span class="string">'BPMx'</span>)
0458             <span class="keyword">if</span> ~isfield(OCS.BPM{i}, <span class="string">'Dispersion'</span>)
0459                 <span class="comment">% Dispersion at the correctors in physics units</span>
0460                 [OCS.BPM{i}.Dispersion, Dy] = <a href="getdisp.html" class="code" title="function [Data, FileName] = getdisp(varargin)">getdisp</a>(OCS.BPM{i}.FamilyName, OCS.BPM{i}.DeviceList, <span class="string">'Numeric'</span>,  OCS.BPM{i}.Units);
0461             <span class="keyword">end</span>
0462             R = [R OCS.BPM{i}.Dispersion(:)'];
0463             
0464             HCM = <a href="physics2hw.html" class="code" title="function S = physics2hw(Family, Field, value, DeviceList, Energy)">physics2hw</a>(OCS.CM{i});
0465 
0466             
0467             <span class="comment">% Move ALS specific code to setorbitdefault ???</span>
0468             <span class="keyword">if</span> strcmpi(<a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Machine'</span>),<span class="string">'ALS'</span>)
0469                 <span class="comment">% For the ALS, either the HCMCHICANE families need to be included or</span>
0470                 <span class="comment">% the chicane &quot;part&quot; of the HCMs needs to be removed.  This will remove the chicane.</span>
0471                 Energy = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Energy'</span>);
0472 
0473                 <span class="comment">% Sector 6</span>
0474                 <span class="comment">%                   Off    1.9 GeV   1.5 GeV</span>
0475                 <span class="comment">% HCMCHICANEM(6,1)  80.0    18.0       ?</span>
0476                 <span class="comment">% HCMCHICANEM(6,1)  80.0    20.0       ?</span>
0477                 <span class="comment">% HCM(6,1)           0.0    18.8       ?</span>
0478                 ihcm = findrowindex([6 1], OCS.CM{i}.DeviceList);
0479                 <span class="keyword">if</span> length(ihcm) == 1
0480                     <span class="keyword">try</span>
0481                         <span class="keyword">if</span> <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(<span class="string">'HCMCHICANEM'</span>,[6 1]) &lt; 70
0482                             <span class="comment">% Assume sector 6 chicane is on</span>
0483                             <span class="keyword">if</span> Energy == 1.9
0484                                 HCM.Data(ihcm) = HCM.Data(ihcm) - 18.8;
0485                             <span class="keyword">else</span>
0486                                 HCM.Data(ihcm) = HCM.Data(ihcm) - 18.8*1.5/1.9;
0487                             <span class="keyword">end</span>
0488                         <span class="keyword">end</span>
0489                     <span class="keyword">catch</span>
0490                         fprintf(<span class="string">'%s\n'</span>, lasterr);
0491                         fprintf(<span class="string">'Due to an error, the chicane &quot;offset&quot; on HCM(6,1) will not be removed.\n\n'</span>);
0492                     <span class="keyword">end</span>
0493                 <span class="keyword">end</span>
0494 
0495                 <span class="comment">% Sector 11</span>
0496                 <span class="comment">%                    Off    1.9 GeV   1.5 GeV</span>
0497                 <span class="comment">% HCMCHICANEM(11,1)  80.0    40.5      52.0</span>
0498                 <span class="comment">% HCMCHICANEM(11,1)  80.0    40.5      52.0</span>
0499                 <span class="comment">% HCM(10,8)           0.0   -17.0     -14.0</span>
0500                 <span class="comment">% HCM(11,1)           0.0   -17.0     -14.0</span>
0501                 ihcm = findrowindex([10 8], OCS.CM{i}.DeviceList);
0502                 <span class="keyword">if</span> length(ihcm) == 1
0503                     <span class="keyword">try</span>
0504                         <span class="keyword">if</span> <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(<span class="string">'HCMCHICANEM'</span>,[11 1]) &lt; 60
0505                             <span class="comment">% Assume sector 11 chicane is on</span>
0506                             <span class="keyword">if</span> Energy == 1.9
0507                                 HCM.Data(ihcm) = HCM.Data(ihcm) + 17;
0508                             <span class="keyword">else</span>
0509                                 HCM.Data(ihcm) = HCM.Data(ihcm) + 14;
0510                             <span class="keyword">end</span>
0511                         <span class="keyword">end</span>
0512                     <span class="keyword">catch</span>
0513                         fprintf(<span class="string">'%s\n'</span>, lasterr);
0514                         fprintf(<span class="string">'Problem reading HCMCHICANEM(11,1).  The chicane &quot;offset&quot; on HCM(10,8) will not be removed.n\n'</span>);
0515                     <span class="keyword">end</span>
0516                 <span class="keyword">end</span>
0517                 ihcm = findrowindex([11 1], OCS.CM{i}.DeviceList);
0518                 <span class="keyword">if</span> length(ihcm) == 1
0519                     <span class="keyword">try</span>
0520                         <span class="keyword">if</span> <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(<span class="string">'HCMCHICANEM'</span>,[11 1]) &lt; 60
0521                             <span class="comment">% Assume sector 11 chicane is on</span>
0522                             <span class="keyword">if</span> Energy == 1.9
0523                                 HCM.Data(ihcm) = HCM.Data(ihcm) + 17;
0524                             <span class="keyword">else</span>
0525                                 HCM.Data(ihcm) = HCM.Data(ihcm) + 14;
0526                             <span class="keyword">end</span>
0527                         <span class="keyword">end</span>
0528                     <span class="keyword">catch</span>
0529                         fprintf(<span class="string">'%s\n'</span>, lasterr);
0530                         fprintf(<span class="string">'Due to an error, the chicane &quot;offset&quot; on HCM(11,1) will not be removed.n\n'</span>);
0531                     <span class="keyword">end</span>
0532                 <span class="keyword">end</span>
0533             <span class="keyword">end</span>
0534             <span class="comment">% END ALS only</span>
0535 
0536 
0537             <span class="comment">% Assumes 1 HCM family and it's first???</span>
0538             DispDotSmatHCM = DispDotSmatHCM + OCS.BPM{i}.Dispersion'*Smat(1:size(OCS.BPM{i}.DeviceList,1),1:1:size(OCS.CM{i}.DeviceList,1))*HCM.Data;
0539         <span class="keyword">else</span>
0540             R = [R zeros(1,size(OCS.BPM{i}.DeviceList,1))];
0541         <span class="keyword">end</span>
0542     <span class="keyword">end</span>
0543     <span class="comment">% [OCS.BPM{1}.Dispersion, Dy] = getdisp(OCS.BPM{1}.FamilyName, OCS.BPM{1}.DeviceList, 'Numeric', OCS.BPM{1}.Units);</span>
0544     <span class="comment">% RR = [OCS.BPM{1}.Dispersion(:); zeros(size(OCS.BPM{2}.DeviceList,1),1)]';</span>
0545 
0546     <span class="comment">%r = 0;</span>
0547     r = -1*DispDotSmatHCM;  <span class="comment">% Not sure if this should be divided by 2</span>
0548     R = [R*Smat(:,1:end-1) 0];
0549 
0550 
0551     <span class="comment">% Projection onto the columns of Smat*V (or U)</span>
0552     <span class="comment">% Since the correctors are V*b, the restriction in corrector strength is R*V</span>
0553     X = Smat * V(:,OCS.SVDIndex);
0554     R = R * V(:,OCS.SVDIndex);
0555     b = inv(X'*X)*X' * (BPMWeight .* (GoalOrbitVec - StartOrbitVec));
0556     br = b - inv(X'*X)*R'*inv(R*inv(X'*X)*R')*(R*b-r);
0557     Delcm = V(:,OCS.SVDIndex) * br;
0558     
0559     <span class="comment">%DelcmNoR = V(:,OCS.SVDIndex) * b;</span>
0560     <span class="comment">%fprintf('   dRF=%g  dRF(NoR)=%g\n',  RFWeight * Delcm(end),  RFWeight * DelcmNoR(end));</span>
0561     
0562 <span class="keyword">elseif</span> OCS.FitRF == 5
0563     <span class="comment">% Constrained L.S. with SVD</span>
0564     <span class="comment">% Constraint: dot(HCM(Dispersion), dHCM) = 0</span>
0565     R = [];
0566     <span class="keyword">for</span> i = 1:length(OCS.CM)
0567         <span class="keyword">if</span> <a href="ismemberof.html" class="code" title="function  [IsTest, Index] = ismemberof(FamilyName, Field, MemberString)">ismemberof</a>(OCS.CM{i}.FamilyName, <span class="string">'HCM'</span>)
0568             <span class="comment">% Assume CM{i} is the same plane as BPM{i}</span>
0569             <span class="keyword">if</span> ~isfield(OCS.BPM{i}, <span class="string">'Dispersion'</span>)
0570                 <span class="comment">% Dispersion at the horizontal BPMs</span>
0571                 [OCS.BPM{i}.Dispersion, Dy] = <a href="getdisp.html" class="code" title="function [Data, FileName] = getdisp(varargin)">getdisp</a>(OCS.BPM{i}.FamilyName, OCS.BPM{i}.DeviceList, <span class="string">'Numeric'</span>,  OCS.BPM{i}.Units);
0572 
0573                 <span class="comment">% Find the corrector pattern of the dispersion orbit</span>
0574                 <span class="comment">%</span>
0575                 <span class="comment">% OCS.SVDIndex ????</span>
0576                 <span class="comment">% Smat???  make an array</span>
0577                 <span class="comment">% Why is Rhcm so different from Rbpmx?</span>
0578                 
0579                 <span class="comment">% Assumes 1 HCM family and it's first???</span>
0580                 SmatNoEta = Smat(1:size(OCS.BPM{i}.DeviceList,1),1:size(OCS.CM{i}.DeviceList,1));
0581                 [UU, SS, VV] = svd(SmatNoEta, <span class="string">'econ'</span>);
0582                 SS = diag(SS);
0583 
0584                 X = SmatNoEta * VV(:,OCS.SVDIndex);
0585                 b = inv(X'*X)*X' * OCS.BPM{i}.Dispersion;
0586                 OCS.BPM{i}.DispersionCorrectors = VV(:,OCS.SVDIndex) * b;
0587             <span class="keyword">end</span>
0588             R = [R OCS.BPM{i}.DispersionCorrectors(:)'];
0589         <span class="keyword">else</span>
0590             R = [R zeros(1,size(OCS.CM{i}.DeviceList,1))];
0591         <span class="keyword">end</span>
0592     <span class="keyword">end</span>
0593 
0594     r = 0;  <span class="comment">% Should it be an absolute conditional ???</span>
0595     R = [R 0];
0596 
0597 
0598     <span class="comment">% Projection onto the columns of Smat*V (or U)</span>
0599     <span class="comment">% Since the correctors are V*b, the restriction in corrector strength is R*V</span>
0600     X = Smat * V(:,OCS.SVDIndex);
0601     R = R * V(:,OCS.SVDIndex);
0602     b = inv(X'*X)*X' * (BPMWeight .* (GoalOrbitVec - StartOrbitVec));
0603     br = b - inv(X'*X)*R'*inv(R*inv(X'*X)*R')*(R*b-r);
0604     Delcm = V(:,OCS.SVDIndex) * br;
0605     
0606     <span class="comment">%DelcmNoR = V(:,OCS.SVDIndex) * b;</span>
0607     <span class="comment">%fprintf('   dRF=%g  dRF(NoR)=%g\n',  RFWeight * Delcm(end),  RFWeight * DelcmNoR(end));</span>
0608 
0609 <span class="keyword">else</span>
0610 
0611     <span class="comment">% L.S. with SVD algorithm</span>
0612     <span class="comment">% The V matrix columns are the singular vectors in the corrector magnet space</span>
0613     <span class="comment">% The U matrix columns are the singular vectors in the BPM space</span>
0614     <span class="comment">% Smat = U*S*V' where U'*U=I and V*V'=I</span>
0615     <span class="comment">%</span>
0616     <span class="comment">% b is the coef. of the projection onto the columns of Smat*V(:,Ivec) - the corrector space (same space as spanned by U)</span>
0617     <span class="comment">% Sometimes it's interesting to look at the size of these coefficients with singular value number.</span>
0618     b = U(:,OCS.SVDIndex)' * (BPMWeight .* (GoalOrbitVec - StartOrbitVec));
0619     b = diag(S(OCS.SVDIndex).^(-1)) * b;
0620 
0621     <span class="comment">% Convert the b vector back to coefficents of response matrix</span>
0622     Delcm = V(:,OCS.SVDIndex) * b;
0623 <span class="keyword">end</span>
0624 
0625 
0626 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0627 <span class="comment">% Remove Weights for the Correction %</span>
0628 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0629 <span class="comment">% Separate the RF from the correctors</span>
0630 <span class="keyword">if</span> OCS.FitRF
0631     <span class="comment">% RF frequency is the last actuator</span>
0632     OCS.DeltaRF = RFWeight * Delcm(end);
0633     Delcm = Delcm(1:end-1);
0634 <span class="keyword">end</span>
0635 
0636 <span class="comment">% Remove column weights from Delcm</span>
0637 Delcm = Delcm .* CMWeight;
0638     
0639     
0640 <span class="comment">% Predict Orbit</span>
0641 <span class="keyword">if</span> OCS.FitRF
0642     OrbitDeltaTotal = [SmatNoWeights OCS.Eta] * [Delcm; OCS.DeltaRF];
0643 <span class="keyword">else</span>
0644     OrbitDeltaTotal = SmatNoWeights * Delcm;
0645 <span class="keyword">end</span>
0646 <span class="keyword">for</span> j = 1:length(OCS.BPM)
0647     N = length(OCS.BPM{j}.Data);
0648     OCS.BPM{j}.PredictedOrbitDelta = OrbitDeltaTotal(1:N);
0649     OrbitDeltaTotal(1:N) = [];
0650 <span class="keyword">end</span>
0651 
0652 
0653 <span class="comment">% Don't put the Delcm into OCS.CM so this function can get</span>
0654 <span class="comment">% called multiple times before actually correcting the orbit</span>
0655 <span class="keyword">for</span> i = 1:length(OCS.CM)
0656     N = length(OCS.CM{i}.Data);
0657     <span class="comment">%OCS.CM{i}.Data = OCS.CM{i}.Data + Delcm(1:N);</span>
0658     OCS.CM{i}.Delta = Delcm(1:N);
0659     Delcm(1:N) = [];
0660 
0661     OCS.CMWeight{i} = CMWeight(1:N);
0662     CMWeight(1:N) = [];
0663 <span class="keyword">end</span>
0664 
0665 
0666 <span class="comment">% Remove the cell array if the length is one</span>
0667 <span class="keyword">if</span> NoCellBPMFlag
0668     OCS.BPM = OCS.BPM{1};
0669     OCS.GoalOrbit = OCS.GoalOrbit{1};
0670     OCS.BPMWeight = OCS.BPMWeight{1};
0671 <span class="keyword">end</span>
0672 <span class="keyword">if</span> NoCellCMFlag
0673     OCS.CM = OCS.CM{1};
0674     OCS.CMWeight = OCS.CMWeight{1};
0675 <span class="keyword">end</span>
0676 
0677 
0678 <span class="comment">% Output statistics???</span>
0679 <span class="comment">% 1. Correctable orbit</span>
0680 <span class="comment">% 2. Not correctable orbit</span>
0681 <span class="comment">% 3. Error propagation</span>
0682 
0683</pre></div>
<hr><address>Generated on Fri 01-Aug-2008 10:57:33 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>