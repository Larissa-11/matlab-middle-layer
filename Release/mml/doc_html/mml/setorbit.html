<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of setorbit</title>
  <meta name="keywords" content="setorbit">
  <meta name="description" content="SETORBIT - Orbit correction function">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">mml</a> &gt; setorbit.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for mml&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>setorbit
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>SETORBIT - Orbit correction function</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [OCS, OCS0, V, S, ErrorFlag] = setorbit(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">SETORBIT - Orbit correction function
  Family/DeviceList method:
  [CM, OCS0, V, Svalues] = setorbit(GoalOrbit, BPMFamily, BPMDevList, CMFamily, CMDevList, NIter, SVDIndex, BPMWeight);

  Data structure method:
  [CM, OCS0, V, Svalues] = setorbit(GoalOrbit, BPMstruct,             CMstruct,            NIter, SVDIndex, BPMWeight);

  Use cell arrays for multiple family correction (like coupled planes):
  [CM, OCS0, V, Svalues] = setorbit(GoalOrbitCell, BPMcell, CMcell, NIter, SVDIndex, BPMWeight);
  Note: BPMcell and CMcell must be a data structures when using cell arrays (GoalOrbitCell can be a cell or a string)

  Orbit Correction Structure (OCS) method:
  [CM, OCS0, V, Svalues] = setorbit(OCS, NIter, SVDIndex, BPMWeight);

  INPUTS
  1. GoalOrbit - Goal orbit (vector or cell array)
                'Golden' for the golden orbit {Default}
                'Offset' for the offset orbit
  2. BPM - BPM data structure (or cell array of structures)
     or BPMFamily and BPMDevList
  3. CM - Corrector magnet data structure (or cell array of structures)
     or CMFamily and CMDevList
  4. SVDIndex - vector, maximum number, 'All', or
                base on a threshold of min/max singular value {Default: 1e-3}
  5. NIter - Number of iterations  {Default: 1}
            (NIter can be 0, see note 1 below)
  6. BPMWeight - Weight applied to the BPMs (OCS.BPMWeight)
  7. FLAGS  - 'Abs' or 'Inc' - GoalOrbit is an absolute or incremental change {Default: 'Abs'}
                               ('Absolute' or 'Incremental' can also be used)
              'CorrectorGain', Gain - Scale the correction by Gain {Default: 1}
              'Display' - plot orbit information before applying the correction
              'FigureHandles' followed by a vector of 1 or 2 elements for figure handles and
                                                      4 or 8 elements for axes handles.
              'FitRF' or 'SetRF' - Fit and change the RF frequency
                   'GoldenDisp' - Use the golden dispersion {Default}
                   'MeasDisp'   - Measure the dispersion 
                   'ModelDisp'  - Calculate the model dispersion
              'GetPV' or 'NoGetPV' - Get new data or use the data already in the OCS {Default: 'GetPV' (for the first iteration)}
                                     This allows one make a correction based on data already checked and analyzed.
                                     ('GetAM' or 'NoGetAM' does the same thing)
              'GoldenResp' or 'ModelResp' - Golden BPM response or calculate from the model {Default: 'GoldenResp'} 
              'SetPV' or 'NoSetPV' - Set or don't set the correctors and RF {Default: 'SetSP'}
                                    'NoSetPV' does the calculation without making the correction.  That way one can
                                     take a look at the expected correction results before applying them.
                                     ('SetSP' or 'NoSetSP' does the same thing)
              'Tolerance', Tol - Quit correction if the std(error) &lt; Tol {Tol: 0}
              'RampSteps', NSteps - Number of steps to ramp in the correction {NSteps: 1}
                                    This is used to avoid a large transient between setpoint changes.
                                    Note: NSteps is only used on the first iteration.
              'FitRF','SetRF','RFCorrector'                       - Set the RF frequency (Eta Column)
              'FitRFHCM0','FitRFEnergy','SetRFHCM0','SetRFEnergy' - Set the RF frequency (HCM energy constraint)
              'FitRFDeltaHCM0','SetRFDeltaHCM0'                   - Set the RF frequency (Delta HCM energy constraint)
              'FitRFDispersionOrbit','SetRFDispersionOrbit'       - Set the RF frequency (Dispersion orbit constraint)
              'FitRFDispersionHCM','SetRFDispersionHCM'           - Set the RF frequency (Dispersion correction constraint)
              The usual Units and Mode flags can also be used.
              Flags are not case sensitive

  OUTPUTS
  1. OCS    - New orbit correction structure (OCS)
  2. OCS0   - Starting OCS
  3. V      - Corrector magnet singular vectors
  4. Svalue - Singular values (vector)

  ALGORITHM
  SVD orbit correction:
  Decompose the response matrix, Rmat:
    [U, S, V] = svd(Rmat);

  The V matrix columns are the singular vectors in the corrector magnet space
  The U matrix columns are the singular vectors in the BPM space
    Rmat = U * S = Rmat * V

  Modify the response matrix by removing singular vector with small singular values
    Rmod = U(:,SVDIndex) * S(SVDIndex,SVDIndex) = Rmat * V(:,SVDIndex)

  Only project (least squares) on to the modified response matrix
    b = inv(Rmod'*Rmod)*Rmod' * (GoalOrbit - PresentOrbit);
  Or
    b = Rmod \ (GoalOrbit - PresentOrbit);

  The b coefficients are in terms of the singular vectors.
  The corrector strengths come from the linear combination of the singular vectors
    DeltaCM = V(:,SVDIndex) * b;

  ORBIT CORRECTION STRUCTURE (OCS)
    OCS.BPM (Data structure or cell array of data structures)
    OCS.CM  (Data structure or cell array of data structures)
    OCS.GoalOrbit
    OCS.NIter         - Number of correction iterations
    OCS.NCorrections  - Number of corrections actually done
    OCS.Tolerance     - Tolerance level to quit iterating
    OCS.RampSteps     - Number of steps to ramp in the each correction
    OCS.SVDIndex
    OCS.FitRF         - Methods for RF correction
                        1 Standard way with no constraints
                        2 Sum of the energy change to zero Also remove the
                          energy change due to the present corrector setpoints
                        3 Sum of the energy change to zero
                          remove energy change due to the incremental change in the correctors
                        4 Constraint: dot(DispersionX,   Smat * dHCM) = 0
                        5 Constraint: dot(HCM(Dispersion), dHCM) = 0
    OCS.RF
    OCS.DeltaRF
    OCS.Display
    OCS.Incremental   - GoalOrbit is an incremental change from the present (1) or absolute (0) {Default: 0}
    OCS.CorrectorGain - Scales the correction (usually used in slow feedback)
    OCS.BPMWeight     - Row    weights on the response matrix
    OCS.CMWeight      - Column weights on the response matrix
    OCS.Flags = {}

  EXAMPLES
  1. The default behavior us horizontal and vertical (coupled) orbit correction to the golden orbit
     setorbit;
     is equivalent to
     x = getx('struct');
     y = gety('struct');
     hcm = getsp('HCM','struct');
     vcm = getsp('VCM','struct');
     setorbit('Golden', {x,y}, {hcm,vcm});

  2. Horizontal orbit correction with the follow criterion:
     a. Correct to the golden orbit
     b. Use the first 10 singular values
     c. Display results

     x = getx([1 1;1 2;12 1; 13 4],'struct');
     hcm = getsp('HCM',[3 1;5 1;10 1],'struct');
     setorbit('Golden', x, hcm, 10, 'Display');

  3. Horizontal and vertical (coupled) orbit correction to the golden orbit (display results)
     x = getx([1 1;1 2;12 1; 13 4],'struct');
     y = gety([1 1;1 2;12 1; 13 4],'struct');
     hcm = getsp('HCM',[3 1;5 1;10 1],'struct');
     vcm = getsp('VCM',[3 1;4 1;9 1;10 1],'struct');
     setorbit('Golden', {x,y}, {hcm,vcm}, 'Display');

  NOTES
  1. Incremental orbit changes with more then one iteration are treated algorithmically
     just like absolute orbit changes.  For a 1 iteration incremental orbit change
     BPM data is not needed and hence not used.  However, if one uses the
     'Display' flag then BPM data is used to show results.  If BPM data is not
     available and one wants to still display corrector and estimated orbit
     information then use the special mode: 'Inc', 'Display', NIter=0.
  2. The 'Display' flag only displays the first iteration and the final result.
     Intermediate iterations (if used) are not displayed.
  3. If horizontal and vertical corrector are used, then the
     coupling terms in the response matrix will be used.
     To avoid using coupling terms, use separate calls.
  4. OCS0.CM.Data is the corrector strength before setorbit ran
     OCS.CM.Data  is the corrector strength after  setorbit ran
     Hence, DeltaCM = OCS.CM.Data - OCS0.CM.Data;
     However, if the 'NoSetSP' flag was used, then no correction was done and
     OCS.CM.Data=OCS0.CM.Data (ie, the present corrector strength).  To apply
     the correction, use OCS.CM.Data + OCS.CM.Delta

  See also <a href="orbitcorrectionmethods.html" class="code" title="function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)">orbitcorrectionmethods</a>, <a href="setorbitbump.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbitbump(varargin)">setorbitbump</a>, <a href="setorbitgui.html" class="code" title="function varargout = setorbitgui(varargin)">setorbitgui</a>, <a href="rmdisp.html" class="code" title="function [DeltaRF, BPM, c, DispOrbit] = rmdisp(varargin)">rmdisp</a>, <a href="plotcm.html" class="code" title="function [DeltaRF, HCMEnergyChangeTotal, DeltaL] = plotcm(varargin)">plotcm</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="family2datastruct.html" class="code" title="function [DataStruct, ErrorFlag] = family2datastruct(varargin)">family2datastruct</a>	FAMILY2DATASTRUCTURE</li><li><a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin)">family2dev</a>	FAMILY2DEV - Return the device list for a family</li><li><a href="family2status.html" class="code" title="function [S, IndexList] = family2status(Family, DeviceList)">family2status</a>	FAMILY2STATUS - Returns the device status</li><li><a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a>	GETDCCT - returns the beam current</li><li><a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>	GETFAMILYDATA - Gets data associated with the accelerator control</li><li><a href="getgolden.html" class="code" title="function Data = getgolden(varargin)">getgolden</a>	GETGOLDEN - Returns the golden values for a family</li><li><a href="gethbpmfamily.html" class="code" title="function Family = gethbpmfamily(OneHit)">gethbpmfamily</a>	GETHBPMFAMILY - Return the default horizontal BPM family</li><li><a href="gethcmfamily.html" class="code" title="function Family = gethcmfamily(OneHit)">gethcmfamily</a>	GETHCMFAMILY - Returns the default horizontal corrector family</li><li><a href="getmode.html" class="code" title="function Mode = getmode(Family, Field)">getmode</a>	GETMODE - Returns the present family mode ('Online', 'Simulator', 'Manual', 'Special', etc)</li><li><a href="getoffset.html" class="code" title="function Data = getoffset(varargin)">getoffset</a>	GETOFFSET - Returns the offset values for a family</li><li><a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>	GETPV - Returns a variable from the online system or the model</li><li><a href="getrf.html" class="code" title="function [RFsp, RFam, DataTime, ErrorFlag] = getrf(varargin)">getrf</a>	GETRF - Gets the RF frequency</li><li><a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>	GETSP - Gets setpoint channels</li><li><a href="getspos.html" class="code" title="function S = getspos(Family, DeviceList)">getspos</a>	GETSPOS - Returns the longitudinal position in meters</li><li><a href="getvbpmfamily.html" class="code" title="function Family = getvbpmfamily(OneHit)">getvbpmfamily</a>	GETVBPMFAMILY - Return the default vertical BPM family</li><li><a href="getvcmfamily.html" class="code" title="function Family = getvcmfamily(OneHit)">getvcmfamily</a>	GETVCMFAMILY - Returns the default vertical corrector family</li><li><a href="maxsp.html" class="code" title="function [Data, ErrorFlag] = maxsp(varargin)">maxsp</a>	MAXSP - Maximum value of the setpoint</li><li><a href="minsp.html" class="code" title="function [Data, ErrorFlag] = minsp(varargin)">minsp</a>	MINSP - Minimum value of the setpoint</li><li><a href="orbitcorrectionmethods.html" class="code" title="function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)">orbitcorrectionmethods</a>	ORBITCORRECTIONMETHODS - Some the orbit correction methods used on light sources</li><li><a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>	SETPV - Setpoint change of the online system or model</li><li><a href="steprf.html" class="code" title="function steprf(varargin)">steprf</a>	STEPRF - Increment change in the RF frequency</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="setorbitbump.html" class="code" title="function [OCS, OCS0, V, S, ErrorFlag] = setorbitbump(varargin)">setorbitbump</a>	SETORBITBUMP - Local bump program (uses setorbit)</li><li><a href="setorbitbumpgui.html" class="code" title="function varargout = setorbitbumpgui(varargin)">setorbitbumpgui</a>	SETORBITBUMPGUI M-file for setorbitbumpgui.fig</li><li><a href="setorbitgui.html" class="code" title="function varargout = setorbitgui(varargin)">setorbitgui</a>	SETORBITGUI - Orbit correction GUI</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [StopFlag, OCS, Smat, S, U, V, FigureHandles, MorePlotsFlag] = answersetorbitcall(OCS, Smat, S, U, V, FigureHandles, InputFlags)</a></li><li><a href="#_sub2" class="code">function [H, Haxis, OCS] = PreCorrectionDisplay(H, OCS0, OCS, Smat, S, U, V, NumberOfTrys, MorePlotsFlag, InputFlags)</a></li><li><a href="#_sub3" class="code">function drawmoreplots(Haxis, OCS, Smat, S, U, V)</a></li><li><a href="#_sub4" class="code">function PostCorrectionDisplay(H, OCS0, OCS, Smat, S, U, V, Iteration, NumberOfTrys, MorePlotsFlag, InputFlags)</a></li></ul>
<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [OCS, OCS0, V, S, ErrorFlag] = setorbit(varargin)</a>
0002 <span class="comment">%SETORBIT - Orbit correction function</span>
0003 <span class="comment">%  Family/DeviceList method:</span>
0004 <span class="comment">%  [CM, OCS0, V, Svalues] = setorbit(GoalOrbit, BPMFamily, BPMDevList, CMFamily, CMDevList, NIter, SVDIndex, BPMWeight);</span>
0005 <span class="comment">%</span>
0006 <span class="comment">%  Data structure method:</span>
0007 <span class="comment">%  [CM, OCS0, V, Svalues] = setorbit(GoalOrbit, BPMstruct,             CMstruct,            NIter, SVDIndex, BPMWeight);</span>
0008 <span class="comment">%</span>
0009 <span class="comment">%  Use cell arrays for multiple family correction (like coupled planes):</span>
0010 <span class="comment">%  [CM, OCS0, V, Svalues] = setorbit(GoalOrbitCell, BPMcell, CMcell, NIter, SVDIndex, BPMWeight);</span>
0011 <span class="comment">%  Note: BPMcell and CMcell must be a data structures when using cell arrays (GoalOrbitCell can be a cell or a string)</span>
0012 <span class="comment">%</span>
0013 <span class="comment">%  Orbit Correction Structure (OCS) method:</span>
0014 <span class="comment">%  [CM, OCS0, V, Svalues] = setorbit(OCS, NIter, SVDIndex, BPMWeight);</span>
0015 <span class="comment">%</span>
0016 <span class="comment">%  INPUTS</span>
0017 <span class="comment">%  1. GoalOrbit - Goal orbit (vector or cell array)</span>
0018 <span class="comment">%                'Golden' for the golden orbit {Default}</span>
0019 <span class="comment">%                'Offset' for the offset orbit</span>
0020 <span class="comment">%  2. BPM - BPM data structure (or cell array of structures)</span>
0021 <span class="comment">%     or BPMFamily and BPMDevList</span>
0022 <span class="comment">%  3. CM - Corrector magnet data structure (or cell array of structures)</span>
0023 <span class="comment">%     or CMFamily and CMDevList</span>
0024 <span class="comment">%  4. SVDIndex - vector, maximum number, 'All', or</span>
0025 <span class="comment">%                base on a threshold of min/max singular value {Default: 1e-3}</span>
0026 <span class="comment">%  5. NIter - Number of iterations  {Default: 1}</span>
0027 <span class="comment">%            (NIter can be 0, see note 1 below)</span>
0028 <span class="comment">%  6. BPMWeight - Weight applied to the BPMs (OCS.BPMWeight)</span>
0029 <span class="comment">%  7. FLAGS  - 'Abs' or 'Inc' - GoalOrbit is an absolute or incremental change {Default: 'Abs'}</span>
0030 <span class="comment">%                               ('Absolute' or 'Incremental' can also be used)</span>
0031 <span class="comment">%              'CorrectorGain', Gain - Scale the correction by Gain {Default: 1}</span>
0032 <span class="comment">%              'Display' - plot orbit information before applying the correction</span>
0033 <span class="comment">%              'FigureHandles' followed by a vector of 1 or 2 elements for figure handles and</span>
0034 <span class="comment">%                                                      4 or 8 elements for axes handles.</span>
0035 <span class="comment">%              'FitRF' or 'SetRF' - Fit and change the RF frequency</span>
0036 <span class="comment">%                   'GoldenDisp' - Use the golden dispersion {Default}</span>
0037 <span class="comment">%                   'MeasDisp'   - Measure the dispersion</span>
0038 <span class="comment">%                   'ModelDisp'  - Calculate the model dispersion</span>
0039 <span class="comment">%              'GetPV' or 'NoGetPV' - Get new data or use the data already in the OCS {Default: 'GetPV' (for the first iteration)}</span>
0040 <span class="comment">%                                     This allows one make a correction based on data already checked and analyzed.</span>
0041 <span class="comment">%                                     ('GetAM' or 'NoGetAM' does the same thing)</span>
0042 <span class="comment">%              'GoldenResp' or 'ModelResp' - Golden BPM response or calculate from the model {Default: 'GoldenResp'}</span>
0043 <span class="comment">%              'SetPV' or 'NoSetPV' - Set or don't set the correctors and RF {Default: 'SetSP'}</span>
0044 <span class="comment">%                                    'NoSetPV' does the calculation without making the correction.  That way one can</span>
0045 <span class="comment">%                                     take a look at the expected correction results before applying them.</span>
0046 <span class="comment">%                                     ('SetSP' or 'NoSetSP' does the same thing)</span>
0047 <span class="comment">%              'Tolerance', Tol - Quit correction if the std(error) &lt; Tol {Tol: 0}</span>
0048 <span class="comment">%              'RampSteps', NSteps - Number of steps to ramp in the correction {NSteps: 1}</span>
0049 <span class="comment">%                                    This is used to avoid a large transient between setpoint changes.</span>
0050 <span class="comment">%                                    Note: NSteps is only used on the first iteration.</span>
0051 <span class="comment">%              'FitRF','SetRF','RFCorrector'                       - Set the RF frequency (Eta Column)</span>
0052 <span class="comment">%              'FitRFHCM0','FitRFEnergy','SetRFHCM0','SetRFEnergy' - Set the RF frequency (HCM energy constraint)</span>
0053 <span class="comment">%              'FitRFDeltaHCM0','SetRFDeltaHCM0'                   - Set the RF frequency (Delta HCM energy constraint)</span>
0054 <span class="comment">%              'FitRFDispersionOrbit','SetRFDispersionOrbit'       - Set the RF frequency (Dispersion orbit constraint)</span>
0055 <span class="comment">%              'FitRFDispersionHCM','SetRFDispersionHCM'           - Set the RF frequency (Dispersion correction constraint)</span>
0056 <span class="comment">%              The usual Units and Mode flags can also be used.</span>
0057 <span class="comment">%              Flags are not case sensitive</span>
0058 <span class="comment">%</span>
0059 <span class="comment">%  OUTPUTS</span>
0060 <span class="comment">%  1. OCS    - New orbit correction structure (OCS)</span>
0061 <span class="comment">%  2. OCS0   - Starting OCS</span>
0062 <span class="comment">%  3. V      - Corrector magnet singular vectors</span>
0063 <span class="comment">%  4. Svalue - Singular values (vector)</span>
0064 <span class="comment">%</span>
0065 <span class="comment">%  ALGORITHM</span>
0066 <span class="comment">%  SVD orbit correction:</span>
0067 <span class="comment">%  Decompose the response matrix, Rmat:</span>
0068 <span class="comment">%    [U, S, V] = svd(Rmat);</span>
0069 <span class="comment">%</span>
0070 <span class="comment">%  The V matrix columns are the singular vectors in the corrector magnet space</span>
0071 <span class="comment">%  The U matrix columns are the singular vectors in the BPM space</span>
0072 <span class="comment">%    Rmat = U * S = Rmat * V</span>
0073 <span class="comment">%</span>
0074 <span class="comment">%  Modify the response matrix by removing singular vector with small singular values</span>
0075 <span class="comment">%    Rmod = U(:,SVDIndex) * S(SVDIndex,SVDIndex) = Rmat * V(:,SVDIndex)</span>
0076 <span class="comment">%</span>
0077 <span class="comment">%  Only project (least squares) on to the modified response matrix</span>
0078 <span class="comment">%    b = inv(Rmod'*Rmod)*Rmod' * (GoalOrbit - PresentOrbit);</span>
0079 <span class="comment">%  Or</span>
0080 <span class="comment">%    b = Rmod \ (GoalOrbit - PresentOrbit);</span>
0081 <span class="comment">%</span>
0082 <span class="comment">%  The b coefficients are in terms of the singular vectors.</span>
0083 <span class="comment">%  The corrector strengths come from the linear combination of the singular vectors</span>
0084 <span class="comment">%    DeltaCM = V(:,SVDIndex) * b;</span>
0085 <span class="comment">%</span>
0086 <span class="comment">%  ORBIT CORRECTION STRUCTURE (OCS)</span>
0087 <span class="comment">%    OCS.BPM (Data structure or cell array of data structures)</span>
0088 <span class="comment">%    OCS.CM  (Data structure or cell array of data structures)</span>
0089 <span class="comment">%    OCS.GoalOrbit</span>
0090 <span class="comment">%    OCS.NIter         - Number of correction iterations</span>
0091 <span class="comment">%    OCS.NCorrections  - Number of corrections actually done</span>
0092 <span class="comment">%    OCS.Tolerance     - Tolerance level to quit iterating</span>
0093 <span class="comment">%    OCS.RampSteps     - Number of steps to ramp in the each correction</span>
0094 <span class="comment">%    OCS.SVDIndex</span>
0095 <span class="comment">%    OCS.FitRF         - Methods for RF correction</span>
0096 <span class="comment">%                        1 Standard way with no constraints</span>
0097 <span class="comment">%                        2 Sum of the energy change to zero Also remove the</span>
0098 <span class="comment">%                          energy change due to the present corrector setpoints</span>
0099 <span class="comment">%                        3 Sum of the energy change to zero</span>
0100 <span class="comment">%                          remove energy change due to the incremental change in the correctors</span>
0101 <span class="comment">%                        4 Constraint: dot(DispersionX,   Smat * dHCM) = 0</span>
0102 <span class="comment">%                        5 Constraint: dot(HCM(Dispersion), dHCM) = 0</span>
0103 <span class="comment">%    OCS.RF</span>
0104 <span class="comment">%    OCS.DeltaRF</span>
0105 <span class="comment">%    OCS.Display</span>
0106 <span class="comment">%    OCS.Incremental   - GoalOrbit is an incremental change from the present (1) or absolute (0) {Default: 0}</span>
0107 <span class="comment">%    OCS.CorrectorGain - Scales the correction (usually used in slow feedback)</span>
0108 <span class="comment">%    OCS.BPMWeight     - Row    weights on the response matrix</span>
0109 <span class="comment">%    OCS.CMWeight      - Column weights on the response matrix</span>
0110 <span class="comment">%    OCS.Flags = {}</span>
0111 <span class="comment">%</span>
0112 <span class="comment">%  EXAMPLES</span>
0113 <span class="comment">%  1. The default behavior us horizontal and vertical (coupled) orbit correction to the golden orbit</span>
0114 <span class="comment">%     setorbit;</span>
0115 <span class="comment">%     is equivalent to</span>
0116 <span class="comment">%     x = getx('struct');</span>
0117 <span class="comment">%     y = gety('struct');</span>
0118 <span class="comment">%     hcm = getsp('HCM','struct');</span>
0119 <span class="comment">%     vcm = getsp('VCM','struct');</span>
0120 <span class="comment">%     setorbit('Golden', {x,y}, {hcm,vcm});</span>
0121 <span class="comment">%</span>
0122 <span class="comment">%  2. Horizontal orbit correction with the follow criterion:</span>
0123 <span class="comment">%     a. Correct to the golden orbit</span>
0124 <span class="comment">%     b. Use the first 10 singular values</span>
0125 <span class="comment">%     c. Display results</span>
0126 <span class="comment">%</span>
0127 <span class="comment">%     x = getx([1 1;1 2;12 1; 13 4],'struct');</span>
0128 <span class="comment">%     hcm = getsp('HCM',[3 1;5 1;10 1],'struct');</span>
0129 <span class="comment">%     setorbit('Golden', x, hcm, 10, 'Display');</span>
0130 <span class="comment">%</span>
0131 <span class="comment">%  3. Horizontal and vertical (coupled) orbit correction to the golden orbit (display results)</span>
0132 <span class="comment">%     x = getx([1 1;1 2;12 1; 13 4],'struct');</span>
0133 <span class="comment">%     y = gety([1 1;1 2;12 1; 13 4],'struct');</span>
0134 <span class="comment">%     hcm = getsp('HCM',[3 1;5 1;10 1],'struct');</span>
0135 <span class="comment">%     vcm = getsp('VCM',[3 1;4 1;9 1;10 1],'struct');</span>
0136 <span class="comment">%     setorbit('Golden', {x,y}, {hcm,vcm}, 'Display');</span>
0137 <span class="comment">%</span>
0138 <span class="comment">%  NOTES</span>
0139 <span class="comment">%  1. Incremental orbit changes with more then one iteration are treated algorithmically</span>
0140 <span class="comment">%     just like absolute orbit changes.  For a 1 iteration incremental orbit change</span>
0141 <span class="comment">%     BPM data is not needed and hence not used.  However, if one uses the</span>
0142 <span class="comment">%     'Display' flag then BPM data is used to show results.  If BPM data is not</span>
0143 <span class="comment">%     available and one wants to still display corrector and estimated orbit</span>
0144 <span class="comment">%     information then use the special mode: 'Inc', 'Display', NIter=0.</span>
0145 <span class="comment">%  2. The 'Display' flag only displays the first iteration and the final result.</span>
0146 <span class="comment">%     Intermediate iterations (if used) are not displayed.</span>
0147 <span class="comment">%  3. If horizontal and vertical corrector are used, then the</span>
0148 <span class="comment">%     coupling terms in the response matrix will be used.</span>
0149 <span class="comment">%     To avoid using coupling terms, use separate calls.</span>
0150 <span class="comment">%  4. OCS0.CM.Data is the corrector strength before setorbit ran</span>
0151 <span class="comment">%     OCS.CM.Data  is the corrector strength after  setorbit ran</span>
0152 <span class="comment">%     Hence, DeltaCM = OCS.CM.Data - OCS0.CM.Data;</span>
0153 <span class="comment">%     However, if the 'NoSetSP' flag was used, then no correction was done and</span>
0154 <span class="comment">%     OCS.CM.Data=OCS0.CM.Data (ie, the present corrector strength).  To apply</span>
0155 <span class="comment">%     the correction, use OCS.CM.Data + OCS.CM.Delta</span>
0156 <span class="comment">%</span>
0157 <span class="comment">%  See also orbitcorrectionmethods, setorbitbump, setorbitgui, rmdisp, plotcm</span>
0158 
0159 <span class="comment">%  Written by Greg Portmann</span>
0160 
0161 
0162 <span class="comment">% Initialize</span>
0163 ErrorFlag = 0;
0164 ExtraDelay = 0;
0165 DCCTLOW = .1;    <span class="comment">% A minimum stored current into the machine</span>
0166 
0167 DefaultNIter = 1;
0168 DefaultSVDIndex = 1e-4;
0169 DefaultGoalOrbit = <span class="string">'Golden'</span>;
0170 DefaultFitRF = 0;
0171 DefaultDisplay = 0;
0172 DefaultCorrectorGain = 1;
0173 
0174 RespFlag = <span class="string">'GoldenResp'</span>;
0175 DispFlag = <span class="string">'GoldenDisp'</span>;
0176 SetSPFlag = 1;
0177 GetPVFlag = 1;
0178 RF0 = [];
0179 RF  = [];
0180 FigHandles = [];
0181 AxesHandles = [];
0182 
0183 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0184 <span class="comment">% Input parsing and checking %</span>
0185 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0186 IncrementalFlag = -1;
0187 ModeFlag = <span class="string">''</span>;
0188 InputFlags = {};
0189 OCSFlags = {};
0190 
0191 <span class="comment">% OCS init and defaults</span>
0192 OCS.BPM = [];
0193 OCS.CM  = [];
0194 OCS.GoalOrbit = DefaultGoalOrbit;
0195 OCS.SVDIndex  = DefaultSVDIndex;
0196 OCS.FitRF     = DefaultFitRF;
0197 OCS.NIter     = DefaultNIter;
0198 OCS.Display   = DefaultDisplay;
0199 OCS.CorrectorGain = DefaultCorrectorGain;
0200 OCS.Incremental = 0;
0201 OCS.Tolerance = 0;
0202 OCS.RampSteps = 1;
0203 
0204 <span class="comment">% First check if an OCS structure was input</span>
0205 OCSInputFlag = 0;
0206 <span class="keyword">if</span> length(varargin) &gt;= 1
0207     <span class="keyword">if</span> isstruct(varargin{1})
0208         <span class="keyword">if</span> isfield(varargin{1},<span class="string">'BPM'</span>) &amp;&amp; isfield(varargin{1},<span class="string">'CM'</span>)
0209             OCSInputFlag = 1;
0210                         
0211             OCSin = varargin{1};
0212             varargin(1) = [];
0213 
0214             <span class="comment">% Copy the input OSC on top of the defaults</span>
0215             FieldCell = fieldnames(OCSin);
0216             <span class="keyword">for</span> i = 1:length(FieldCell)
0217                 OCS.(FieldCell{i}) = OCSin.(FieldCell{i});
0218             <span class="keyword">end</span>
0219            
0220             <span class="comment">% Attach the flags</span>
0221             <span class="keyword">if</span> isfield(OCS, <span class="string">'Flags'</span>)
0222                 varargin = [varargin OCS.Flags];
0223             <span class="keyword">end</span>
0224         <span class="keyword">end</span>
0225     <span class="keyword">end</span>
0226 <span class="keyword">end</span>
0227 
0228 
0229 <span class="keyword">for</span> i = length(varargin):-1:1
0230     <span class="keyword">if</span> isstruct(varargin{i})
0231         <span class="comment">% Ignor structures</span>
0232     <span class="keyword">elseif</span> iscell(varargin{i})
0233         <span class="comment">% Ignor cells</span>
0234 
0235     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Golden'</span>)
0236         <span class="comment">% Use the golden orbit</span>
0237         OCS.GoalOrbit = <span class="string">'Golden'</span>;
0238         varargin(i) = [];
0239     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Offset'</span>)
0240         <span class="comment">% Use the offset orbit</span>
0241         OCS.GoalOrbit = <span class="string">'Offset'</span>;
0242         varargin(i) = [];
0243 
0244     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'FitRF'</span>,<span class="string">'SetRF'</span>,<span class="string">'RFCorrector'</span>}))
0245         <span class="comment">%SetRFString = 'Set the RF frequency (Eta Column)';</span>
0246         OCS.FitRF = 1;
0247         varargin(i) = [];
0248     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'FitRFHCM0'</span>,<span class="string">'FitRFEnergy'</span>,<span class="string">'SetRFHCM0'</span>,<span class="string">'SetRFEnergy'</span>}))
0249         <span class="comment">%SetRFString = 'Set the RF frequency (HCM energy constraint)';</span>
0250         OCS.FitRF = 2;
0251         varargin(i) = [];
0252     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'FitRFDeltaHCM0'</span>,<span class="string">'SetRFDeltaHCM0'</span>}))
0253         <span class="comment">%SetRFString = 'Set the RF frequency (Delta HCM energy constraint)';</span>
0254         OCS.FitRF = 3;
0255         varargin(i) = [];
0256     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'FitRFDispersionOrbit'</span>,<span class="string">'SetRFDispersionOrbit'</span>}))
0257         <span class="comment">%SetRFString = 'Set the RF frequency (Dispersion orbit constraint)';</span>
0258         OCS.FitRF = 4;
0259         varargin(i) = [];
0260     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'FitRFDispersionHCM'</span>,<span class="string">'SetRFDispersionHCM'</span>}))
0261         <span class="comment">%SetRFString = 'Set the RF frequency (Dispersion correction constraint)';</span>
0262         OCS.FitRF = 5;
0263         varargin(i) = [];
0264 
0265     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Display'</span>)
0266         OCS.Display = 1;
0267         varargin(i) = [];
0268     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'NoDisplay'</span>) || strcmpi(varargin{i},<span class="string">'No Display'</span>)
0269         OCS.Display = 0;
0270         varargin(i) = [];
0271 
0272     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'ModelResp'</span>)
0273         RespFlag = varargin{i};
0274         varargin(i) = [];
0275     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'GoldenResp'</span>)
0276         RespFlag = varargin{i};
0277         varargin(i) = [];
0278 
0279     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'ModelDisp'</span>)
0280         DispFlag = varargin{i};
0281         varargin(i) = [];
0282     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'MeasDisp'</span>)
0283         DispFlag = varargin{i};
0284         varargin(i) = [];
0285     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'GoldenDisp'</span>)
0286         DispFlag = varargin{i};
0287         varargin(i) = [];
0288 
0289     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'Inc'</span>,<span class="string">'Incremental'</span>}))
0290         OCS.Incremental = 1;
0291         varargin(i) = [];
0292     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'Abs'</span>,<span class="string">'Absolute'</span>}))
0293         OCS.Incremental = 0;
0294         varargin(i) = [];
0295 
0296     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'SetPV'</span>,<span class="string">'SetSP'</span>}))
0297         SetSPFlag = 1;
0298         varargin(i) = [];
0299     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'NoSetPV'</span>,<span class="string">'NoSetSP'</span>}))
0300         SetSPFlag = 0;
0301         varargin(i) = [];
0302 
0303     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'GetPV'</span>,<span class="string">'GetAM'</span>}))
0304         GetPVFlag = 1;
0305         varargin(i)   = [];
0306     <span class="keyword">elseif</span> any(strcmpi(varargin{i},{<span class="string">'NoGetPV'</span>,<span class="string">'NoGetAM'</span>}))
0307         GetPVFlag = 0;
0308         varargin(i)   = [];
0309 
0310     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Simulator'</span>) || strcmpi(varargin{i},<span class="string">'Model'</span>)
0311         ModeFlag = <span class="string">'Simulator'</span>;
0312         <span class="comment">%OCSFlags = [OCSFlags varargin(i)];    % Don't maintain the mode field, it must be on the input field</span>
0313         InputFlags = [InputFlags varargin(i)];
0314         varargin(i) = [];
0315     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Online'</span>)
0316         ModeFlag = <span class="string">'Online'</span>;
0317         <span class="comment">%OCSFlags = [OCSFlags varargin(i)];    % Don't maintain the mode field, it must be on the input field</span>
0318         InputFlags = [InputFlags varargin(i)];
0319         varargin(i) = [];
0320     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Manual'</span>)
0321         ModeFlag = <span class="string">'Manual'</span>;
0322         <span class="comment">%OCSFlags = [OCSFlags varargin(i)];    % Don't maintain the mode field, it must be on the input field</span>
0323         InputFlags = [InputFlags varargin(i)];
0324         varargin(i) = [];
0325     
0326     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'physics'</span>)
0327         OCSFlags = [OCSFlags varargin(i)];
0328         InputFlags = [InputFlags varargin(i)];
0329         varargin(i) = [];
0330     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'hardware'</span>)
0331         OCSFlags = [OCSFlags varargin(i)];
0332         InputFlags = [InputFlags varargin(i)];
0333         varargin(i) = [];
0334 
0335     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'FigureHandles'</span>)
0336         OCS.Display = 1;
0337         FigHandles = varargin{i+1};
0338         <span class="keyword">if</span> ~any(length(FigHandles) == [1 2  3 6])
0339             error(<span class="string">'Figure handles must be of length 1 or 2 for figures or 3 or 6 for axes.'</span>);
0340         <span class="keyword">end</span>
0341         varargin(i+1) = [];
0342         varargin(i)   = [];
0343 
0344     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'CorrectorGain'</span>)
0345         OCS.CorrectorGain = varargin{i+1};
0346         varargin(i+1) = [];
0347         varargin(i)   = [];
0348 
0349     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Tolerance'</span>)
0350         OCS.Tolerance = varargin{i+1};
0351         varargin(i+1) = [];
0352         varargin(i)   = [];
0353 
0354     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'RampSteps'</span>)
0355         OCS.RampSteps = varargin{i+1};
0356         varargin(i+1) = [];
0357         varargin(i)   = [];
0358 
0359     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Archive'</span>)
0360         <span class="comment">% Just remove</span>
0361         varargin(i) = [];
0362     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'NoArchive'</span>)
0363         <span class="comment">% Just remove</span>
0364         varargin(i) = [];
0365     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Struct'</span>)
0366         <span class="comment">% Just remove</span>
0367         varargin(i) = [];
0368     <span class="keyword">elseif</span> strcmpi(varargin{i},<span class="string">'Numeric'</span>)
0369         <span class="comment">% Just remove</span>
0370         varargin(i) = [];
0371     <span class="keyword">end</span>
0372 <span class="keyword">end</span>
0373 
0374 OCSFlags = [OCSFlags {RespFlag} {DispFlag}];
0375 
0376 
0377 <span class="keyword">if</span> ~OCSInputFlag
0378     <span class="keyword">if</span> iscell(varargin{1})
0379         <span class="keyword">if</span> isstruct(varargin{1}{1})
0380             <span class="comment">% BPM, CM</span>
0381             <span class="keyword">if</span> length(varargin) &lt; 2
0382                 error(<span class="string">'Input parsing problem'</span>);
0383             <span class="keyword">end</span>
0384             <span class="keyword">if</span> ~iscell(varargin{1}) || ~iscell(varargin{2})
0385                 error(<span class="string">'When using cell arrays BPM and CM inputs must all be cell arrays'</span>);
0386             <span class="keyword">end</span>
0387             OCS.BPM = varargin{1};
0388             OCS.CM = varargin{2};
0389             varargin(1:2) = [];
0390         <span class="keyword">else</span>
0391             <span class="comment">% GoalOrbit, BPM, CM</span>
0392             <span class="keyword">if</span> length(varargin) &lt; 3
0393                 error(<span class="string">'Input parsing problem'</span>);
0394             <span class="keyword">end</span>
0395             OCS.GoalOrbit = varargin{1};
0396             <span class="keyword">if</span> ~iscell(varargin{2}) || ~iscell(varargin{3})
0397                 error(<span class="string">'When using cell arrays BPM and CM inputs must all be cell arrays'</span>);
0398             <span class="keyword">end</span>
0399             OCS.BPM = varargin{2};
0400             OCS.CM = varargin{3};
0401             varargin(1:3) = [];
0402         <span class="keyword">end</span>
0403     <span class="keyword">elseif</span> isstruct(varargin{1})
0404         <span class="comment">% BPM and CM are structures, Golden orbit is not</span>
0405         <span class="comment">% Golden orbit could have been a string which has already been removed</span>
0406         <span class="keyword">if</span> length(varargin) &lt; 2
0407             error(<span class="string">'Input parsing problem: BPM and/or CM not found'</span>);
0408         <span class="keyword">end</span>
0409         OCS.BPM = varargin{1};
0410         varargin(1) = [];
0411         <span class="keyword">if</span> ischar(OCS.BPM)
0412             FamilyName = OCS.BPM;
0413             DeviceList = varargin{1};
0414             <span class="keyword">if</span> length(varargin) &lt; 1
0415                 error(<span class="string">'BPM device list must exist'</span>);
0416             <span class="keyword">end</span>
0417             varargin(1) = [];
0418             OCS.BPM = <a href="family2datastruct.html" class="code" title="function [DataStruct, ErrorFlag] = family2datastruct(varargin)">family2datastruct</a>(FamilyName, DeviceList);
0419         <span class="keyword">end</span>
0420         OCS.CM = varargin{1};
0421         varargin(1) = [];
0422         <span class="keyword">if</span> ischar(OCS.CM)
0423             FamilyName = OCS.CM;
0424             <span class="keyword">if</span> length(varargin) &lt; 1
0425                 error(<span class="string">'Corrector magnet device list must exist'</span>);
0426             <span class="keyword">end</span>
0427             DeviceList = varargin{1};
0428             varargin(1) = [];
0429             OCS.CM = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(FamilyName, DeviceList, <span class="string">'struct'</span>);
0430         <span class="keyword">end</span>
0431     <span class="keyword">else</span>
0432         <span class="keyword">if</span> isnumeric(varargin{1})
0433             <span class="keyword">if</span> length(varargin) &lt; 3
0434                 error(<span class="string">'Input parsing problem: GoalOrbit, BPM, CM not all found'</span>);
0435             <span class="keyword">end</span>
0436             OCS.GoalOrbit = varargin{1};
0437             varargin(1) = [];
0438         <span class="keyword">else</span>
0439             <span class="keyword">if</span> length(varargin) &lt; 2
0440                 error(<span class="string">'Input parsing problem: BPM and/or CM not found'</span>);
0441             <span class="keyword">end</span>
0442         <span class="keyword">end</span>
0443 
0444         OCS.BPM = varargin{1};
0445         varargin(1) = [];
0446         <span class="keyword">if</span> ischar(OCS.BPM)
0447             FamilyName = OCS.BPM;
0448             <span class="keyword">if</span> isnumeric(varargin{1})
0449                 DeviceList = varargin{1};
0450                 varargin(1) = [];
0451             <span class="keyword">else</span>
0452                 DeviceList = [];
0453             <span class="keyword">end</span>
0454             <span class="keyword">if</span> length(varargin) &lt; 1
0455                 error(<span class="string">'BPM device list must exist'</span>);
0456             <span class="keyword">end</span>
0457             OCS.BPM = <a href="family2datastruct.html" class="code" title="function [DataStruct, ErrorFlag] = family2datastruct(varargin)">family2datastruct</a>(FamilyName, DeviceList);
0458         <span class="keyword">end</span>
0459 
0460         OCS.CM = varargin{1};
0461         varargin(1) = [];
0462         <span class="keyword">if</span> ischar(OCS.CM)
0463             FamilyName = OCS.CM;
0464             <span class="keyword">if</span> length(varargin) &lt; 1
0465                 error(<span class="string">'Corrector magnget device list must exist'</span>);
0466             <span class="keyword">end</span>
0467             <span class="keyword">if</span> isnumeric(varargin{1})
0468                 DeviceList = varargin{1};
0469                 varargin(1) = [];
0470             <span class="keyword">else</span>
0471                 DeviceList = [];
0472             <span class="keyword">end</span>
0473             OCS.CM = <a href="getsp.html" class="code" title="function [SP, tout, DataTime, ErrorFlag] = getsp(Family, varargin)">getsp</a>(FamilyName, DeviceList, <span class="string">'struct'</span>);
0474         <span class="keyword">end</span>
0475     <span class="keyword">end</span>
0476 <span class="keyword">end</span>
0477 
0478 
0479 <span class="comment">% Get NIter</span>
0480 <span class="keyword">if</span> length(varargin) &gt;= 1
0481     OCS.NIter = varargin{1};
0482     varargin(1) = [];
0483 <span class="keyword">end</span>
0484 <span class="keyword">if</span> isempty(OCS.NIter)
0485     OCS.NIter = DefaultNIter;
0486 <span class="keyword">end</span>
0487 
0488 <span class="comment">% Get SVDIndex</span>
0489 <span class="keyword">if</span> length(varargin) &gt;= 1
0490     OCS.SVDIndex = varargin{1};
0491     varargin(1) = [];
0492 <span class="keyword">end</span>
0493 <span class="keyword">if</span> isempty(OCS.SVDIndex)
0494     OCS.SVDIndex = DefaultSVDIndex;
0495 <span class="keyword">end</span>
0496 
0497 
0498 <span class="comment">% Get BPMWeight</span>
0499 <span class="keyword">if</span> length(varargin) &gt;= 1
0500     OCS.BPMWeight = varargin{1};
0501     varargin(1) = [];
0502 <span class="keyword">end</span>
0503 
0504 
0505 <span class="comment">% Check BPM field</span>
0506 <span class="keyword">if</span> isempty(OCS.BPM)
0507     OCS.BPM = {<a href="gethbpmfamily.html" class="code" title="function Family = gethbpmfamily(OneHit)">gethbpmfamily</a>, <a href="getvbpmfamily.html" class="code" title="function Family = getvbpmfamily(OneHit)">getvbpmfamily</a>};
0508 <span class="keyword">end</span>
0509 
0510 <span class="comment">% Check CM field</span>
0511 <span class="keyword">if</span> isempty(OCS.CM)
0512     OCS.CM = {<a href="gethcmfamily.html" class="code" title="function Family = gethcmfamily(OneHit)">gethcmfamily</a>,  <a href="getvcmfamily.html" class="code" title="function Family = getvcmfamily(OneHit)">getvcmfamily</a>};
0513 <span class="keyword">end</span>
0514 
0515 
0516 <span class="comment">% Check the Display field</span>
0517 <span class="keyword">if</span> isempty(OCS.Display)
0518     OCS.Display = DefaultDisplay;
0519 <span class="keyword">end</span>
0520 
0521 
0522 <span class="comment">% Check the corrector gain</span>
0523 <span class="keyword">if</span> isempty(OCS.CorrectorGain)
0524     OCS.CorrectorGain = DefaultCorrectorGain;
0525 <span class="keyword">end</span>
0526 
0527 
0528 <span class="comment">% Check NIter</span>
0529 <span class="keyword">if</span> OCS.Incremental
0530     <span class="keyword">if</span> ~OCS.Display &amp;&amp; OCS.NIter == 1
0531         <span class="comment">% Use OCS.NIter=0, since BPM data is not needed</span>
0532         OCS.NIter = 0;
0533     <span class="keyword">end</span>
0534 <span class="keyword">else</span>
0535     <span class="keyword">if</span> OCS.NIter == 0
0536         error(<span class="string">'Number of iterations cannot be zero for absolute orbit changes'</span>);
0537     <span class="keyword">end</span>
0538 <span class="keyword">end</span>
0539 
0540 
0541 <span class="comment">% Make cell arrays if they are not already</span>
0542 <span class="keyword">if</span> ~iscell(OCS.BPM)
0543     NoCellBPMFlag = 1;
0544     OCS.BPM = {OCS.BPM};
0545 <span class="keyword">else</span>
0546     NoCellBPMFlag = 0;
0547 <span class="keyword">end</span>
0548 <span class="keyword">if</span> ~iscell(OCS.CM)
0549     NoCellCMFlag = 1;
0550     OCS.CM = {OCS.CM};
0551     <span class="keyword">if</span> isfield(OCS, <span class="string">'CMWeight'</span>) &amp;&amp; ~iscell(OCS.CMWeight)
0552         OCS.CMWeight = {OCS.CMWeight};
0553     <span class="keyword">end</span>
0554 <span class="keyword">else</span>
0555     NoCellCMFlag = 0;
0556 <span class="keyword">end</span>
0557 
0558 
0559 <span class="comment">% Attach the flags</span>
0560 OCS.Flags = OCSFlags;
0561 
0562 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0563 <span class="comment">% End input parsing and checking %</span>
0564 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0565 
0566 
0567 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0568 <span class="comment">% Check for good status if online %</span>
0569 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0570 <span class="keyword">for</span> i = 1:length(OCS.BPM)
0571     <span class="keyword">if</span> strcmpi(<a href="getmode.html" class="code" title="function Mode = getmode(Family, Field)">getmode</a>(OCS.BPM{i}),<span class="string">'Online'</span>)
0572         [S, IndexList] = <a href="family2status.html" class="code" title="function [S, IndexList] = family2status(Family, DeviceList)">family2status</a>(OCS.BPM{i});
0573         <span class="keyword">if</span> find(S==0)
0574             tmp = questdlg({sprintf(<span class="keyword">...</span>
0575                 <span class="string">'BPM family %s is showing %d element(s) with bad status.'</span>, OCS.BPM{i}.FamilyName, length(find(S==0))), <span class="keyword">...</span>
0576                 <span class="string">'Do you want to continue with orbit correction?'</span>},<span class="keyword">...</span>
0577                 <span class="string">'SETORBIT'</span>,<span class="string">'YES'</span>,<span class="string">'NO'</span>,<span class="string">'NO'</span>);
0578             <span class="keyword">if</span> ~strcmpi(tmp,<span class="string">'YES'</span>)
0579                 <span class="keyword">return</span>
0580             <span class="keyword">end</span>
0581         <span class="keyword">end</span>
0582     <span class="keyword">end</span>
0583 <span class="keyword">end</span>
0584 <span class="keyword">for</span> i = 1:length(OCS.CM)
0585     <span class="keyword">if</span> strcmpi(<a href="getmode.html" class="code" title="function Mode = getmode(Family, Field)">getmode</a>(OCS.CM{i}),<span class="string">'Online'</span>)
0586         [S, IndexList] = <a href="family2status.html" class="code" title="function [S, IndexList] = family2status(Family, DeviceList)">family2status</a>(OCS.CM{i});
0587         <span class="keyword">if</span> find(S==0)
0588             tmp = questdlg({sprintf(<span class="keyword">...</span>
0589                 <span class="string">'Corrector family %s is showing %d element(s) with bad status.'</span>, OCS.CM{i}.FamilyName, length(find(S==0))), <span class="keyword">...</span>
0590                 <span class="string">'Do you want to continue with orbit correction?'</span>},<span class="keyword">...</span>
0591                 <span class="string">'SETORBIT'</span>,<span class="string">'YES'</span>,<span class="string">'NO'</span>,<span class="string">'NO'</span>);
0592             <span class="keyword">if</span> ~strcmpi(tmp,<span class="string">'YES'</span>)
0593                 <span class="keyword">return</span>
0594             <span class="keyword">end</span>
0595         <span class="keyword">end</span>
0596     <span class="keyword">end</span>
0597 <span class="keyword">end</span>
0598 
0599 
0600 <span class="comment">% Check BPMWeight</span>
0601 <span class="keyword">if</span> ~isfield(OCS, <span class="string">'BPMWeight'</span>)
0602     <span class="keyword">for</span> i = 1:length(OCS.BPM)
0603         OCS.BPMWeight{i} = [];
0604     <span class="keyword">end</span>
0605 <span class="keyword">end</span>
0606 <span class="keyword">if</span> ~iscell(OCS.BPMWeight)
0607     OCS.BPMWeight = {OCS.BPMWeight};
0608 <span class="keyword">end</span>
0609 
0610 
0611 
0612 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0613 <span class="comment">% Build the goal orbit cell %</span>
0614 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0615 <span class="keyword">if</span> ischar(OCS.GoalOrbit)
0616     GoalOrbitFlag = OCS.GoalOrbit;
0617     OCS.GoalOrbit = [];
0618     <span class="keyword">for</span> i = 1:length(OCS.BPM)
0619         <span class="keyword">if</span> strcmpi(GoalOrbitFlag,<span class="string">'Golden'</span>)
0620             tmp = <a href="getgolden.html" class="code" title="function Data = getgolden(varargin)">getgolden</a>(OCS.BPM{i}, <span class="string">'Numeric'</span>);
0621         <span class="keyword">elseif</span> strcmpi(GoalOrbitFlag,<span class="string">'Offset'</span>)
0622             tmp = <a href="getoffset.html" class="code" title="function Data = getoffset(varargin)">getoffset</a>(OCS.BPM{i}, <span class="string">'Numeric'</span>);
0623         <span class="keyword">else</span>
0624             error(<span class="string">'Only golden and offset orbits are known'</span>)
0625         <span class="keyword">end</span>
0626         OCS.GoalOrbit{i} = tmp;
0627     <span class="keyword">end</span>
0628 <span class="keyword">end</span>
0629 <span class="keyword">if</span> ~iscell(OCS.GoalOrbit)
0630     OCS.GoalOrbit = {OCS.GoalOrbit};
0631 <span class="keyword">end</span>
0632 
0633 
0634 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%</span>
0635 <span class="comment">% End of Input Setup %</span>
0636 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%</span>
0637 
0638 
0639 
0640 <span class="comment">% Save the starting RF frequency</span>
0641 <span class="keyword">if</span> GetPVFlag
0642     OCS.RF = <a href="getrf.html" class="code" title="function [RFsp, RFam, DataTime, ErrorFlag] = getrf(varargin)">getrf</a>(<span class="string">'Struct'</span>, InputFlags{:});
0643 <span class="keyword">end</span>
0644 
0645 
0646 <span class="comment">% Number of iterations (OCS.NIter can be 0 for display reasons with increment changes)</span>
0647 <span class="keyword">if</span> OCS.NIter == 0
0648     NumberOfTrys = 1;
0649 <span class="keyword">else</span>
0650     NumberOfTrys = OCS.NIter;
0651 <span class="keyword">end</span>
0652 
0653 
0654 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0655 <span class="comment">% Build the starting orbit %</span>
0656 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0657 <span class="keyword">for</span> i = 1:length(OCS.BPM)
0658     <span class="keyword">if</span> OCS.NIter == 0
0659         <span class="comment">% Don't use BPM data for zero interations</span>
0660         OCS.BPM{i}.Data = zeros(size(OCS.BPM{i}.DeviceList,1),1);
0661     <span class="keyword">else</span>
0662         <span class="keyword">if</span> GetPVFlag
0663             <span class="comment">% Get new BPM data if not in calculate mode</span>
0664             OCS.BPM{i} = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(OCS.BPM{i}, <span class="string">'Struct'</span>, InputFlags{:});
0665         <span class="keyword">end</span>
0666     <span class="keyword">end</span>
0667 <span class="keyword">end</span>
0668 
0669 <span class="comment">% For increment changes, convert the goal orbit to an absolute orbit</span>
0670 <span class="keyword">if</span> OCS.Incremental
0671     <span class="keyword">for</span> i = 1:length(OCS.GoalOrbit)
0672         OCS.GoalOrbit{i} = OCS.GoalOrbit{i} + OCS.BPM{i}.Data;
0673     <span class="keyword">end</span>
0674     
0675     <span class="comment">% The incremental flag is always zero on exit because the orbits are absolute at this point</span>
0676     OCS.Incremental = 0;
0677 <span class="keyword">end</span>
0678 
0679 
0680 
0681 <span class="comment">% Interactively select singular value</span>
0682 SVDquestion = <span class="string">'Select Again'</span>;
0683 MorePlotsFlag = 0;
0684 <span class="keyword">while</span> strcmp(SVDquestion,<span class="string">'Select Again'</span>)
0685 
0686     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0687     <span class="comment">% Build the starting orbit %</span>
0688     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0689     <span class="keyword">for</span> i = 1:length(OCS.BPM)
0690         <span class="keyword">if</span> OCS.NIter == 0
0691             <span class="comment">% Don't use BPM data for zero interations</span>
0692             OCS.BPM{i}.Data = zeros(size(OCS.BPM{i}.DeviceList,1),1);
0693         <span class="keyword">else</span>
0694             <span class="keyword">if</span> GetPVFlag
0695                 <span class="comment">% Get new BPM data if not in calculate mode</span>
0696                 OCS.BPM{i} = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(OCS.BPM{i}, <span class="string">'Struct'</span>, InputFlags{:});
0697             <span class="keyword">end</span>
0698         <span class="keyword">end</span>
0699     <span class="keyword">end</span>
0700 
0701 
0702     <span class="comment">% Get the present setpoints</span>
0703     <span class="keyword">if</span> GetPVFlag
0704         OCS.CM = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(OCS.CM, <span class="string">'Struct'</span>, InputFlags{:});
0705     <span class="keyword">end</span>
0706 
0707     <span class="comment">% Compute the correction</span>
0708     [OCS, Smat, S, U, V] = <a href="orbitcorrectionmethods.html" class="code" title="function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)">orbitcorrectionmethods</a>(OCS);
0709 
0710     <span class="comment">% Save the starting OCS (with possible CM &amp; BPM list changes)</span>
0711     OCS0 = OCS;
0712 
0713     <span class="keyword">if</span> OCS.Display  <span class="comment">% || length(FigHandles&gt;=3)</span>
0714         [FigHandles, AxesHandles, OCS] = <a href="#_sub2" class="code" title="subfunction [H, Haxis, OCS] = PreCorrectionDisplay(H, OCS0, OCS, Smat, S, U, V, NumberOfTrys, MorePlotsFlag, InputFlags)">PreCorrectionDisplay</a>(FigHandles, OCS0, OCS, Smat, S, U, V, NumberOfTrys, MorePlotsFlag, InputFlags);
0715     <span class="keyword">else</span>
0716         SVDquestion = <span class="string">'Correct Orbit'</span>;
0717     <span class="keyword">end</span>
0718 
0719     <span class="keyword">if</span> SetSPFlag &amp;&amp; OCS.Display &amp;&amp; length(FigHandles)&lt;3
0720         Units = get(0,<span class="string">'units'</span>);
0721         <span class="keyword">if</span> strcmpi(Units, <span class="string">'Normalized'</span>)
0722             fprintf(<span class="string">'   Setting the command window units to pixels since the menu command fails with normalized units.\n'</span>);
0723             set(0,<span class="string">'units'</span>,<span class="string">'pixels'</span>);
0724         <span class="keyword">end</span>
0725         <span class="keyword">if</span> MorePlotsFlag == 0
0726             tmp = menu(<span class="string">''</span>, <span class="keyword">...</span>
0727                 <span class="string">'Apply orbit correction'</span>, <span class="keyword">...</span>
0728                 <span class="string">'Change the number of singular values'</span>, <span class="keyword">...</span>
0729                 <span class="string">'Change the BPMs'</span>, <span class="keyword">...</span>
0730                 <span class="string">'Change the correctors'</span>, <span class="keyword">...</span>
0731                 <span class="string">'Plot more information (AT Model required)'</span>, <span class="keyword">...</span>
0732                 <span class="string">'Exit - No orbit correction'</span>);
0733         <span class="keyword">else</span>
0734             tmp = menu(<span class="string">''</span>, <span class="keyword">...</span>
0735                 <span class="string">'Apply orbit correction'</span>, <span class="keyword">...</span>
0736                 <span class="string">'Change the number of singular values'</span>, <span class="keyword">...</span>
0737                 <span class="string">'Change the BPMs'</span>, <span class="keyword">...</span>
0738                 <span class="string">'Change the correctors'</span>, <span class="keyword">...</span>
0739                 <span class="string">'Close &quot;more information plot&quot;'</span>, <span class="keyword">...</span>
0740                 <span class="string">'Exit - No orbit correction'</span>);
0741         <span class="keyword">end</span>
0742         <span class="keyword">if</span> tmp == 6
0743             fprintf(<span class="string">'   Orbit not corrected\n'</span>);
0744             SVDquestion = <span class="string">'Correct not corrected'</span>;
0745             SetSPFlag = 0;
0746         <span class="keyword">elseif</span> tmp == 1
0747             SVDquestion = <span class="string">'Correct Orbit'</span>;
0748         <span class="keyword">elseif</span> tmp == 2
0749             <span class="comment">% Change the singular values</span>
0750             def = {sprintf(<span class="string">'[%d:%d]'</span>,OCS.SVDIndex(1),OCS.SVDIndex(end))};
0751             answer=inputdlg({<span class="string">'Which singular values:'</span>}, <span class="string">'SETORBIT'</span>, 1, def);
0752             <span class="keyword">if</span> ~isempty(answer)
0753                 tmp = str2num(answer{1});
0754 
0755                 <span class="comment">% Test for out-ot-range</span>
0756                 <span class="keyword">if</span> all(tmp&lt;=size(V,2)) &amp;&amp; ~isempty(tmp)
0757                     OCS.SVDIndex = tmp;
0758                 <span class="keyword">else</span>
0759                     fprintf(<span class="string">'   Singular value selection out-of-range.  Select again and try a new range.\n'</span>);
0760                 <span class="keyword">end</span>
0761             <span class="keyword">end</span>
0762         <span class="keyword">elseif</span> tmp == 3
0763             <span class="comment">% Change BPMs</span>
0764             <span class="keyword">for</span> i = 1:length(OCS.BPM)
0765                 List0 = OCS.BPM{i}.DeviceList;
0766                 ListTotal = <a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin)">family2dev</a>(OCS.BPM{i}.FamilyName);
0767                 j = findrowindex(OCS.BPM{i}.DeviceList, ListTotal);
0768                 CheckedList = zeros(size(ListTotal,1),1);
0769                 CheckedList(j) = 1;
0770                 OCS.BPM{i}.DeviceList = editlist(ListTotal, OCS.BPM{i}.FamilyName, CheckedList);
0771 
0772                 [j,jNotFound] = findrowindex(OCS.BPM{i}.DeviceList, List0);
0773                 <span class="keyword">if</span> isempty(jNotFound)
0774                     OCS.GoalOrbit{i} = OCS.GoalOrbit{i}(j);
0775                     <span class="keyword">if</span> ~isempty(OCS.BPMWeight{i}) &amp;&amp; isvector(OCS.BPMWeight{i})
0776                         OCS.BPMWeight{i} = OCS.BPMWeight{i}(j);
0777                     <span class="keyword">end</span>
0778                 <span class="keyword">else</span>
0779                     <span class="comment">% New BPMs were added</span>
0780                     <span class="keyword">if</span> any(strcmpi(OCS.Flags,<span class="string">'Golden'</span>))
0781                         OCS.GoalOrbit{i} = <a href="getgolden.html" class="code" title="function Data = getgolden(varargin)">getgolden</a>(OCS.BPM{i}, <span class="string">'Numeric'</span>);
0782                     <span class="keyword">elseif</span> any(strcmpi(OCS.Flags,<span class="string">'Offset'</span>))
0783                         OCS.GoalOrbit{i} = <a href="getoffset.html" class="code" title="function Data = getoffset(varargin)">getoffset</a>(OCS.BPM{i}, <span class="string">'Numeric'</span>);
0784                     <span class="keyword">else</span>
0785                         error(<span class="string">'Unknown goal orbit for the new BPMs'</span>);
0786                     <span class="keyword">end</span>
0787                     <span class="keyword">if</span> ~isempty(OCS.BPMWeight{i})
0788                         <span class="keyword">if</span> all(OCS.BPMWeight{i} == max(OCS.BPMWeight{i}))
0789                             <span class="comment">% If all the weights are the same, then the new BPMs get the same weight</span>
0790                             OCS.BPMWeight{i} = OCS.BPMWeight{i}(1) * ones(size(OCS.BPM{i}.DeviceList,1),1);
0791                         <span class="keyword">else</span>
0792                             error(<span class="string">'Unknown BPM weights for new BPMs'</span>);
0793                         <span class="keyword">end</span>
0794                     <span class="keyword">end</span>
0795                 <span class="keyword">end</span>
0796             <span class="keyword">end</span>
0797         <span class="keyword">elseif</span> tmp == 4
0798             <span class="comment">% Change correctors</span>
0799             <span class="keyword">for</span> i = 1:length(OCS.CM)
0800                 ListTotal = <a href="family2dev.html" class="code" title="function DeviceList = family2dev(Family, varargin)">family2dev</a>(OCS.CM{i}.FamilyName);
0801                 j = findrowindex(OCS.CM{i}.DeviceList, ListTotal);
0802                 CheckedList = zeros(size(ListTotal,1),1);
0803                 CheckedList(j) = 1;
0804                 OCS.CM{i}.DeviceList = editlist(ListTotal, OCS.CM{i}.FamilyName, CheckedList);
0805             <span class="keyword">end</span>
0806         <span class="keyword">elseif</span> tmp == 5
0807             <span class="keyword">if</span> MorePlotsFlag == 0
0808                 MorePlotsFlag = 1;
0809             <span class="keyword">else</span>
0810                 MorePlotsFlag = 0;
0811                 close(FigHandles(2));
0812                 FigHandles = [FigHandles(1); NaN];
0813 
0814                 <span class="comment">% Make figure 1 a little wider</span>
0815                 p = get(FigHandles(1), <span class="string">'Position'</span>);
0816                 set(FigHandles(1), <span class="string">'Position'</span>, [p(1)-.1*p(3) p(2) p(3)+.1*p(3) p(4)]);
0817             <span class="keyword">end</span>
0818         <span class="keyword">end</span>
0819     <span class="keyword">else</span>
0820         SVDquestion = <span class="string">'Get out of loop'</span>;
0821     <span class="keyword">end</span>
0822 <span class="keyword">end</span>
0823 
0824 
0825 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%</span>
0826 <span class="comment">% Exit if ~SetSPFlag %</span>
0827 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%</span>
0828 <span class="keyword">if</span> ~SetSPFlag
0829     <span class="comment">%% Put Delta into OCS.CM (don't do this since setorbit can be called multiple times before correcting)</span>
0830     <span class="comment">%for i = 1:length(OCS.CM)</span>
0831     <span class="comment">%    OCS.CM{i}.Data = OCS.CM{i}.Data + OCS.CM{i}.Delta;</span>
0832     <span class="comment">%end</span>
0833     <span class="comment">%if OCS.FitRF</span>
0834     <span class="comment">%    OCS.RF.Data = OCS.RF.Data + OCS.DeltaRF;</span>
0835     <span class="comment">%end</span>
0836 
0837     <span class="comment">% Remove the cell array if it was not input as a cell array</span>
0838     <span class="keyword">if</span> NoCellBPMFlag
0839         OCS.BPM = OCS.BPM{1};
0840         OCS0.BPM = OCS0.BPM{1};
0841 
0842         OCS.GoalOrbit = OCS.GoalOrbit{1};
0843         OCS0.GoalOrbit = OCS0.GoalOrbit{1};
0844 
0845         OCS.BPMWeight = OCS.BPMWeight{1};
0846         OCS0.BPMWeight = OCS0.BPMWeight{1};
0847     <span class="keyword">end</span>
0848     <span class="keyword">if</span> NoCellCMFlag
0849         OCS.CM = OCS.CM{1};
0850         OCS0.CM = OCS0.CM{1};
0851 
0852         <span class="keyword">if</span> isfield(OCS, <span class="string">'CMWeight'</span>)
0853             OCS.CMWeight = OCS.CMWeight{1};
0854             OCS0.CMWeight = OCS0.CMWeight{1};
0855         <span class="keyword">end</span>
0856     <span class="keyword">end</span>
0857     <span class="keyword">return</span>;
0858 <span class="keyword">end</span>
0859 
0860 
0861 
0862 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0863 <span class="comment">% Iterate on orbit correction %</span>
0864 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0865 
0866 <span class="keyword">if</span> ~isfield(OCS, <span class="string">'MinimumPeriod'</span>)
0867     OCS.MinimumPeriod = 0;
0868 <span class="keyword">end</span>
0869 <span class="keyword">if</span> isempty(OCS.MinimumPeriod)
0870     OCS.MinimumPeriod = 0;
0871 <span class="keyword">end</span>
0872 
0873         
0874 <span class="comment">% Running flag</span>
0875 RingSetOrbit.RunFlag = 1;
0876 setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
0877 
0878 OCS.NCorrections = 0;
0879 <span class="keyword">for</span> iloop = 1:NumberOfTrys
0880     tic;
0881 
0882     <span class="comment">% The 1st iteration is already computed</span>
0883     <span class="keyword">if</span> iloop &gt; 1
0884         <span class="comment">% Build the new starting orbit</span>
0885         <span class="keyword">for</span> i = 1:length(OCS.BPM)
0886             OCS.BPM{i} = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(OCS.BPM{i}, <span class="string">'Struct'</span>, InputFlags{:});
0887         <span class="keyword">end</span>
0888 
0889         <span class="comment">% Compute the correction</span>
0890         OCS = <a href="orbitcorrectionmethods.html" class="code" title="function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)">orbitcorrectionmethods</a>(OCS, Smat, S, U, V);
0891     <span class="keyword">end</span>
0892 
0893 
0894     <span class="comment">% Tolerance check</span>
0895     <span class="keyword">for</span> i = 1:length(OCS.BPM)
0896         TolFlag(i) = std(OCS.BPM{i}.Data(:) - OCS.GoalOrbit{i}(:)) &lt; OCS.Tolerance;
0897     <span class="keyword">end</span>
0898     <span class="keyword">if</span> all(TolFlag)
0899         <span class="keyword">break</span>;
0900     <span class="keyword">end</span>
0901 
0902     
0903     <span class="comment">% Put Delta into OCS.CM &amp; OCS.RF</span>
0904     <span class="keyword">for</span> i = 1:length(OCS.CM)
0905         OCS.CM{i}.Data = OCS.CM{i}.Data + OCS.CorrectorGain * OCS.CM{i}.Delta;
0906     <span class="keyword">end</span>
0907     <span class="keyword">if</span> OCS.FitRF
0908         OCS.RF.Data = OCS.RF.Data + OCS.CorrectorGain * OCS.DeltaRF;
0909     <span class="keyword">end</span>
0910 
0911 
0912     <span class="comment">% Check corrector power supply limits</span>
0913     <span class="keyword">for</span> i = 1:length(OCS.CM)
0914         MinSP = <a href="minsp.html" class="code" title="function [Data, ErrorFlag] = minsp(varargin)">minsp</a>(OCS.CM{i});
0915         MaxSP = <a href="maxsp.html" class="code" title="function [Data, ErrorFlag] = maxsp(varargin)">maxsp</a>(OCS.CM{i});
0916         
0917         <span class="comment">% Since the Max or Min sign is really arbitary, any(OCS.CM{i}.Data &gt; MaxSP) will not work</span>
0918         <span class="comment">% For instance, a max in hardware units can be a min in physics units.</span>
0919         <span class="comment">% It's better to check if it's between the max and min</span>
0920         [Tmp, SortIndex] = sort([MinSP OCS.CM{i}.Data MaxSP],2);
0921         <span class="keyword">if</span> any(SortIndex(:,2) ~= 2)
0922             icm = find(SortIndex(:,2) ~= 2);
0923             <span class="keyword">for</span> j = 1:length(icm)
0924                 fprintf(<span class="string">'   Setting %s(%d,%d) to %f would exceed [%f %f] %s range.\n'</span>, OCS.CM{i}.FamilyName, OCS.CM{i}.DeviceList(icm(j),:), OCS.CM{i}.Data(icm(j)), MinSP(icm(j)), MaxSP(icm(j)), OCS.CM{i}.UnitsString);
0925             <span class="keyword">end</span>
0926             fprintf(<span class="string">'   Orbit correction stopped on iteration %d.\n   A power supply limit would have been exceeded!\n'</span>, iloop);
0927             RingSetOrbit.RunFlag = 0;
0928             setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
0929             ErrorFlag = 1;
0930             <span class="keyword">break</span>;
0931             <span class="comment">%return;</span>
0932         <span class="keyword">end</span>
0933     <span class="keyword">end</span>
0934     <span class="keyword">if</span> ErrorFlag
0935         <span class="keyword">break</span>;
0936     <span class="keyword">end</span>
0937 
0938 
0939     <span class="comment">%if OCS.Display</span>
0940     <span class="comment">%    if OCS.NIter &gt; 1</span>
0941     <span class="comment">%        fprintf('   Iteration %d. Changing the correctors (%s)\n', iloop, datestr(clock, 0));</span>
0942     <span class="comment">%        if OCS.FitRF</span>
0943     <span class="comment">%            fprintf('   Iteration %d. Changing the RF frequency by %d %s\n', iloop, OCS.DeltaRF, OCS.RF.UnitsString);</span>
0944     <span class="comment">%        end</span>
0945     <span class="comment">%    else</span>
0946     <span class="comment">%        fprintf('   Setting the correctors (%s)\n', datestr(clock, 0));</span>
0947     <span class="comment">%        if OCS.FitRF</span>
0948     <span class="comment">%            fprintf('   Changing the RF frequency by %d %s (%s)\n', OCS.DeltaRF, OCS.RF.UnitsString, datestr(clock, 0));</span>
0949     <span class="comment">%        end</span>
0950     <span class="comment">%    end</span>
0951     <span class="comment">%end</span>
0952     
0953     <span class="comment">% Since power supplies get out of sync, it can be useful</span>
0954     <span class="comment">% to set the power supplies in smaller steps.</span>
0955     <span class="keyword">if</span> OCS.RampSteps == 1 || iloop &gt; 1
0956         <span class="comment">% Apply correction in 1 step</span>
0957         
0958         <span class="comment">% Set the RF frequency</span>
0959         <span class="keyword">if</span> OCS.FitRF
0960             <a href="steprf.html" class="code" title="function steprf(varargin)">steprf</a>(OCS.DeltaRF, -1, InputFlags{:});
0961         <span class="keyword">end</span>
0962 
0963         <span class="comment">% Set the correctors in one step</span>
0964         <a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>(OCS.CM, -2, InputFlags{:});
0965 
0966     <span class="keyword">else</span>
0967 
0968         <span class="comment">% Apply correction slowly</span>
0969         CM  = OCS.CM;
0970         CM1 = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(OCS.CM,<span class="string">'Struct'</span>);
0971         CM2 = OCS.CM;
0972 
0973         <span class="keyword">if</span> OCS.FitRF
0974             dRF = OCS.DeltaRF / OCS.RampSteps;
0975         <span class="keyword">end</span>
0976 
0977         <span class="keyword">for</span> j = 1:OCS.RampSteps
0978             <span class="keyword">if</span> j == OCS.RampSteps
0979                 WaitFlag = -2;
0980             <span class="keyword">else</span>
0981                 WaitFlag = -1;
0982             <span class="keyword">end</span>
0983             
0984             <span class="keyword">if</span> OCS.FitRF
0985                 <a href="steprf.html" class="code" title="function steprf(varargin)">steprf</a>(dRF, -1, InputFlags{:});
0986             <span class="keyword">end</span>
0987 
0988             <span class="keyword">for</span> i = 1:length(OCS.CM)
0989                 CM{i}.Data = CM1{i}.Data + (CM2{i}.Data - CM1{i}.Data)*(j/OCS.RampSteps);
0990                 <a href="setpv.html" class="code" title="function ErrorFlag = setpv(varargin)">setpv</a>(CM{i}, WaitFlag, InputFlags{:});
0991             <span class="keyword">end</span>
0992         <span class="keyword">end</span>
0993     <span class="keyword">end</span>
0994     
0995 
0996     OCS.NCorrections = iloop;            <span class="comment">% Count the actual number of corrections made</span>
0997     sleep(ExtraDelay);
0998 
0999         
1000     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1001     <span class="comment">% Build the final orbit %</span>
1002     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1003     <span class="keyword">for</span> i = 1:length(OCS.BPM)
1004         <span class="keyword">if</span> OCS.NIter &gt; 0
1005             OCS.BPM{i}.Data = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(OCS.BPM{i}, <span class="string">'Numeric'</span>, InputFlags{:});
1006         <span class="keyword">end</span>
1007     <span class="keyword">end</span>
1008 
1009 
1010     <span class="comment">% Get the present setpoints</span>
1011     <span class="comment">% Some accelerators might have digitizing errors that gets picked up with a reread</span>
1012     OCS.CM = <a href="getpv.html" class="code" title="function [AM, tout, DataTime, ErrorFlag] = getpv(varargin)">getpv</a>(OCS.CM, <span class="string">'Struct'</span>, InputFlags{:});
1013 
1014     <span class="keyword">if</span> OCS.FitRF
1015         OCS.RF = <a href="getrf.html" class="code" title="function [RFsp, RFam, DataTime, ErrorFlag] = getrf(varargin)">getrf</a>(<span class="string">'Struct'</span>, InputFlags{:});
1016     <span class="keyword">end</span>
1017 
1018 
1019     <span class="comment">% Display final result if OCS.Display, more than 0 iterations, and a setpoint change was made</span>
1020     <span class="comment">%if (OCS.Display | length(FigHandles&gt;=4)) &amp; OCS.NIter &amp; SetSPFlag</span>
1021     <span class="keyword">if</span> OCS.Display &amp;&amp; OCS.NIter &amp;&amp; SetSPFlag
1022         <a href="#_sub4" class="code" title="subfunction PostCorrectionDisplay(H, OCS0, OCS, Smat, S, U, V, Iteration, NumberOfTrys, MorePlotsFlag, InputFlags)">PostCorrectionDisplay</a>(AxesHandles, OCS0, OCS, Smat, S, U, V, iloop, NumberOfTrys, MorePlotsFlag, InputFlags);
1023     <span class="keyword">end</span>
1024 
1025     <span class="comment">% Update timestamp</span>
1026     <span class="keyword">if</span> OCS.Display &amp;&amp; isfield(OCS,<span class="string">'Handles'</span>) &amp;&amp; isfield(OCS.Handles, <span class="string">'TimeStamp'</span>) &amp;&amp; ~isempty(OCS.Handles.TimeStamp)
1027         set(OCS.Handles.TimeStamp, <span class="string">'String'</span>, datestr(clock,0));
1028         drawnow;
1029     <span class="keyword">end</span>
1030     
1031     
1032     <span class="keyword">if</span> iloop ~= NumberOfTrys
1033         <span class="comment">% Check if another application is trying to change a setting</span>
1034         [StopFlag, OCS, Smat, S, U, V, AxesHandles, MorePlotsFlag] = <a href="#_sub1" class="code" title="subfunction [StopFlag, OCS, Smat, S, U, V, FigureHandles, MorePlotsFlag] = answersetorbitcall(OCS, Smat, S, U, V, FigureHandles, InputFlags)">answersetorbitcall</a>(OCS, Smat, S, U, V, AxesHandles, InputFlags);
1035         <span class="keyword">if</span> StopFlag
1036             <span class="keyword">break</span>;
1037         <span class="keyword">end</span>
1038 
1039 
1040         <span class="comment">% Check beam current (this might be machine dependent)</span>
1041         <span class="keyword">if</span> <a href="getdcct.html" class="code" title="function [DCCT, tout, DataTime, ErrorFlag] = getdcct(varargin)">getdcct</a> &lt; DCCTLOW
1042             fprintf(<span class="string">'   Orbit correction stopped on iteration %d.   Beam current is below .05 milliampere!\n'</span>, iloop);
1043             <span class="keyword">break</span>;
1044         <span class="keyword">end</span>
1045 
1046         
1047         <span class="comment">% Set the minimum update period</span>
1048         <span class="keyword">while</span> toc &lt; OCS.MinimumPeriod
1049             <span class="keyword">if</span> (OCS.MinimumPeriod-toc) &gt; .3
1050                 sleep(.3);
1051             <span class="keyword">else</span>
1052                 sleep(OCS.MinimumPeriod - toc);
1053             <span class="keyword">end</span>
1054 
1055             <span class="comment">% Check for a stop request or change to the minimum update period</span>
1056             [StopFlag, OCS, Smat, S, U, V, AxesHandles, MorePlotsFlag] = <a href="#_sub1" class="code" title="subfunction [StopFlag, OCS, Smat, S, U, V, FigureHandles, MorePlotsFlag] = answersetorbitcall(OCS, Smat, S, U, V, FigureHandles, InputFlags)">answersetorbitcall</a>(OCS, Smat, S, U, V, AxesHandles, InputFlags);
1057             <span class="keyword">if</span> StopFlag
1058                 <span class="keyword">break</span>;
1059             <span class="keyword">end</span>
1060         <span class="keyword">end</span>
1061     <span class="keyword">end</span>
1062 <span class="keyword">end</span>
1063 
1064 
1065 <span class="comment">% Orbit correction finished</span>
1066 RingSetOrbit.RunFlag = 0;
1067 setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
1068 
1069 
1070 <span class="comment">% For multiple iterations put the total change in the .Delta &amp; .DeltaRF fields</span>
1071 <span class="keyword">for</span> i = 1:length(OCS.CM)
1072     OCS.CM{i}.Delta = OCS.CM{i}.Data - OCS0.CM{i}.Data;
1073 <span class="keyword">end</span>
1074 <span class="keyword">if</span> OCS.FitRF
1075     OCS.DeltaRF = OCS.RF.Data - OCS0.RF.Data;
1076 <span class="keyword">end</span>
1077 
1078 
1079 <span class="comment">% Remove the cell array if the input was not a cell</span>
1080 <span class="keyword">if</span> NoCellBPMFlag
1081     OCS.BPM = OCS.BPM{1};
1082     OCS0.BPM = OCS0.BPM{1};
1083 
1084     OCS.GoalOrbit = OCS.GoalOrbit{1};
1085     OCS0.GoalOrbit = OCS0.GoalOrbit{1};
1086 
1087     OCS.BPMWeight = OCS.BPMWeight{1};
1088     OCS0.BPMWeight = OCS0.BPMWeight{1};
1089 <span class="keyword">end</span>
1090 <span class="keyword">if</span> NoCellCMFlag
1091     OCS.CM = OCS.CM{1};
1092     OCS0.CM = OCS0.CM{1};
1093     
1094     <span class="keyword">if</span> isfield(OCS, <span class="string">'CMWeight'</span>)
1095         OCS.CMWeight = OCS.CMWeight{1};
1096         OCS0.CMWeight = OCS0.CMWeight{1};
1097     <span class="keyword">end</span>
1098 <span class="keyword">end</span>
1099 
1100 
1101 <span class="comment">% if OCS.Display</span>
1102 <span class="comment">%     fprintf('   Orbit correction complete (%s)\n', datestr(clock, 0));</span>
1103 <span class="comment">% end</span>
1104 
1105 
1106 <span class="comment">%%%%%%%%%%%%%%%%%%%</span>
1107 <span class="comment">% End of Setorbit %</span>
1108 <span class="comment">%%%%%%%%%%%%%%%%%%%</span>
1109 
1110 
1111 
1112 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1113 <span class="comment">% Ring/Answer Subroutine %</span>
1114 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1115 <a name="_sub1" href="#_subfunctions" class="code">function [StopFlag, OCS, Smat, S, U, V, FigureHandles, MorePlotsFlag] = answersetorbitcall(OCS, Smat, S, U, V, FigureHandles, InputFlags)</a>
1116 
1117 StopFlag = 0;
1118 MorePlotsFlag = 0;
1119 RingSetOrbit = getappdata(0, <span class="string">'RingSetOrbit'</span>);
1120 
1121 <span class="keyword">if</span> ~isempty(RingSetOrbit)
1122 
1123     <span class="keyword">if</span> isfield(RingSetOrbit, <span class="string">'RunFlag'</span>)
1124         <span class="keyword">if</span> RingSetOrbit.RunFlag == -1
1125             StopFlag = 1;
1126         <span class="keyword">end</span>
1127         <span class="comment">%RingSetOrbit = rmfield(RingSetOrbit, 'RunFlag');</span>
1128         <span class="comment">%setappdata(0, 'RingSetOrbit', RingSetOrbit);</span>
1129     <span class="keyword">end</span>
1130 
1131     <span class="keyword">if</span> isfield(RingSetOrbit, <span class="string">'MinimumPeriod'</span>)
1132         OCS.MinimumPeriod = RingSetOrbit.MinimumPeriod;
1133         <span class="keyword">if</span> isempty(OCS.MinimumPeriod)
1134             OCS.MinimumPeriod = 0;
1135         <span class="keyword">end</span>
1136         RingSetOrbit = rmfield(RingSetOrbit, <span class="string">'MinimumPeriod'</span>);
1137         setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
1138     <span class="keyword">end</span>
1139 
1140     <span class="keyword">if</span> isfield(RingSetOrbit, <span class="string">'Display'</span>)
1141         OCS.Display = RingSetOrbit.Display;
1142         RingSetOrbit = rmfield(RingSetOrbit, <span class="string">'Display'</span>);
1143         setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
1144     <span class="keyword">end</span>
1145 
1146     <span class="keyword">if</span> isfield(RingSetOrbit, <span class="string">'CorrectorGain'</span>)
1147         OCS.CorrectorGain = RingSetOrbit.CorrectorGain;
1148         RingSetOrbit = rmfield(RingSetOrbit, <span class="string">'CorrectorGain'</span>);
1149         setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
1150     <span class="keyword">end</span>
1151 
1152     <span class="keyword">if</span> isfield(RingSetOrbit, <span class="string">'FigureHandles'</span>)
1153         FigureHandles = RingSetOrbit.FigureHandles;
1154         RingSetOrbit = rmfield(RingSetOrbit, <span class="string">'FigureHandles'</span>);
1155         setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
1156 
1157         <span class="keyword">if</span> length(FigureHandles) == 6
1158             <a href="#_sub3" class="code" title="subfunction drawmoreplots(Haxis, OCS, Smat, S, U, V)">drawmoreplots</a>(FigureHandles(4:6), OCS, Smat, S, U, V);
1159             <span class="comment">%MorePlotsFlag = 1;</span>
1160         <span class="keyword">end</span>
1161     <span class="keyword">end</span>
1162 
1163 
1164     <span class="keyword">if</span> isfield(RingSetOrbit, <span class="string">'FitRF'</span>)
1165         OCS.FitRF = RingSetOrbit.FitRF;
1166         RingSetOrbit = rmfield(RingSetOrbit, <span class="string">'FitRF'</span>);
1167         setappdata(0, <span class="string">'RingSetOrbit'</span>, RingSetOrbit);
1168         
1169         <span class="keyword">if</span> OCS.FitRF == 1
1170             <span class="comment">% Include the RF frequency next time</span>
1171             OCS.RF = <a href="getrf.html" class="code" title="function [RFsp, RFam, DataTime, ErrorFlag] = getrf(varargin)">getrf</a>(<span class="string">'Struct'</span>, InputFlags{:});
1172             [OCS, Smat, S, U, V] = <a href="orbitcorrectionmethods.html" class="code" title="function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)">orbitcorrectionmethods</a>(OCS);  <span class="comment">% Get new S, U, V matrices</span>
1173         <span class="keyword">else</span>
1174             <span class="comment">% Don't include the RF frequency next time</span>
1175             OCS.FitRF = 0;
1176             [OCS, Smat, S, U, V] = <a href="orbitcorrectionmethods.html" class="code" title="function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)">orbitcorrectionmethods</a>(OCS);  <span class="comment">% Get new S, U, V matrices</span>
1177         <span class="keyword">end</span>
1178     <span class="keyword">end</span>
1179     
1180 <span class="keyword">end</span>
1181 
1182 
1183 
1184 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1185 <span class="comment">%  Pre-correction display %</span>
1186 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1187 <a name="_sub2" href="#_subfunctions" class="code">function [H, Haxis, OCS] = PreCorrectionDisplay(H, OCS0, OCS, Smat, S, U, V, NumberOfTrys, MorePlotsFlag, InputFlags)</a>
1188 
1189 <span class="comment">% Build the orbit vector</span>
1190 StartOrbitVec = [];
1191 Orbit0Vec = [];
1192 GoalOrbitVec = [];
1193 BPMWeight = [];
1194 <span class="keyword">for</span> i = 1:length(OCS.BPM)
1195     StartOrbitVec = [StartOrbitVec; OCS.BPM{i}.Data];
1196     Orbit0Vec     = [Orbit0Vec;     OCS.BPM{i}.Data];
1197     GoalOrbitVec  = [GoalOrbitVec;  OCS.GoalOrbit{i}];
1198 
1199     <span class="keyword">if</span> isempty(OCS.BPMWeight{i})
1200         BPMWeight = [BPMWeight; ones(length(OCS.BPM{i}.Data),1)];
1201     <span class="keyword">else</span>
1202         BPMWeight = [BPMWeight; OCS.BPMWeight{i}(:)];
1203     <span class="keyword">end</span>
1204 <span class="keyword">end</span>
1205 
1206 <span class="comment">% Plot some stuff</span>
1207 L = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Circumference'</span>);
1208 <span class="keyword">if</span> isempty(L)
1209     <span class="keyword">global</span> THERING
1210     L = findspos(THERING, length(THERING)+1);
1211 <span class="keyword">end</span>
1212 
1213 
1214 <span class="keyword">if</span> isempty(H)
1215     HCF = get(0, <span class="string">'CurrentFigure'</span>);
1216     <span class="keyword">if</span> isempty(HCF)
1217         H = [gcf; NaN];
1218     <span class="keyword">else</span>
1219         <span class="keyword">if</span> rem(HCF,1)==0
1220             H = [HCF(1); NaN];
1221         <span class="keyword">else</span>
1222             H = [figure; NaN];
1223         <span class="keyword">end</span>
1224     <span class="keyword">end</span>
1225     <span class="comment">%drawnow</span>
1226     subfig(2,2,2, H(1));
1227     p = get(H(1), <span class="string">'Position'</span>);
1228     set(H(1), <span class="string">'Position'</span>, [p(1) p(2)-.8*p(4) p(3) p(4)+.8*p(4)]);
1229 <span class="keyword">end</span>
1230 
1231 
1232 <span class="keyword">if</span> length(H) &lt; 3
1233     figure(H(1));
1234     clf reset
1235     Haxis(1) = subplot(3,1,1);
1236     Haxis(2) = subplot(3,1,2);
1237     Haxis(3) = subplot(3,1,3);
1238     yaxesposition(1.05);
1239     orient portrait
1240 <span class="keyword">else</span>
1241     Haxis = H;
1242 <span class="keyword">end</span>
1243 
1244 
1245 ColorOrderMat = get(gca,<span class="string">'ColorOrder'</span>);
1246 
1247 
1248 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
1249 <span class="comment">% Change in corrector %</span>
1250 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
1251 axes(Haxis(1));
1252 <span class="keyword">for</span> i4 = 1:length(OCS.CM)
1253     CMpos = <a href="getspos.html" class="code" title="function S = getspos(Family, DeviceList)">getspos</a>(OCS.CM{i4});
1254     [CMpos,isort] = sort(CMpos);
1255 
1256     <span class="comment">% Percentage from max</span>
1257     <span class="comment">%CMmax = maxsp(OCS.CM{i4});</span>
1258     <span class="comment">%plot(CMpos, 100*OCS.CM{i4}.Delta./CMmax, '.-','Color', ColorOrderMat(mod(i4,size(ColorOrderMat,1)),:));</span>
1259     <span class="comment">%%plot(CMpos, 100*OCS.CM{i4}.Delta./CMmax,'-square','Color', ColorOrderMat(mod(i4,size(ColorOrderMat,1)),:), 'Markersize',3, 'MarkerFaceColor', ColorOrderMat(mod(i4,size(ColorOrderMat,1)),:));</span>
1260     <span class="comment">%LabelCell4{i4} = sprintf('%s', OCS.CM{i4}.FamilyName);</span>
1261 
1262     <span class="comment">% Absolute corrector change</span>
1263     plot(CMpos, OCS.CM{i4}.Delta(isort), <span class="string">'.-'</span>,<span class="string">'Color'</span>, ColorOrderMat(mod(i4,size(ColorOrderMat,1)),:));
1264     LabelCell4{i4} = sprintf(<span class="string">'%s [%s]'</span>, OCS.CM{i4}.FamilyName, OCS.CM{i4}.UnitsString);
1265     hold on;
1266 <span class="keyword">end</span>
1267 hold off;
1268 <span class="keyword">if</span> length(OCS.CM) == 1
1269     <span class="comment">%ylabel(sprintf('{\\Delta}%s [%%Max]', OCS.CM{1}.FamilyName));</span>
1270     ylabel(sprintf(<span class="string">'\\Delta %s [%s]'</span>, OCS.CM{1}.FamilyName, OCS.CM{1}.UnitsString));
1271 <span class="keyword">else</span>
1272     <span class="comment">%ylabel('\Delta Corrector [%Max]');</span>
1273     ylabel(<span class="string">'\Delta Corrector'</span>);
1274     h_legend = legend(LabelCell4, 0);
1275     set(h_legend, <span class="string">'UserData'</span>, <span class="string">'Axes1'</span>);
1276 <span class="keyword">end</span>
1277 
1278 <span class="comment">%if NumberOfTrys == 1</span>
1279 <span class="keyword">if</span> OCS.FitRF
1280     title({sprintf(<span class="string">'\\DeltaRF = %g %s   SV[%d out of %d]'</span>, OCS.DeltaRF, OCS.RF.UnitsString, max(OCS.SVDIndex), length(S)), <span class="string">'Pre-Orbit Correction'</span>});
1281 <span class="keyword">else</span>
1282     title({sprintf(<span class="string">'SV[%d out of %d]'</span>, max(OCS.SVDIndex), length(S)), <span class="string">'Pre-Orbit Correction'</span>});
1283 <span class="keyword">end</span>
1284 
1285 <span class="comment">%xlabel('Position [Meters]');</span>
1286 xaxis([0 L]);
1287 <span class="comment">%set(gca,'XTickLabel','');</span>
1288 
1289 
1290 
1291 <span class="comment">%%%%%%%%%%%%%%%%%%%%</span>
1292 <span class="comment">% Plot Orbit Error %</span>
1293 <span class="comment">%%%%%%%%%%%%%%%%%%%%</span>
1294 axes(Haxis(2));
1295 <span class="keyword">for</span> i = 1:length(OCS.BPM)
1296     BPMpos = <a href="getspos.html" class="code" title="function S = getspos(Family, DeviceList)">getspos</a>(OCS.BPM{i});
1297     [BPMpos, isort] = sort(BPMpos);
1298     plot(BPMpos, OCS.BPM{i}.Data(isort) - OCS.GoalOrbit{i}(isort),<span class="string">'.-'</span>,<span class="string">'Color'</span>, ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));
1299     hold on;
1300     LabelCell2{i} = sprintf(<span class="string">'%s [%s]'</span>, OCS.BPM{i}.FamilyName, OCS.BPM{i}.UnitsString);
1301 <span class="keyword">end</span>
1302 hold off
1303 <span class="keyword">if</span> length(LabelCell2) == 1
1304     ylabel(sprintf(<span class="string">'%s Starting Error [%s]'</span>, OCS.BPM{1}.FamilyName, OCS.BPM{1}.UnitsString));
1305 <span class="keyword">else</span>
1306     ylabel(<span class="string">'Starting Orbit Error'</span>);
1307     h_legend = legend(LabelCell2, 0);
1308     set(h_legend, <span class="string">'UserData'</span>, <span class="string">'Axes2'</span>);
1309 <span class="keyword">end</span>
1310 <span class="comment">%title(sprintf('Orbit Error Before Correction (Iteration 1 of %d)', NumberOfTrys));</span>
1311 <span class="comment">%xlabel('Position [Meters]');</span>
1312 xaxis([0 L]);
1313 <span class="comment">%set(gca,'XTickLabel','');</span>
1314 
1315 
1316 
1317 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%</span>
1318 <span class="comment">% Predicted Residual %</span>
1319 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%</span>
1320 axes(Haxis(3));
1321 
1322 <span class="keyword">for</span> i = 1:length(OCS.BPM)
1323     BPMpos = <a href="getspos.html" class="code" title="function S = getspos(Family, DeviceList)">getspos</a>(OCS.BPM{i});
1324     [BPMpos, isort] = sort(BPMpos);
1325 
1326     <span class="comment">% S-mat prediction: OrbitDelta + Error</span>
1327     plot(BPMpos, OCS.BPM{i}.PredictedOrbitDelta(isort) + (OCS.BPM{i}.Data(isort)-OCS.GoalOrbit{i}(isort)),<span class="string">'.-'</span>,<span class="string">'Color'</span>, ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));
1328     hold on;
1329     LabelCell2{i} = sprintf(<span class="string">'%s [%s]'</span>, OCS.BPM{i}.FamilyName, OCS.BPM{i}.UnitsString);
1330 <span class="keyword">end</span>
1331 hold off
1332 <span class="keyword">if</span> length(LabelCell2) == 1
1333     ylabel(sprintf(<span class="string">'%s Residual [%s]'</span>, OCS.BPM{1}.FamilyName, OCS.BPM{1}.UnitsString));
1334 <span class="keyword">else</span>
1335     ylabel(<span class="string">'Orbit Residual'</span>);
1336     h_legend = legend(LabelCell2, 0);
1337     set(h_legend, <span class="string">'UserData'</span>, <span class="string">'Axes3'</span>);
1338 <span class="keyword">end</span>
1339 <span class="comment">%title('Predicted Orbit Residual (by the Response Matrix)');</span>
1340 xlabel(<span class="string">'Position [Meters]'</span>);
1341 xaxis([0 L]);
1342 
1343 
1344 <span class="comment">% Add TimeStamp labels</span>
1345 <span class="keyword">if</span> length(H) &lt; 3
1346     OCS.Handles.TimeStamp = addlabel(1, 0, datestr(OCS.BPM{1}.TimeStamp,0));
1347 
1348     <span class="comment">%if OCS.FitRF</span>
1349     <span class="comment">%    OCS.Handles.RF = addlabel(0, 0, sprintf('RF frequency will be changed by  %g %s', OCS.DeltaRF, OCS.RF.UnitsString));</span>
1350     <span class="comment">%end</span>
1351 <span class="keyword">end</span>
1352 
1353 
1354 
1355 
1356 <span class="keyword">if</span> MorePlotsFlag || length(H)==6
1357 
1358     <span class="comment">%%%%%%%%%%%%%%%%</span>
1359     <span class="comment">% 3 More Plots %</span>
1360     <span class="comment">%%%%%%%%%%%%%%%%</span>
1361 
1362     <span class="keyword">if</span> length(H) &lt; 3
1363         <span class="keyword">if</span> isnan(H(2))
1364             H(2) = H(1) + 1;
1365             subfig(2,2,1,H(2));
1366             p = get(H(2), <span class="string">'Position'</span>);
1367             set(H(2), <span class="string">'Position'</span>, [p(1) p(2)-.8*p(4) p(3) p(4)+.8*p(4)]);
1368             p = get(H(2), <span class="string">'Position'</span>);
1369             set(H(2), <span class="string">'Position'</span>, [p(1)+.2*p(3) p(2) p(3)-.1*p(3) p(4)]);
1370 
1371             p = get(H(1), <span class="string">'Position'</span>);
1372             set(H(1), <span class="string">'Position'</span>, [p(1)+.1*p(3) p(2) p(3)-.1*p(3) p(4)]);
1373         <span class="keyword">end</span>
1374 
1375         figure(H(2));
1376         clf reset
1377 
1378         Haxis(4) = subplot(3,1,1);
1379         Haxis(5) = subplot(3,1,2);
1380         Haxis(6) = subplot(3,1,3);
1381         yaxesposition(1.05);
1382         orient portrait
1383     <span class="keyword">end</span>
1384 
1385     <a href="#_sub3" class="code" title="subfunction drawmoreplots(Haxis, OCS, Smat, S, U, V)">drawmoreplots</a>(Haxis(4:6), OCS, Smat, S, U, V);
1386 <span class="keyword">end</span>
1387 
1388 drawnow;
1389 
1390 
1391 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1392 <span class="comment">%  End pre-correction display  %</span>
1393 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1394 
1395 
1396 
1397 
1398 <a name="_sub3" href="#_subfunctions" class="code">function drawmoreplots(Haxis, OCS, Smat, S, U, V)</a>
1399 
1400 
1401 <span class="comment">%%%%%%%%%%%%%%%%</span>
1402 <span class="comment">% 3 More Plots %</span>
1403 <span class="comment">%%%%%%%%%%%%%%%%</span>
1404 
1405 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1406 <span class="comment">% Compute Orbit Error &amp; CM strength vs SVD Number %</span>
1407 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1408 
1409 <span class="comment">% Print wait messege</span>
1410 <span class="comment">%plot([0 1],[0 1],'w');</span>
1411 <span class="comment">%UnitsString = get(gca,'units');</span>
1412 <span class="comment">%set(gca,'units','characters');</span>
1413 <span class="comment">%p = get(gca,'Position');</span>
1414 <span class="comment">%set(gca,'XTick',[]); set(gca,'YTick',[]); cla; title(' '); xlabel(' '); ylabel(' ');</span>
1415 <span class="comment">%set(gca,'box','on');</span>
1416 <span class="comment">%Top = floor(p(4));</span>
1417 <span class="comment">%</span>
1418 <span class="comment">%text(4,Top-4,sprintf('Please wait ...'),'units','characters');</span>
1419 <span class="comment">%text(4,Top-6,sprintf('Computing correction performance'),'units','characters');</span>
1420 <span class="comment">%text(4,Top-7,sprintf('   as a function of singular value number.'),'units','characters');</span>
1421 <span class="comment">%set(gca, 'units', UnitsString);</span>
1422 <span class="comment">%drawnow;</span>
1423 
1424 
1425 <span class="comment">% The total kick as a function of SV</span>
1426 hbar = waitbar(0, <span class="string">'Computing Orbit Change vs SVD#.  Please wait ...'</span>);
1427 warning off;
1428 LastGoodSvalue = 1;
1429 OCStmp = OCS;
1430 N = length(S);
1431 <span class="keyword">for</span> i = 1:N
1432     lastwarn(<span class="string">''</span>);
1433     waitbar(i/N);
1434 
1435     OCStmp.SVDIndex = 1:i;
1436     OCStmp = <a href="orbitcorrectionmethods.html" class="code" title="function [OCS, SmatNoWeights, S, U, V] = orbitcorrectionmethods(OCS, Smat, S, U, V)">orbitcorrectionmethods</a>(OCStmp, Smat, S, U, V);
1437 
1438 
1439     <span class="comment">% RMS orbit change of the corrector magnets</span>
1440     <span class="keyword">for</span> j = 1:length(OCS.CM)
1441         <span class="keyword">if</span> isempty(lastwarn)
1442             CMSTDvec{j}(i) = std(OCStmp.CM{j}.Delta);
1443             CMTotal(j,i) = sum(abs(OCStmp.CM{j}.Delta));
1444         <span class="keyword">else</span>
1445             CMSTDvec{j}(i) = NaN;
1446             CMTotal(j,i) = NaN;
1447         <span class="keyword">end</span>
1448 
1449 
1450         <span class="comment">% S-mat prediction residual: PredictedOrbitData + Error</span>
1451         BPMresidual(j,i) = std(OCStmp.BPM{j}.PredictedOrbitDelta + (OCStmp.BPM{j}.Data-OCStmp.GoalOrbit{j}));
1452     <span class="keyword">end</span>
1453 
1454     <span class="keyword">if</span> isempty(lastwarn)
1455         LastGoodSvalue = i;
1456         DeltaRFvec(i,1) = OCStmp.DeltaRF;
1457     <span class="keyword">else</span>
1458         DeltaRFvec(i,1) = NaN;
1459         <span class="comment">%fprintf('\n   S-value number %d warning: %s', i, lastwarn);</span>
1460     <span class="keyword">end</span>
1461 <span class="keyword">end</span>
1462 <span class="keyword">try</span>
1463     close(hbar);
1464 <span class="keyword">catch</span>
1465 <span class="keyword">end</span>
1466 
1467 
1468 warning on;
1469 <span class="keyword">if</span> LastGoodSvalue ~= length(S)
1470     fprintf(<span class="string">'   Computational warning for choosing singular values above %d. \n'</span>, LastGoodSvalue);
1471 <span class="keyword">end</span>
1472 
1473 
1474 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1475 <span class="comment">% CM strength vs SVD number %</span>
1476 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1477 iSVDremove = 1:length(S);
1478 [tmp1, tmp2, i] = intersect(OCS.SVDIndex, iSVDremove);
1479 iSVDremove(i) = [];
1480 
1481 <span class="keyword">for</span> i = 1:length(OCS.CM)
1482     LabelCellCM{i} = sprintf(<span class="string">'%s [%s]'</span>, OCS.CM{i}.FamilyName, OCS.CM{i}.UnitsString);
1483 <span class="keyword">end</span>
1484 <span class="keyword">if</span> OCS.FitRF
1485     <span class="comment">%(Haxis(1));</span>
1486     [ax, h1, h2] = plotyy(Haxis(1), 1:length(S), CMTotal, 1:length(S), DeltaRFvec, @plot, @plot);
1487     set(get(ax(2),<span class="string">'Ylabel'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'\\DeltaRF Frequency [%s]'</span>, OCS.RF.UnitsString), <span class="string">'Color'</span>,[.5 0 0]);
1488     set(h1,<span class="string">'LineStyle'</span>,<span class="string">'-'</span>);
1489     set(h1,<span class="string">'Marker'</span>,<span class="string">'.'</span>);
1490     set(h1,<span class="string">'MarkerSize'</span>,6);
1491     set(h2,<span class="string">'LineStyle'</span>,<span class="string">'-'</span>);
1492     set(h2,<span class="string">'Color'</span>,[.5 0 0]);
1493     set(ax(2),<span class="string">'YColor'</span>,[.5 0 0]);
1494     set(h2,<span class="string">'Marker'</span>,<span class="string">'.'</span>);
1495     set(h2,<span class="string">'MarkerSize'</span>,6);
1496     <span class="comment">%set(get(ax(1),'XLabel'),'String', 'Singular Value Number');</span>
1497     <span class="comment">%set(get(ax(1),'Title'), 'String', 'Total Kick Strength');</span>
1498 
1499     set(ax(1),<span class="string">'XLim'</span>, [0 length(S)]);
1500     set(ax(2),<span class="string">'XLim'</span>, [0 length(S)]);
1501 
1502     set(get(ax(1),<span class="string">'XLabel'</span>),<span class="string">'String'</span>, <span class="string">''</span>);
1503     set(get(ax(2),<span class="string">'XLabel'</span>),<span class="string">'String'</span>, <span class="string">''</span>);
1504     <span class="comment">%set(ax(1),'XTickLabel', '');</span>
1505     <span class="comment">%set(ax(2),'XTickLabel', '');</span>
1506 
1507     set(get(ax(1),<span class="string">'title'</span>),<span class="string">'string'</span>, {<span class="string">'Performance vs. Number of Singular Values'</span>,sprintf(<span class="string">'Based on %s Orbit'</span>,datestr(OCS.BPM{1}.TimeStamp,0))});
1508 
1509     <span class="keyword">if</span> length(LabelCellCM) == 1
1510         set(get(ax(1),<span class="string">'YLabel'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'\\Sigma \\mid%s\\mid [%s]'</span>, OCS.CM{1}.FamilyName, OCS.CM{1}.UnitsString));
1511     <span class="keyword">else</span>
1512         set(get(ax(1),<span class="string">'YLabel'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'\\Sigma \\midCM\\mid'</span>));
1513         <span class="comment">%h_legend = legend(Haxis(1), LabelCellCM, 0);</span>
1514         <span class="comment">%set(h_legend, 'UserData', 'Axes4');</span>
1515         AxePosition = get(ax(2),<span class="string">'Position'</span>);
1516         set(ax(1),<span class="string">'Position'</span>, AxePosition);
1517     <span class="keyword">end</span>
1518 <span class="keyword">else</span>
1519     <span class="comment">%semilogy(1:length(S), CMTotal, '.-');</span>
1520     plot(Haxis(1), 1:length(S), CMTotal, <span class="string">'-'</span>);
1521     hold(Haxis(1), <span class="string">'on'</span>);
1522     plot(Haxis(1), OCS.SVDIndex, CMTotal(:,OCS.SVDIndex), <span class="string">'s'</span>, <span class="string">'markersize'</span>,2);
1523     plot(Haxis(1), iSVDremove,   CMTotal(:,iSVDremove),   <span class="string">'sr'</span>,<span class="string">'markersize'</span>,2);
1524     hold(Haxis(1), <span class="string">'off'</span>);
1525 
1526     <span class="keyword">if</span> length(LabelCellCM) == 1
1527         ylabel(Haxis(1), sprintf(<span class="string">'\\Sigma \\mid%s\\mid [%s]'</span>, OCS.CM{1}.FamilyName, OCS.CM{1}.UnitsString));
1528     <span class="keyword">else</span>
1529         ylabel(Haxis(1), <span class="string">'\Sigma \midCM\mid'</span>);
1530         <span class="comment">%h_legend = legend(Haxis(1), LabelCellCM, 0);</span>
1531         <span class="comment">%set(h_legend, 'UserData', 'Axes4');</span>
1532     <span class="keyword">end</span>
1533     <span class="comment">%xlabel(Haxis(1), 'Singular Value Number');</span>
1534     title(Haxis(1), {<span class="string">'Performance vs. Number of Singular Values'</span>,sprintf(<span class="string">'Based on %s Orbit'</span>,datestr(OCS.BPM{1}.TimeStamp,0))});
1535     
1536     axis(Haxis(1), <span class="string">'tight'</span>);
1537     a = axis(Haxis(1));
1538     axis(Haxis(1), [0 length(S) a(3:4)]);
1539     <span class="comment">%set(gca,'XTickLabel','');</span>
1540 <span class="keyword">end</span>
1541 
1542 
1543 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1544 <span class="comment">% Plot Orbit Error vs SVD Number %</span>
1545 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1546 <span class="comment">%axes(Haxis(2));</span>
1547 ColorOrderMat = get(Haxis(2),<span class="string">'ColorOrder'</span>);
1548 <span class="keyword">for</span> i = 1:length(OCS.BPM)
1549     <span class="comment">%BPMpos = getspos(OCS.BPM{i});</span>
1550     <span class="comment">%semilogy(1:length(S), CMSTDvec{i},'.-','Color', ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));</span>
1551     plot(Haxis(2), 1:length(S), BPMresidual(i,:),<span class="string">'-'</span>, <span class="string">'Color'</span>, ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));
1552     hold(Haxis(2), <span class="string">'on'</span>);
1553     plot(Haxis(2), OCS.SVDIndex, BPMresidual(i,OCS.SVDIndex), <span class="string">'s'</span>, <span class="string">'markersize'</span>,2, <span class="string">'Color'</span>, ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));
1554     plot(Haxis(2), iSVDremove,   BPMresidual(i,iSVDremove),   <span class="string">'sr'</span>,<span class="string">'markersize'</span>,2);
1555    
1556     LabelCell2{i} = sprintf(<span class="string">'%s [%s]'</span>, OCS.BPM{i}.FamilyName, OCS.BPM{i}.UnitsString);
1557 <span class="keyword">end</span>
1558 hold(Haxis(2), <span class="string">'off'</span>);
1559 <span class="keyword">if</span> length(LabelCell2) == 1
1560     ylabel(Haxis(2), sprintf(<span class="string">'STD %s [%s]'</span>, OCS.BPM{1}.FamilyName, OCS.BPM{1}.UnitsString));
1561 <span class="keyword">else</span>
1562     ylabel(Haxis(2), <span class="string">'std(Residual)'</span>);
1563     <span class="comment">%h_legend = legend(Haxis(2), LabelCell2, 0);</span>
1564     <span class="comment">%set(h_legend, 'UserData', 'Axes5');</span>
1565 <span class="keyword">end</span>
1566 <span class="comment">%title(Haxis(2), 'Standard Deviation of the Predicted Orbit Residual');</span>
1567 <span class="comment">%xlabel(Haxis(2), 'Singular Value Number');</span>
1568 
1569 axis(Haxis(2), <span class="string">'tight'</span>);
1570 a = axis(Haxis(2));
1571 axis(Haxis(2), [0 length(S) a(3:4)]);
1572 <span class="comment">%set(gca,'XTickLabel','');</span>
1573 
1574 
1575 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%</span>
1576 <span class="comment">% Plot singular values %</span>
1577 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%</span>
1578 axes(Haxis(3));
1579 semilogy(Haxis(3), S, <span class="string">'-b'</span>);
1580 hold(Haxis(3), <span class="string">'on'</span>);
1581 semilogy(Haxis(3), OCS.SVDIndex, S(OCS.SVDIndex), <span class="string">'sb'</span>, <span class="string">'markersize'</span>,2);
1582 semilogy(Haxis(3), iSVDremove,   S(iSVDremove),   <span class="string">'sr'</span>, <span class="string">'markersize'</span>,2);
1583 hold(Haxis(3), <span class="string">'off'</span>);
1584 ylabel(Haxis(3), <span class="string">'Magnitude'</span>);
1585 xlabel(Haxis(3), <span class="string">'Singular Value Number'</span>);
1586 axis(Haxis(3), <span class="string">'tight'</span>);
1587 a = axis(Haxis(3));
1588 axis(Haxis(3), [0 length(S) a(3:4)]);
1589 
1590 drawnow;
1591 
1592 
1593 
1594 
1595 
1596 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1597 <span class="comment">%  Post-correction display  %</span>
1598 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1599 <a name="_sub4" href="#_subfunctions" class="code">function PostCorrectionDisplay(H, OCS0, OCS, Smat, S, U, V, Iteration, NumberOfTrys, MorePlotsFlag, InputFlags)</a>
1600 
1601 ColorOrderMat = get(gca,<span class="string">'ColorOrder'</span>);
1602 
1603 <span class="comment">% Build the orbit vectors</span>
1604 StartOrbitVec = [];
1605 Orbit0Vec = [];
1606 GoalOrbitVec = [];
1607 OrbitNewVec = [];
1608 <span class="comment">%BPMWeight = [];</span>
1609 <span class="keyword">for</span> i = 1:length(OCS.BPM)
1610     StartOrbitVec = [StartOrbitVec; OCS.BPM{i}.Data];
1611     Orbit0Vec     = [Orbit0Vec;     OCS.BPM{i}.Data];
1612     GoalOrbitVec  = [GoalOrbitVec;  OCS.GoalOrbit{i}];
1613 
1614     <span class="comment">%OCS.BPM{i} = getpv(OCS.BPM{i}, 'Struct', InputFlags{:});</span>
1615     OrbitNewVec = [OrbitNewVec; OCS.BPM{i}.Data];
1616 
1617     <span class="comment">%if isempty(OCS.BPMWeight{i})</span>
1618     <span class="comment">%    BPMWeight = [BPMWeight; ones(length(OCS.BPM{i}.Data),1)];</span>
1619     <span class="comment">%else</span>
1620     <span class="comment">%    BPMWeight = [BPMWeight; OCS.BPMWeight{i}(:)];</span>
1621     <span class="comment">%end</span>
1622 <span class="keyword">end</span>
1623 
1624 L = <a href="getfamilydata.html" class="code" title="function [Data, ErrorFlag] = getfamilydata(Family, Field1, Field2, DeviceList)">getfamilydata</a>(<span class="string">'Circumference'</span>);
1625 <span class="keyword">if</span> isempty(L)
1626     <span class="keyword">global</span> THERING
1627     L = findspos(THERING, length(THERING)+1);
1628 <span class="keyword">end</span>
1629 
1630 
1631 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1632 <span class="comment">% Plot cumulative change in the corrector %</span>
1633 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1634 set(H(1), <span class="string">'YLimMode'</span>, <span class="string">'Auto'</span>);
1635 hline = get(H(1), <span class="string">'Children'</span>);
1636 <span class="keyword">for</span> i = 1:length(OCS.CM)
1637     CMpos = <a href="getspos.html" class="code" title="function S = getspos(Family, DeviceList)">getspos</a>(OCS.CM{i});
1638     [CMpos, isort] = sort(CMpos);
1639     set(hline(end-i+1), <span class="string">'YData'</span>, OCS.CM{i}.Data(isort)-OCS0.CM{i}.Data(isort));
1640 <span class="keyword">end</span>
1641 <span class="keyword">if</span> length(OCS.CM) == 1
1642     set(get(H(1),<span class="string">'YLabel'</span>), <span class="string">'String'</span>, sprintf(<span class="string">'\\Delta %s [%s]'</span>, OCS.CM{1}.FamilyName, OCS.CM{1}.UnitsString));
1643 <span class="keyword">else</span>
1644     set(get(H(1),<span class="string">'YLabel'</span>), <span class="string">'String'</span>, <span class="string">'\Delta Corrector'</span>);
1645 <span class="keyword">end</span>
1646 
1647 DeltaRF = OCS.RF.Data - OCS0.RF.Data;
1648 <span class="keyword">if</span> NumberOfTrys == 1
1649     <span class="keyword">if</span> OCS.FitRF
1650         TitleString = {sprintf(<span class="string">'\\DeltaRF = %g %s   SV[%d out of %d]'</span>, DeltaRF, OCS.RF.UnitsString, max(OCS.SVDIndex), length(S)), <span class="string">'Post-Orbit Correction'</span>};
1651     <span class="keyword">else</span>
1652         TitleString = {sprintf(<span class="string">'SV[%d out of %d]'</span>, max(OCS.SVDIndex), length(S)), <span class="string">'Post-Orbit Correction'</span>};
1653     <span class="keyword">end</span>
1654 <span class="keyword">else</span>
1655     <span class="keyword">if</span> OCS.FitRF
1656         TitleString = {<span class="keyword">...</span>
1657             sprintf(<span class="string">'\\DeltaRF = %g %s    SV[%d out of %d]'</span>, DeltaRF, OCS.RF.UnitsString, max(OCS.SVDIndex), length(S)), <span class="keyword">...</span>
1658             sprintf(<span class="string">'Iteration %d of %d'</span>, Iteration, NumberOfTrys)};
1659     <span class="keyword">else</span>
1660         TitleString = {<span class="keyword">...</span>
1661             sprintf(<span class="string">'SV[%d out of %d]'</span>, max(OCS.SVDIndex), length(S)), <span class="keyword">...</span>
1662             sprintf(<span class="string">'Iteration %d of %d'</span>, Iteration, NumberOfTrys)};
1663     <span class="keyword">end</span>
1664 <span class="keyword">end</span>
1665 set(get(H(1),<span class="string">'Title'</span>), <span class="string">'String'</span>, TitleString);
1666 
1667 <span class="comment">%set(gca,'XTickLabel','');</span>
1668 
1669 
1670 
1671 <span class="comment">%%%%%%%%%%%%%%%%%%%%</span>
1672 <span class="comment">% Plot Orbit Error %</span>
1673 <span class="comment">%%%%%%%%%%%%%%%%%%%%</span>
1674 set(H(3), <span class="string">'YLimMode'</span>, <span class="string">'Auto'</span>);
1675 hline = get(H(3), <span class="string">'Children'</span>);
1676 <span class="keyword">for</span> i = 1:length(OCS.BPM)
1677     BPMpos = <a href="getspos.html" class="code" title="function S = getspos(Family, DeviceList)">getspos</a>(OCS.BPM{i});
1678     [BPMpos,isort] = sort(BPMpos);
1679     <span class="comment">%plot(BPMpos, OCS.BPM{i}.Data(isort)-OCS.GoalOrbit{i}(isort),'.-','Color', ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));</span>
1680     set(hline(end-i+1), <span class="string">'YData'</span>, OCS.BPM{i}.Data(isort)-OCS.GoalOrbit{i}(isort));
1681 <span class="keyword">end</span>
1682 <span class="keyword">if</span> length(OCS.BPM) == 1
1683     set(get(H(3),<span class="string">'YLabel'</span>), <span class="string">'String'</span>, sprintf(<span class="string">'%s Remaining Error [%s]'</span>, OCS.BPM{1}.FamilyName, OCS.BPM{1}.UnitsString));
1684 <span class="keyword">else</span>
1685     set(get(H(3),<span class="string">'YLabel'</span>), <span class="string">'String'</span>, <span class="string">'Remaining Orbit Error'</span>);
1686 <span class="keyword">end</span>
1687 
1688 
1689 <span class="comment">% if OCS.FitRF</span>
1690 <span class="comment">%     set(OCS.Handles.RF, 'String', sprintf(' RF frequency was changed by  %g %s', OCS.DeltaRF, OCS.RF.UnitsString));</span>
1691 <span class="comment">% end</span>
1692 
1693 
1694 drawnow;
1695 
1696 
1697 
1698 
1699 
1700 <span class="comment">% % Plot Orbit Error</span>
1701 <span class="comment">%</span>
1702 <span class="comment">% The problem here is the orbit gets updated but .PredictedOrbitDelta does not</span>
1703 <span class="comment">%</span>
1704 <span class="comment">% axes(H(3));</span>
1705 <span class="comment">%</span>
1706 <span class="comment">% ColorOrderMat = get(gca,'ColorOrder');</span>
1707 <span class="comment">% for i = 1:length(OCS.BPM)</span>
1708 <span class="comment">%     BPMpos = getspos(OCS.BPM{i});</span>
1709 <span class="comment">%     [BPMpos, isort] = sort(BPMpos);</span>
1710 <span class="comment">%</span>
1711 <span class="comment">%     % S-mat prediction: OrbitDelta + Error</span>
1712 <span class="comment">%     plot(BPMpos, OCS.BPM{i}.PredictedOrbitDelta(isort) + (OCS.BPM{i}.Data(isort)-OCS.GoalOrbit{i}(isort)),'.-','Color', ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));</span>
1713 <span class="comment">%     hold on;</span>
1714 <span class="comment">%     LabelCell2{i} = sprintf('%s [%s]', OCS.BPM{i}.FamilyName, OCS.BPM{i}.UnitsString);</span>
1715 <span class="comment">% end</span>
1716 <span class="comment">% hold off</span>
1717 <span class="comment">% if length(LabelCell2) == 1</span>
1718 <span class="comment">%     ylabel(sprintf('%s Residual [%s]', OCS.BPM{1}.FamilyName, OCS.BPM{1}.UnitsString));</span>
1719 <span class="comment">% else</span>
1720 <span class="comment">%     ylabel('Orbit Residual');</span>
1721 <span class="comment">%     h_legend = legend(LabelCell2, 0);</span>
1722 <span class="comment">% end</span>
1723 <span class="comment">% title('Predicted Orbit Residual (by the Response Matrix)');</span>
1724 <span class="comment">% xlabel('Position [Meters]');</span>
1725 <span class="comment">% xaxis([0 L]);</span>
1726 <span class="comment">% set(gca,'XTickLabel','');</span>
1727 
1728 
1729 
1730 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%</span>
1731 <span class="comment">% % Predicted Residual %</span>
1732 <span class="comment">% %%%%%%%%%%%%%%%%%%%%%%</span>
1733 <span class="comment">% if length(H) &lt; 3</span>
1734 <span class="comment">%     figure(H(1));</span>
1735 <span class="comment">%     subplot(3,1,3);</span>
1736 <span class="comment">% else</span>
1737 <span class="comment">%     axes(H(3));</span>
1738 <span class="comment">% end</span>
1739 <span class="comment">% for i = 1:length(OCS.BPM)</span>
1740 <span class="comment">%     BPMpos = getspos(OCS.BPM{i});</span>
1741 <span class="comment">%     [BPMpos, isort] = sort(BPMpos);</span>
1742 <span class="comment">%</span>
1743 <span class="comment">%     % S-mat prediction: OrbitDelta + Error</span>
1744 <span class="comment">%     plot(BPMpos, OCS.BPM{i}.PredictedOrbitDelta(isort) + (OCS.BPM{i}.Data(isort)-OCS.GoalOrbit{i}(isort)),'.-','Color', ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));</span>
1745 <span class="comment">%     hold on;</span>
1746 <span class="comment">%     LabelCell2{i} = sprintf('%s [%s]', OCS.BPM{i}.FamilyName, OCS.BPM{i}.UnitsString);</span>
1747 <span class="comment">% end</span>
1748 <span class="comment">% hold off</span>
1749 <span class="comment">% if length(LabelCell2) == 1</span>
1750 <span class="comment">%     ylabel(sprintf('%s Residual [%s]', OCS.BPM{1}.FamilyName, OCS.BPM{1}.UnitsString));</span>
1751 <span class="comment">% else</span>
1752 <span class="comment">%     ylabel('Orbit Residual');</span>
1753 <span class="comment">%     h_legend = legend(LabelCell2, 0);</span>
1754 <span class="comment">% end</span>
1755 <span class="comment">% %title('Predicted Orbit Residual (by the Response Matrix)');</span>
1756 <span class="comment">% xlabel('Position [Meters]');</span>
1757 <span class="comment">% xaxis([0 L]);</span>
1758 
1759 
1760 
1761 <span class="comment">% for i = 1:length(OCS.BPM)</span>
1762 <span class="comment">%     BPMpos = getspos(OCS.BPM{i});</span>
1763 <span class="comment">%     [BPMpos,isort] = sort(BPMpos);</span>
1764 <span class="comment">%</span>
1765 <span class="comment">%     % S-mat prediction</span>
1766 <span class="comment">%     plot(BPMpos, (OCS0.BPM{i}.Data(isort)-OCS.GoalOrbit{i}(isort)) + (OCS.BPM{i}.PredictedOrbitDelta(isort)),'.-','Color', ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));</span>
1767 <span class="comment">%     hold on;</span>
1768 <span class="comment">%     LabelCell2{i} = sprintf('%s [%s]', OCS.BPM{i}.FamilyName, OCS.BPM{i}.UnitsString);</span>
1769 <span class="comment">% end</span>
1770 <span class="comment">% hold off</span>
1771 <span class="comment">% if length(LabelCell2) == 1</span>
1772 <span class="comment">%     ylabel(sprintf('%s Residual [%s]', OCS.BPM{1}.FamilyName, OCS.BPM{1}.UnitsString));</span>
1773 <span class="comment">% else</span>
1774 <span class="comment">%     ylabel('Orbit Residual');</span>
1775 <span class="comment">%     h_legend = legend(LabelCell2, 0);</span>
1776 <span class="comment">% end</span>
1777 <span class="comment">% title('Predicted Orbit Residual (by the Response Matrix)');</span>
1778 <span class="comment">% xlabel('Position [Meters]');</span>
1779 <span class="comment">% xaxis([0 L]);</span>
1780 
1781 
1782 
1783 
1784 
1785 
1786 
1787 
1788 
1789 
1790 
1791 
1792 <span class="comment">%     %%%%%%%%%%%%%%%%%%%%%</span>
1793 <span class="comment">%     % Model predictions %</span>
1794 <span class="comment">%     %%%%%%%%%%%%%%%%%%%%%</span>
1795 <span class="comment">%     % %[Orbit0ModelX, Orbit0ModelY, Xpos, Ypos] = modeltwiss('x', 'All');</span>
1796 <span class="comment">%     % for i = 1:length(OCS.BPM)</span>
1797 <span class="comment">%     %     OCS0Model.BPM{i} = getpv(OCS.BPM{i},'Model');</span>
1798 <span class="comment">%     % end</span>
1799 <span class="comment">%     %</span>
1800 <span class="comment">%     % % Step the model</span>
1801 <span class="comment">%     % for i = 1:length(OCS.CM)</span>
1802 <span class="comment">%     %     steppv(OCS.CM{i}.FamilyName, OCS.CM{i}.Field, OCS.CM{i}.Delta, OCS.CM{i}.DeviceList, 'Model', InputFlags{:});</span>
1803 <span class="comment">%     % end</span>
1804 <span class="comment">%     % if OCS.FitRF</span>
1805 <span class="comment">%     %     stepsp('RF', OCS.DeltaRF, 'Model');</span>
1806 <span class="comment">%     % end</span>
1807 <span class="comment">%     %</span>
1808 <span class="comment">%     % %[OrbitModelX, OrbitModelY] = modeltwiss('x', 'All');</span>
1809 <span class="comment">%     % for i = 1:length(OCS.BPM)</span>
1810 <span class="comment">%     %     OCSModel.BPM{i} = getpv(OCS.BPM{i},'Model');</span>
1811 <span class="comment">%     % end</span>
1812 <span class="comment">%     %</span>
1813 <span class="comment">%     % % Step the model back</span>
1814 <span class="comment">%     % for i = 1:length(OCS.CM)</span>
1815 <span class="comment">%     %     steppv(OCS.CM{i}.FamilyName, OCS.CM{i}.Field, -1*OCS.CM{i}.Delta, OCS.CM{i}.DeviceList, 'Model', InputFlags{:});</span>
1816 <span class="comment">%     % end</span>
1817 <span class="comment">%     % if OCS.FitRF</span>
1818 <span class="comment">%     %     stepsp('RF', -OCS.DeltaRF, 'Model');</span>
1819 <span class="comment">%     % end</span>
1820 <span class="comment">%     %</span>
1821 <span class="comment">%     %</span>
1822 <span class="comment">%     % %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1823 <span class="comment">%     % % Plot Orbit Residue based on the AT model %</span>
1824 <span class="comment">%     % %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1825 <span class="comment">%     % axes(Haxis(7));</span>
1826 <span class="comment">%     % ColorOrderMat = get(gca,'ColorOrder');</span>
1827 <span class="comment">%     % for i = 1:length(OCS.BPM)</span>
1828 <span class="comment">%     %     BPMpos = getspos(OCS.BPM{i});</span>
1829 <span class="comment">%     %     [BPMpos,isort] = sort(BPMpos);</span>
1830 <span class="comment">%     %</span>
1831 <span class="comment">%     %     % Model prediction Error</span>
1832 <span class="comment">%     %     plot(BPMpos, (OCSModel.BPM{i}.Data(isort)-OCS0Model.BPM{i}.Data(isort)) - (OCS.GoalOrbit{i}(isort)-OCS.BPM{i}.Data(isort)),'.-','Color', ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));</span>
1833 <span class="comment">%     %</span>
1834 <span class="comment">%     %     % S-mat prediction</span>
1835 <span class="comment">%     %     %    plot(BPMpos, (OCS0.BPM{i}.Data-OCS.GoalOrbit{i}) + (BPMSVDDeltaCell{i}),':','Color', ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));</span>
1836 <span class="comment">%     %     hold on;</span>
1837 <span class="comment">%     %     LabelCell2{i} = sprintf('%s [%s]', OCS.BPM{i}.FamilyName, OCS.BPM{i}.UnitsString);</span>
1838 <span class="comment">%     % end</span>
1839 <span class="comment">%     % hold off</span>
1840 <span class="comment">%     % if length(LabelCell2) == 1</span>
1841 <span class="comment">%     %     ylabel(sprintf('%s Residual [%s]', OCS.BPM{1}.FamilyName, OCS.BPM{1}.UnitsString));</span>
1842 <span class="comment">%     % else</span>
1843 <span class="comment">%     %     ylabel('Orbit Residual');</span>
1844 <span class="comment">%     %     h_legend = legend(LabelCell2, 0);</span>
1845 <span class="comment">%     % end</span>
1846 <span class="comment">%     % title('Predicted Orbit Residual (by the Nonlinear AT Model)');</span>
1847 <span class="comment">%     % xlabel('Position [Meters]');</span>
1848 <span class="comment">%     % xaxis([0 L]);</span>
1849 <span class="comment">%     %</span>
1850 <span class="comment">%     %</span>
1851 <span class="comment">%     % % Linearization Error</span>
1852 <span class="comment">%     % if length(H) &lt; 4</span>
1853 <span class="comment">%     %     figure(H(2));</span>
1854 <span class="comment">%     %     subplot(4,1,4);</span>
1855 <span class="comment">%     % else</span>
1856 <span class="comment">%     %     axes(H(8));</span>
1857 <span class="comment">%     % end</span>
1858 <span class="comment">%     % ColorOrderMat = get(gca,'ColorOrder');</span>
1859 <span class="comment">%     % for i = 1:length(OCS.BPM)</span>
1860 <span class="comment">%     %     BPMpos = getspos(OCS.BPM{i});</span>
1861 <span class="comment">%     %     [BPMpos,isort] = sort(BPMpos);</span>
1862 <span class="comment">%     %</span>
1863 <span class="comment">%     %     % Model - S-matrix prediction</span>
1864 <span class="comment">%     %     plot(BPMpos, (OCSModel.BPM{i}.Data(isort)-OCS0Model.BPM{i}.Data(isort)) - OCS.BPM{i}.PredictedOrbitDelta(isort),'.-','Color', ColorOrderMat(mod(i,size(ColorOrderMat,1)),:));</span>
1865 <span class="comment">%     %     hold on;</span>
1866 <span class="comment">%     %     LabelCell2{i} = sprintf('%s [%s]', OCS.BPM{i}.FamilyName, OCS.BPM{i}.UnitsString);</span>
1867 <span class="comment">%     % end</span>
1868 <span class="comment">%     % hold off</span>
1869 <span class="comment">%     % if length(LabelCell2) == 1</span>
1870 <span class="comment">%     %     %ylabel(sprintf('%s Linearization Error [%s]', OCS.BPM{1}.FamilyName, OCS.BPM{1}.UnitsString));</span>
1871 <span class="comment">%     %     ylabel(sprintf('Linearization Error [%s]', OCS.BPM{1}.UnitsString));</span>
1872 <span class="comment">%     % else</span>
1873 <span class="comment">%     %     ylabel('Linearization Error');</span>
1874 <span class="comment">%     %     h_legend = legend(LabelCell2, 0);</span>
1875 <span class="comment">%     % end</span>
1876 <span class="comment">%     % title('Predicted Orbit Change Error (AT Model - Response Matrix)');</span>
1877 <span class="comment">%     % xlabel('Position [Meters]');</span>
1878 <span class="comment">%     % xaxis([0 L]);</span></pre></div>
<hr><address>Generated on Fri 01-Aug-2008 10:57:33 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>