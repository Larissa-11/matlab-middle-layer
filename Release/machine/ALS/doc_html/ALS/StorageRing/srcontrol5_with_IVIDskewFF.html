<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of srcontrol5_with_IVIDskewFF</title>
  <meta name="keywords" content="srcontrol5_with_IVIDskewFF">
  <meta name="description" content="srcontrol5">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">ALS</a> &gt; <a href="index.html">StorageRing</a> &gt; srcontrol5_with_IVIDskewFF.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for ALS\StorageRing&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>srcontrol5_with_IVIDskewFF
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>srcontrol5</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function srcontrol5(action, Input2, Input3) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> srcontrol5
 Storage ring control program

 This program controls all storage ring magnets, performs orbit feedback and
 tune feedforward and helps to diagnose problems in routine user operation
 of the ALS storage ring. It includes a gui to simplify the use of this
 program.

 It was originally programmed by Greg Portmann (until December 2000) with input
 from Winfried Decking, David Robin, Christoph Steier, Ying Wu and others
 and is currently (July 2002) maintained by Christoph Steier and Tom Scarvie.

 The actual version of this program is srcontrol5 (is called by default if you call srcontrol).

 Christoph Steier, July 2002

 SRCONTROL5 is the newest versionof SRCONTROL, edited to work with G. Portmann's new (2005) Matlab middle layer.

 Tom Scarvie, April 2005</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>	BEND2GEV - Compute the energy based on the ramp tables</li><li><a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>	CHECKSRMAGS - Check SR power supplies against a lattice file</li><li><a href="checksrorbit.html" class="code" title="function ErrorNums = checksrorbit(SectorList, BPMxtol,BPMytol)">checksrorbit</a>	ErrorNums =checksrorbit(Sector, BPMxtolerance [.015 mm], [BPMytolerance [.015 mm]])</li><li><a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>	GAP2TUNE - Computes the vertical tune shift for a insertion device gap change.</li><li><a href="gaplimit.html" class="code" title="function [GAPmin, GAPmax] = gaplimit(Dev);">gaplimit</a>	[GapMin, GapMax] = gaplimit(ID_Number);</li><li><a href="getbpmtimeconstant.html" class="code" title="function [BPMTimeConstant, WarningFlag] = getbpmtimeconstant(varargin)">getbpmtimeconstant</a>	GETBPMTIMECONSTANT - Sets the timeconstants for the Bergoz style BPMs.</li><li><a href="getff.html" class="code" title="function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)">getff</a>	function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)</li><li><a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>	GETID - Get the insertion device position, velocity, run flag, and user requested gap</li><li><a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>	[StateNumber, StateString] = getsrstate</li><li><a href="set_alarmhandler_AHU_thresholds_inject.html" class="code" title="function set_alarmhandler_AHU_thresholds_inject">set_alarmhandler_AHU_thresholds_inject</a>	function set_alarmhandler_AHU_thresholds_inject</li><li><a href="set_alarmhandler_thresholds.html" class="code" title="function set_alarmhandler_thresholds">set_alarmhandler_thresholds</a>	set_alarmhandler_thresholds</li><li><a href="set_alarmhandler_thresholds_new.html" class="code" title="function set_alarmhandler_thresholds_new">set_alarmhandler_thresholds_new</a>	set_alarmhandler_thresholds_new</li><li><a href="set_etaywave_nuy9_20skews_skewFF.html" class="code" title="function [SQSFincr, SQSDincr] = set_etaywave_nuy9_20skews_skewFF(scale);">set_etaywave_nuy9_20skews_skewFF</a>	function [SQSFincr, SQSDincr] = set_etaywave_nuy9_20skews_skewFF(scale);</li><li><a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>	SETBPMTIMECONSTANT - Sets the timeconstants for the Bergoz style BPMs.</li><li><a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>	SETBUMPS - Make a straight section bump</li><li><a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>	function setff(Sector, FFEnableBC, GapEnableBC)</li><li><a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>	SETID - Set the insertion device vertical gap</li><li><a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>	</li><li><a href="shift2tune.html" class="code" title="function [Dnux, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = shift2tune(Sector, Gap, EPUshift, GeV)">shift2tune</a>	SHIFT2TUNE - Computes the horizontal tune shift for a EPU gap and horizontal shift</li><li><a href="srcycle.html" class="code" title="function FailFlag = srcycle(varargin)">srcycle</a>	SRCYCLE - Storage ring cycle</li><li><a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>	SRRAMP - Ramp the storage ring energy</li><li><a href="write_goldenorbit_ffb.html" class="code" title="function write_goldenorbit_ffb">write_goldenorbit_ffb</a>	function write_goldenorbit_ffb</li><li><a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>	WRITE_GOLDENORBIT_FFTB_2PLANES - Sets the BPM setpoints which are used by the fast feedback system</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function srcontrol5(action, Input2, Input3)</a>
0002 <span class="comment">% srcontrol5</span>
0003 <span class="comment">% Storage ring control program</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% This program controls all storage ring magnets, performs orbit feedback and</span>
0006 <span class="comment">% tune feedforward and helps to diagnose problems in routine user operation</span>
0007 <span class="comment">% of the ALS storage ring. It includes a gui to simplify the use of this</span>
0008 <span class="comment">% program.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% It was originally programmed by Greg Portmann (until December 2000) with input</span>
0011 <span class="comment">% from Winfried Decking, David Robin, Christoph Steier, Ying Wu and others</span>
0012 <span class="comment">% and is currently (July 2002) maintained by Christoph Steier and Tom Scarvie.</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% The actual version of this program is srcontrol5 (is called by default if you call srcontrol).</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% Christoph Steier, July 2002</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% SRCONTROL5 is the newest versionof SRCONTROL, edited to work with G. Portmann's new (2005) Matlab middle layer.</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% Tom Scarvie, April 2005</span>
0021 
0022 <span class="comment">% known bugs/problems (May 2001):</span>
0023 <span class="comment">% - IDBPM averaging might be a bit too long for orbit feedback</span>
0024 <span class="comment">%        solved after Superbend shutdown ... Instead of averaging, digital low pass filters are used</span>
0025 <span class="comment">% - gap2tune does not give correct answers for wiggler and potentially other IDs -&gt; orbit feedback</span>
0026 <span class="comment">%        seems to be OK for other IDs, has been corrected for wiggler (fit to insertion device</span>
0027 <span class="comment">%        compensation table)</span>
0028 <span class="comment">% - chicanes do not work in orbit feedback</span>
0029 <span class="comment">%        solved. One problem was that orbit response matrizes were mis-scaled by factor of two.</span>
0030 <span class="comment">%        Second problem was different time constant of power supply control. Solved by moving controls</span>
0031 <span class="comment">%        of center chicanes to cPCI (and magnets are fast, hysteresis free, aircore coils).</span>
0032 <span class="comment">%        Center chicane in sector 4 is now routinely used in orbit feedback. Sector 11 to follow soon.</span>
0033 <span class="comment">% - zero reading of ID gap dumps beam</span>
0034 <span class="comment">%        solved in srcontrol5, still a problem in srcontrol5_hightune (but that routine has to be completely</span>
0035 <span class="comment">%        rewritten because of all recent changes to srcontrol5, anyhow). For gap readings below the minimum</span>
0036 <span class="comment">%        allowed gap for a device, the tune feedforward disables itself.</span>
0037 <span class="comment">% - cycling of lattice causes frequent power supply failures</span>
0038 <span class="comment">%        solved by changing the cycling procedure. 1.5 GeV operation is now on the upper hysteresis branch</span>
0039 <span class="comment">%        as was the 1.9 GeV injection lattice before.</span>
0040 <span class="comment">% - frequently stalled data in IDBPM readout</span>
0041 <span class="comment">%        solved with new BPM readouts and digital filtering. Seems to have been a resolution problem</span>
0042 <span class="comment">%        of the digital averaging algorithm.</span>
0043 <span class="comment">% - magnet ramp tables are not in perfect agreement with magnetic measurements</span>
0044 <span class="comment">%        Does not appear to be a serious problem. Superbends are slightly out of sync with other magnets,</span>
0045 <span class="comment">%        but this does not cause any negative effects while ramping.</span>
0046 <span class="comment">% - no good way to operate with injection at 1.5 GeV and storage energy below that</span>
0047 <span class="comment">%        There now is a reasonable way to inject at 1.5 GeV and ramp down to lower storage energy. But</span>
0048 <span class="comment">%        it has to be tested again after implementing new (and more) chicanes ...</span>
0049 
0050 <span class="comment">% revision history</span>
0051 <span class="comment">% 2001-05-10, Christoph Steier</span>
0052 <span class="comment">% check whether readback from insertion device is significantly (more than 1 mm) below minimum</span>
0053 <span class="comment">% gap, to avoid false zero readings of insertion device gaps to cause the tune feed forward</span>
0054 <span class="comment">% to implement false huge correction (and dump the beam). If the insertion device gap readbacks</span>
0055 <span class="comment">% gets more than 1 mm below the nominal minimum gap, the routine now assumes the insertion device</span>
0056 <span class="comment">% to be open.</span>
0057 <span class="comment">%</span>
0058 <span class="comment">% 2001-08-30 and during Superbend commissioning, Christoph Steier, Tom Scarvie, Winni Decking</span>
0059 <span class="comment">% various changes have been made to incorporate the Superbends and some other new equipment</span>
0060 <span class="comment">% installed in the Superbend shutdown. This included some changes to programs being called by srcontrol</span>
0061 <span class="comment">% (like srload, srsave, srcycle, srramp, ...). The main changes within srcontrol were in the orbit</span>
0062 <span class="comment">% correction and slow orbit feedback routines (incorporating frequency feedback, ...)</span>
0063 <span class="comment">%</span>
0064 <span class="comment">% 2002-05-04, Christoph Steier</span>
0065 <span class="comment">% added new IDBPMs, modified orbit feedback to use trim DACs, removed LSB toggling in vertical</span>
0066 <span class="comment">% orbit feedback, ...</span>
0067 <span class="comment">%</span>
0068 
0069 <span class="comment">% 2002-07-29, T.Scarvie</span>
0070 <span class="comment">% added check of CM trim currents to warn of problems that might rail the orbit feedback</span>
0071 <span class="comment">%</span>
0072 <span class="comment">% 2002-07-31, Christoph Steier</span>
0073 <span class="comment">% increased the gain of the RF frequency feedback from 1/50 of the gain of the horizontal</span>
0074 <span class="comment">% orbit feedback to 1/20. Reason was that the frequency feedback was reacting a bit too slow if all</span>
0075 <span class="comment">% insertion device gaps are closed at once at high speed at the beginning of a fill.</span>
0076 <span class="comment">%</span>
0077 <span class="comment">% 2002-08-05, C.Steier, T.Scarvie</span>
0078 <span class="comment">% Added conditional to reduce orbit feedback gain if running in two-bunch mode</span>
0079 <span class="comment">%</span>
0080 <span class="comment">% 2003-06-02, T.Scarvie</span>
0081 <span class="comment">% Added loop inside orbit feedback to reset the SR11 chicane M1 and M2 motors every 20s to combat drift problem</span>
0082 <span class="comment">%</span>
0083 <span class="comment">% 2003-06-18, C. Steier</span>
0084 <span class="comment">% Disabled loop to periodically reset chicane in SR11. Al Robb replaced power supply, seems to be no problem anymore.</span>
0085 <span class="comment">%</span>
0086 <span class="comment">% 2004-05-10, C. Steier</span>
0087 <span class="comment">% The list of all BBPMs is now set up automatically be calling getlist('BBPMx'). This way, new BBPMs have to be added</span>
0088 <span class="comment">% at fewer places in the software. It should now be sufficient to modify getlist and run the orbit response matrix</span>
0089 <span class="comment">% rountine (getsmat) once to enable use of the new BBPMs.</span>
0090 <span class="comment">%</span>
0091 <span class="comment">% 2004-05-14, C. Steier</span>
0092 <span class="comment">% Modified parameters for ramprate reduction (in srramp and here). Previous parameters were slightly too</span>
0093 <span class="comment">% cautious. Increased initial slow ramprate to 0.4 A/s.</span>
0094 <span class="comment">%</span>
0095 <span class="comment">% 2004-05-14, C. Steier</span>
0096 <span class="comment">% Incorporated insertion device compensation schemes for nu_y = 9.2 lattice.</span>
0097 <span class="comment">%</span>
0098 <span class="comment">% 2004-06-14, T.Scarvie</span>
0099 <span class="comment">% Added controls for fast orbit feedback</span>
0100 <span class="comment">%</span>
0101 <span class="comment">% 2004-06-21, C. Steier</span>
0102 <span class="comment">% Added tune feedforward (in the global tune compensation scheme for the nu_y=9.2 lattice) for the shift</span>
0103 <span class="comment">% dependent tune shift of the EPUs, as well as a skew quadrupole feedforward for the EPU im sector 11</span>
0104 <span class="comment">% (both only active in parallel mode so far).</span>
0105 <span class="comment">%</span>
0106 <span class="comment">% 2005-02-13, T.Scarvie</span>
0107 <span class="comment">% Separated horizontal and vertical planes for setting Fast Feedback PIDs</span>
0108 
0109 
0110 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0111 <span class="comment">% NOTES for conversion to new Middle Layer %</span>
0112 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0113 <span class="comment">%</span>
0114 <span class="comment">% We never use the gap and bump control flags - the radio buttons have been disabled -</span>
0115 <span class="comment">%        should we try to keep the functionality?</span>
0116 <span class="comment">%</span>
0117 <span class="comment">% checksrmags</span>
0118 <span class="comment">% checksrorbit(...)</span>
0119 
0120 
0121 <span class="comment">% For the compiler</span>
0122 <span class="comment">%#function goldenpage</span>
0123 <span class="comment">%#function setoperationalmode</span>
0124 
0125 
0126 <span class="comment">% Check if the AO exists</span>
0127 checkforao;
0128 
0129 
0130 <span class="comment">%%%%%%%%%%%%%%</span>
0131 <span class="comment">% Initialize %</span>
0132 <span class="comment">%%%%%%%%%%%%%%</span>
0133 
0134 <span class="keyword">global</span> FEEDBACK_STOP_FLAG
0135 
0136 SR_Mode = getfamilydata(<span class="string">'OperationalMode'</span>);
0137 SR_GEV = getfamilydata(<span class="string">'Energy'</span>);
0138 
0139 BSCramprate = getfamilydata(<span class="string">'BSCRampRate'</span>);
0140 <span class="keyword">if</span> isnan(BSCramprate) | isempty(BSCramprate)
0141     BSCramprate = 0.4;
0142     setfamilydata(BSCramprate, <span class="string">'BSCRampRate'</span>);
0143 <span class="keyword">end</span>
0144 
0145 <span class="keyword">if</span> nargin &lt; 1
0146     action = <span class="string">'Initialize'</span>;
0147 <span class="keyword">end</span>
0148 <span class="keyword">if</span> nargin &lt; 2
0149     Input2 = 0;
0150 <span class="keyword">end</span>
0151 <span class="keyword">if</span> nargin &lt; 3
0152     Input3 = 0;
0153 <span class="keyword">end</span>
0154 
0155 <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
0156     FOFBcheckboxVal = 0;
0157 <span class="keyword">else</span>
0158     FOFBcheckboxVal = 1;
0159 <span class="keyword">end</span>
0160 
0161 <span class="comment">%%%%%%%%%%%%%%%%</span>
0162 <span class="comment">% Main Program %</span>
0163 <span class="comment">%%%%%%%%%%%%%%%%</span>
0164 
0165 <span class="keyword">switch</span>(action)
0166 
0167     <span class="keyword">case</span> <span class="string">'StopOrbitFeedback'</span>
0168 
0169         FEEDBACK_STOP_FLAG = 1;
0170 
0171     <span class="keyword">case</span> <span class="string">'Initialize'</span>
0172 
0173         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0174         <span class="comment">% GUI</span>
0175         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0176         ButtonWidth = 200;
0177         ButtonHeight  = 25;
0178 
0179         Offset1 = 8*25+12 + 47 + 25+25;
0180         Offset2 = 47+25+25;
0181         Offset3 = 45+25;
0182         Offset4 = 1;
0183         Offset5 = 30;
0184         FigWidth = ButtonWidth+6;
0185         FigHeight  = 3+9*(ButtonHeight+6)+24+Offset1;
0186         ButtonWidth = 200-6;
0187 
0188         <span class="comment">% Change figure position</span>
0189         set(0,<span class="string">'Units'</span>,<span class="string">'pixels'</span>);
0190         p=get(0,<span class="string">'screensize'</span>);
0191 
0192         h0 = figure( <span class="keyword">...</span>
0193             <span class="string">'Color'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0194             <span class="string">'HandleVisibility'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0195             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0196             <span class="string">'MenuBar'</span>,<span class="string">'none'</span>, <span class="keyword">...</span>
0197             <span class="string">'Name'</span>,<span class="string">'ALS SR CONTROL'</span>, <span class="keyword">...</span>
0198             <span class="string">'NumberTitle'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0199             <span class="string">'Units'</span>,<span class="string">'pixels'</span>, <span class="keyword">...</span>
0200             <span class="string">'Position'</span>,[30 p(4)-FigHeight-40 FigWidth FigHeight+Offset5], <span class="keyword">...</span>
0201             <span class="string">'Resize'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0202             <span class="string">'Tag'</span>,<span class="string">'SRCTRLFig1'</span>);
0203 
0204         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0205             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0206             <span class="string">'Callback'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0207             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0208             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0209             <span class="string">'FontWeight'</span>,<span class="string">'Bold'</span>, <span class="keyword">...</span>
0210             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0211             <span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>, <span class="keyword">...</span>
0212             <span class="string">'Position'</span>,[6 3+8*(ButtonHeight+3)+19+19+8+Offset1  ButtonWidth 20+Offset5], <span class="keyword">...</span>
0213             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0214             <span class="string">'String'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0215             <span class="string">'Tag'</span>,<span class="string">'SRCTRLTitle'</span>);
0216 
0217         <span class="comment">% Frame Box I</span>
0218         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0219             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0220             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0221             <span class="string">'Position'</span>,[3 3+3*(ButtonHeight+3)+Offset1-3+Offset5 ButtonWidth+6 7*ButtonHeight+18], <span class="keyword">...</span>
0222             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0223 
0224         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0225             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0226             <span class="string">'Callback'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0227             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0228             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0229             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0230             <span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>, <span class="keyword">...</span>
0231             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)+Offset1  ButtonWidth 15+Offset5], <span class="keyword">...</span>
0232             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0233             <span class="string">'String'</span>,<span class="string">'Lattice Setup Functions'</span>);
0234 
0235         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0236             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Cycle'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0237             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0238             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0239             <span class="string">'Position'</span>,[6 3+8*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0240             <span class="string">'String'</span>,<span class="string">'Cycle SR Lattice'</span>, <span class="keyword">...</span>
0241             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>);
0242 
0243         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0244             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Injection'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0245             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0246             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0247             <span class="string">'Position'</span>,[6 3+7*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0248             <span class="string">'String'</span>,<span class="string">'Injection'</span>, <span class="keyword">...</span>
0249             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>);
0250 
0251         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0252             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Production'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0253             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0254             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0255             <span class="string">'Position'</span>,[6 3+6*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0256             <span class="string">'String'</span>,[<span class="string">'Production'</span>], <span class="keyword">...</span>
0257             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>);
0258 
0259         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0260             <span class="string">'Callback'</span>,[<span class="keyword">...</span>
0261             <span class="string">'fprintf(''\n'');'</span> <span class="keyword">...</span>
0262             <span class="string">'disp([''   **********************************************'']);'</span>, <span class="keyword">...</span>
0263             <span class="string">'disp([''   **  Changing Storage Ring Operational Mode  **'']);'</span>, <span class="keyword">...</span>
0264             <span class="string">'disp([''   **********************************************'']);'</span>, <span class="keyword">...</span>
0265             <span class="string">'setoperationalmode;'</span>, <span class="keyword">...</span>
0266             <span class="string">'srcontrol5(''CheckInputs'');'</span>, <span class="keyword">...</span>
0267             <span class="string">'disp([''   ****************************'']);'</span>, <span class="keyword">...</span>
0268             <span class="string">'disp([''   **  Mode Change Complete  **'']);'</span>, <span class="keyword">...</span>
0269             <span class="string">'disp([''   ****************************'']);'</span>, <span class="keyword">...</span>
0270             <span class="string">'fprintf(''\n'');'</span>], <span class="keyword">...</span>
0271             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0272             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0273             <span class="string">'Position'</span>,[6 3+5*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0274             <span class="string">'Value'</span>,1, <span class="keyword">...</span>
0275             <span class="string">'String'</span>,<span class="string">'Change Operational Mode'</span>, <span class="keyword">...</span>
0276             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>);
0277 
0278         h1 = uicontrol(<span class="keyword">...</span>
0279             <span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0280             <span class="string">'Callback'</span>, [<span class="keyword">...</span>
0281             <span class="string">'srcontrol5(''CheckInputs'');'</span>,<span class="keyword">...</span>
0282             <span class="string">'srcontrol5(''SRState'');'</span>], <span class="keyword">...</span>
0283             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0284             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0285             <span class="string">'Position'</span>,[6 3+4*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0286             <span class="string">'String'</span>,<span class="string">'Check For Problems'</span>, <span class="keyword">...</span>
0287             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>);
0288 
0289         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0290             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs''); goldenpage;'</span>, <span class="keyword">...</span>
0291             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0292             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0293             <span class="string">'Position'</span>,[6 3+3*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0294             <span class="string">'String'</span>,<span class="string">'Golden Page'</span>, <span class="keyword">...</span>
0295             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>);
0296 
0297 
0298         <span class="comment">% Frame Box II</span>
0299         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0300             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0301             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0302             <span class="string">'Position'</span>,[3 3+9*(ButtonHeight+3)-29+Offset2+Offset5 ButtonWidth+6 2*ButtonHeight+15], <span class="keyword">...</span>
0303             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0304         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0305             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0306             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0307             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0308             <span class="string">'Position'</span>,[6 3+10*(ButtonHeight+3)-10+Offset2 ButtonWidth .6*ButtonHeight+Offset5], <span class="keyword">...</span>
0309             <span class="string">'String'</span>,<span class="string">'Global/Local Orbit Correction'</span>, <span class="keyword">...</span>
0310             <span class="string">'Style'</span>,<span class="string">'text'</span>);
0311         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0312             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''OrbitCorrection'');'</span>, <span class="keyword">...</span>
0313             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0314             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0315             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)-6+Offset2+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0316             <span class="string">'String'</span>,<span class="string">'Correct Global Orbit w/ IDBPMs'</span>, <span class="keyword">...</span>
0317             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>);
0318         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0319             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''OrbitCorrectionSetup'',1);'</span>, <span class="keyword">...</span>
0320             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''OrbitCorrectionSetup'',0);'</span>, <span class="keyword">...</span>
0321             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0322             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0323             <span class="string">'Position'</span>,[6 9*(ButtonHeight+3)-22+Offset2+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0324             <span class="string">'String'</span>,<span class="string">'Edit IDBPM, CM, &amp; Local Bump Lists'</span>, <span class="keyword">...</span>
0325             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0326             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0327             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>);
0328 
0329 
0330         <span class="comment">% Frame Box III</span>
0331         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0332             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0333             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0334             <span class="string">'Position'</span>,[3 1*(ButtonHeight)+Offset3+Offset5-38 ButtonWidth+6 8*ButtonHeight+61], <span class="keyword">...</span>
0335             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0336         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0337             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0338             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0339             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0340             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)+Offset3-25 ButtonWidth .55*ButtonHeight+Offset5], <span class="keyword">...</span>
0341             <span class="string">'String'</span>,<span class="string">'Orbit Feedback'</span>, <span class="keyword">...</span>
0342             <span class="string">'Style'</span>,<span class="string">'text'</span>);
0343 
0344         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0345             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0346             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0347             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0348             <span class="string">'Position'</span>,[26 3+8*(ButtonHeight+3)+Offset3-18+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0349             <span class="string">'String'</span>,<span class="string">'Slow Orbit Correction'</span>, <span class="keyword">...</span>
0350             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0351             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0352             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxSOFB'</span>);
0353         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0354             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0355             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0356             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0357             <span class="string">'Position'</span>,[26 3+7*(ButtonHeight+3)+Offset3-9+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0358             <span class="string">'String'</span>,<span class="string">'Fast Orbit Correction'</span>, <span class="keyword">...</span>
0359             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0360             <span class="string">'Value'</span>,FOFBcheckboxVal,<span class="keyword">...</span>
0361             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxFOFB'</span>);
0362 
0363         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0364             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0365             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0366             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0367             <span class="string">'Position'</span>,[26 3+6*(ButtonHeight+3)+Offset3+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0368             <span class="string">'String'</span>,<span class="string">'Correct ID Tune Shift  '</span>, <span class="keyword">...</span>
0369             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0370             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0371             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxTune'</span>);
0372 
0373         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0374             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0375             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0376             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0377             <span class="string">'Position'</span>,[26 3+5*(ButtonHeight+3)+Offset3+9+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0378             <span class="string">'String'</span>,<span class="string">'Correct RF Frequency'</span>, <span class="keyword">...</span>
0379             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0380             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0381             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>);
0382 
0383         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0384             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''Feedback'');'</span>, <span class="keyword">...</span>
0385             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0386             <span class="string">'FontSize'</span>,12, <span class="keyword">...</span>
0387             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0388             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0389             <span class="string">'Position'</span>,[8 3+5*(ButtonHeight+3)+3+Offset3-25+Offset5 .5*ButtonWidth-6 1.0*ButtonHeight], <span class="keyword">...</span>
0390             <span class="string">'String'</span>,<span class="string">'Start FB'</span>, <span class="keyword">...</span>
0391             <span class="string">'Value'</span>,0, <span class="keyword">...</span>
0392             <span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>);
0393         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0394             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''StopOrbitFeedback'');pause(0);'</span>, <span class="keyword">...</span>
0395             <span class="string">'Enable'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0396             <span class="string">'FontSize'</span>,12, <span class="keyword">...</span>
0397             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0398             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0399             <span class="string">'Position'</span>,[.5*FigWidth+3 3+5*(ButtonHeight+3)+3+Offset3-25+Offset5 .5*ButtonWidth-6 1.0*ButtonHeight], <span class="keyword">...</span>
0400             <span class="string">'String'</span>,<span class="string">'Stop FB'</span>, <span class="keyword">...</span>
0401             <span class="string">'Value'</span>,0, <span class="keyword">...</span>
0402             <span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>);
0403 
0404         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0405             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0406             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0407             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0408             <span class="string">'Position'</span>,[14 4*(ButtonHeight)+Offset3+Offset5-3 ButtonWidth-14 .75*ButtonHeight], <span class="keyword">...</span>
0409             <span class="string">'String'</span>,<span class="string">'Horizontal RMS = _____ mm'</span>, <span class="keyword">...</span>
0410             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0411             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>);
0412         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0413             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0414             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0415             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0416             <span class="string">'Position'</span>,[26 3+3.5*(ButtonHeight)+16+Offset3-25+Offset5 ButtonWidth-26 .75*ButtonHeight], <span class="keyword">...</span>
0417             <span class="string">'String'</span>,<span class="string">'Vertical RMS = _____ mm'</span>, <span class="keyword">...</span>
0418             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0419             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>);
0420 
0421         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0422             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''FeedbackSetup'',1);'</span>, <span class="keyword">...</span>
0423             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''FeedbackSetup'',0);'</span>, <span class="keyword">...</span>
0424             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0425             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0426             <span class="string">'Position'</span>,[8 3+3.5*(ButtonHeight)+.5+Offset3-25+Offset5 ButtonWidth-5 .75*ButtonHeight], <span class="keyword">...</span>
0427             <span class="string">'String'</span>,<span class="string">'Edit SOFB Setup'</span>, <span class="keyword">...</span>
0428             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0429             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0430             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>);
0431 
0432         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0433             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0434             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0435             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0436             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0437             <span class="string">'String'</span>,<span class="string">'01 ____'</span>, <span class="keyword">...</span>
0438             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0439             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0440             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>);
0441 
0442         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0443             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0444             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0445             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0446             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0447             <span class="string">'String'</span>,<span class="string">'02 ____'</span>, <span class="keyword">...</span>
0448             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0449             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0450             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>);
0451 
0452         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0453             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0454             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0455             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0456             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0457             <span class="string">'String'</span>,<span class="string">'03 ____'</span>, <span class="keyword">...</span>
0458             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0459             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0460             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>);
0461 
0462         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0463             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0464             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0465             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0466             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0467             <span class="string">'String'</span>,<span class="string">'04 ____'</span>, <span class="keyword">...</span>
0468             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0469             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0470             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>);
0471 
0472         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0473             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0474             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0475             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0476             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0477             <span class="string">'String'</span>,<span class="string">'05 ____'</span>, <span class="keyword">...</span>
0478             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0479             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0480             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>);
0481 
0482         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0483             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0484             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0485             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0486             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0487             <span class="string">'String'</span>,<span class="string">'06 ____'</span>, <span class="keyword">...</span>
0488             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0489             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0490             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>);
0491 
0492         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0493             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0494             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0495             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0496             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0497             <span class="string">'String'</span>,<span class="string">'07 ____'</span>, <span class="keyword">...</span>
0498             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0499             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0500             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>);
0501 
0502         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0503             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0504             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0505             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0506             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0507             <span class="string">'String'</span>,<span class="string">'08 ____'</span>, <span class="keyword">...</span>
0508             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0509             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0510             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>);
0511 
0512         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0513             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0514             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0515             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0516             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0517             <span class="string">'String'</span>,<span class="string">'09 ____'</span>, <span class="keyword">...</span>
0518             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0519             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0520             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>);
0521 
0522         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0523             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0524             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0525             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0526             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0527             <span class="string">'String'</span>,<span class="string">'10 ____'</span>, <span class="keyword">...</span>
0528             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0529             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0530             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>);
0531 
0532         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0533             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0534             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0535             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0536             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0537             <span class="string">'String'</span>,<span class="string">'11 ____'</span>, <span class="keyword">...</span>
0538             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0539             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0540             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>);
0541 
0542         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0543             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0544             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0545             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0546             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0547             <span class="string">'String'</span>,<span class="string">'12 ____'</span>, <span class="keyword">...</span>
0548             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0549             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0550             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>);
0551 
0552         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0553             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''FastFeedbackSetup'',1);'</span>, <span class="keyword">...</span>
0554             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''FastFeedbackSetup'',0);'</span>, <span class="keyword">...</span>
0555             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0556             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0557             <span class="string">'Position'</span>,[8 1*(ButtonHeight)+Offset3-3 ButtonWidth-5 .75*ButtonHeight], <span class="keyword">...</span>
0558             <span class="string">'String'</span>,<span class="string">'Edit FOFB Setup'</span>, <span class="keyword">...</span>
0559             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0560             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0561             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>);
0562 
0563         <span class="comment">% Frame Box IV</span>
0564         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0565             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0566             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0567             <span class="string">'Position'</span>,[3 3+ButtonHeight+Offset4-14+Offset5 ButtonWidth+6 ButtonHeight+12], <span class="keyword">...</span>
0568             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0569         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0570             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0571             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0572             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0573             <span class="string">'Position'</span>,[6 3+1.75*ButtonHeight+5+Offset4-21+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0574             <span class="string">'String'</span>,<span class="string">'Storage Ring State'</span>, <span class="keyword">...</span>
0575             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0576             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHeader'</span>);
0577         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0578             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''CheckInputs'');'</span>, <span class="keyword">...</span>
0579             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0580             <span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>, <span class="keyword">...</span>
0581             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0582             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0583             <span class="string">'Position'</span>,[6 3+ButtonHeight+6+3+2+Offset4-22+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0584             <span class="string">'String'</span>,<span class="string">'   '</span>, <span class="keyword">...</span>
0585             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0586             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>);
0587 
0588 
0589         <span class="comment">% Frame Box &quot;Close&quot;</span>
0590         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0591             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0592             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0593             <span class="string">'Position'</span>,[3 8 ButtonWidth+6 ButtonHeight+8], <span class="keyword">...</span>
0594             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0595         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0596             <span class="string">'Callback'</span>,<span class="string">'close(gcbf);'</span>, <span class="keyword">...</span>
0597             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0598             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0599             <span class="string">'Position'</span>,[6 13 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0600             <span class="string">'String'</span>,<span class="string">'Close'</span>, <span class="keyword">...</span>
0601             <span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>);
0602 
0603 
0604         <span class="comment">% Update database channels</span>
0605         <a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>;
0606 
0607         <span class="keyword">if</span> nargout &gt; 0
0608             fig = h0;
0609         <span class="keyword">end</span>
0610 
0611 
0612     <span class="keyword">case</span> <span class="string">'Cycle'</span>
0613         GapFlag = Input2;
0614         BumpMagnetFlag = Input3;
0615 
0616         fprintf(<span class="string">'\n'</span>);
0617         disp(<span class="string">'   **************************'</span>);
0618         disp(<span class="string">'   **  Storage Ring Cycle  **'</span>);
0619         disp(<span class="string">'   **************************'</span>);
0620         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
0621 
0622         BSCFlag = questdlg(sprintf(<span class="string">'Cycle Superbend Magnets?'</span>),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0623         <span class="comment">%if strcmp(BSCFlag,'No')</span>
0624         <span class="comment">%    disp(['   ** Superbends will not be cycled. **']);</span>
0625         <span class="comment">%else</span>
0626         <span class="comment">%    disp(['   ** Superbends will be cycled during the second mini-cycle only. **']);</span>
0627         <span class="comment">%end</span>
0628 
0629         ChicSQFlag = questdlg(sprintf(<span class="string">'Cycle chicanes and skew quads and home motor chicanes?'</span>),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0630         <span class="comment">%if strcmp(ChicSQFlag,'No')</span>
0631         <span class="comment">%    disp(['   ** Chicanes and skew quads will not be cycled; motor chicanes will not be homed. **']);</span>
0632         <span class="comment">%else</span>
0633         <span class="comment">%    disp(['   ** Chicanes and skew quads will be cycled; motor chicanes will be homed. **']);</span>
0634         <span class="comment">%end</span>
0635 
0636 
0637         StartFlag = questdlg(sprintf(<span class="string">'Start %.1f GeV Cycle?'</span>,SR_GEV),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0638         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
0639             disp([<span class="string">'   ***************************'</span>]);
0640             disp([<span class="string">'   **    Cycle  Canceled    **'</span>]);
0641             disp([<span class="string">'   ***************************'</span>]);
0642             fprintf(<span class="string">'\n'</span>);
0643             <span class="keyword">return</span>
0644         <span class="keyword">end</span>
0645 
0646         <span class="keyword">try</span>
0647             <span class="keyword">if</span> GapFlag
0648                 <span class="comment">% Make sure that the gaps are open with FF off</span>
0649                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0650                     <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0651                     disp(<span class="string">'   Insertion device gaps are not open.'</span>);
0652                     disp(<span class="string">'   Opening all gaps at maximum speed.'</span>);
0653                     <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0654                     disp(<span class="string">'   Gap control disabled.'</span>);
0655                     disp(<span class="string">'   Feed forward enabled.'</span>);
0656                     pause(1);
0657                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0658                     disp(<span class="string">'   Gaps opened.'</span>);
0659                     disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0660                     a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0661                 <span class="keyword">else</span>
0662                     disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0663                 <span class="keyword">end</span>
0664             <span class="keyword">else</span>
0665                 disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0666             <span class="keyword">end</span>
0667 
0668             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0669             pause(1);
0670             
0671             <a href="srcycle.html" class="code" title="function FailFlag = srcycle(varargin)">srcycle</a>(BSCFlag, ChicSQFlag);
0672 
0673             setpv(<span class="string">'SR_STATE'</span>,1);
0674 
0675         <span class="keyword">catch</span>
0676 
0677             fprintf(<span class="string">'   %s \n'</span>,lasterr);
0678             fprintf(<span class="string">'   Cycle failed due to error condition! \n\n'</span>);
0679             setpv(<span class="string">'SR_STATE'</span>,-1);
0680             
0681         <span class="keyword">end</span>
0682 
0683         date;
0684         a = clock;
0685         datestr1=date;
0686         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0687         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0688         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0689         <span class="keyword">if</span> StateNumber &gt;= 0
0690             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0691             disp(<span class="string">'   **********************************************'</span>);
0692             disp(<span class="string">'   **  SR Cycle complete, ready for injection  **'</span>);
0693             disp(<span class="string">'   **********************************************'</span>); fprintf(<span class="string">'\n'</span>);
0694         <span class="keyword">else</span>
0695             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0696             disp(<span class="string">'   **********************************'</span>);
0697             disp(<span class="string">'   **  Problem cycling SR lattice  **'</span>);
0698             disp(<span class="string">'   **********************************'</span>); fprintf(<span class="string">'\n'</span>);
0699         <span class="keyword">end</span>
0700         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0701         
0702 
0703     <span class="keyword">case</span> <span class="string">'Injection'</span>
0704         AD = getad;
0705         GapFlag = Input2;
0706         BumpMagnetFlag = Input3;
0707 
0708         fprintf(<span class="string">'\n'</span>);
0709         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0710 
0711         <span class="keyword">if</span> abs(AD.Energy - AD.InjectionEnergy) &gt; .05
0712             fprintf(<span class="string">'   ***************************************************\n'</span>);
0713             fprintf(<span class="string">'   **  Setup For %.2f GeV Injection (with ramping)  **\n'</span>, getfamilydata(<span class="string">'InjectionEnergy'</span>));
0714             fprintf(<span class="string">'   ***************************************************\n'</span>);
0715             <a href="set_alarmhandler_AHU_thresholds_inject.html" class="code" title="function set_alarmhandler_AHU_thresholds_inject">set_alarmhandler_AHU_thresholds_inject</a>;
0716             StartFlag = questdlg(sprintf(<span class="string">'Start setup for injection, %.2f GeV?'</span>,getfamilydata(<span class="string">'InjectionEnergy'</span>)),<span class="string">'Injection Setup'</span>,<span class="string">'Ramp quickly'</span>,<span class="string">'Ramp slowly'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0717         <span class="keyword">else</span>
0718             fprintf(<span class="string">'   *************************************************\n'</span>);
0719             fprintf(<span class="string">'   **  Setup For On Energy Injection at %.2f GeV  **\n'</span>, SR_GEV);
0720             fprintf(<span class="string">'   *************************************************\n'</span>);
0721             StartFlag = questdlg(sprintf(<span class="string">'Start setup for injection, %.2f GeV?'</span>,SR_GEV),<span class="string">'Injection Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0722         <span class="keyword">end</span>
0723         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'Cancel'</span>)
0724             disp([<span class="string">'   ********************************'</span>]);
0725             disp([<span class="string">'   **  Injection Setup Canceled  **'</span>]);
0726             disp([<span class="string">'   ********************************'</span>]);
0727             <a href="set_alarmhandler_thresholds.html" class="code" title="function set_alarmhandler_thresholds">set_alarmhandler_thresholds</a>;
0728             fprintf(<span class="string">'\n'</span>);
0729             <span class="keyword">return</span>
0730         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp quickly'</span>)
0731             setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0732         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp slowly'</span>)
0733             setfamilydata(0.4, <span class="string">'BSCRampRate'</span>);
0734         <span class="keyword">end</span>
0735 
0736         <span class="keyword">try</span>
0737 
0738             <span class="keyword">if</span> GapFlag
0739                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([],1,0);
0740                 disp(<span class="string">'   Gap control disabled'</span>);
0741                 disp(<span class="string">'   Feed forward enabled'</span>);
0742                 pause(1);
0743 
0744                 <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0745                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0746                     disp(<span class="string">'   Opening all gaps'</span>);
0747                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0748                 <span class="keyword">end</span>
0749 
0750                 disp(<span class="string">'   Gaps are open'</span>);
0751                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0752                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0753             <span class="keyword">else</span>
0754                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0755             <span class="keyword">end</span>
0756 
0757             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0758             pause(1);
0759 
0760             <span class="keyword">if</span> (AD.Energy-AD.InjectionEnergy) &gt; 0.05
0761                 <span class="comment">% Ramp down to Injection Energy</span>
0762                 ErrorFlag = <a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>(<span class="string">'Injection'</span>);
0763                 <span class="keyword">if</span> ErrorFlag
0764                     error(<span class="string">'Superbends over temperature.'</span>);
0765                 <span class="keyword">end</span>
0766                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n\n'</span>,date, a(4), a(5), a(6));
0767 
0768             <span class="keyword">elseif</span> (AD.Energy-AD.InjectionEnergy) &lt; -0.05
0769 
0770                 <span class="comment">% first load injection lattice, then ramp to 1.9 GeV and back to 1.5 GeV to get onto same hysteresis branch</span>
0771 
0772                 srload(<span class="string">'Injection'</span>);
0773 
0774                 <span class="comment">% load 1.9 GeV lattice</span>
0775                 tempfilename = sprintf(<span class="string">'%s19nuy9prod.mat'</span>, getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>));
0776 
0777                 srload(tempfilename);
0778 
0779                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0780 
0781                 pause(5);
0782 
0783             <span class="keyword">end</span>
0784 
0785             srload(<span class="string">'Injection'</span>);
0786 
0787             setpv(<span class="string">'SR_STATE'</span>,2);
0788 
0789         <span class="keyword">catch</span>
0790 
0791             fprintf(<span class="string">'   %s \n'</span>,lasterr);
0792             fprintf(<span class="string">'   Injection lattice setup failed due to error condition! \n\n'</span>);
0793             setpv(<span class="string">'SR_STATE'</span>,-2);
0794 
0795         <span class="keyword">end</span>
0796 
0797 
0798         date;
0799         a = clock;
0800         datestr1=date;
0801         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0802         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0803         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0804         <span class="keyword">if</span> StateNumber &gt;= 0
0805             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0806             <span class="keyword">if</span> AD.Energy &lt;= 1.5
0807                 disp([<span class="string">'   *******************************************************************************'</span>]);
0808                 disp([<span class="string">'   **  Function complete:  the storage ring is setup for injection at '</span>,sprintf(<span class="string">'%.2f'</span>,SR_GEV),<span class="string">' GeV  **'</span>]);
0809                 disp([<span class="string">'   *******************************************************************************'</span>]); 
0810                 fprintf(<span class="string">'\n'</span>);
0811             <span class="keyword">else</span>
0812                 fprintf(<span class="string">'   **********************************************************************************************\n'</span>);
0813                 fprintf(<span class="string">'   **  Function complete:  the storage ring is setup for injection at %.2f GeV (upper branch)  **\n'</span>, getfamilydata(<span class="string">'InjectionEnergy'</span>));
0814                 fprintf(<span class="string">'   **********************************************************************************************\n'</span>); 
0815                 fprintf(<span class="string">'\n'</span>);
0816             <span class="keyword">end</span>
0817         <span class="keyword">else</span>
0818             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0819             disp([<span class="string">'   ************************************'</span>]);
0820             disp([<span class="string">'   **  Problem with injection setup  **'</span>]);
0821             disp([<span class="string">'   ************************************'</span>]); 
0822             fprintf(<span class="string">'\n'</span>);
0823         <span class="keyword">end</span>
0824         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0825 
0826         <span class="comment">%soundchord;</span>
0827 
0828         setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0829 
0830 
0831     <span class="keyword">case</span> <span class="string">'Production'</span>
0832         GapFlag = Input2;
0833         BumpMagnetFlag = Input3;
0834         AD=getad;
0835         
0836         fprintf(<span class="string">'\n'</span>);
0837         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0838 
0839         <span class="keyword">if</span> abs(AD.Energy - AD.InjectionEnergy) &gt; .05
0840             disp(<span class="string">'   ********************************************************'</span>);
0841             disp(sprintf(<span class="string">'   **  Setup For %.2f GeV User Operation (with ramping)  **'</span>,SR_GEV));
0842             disp(<span class="string">'   ********************************************************'</span>);
0843             StartFlag = questdlg(sprintf(<span class="string">'Start setup for users, %.1f GeV?'</span>,SR_GEV),<span class="string">'User Setup'</span>,<span class="string">'Ramp quickly'</span>,<span class="string">'Ramp slowly'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0844         <span class="keyword">else</span>
0845             disp(<span class="string">'   *****************************************'</span>);
0846             disp(sprintf(<span class="string">'   **  Setup For %.2f GeV User Operation  **'</span>,SR_GEV));
0847             disp(<span class="string">'   *****************************************'</span>);
0848             StartFlag = questdlg(sprintf(<span class="string">'Start setup for users, %.1f GeV?'</span>,SR_GEV),<span class="string">'User Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0849         <span class="keyword">end</span>
0850 
0851         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'Cancel'</span>)
0852             disp([<span class="string">'   ***************************'</span>]);
0853             disp([<span class="string">'   **  User Setup Canceled  **'</span>]);
0854             disp([<span class="string">'   ***************************'</span>]);
0855             fprintf(<span class="string">'\n'</span>);
0856             <span class="keyword">return</span>
0857         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp quickly'</span>)
0858             setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0859         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp slowly'</span>)
0860             setfamilydata(0.4, <span class="string">'BSCRampRate'</span>);
0861         <span class="keyword">end</span>
0862 
0863         <span class="keyword">try</span>
0864 
0865             <span class="keyword">if</span> GapFlag
0866                 <span class="comment">% Make sure that the gaps are open</span>
0867                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0868                     <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0869                     disp(<span class="string">'   Insertion device gaps are not open'</span>);
0870                     disp(<span class="string">'   Opening all gaps at maximum speed'</span>);
0871                     <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0872                     disp(<span class="string">'   Gap control disabled'</span>);
0873                     disp(<span class="string">'   Feed forward enabled'</span>);
0874                     pause(1);
0875                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0876                     disp(<span class="string">'   Gaps opened'</span>);
0877                     disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0878                     a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0879                 <span class="keyword">else</span>
0880                     disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0881                 <span class="keyword">end</span>
0882             <span class="keyword">else</span>
0883                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0884             <span class="keyword">end</span>
0885 
0886             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0887             pause(1);
0888 
0889             <span class="comment">% Ramp up to the production lattice</span>
0890             ErrorFlag = <a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>(<span class="string">'Production'</span>);
0891             <span class="keyword">if</span> ErrorFlag
0892                 error(<span class="string">'Superbends over temperature.'</span>);
0893             <span class="keyword">end</span>
0894             a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0895 
0896             srload(<span class="string">'Production'</span>);
0897 
0898             <span class="keyword">if</span> GapFlag
0899                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0900                 disp(<span class="string">'   Gap control disabled'</span>);
0901                 disp(<span class="string">'   Feed forward enable'</span>);
0902                 pause(1);
0903 
0904                 disp(<span class="string">'   Insertion device velocity profile boolean control off'</span>);
0905                 disp(<span class="string">'   Closing all gaps at maximum speed'</span>);
0906 
0907                 <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0908                 [Position, Velocity, RunFlag, UserGap] = <a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>;
0909 
0910                 <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], UserGap, maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0911 
0912                 <span class="comment">% Turn velocity profile on</span>
0913                 disp(<span class="string">'   Insertion device velocity profile boolean control is on'</span>);
0914                 <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], [], maxsp(<span class="string">'IDvel'</span>), 1, 1, 0);
0915 
0916                 disp(<span class="string">'   Gaps are closed'</span>);
0917                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([4;7;8;9;10;12], 1, 1);
0918                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>(5, 1, 0);
0919                 disp(<span class="string">'   Gap control enabled (except sector 5 (W16))'</span>);
0920             <span class="keyword">end</span>
0921 
0922             <a href="set_alarmhandler_thresholds_new.html" class="code" title="function set_alarmhandler_thresholds_new">set_alarmhandler_thresholds_new</a>;
0923             setpv(<span class="string">'SR_STATE'</span>,3);
0924 
0925         <span class="keyword">catch</span>
0926 
0927             fprintf(<span class="string">'   %s \n'</span>, lasterr);
0928             fprintf(<span class="string">'   User lattice setup failed due to error condition! \n\n'</span>);
0929             setpv(<span class="string">'SR_STATE'</span>,-3);
0930 
0931         <span class="keyword">end</span>
0932 
0933         a = clock;
0934         datestr1=date;
0935         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0936         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0937         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0938         <span class="keyword">if</span> StateNumber &gt;= 0
0939             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0940             disp([<span class="string">'   **************************************************************************'</span>]);
0941             disp([<span class="string">'   **  Function complete:  the storage ring is setup for users at '</span>,sprintf(<span class="string">'%.1f'</span>,SR_GEV),<span class="string">' GeV  **'</span>]);
0942             disp([<span class="string">'   **************************************************************************'</span>]); fprintf(<span class="string">'\n'</span>);
0943         <span class="keyword">else</span>
0944             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0945             disp([<span class="string">'   *************************************'</span>]);
0946             disp([<span class="string">'   **  Problem with production setup  **'</span>]);
0947             disp([<span class="string">'   *************************************'</span>]); fprintf(<span class="string">'\n'</span>);
0948         <span class="keyword">end</span>
0949         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0950 
0951         setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0952 
0953         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0954         <span class="comment">% for BL6.0.x, set lower setpoint limit for IVID to 7mm until beamlines are surveyed below that value</span>
0955         <span class="comment">% if 6.0.1 hard x-ray beamline is running the gap will be admin locked at 30mm - 5-02-07 - T.Scarvie</span>
0956         <span class="keyword">try</span>
0957             scaput(<span class="string">'SR06U___GDS1PS_AC00.DRVL'</span>,12.5);
0958             disp(<span class="string">'  Setting SR06U___GDS1PS_AC00.DRVL to 12.5mm (lower limit for IVID'</span>);
0959         <span class="keyword">catch</span>
0960             disp(<span class="string">'  Trouble setting lower limit for IVID to 12.5mm!'</span>);
0961         <span class="keyword">end</span>
0962         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0963 
0964         
0965     <span class="keyword">case</span> <span class="string">'CheckInputs'</span>
0966 
0967         SR_GEV = getfamilydata(<span class="string">'Energy'</span>);
0968         AD=getad;
0969         <a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>; 
0970 
0971         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0972 
0973         <span class="keyword">if</span> AD.Energy &gt; 1.55
0974             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection (Ramp Down)'</span>]);
0975             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users (Ramp Up)'</span>]);
0976         <span class="keyword">elseif</span> AD.Energy &lt; 1.45
0977             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection (Ramp Up+cycle)'</span>]);
0978             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users, '</span>,num2str(round(10*SR_GEV)/10),<span class="string">' GeV (Ramp Down)'</span>]);
0979         <span class="keyword">else</span>
0980             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection'</span>]);
0981             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users, '</span>,num2str(round(10*SR_GEV)/10),<span class="string">' GeV'</span>]);
0982         <span class="keyword">end</span>
0983         set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLTitle'</span>),<span class="string">'String'</span>,SR_Mode);
0984 
0985         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0986         <span class="keyword">if</span> StateNumber &gt;= 0
0987             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0988         <span class="keyword">else</span>
0989             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0990         <span class="keyword">end</span>
0991 
0992         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0993 
0994 
0995     <span class="keyword">case</span> <span class="string">'SRState'</span>
0996         NumErrors = 0;
0997         fprintf(<span class="string">'\n'</span>);
0998         disp(<span class="string">'   ***********************************'</span>);
0999         disp(<span class="string">'   **  Checking Storage Ring State  **'</span>);
1000         disp(<span class="string">'   ***********************************'</span>);
1001         a = clock;
1002         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1003 
1004         <span class="comment">%       FileName = getpv('SR_LATTICE_FILE','String');   % Last srload file name (in OLD MIDDLE LAYER nomenclature!!)</span>
1005 
1006         GeVnow = <a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>;
1007         <span class="keyword">if</span> GeVnow == getfamilydata(<span class="string">'Energy'</span>)
1008             [ConfigSetpoint, ConfigMonitor, FileName] = getproductionlattice;
1009         <span class="keyword">elseif</span> GeVnow == getfamilydata(<span class="string">'InjectionEnergy'</span>)
1010             [ConfigSetpoint, ConfigMonitor, FileName] = getinjectionlattice;
1011         <span class="keyword">else</span>
1012             FileName = <span class="string">''</span>;
1013         <span class="keyword">end</span>
1014 
1015         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1016         fprintf(<span class="string">'   Storage ring operational mode: %s\n'</span>, SR_Mode);
1017         <span class="keyword">if</span> StateNumber &lt; 0
1018             fprintf(<span class="string">'   Storage ring state error: %s\n'</span>, StateString);
1019             NumErrors = NumErrors + 1;
1020         <span class="keyword">else</span>
1021             fprintf(<span class="string">'   Storage ring state: %s\n'</span>, StateString);
1022         <span class="keyword">end</span>
1023         <span class="keyword">if</span> StateNumber==0
1024             <span class="comment">% Storage ring state unknown</span>
1025             NumErrors = NumErrors + 1;
1026         <span class="keyword">elseif</span> abs(StateNumber)==1 || abs(StateNumber)==2
1027             FileNameGoal = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>) getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'InjectionFile'</span>) <span class="string">'.mat'</span>];
1028             <span class="keyword">if</span> ~strcmp(FileName, FileNameGoal)
1029                 fprintf(<span class="string">'   Lattice file %s should be loaded but it appears that %s is loaded.\n'</span>, getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'InjectionFile'</span>), FileName);
1030                 NumErrors = NumErrors + 1;
1031             <span class="keyword">end</span>
1032         <span class="keyword">else</span>
1033             FileNameGoal = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>) getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'LatticeFile'</span>) <span class="string">'.mat'</span>];
1034             <span class="keyword">if</span> ~strcmp(FileName, FileNameGoal)
1035                 fprintf(<span class="string">'   Lattice file %s should be loaded but it appears that %s is loaded.\n'</span>, getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'LatticeFile'</span>), FileName);
1036                 NumErrors = NumErrors + 1;
1037             <span class="keyword">end</span>
1038         <span class="keyword">end</span>
1039 
1040 
1041         <span class="comment">% Check all SR magnets</span>
1042         <span class="keyword">if</span> isempty(FileName)
1043             fprintf(<span class="string">'   Goal setpoints will not be checked since the last lattice load is unknown.\n'</span>);
1044             NumErrors1 = <a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>(<span class="string">''</span>);
1045         <span class="keyword">else</span>
1046 <span class="comment">%            NumErrors1 = checksrmags([getfamilydata('Directory','OpsData') FileName]);</span>
1047             NumErrors1 = <a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>(FileName);
1048         <span class="keyword">end</span>
1049         <span class="keyword">if</span> NumErrors1 == 0
1050             fprintf(<span class="string">'   SR magnets power supplies are OK.\n'</span>);
1051         <span class="keyword">end</span>
1052         NumErrors = NumErrors + NumErrors1;
1053 
1054 
1055         <span class="comment">% Check RF frequency</span>
1056         <span class="keyword">if</span> isempty(FileName)
1057             fprintf(<span class="string">'   RF frequency will not be checked since the last lattice load is unknown.\n'</span>);
1058         <span class="keyword">else</span>
1059 <span class="comment">%            load([getfamilydata('Directory','OpsData'), FileName]);</span>
1060             load(FileName);
1061             [tmp, RFHPCounterPresent] = getrf;
1062             <span class="keyword">if</span> abs(RFHPCounterPresent-ConfigSetpoint.RF.Setpoint.Data) &gt; .002
1063                 NumErrors = NumErrors + 1;
1064                 fprintf(<span class="string">'   RF frequency should be %f, presently it is %f MHz (as measured by the HP counter).\n'</span>, ConfigSetpoint.RF.Setpoint.Data, RFHPCounterPresent);
1065             <span class="keyword">else</span>
1066                 fprintf(<span class="string">'   RF frequency is OK (HP counter is %f MHz, at the time of the lattice save it was %f MHz).\n'</span>, RFHPCounterPresent, ConfigSetpoint.RF.Setpoint.Data);
1067             <span class="keyword">end</span>
1068         <span class="keyword">end</span>
1069 
1070 
1071         <span class="comment">% Check for orbit problems</span>
1072         <span class="keyword">if</span> (StateNumber &gt;= 3) &amp; (getdcct &gt; 2)   <span class="comment">% Production lattice is loaded with beam in the machine</span>
1073             Xtol = 0.070;
1074             Ytol = 0.010;
1075             NumErrors1 = <a href="checksrorbit.html" class="code" title="function ErrorNums = checksrorbit(SectorList, BPMxtol,BPMytol)">checksrorbit</a>([],Xtol,Ytol);
1076             <span class="keyword">if</span> NumErrors1
1077                 fprintf(<span class="string">'   SR orbit in the ID straight sections or at Bergoz BPMs deviates more than allowed from the golden orbit.\n'</span>);
1078             <span class="keyword">else</span>
1079                 fprintf(<span class="string">'   SR orbit in the ID straight sections and at Bergoz BPMs is OK.\n'</span>);
1080                 fprintf(<span class="string">'   The orbit is within %.3f mm horizontally and %.3f mm vertically'</span>, Xtol, Ytol);
1081             <span class="keyword">end</span>
1082             NumErrors = NumErrors + NumErrors1;
1083         <span class="keyword">else</span>
1084             fprintf(<span class="string">'   Storage ring orbit was not checked.\n'</span>);
1085         <span class="keyword">end</span>
1086 
1087 
1088         a = clock;
1089         datestr1=date;
1090         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
1091         <span class="keyword">if</span> NumErrors
1092             disp(<span class="string">'   *********************************'</span>);
1093             disp(<span class="string">'   **  Storage Ring Has Problems  **'</span>);
1094             disp(<span class="string">'   *********************************'</span>);
1095         <span class="keyword">else</span>
1096             disp(<span class="string">'   **********************************'</span>);
1097             disp(<span class="string">'   **  Storage Ring Lattice is OK  **'</span>);
1098             disp(<span class="string">'   **********************************'</span>);
1099         <span class="keyword">end</span>
1100         fprintf(<span class="string">'   \n'</span>);
1101 
1102         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1103         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1104         <span class="keyword">if</span> StateNumber &gt;= 0
1105             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1106         <span class="keyword">else</span>
1107             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1108         <span class="keyword">end</span>
1109         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1110 
1111 
1112     <span class="keyword">case</span> <span class="string">'OrbitCorrection'</span>
1113         fprintf(<span class="string">'\n'</span>);
1114         fprintf(<span class="string">'   *********************************\n'</span>);
1115         fprintf(<span class="string">'   **  Starting Orbit Correction  **\n'</span>);
1116         fprintf(<span class="string">'   *********************************\n'</span>);
1117         a = clock;
1118         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1119 
1120         StartFlag = questdlg(sprintf(<span class="string">'Start orbit correction, %.1f GeV?'</span>,SR_GEV),<span class="string">'Orbit Correction'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
1121         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
1122             disp([<span class="string">'   ********************************'</span>]);
1123             disp([<span class="string">'   **  Orbit Correction Aborted  **'</span>]);
1124             disp([<span class="string">'   ********************************'</span>]);
1125             fprintf(<span class="string">'\n'</span>);
1126             <span class="keyword">return</span>
1127         <span class="keyword">end</span>
1128 
1129         <span class="keyword">if</span> getdcct &lt; 5     <span class="comment">% Don't correct the orbit if the current is too small</span>
1130             fprintf(<span class="string">'   Orbit not corrected due to small current.\n'</span>);
1131             <span class="keyword">return</span>
1132         <span class="keyword">end</span>
1133 
1134         <span class="keyword">if</span> abs(SR_GEV-<a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>(getpv(<span class="string">'BEND'</span>,[1 1])))&gt;  0.05     <span class="comment">% Don't use this routine for the injection lattice</span>
1135             fprintf(<span class="string">'   This routine should only be used for the production energy: Correction aborted\n'</span>);
1136             <span class="keyword">return</span>
1137         <span class="keyword">end</span>
1138 
1139         SR_STATE_OLD = scaget(<span class="string">'SR_STATE'</span>);
1140         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1141         setpv(<span class="string">'SR_STATE'</span>,4);
1142         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1143         <span class="keyword">if</span> StateNumber &gt;= 0
1144             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1145         <span class="keyword">else</span>
1146             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1147         <span class="keyword">end</span>
1148         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1149 
1150 
1151         <span class="keyword">try</span>
1152             <span class="comment">% save current BPM timeconstant - will reset to this after correction</span>
1153             BPMtimeconstantOC = <a href="getbpmtimeconstant.html" class="code" title="function [BPMTimeConstant, WarningFlag] = getbpmtimeconstant(varargin)">getbpmtimeconstant</a>;
1154             fprintf(<span class="string">'   Current Bergoz BPM time constant is %.1fs\n'</span>, BPMtimeconstantOC);
1155 
1156             <span class="comment">% 2 Hz update rate on IDBPMs</span>
1157             disp(<span class="string">'   Bergoz BPM time constant set to 0.5s.'</span>)
1158             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.5)
1159             pause(2);
1160 
1161 
1162             <span class="comment">% Turn off feed forward</span>
1163             fprintf(<span class="string">'   Turning feed forward off.\n'</span>);
1164             [FFEnableBM, FFEnableBC] = <a href="getff.html" class="code" title="function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)">getff</a>;
1165             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0);
1166             scasleep(.2);
1167 
1168 
1169             <span class="comment">% Get vectors</span>
1170             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>);
1171             LocalBumplist = FB.LocalBumplist;
1172 
1173         <span class="keyword">catch</span>
1174 
1175             fprintf(<span class="string">'   %s \n'</span>,lasterr);
1176             fprintf(<span class="string">'   Orbit correction setup failed due to error condition! \n\n'</span>);
1177             setpv(<span class="string">'SR_STATE'</span>,-4);
1178             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1179             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1180             <span class="keyword">if</span> StateNumber &gt;= 0
1181                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1182             <span class="keyword">else</span>
1183                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1184             <span class="keyword">end</span>
1185             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1186 
1187             <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1188             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1189             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1190             <span class="keyword">return</span>
1191         <span class="keyword">end</span>
1192 
1193         iNotHCMChicane = find(FB.HCMlist1(:,2) &lt; 10); <span class="comment">%used by steppv's for setting correctors in loop</span>
1194         iHCMChicane = find(FB.HCMlist1(:,2) == 10);
1195         iNotVCMChicane = find(FB.VCMlist1(:,2) &lt; 10);
1196         iVCMChicane = find(FB.VCMlist1(:,2) == 10);
1197 
1198         fprintf(<span class="string">'   Starting horizontal and vertical global orbit correction (SVD method).\n'</span>);
1199 
1200         <span class="keyword">for</span> iloop = 1:3
1201             <span class="keyword">try</span>
1202                 <span class="comment">% use the following to get corrector settings in OCS without setting them, so the values can be checked</span>
1203                 FB.OCSx = setorbit(FB.OCSx,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1204                 FB.OCSy = setorbit(FB.OCSy,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1205                 <span class="keyword">if</span> any(abs(FB.OCSx.CM.Delta(iNotHCMChicane)) &gt; 5)
1206                   disp(<span class="string">'   Orbit Correction is changing some horizontal corrector(s) &gt; 5A!!'</span>);
1207                 <span class="keyword">end</span>
1208                 <span class="keyword">if</span> any(abs(FB.OCSy.CM.Delta(iNotVCMChicane)) &gt; 5)
1209                   disp(<span class="string">'   Orbit Correction is changing some vertical corrector(s) &gt; 5A!!'</span>);
1210                 <span class="keyword">end</span>
1211                 <span class="keyword">if</span> any(abs(FB.OCSx.CM.Delta(iHCMChicane)) &gt; 10)
1212                   disp(<span class="string">'   Orbit Correction is changing some horizontal chicane corrector(s) &gt; 10A!!'</span>);
1213                 <span class="keyword">end</span>
1214                 <span class="keyword">if</span> any(abs(FB.OCSy.CM.Delta(iVCMChicane)) &gt; 10)
1215                   disp(<span class="string">'   Orbit Correction is changing some vertical chicane corrector(s) &gt; 10A!!'</span>);
1216                 <span class="keyword">end</span>
1217 
1218 
1219                 <span class="comment">% Correct horizontal orbit</span>
1220                 FB.OCSx = setorbit(FB.OCSx,<span class="string">'NoDisplay'</span>);
1221                 <span class="comment">% Correct vertical orbit</span>
1222                 FB.OCSy = setorbit(FB.OCSy,<span class="string">'NoDisplay'</span>);
1223 
1224 
1225                 <span class="comment">% Check for current in machine - stop orbit correction if DCCT &lt; 5mA</span>
1226                 <span class="keyword">if</span> (getdcct &lt; 4.5)
1227                     error(<span class="string">'**There is less than 5mA in the machine! Stopping orbit correction.'</span>);
1228                 <span class="keyword">end</span>
1229 
1230                 <span class="comment">% Check state of gaps - stop orbit correction if any are moving</span>
1231                 GAPrunflag = getpv(<span class="string">'ID'</span>,<span class="string">'RunFlag'</span>);
1232                 <span class="keyword">if</span> any(GAPrunflag-round(GAPrunflag))
1233                     error(<span class="string">'**One or more of the gaps are moving! Stopping orbit correction.'</span>);
1234                 <span class="keyword">end</span>
1235 
1236                 x = FB.OCSx.GoalOrbit - getx(FB.OCSx.BPM.DeviceList);
1237                 y = FB.OCSy.GoalOrbit - gety(FB.OCSy.BPM.DeviceList);
1238                 fprintf(<span class="string">'   %d. Horizontal RMS = %.3f mm\n'</span>, iloop, norm(x)/sqrt(length(x)));
1239                 fprintf(<span class="string">'   %d.   Vertical RMS = %.3f mm\n'</span>, iloop, norm(y)/sqrt(length(y)));
1240 
1241             <span class="keyword">catch</span>
1242                 <span class="comment">% fprintf('   %s \n',lasterr);</span>
1243                 fprintf(<span class="string">'   Orbit correction failed due to error condition!\n  Fix the problem, reload the lattice (srload), and try again.  \n\n'</span>);
1244                 setpv(<span class="string">'SR_STATE'</span>,-4);
1245                 set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1246                 [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1247                 <span class="keyword">if</span> StateNumber &gt;= 0
1248                     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1249                 <span class="keyword">else</span>
1250                     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1251                 <span class="keyword">end</span>
1252                 set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1253 
1254                 <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1255                 <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1256                 fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1257                 <span class="keyword">return</span>
1258             <span class="keyword">end</span>
1259         <span class="keyword">end</span>
1260 
1261 
1262         <span class="comment">% Set user bumps w/o sextupole correctors</span>
1263         <span class="keyword">try</span>
1264 
1265             <span class="comment">%turn up corrector speed here to quicken setting bumps</span>
1266             HCMramprate = getpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>);
1267             VCMramprate = getpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>);
1268             setpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>, 10, [], 0);
1269             setpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>, 10, [], 0);
1270             
1271             <span class="keyword">if</span> ~isempty(LocalBumplist)
1272                 fprintf(<span class="string">'   Setting local bumps in the straight sections.\n'</span>);
1273                 <span class="keyword">for</span> loop = 1:size(LocalBumplist,1)
1274 
1275                     <span class="comment">% Check for current in machine - stop orbit correction if DCCT &lt; 5mA</span>
1276                     <span class="keyword">if</span> (getdcct &lt; 5)
1277                         error(<span class="string">'** There is less than 5mA in the machine! Stopping local bumps.'</span>);
1278                     <span class="keyword">end</span>
1279 
1280                     <span class="comment">% Check state of gaps - stop setting bumps if any are moving</span>
1281                     GAPrunflag = getpv(<span class="string">'ID'</span>,<span class="string">'RunFlag'</span>);
1282                     <span class="keyword">if</span> any(GAPrunflag-round(GAPrunflag))
1283                         error(<span class="string">'** One or more of the gaps are moving! Stopping local bumps.'</span>);
1284                     <span class="keyword">end</span>
1285 
1286                     HCMoldsp = getsp(<span class="string">'HCM'</span>, FB.HCMlist1);
1287                     VCMoldsp = getsp(<span class="string">'VCM'</span>, FB.VCMlist1);
1288 
1289                     <span class="keyword">if</span> any(LocalBumplist(loop,1) == [4 6 11])
1290                         <span class="keyword">if</span> LocalBumplist(loop,2) == 0
1291                             <span class="comment">% Upstream bump</span>
1292                             [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1)-1 11;LocalBumplist(loop,1)-1 12;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1293                             <span class="keyword">if</span> isempty(iRemove)
1294                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1295                             <span class="keyword">else</span>
1296                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1297                             <span class="keyword">end</span>
1298                         <span class="keyword">elseif</span> LocalBumplist(loop,2) == 1
1299                             <span class="comment">% Upstream bump</span>
1300                             [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1)-1 11;],FB.OCSx.BPM.DeviceList);
1301                             <span class="keyword">if</span> isempty(iRemove)
1302                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1303                             <span class="keyword">else</span>
1304                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1305                             <span class="keyword">end</span>
1306                         <span class="keyword">else</span>
1307                             <span class="comment">% Downstream bump</span>
1308                             [i, iRemove] = findrowindex([LocalBumplist(loop,1)-1 12;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1309                             <span class="keyword">if</span> isempty(iRemove)
1310                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1311                             <span class="keyword">else</span>
1312                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1313                             <span class="keyword">end</span>
1314                         <span class="keyword">end</span>
1315                     <span class="keyword">else</span>
1316                         [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1317                         <span class="keyword">if</span> isempty(iRemove)
1318                             <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1319                         <span class="keyword">else</span>
1320                             fprintf(<span class="string">'\n   BPMs missing from Sector %02d - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,1));
1321                         <span class="keyword">end</span>
1322                     <span class="keyword">end</span>
1323                     
1324                     HCMnewsp = getsp(<span class="string">'HCM'</span>, FB.HCMlist1);
1325                     VCMnewsp = getsp(<span class="string">'VCM'</span>, FB.VCMlist1);
1326                     <span class="comment">% Remove center chicane trim from corrector check</span>
1327                     <span class="keyword">if</span> (max(abs(HCMoldsp(iNotHCMChicane)-HCMnewsp(iNotHCMChicane))) &gt; 5) | (max(abs(VCMoldsp(iNotVCMChicane)-VCMnewsp(iNotVCMChicane))) &gt; 10)
1328                         error(<span class="string">'**Setbumps caused some corrector magnet currents to change by more than 5(Horiz)/10(Vert) A!'</span>);
1329                     <span class="keyword">end</span>
1330                     <span class="comment">% Now check center chicane trims</span>
1331                     <span class="keyword">if</span> (max(abs(HCMoldsp(iNotHCMChicane)-HCMnewsp(iNotHCMChicane))) &gt; 10) | (max(abs(VCMoldsp(iNotVCMChicane)-VCMnewsp(iNotVCMChicane))) &gt; 15)
1332                         error(<span class="string">'**Setbumps caused some chicane trim magnet currents to change by more than 10(Horiz)/15(Vert) A!'</span>);
1333                     <span class="keyword">end</span>
1334                 <span class="keyword">end</span>
1335             <span class="keyword">end</span>
1336 
1337             <span class="comment">%restore corrector speeds</span>
1338             setpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>, HCMramprate, [], 0);
1339             setpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>, VCMramprate, [], 0);
1340 
1341         <span class="keyword">catch</span>
1342             fprintf(<span class="string">'   %s \n'</span>,lasterr);
1343             fprintf(<span class="string">'   Setbumps failed due to error condition!  Fix the problem, reload the lattice (srload), and try again.\n\n'</span>);
1344             setpv(<span class="string">'SR_STATE'</span>,-4);
1345             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1346             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1347             <span class="keyword">if</span> StateNumber &gt;= 0
1348                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1349             <span class="keyword">else</span>
1350                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1351             <span class="keyword">end</span>
1352             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1353 
1354             <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1355             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1356             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1357             <span class="keyword">return</span>
1358         <span class="keyword">end</span>
1359 
1360         <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1361         <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1362         fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1363 
1364         <span class="comment">% Turn feed forward back to it's original state</span>
1365         <span class="keyword">if</span> any(FFEnableBC)
1366             fprintf(<span class="string">'   Turning feed forward back on.\n'</span>);
1367             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], FFEnableBC);
1368         <span class="keyword">end</span>
1369 
1370 
1371         a = clock;
1372         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1373         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1374         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1375         <span class="keyword">if</span> StateNumber &gt;= 0
1376             setpv(<span class="string">'SR_STATE'</span>,4.1);
1377             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1378             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1379             fprintf(<span class="string">'   *********************************\n'</span>);
1380             fprintf(<span class="string">'   **  Orbit Correction Complete  **\n'</span>);
1381             fprintf(<span class="string">'   *********************************\n\n'</span>);
1382         <span class="keyword">else</span>
1383             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1384             fprintf(<span class="string">'   *************************************\n'</span>);
1385             fprintf(<span class="string">'   **  Problem With Orbit Correction  **\n'</span>);
1386             fprintf(<span class="string">'   *************************************\n\n'</span>);
1387         <span class="keyword">end</span>
1388         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1389         pause(0);
1390 
1391 
1392     <span class="keyword">case</span> <span class="string">'OrbitCorrectionSetup'</span>
1393         InitFlag = Input2;           <span class="comment">% Input #2: if InitFlag, then initialize variables</span>
1394 
1395         <span class="keyword">if</span> InitFlag
1396             <span class="comment">% Setup feedback elements</span>
1397             <span class="comment">% disp('Orbit correction condition: InitFlag=1 -- debugging message');</span>
1398 
1399             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1400             <span class="comment">% Edit the following lists to change default configuration of Orbit Correction %</span>
1401             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1402             hlist=[];vlist=[];
1403             <span class="keyword">for</span> Sector =1:12
1404                 <span class="keyword">if</span> Sector == 1
1405                     vlist = [vlist;Sector 2;Sector 4;Sector 5;Sector 8];
1406                     hlist = [hlist;Sector 2;Sector 7];
1407                 <span class="keyword">elseif</span> Sector == 3
1408                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];
1409                     hlist = [hlist;Sector 2;Sector 7;Sector 10];
1410                 <span class="keyword">elseif</span> Sector == 5
1411                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];
1412                     hlist = [hlist;Sector 2;Sector 7;Sector 10];
1413 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8]; %remove HCM and VCM(5,10) since corrector is not controlling starting 4-6-07</span>
1414 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7];</span>
1415                 <span class="keyword">elseif</span> Sector == 10
1416                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];
1417                     hlist = [hlist;Sector 2;Sector 7;Sector 10];
1418                 <span class="keyword">elseif</span> Sector == 12
1419                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 7];
1420                     hlist = [hlist;Sector 2;Sector 7];
1421                 <span class="keyword">else</span>
1422                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8];
1423                     hlist = [hlist;Sector 2;Sector 7];
1424                 <span class="keyword">end</span>
1425             <span class="keyword">end</span>
1426             HCMlist1 = hlist;
1427             VCMlist1 = vlist;
1428 
1429             BPMlist1 = [
1430                 1 2
1431                 1 5
1432                 1 6
1433                 1 10
1434                 2 1
1435                 2 5
1436                 2 6
1437                 2 9
1438                 3 2
1439                 3 5
1440                 3 6
1441                 3 10
1442                 3 11
1443                 3 12
1444                 4 1
1445                 4 5
1446                 4 6
1447                 4 10
1448                 5 1
1449                 5 5
1450                 5 6
1451                 5 10
1452                 5 11
1453                 5 12
1454                 6 1
1455                 6 5
1456                 6 6
1457                 6 10
1458                 7 1
1459                 7 5
1460                 7 6
1461                 7 10
1462                 8 1
1463                 8 5
1464                 8 6
1465                 8 10
1466                 9 1
1467                 9 5
1468                 9 6
1469                 9 10
1470                 10 1
1471                 10 5
1472                 10 6
1473                 10 10
1474                 10 11
1475                 10 12
1476                 11 1
1477                 11 5
1478                 11 6
1479                 11 10
1480                 12 1
1481                 12 5
1482                 12 6
1483                 12 9];
1484 
1485             <span class="comment">% SVD orbit correction</span>
1486             Xivec = [1:28];
1487             Yivec = [1:51];
1488 
1489 
1490             LocalBumplist = [
1491               <span class="comment">% 1 1</span>
1492               <span class="comment">% 2 1</span>
1493               <span class="comment">% 3 1</span>
1494                 4 1
1495               <span class="comment">% 4 2</span>
1496                 5 1
1497               <span class="comment">% 6 1</span>
1498               <span class="comment">% 6 2</span>
1499                 7 1
1500                 8 1
1501                 9 1
1502                 10 1
1503                 11 1
1504                 11 2
1505                 12 1
1506 ];
1507             <span class="comment">%LocalBumplist = []</span>
1508             
1509             <span class="comment">% initialize RFCorrFlag</span>
1510             RFCorrFlag = <span class="string">'Yes'</span>;
1511         <span class="keyword">else</span>
1512 
1513             <span class="comment">% Get vectors</span>
1514             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>);
1515             BPMlist1 = FB.BPMlist1;
1516             HCMlist1 = FB.HCMlist1;
1517             VCMlist1 = FB.VCMlist1;
1518             Xivec = FB.Xivec;
1519             Yivec = FB.Yivec;
1520             LocalBumplist = FB.LocalBumplist;
1521             Xgoal = FB.Xgoal;
1522             Ygoal = FB.Ygoal;
1523             RFCorrFlag = FB.RFCorrFlag;
1524 
1525             <span class="comment">% Add button to change #ivectors, CMs, IDBPMs,</span>
1526             EditFlag = 0;
1527             h_fig1 = figure;
1528             <span class="keyword">while</span> EditFlag ~= 8
1529 
1530                 <span class="comment">% Sensitivity matrix</span>
1531                 Sx = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
1532                 Sy = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
1533                 
1534                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1535                 <span class="comment">% Can the call below work for setting FOFB RF parameter? %</span>
1536                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1537                 <span class="keyword">if</span> strcmpi(RFCorrFlag, <span class="string">'Yes'</span>)
1538                     Sx = [Sx getdisp(<span class="string">'BPMx'</span>,BPMlist1)];
1539                 <span class="keyword">end</span>
1540                 
1541                 [Ux, SVx, Vx] = svd(Sx);
1542                 [Uy, SVy, Vy] = svd(Sy);
1543 
1544 
1545                 <span class="comment">% Remove singular values greater than the actual number of singular values</span>
1546                 i = find(Xivec&gt;length(diag(SVx)));
1547                 <span class="keyword">if</span> ~isempty(i)
1548                     disp(<span class="string">'   Horizontal E-vector scaled since there were more elements in the vector than singular values.'</span>);
1549                     pause(0);
1550                     Xivec(i) = [];
1551                 <span class="keyword">end</span>
1552                 i = find(Yivec&gt;length(diag(SVy)));
1553                 <span class="keyword">if</span> ~isempty(i)
1554                     disp(<span class="string">'   Vertical E-vector scaled since there were more elements in the vector than singular values.'</span>);
1555                     pause(0);
1556                     Yivec(i) = [];
1557                 <span class="keyword">end</span>
1558 
1559 
1560                 Ax = Sx*Vx(:,Xivec);
1561                 Tx = inv(Ax'*Ax)*Ax';
1562 
1563                 Ay = Sy*Vy(:,Yivec);
1564                 Ty = inv(Ay'*Ay)*Ay';
1565 
1566 
1567                 figure(h_fig1);
1568                 subplot(2,1,1);
1569                 semilogy(diag(SVx),<span class="string">'b'</span>);
1570                 hold on;
1571                 semilogy(diag(SVx(Xivec,Xivec)),<span class="string">'xr'</span>);
1572                 ylabel(<span class="string">'Horizontal'</span>);
1573                 title(<span class="string">'Response Matrix Singular Values'</span>);
1574                 hold off;
1575                 subplot(2,1,2);
1576                 semilogy(diag(SVy),<span class="string">'b'</span>);
1577                 hold on;
1578                 semilogy(diag(SVy(Yivec,Yivec)),<span class="string">'xr'</span>);
1579                 xlabel(<span class="string">'Singular Value Number'</span>);
1580                 ylabel(<span class="string">'Vertical'</span>);
1581                 hold off;
1582                 drawnow;
1583 
1584                 <span class="keyword">if</span> strcmp(RFCorrFlag,<span class="string">'No'</span>)
1585                     RFCorrState = <span class="string">'NOT CORRECTED'</span>;
1586                 <span class="keyword">elseif</span> strcmp(RFCorrFlag,<span class="string">'Yes'</span>)
1587                     RFCorrState = <span class="string">'CORRECTED'</span>;
1588                 <span class="keyword">else</span>
1589                     RFCorrState = <span class="string">'???'</span>;
1590                 <span class="keyword">end</span>
1591 
1592                 <span class="comment">%         EditFlag = menu('Change Parameters?','Singular Values','HCM List','VCM List','HCM Chicane List','VCM Chicane List','IDBPM List','BBPM List','Change Golden Orbit',...</span>
1593                 <span class="comment">%            'Local Bump List',sprintf('RF Frequency (currently %s)',RFCorrState),'Continue');</span>
1594                 EditFlag = menu(<span class="string">'Change Parameters?'</span>,<span class="string">'Singular Values'</span>,<span class="string">'HCM List'</span>,<span class="string">'VCM List'</span>,<span class="string">'BPM List'</span>,<span class="string">'Change Golden Orbit'</span>,<span class="keyword">...</span>
1595                     <span class="string">'Local Bump List'</span>,sprintf(<span class="string">'RF Frequency (currently %s)'</span>,RFCorrState),<span class="string">'Continue'</span>);
1596 
1597                 <span class="keyword">if</span> EditFlag == 1
1598                     prompt={<span class="string">'Enter the horizontal E-vector numbers (Matlab vector format):'</span>,<span class="string">'Enter the vertical E-vector numbers (Matlab vector format):'</span>};
1599                     def={sprintf(<span class="string">'[%d:%d]'</span>,1,Xivec(end)),sprintf(<span class="string">'[%d:%d]'</span>,1,Yivec(end))};
1600                     titlestr=<span class="string">'SVD Orbit Feedback'</span>;
1601                     lineNo=1;
1602                     answer=inputdlg(prompt,titlestr,lineNo,def);
1603                     <span class="keyword">if</span> ~isempty(answer)
1604                         XivecNew = fix(str2num(answer{1}));
1605                         <span class="keyword">if</span> isempty(XivecNew)
1606                             disp(<span class="string">'   Horizontal E-vector cannot be empty.  No change made.'</span>);
1607                         <span class="keyword">else</span>
1608                             <span class="keyword">if</span> any(XivecNew&lt;=0) | max(XivecNew)&gt;length(diag(SVx))
1609                                 disp(<span class="string">'   Error reading horizontal E-vector.  No change made.'</span>);
1610                             <span class="keyword">else</span>
1611                                 Xivec = XivecNew;
1612                             <span class="keyword">end</span>
1613                         <span class="keyword">end</span>
1614                         YivecNew = fix(str2num(answer{2}));
1615                         <span class="keyword">if</span> isempty(YivecNew)
1616                             disp(<span class="string">'   Vertical E-vector cannot be empty.  No change made.'</span>);
1617                         <span class="keyword">else</span>
1618                             <span class="keyword">if</span> any(YivecNew&lt;=0) | max(YivecNew)&gt;length(diag(SVy))
1619                                 disp(<span class="string">'   Error reading vertical E-vector.  No change made.'</span>);
1620                             <span class="keyword">else</span>
1621                                 Yivec = YivecNew;
1622                             <span class="keyword">end</span>
1623                         <span class="keyword">end</span>
1624                     <span class="keyword">end</span>
1625                 <span class="keyword">end</span>
1626 
1627                 <span class="keyword">if</span> EditFlag == 2
1628                     List = getlist(<span class="string">'HCM'</span>);
1629                     CheckList = zeros(size(List,1));
1630                     Elem = dev2elem(<span class="string">'HCM'</span>, HCMlist1);
1631                     CheckList(Elem) = ones(size(Elem));
1632                     CheckList = CheckList(dev2elem(<span class="string">'HCM'</span>,List));
1633                     newList = editlist(List, <span class="string">'HCM'</span>, CheckList);
1634                     <span class="keyword">if</span> isempty(newList)
1635                         fprintf(<span class="string">'   Horizontal corrector magnet list cannot be empty.  No change made.\n'</span>);
1636                     <span class="keyword">else</span>
1637                         HCMlist1 = newList;
1638                     <span class="keyword">end</span>
1639                 <span class="keyword">end</span>
1640 
1641                 <span class="keyword">if</span> EditFlag == 3
1642                     List = getlist(<span class="string">'VCM'</span>);
1643                     CheckList = zeros(size(List,1));
1644                     Elem = dev2elem(<span class="string">'VCM'</span>, VCMlist1);
1645                     CheckList(Elem) = ones(size(Elem));
1646                     CheckList = CheckList(dev2elem(<span class="string">'VCM'</span>,List));
1647                     newList = editlist(List, <span class="string">'VCM'</span>, CheckList);
1648                     <span class="keyword">if</span> isempty(newList)
1649                         fprintf(<span class="string">'   Vertical corrector magnet cannot be empty.  No change made.\n'</span>);
1650                     <span class="keyword">else</span>
1651                         VCMlist1 = newList;
1652                     <span class="keyword">end</span>
1653                 <span class="keyword">end</span>
1654 
1655                 <span class="keyword">if</span> EditFlag == 4
1656                     ListOld = BPMlist1;
1657                     XgoalOld = Xgoal;
1658                     YgoalOld = Ygoal;
1659 
1660                     <span class="comment">% Full BPM list</span>
1661                     List = [
1662                         1 2
1663                         1 5
1664                         1 6
1665                         1 10
1666                         2 1
1667                         2 5
1668                         2 6
1669                         2 9
1670                         3 2
1671                         3 5
1672                         3 6
1673                         3 10
1674                         3 11
1675                         3 12
1676                         4 1
1677                         4 5
1678                         4 6
1679                         4 10
1680                         5 1
1681                         5 5
1682                         5 6
1683                         5 10
1684                         5 11
1685                         5 12
1686                         6 1
1687                         6 5
1688                         6 6
1689                         6 10
1690                         7 1
1691                         7 5
1692                         7 6
1693                         7 10
1694                         8 1
1695                         8 5
1696                         8 6
1697                         8 10
1698                         9 1
1699                         9 5
1700                         9 6
1701                         9 10
1702                         10 1
1703                         10 5
1704                         10 6
1705                         10 10
1706                         10 11
1707                         10 12
1708                         11 1
1709                         11 5
1710                         11 6
1711                         11 10
1712                         12 1
1713                         12 5
1714                         12 6
1715                         12 9
1716                         ];
1717 
1718                     CheckList = zeros(size(List,1),1);
1719                     <span class="keyword">if</span> ~isempty(BPMlist1)
1720                         <span class="keyword">for</span> i = 1:size(List,1)
1721                             k = find(List(i,1)==BPMlist1(:,1));
1722                             l = find(List(i,2)==BPMlist1(k,2));
1723 
1724                             <span class="keyword">if</span> isempty(k) | isempty(l)
1725                                 <span class="comment">% Item not in list</span>
1726                             <span class="keyword">else</span>
1727                                 CheckList(i) = 1;
1728                             <span class="keyword">end</span>
1729                         <span class="keyword">end</span>
1730                     <span class="keyword">end</span>
1731 
1732                     newList = editlist(List, <span class="string">'BPM'</span>, CheckList);
1733                     <span class="keyword">if</span> isempty(newList)
1734                         fprintf(<span class="string">'   BPM list cannot be empty.  No change made.\n'</span>);
1735                     <span class="keyword">else</span>
1736                         BPMlist1 = newList;
1737                     <span class="keyword">end</span>
1738 
1739                     <span class="comment">% Set the goal orbit to the golden orbit</span>
1740                     Xgoal = getgolden(<span class="string">'BPMx'</span>, BPMlist1);
1741                     Ygoal = getgolden(<span class="string">'BPMy'</span>, BPMlist1);
1742 
1743 
1744                     <span class="comment">% If a new BPM is added, then set the goal orbit to the golden orbit</span>
1745                     <span class="keyword">for</span> i = 1:size(BPMlist1,1)
1746 
1747                         <span class="comment">% Is it a new BPM?</span>
1748                         k = find(BPMlist1(i,1)==ListOld(:,1));
1749                         l = find(BPMlist1(i,2)==ListOld(k,2));
1750 
1751                         <span class="keyword">if</span> isempty(k) | isempty(l)
1752                             <span class="comment">% New BPM</span>
1753                         <span class="keyword">else</span>
1754                             <span class="comment">% Use the old value for old BPM</span>
1755                             Xgoal(i) = XgoalOld(k(l));
1756                             Ygoal(i) = YgoalOld(k(l));
1757                         <span class="keyword">end</span>
1758                     <span class="keyword">end</span>
1759                 <span class="keyword">end</span>
1760 
1761                 <span class="keyword">if</span> EditFlag == 5
1762 
1763                     ChangeList = editlist(BPMlist1, <span class="string">'Change BPM'</span>, zeros(size(BPMlist1,1),1));
1764                     <span class="keyword">for</span> i = 1:size(ChangeList,1)
1765 
1766                         k = find(ChangeList(i,1)==BPMlist1(:,1));
1767                         l = find(ChangeList(i,2)==BPMlist1(k,2));
1768 
1769                         prompt = {sprintf(<span class="string">'Enter the new horizontal goal orbit for BPMx(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2)),sprintf(<span class="string">'Enter the new vertical goal orbit for BPMy(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2))};
1770                         def = {sprintf(<span class="string">'%f'</span>,Xgoal(k(l))),sprintf(<span class="string">'%f'</span>,Ygoal(k(l)))};
1771                         titlestr = <span class="string">'CHANGE THE GOAL ORBIT'</span>;
1772                         lineNo = 1;
1773                         answer = inputdlg(prompt, titlestr, lineNo, def);
1774 
1775                         <span class="keyword">if</span> isempty(answer)
1776                             <span class="comment">% No change</span>
1777                             fprintf(<span class="string">'   No change was made to the golden orbit.\n'</span>);
1778                         <span class="keyword">else</span>
1779                             Xgoalnew = str2num(answer{1});
1780                             <span class="keyword">if</span> isempty(Xgoalnew)
1781                                 fprintf(<span class="string">'   No change was made to the horizontal golden orbit.\n'</span>);
1782                             <span class="keyword">else</span>
1783                                 Xgoal(k(l)) = Xgoalnew;
1784                             <span class="keyword">end</span>
1785 
1786                             Ygoalnew = str2num(answer{2});
1787                             <span class="keyword">if</span> isempty(Ygoalnew)
1788                                 fprintf(<span class="string">'   No change was made to the vertical golden orbit.\n'</span>);
1789                             <span class="keyword">else</span>
1790                                 Ygoal(k(l)) = Ygoalnew;
1791                             <span class="keyword">end</span>
1792                         <span class="keyword">end</span>
1793                     <span class="keyword">end</span>
1794                     <span class="keyword">if</span> ~isempty(ChangeList)
1795                         fprintf(<span class="string">'   Note:  changing the goal orbit for &quot;Orbit Correction&quot; does not change the goal orbit for &quot;Slow Orbit Feedback.&quot;\n'</span>);
1796                         fprintf(<span class="string">'          Re-running srcontrol will restart the goal orbit to the golden orbit.&quot;\n'</span>);
1797                     <span class="keyword">end</span>
1798                 <span class="keyword">end</span>
1799 
1800                 <span class="keyword">if</span> EditFlag == 6
1801                     List = [
1802                         1 1
1803                         2 1
1804                         3 1
1805                         4 1
1806                         4 2
1807                         5 1
1808                         6 1
1809                         6 2
1810                         7 1
1811                         8 1
1812                         9 1
1813                         10 1
1814                         11 1
1815                         11 2
1816                         12 1];
1817                     CheckList = zeros(size(List,1),1);
1818                     <span class="keyword">if</span> ~isempty(LocalBumplist)
1819                         <span class="keyword">for</span> i = 1:size(List,1)
1820                             k = find(List(i,1)==LocalBumplist(:,1));
1821                             l = find(List(i,2)==LocalBumplist(k,2));
1822 
1823                             <span class="keyword">if</span> isempty(k) | isempty(l)
1824                                 <span class="comment">% Item not in list</span>
1825                             <span class="keyword">else</span>
1826                                 CheckList(i) = 1;
1827                             <span class="keyword">end</span>
1828                         <span class="keyword">end</span>
1829                     <span class="keyword">end</span>
1830                     LocalBumplist = editlist2(List, <span class="string">'Sector'</span>, CheckList);
1831                 <span class="keyword">end</span>
1832 
1833                 <span class="keyword">if</span> EditFlag == 7
1834                     RFCorrFlag = questdlg(sprintf(<span class="string">'Set RF Frequency during Orbit Correction?'</span>),<span class="string">'RF Frequency'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>, <span class="string">'No'</span>);
1835                     <span class="keyword">if</span> strcmp(RFCorrFlag,<span class="string">'No'</span>)
1836                         disp([<span class="string">'   RF Frequency will not be included in global orbit correction.'</span>]);
1837                     <span class="keyword">elseif</span> strcmp(RFCorrFlag,<span class="string">'Yes'</span>)
1838                         disp([<span class="string">'   RF Frequency will be included in global orbit correction.'</span>]);
1839                     <span class="keyword">end</span>
1840 
1841                 <span class="keyword">end</span>
1842             <span class="keyword">end</span>
1843             close(h_fig1);
1844         <span class="keyword">end</span>
1845         
1846 <span class="comment">%  ORBIT CORRECTION STRUCTURE (OCS)</span>
1847 <span class="comment">%    OCS.BPM (data structure)</span>
1848 <span class="comment">%    OCS.CM  (data structure)</span>
1849 <span class="comment">%    OCS.GoalOrbit</span>
1850 <span class="comment">%    OCS.NIter</span>
1851 <span class="comment">%    OCS.SVDIndex</span>
1852 <span class="comment">%    OCS.IncrementalFlag = 'Yes'/'No'</span>
1853 <span class="comment">%    OCS.BPMWeight</span>
1854 <span class="comment">%    OCS.Flags = { 'FitRF' , etc.  }</span>
1855         OCSx.BPM = getx(BPMlist1, <span class="string">'struct'</span>);
1856         OCSx.CM = getsp(<span class="string">'HCM'</span>, HCMlist1, <span class="string">'struct'</span>);
1857         OCSx.GoalOrbit = getgolden(OCSx.BPM, <span class="string">'numeric'</span>);
1858         OCSx.NIter = 1;
1859         OCSx.SVDIndex = Xivec;
1860         OCSx.IncrementalFlag = <span class="string">'No'</span>;
1861         OCSx.FitRF = 1;
1862         OCSy.BPM = gety(BPMlist1, <span class="string">'struct'</span>);
1863         OCSy.CM = getsp(<span class="string">'VCM'</span>, VCMlist1, <span class="string">'struct'</span>);
1864         OCSy.GoalOrbit = getgolden(OCSy.BPM, <span class="string">'numeric'</span>);
1865         OCSy.NIter = 1;
1866         OCSy.SVDIndex = Yivec;
1867         OCSy.IncrementalFlag = <span class="string">'No'</span>;
1868         OCSy.FitRF = 0;
1869 
1870         <span class="comment">% Save vectors</span>
1871         FB.OCSx = OCSx;
1872         FB.OCSy = OCSy;
1873 
1874         FB.BPMlist1 = BPMlist1;
1875         FB.HCMlist1 = HCMlist1;
1876         FB.VCMlist1 = VCMlist1;
1877         FB.Xivec = Xivec;
1878         FB.Yivec = Yivec;
1879         FB.Xgoal = OCSx.GoalOrbit;
1880         FB.Ygoal = OCSy.GoalOrbit;
1881         FB.RFCorrFlag = RFCorrFlag;
1882         FB.LocalBumplist = LocalBumplist;
1883         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>,FB);
1884         
1885         
1886     <span class="keyword">case</span> <span class="string">'Feedback'</span>
1887 
1888         FBloopIter = 1;
1889         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxFOFB'</span>),<span class="string">'Value'</span>) == 1
1890             StartFOFBFlag = 1;
1891         <span class="keyword">else</span>
1892             StartFOFBFlag = 0;
1893         <span class="keyword">end</span>
1894 
1895         FEEDBACK_STOP_FLAG = 0;
1896         HWarnNum=0;
1897         VWarnNum=0;
1898 
1899         SR_GeV = getenergy;
1900         <span class="comment">% Feedback loop setup</span>
1901         PlotInfoFlag = 0;           <span class="comment">% Plot micado stuff</span>
1902         LoopDelay = 1.0;           <span class="comment">% Period of feedback loop [seconds], make sure the BPM averaging is correct</span>
1903         VCM_LSB = .00366211;
1904         VCMCHICANE_LSB = .002441;   <span class="comment">% 80 max?,  Note: not fully implemented</span>
1905 
1906         <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
1907             Xgain  = 0.2;
1908             Ygain  = 0.1;
1909         <span class="keyword">else</span>
1910             Xgain  = 0.8; <span class="comment">% raised 0.5-&gt;0.8 at 17:20, 3-2-05 to more quickly correct EPU4 fast switching orbit distortions</span>
1911             Ygain  = 0.8;
1912         <span class="keyword">end</span>
1913 
1914         <span class="comment">% Load lattice set for tune feed forward</span>
1915         ConfigSetpoint = getproductionlattice;
1916         <span class="comment">%load([getfamilydata('Directory','OpsData') getfamilydata('OpsData','LatticeFile')]);</span>
1917         QFsp = ConfigSetpoint.QF.Setpoint.Data;
1918         QDsp = ConfigSetpoint.QD.Setpoint.Data;
1919         TuneW16Min = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(5, 13.23, 1.8909);
1920         <span class="comment">% Tune response matrix</span>
1921         SR_TUNE_MATRIX = gettuneresp({<span class="string">'QF'</span>,<span class="string">'QD'</span>}, {[],[]}, getenergy(<span class="string">'Production'</span>));    <span class="comment">% Approx. [0.1944 -0.0286;-0.1182 0.1526];</span>
1922         <span class="comment">%SR_TUNE_MATRIX = [0.1641 -0.0245</span>
1923         <span class="comment">%                 -0.1149 0.1477];</span>
1924 
1925         <span class="comment">%SQSFindex = [1 1; 3 1; 3 2; 5 1; 6 1; 6 2; 7 2; 9 1; 11 1];</span>
1926           <span class="comment">%SQSFind = [1 2 3 4 6 7 9 10 11];</span>
1927           HCSFindex = [5 2;7 1];
1928           HCSFind = [33 48];
1929           <span class="comment">%SQSDindex = [2 1; 3 1; 3 2; 4 1; 6 1; 6 2; 7 1; 7 2; 8 1; 10 1; 12 1];</span>
1930           <span class="comment">%SQSDind = [12 13 14 15 18 19 20 21 22 23 24];</span>
1931           HCSDindex = [5 1;5 2];
1932         HCSDind = [32 33];
1933         SQSFsp = ConfigSetpoint.SQSF.Setpoint.Data;
1934         SQSDsp = ConfigSetpoint.SQSD.Setpoint.Data;
1935         HCSFsp = ConfigSetpoint.HCM.Setpoint.Data(HCSFind);
1936         HCSDsp = ConfigSetpoint.HCM.Setpoint.Data(HCSDind);
1937         
1938         <span class="comment">% ID tune compensation does not work in the injection lattice, so ...</span>
1939         <span class="keyword">if</span> abs(SR_GEV - <a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>)&gt;  0.05     <span class="comment">% Don't use this routine for the injection lattice</span>
1940             fprintf(<span class="string">'   This routine should only be used for the production energy: Orbit feedback aborted\n'</span>);
1941             <span class="keyword">return</span>
1942         <span class="keyword">end</span>
1943 
1944         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1945 
1946         <span class="keyword">try</span>
1947             fprintf(<span class="string">'\n'</span>);
1948             fprintf(<span class="string">'   *******************************\n'</span>);
1949             fprintf(<span class="string">'   **  Starting Orbit Feedback  **\n'</span>);
1950             fprintf(<span class="string">'   *******************************\n'</span>);
1951             a = clock;
1952             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1953             fprintf(<span class="string">'   Note: the Matlab command window will be used to display status information.\n'</span>);
1954             fprintf(<span class="string">'         It cannot be used to enter commands during slow orbit feedback.\n'</span>);
1955 
1956 
1957                 <span class="comment">% save current BPM timeconstant - will reset to this when feedback stops</span>
1958                 BPMtimeconstantOFB = <a href="getbpmtimeconstant.html" class="code" title="function [BPMTimeConstant, WarningFlag] = getbpmtimeconstant(varargin)">getbpmtimeconstant</a>;
1959                 fprintf(<span class="string">'   Current Bergoz BPM time constant is %.1fs\n'</span>, BPMtimeconstantOFB);
1960                 
1961             <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
1962             disp(<span class="string">'   Bergoz BPM time constant set to 0.2s.'</span>)
1963             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.2)
1964             pause(1.1);
1965 
1966             <span class="comment">% Check whether bumps and kickers are on and warn to turn off before starting feedback if necessary</span>
1967             <span class="keyword">try</span>
1968                 <span class="keyword">if</span> (getsp(<span class="string">'SR01S___BUMP1__BC21'</span>)==1 &amp; getsp(<span class="string">'SR01S___BUMP1P_BC22'</span>)==1) | (getsp(<span class="string">'SR01S___SEK____BC21'</span>)==1 &amp; getsp(<span class="string">'SR01S___SEK_P__BC23'</span>)==1) | (getsp(<span class="string">'SR01S___SEN____BC20'</span>)==1 &amp; getsp(<span class="string">'SR01S___SEN_P__BC22'</span>)==1)
1969                     soundtada;
1970                     fprintf(<span class="string">'   \n'</span>);
1971                     fprintf(<span class="string">'   *********************************************************************************\n'</span>);
1972                     fprintf(<span class="string">'   ** One or more of the pulsed SR injection magnets is still on!  Turn them off! **\n'</span>);
1973                     fprintf(<span class="string">'   *********************************************************************************\n'</span>);
1974                     fprintf(<span class="string">'   \n'</span>);
1975                 <span class="keyword">end</span>
1976             <span class="keyword">catch</span>
1977                 disp(<span class="string">'**Problem checking the state of the bumps and kickers - please check that they are not pulsing.'</span>);
1978             <span class="keyword">end</span>
1979 
1980             <span class="comment">% Get vectors</span>
1981 
1982             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
1983 
1984             BPMlist1 = FB.OCSx.BPM.DeviceList;
1985             <span class="comment">% FOFB_BPMlist =</span>
1986             HCMlist1 = FB.HCMlist1;
1987             VCMlist1 = FB.VCMlist1;
1988             Xivec = FB.Xivec;
1989             Yivec = FB.Yivec;
1990             Xgoal = FB.OCSx.GoalOrbit;
1991             Ygoal = FB.OCSy.GoalOrbit;
1992             FFTypeFlag = FB.FFTypeFlag;   <span class="comment">%local or global tune correction</span>
1993 
1994             iNotHCMChicane = find(HCMlist1(:,2) &lt; 10); <span class="comment">%used by steppv's for setting correctors in loop</span>
1995             iHCMChicane = find(HCMlist1(:,2) == 10);
1996             iNotVCMChicane = find(VCMlist1(:,2) &lt; 10);
1997             iVCMChicane = find(VCMlist1(:,2) == 10);
1998 
1999             <span class="comment">% Sensitivity matrix for setting fast feedback setpoints</span>
2000             Sx1 = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
2001             Sy1 = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
2002 
2003         <span class="keyword">catch</span>
2004             fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
2005 
2006             <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2007             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2008             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2009 
2010 
2011             a = clock;
2012             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2013             fprintf(<span class="string">'   *************************************************************\n'</span>);
2014             fprintf(<span class="string">'   **  Orbit feedback could not start due to error condition  **\n'</span>);
2015             fprintf(<span class="string">'   *************************************************************\n\n'</span>);
2016             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
2017             pause(0);
2018 
2019             <span class="keyword">return</span>
2020         <span class="keyword">end</span>
2021 
2022         StartFlag = questdlg(strvcat(<span class="string">''</span>,<span class="string">'Is it OK to start orbit feedback?'</span>),<span class="string">'Orbit Feedback'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
2023         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
2024             <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2025             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2026             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2027 
2028             a = clock;
2029             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2030             fprintf(<span class="string">'   ***************************\n'</span>);
2031             fprintf(<span class="string">'   **  Orbit Feedback Exit  **\n'</span>);
2032             fprintf(<span class="string">'   ***************************\n\n'</span>);
2033             pause(0);
2034             <span class="keyword">return</span>
2035         <span class="keyword">end</span>
2036 
2037         SR_STATE_OLD = scaget(<span class="string">'SR_STATE'</span>);
2038         setpv(<span class="string">'SR_STATE'</span>, 5);
2039         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
2040         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2041         <span class="keyword">if</span> StateNumber &gt;= 0
2042             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2043         <span class="keyword">else</span>
2044             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2045         <span class="keyword">end</span>
2046         fprintf(<span class="string">'   Using %d E-vectors horizontally.\n'</span>, length(Xivec));
2047         fprintf(<span class="string">'   Using %d E-vectors vertically.\n'</span>,   length(Yivec));
2048         fprintf(<span class="string">'   Starting slow orbit correction every %.1f seconds.\n'</span>, LoopDelay);
2049         <span class="comment">%  fprintf('   Resetting SR11 chicane motors every 20 seconds to fix drift problem.\n');</span>
2050 
2051         IDSector = getlist(<span class="string">'ID'</span>);
2052         EPUlist = find((IDSector(:,1)==4) | (IDSector(:,1)==11));
2053         oldgap=210*ones(size(IDSector,1),1);
2054         oldShift=zeros(size(oldgap));
2055           
2056         <span class="keyword">try</span>
2057             
2058             <span class="comment">% Get and display data</span>
2059             x = FB.OCSx.GoalOrbit - getx(FB.OCSx.BPM.DeviceList);
2060             y = FB.OCSy.GoalOrbit - gety(FB.OCSy.BPM.DeviceList);
2061             STDx = norm(x)/sqrt(length(x));
2062             STDy = norm(y)/sqrt(length(y));
2063             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = %.4f mm'</span>,STDx),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2064             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = %.4f mm'</span>,STDy),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2065 
2066             <span class="comment">% write goldenorbit values to Fast Orbit Feedback</span>
2067             <span class="keyword">try</span>
2068                 <a href="write_goldenorbit_ffb.html" class="code" title="function write_goldenorbit_ffb">write_goldenorbit_ffb</a>;
2069             <span class="keyword">catch</span>
2070                 disp(<span class="string">'write_goldenorbit_ffb did not work!'</span>);
2071             <span class="keyword">end</span>
2072             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2073             <span class="comment">%pause(0);</span>
2074 
2075             <span class="comment">%display state of FOFB system</span>
2076             FOFBStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2077                 getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2078                 getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2079                 getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2080             FOFBStatusStr = [<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>];
2081             <span class="keyword">for</span> loop = 1:size(FOFBStatus,2)
2082                 <span class="keyword">if</span> FOFBStatus(loop)==0
2083                     FOFBStatusStr(loop,:) = <span class="string">'OFF '</span>;
2084                 <span class="keyword">elseif</span> FOFBStatus(loop)==1
2085                     FOFBStatusStr(loop,:) = <span class="string">'ON  '</span>;
2086                 <span class="keyword">elseif</span> FOFBStatus(loop)==2
2087                     FOFBStatusStr(loop,:) = <span class="string">'OPEN'</span>;
2088                 <span class="keyword">else</span>
2089                     FOFBStatusStr(loop,:) = <span class="string">'BAD '</span>;
2090                 <span class="keyword">end</span>
2091             <span class="keyword">end</span>
2092             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 %s'</span>,FOFBStatusStr(1,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2093             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 %s'</span>,FOFBStatusStr(2,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2094             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 %s'</span>,FOFBStatusStr(3,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2095             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 %s'</span>,FOFBStatusStr(4,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2096             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 %s'</span>,FOFBStatusStr(5,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2097             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 %s'</span>,FOFBStatusStr(6,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2098             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 %s'</span>,FOFBStatusStr(7,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2099             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 %s'</span>,FOFBStatusStr(8,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2100             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 %s'</span>,FOFBStatusStr(9,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2101             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 %s'</span>,FOFBStatusStr(10,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2102             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 %s'</span>,FOFBStatusStr(11,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2103             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 %s'</span>,FOFBStatusStr(12,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2104 
2105         <span class="keyword">catch</span>
2106 
2107             fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
2108 
2109             <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2110             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2111             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2112 
2113 
2114             a = clock;
2115             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2116             fprintf(<span class="string">'   *************************************************************\n'</span>);
2117             fprintf(<span class="string">'   **  Orbit feedback could not start due to error condition  **\n'</span>);
2118             fprintf(<span class="string">'   *************************************************************\n\n'</span>);
2119 
2120             setpv(<span class="string">'SR_STATE'</span>,SR_STATE_OLD);
2121             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2122             <span class="keyword">if</span> StateNumber &gt;= 0
2123                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2124             <span class="keyword">else</span>
2125                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2126             <span class="keyword">end</span>
2127             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
2128             pause(0);
2129 
2130             <span class="keyword">return</span>
2131 
2132         <span class="keyword">end</span>
2133 
2134 
2135         <span class="comment">% Disable buttons</span>
2136         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
2137         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2138         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2139         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2140         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2141         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2142         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2143         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2144         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2145         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2146         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2147         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2148         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2149         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2150         pause(0);
2151 
2152 
2153         <span class="comment">% Initialize feedback loop</span>
2154         StartTime = gettime;
2155         StartErrorTime = gettime;
2156         Xold = getx(FB.OCSx.BPM.DeviceList);
2157         Yold = gety(FB.OCSy.BPM.DeviceList);
2158         HQMOFM_stalenum = 0;
2159         pause(LoopDelay);
2160 
2161         N_HCM = size(HCMlist1,1);
2162         N_VCM = size(VCMlist1,1);
2163 
2164         N_RFMO = 1;
2165 
2166         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
2167             [FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,<span class="string">'SetRF'</span>,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2168         <span class="keyword">else</span>
2169             [FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2170         <span class="keyword">end</span>
2171         [FB.OCSx, Smatx, Sx, Ux, Vx] = orbitcorrectionmethods(FB.OCSx);
2172 
2173         [FB.OCSy, junk, OCSy0] = setorbit(FB.OCSy,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2174         [FB.OCSy, Smaty, Sy, Uy, Vy] = orbitcorrectionmethods(FB.OCSy);
2175 
2176 
2177         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2178         <span class="comment">% Start feedback loop %</span>
2179         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2180 
2181         <span class="comment">% chicaneloop=1;  % loop variable for resetting drifting chicanes (see a few lines below)</span>
2182         <span class="comment">% fftest=figure;</span>
2183 
2184         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2); <span class="comment">% put FOFB in open loop so beamnoise gets recorded even if FOFB is not enabled</span>
2185 
2186         <span class="keyword">while</span> 1
2187             <span class="keyword">try</span>
2188                 t00 = gettime;
2189 
2190                 <span class="comment">%          if chicaneloop==20 % reset SR11 motor chicane setpoints every 20s due to drifting positions</span>
2191                 <span class="comment">%             setsp('HCMCHICANEM',HCMCHICANEMsp(6),[11 1],0);</span>
2192                 <span class="comment">%             setsp('HCMCHICANEM',HCMCHICANEMsp(7),[11 2],0);</span>
2193                 <span class="comment">%             chicaneloop = 1;</span>
2194                 <span class="comment">%          else</span>
2195                 <span class="comment">%             chicaneloop = chicaneloop + 1;</span>
2196                 <span class="comment">%          end</span>
2197 
2198                 <span class="comment">% Check if GUI has been closed</span>
2199                 <span class="keyword">if</span> isempty(gcbf)
2200                     FEEDBACK_STOP_FLAG = 1;
2201                     lasterr(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2202                     error(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2203                 <span class="keyword">end</span>
2204 
2205                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2206                 <span class="comment">% Fast orbit feedback %</span>
2207                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2208                 <span class="keyword">if</span> StartFOFBFlag == 1 &amp; FBloopIter &gt; 3
2209                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2210                     pause(0.5);
2211                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,1);
2212                     StartFOFBFlag = 0;
2213                     pause(1);
2214                     FOFBOnStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2215                         getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2216                         getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2217                         getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2218                     <span class="keyword">if</span> any(FOFBOnStatus==0) | any(FOFBOnStatus==2)
2219                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2); <span class="comment">% open FOFB loop</span>
2220                         disp(<span class="string">'************************************************************************************************************'</span>);
2221                         disp(<span class="string">'** Problem turning on Fast Orbit Feedback system...                                                       **'</span>);
2222                         disp(<span class="string">'** Check status of ffbsecXX crates - but remember that a crate reboot will turn off Quads in that sector! **'</span>);
2223                         disp(<span class="string">'** Suggest disabling the &quot;Fast Orbit Correction&quot; checkbox and starting Orbit Feedback again.              **'</span>);
2224                         disp(<span class="string">'************************************************************************************************************'</span>);
2225                     <span class="keyword">else</span>
2226                         fprintf(<span class="string">'   Starting Fast Orbit Feedback at %.0f Hz.\n'</span>, getpv(<span class="string">'SR01____FFBFREQAM00'</span>));
2227                     <span class="keyword">end</span>
2228                 <span class="keyword">end</span>
2229 
2230 
2231                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2232                 <span class="comment">% Horizontal plane &quot;feedback&quot; %</span>
2233                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2234 
2235                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxSOFB'</span>),<span class="string">'Value'</span>) == 1
2236 
2237                     <span class="comment">% Get orbit and check that the BPMs are different from the last update</span>
2238                     Xnew = getx(FB.OCSx.BPM.DeviceList);
2239 
2240                     <span class="comment">% Don't feedback if the current is too small</span>
2241                     <span class="keyword">if</span> getdcct &lt; 5
2242                         FEEDBACK_STOP_FLAG = 1;
2243                         fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2244                         <span class="keyword">break</span>;
2245                     <span class="keyword">end</span>
2246 
2247                     x = Xgoal - Xnew;
2248                     STDx = norm(x)/sqrt(length(x));
2249 
2250                     <span class="keyword">if</span> any(Xold == Xnew)
2251                         a = clock;
2252                         N_Stale_Data_Points = find((Xold==Xnew)==1);
2253                         <span class="keyword">for</span> loop = N_Stale_Data_Points'
2254                             fprintf(<span class="string">'   Stale data: BPMx(%2d,%d), feedback step skipped (%s %d:%d:%.0f). \n'</span>, FB.OCSx.BPM.DeviceList(loop,1), FB.OCSx.BPM.DeviceList(loop,2), date, a(4), a(5), a(6));
2255                         <span class="keyword">end</span>
2256                     <span class="keyword">else</span>
2257                         <span class="comment">% Compute horizontal correction</span>
2258                         <span class="comment">%%%OCSx0 = FB.OCSx;</span>
2259                         FB.OCSx.BPM.Data = Xnew;
2260                         FB.OCSx = orbitcorrectionmethods(FB.OCSx, Smatx, Sx, Ux, Vx);
2261 
2262                         <span class="comment">%%%[FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,'Nodisplay','Nosetsp');</span>
2263 
2264                         <span class="comment">% reduced feedback gain (implemented by Greg Portmann, December 2000)</span>
2265                         <span class="comment">% reduced to 0.1, C. Steier, 2001-09-04, IDBPMs are noisy at the moment</span>
2266                         <span class="comment">% increased back to 0.8 C. Steier, 2001-09-29, IDBPMs filtering + direct DAC read/write + all SVDs (no arc BPMs)</span>
2267                         <span class="comment">% increased to 1.0, C. Steier, 2002-05-04, trim DACs</span>
2268                         X = Xgain .* FB.OCSx.CM.Delta;
2269                         X(N_HCM+1) = 0.3*FB.OCSx.DeltaRF/4.988e-3;
2270                         <span class="comment">%%%X = Xgain .* (FB.OCSx.CM.Data - OCSx0.CM.Data);</span>
2271 
2272                         <span class="comment">% check for trim values+next step values, warn or stop FB as necessary</span>
2273                         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2274                         <span class="comment">% need to extract Chicanes from this comparison or maybe check them first for range %</span>
2275                         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2276                         HCMtrimSP=getpv(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1);
2277                         HCMtrimSP_next = HCMtrimSP + X(1:N_HCM);
2278                         <span class="keyword">if</span> max(abs(HCMtrimSP_next)) &gt; 4
2279                             HCMtrimnum=find(abs(HCMtrimSP_next) &gt; 4);
2280 
2281                             <span class="comment">% print message to screen</span>
2282                             fprintf(<span class="string">'**One or more of the horizontal correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2283                             fprintf(<span class="string">'%s\n'</span>,datestr(now));
2284                             <span class="keyword">for</span> loop = HCMtrimnum'
2285                                 fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1(loop,:)));
2286                             <span class="keyword">end</span>
2287 
2288                             <span class="comment">% send alphapage to operator pager</span>
2289                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2290                             FEEDBACK_STOP_FLAG = 1;
2291 
2292                             setpv(<span class="string">'SR_STATE'</span>, -5);
2293                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2294                             <span class="keyword">if</span> StateNumber &gt;= 0
2295                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2296                             <span class="keyword">else</span>
2297                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2298                             <span class="keyword">end</span>
2299                         <span class="keyword">end</span>
2300 
2301                         <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2302                             <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2303                             <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2304                                 disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2305                             <span class="keyword">end</span>
2306                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2307                             pause(0.5);
2308                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2309                             <span class="keyword">break</span>;
2310                         <span class="keyword">end</span>
2311 
2312                         <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2313                         pause(0);
2314 
2315                         <span class="keyword">if</span> max(abs(HCMtrimSP_next) &gt; 3)
2316                             HCMtrimnum=find(abs(HCMtrimSP_next) &gt; 3);
2317                             HWarnNum=HWarnNum+1;
2318                             <span class="keyword">if</span> (HWarnNum==1 | rem(HWarnNum,120)==0)
2319 
2320                                 <span class="comment">% print message to screen every two minutes</span>
2321                                 fprintf(<span class="string">'**One or more of the horizontal corrector trims is above 3A or below -3A! \n'</span>);
2322                                 fprintf(<span class="string">'%s\n'</span>,datestr(now));
2323                                 <span class="keyword">for</span> loop = HCMtrimnum'
2324                                     fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1(loop,:)));
2325                                 <span class="keyword">end</span>
2326                                 fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2327 
2328                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2329                                 <span class="keyword">if</span> (HWarnNum==1 | HWarnNum==600)
2330                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageHCM.txt
2331                                 <span class="keyword">end</span>
2332                             <span class="keyword">end</span>
2333                         <span class="keyword">else</span>
2334                             HWarnNum=0;
2335                         <span class="keyword">end</span>
2336 
2337                         <span class="comment">% Don't feedback if the current is too small</span>
2338                         <span class="keyword">if</span> getdcct &lt; 5
2339                             FEEDBACK_STOP_FLAG = 1;
2340                             fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2341                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/beamisoff.txt
2342                             <span class="keyword">break</span>;
2343                         <span class="keyword">end</span>
2344 
2345                         <span class="keyword">if</span> N_HCM &gt; 0
2346                             steppv(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>, X(iNotHCMChicane), HCMlist1(iNotHCMChicane,:), 0);
2347                             steppv(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>, X(iHCMChicane), HCMlist1(iHCMChicane,:), 0);
2348                         <span class="keyword">end</span>
2349 
2350                         <span class="comment">% write fast orbit feedback setpoints</span>
2351                         <span class="keyword">if</span> 1
2352                             <span class="comment">%write_goldenorbit_ffb_2planes(1, Xnew(1:size(BPMlist1,1))+Sx1*X(1:N_HCM)+Sx3*X(length(X))/20, BPMlist1);</span>
2353                             <span class="comment">% should be corrected to include result of next frequency step ...</span>
2354                             <a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>(1,Xnew(1:size(BPMlist1,1))+Sx1*X(1:N_HCM),BPMlist1);
2355                         <span class="keyword">end</span>
2356 
2357                         <span class="comment">%fprintf('Horizontal Done: %f \n',gettime-t00);</span>
2358 
2359                         <span class="comment">% RF feedback</span>
2360                         HQMOFMsp_last = getpv(<span class="string">'EG______HQMOFM_AC01'</span>);
2361 
2362                         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
2363                             <span class="keyword">if</span> N_RFMO &gt; 0
2364                                 <span class="keyword">if</span> abs(X(end)/3) &lt; .01
2365                                     <span class="comment">% if abs(FB.OCSx.DeltaRF/3) &lt; .01</span>
2366                                     steppv(<span class="string">'EG______HQMOFM_AC01'</span>, X(end));
2367                                 <span class="keyword">else</span>
2368                                     steppv(<span class="string">'EG______HQMOFM_AC01'</span>, 0.01*sign(X(end)));
2369                                 <span class="keyword">end</span>
2370                             <span class="keyword">end</span>
2371 
2372                             HQMOFMsp_now = getpv(<span class="string">'EG______HQMOFM_AC01'</span>);
2373 
2374                             <span class="comment">% Check for stale RF feedback</span>
2375                             <span class="keyword">if</span> HQMOFMsp_last == HQMOFMsp_now
2376                                 HQMOFM_stalenum = HQMOFM_stalenum + 1;
2377                                 <span class="keyword">if</span> HQMOFM_stalenum == 30 <span class="comment">% warn and message to pager if stale for 30 secs</span>
2378                                     fprintf(<span class="string">'**The RF is not responding to orbit feedback changes! \n'</span>);
2379                                     fprintf(<span class="string">'%s\n'</span>,datestr(now));
2380                                     fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2381                                     fprintf(<span class="string">'**ILC 73 controls the EG______HQMOFM_AC01 channel, which sets the RF frequency. \n'</span>);
2382                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstaleRFmessage.txt
2383                                 <span class="keyword">end</span>
2384                                 <span class="keyword">if</span> rem(HQMOFM_stalenum,120)==0 <span class="comment">% message to screen every 2 minutes</span>
2385                                     fprintf(<span class="string">'**The RF is not responding to orbit feedback changes! (%s)\n'</span>,datestr(now));
2386                                 <span class="keyword">end</span>
2387                             <span class="keyword">else</span>
2388                                 HQMOFM_stalenum = 0;
2389                             <span class="keyword">end</span>
2390 
2391                         <span class="keyword">end</span>
2392 
2393                         <span class="comment">%fprintf('RF Done: %f \n',gettime-t00);</span>
2394 
2395                         Xold = Xnew;
2396                     <span class="keyword">end</span> <span class="comment">% End horizontal correction</span>
2397 
2398 
2399                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2400                     <span class="comment">% Vertical plane &quot;feedback&quot; %</span>
2401                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2402 
2403                     <span class="comment">% Get orbit and check that the BPMs are different from the last update</span>
2404                     Ynew = gety(FB.OCSy.BPM.DeviceList);
2405 
2406                     <span class="comment">% Don't feedback if the current is too small</span>
2407                     <span class="keyword">if</span> getdcct &lt; 5
2408                         FEEDBACK_STOP_FLAG = 1;
2409                         fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2410                         <span class="keyword">break</span>;
2411                     <span class="keyword">end</span>
2412 
2413                     y = Ygoal - Ynew;
2414                     STDy = norm(y)/sqrt(length(y));
2415 
2416                     <span class="keyword">if</span> any(Yold == Ynew)
2417                         a = clock;
2418                         N_Stale_Data_Points = find((Yold==Ynew)==1);
2419                         <span class="keyword">for</span> loop = N_Stale_Data_Points'
2420                             fprintf(<span class="string">'   Stale data: BPMy(%2d,%d), feedback step skipped (%s %d:%d:%.0f). \n'</span>, FB.OCSy.BPM.DeviceList(loop,1), FB.OCSy.BPM.DeviceList(loop,2), date, a(4), a(5), a(6));
2421                         <span class="keyword">end</span>
2422 
2423                     <span class="keyword">else</span>
2424 
2425                         <span class="comment">% Compute vertical correction</span>
2426                         <span class="comment">%%%OCSy0 = FB.OCSy;</span>
2427                         FB.OCSy.BPM.Data = Ynew;
2428                         FB.OCSy = orbitcorrectionmethods(FB.OCSy, Smaty, Sy, Uy, Vy);
2429 
2430                         <span class="comment">%%%[FB.OCSy, RF, OCSy0] = setorbit(FB.OCSy,'Nodisplay','Nosetsp');</span>
2431 
2432                         <span class="comment">% reduced feedback gain, C. Steier, 2001-03-25</span>
2433                         <span class="comment">% reduced to 0.1, C. Steier, 2001-09-04, IDBPMs are noisy at the moment</span>
2434                         <span class="comment">% increased back to 0.8, C. Steier, 2001-09-29, IDBPMs filtering + direct DAC read/write + all SVDs (no arc BPMs)</span>
2435                         <span class="comment">% set to unity gain, C. Steier, 2002-05-04, trim DACs</span>
2436                         Y = Ygain .* FB.OCSy.CM.Delta;
2437                         <span class="comment">%%%Y = Ygain .* (FB.OCSy.CM.Data - OCSy0.CM.Data);</span>
2438 
2439                         <span class="comment">% Just SVD correction</span>
2440                         <span class="comment">% warning('Not using &quot;micado&quot; correction in the vertical plane.');</span>
2441 
2442                         <span class="comment">% check for trim values+next step values, warn or stop FB as necessary</span>
2443                         VCMtrimSP = getpv(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1);
2444                         VCMtrimSP_next = VCMtrimSP + Y(1:N_VCM);
2445                         <span class="keyword">if</span> max(abs(VCMtrimSP_next)) &gt; 12
2446                             VCMtrimnum=find(abs(VCMtrimSP_next) &gt; 12);
2447 
2448                             <span class="comment">% print message to screen</span>
2449                             fprintf(<span class="string">'**One or more of the vertical correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2450                             fprintf(<span class="string">'%s\n'</span>,datestr(now));
2451                             <span class="keyword">for</span> loop = VCMtrimnum'
2452                                 fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1(loop,:)));
2453                             <span class="keyword">end</span>
2454 
2455                             <span class="comment">% send alphapage to operator pager</span>
2456                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2457                             FEEDBACK_STOP_FLAG = 1;
2458 
2459                             setpv(<span class="string">'SR_STATE'</span>, -5);
2460                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2461                             <span class="keyword">if</span> StateNumber &gt;= 0
2462                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2463                             <span class="keyword">else</span>
2464                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2465                             <span class="keyword">end</span>
2466                         <span class="keyword">end</span>
2467 
2468                         <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2469                             <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2470                             <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2471                                 disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2472                             <span class="keyword">end</span>
2473                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2474                             pause(0.5);
2475                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2476                             <span class="keyword">break</span>;
2477                         <span class="keyword">end</span>
2478 
2479                         <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2480                         <span class="comment">% pause(0);</span>
2481 
2482                         <span class="keyword">if</span> max(abs(VCMtrimSP_next) &gt; 4)
2483                             VCMtrimnum=find(abs(VCMtrimSP_next) &gt; 4);
2484                             VWarnNum=VWarnNum+1;
2485                             <span class="keyword">if</span> (VWarnNum==1 | rem(VWarnNum,120)==0)
2486 
2487                                 <span class="comment">% print message to screen every two minutes</span>
2488                                 fprintf(<span class="string">'**One or more of the vertical corrector trims is above 4A or below -4A! \n'</span>);
2489                                 fprintf(<span class="string">'%s\n'</span>,datestr(now));
2490                                 <span class="keyword">for</span> loop = VCMtrimnum'
2491                                     fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1(loop,:)));
2492                                 <span class="keyword">end</span>
2493                                 fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2494 
2495                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2496                                 <span class="keyword">if</span> (VWarnNum==1 | VWarnNum==600)
2497                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageVCM.txt
2498                                 <span class="keyword">end</span>
2499                             <span class="keyword">end</span>
2500                         <span class="keyword">else</span>
2501                             VWarnNum=0;
2502                         <span class="keyword">end</span>
2503 
2504                         <span class="comment">% Don't feedback if the current is too small</span>
2505                         <span class="keyword">if</span> getdcct &lt; 5
2506                             FEEDBACK_STOP_FLAG = 1;
2507                             fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2508                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/beamisoff.txt
2509                             <span class="keyword">break</span>;
2510                         <span class="keyword">end</span>
2511 
2512                         <span class="keyword">if</span> N_VCM &gt; 0
2513                             steppv(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>, Y(iNotVCMChicane), VCMlist1(iNotVCMChicane,:), 0);
2514                             steppv(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>, Y(iVCMChicane), VCMlist1(iVCMChicane,:), 0);
2515                         <span class="keyword">end</span>
2516 
2517                         <span class="comment">% write fast orbit feedback setpoints</span>
2518                         <span class="keyword">if</span> 1
2519                             <a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>(2,Ynew(1:size(BPMlist1,1))+Sy1*Y(1:N_VCM),BPMlist1);
2520                         <span class="keyword">end</span>
2521 
2522                     <span class="keyword">end</span>
2523 
2524                     Yold = Ynew;
2525 
2526                     <span class="comment">%fprintf('Vertical Done: %f \n',gettime-t00);</span>
2527                 <span class="keyword">end</span> <span class="comment">% End vertical correction</span>
2528 
2529 
2530                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
2531                 <span class="comment">% Tune feed forward %</span>
2532                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
2533                 <span class="comment">% We should do a Sector limit check</span>
2534 
2535                 tic;
2536                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxTune'</span>),<span class="string">'Value'</span>) == 1
2537 
2538                     <span class="keyword">if</span> strcmp(SR_Mode, <span class="string">'1.9 GeV, High Tune'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Inject at 1.23'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Two-Bunch'</span>)
2539 
2540                         addQFsp = zeros(24,1);
2541                         addQDsp = zeros(24,1);
2542 
2543                         <span class="keyword">if</span> strcmp(FFTypeFlag,<span class="string">'Local'</span>)
2544                             disp(<span class="string">'  No local tune compensation available - global is the default now.'</span>);
2545                         <span class="keyword">elseif</span> strcmp(FFTypeFlag,<span class="string">'Global'</span>)
2546 
2547                             <span class="comment">% The vectorized gets were put outside of loop for speed reasons</span>
2548                             <span class="comment">%</span>
2549                             <span class="comment">% should also set up QFfac, Quadelem, Quadlist structures outside loop</span>
2550                             actualgap = <a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>(IDSector);
2551                             [gapmin,gapmax] = <a href="gaplimit.html" class="code" title="function [GAPmin, GAPmax] = gaplimit(Dev);">gaplimit</a>(IDSector);
2552                             corrind = find(actualgap&lt;(gapmin-1));
2553                             actualgap(corrind)=gapmax(corrind);
2554                             Shift=zeros(size(actualgap));
2555                             Shift(EPUlist)=getpv(<span class="string">'EPU'</span>);
2556 
2557                             IDchangedList=find((abs(actualgap-oldgap)&gt;0.005) | (abs(Shift-oldShift)&gt;0.005));
2558 
2559                             <span class="keyword">if</span> ~isempty(IDchangedList)
2560 
2561                                 oldgap=actualgap;
2562                                 oldShift=Shift;
2563 
2564                                 <span class="comment">% EPUs excite nux = .25 resonance in vertical linear polarization mode!</span>
2565                                 <span class="comment">% therefore with EPU tune feedforward</span>
2566                                 <span class="comment">% running, we want to move our nominal working point away (just below) the .25 resonance.</span>
2567                                 <span class="comment">%</span>
2568                                 <span class="comment">% The following tune correction moves nominal</span>
2569                                 <span class="comment">% nu_x from .25 to .245 - this should be enough for well set up lattices.</span>
2570                                 <span class="comment">%</span>
2571                                 <span class="comment">% 24 QF+ 24 QD</span>
2572                                 DeltaAmps = inv(SR_TUNE_MATRIX) * [-0.005;0];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2573                                 addQFsp = addQFsp + DeltaAmps(1,:);
2574                                 addQDsp = addQDsp + DeltaAmps(2,:);
2575 
2576                                 <span class="keyword">for</span> gapnum = 1:length(actualgap)
2577 
2578                                     <span class="comment">% Change in tune and [QF;QD] from maximum gap</span>
2579 
2580                                     <span class="keyword">if</span> (IDSector(gapnum,1) == 4) | (IDSector(gapnum,1) == 11)
2581                                         <span class="keyword">if</span> IDSector(gapnum,2) == 1
2582                                             modenamestr = sprintf(<span class="string">'SR%02dU___ODS1M__DC00'</span>,IDSector(gapnum,1));
2583                                         <span class="keyword">else</span> <span class="comment">% if IDSector(gapnum,2) == 2</span>
2584                                             modenamestr = sprintf(<span class="string">'SR%02dU___ODS2M__DC00'</span>,IDSector(gapnum,1));
2585                                         <span class="keyword">end</span>
2586                                         epumode = getpvonline(modenamestr);
2587                                         <span class="keyword">if</span> IDSector(gapnum,2)==2
2588                                             longshift=3;
2589                                         <span class="keyword">else</span>
2590                                             longshift=0;
2591                                         <span class="keyword">end</span>
2592                                         <span class="keyword">if</span> (epumode==0) &amp; (any(IDSector(gapnum,:)~=[11 1]))      <span class="comment">% antiparallel tables need to be fit to data so that they could be used here</span>
2593                                             DeltaNuX = <a href="shift2tune.html" class="code" title="function [Dnux, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = shift2tune(Sector, Gap, EPUshift, GeV)">shift2tune</a>(IDSector(gapnum,1),actualgap(gapnum),Shift(gapnum)+longshift,SR_GeV);
2594                                             DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);   <span class="comment">% variation of vertical tune shift with phase is small for EPUs</span>
2595                                         <span class="keyword">else</span>
2596                                             DeltaNuX = 0;
2597                                             DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);   <span class="comment">% variation of vertical tune shift with phase is small for EPUs</span>
2598                                         <span class="keyword">end</span>
2599 
2600                                     <span class="keyword">else</span>
2601                                         DeltaNuX = 0;
2602                                         DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);
2603                                     <span class="keyword">end</span>
2604 
2605                                     DelQF = zeros(length(QFsp),1);
2606                                     DelQD = zeros(length(QFsp),1);
2607 
2608                                     fraccorr = 0.8*DeltaNuY ./ TuneW16Min;
2609 
2610                                     <span class="comment">% Find which quads to change (local beta beating correction</span>
2611                                     <span class="comment">% (horizontal for EPU, vertical otherwise)</span>
2612                                     QuadList = [IDSector(gapnum,1)-1 2; IDSector(gapnum,1) 1];
2613                                     QuadElem = dev2elem(<span class="string">'QF'</span>,QuadList); <span class="comment">% in reality use QF and QD ...</span>
2614 
2615                                     <span class="comment">% global vertical tune correction</span>
2616                                     <span class="comment">% 24 QF+ 24 QD</span>
2617                                     DeltaAmps = inv(SR_TUNE_MATRIX) * [(fraccorr*6.23e-4); fraccorr*(-0.05301)];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2618                                     DelQF = DelQF + DeltaAmps(1,:);
2619                                     DelQD = DelQD + DeltaAmps(2,:);
2620 
2621                                     <span class="comment">% local horizontal tune correction (is also nearly a beta beating correction) only nonzero for EPUs!</span>
2622                                     <span class="comment">% 2 QF + 2 QD</span>
2623                                     DeltaAmpsLocal = 12*inv(SR_TUNE_MATRIX) * [-DeltaNuX;0];                       <span class="comment">%  DelAmps =  [QF; QD];</span>
2624                                     DelQF(QuadElem) = DelQF(QuadElem)+DeltaAmpsLocal(1,1);
2625                                     DelQD(QuadElem) = DelQD(QuadElem)+DeltaAmpsLocal(2,1);
2626 
2627                                     <span class="comment">% local vertical beta beating correction (should be used together with above global tune correction)</span>
2628                                     <span class="comment">% set to zero for EPUs, since their vertical tune shift is small</span>
2629                                     <span class="comment">% 2 QF + 2QD</span>
2630                                     <span class="keyword">if</span> (IDSector(gapnum,1)==6) | (IDSector(gapnum,1)==7) | (IDSector(gapnum,1)==10) | (IDSector(gapnum,1)==11)
2631                                         QFfac = ([2.243127/2.237111; 2.243127/2.237111]-1) * fraccorr;
2632                                         QDfac = ([2.556392/2.511045; 2.556392/2.511045]-1) * fraccorr;
2633                                     <span class="keyword">elseif</span> (IDSector(gapnum,1)==5) | (IDSector(gapnum,1)==9)
2634                                         QFfac = ([2.225965/2.219784; 2.243096/2.237111]-1) * fraccorr;
2635                                         QDfac = ([2.528950/2.483259; 2.556345/2.511045]-1) * fraccorr;
2636                                     <span class="keyword">elseif</span> (IDSector(gapnum,1)==4) | (IDSector(gapnum,1)==8) | (IDSector(gapnum,1)==12)
2637                                         QFfac = ([2.243096/2.237111; 2.225965/2.219784]-1) * fraccorr;
2638                                         QDfac = ([2.556345/2.511045; 2.528950/2.483259]-1) * fraccorr;
2639                                     <span class="keyword">else</span>
2640                                         QFfac = zeros(2,1);
2641                                         QDfac = zeros(2,1);
2642                                     <span class="keyword">end</span>
2643 
2644                                     DelQF(QuadElem,:) = DelQF(QuadElem,:) + QFfac.*QFsp(QuadElem,:);
2645                                     DelQD(QuadElem,:) = DelQD(QuadElem,:) + QDfac.*QDsp(QuadElem,:);
2646 
2647                                     <span class="comment">% add all tune and beta beating corrections for this one ID to the summed up correction vectors for all IDs</span>
2648                                     addQFsp = addQFsp+DelQF;
2649                                     addQDsp = addQDsp+DelQD;
2650                                     
2651                                     
2652                                     <span class="comment">% Skew FF for IVID</span>
2653                                     <span class="keyword">if</span> (IDSector(gapnum,1)==6)
2654                                         <span class="comment">% what input argument do we use below???</span>
2655                                         [SQSFincr, HCSFincr, SQSDincr, HCSDincr] = <a href="set_etaywave_nuy9_20skews_skewFF.html" class="code" title="function [SQSFincr, SQSDincr] = set_etaywave_nuy9_20skews_skewFF(scale);">set_etaywave_nuy9_20skews_skewFF</a>(scale);
2656                                     <span class="keyword">end</span>
2657 
2658                                 <span class="keyword">end</span>
2659 
2660                                 <span class="comment">% Set quadrupoles using main setpoint channels</span>
2661                                 setpv(<span class="string">'QF'</span>, QFsp+addQFsp,[], 0);
2662                                 setpv(<span class="string">'QD'</span>, QDsp+addQDsp,[], 0);
2663                                 <span class="comment">% % Set quadrupoles using FF setpoint channels</span>
2664                                 <span class="comment">% setpv('QF', 'FF', addQFsp, [], 0);</span>
2665                                 <span class="comment">% setpv('QD', 'FF', addQDsp, [], 0);</span>
2666                                 
2667                                 <span class="comment">% Set skew quadrupoles to compensate for IVID skew effect</span>
2668                                 setpv(<span class="string">'SQSF'</span>, SQSFsp+SQSFincr, [], 0);
2669                                 setpv(<span class="string">'SQSD'</span>, SQSDsp+SQSDincr, [], 0);
2670                                 setpv(<span class="string">'HCM'</span>, HCSFsp+HCSFincr, [HCSFindex], 0);
2671                                 setpv(<span class="string">'HCM'</span>, HCSDsp+HCSDincr, [HCSDindex], 0);
2672                             <span class="keyword">end</span>
2673 
2674                         <span class="keyword">else</span>
2675                             error(<span class="string">'Unknown type selected for tune FF'</span>);
2676                         <span class="keyword">end</span>
2677 
2678                     <span class="keyword">else</span>
2679                         disp(<span class="string">'  No tune FF algorithm for non-production modes yet...'</span>);
2680                     <span class="keyword">end</span>
2681                 <span class="keyword">end</span>
2682 
2683                 ffdeltaquad_delay = toc;
2684                 <span class="comment">%fprintf('tune FF delay = %.1f seconds\n',ffdeltaquad_delay);</span>
2685                 <span class="comment">% fprintf('Tune Done: %f \n',gettime-t00);</span>
2686 
2687                 <span class="comment">% Output info to screen</span>
2688                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = %.4f mm'</span>,STDx),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2689                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = %.4f mm'</span>,STDy),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2690                 <span class="comment">%pause(0);</span>
2691 
2692                 FOFBStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2693                     getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2694                     getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2695                     getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2696                 <span class="keyword">for</span> loop = 1:size(FOFBStatus,2)
2697                     <span class="keyword">if</span> FOFBStatus(loop)==0
2698                         FOFBStatusStr(loop,:) = <span class="string">'OFF '</span>;
2699                     <span class="keyword">elseif</span> FOFBStatus(loop)==1
2700                         FOFBStatusStr(loop,:) = <span class="string">'ON  '</span>;
2701                     <span class="keyword">elseif</span> FOFBStatus(loop)==2
2702                         FOFBStatusStr(loop,:) = <span class="string">'OPEN'</span>;
2703                     <span class="keyword">else</span>
2704                         FOFBStatusStr(loop,:) = <span class="string">'BAD '</span>;
2705                     <span class="keyword">end</span>
2706                 <span class="keyword">end</span>
2707                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 %s'</span>,FOFBStatusStr(1,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2708                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 %s'</span>,FOFBStatusStr(2,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2709                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 %s'</span>,FOFBStatusStr(3,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2710                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 %s'</span>,FOFBStatusStr(4,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2711                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 %s'</span>,FOFBStatusStr(5,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2712                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 %s'</span>,FOFBStatusStr(6,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2713                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 %s'</span>,FOFBStatusStr(7,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2714                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 %s'</span>,FOFBStatusStr(8,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2715                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 %s'</span>,FOFBStatusStr(9,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2716                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 %s'</span>,FOFBStatusStr(10,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2717                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 %s'</span>,FOFBStatusStr(11,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2718                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 %s'</span>,FOFBStatusStr(12,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2719 
2720 
2721                 <span class="comment">%fprintf('End of feedback operations: %f \n\n',gettime-t00);</span>
2722 
2723                 <span class="comment">% Wait for next update time or stop request</span>
2724                 <span class="keyword">while</span> (gettime-t00) &lt; LoopDelay
2725                     <span class="comment">%disp('interval could be shorter')</span>
2726                     pause(.05);
2727                     <span class="comment">% Check if GUI has been closed</span>
2728                     <span class="keyword">if</span> isempty(gcbf)
2729                         FEEDBACK_STOP_FLAG = 1;
2730                         lasterr(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2731                         error(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2732                     <span class="keyword">end</span>
2733 
2734                     <span class="comment">% Check if Stop button was pressed</span>
2735                     <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2736                         <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2737                         <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2738                             disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2739                         <span class="keyword">end</span>
2740                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2741                         pause(0.5);
2742                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2743                         <span class="keyword">break</span>;
2744                     <span class="keyword">end</span>
2745                 <span class="keyword">end</span>
2746 
2747 
2748                 <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2749                     <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2750                     <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2751                         disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2752                     <span class="keyword">end</span>
2753                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2754                     pause(0.5);
2755                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2756                     <span class="keyword">break</span>;
2757                 <span class="keyword">end</span>
2758 
2759                 StartErrorTime = gettime;
2760 
2761             <span class="keyword">catch</span>
2762 
2763                 fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
2764 
2765                 <span class="comment">% Quit if error exists for more than 20 seconds</span>
2766                 <span class="keyword">if</span> gettime-StartErrorTime&gt;20 | FEEDBACK_STOP_FLAG==1
2767                     fprintf(<span class="string">'%s  Orbit feedback stopped due to error condition. \n\n'</span>,datestr(now));
2768 
2769                     <span class="comment">%send alphapage to operator pager</span>
2770                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2771                     FEEDBACK_STOP_FLAG = 1;
2772 
2773                     setpv(<span class="string">'SR_STATE'</span>, -5);
2774                     [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2775                     <span class="keyword">if</span> StateNumber &gt;= 0
2776                         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2777                     <span class="keyword">else</span>
2778                         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2779                     <span class="keyword">end</span>
2780                 <span class="keyword">else</span>
2781                     a = clock;
2782                     fprintf(<span class="string">'   Orbit feedback was paused due to error condition (%s %d:%d:%.0f). \n'</span>, date, a(4), a(5), a(6));
2783                     fprintf(<span class="string">'   Orbit feedback has automatically restarted and is running. \n\n'</span>);
2784                 <span class="keyword">end</span>
2785 
2786             <span class="keyword">end</span>
2787 
2788             <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2789                 <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2790                 <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2791                     disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2792                 <span class="keyword">end</span>
2793                 setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2794                 pause(0.5);
2795                 setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2796                 <span class="keyword">break</span>;
2797             <span class="keyword">end</span>
2798 
2799             <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2800 
2801             <span class="comment">%pause(0);</span>
2802 
2803             <span class="comment">% this loop delays turn on of Fast Feedback system</span>
2804             <span class="keyword">if</span> FBloopIter &lt; 5
2805                 FBloopIter = FBloopIter + 1;
2806             <span class="keyword">end</span>
2807 
2808         <span class="keyword">end</span>  <span class="comment">% End of feedback loop</span>
2809 
2810 
2811         <span class="comment">% End feedback, reset all parameters</span>
2812         <span class="keyword">try</span>
2813 
2814             <span class="comment">% Enable buttons</span>
2815             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2816             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2817             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2818             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2819             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2820             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2821             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2822             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2823             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2824             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2825             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2826             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2827             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2828 
2829             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = _____ mm'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2830             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = _____ mm'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2831 
2832             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2833             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2834             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2835             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2836             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2837             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2838             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2839             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2840             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2841             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2842             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2843             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2844 
2845             <span class="comment">%pause(0);</span>
2846 
2847         <span class="keyword">catch</span>
2848 
2849             <span class="comment">% GUI must have been closed</span>
2850 
2851         <span class="keyword">end</span>
2852 
2853 
2854         <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2855         fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2856         <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2857 
2858 
2859         a = clock;
2860         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2861         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2862         <span class="keyword">if</span> StateNumber &gt;= 0
2863             setpv(<span class="string">'SR_STATE'</span>,5.1);
2864             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2865             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2866             fprintf(<span class="string">'   ******************************\n'</span>);
2867             fprintf(<span class="string">'   **  Orbit Feedback Stopped  **\n'</span>);
2868             fprintf(<span class="string">'   ******************************\n\n'</span>);
2869         <span class="keyword">else</span>
2870             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2871             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2872             fprintf(<span class="string">'   ****************************************\n'</span>);
2873             fprintf(<span class="string">'   **  Problem With Slow Orbit Feedback  **\n'</span>);
2874             fprintf(<span class="string">'   ****************************************\n\n'</span>);
2875         <span class="keyword">end</span>
2876         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
2877         pause(0);
2878 
2879 
2880     <span class="keyword">case</span> <span class="string">'FeedbackSetup'</span>
2881         InitFlag = Input2;           <span class="comment">% Input #2: if InitFlag, then initialize variables</span>
2882 
2883         <span class="keyword">if</span> InitFlag
2884             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2885             <span class="comment">% Edit the following lists to change default configuration of Orbit Correction %</span>
2886             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2887 
2888             <span class="comment">% Corrector magnets</span>
2889             listh=[
2890                 1 2;
2891                 1 8;
2892                 2 1;
2893                 2 8;
2894                 3 1;
2895                 3 8;
2896                 3 10; <span class="comment">%SR04U_HCM2 (chicane trim)</span>
2897                 4 1;
2898                 4 8;
2899                 5 1;
2900                 5 8;
2901                 5 10; <span class="comment">%SR06U_HCM2 (chicane trim)</span>
2902                 6 1;
2903                 6 8;
2904                 7 1;
2905                 7 8;
2906                 8 1;
2907                 8 8;
2908                 9 1;
2909                 9 8;
2910                 10 1;
2911                 10 8;
2912                 10 10; <span class="comment">%SR11U_HCM2 (chicane trim)</span>
2913                 11 1;
2914                 11 8;
2915                 12 1;
2916                 12 7];
2917             listv=[
2918                 1 2;
2919                 1 8;
2920                 2 1;
2921                 2 8;
2922                 3 1;
2923                 3 7;
2924                 3 8;
2925                 3 10; <span class="comment">%SR04U_VHCM2 (chicane trim)</span>
2926                 4 1;
2927                 4 7;
2928                 4 8;
2929                 5 1;
2930                 5 8;
2931                 5 10; <span class="comment">%SR06U_VHCM2 (chicane trim)</span>
2932                 6 1;
2933                 6 8;
2934                 7 1;
2935                 7 8;
2936                 8 1;
2937                 8 8;
2938                 9 1;
2939                 9 8;
2940                 10 1;
2941                 10 2;
2942                 10 7;
2943                 10 8;
2944                 10 10; <span class="comment">%SR11U_VHCM2 (chicane trim)</span>
2945                 11 1;
2946                 11 7;
2947                 11 8;
2948                 12 1;
2949                 12 7];
2950 
2951             Xivec = [1:28];
2952             Yivec = [1:32];
2953             HCMlist1 = listh;
2954             VCMlist1 = listv;
2955 
2956             <span class="comment">% Full BPM list</span>
2957             BPMlist1 = [
2958                 1 2
2959                 1 5
2960                 1 6
2961                 1 10
2962                 2 1
2963                 2 5
2964                 2 6
2965                 2 9
2966                 3 2
2967                 3 5
2968                 3 6
2969                 3 10
2970                 3 11
2971                 3 12
2972                 4 1
2973                 4 5
2974                 4 6
2975                 4 10
2976                 5 1
2977                 5 5
2978                 5 6
2979                 5 10
2980                 5 11
2981                 5 12
2982                 6 1
2983                 6 5
2984                 6 6
2985                 6 10
2986                 7 1
2987                 7 5
2988                 7 6
2989                 7 10
2990                 8 1
2991                 8 5
2992                 8 6
2993                 8 10
2994                 9 1
2995                 9 5
2996                 9 6
2997                 9 10
2998                 10 1
2999                 10 5
3000                 10 6
3001                 10 10
3002                 10 11
3003                 10 12
3004                 11 1
3005                 11 5
3006                 11 6
3007                 11 10
3008                 12 1
3009                 12 5
3010                 12 6
3011                 12 9
3012                 ];
3013 
3014             <span class="comment">% remove Bergoz BPMs in SR01 and SR03 for 2-bunch (noisy at low currents) and drop singular values</span>
3015             <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
3016                     BPMlist1 = [
3017                          <span class="comment">%1 2</span>
3018                          1 5
3019                          1 6
3020                          1 10
3021                          2 1
3022                          2 5
3023                          2 6
3024                          <span class="comment">%2 9</span>
3025                          <span class="comment">%3 2</span>
3026                          3 5
3027                          3 6
3028                          3 10
3029                          3 11
3030                          3 12
3031                          4 1
3032                          4 5
3033                          4 6
3034                          4 10
3035                          5 1
3036                          5 5
3037                          5 6
3038                          5 10
3039                          5 11
3040                          5 12
3041                          6 1
3042                          6 5
3043                          6 6
3044                          6 10
3045                          7 1
3046                          7 5
3047                          7 6
3048                          7 10
3049                          8 1
3050                          8 5
3051                          8 6
3052                          8 10
3053                          9 1
3054                          9 5
3055                          9 6
3056                          9 10
3057                          10 1
3058                          10 5
3059                          10 6
3060                          10 10
3061                          10 11
3062                          10 12
3063                          11 1
3064                          11 5
3065                          11 6
3066                          11 10
3067                          12 1
3068                          12 5
3069                          12 6
3070                          <span class="comment">%12 9</span>
3071                          ];
3072             <span class="keyword">end</span>
3073 
3074             OCSx.BPM = getx(BPMlist1, <span class="string">'struct'</span>);
3075             OCSx.CM = getsp(<span class="string">'HCM'</span>, HCMlist1, <span class="string">'struct'</span>);
3076             OCSx.GoalOrbit = getgolden(OCSx.BPM, <span class="string">'numeric'</span>);
3077             OCSx.NIter = 1;
3078             OCSx.SVDIndex = Xivec;
3079             OCSx.IncrementalFlag = <span class="string">'No'</span>;
3080             OCSx.BPMWeight = {[]};
3081             OCSx.FitRF = 0;
3082             OCSy.BPM = gety(BPMlist1, <span class="string">'struct'</span>);
3083             OCSy.CM = getsp(<span class="string">'VCM'</span>, VCMlist1, <span class="string">'struct'</span>);
3084             OCSy.GoalOrbit = getgolden(OCSy.BPM, <span class="string">'numeric'</span>);
3085             OCSy.NIter = 1;
3086             OCSy.SVDIndex = Yivec;
3087             OCSy.IncrementalFlag = <span class="string">'No'</span>;
3088             OCSy.BPMWeight = {[]};
3089             OCSy.FitRF = 0;
3090             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
3091             <span class="comment">% do we need these Smat calls? %</span>
3092             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
3093             SXmat = getrespmat(OCSx.BPM, OCSx.CM, <span class="string">'numeric'</span>);
3094             SYmat = getrespmat(OCSy.BPM, OCSy.CM, <span class="string">'numeric'</span>);
3095             <span class="comment">% [OCSx, Sx, Ux, Vx] = orbitcorrectionmethods(OCSx, SXmat);</span>
3096             <span class="comment">% [OCSy, Sy, Uy, Vy] = orbitcorrectionmethods(OCSy, SYmat);</span>
3097 
3098             <span class="comment">% initialize FFTypeFlag</span>
3099             FFTypeFlag = <span class="string">'Global'</span>;
3100 
3101         <span class="keyword">else</span>
3102 
3103             <span class="comment">% Get vectors</span>
3104             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
3105             <span class="comment">% the two lines below seem to fix BPMlist editing problem</span>
3106             OCSx = FB.OCSx;
3107             OCSy = FB.OCSy;
3108             BPMlist1 = FB.BPMlist1;
3109             HCMlist1 = FB.HCMlist1;
3110             VCMlist1 = FB.VCMlist1;
3111             Xivec = FB.Xivec;
3112             Yivec = FB.Yivec;
3113             Xgoal = FB.OCSx.GoalOrbit;
3114             OCSx.GoalOrbit = Xgoal;
3115             Ygoal = FB.OCSy.GoalOrbit;
3116             OCSy.GoalOrbit = Ygoal;
3117             FFTypeFlag = FB.FFTypeFlag;
3118 
3119 
3120             <span class="comment">% FF corrector magnet list</span>
3121             ListFF = [
3122                 4     2
3123                 4     8
3124                 5     1
3125                 5     7
3126 <span class="comment">%               5     8 % why are these out???</span>
3127 <span class="comment">%               6     1 % why are these out???</span>
3128                 6     8
3129                 7     1
3130                 7     8
3131                 8     1
3132                 8     8
3133                 9     1
3134                 9     8
3135                 10    1
3136                 11    8
3137                 12    1];
3138             ElemFF = dev2elem(<span class="string">'HCM'</span>,ListFF);
3139 
3140 
3141             <span class="comment">% Add button to change #ivectors, cm, IDBPMs,</span>
3142             EditFlag = 0;
3143             h_fig1 = figure;
3144             <span class="keyword">while</span> EditFlag ~= 6
3145 
3146                 Sx = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
3147                 Sy = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
3148                 
3149                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
3150                     DispOrbit = getdisp(<span class="string">'BPMx'</span>, BPMlist1);
3151                     Sx = [Sx DispOrbit];
3152                 <span class="keyword">end</span>
3153                 
3154                 [Ux, SVx, Vx] = svd(Sx);
3155                 [Uy, SVy, Vy] = svd(Sy);
3156 
3157                 
3158                 <span class="comment">% Remove singular values greater than the actual number of singular values</span>
3159                 i = find(Xivec&gt;length(diag(SVx)));
3160                 <span class="keyword">if</span> ~isempty(i)
3161                     disp(<span class="string">'   Horizontal E-vector scaled since there were more elements in the vector than singular values.'</span>);
3162                     pause(0);
3163                     Xivec(i) = [];
3164                 <span class="keyword">end</span>
3165                 i = find(Yivec&gt;length(diag(SVy)));
3166                 <span class="keyword">if</span> ~isempty(i)
3167                     disp(<span class="string">'   Vertical E-vector scaled since there were more elements in the vector than singular values.'</span>);
3168                     pause(0);
3169                     Yivec(i) = [];
3170                 <span class="keyword">end</span>
3171 
3172 
3173                 Ax = Sx*Vx(:,Xivec);
3174                 Tx = inv(Ax'*Ax)*Ax';
3175 
3176                 Ay = Sy*Vy(:,Yivec);
3177                 Ty = inv(Ay'*Ay)*Ay';
3178 
3179                 figure(h_fig1);
3180                 subplot(2,1,1);
3181                 semilogy(diag(SVx),<span class="string">'b'</span>);
3182                 hold on;
3183                 semilogy(diag(SVx(Xivec,Xivec)),<span class="string">'xr'</span>);
3184                 ylabel(<span class="string">'Horizontal'</span>);
3185                 title(<span class="string">'Response Matrix Singular Values'</span>);
3186                 hold off;
3187                 subplot(2,1,2);
3188                 semilogy(diag(SVy),<span class="string">'b'</span>);
3189                 hold on;
3190                 semilogy(diag(SVy(Yivec,Yivec)),<span class="string">'xr'</span>);
3191                 xlabel(<span class="string">'Singular Value Number'</span>);
3192                 ylabel(<span class="string">'Vertical'</span>);
3193                 hold off;
3194                 drawnow;
3195 
3196                 EditFlag = menu(<span class="string">'Change Parameters?'</span>,<span class="string">'Singular Values'</span>,<span class="string">'HCM List'</span>,<span class="string">'VCM List'</span>, <span class="keyword">...</span>
3197                     <span class="string">'BPM List'</span>,<span class="string">'Change the Goal Orbit'</span>,<span class="string">'Continue'</span>);
3198 
3199                 <span class="keyword">if</span> EditFlag == 1
3200                     prompt={<span class="string">'Enter the horizontal E-vector numbers (Matlab vector format):'</span>,<span class="string">'Enter the vertical E-vector numbers (Matlab vector format):'</span>};
3201                     def={sprintf(<span class="string">'[%d:%d]'</span>,1,Xivec(end)),sprintf(<span class="string">'[%d:%d]'</span>,1,Yivec(end))};
3202                     titlestr=<span class="string">'SVD Orbit Feedback'</span>;
3203                     lineNo=1;
3204                     answer=inputdlg(prompt,titlestr,lineNo,def);
3205                     <span class="keyword">if</span> ~isempty(answer)
3206                         XivecNew = fix(str2num(answer{1}));
3207                         <span class="keyword">if</span> isempty(XivecNew)
3208                             disp(<span class="string">'   Horizontal E-vector cannot be empty.  No change made.'</span>);
3209                         <span class="keyword">else</span>
3210                             <span class="keyword">if</span> any(XivecNew&lt;=0) | max(XivecNew)&gt;length(diag(SVx))
3211                                 disp(<span class="string">'   Error reading horizontal E-vector.  No change made.'</span>);
3212                             <span class="keyword">else</span>
3213                                 Xivec = XivecNew;
3214                             <span class="keyword">end</span>
3215                         <span class="keyword">end</span>
3216                         YivecNew = fix(str2num(answer{2}));
3217                         <span class="keyword">if</span> isempty(YivecNew)
3218                             disp(<span class="string">'   Vertical E-vector cannot be empty.  No change made.'</span>);
3219                         <span class="keyword">else</span>
3220                             <span class="keyword">if</span> any(YivecNew&lt;=0) | max(YivecNew)&gt;length(diag(SVy))
3221                                 disp(<span class="string">'   Error reading vertical E-vector.  No change made.'</span>);
3222                             <span class="keyword">else</span>
3223                                 Yivec = YivecNew;
3224                             <span class="keyword">end</span>
3225                         <span class="keyword">end</span>
3226                     <span class="keyword">end</span>
3227                 <span class="keyword">end</span>
3228 
3229                 <span class="keyword">if</span> EditFlag == 2
3230                     List= getlist(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>);
3231                     CheckList = zeros(96,1);
3232                     Elem = dev2elem(<span class="string">'HCM'</span>, HCMlist1);
3233                     CheckList(Elem) = ones(size(Elem));
3234                     CheckList = CheckList(dev2elem(<span class="string">'HCM'</span>,List));
3235 
3236                     <span class="comment">% Remove FF corrrectors</span>
3237                     <span class="comment">%           Elem = dev2elem('HCM',List);</span>
3238                     <span class="comment">%           for j = length(ElemFF):-1:1</span>
3239                     <span class="comment">%              i = find(Elem==ElemFF(j));</span>
3240                     <span class="comment">%              Elem(i,:) = [];</span>
3241                     <span class="comment">%              List(i,:) = [];</span>
3242                     <span class="comment">%              CheckList(i,:) = [];</span>
3243                     <span class="comment">%           end</span>
3244 
3245                     newList = editlist(List, <span class="string">'HCMtrim'</span>, CheckList);
3246 
3247                     <span class="keyword">if</span> isempty(newList)
3248                         fprintf(<span class="string">'   WARNING: Horizontal corrector magnet list is empty!\n'</span>);
3249                         HCMlist1 = newList;
3250                     <span class="keyword">else</span>
3251                         HCMlist1 = newList;
3252                     <span class="keyword">end</span>
3253                     OCSx.CM.DeviceList = HCMlist1;
3254                 <span class="keyword">end</span>
3255 
3256                 <span class="keyword">if</span> EditFlag == 3
3257                     List = getlist(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>);
3258                     CheckList = zeros(96,1);
3259                     Elem = dev2elem(<span class="string">'VCM'</span>, VCMlist1);
3260                     CheckList(Elem) = ones(size(Elem));
3261                     CheckList = CheckList(dev2elem(<span class="string">'VCM'</span>,List));
3262 
3263                     <span class="comment">% Remove FF corrrectors</span>
3264                     <span class="comment">%           Elem = dev2elem('VCM',List);</span>
3265                     <span class="comment">%           for j = length(ElemFF):-1:1</span>
3266                     <span class="comment">%              i = find(Elem==ElemFF(j));</span>
3267                     <span class="comment">%              Elem(i,:) = [];</span>
3268                     <span class="comment">%              List(i,:) = [];</span>
3269                     <span class="comment">%              CheckList(i,:) = [];</span>
3270                     <span class="comment">%           end</span>
3271 
3272                     newList = editlist(List, <span class="string">'VCMtrim'</span>, CheckList);
3273 
3274                     <span class="keyword">if</span> isempty(newList)
3275                         fprintf(<span class="string">'   WARNING: Vertical corrector magnet list is empty!\n'</span>);
3276                         VCMlist1 = newList;
3277                     <span class="keyword">else</span>
3278                         VCMlist1 = newList;
3279                     <span class="keyword">end</span>
3280                     OCSy.CM.DeviceList = VCMlist1;
3281                 <span class="keyword">end</span>
3282 
3283                 <span class="keyword">if</span> EditFlag == 4
3284                     ListOld = BPMlist1;
3285                     XgoalOld = Xgoal;
3286                     YgoalOld = Ygoal;
3287 
3288                     <span class="comment">% Full BPM list</span>
3289                     List = [
3290                         1 2
3291                         1 5
3292                         1 6
3293                         1 10
3294                         2 1
3295                         2 5
3296                         2 6
3297                         2 9
3298                         3 2
3299                         3 5
3300                         3 6
3301                         3 10
3302                         3 11
3303                         3 12
3304                         4 1
3305                         4 5
3306                         4 6
3307                         4 10
3308                         5 1
3309                         5 5
3310                         5 6
3311                         5 10
3312                         5 11
3313                         5 12
3314                         6 1
3315                         6 5
3316                         6 6
3317                         6 10
3318                         7 1
3319                         7 5
3320                         7 6
3321                         7 10
3322                         8 1
3323                         8 5
3324                         8 6
3325                         8 10
3326                         9 1
3327                         9 5
3328                         9 6
3329                         9 10
3330                         10 1
3331                         10 5
3332                         10 6
3333                         10 10
3334                         10 11
3335                         10 12
3336                         11 1
3337                         11 5
3338                         11 6
3339                         11 10
3340                         12 1
3341                         12 5
3342                         12 6
3343                         12 9
3344                         ];
3345 
3346 
3347                     CheckList = zeros(size(List,1),1);
3348                     <span class="keyword">if</span> ~isempty(BPMlist1)
3349                         <span class="keyword">for</span> i = 1:size(List,1)
3350                             k = find(List(i,1)==BPMlist1(:,1));
3351                             l = find(List(i,2)==BPMlist1(k,2));
3352 
3353                             <span class="keyword">if</span> isempty(k) | isempty(l)
3354                                 <span class="comment">% Item not in list</span>
3355                             <span class="keyword">else</span>
3356                                 CheckList(i) = 1;
3357                             <span class="keyword">end</span>
3358                         <span class="keyword">end</span>
3359                     <span class="keyword">end</span>
3360 
3361                     newList = editlist(List, <span class="string">'BPM'</span>, CheckList);
3362                     <span class="keyword">if</span> isempty(newList)
3363                         fprintf(<span class="string">'   BPM list cannot be empty.  No change made.\n'</span>);
3364                     <span class="keyword">else</span>
3365                         BPMlist1 = newList;
3366                     <span class="keyword">end</span>
3367 
3368                     <span class="comment">% Set the goal orbit to the golden orbit</span>
3369                     Xgoal = getgolden(<span class="string">'BPMx'</span>, BPMlist1);
3370                     Ygoal = getgolden(<span class="string">'BPMy'</span>, BPMlist1);
3371 
3372 
3373                     <span class="comment">% If a new BPM is added, then set the goal orbit to the golden orbit</span>
3374                     <span class="keyword">for</span> i = 1:size(BPMlist1,1)
3375 
3376                         <span class="comment">% Is it a new BPM?</span>
3377                         k = find(BPMlist1(i,1)==ListOld(:,1));
3378                         l = find(BPMlist1(i,2)==ListOld(k,2));
3379 
3380                         <span class="keyword">if</span> isempty(k) | isempty(l)
3381                             <span class="comment">% New BPM</span>
3382                         <span class="keyword">else</span>
3383                             <span class="comment">% Use the old value for old BPM</span>
3384                             Xgoal(i) = XgoalOld(k(l));
3385                             Ygoal(i) = YgoalOld(k(l));
3386                         <span class="keyword">end</span>
3387                     <span class="keyword">end</span>
3388                     OCSx.BPM.DeviceList = BPMlist1;
3389                     OCSy.BPM.DeviceList = BPMlist1;
3390                     OCSx.GoalOrbit = Xgoal;
3391                     OCSy.GoalOrbit = Ygoal;
3392                 <span class="keyword">end</span>
3393 
3394                 <span class="keyword">if</span> EditFlag == 5
3395                     ChangeList = editlist2(BPMlist1, <span class="string">'Change BPM'</span>, zeros(size(BPMlist1,1),1));
3396 
3397                     <span class="keyword">for</span> i = 1:size(ChangeList,1)
3398 
3399                         k = find(ChangeList(i,1)==BPMlist1(:,1));
3400                         l = find(ChangeList(i,2)==BPMlist1(k,2));
3401 
3402                         prompt={sprintf(<span class="string">'Enter the new horizontal goal orbit for BPMx(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2)),sprintf(<span class="string">'Enter the new vertical goal orbit for BPMy(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2))};
3403                         def={sprintf(<span class="string">'%f'</span>,Xgoal(k(l))),sprintf(<span class="string">'%f'</span>,Ygoal(k(l)))};
3404                         titlestr=<span class="string">'CHANGE THE GOAL ORBIT'</span>;
3405                         lineNo=1;
3406                         answer = inputdlg(prompt, titlestr, lineNo, def);
3407 
3408                         <span class="keyword">if</span> isempty(answer)
3409                             <span class="comment">% No change</span>
3410                             fprintf(<span class="string">'   No change was made to the golden orbit.\n'</span>);
3411                         <span class="keyword">else</span>
3412                             Xgoalnew = str2num(answer{1});
3413                             <span class="keyword">if</span> isempty(Xgoalnew)
3414                                 fprintf(<span class="string">'   No change was made to the horizontal golden orbit.\n'</span>);
3415                             <span class="keyword">else</span>
3416                                 Xgoal(k(l)) = Xgoalnew;
3417                             <span class="keyword">end</span>
3418 
3419                             Ygoalnew = str2num(answer{2});
3420                             <span class="keyword">if</span> isempty(Ygoalnew)
3421                                 fprintf(<span class="string">'   No change was made to the vertical golden orbit.\n'</span>);
3422                             <span class="keyword">else</span>
3423                                 Ygoal(k(l)) = Ygoalnew;
3424                             <span class="keyword">end</span>
3425                         <span class="keyword">end</span>
3426                     <span class="keyword">end</span>
3427                     <span class="keyword">if</span> ~isempty(ChangeList)
3428                         fprintf(<span class="string">'   Note:  Changing the goal orbit for &quot;Slow Orbit Feedback&quot; does not change the goal orbit for &quot;Orbit Correction.&quot;\n'</span>);
3429                         fprintf(<span class="string">'          Re-running srcontrol will restart the goal orbit to the golden orbit.&quot;\n'</span>);
3430                     <span class="keyword">end</span>
3431                     OCSx.GoalOrbit = Xgoal;
3432                     OCSy.GoalOrbit = Ygoal;
3433                 <span class="keyword">end</span>
3434 
3435 <span class="comment">%                 if EditFlag == 6</span>
3436 <span class="comment">%                     FFTypeFlag = questdlg(sprintf('Do you want to use a fully local or a combined local/global compensation of IDs? (nuy=9.2 only)'),'Tune FF','Local','Global', 'Global');</span>
3437 <span class="comment">%                     if strcmp(FFTypeFlag,'Local')</span>
3438 <span class="comment">%                         disp(['   The tune FF will use 8 local quadrupoles to compensate beta beating and tune shift']);</span>
3439 <span class="comment">%                         disp(['   from each ID.']);</span>
3440 <span class="comment">%                     elseif strcmp(FFTypeFlag,'Global')</span>
3441 <span class="comment">%                         disp(['   The tune FF will use 4 local quadrupoles to compensate beta beating and all QF+QD']);</span>
3442 <span class="comment">%                         disp(['   to compensate tune shift from each ID.']);</span>
3443 <span class="comment">%                     end</span>
3444 <span class="comment">%                 end</span>
3445 
3446             <span class="keyword">end</span>
3447             close(h_fig1);
3448         <span class="keyword">end</span>
3449 
3450         <span class="comment">% Save vectors</span>
3451         FB.Xivec = Xivec;
3452         FB.Yivec = Yivec;
3453         FB.HCMlist1 = HCMlist1;
3454         FB.VCMlist1 = VCMlist1;
3455         FB.BPMlist1 = BPMlist1;
3456 
3457         OCSx.SVDIndex = Xivec;
3458         OCSy.SVDIndex = Yivec;
3459         FB.OCSx = OCSx;
3460         FB.OCSy = OCSy;
3461 
3462         FB.FFTypeFlag = FFTypeFlag;
3463         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>,FB);
3464 
3465 
3466     <span class="keyword">case</span> <span class="string">'FastFeedbackSetup'</span>
3467 
3468         InitFlag = Input2;
3469 
3470         <span class="keyword">if</span> InitFlag
3471             FOFBFreq = 1000;
3472             <span class="comment">% user operations 9/14-10/17/04: P=0.5, I=120, D=0.0015 (for both planes)</span>
3473             <span class="comment">% below are known good values for user ops as of 8-1-05</span>
3474             HorP = 2;
3475             HorI = 300;
3476             HorD = 0.002;
3477             VertP = 1;
3478             VertI = 100;
3479             VertD = 0.0015;
3480 
3481             <span class="comment">% this initial set is now done in hwinit.m because it's not a good idea to set anything when srcontrol is launched</span>
3482             <span class="comment">% try</span>
3483             <span class="comment">%     setsp('SR01____FFBFREQAC00', FOFBFreq); % set freq</span>
3484             <span class="comment">%     write_pid_ffb2_patch(HorP, HorI, HorD, VertP, VertI, VertD);</span>
3485             <span class="comment">% catch</span>
3486             <span class="comment">%     disp('   Trouble setting Fast Orbit Feedback parameters!');</span>
3487             <span class="comment">% end</span>
3488 
3489         <span class="keyword">else</span>
3490             <span class="comment">% Get vectors</span>
3491             FOFB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
3492             FOFBFreq = FOFB.FOFBFreq;
3493             HorP  = FOFB.HorP;
3494             HorI  = FOFB.HorI;
3495             HorD  = FOFB.HorD;
3496             VertP = FOFB.VertP;
3497             VertI = FOFB.VertI;
3498             VertD = FOFB.VertD;
3499 
3500             <span class="comment">% Add button to change #ivectors, CMs, IDBPMs,</span>
3501             EditFlag = 0;
3502             <span class="comment">%h_fig1 = figure;</span>
3503             <span class="keyword">while</span> EditFlag ~= 3
3504 
3505                 <span class="comment">%EditFlag = menu('Change Parameters?', 'Fast Feedback Frequency', 'PID Values', 'HCM List', 'VCM List', ...</span>
3506                 <span class="comment">%   'IDBPM List', 'BBPM List', 'Continue');</span>
3507                 <span class="comment">% Use menu below until other FFB config routines work (then also uncomment options 3,4,5,6 below)</span>
3508                 EditFlag = menu(<span class="string">'Change Parameters?'</span>, <span class="string">'Fast Feedback Frequency'</span>, <span class="string">'PID Values'</span>, <span class="string">'Continue'</span>);
3509 
3510                 <span class="keyword">if</span> EditFlag == 1
3511                     <span class="comment">% change rate</span>
3512 
3513                     prompt={<span class="string">'Enter the desired Fast Feedback Frequency (1-1000 Hz)'</span>};
3514                     def={num2str(FOFBFreq)};
3515                     titlestr=<span class="string">'Fast Feedback Setup'</span>;
3516                     lineNo=1;
3517                     answer=inputdlg(prompt,titlestr,lineNo,def);
3518                     <span class="keyword">if</span> ~isempty(answer)
3519                         FOFBFreq = fix(str2num(answer{1}));
3520                         <span class="keyword">if</span> isempty(FOFBFreq)
3521                             disp(<span class="string">'   Frequency value cannot be empty.  No change made.'</span>);
3522                             FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3523                         <span class="keyword">else</span>
3524                             <span class="keyword">if</span> FOFBFreq &lt; 1 | FOFBFreq &gt; 1000
3525                                 disp(<span class="string">'   Frequency must be between 1 and 1000 Hz.  No change made.'</span>);
3526                                 FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3527                             <span class="keyword">end</span>
3528                         <span class="keyword">end</span>
3529                         setsp(<span class="string">'SR01____FFBFREQAC00'</span>,FOFBFreq   ); <span class="comment">% change freq</span>
3530                         pause(0.5);
3531                         fprintf(<span class="string">'   Fast orbit feedback frequency is running at %.0f Hz.\n'</span>, getpv(<span class="string">'SR01____FFBFREQAM00'</span>));
3532                     <span class="keyword">else</span>
3533                         FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3534                     <span class="keyword">end</span>
3535                 <span class="keyword">end</span>
3536 
3537                 <span class="keyword">if</span> EditFlag == 2
3538                     <span class="comment">% edit  PIDs</span>
3539                     <span class="comment">% User defaults are HorP=2, HorI=300, HorD=0.002, VertP=1, VertI=100, VertD=0.0015</span>
3540                     prompt={<span class="string">'P horizontal'</span>, <span class="string">'I horizontal'</span>, <span class="string">'D horizontal'</span>, <span class="string">'P vertical'</span>, <span class="string">'I vertical'</span>, <span class="string">'D vertical'</span>};
3541                     def={num2str(HorP), num2str(HorI), num2str(HorD), num2str(VertP), num2str(VertI), num2str(VertD)};
3542                     titlestr=<span class="string">'Fast Feedback PID Setup'</span>;
3543                     lineNo=1;
3544                     answer=inputdlg(prompt,titlestr,lineNo,def);
3545                     <span class="keyword">if</span> ~isempty(answer)
3546                         HorPnewnum = str2num(answer{1});
3547                         <span class="keyword">if</span> isempty(HorPnewnum)
3548                             disp(<span class="string">'   HorP value cannot be empty.  No change made.'</span>);
3549                         <span class="keyword">else</span>
3550                             HorP = HorPnewnum;
3551                         <span class="keyword">end</span>
3552                         HorInewnum = str2num(answer{2});
3553                         <span class="keyword">if</span> isempty(HorInewnum)
3554                             disp(<span class="string">'   HorI value cannot be empty.  No change made.'</span>);
3555                         <span class="keyword">else</span>
3556                             HorI = HorInewnum;
3557                         <span class="keyword">end</span>
3558                         HorDnewnum = str2num(answer{3});
3559                         <span class="keyword">if</span> isempty(HorDnewnum)
3560                             disp(<span class="string">'   HorD value cannot be empty.  No change made.'</span>);
3561                         <span class="keyword">else</span>
3562                             HorD = HorDnewnum;
3563                         <span class="keyword">end</span>
3564                         VertPnewnum = str2num(answer{4});
3565                         <span class="keyword">if</span> isempty(VertPnewnum)
3566                             disp(<span class="string">'   VertP value cannot be empty.  No change made.'</span>);
3567                         <span class="keyword">else</span>
3568                             VertP = VertPnewnum;
3569                         <span class="keyword">end</span>
3570                         VertInewnum = str2num(answer{5});
3571                         <span class="keyword">if</span> isempty(VertInewnum)
3572                             disp(<span class="string">'   VertI value cannot be empty.  No change made.'</span>);
3573                         <span class="keyword">else</span>
3574                             VertI = VertInewnum;
3575                         <span class="keyword">end</span>
3576                         VertDnewnum = str2num(answer{6});
3577                         <span class="keyword">if</span> isempty(VertDnewnum)
3578                             disp(<span class="string">'   VertD value cannot be empty.  No change made.'</span>);
3579                         <span class="keyword">else</span>
3580                             VertD = VertDnewnum;
3581                         <span class="keyword">end</span>
3582 
3583                         <span class="keyword">try</span>
3584                             write_pid_ffb2_patch(HorP, HorI, HorD, VertP, VertI, VertD);
3585                             fprintf(<span class="string">'   Setting FFB gains to Horizontal P=%.2f, I=%.1f, D=%.4f;  Vertical P=%.2f, I=%.1f, D=%.4f\n'</span>, HorP, HorI, HorD, VertP, VertI, VertD);
3586                         <span class="keyword">catch</span>
3587                             disp(<span class="string">'   Trouble setting Fast Orbit Feedback parameters!'</span>);
3588                         <span class="keyword">end</span>
3589                     <span class="keyword">end</span>
3590                 <span class="keyword">end</span>
3591 
3592                 <span class="comment">%if EditFlag == 3</span>
3593                 <span class="comment">%   disp('   This function not yet available.');</span>
3594                 <span class="comment">%   % change HCM List</span>
3595                 <span class="comment">%end</span>
3596                 <span class="comment">%</span>
3597                 <span class="comment">%if EditFlag == 4</span>
3598                 <span class="comment">%   disp('   This function not yet available.');</span>
3599                 <span class="comment">%   % change VCM List</span>
3600                 <span class="comment">%end</span>
3601                 <span class="comment">%</span>
3602                 <span class="comment">%if EditFlag == 5</span>
3603                 <span class="comment">%   disp('   This function not yet available.');</span>
3604                 <span class="comment">%   % change IDBPM List</span>
3605                 <span class="comment">%end</span>
3606                 <span class="comment">%</span>
3607                 <span class="comment">%if EditFlag == 6</span>
3608                 <span class="comment">%   disp('   This function not yet available.');</span>
3609                 <span class="comment">%   % change BBPM List</span>
3610                 <span class="comment">%end</span>
3611 
3612             <span class="keyword">end</span>
3613             <span class="comment">%close(h_fig1);</span>
3614         <span class="keyword">end</span>
3615 
3616         <span class="comment">% Save vectors</span>
3617         FOFB.FOFBFreq = FOFBFreq;
3618         FOFB.HorP = HorP;
3619         FOFB.HorI = HorI;
3620         FOFB.HorD = HorD;
3621         FOFB.VertP = VertP;
3622         FOFB.VertI = VertI;
3623         FOFB.VertD = VertD;
3624         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Userdata'</span>,FOFB);
3625 
3626     <span class="keyword">otherwise</span>
3627         fprintf(<span class="string">'   No action for %s.\n'</span>, action);
3628 <span class="keyword">end</span>   <span class="comment">% end case</span></pre></div>
<hr><address>Generated on Thu 02-Aug-2007 13:16:07 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>