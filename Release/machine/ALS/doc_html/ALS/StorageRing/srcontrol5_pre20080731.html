<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of srcontrol5_pre20080731</title>
  <meta name="keywords" content="srcontrol5_pre20080731">
  <meta name="description" content="srcontrol5">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">ALS</a> &gt; <a href="index.html">StorageRing</a> &gt; srcontrol5_pre20080731.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for ALS\StorageRing&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>srcontrol5_pre20080731
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>srcontrol5</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function srcontrol5(action, Input2, Input3) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> srcontrol5
 Storage ring control program

 This program controls all storage ring magnets, performs orbit feedback and
 tune feedforward and helps to diagnose problems in routine user operation
 of the ALS storage ring. It includes a gui to simplify the use of this
 program.

 It was originally programmed by Greg Portmann (until December 2000) with input
 from Winfried Decking, David Robin, Christoph Steier, Ying Wu and others
 and is currently (July 2002) maintained by Christoph Steier and Tom Scarvie.

 The actual version of this program is srcontrol5 (is called by default if you call srcontrol).

 Christoph Steier, July 2002

 SRCONTROL5 is the newest versionof SRCONTROL, edited to work with G. Portmann's new (2005) Matlab middle layer.

 Tom Scarvie, April 2005</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="amp2k.html" class="code" title="function [k, B] = amp2k(Family, Field, Amps, DeviceList, Energy, BranchFlag)">amp2k</a>	AMP2K - Converts amperes to simulator values</li><li><a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>	BEND2GEV - Compute the energy based on the ramp tables</li><li><a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>	CHECKSRMAGS - Check SR power supplies against a lattice file</li><li><a href="checksrorbit.html" class="code" title="function ErrorNums = checksrorbit(SectorList, BPMxtol,BPMytol)">checksrorbit</a>	ErrorNums =checksrorbit(Sector, BPMxtolerance [.015 mm], [BPMytolerance [.015 mm]])</li><li><a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>	GAP2TUNE - Computes the vertical tune shift for a insertion device gap change.</li><li><a href="gaplimit.html" class="code" title="function [GAPmin, GAPmax] = gaplimit(DeviceList)">gaplimit</a>	[GapMin, GapMax] = gaplimit(DeviceList)</li><li><a href="getbpmlist.html" class="code" title="function [DeviceList, Index] = getbpmlist(varargin)">getbpmlist</a>	GETBPMLIST - Return a BPM list based on key words and sector numbers</li><li><a href="getbpmtimeconstant.html" class="code" title="function [BPMTimeConstant, WarningFlag] = getbpmtimeconstant(varargin)">getbpmtimeconstant</a>	GETBPMTIMECONSTANT - Sets the timeconstants for the Bergoz style BPMs.</li><li><a href="getff.html" class="code" title="function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)">getff</a>	GETFF - Get the state of insertion device feed forward and user gap contr5ol</li><li><a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>	GETID - Get the insertion device position, velocity, run flag, and user requested gap</li><li><a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>	[StateNumber, StateString] = getsrstate</li><li><a href="ocsinit.html" class="code" title="function [HBPM, VBPM, HCM, VCM, HSV, VSV] = ocsinit(MethodName)">ocsinit</a>	OCSINIT - Corrector and BPM</li><li><a href="set_alarmhandler_AHU_thresholds_inject.html" class="code" title="function set_alarmhandler_AHU_thresholds_inject">set_alarmhandler_AHU_thresholds_inject</a>	function set_alarmhandler_AHU_thresholds_inject</li><li><a href="set_etaywave_nuy9_20skews_skewFF.html" class="code" title="function [SQSFincr, SQSDincr] = set_etaywave_nuy9_20skews_skewFF(scale);">set_etaywave_nuy9_20skews_skewFF</a>	function [SQSFincr, SQSDincr] = set_etaywave_nuy9_20skews_skewFF(scale);</li><li><a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>	SETBPMTIMECONSTANT - Sets the timeconstants for the Bergoz style BPMs.</li><li><a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>	SETBUMPS - Make a straight section bump</li><li><a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>	function setff(DeviceList, FFEnableBC, GapEnableBC)</li><li><a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag)">setid</a>	SETID - Set the insertion device vertical gap</li><li><a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>	</li><li><a href="shift2tune.html" class="code" title="function [Dnux, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = shift2tune(Sector, Gap, EPUshift, GeV)">shift2tune</a>	SHIFT2TUNE - Computes the horizontal tune shift for a EPU gap and horizontal shift</li><li><a href="srcycle.html" class="code" title="function FailFlag = srcycle(varargin)">srcycle</a>	SRCYCLE - Storage ring cycle</li><li><a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>	SRRAMP - Ramp the storage ring energy</li><li><a href="write_goldenorbit_ffb.html" class="code" title="function write_goldenorbit_ffb">write_goldenorbit_ffb</a>	function write_goldenorbit_ffb</li><li><a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>	WRITE_GOLDENORBIT_FFTB_2PLANES - Sets the BPM setpoints which are used by the fast feedback system</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function srcontrol5(action, Input2, Input3)</a>
0002 <span class="comment">% srcontrol5</span>
0003 <span class="comment">% Storage ring control program</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% This program controls all storage ring magnets, performs orbit feedback and</span>
0006 <span class="comment">% tune feedforward and helps to diagnose problems in routine user operation</span>
0007 <span class="comment">% of the ALS storage ring. It includes a gui to simplify the use of this</span>
0008 <span class="comment">% program.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% It was originally programmed by Greg Portmann (until December 2000) with input</span>
0011 <span class="comment">% from Winfried Decking, David Robin, Christoph Steier, Ying Wu and others</span>
0012 <span class="comment">% and is currently (July 2002) maintained by Christoph Steier and Tom Scarvie.</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% The actual version of this program is srcontrol5 (is called by default if you call srcontrol).</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% Christoph Steier, July 2002</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% SRCONTROL5 is the newest versionof SRCONTROL, edited to work with G. Portmann's new (2005) Matlab middle layer.</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% Tom Scarvie, April 2005</span>
0021 
0022 <span class="comment">% known bugs/problems (May 2001):</span>
0023 <span class="comment">% - IDBPM averaging might be a bit too long for orbit feedback</span>
0024 <span class="comment">%        solved after Superbend shutdown ... Instead of averaging, digital low pass filters are used</span>
0025 <span class="comment">% - gap2tune does not give correct answers for wiggler and potentially other IDs -&gt; orbit feedback</span>
0026 <span class="comment">%        seems to be OK for other IDs, has been corrected for wiggler (fit to insertion device</span>
0027 <span class="comment">%        compensation table)</span>
0028 <span class="comment">% - chicanes do not work in orbit feedback</span>
0029 <span class="comment">%        solved. One problem was that orbit response matrizes were mis-scaled by factor of two.</span>
0030 <span class="comment">%        Second problem was different time constant of power supply control. Solved by moving controls</span>
0031 <span class="comment">%        of center chicanes to cPCI (and magnets are fast, hysteresis free, aircore coils).</span>
0032 <span class="comment">%        Center chicane in sector 4 is now routinely used in orbit feedback. Sector 11 to follow soon.</span>
0033 <span class="comment">% - zero reading of ID gap dumps beam</span>
0034 <span class="comment">%        solved in srcontrol5, still a problem in srcontrol5_hightune (but that routine has to be completely</span>
0035 <span class="comment">%        rewritten because of all recent changes to srcontrol5, anyhow). For gap readings below the minimum</span>
0036 <span class="comment">%        allowed gap for a device, the tune feedforward disables itself.</span>
0037 <span class="comment">% - cycling of lattice causes frequent power supply failures</span>
0038 <span class="comment">%        solved by changing the cycling procedure. 1.5 GeV operation is now on the upper hysteresis branch</span>
0039 <span class="comment">%        as was the 1.9 GeV injection lattice before.</span>
0040 <span class="comment">% - frequently stalled data in IDBPM readout</span>
0041 <span class="comment">%        solved with new BPM readouts and digital filtering. Seems to have been a resolution problem</span>
0042 <span class="comment">%        of the digital averaging algorithm.</span>
0043 <span class="comment">% - magnet ramp tables are not in perfect agreement with magnetic measurements</span>
0044 <span class="comment">%        Does not appear to be a serious problem. Superbends are slightly out of sync with other magnets,</span>
0045 <span class="comment">%        but this does not cause any negative effects while ramping.</span>
0046 <span class="comment">% - no good way to operate with injection at 1.5 GeV and storage energy below that</span>
0047 <span class="comment">%        There now is a reasonable way to inject at 1.5 GeV and ramp down to lower storage energy. But</span>
0048 <span class="comment">%        it has to be tested again after implementing new (and more) chicanes ...</span>
0049 
0050 <span class="comment">% revision history</span>
0051 <span class="comment">% 2001-05-10, Christoph Steier</span>
0052 <span class="comment">% check whether readback from insertion device is significantly (more than 1 mm) below minimum</span>
0053 <span class="comment">% gap, to avoid false zero readings of insertion device gaps to cause the tune feed forward</span>
0054 <span class="comment">% to implement false huge correction (and dump the beam). If the insertion device gap readbacks</span>
0055 <span class="comment">% gets more than 1 mm below the nominal minimum gap, the routine now assumes the insertion device</span>
0056 <span class="comment">% to be open.</span>
0057 <span class="comment">%</span>
0058 <span class="comment">% 2001-08-30 and during Superbend commissioning, Christoph Steier, Tom Scarvie, Winni Decking</span>
0059 <span class="comment">% various changes have been made to incorporate the Superbends and some other new equipment</span>
0060 <span class="comment">% installed in the Superbend shutdown. This included some changes to programs being called by srcontrol</span>
0061 <span class="comment">% (like srload, srsave, srcycle, srramp, ...). The main changes within srcontrol were in the orbit</span>
0062 <span class="comment">% correction and slow orbit feedback routines (incorporating frequency feedback, ...)</span>
0063 <span class="comment">%</span>
0064 <span class="comment">% 2002-05-04, Christoph Steier</span>
0065 <span class="comment">% added new IDBPMs, modified orbit feedback to use trim DACs, removed LSB toggling in vertical</span>
0066 <span class="comment">% orbit feedback, ...</span>
0067 <span class="comment">%</span>
0068 <span class="comment">% 2002-07-29, T.Scarvie</span>
0069 <span class="comment">% added check of CM trim currents to warn of problems that might rail the orbit feedback</span>
0070 <span class="comment">%</span>
0071 <span class="comment">% 2002-07-31, Christoph Steier</span>
0072 <span class="comment">% increased the gain of the RF frequency feedback from 1/50 of the gain of the horizontal</span>
0073 <span class="comment">% orbit feedback to 1/20. Reason was that the frequency feedback was reacting a bit too slow if all</span>
0074 <span class="comment">% insertion device gaps are closed at once at high speed at the beginning of a fill.</span>
0075 <span class="comment">%</span>
0076 <span class="comment">% 2002-08-05, C.Steier, T.Scarvie</span>
0077 <span class="comment">% Added conditional to reduce orbit feedback gain if running in two-bunch mode</span>
0078 <span class="comment">%</span>
0079 <span class="comment">% 2003-06-02, T.Scarvie</span>
0080 <span class="comment">% Added loop inside orbit feedback to reset the SR11 chicane M1 and M2 motors every 20s to combat drift problem</span>
0081 <span class="comment">%</span>
0082 <span class="comment">% 2003-06-18, C. Steier</span>
0083 <span class="comment">% Disabled loop to periodically reset chicane in SR11. Al Robb replaced power supply, seems to be no problem anymore.</span>
0084 <span class="comment">%</span>
0085 <span class="comment">% 2004-05-10, C. Steier</span>
0086 <span class="comment">% The list of all BBPMs is now set up automatically be calling getlist('BBPMx'). This way, new BBPMs have to be added</span>
0087 <span class="comment">% at fewer places in the software. It should now be sufficient to modify getlist and run the orbit response matrix</span>
0088 <span class="comment">% rountine (getsmat) once to enable use of the new BBPMs.</span>
0089 <span class="comment">%</span>
0090 <span class="comment">% 2004-05-14, C. Steier</span>
0091 <span class="comment">% Modified parameters for ramprate reduction (in srramp and here). Previous parameters were slightly too</span>
0092 <span class="comment">% cautious. Increased initial slow ramprate to 0.4 A/s.</span>
0093 <span class="comment">%</span>
0094 <span class="comment">% 2004-05-14, C. Steier</span>
0095 <span class="comment">% Incorporated insertion device compensation schemes for nu_y = 9.2 lattice.</span>
0096 <span class="comment">%</span>
0097 <span class="comment">% 2004-06-14, T.Scarvie</span>
0098 <span class="comment">% Added controls for fast orbit feedback</span>
0099 <span class="comment">%</span>
0100 <span class="comment">% 2004-06-21, C. Steier</span>
0101 <span class="comment">% Added tune feedforward (in the global tune compensation scheme for the nu_y=9.2 lattice) for the shift</span>
0102 <span class="comment">% dependent tune shift of the EPUs, as well as a skew quadrupole feedforward for the EPU im sector 11</span>
0103 <span class="comment">% (both only active in parallel mode so far).</span>
0104 <span class="comment">%</span>
0105 <span class="comment">% 2005-02-13, T.Scarvie</span>
0106 <span class="comment">% Separated horizontal and vertical planes for setting Fast Feedback PIDs</span>
0107 
0108 
0109 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0110 <span class="comment">% NOTES for conversion to new Middle Layer %</span>
0111 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0112 <span class="comment">%</span>
0113 <span class="comment">% We never use the gap and bump control flags - the radio buttons have been disabled -</span>
0114 <span class="comment">%        should we try to keep the functionality?</span>
0115 <span class="comment">%</span>
0116 <span class="comment">% checksrmags</span>
0117 <span class="comment">% checksrorbit(...)</span>
0118 
0119 
0120 <span class="comment">% For the compiler</span>
0121 <span class="comment">%#function goldenpage</span>
0122 <span class="comment">%#function setoperationalmode</span>
0123 
0124 
0125 <span class="comment">% Check if the AO exists</span>
0126 checkforao;
0127 
0128 
0129 <span class="comment">%%%%%%%%%%%%%%</span>
0130 <span class="comment">% Initialize %</span>
0131 <span class="comment">%%%%%%%%%%%%%%</span>
0132 
0133 <span class="keyword">global</span> FEEDBACK_STOP_FLAG
0134 
0135 SR_Mode = getfamilydata(<span class="string">'OperationalMode'</span>);
0136 SR_GEV = getfamilydata(<span class="string">'Energy'</span>);
0137 
0138 BSCramprate = getfamilydata(<span class="string">'BSCRampRate'</span>);
0139 <span class="keyword">if</span> isnan(BSCramprate) || isempty(BSCramprate)
0140     BSCramprate = 0.4;
0141     setfamilydata(BSCramprate, <span class="string">'BSCRampRate'</span>);
0142 <span class="keyword">end</span>
0143 
0144 <span class="keyword">if</span> nargin &lt; 1
0145     action = <span class="string">'Initialize'</span>;
0146 <span class="keyword">end</span>
0147 <span class="keyword">if</span> nargin &lt; 2
0148     Input2 = 0;
0149 <span class="keyword">end</span>
0150 <span class="keyword">if</span> nargin &lt; 3
0151     Input3 = 0;
0152 <span class="keyword">end</span>
0153 
0154 <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
0155     FOFBcheckboxVal = 0;
0156 <span class="keyword">else</span>
0157     FOFBcheckboxVal = 1;
0158 <span class="keyword">end</span>
0159 
0160 <span class="comment">% if strcmp(getfamilydata('OperationalMode'), '1.5 GeV, Inject at 1.23') || strcmp(SR_Mode, '1.9 GeV, Inject at 1.353')</span>
0161 <span class="comment">%     TUNEcheckboxVal = 0;</span>
0162 <span class="comment">% else</span>
0163 TUNEcheckboxVal = 1;
0164 <span class="comment">% end</span>
0165 
0166 <span class="comment">%%%%%%%%%%%%%%%%</span>
0167 <span class="comment">% Main Program %</span>
0168 <span class="comment">%%%%%%%%%%%%%%%%</span>
0169 
0170 <span class="keyword">switch</span>(action)
0171 
0172     <span class="keyword">case</span> <span class="string">'StopOrbitFeedback'</span>
0173 
0174         FEEDBACK_STOP_FLAG = 1;
0175 
0176     <span class="keyword">case</span> <span class="string">'Initialize'</span>
0177 
0178         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0179         <span class="comment">% GUI</span>
0180         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0181         ButtonWidth = 200;
0182         ButtonHeight  = 25;
0183 
0184         Offset1 = 8*25+12 + 47 + 25+25;
0185         Offset2 = 47+25+25;
0186         Offset3 = 45+25;
0187         Offset4 = 1;
0188         Offset5 = 30;
0189         FigWidth = ButtonWidth+6;
0190         FigHeight  = 3+9*(ButtonHeight+6)+24+Offset1;
0191         ButtonWidth = 200-6;
0192 
0193         <span class="comment">% Change figure position</span>
0194         set(0,<span class="string">'Units'</span>,<span class="string">'pixels'</span>);
0195         p=get(0,<span class="string">'screensize'</span>);
0196 
0197         h0 = figure( <span class="keyword">...</span>
0198             <span class="string">'Color'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0199             <span class="string">'HandleVisibility'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0200             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0201             <span class="string">'MenuBar'</span>,<span class="string">'none'</span>, <span class="keyword">...</span>
0202             <span class="string">'Name'</span>,<span class="string">'ALS SR CONTROL'</span>, <span class="keyword">...</span>
0203             <span class="string">'NumberTitle'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0204             <span class="string">'Units'</span>,<span class="string">'pixels'</span>, <span class="keyword">...</span>
0205             <span class="string">'Position'</span>,[30 p(4)-FigHeight-40 FigWidth FigHeight+Offset5], <span class="keyword">...</span>
0206             <span class="string">'Resize'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0207             <span class="string">'Tag'</span>,<span class="string">'SRCTRLFig1'</span>);
0208 
0209         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0210             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0211             <span class="string">'Callback'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0212             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0213             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0214             <span class="string">'FontWeight'</span>,<span class="string">'Bold'</span>, <span class="keyword">...</span>
0215             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0216             <span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>, <span class="keyword">...</span>
0217             <span class="string">'Position'</span>,[6 3+8*(ButtonHeight+3)+19+19+8+Offset1  ButtonWidth 20+Offset5], <span class="keyword">...</span>
0218             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0219             <span class="string">'String'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0220             <span class="string">'Tag'</span>,<span class="string">'SRCTRLTitle'</span>);
0221 
0222         <span class="comment">% Frame Box I</span>
0223         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0224             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0225             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0226             <span class="string">'Position'</span>,[3 3+3*(ButtonHeight+3)+Offset1-3+Offset5 ButtonWidth+6 7*ButtonHeight+18], <span class="keyword">...</span>
0227             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0228 
0229         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0230             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0231             <span class="string">'Callback'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0232             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0233             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0234             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0235             <span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>, <span class="keyword">...</span>
0236             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)+Offset1  ButtonWidth 15+Offset5], <span class="keyword">...</span>
0237             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0238             <span class="string">'String'</span>,<span class="string">'Lattice Setup Functions'</span>);
0239 
0240         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0241             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Cycle'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0242             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0243             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0244             <span class="string">'Position'</span>,[6 3+8*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0245             <span class="string">'String'</span>,<span class="string">'Cycle SR Lattice'</span>, <span class="keyword">...</span>
0246             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>);
0247 
0248         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0249             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Injection'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0250             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0251             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0252             <span class="string">'Position'</span>,[6 3+7*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0253             <span class="string">'String'</span>,<span class="string">'Injection'</span>, <span class="keyword">...</span>
0254             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>);
0255 
0256         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0257             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Production'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0258             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0259             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0260             <span class="string">'Position'</span>,[6 3+6*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0261             <span class="string">'String'</span>,[<span class="string">'Production'</span>], <span class="keyword">...</span>
0262             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>);
0263 
0264         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0265             <span class="string">'Callback'</span>,[<span class="keyword">...</span>
0266             <span class="string">'fprintf(''\n'');'</span> <span class="keyword">...</span>
0267             <span class="string">'disp([''   **********************************************'']);'</span>, <span class="keyword">...</span>
0268             <span class="string">'disp([''   **  Changing Storage Ring Operational Mode  **'']);'</span>, <span class="keyword">...</span>
0269             <span class="string">'disp([''   **********************************************'']);'</span>, <span class="keyword">...</span>
0270             <span class="string">'setoperationalmode;'</span>, <span class="keyword">...</span>
0271             <span class="string">'srcontrol5(''CheckInputs'');'</span>, <span class="keyword">...</span>
0272             <span class="string">'disp([''   ****************************'']);'</span>, <span class="keyword">...</span>
0273             <span class="string">'disp([''   **  Mode Change Complete  **'']);'</span>, <span class="keyword">...</span>
0274             <span class="string">'disp([''   ****************************'']);'</span>, <span class="keyword">...</span>
0275             <span class="string">'fprintf(''\n'');'</span>], <span class="keyword">...</span>
0276             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0277             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0278             <span class="string">'Position'</span>,[6 3+5*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0279             <span class="string">'Value'</span>,1, <span class="keyword">...</span>
0280             <span class="string">'String'</span>,<span class="string">'Change Operational Mode'</span>, <span class="keyword">...</span>
0281             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>);
0282 
0283         h1 = uicontrol(<span class="keyword">...</span>
0284             <span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0285             <span class="string">'Callback'</span>, [<span class="keyword">...</span>
0286             <span class="string">'srcontrol5(''CheckInputs'');'</span>,<span class="keyword">...</span>
0287             <span class="string">'srcontrol5(''SRState'');'</span>], <span class="keyword">...</span>
0288             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0289             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0290             <span class="string">'Position'</span>,[6 3+4*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0291             <span class="string">'String'</span>,<span class="string">'Check For Problems'</span>, <span class="keyword">...</span>
0292             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>);
0293 
0294         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0295             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs''); goldenpage;'</span>, <span class="keyword">...</span>
0296             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0297             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0298             <span class="string">'Position'</span>,[6 3+3*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0299             <span class="string">'String'</span>,<span class="string">'Golden Page'</span>, <span class="keyword">...</span>
0300             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>);
0301 
0302 
0303         <span class="comment">% Frame Box II</span>
0304         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0305             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0306             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0307             <span class="string">'Position'</span>,[3 3+9*(ButtonHeight+3)-29+Offset2+Offset5 ButtonWidth+6 2*ButtonHeight+15], <span class="keyword">...</span>
0308             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0309         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0310             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0311             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0312             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0313             <span class="string">'Position'</span>,[6 3+10*(ButtonHeight+3)-10+Offset2 ButtonWidth .6*ButtonHeight+Offset5], <span class="keyword">...</span>
0314             <span class="string">'String'</span>,<span class="string">'Global/Local Orbit Correction'</span>, <span class="keyword">...</span>
0315             <span class="string">'Style'</span>,<span class="string">'text'</span>);
0316         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0317             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''OrbitCorrection'');'</span>, <span class="keyword">...</span>
0318             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0319             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0320             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)-6+Offset2+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0321             <span class="string">'String'</span>,<span class="string">'Correct Global Orbit w/ IDBPMs'</span>, <span class="keyword">...</span>
0322             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>);
0323         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0324             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''OrbitCorrectionSetup'',1);'</span>, <span class="keyword">...</span>
0325             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''OrbitCorrectionSetup'',0);'</span>, <span class="keyword">...</span>
0326             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0327             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0328             <span class="string">'Position'</span>,[6 9*(ButtonHeight+3)-22+Offset2+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0329             <span class="string">'String'</span>,<span class="string">'Edit IDBPM, CM, &amp; Local Bump Lists'</span>, <span class="keyword">...</span>
0330             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0331             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0332             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>);
0333 
0334 
0335         <span class="comment">% Frame Box III</span>
0336         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0337             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0338             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0339             <span class="string">'Position'</span>,[3 1*(ButtonHeight)+Offset3+Offset5-38 ButtonWidth+6 8*ButtonHeight+61], <span class="keyword">...</span>
0340             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0341         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0342             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0343             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0344             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0345             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)+Offset3-25 ButtonWidth .55*ButtonHeight+Offset5], <span class="keyword">...</span>
0346             <span class="string">'String'</span>,<span class="string">'Orbit Feedback'</span>, <span class="keyword">...</span>
0347             <span class="string">'Style'</span>,<span class="string">'text'</span>);
0348 
0349         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0350             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0351             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0352             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0353             <span class="string">'Position'</span>,[26 3+8*(ButtonHeight+3)+Offset3-18+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0354             <span class="string">'String'</span>,<span class="string">'Slow Orbit Correction'</span>, <span class="keyword">...</span>
0355             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0356             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0357             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxSOFB'</span>);
0358         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0359             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0360             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0361             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0362             <span class="string">'Position'</span>,[26 3+7*(ButtonHeight+3)+Offset3-9+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0363             <span class="string">'String'</span>,<span class="string">'Fast Orbit Correction'</span>, <span class="keyword">...</span>
0364             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0365             <span class="string">'Value'</span>,FOFBcheckboxVal,<span class="keyword">...</span>
0366             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxFOFB'</span>);
0367 
0368         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0369             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0370             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0371             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0372             <span class="string">'Position'</span>,[26 3+6*(ButtonHeight+3)+Offset3+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0373             <span class="string">'String'</span>,<span class="string">'Correct ID Tune Shift  '</span>, <span class="keyword">...</span>
0374             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0375             <span class="string">'Value'</span>,TUNEcheckboxVal,<span class="keyword">...</span>
0376             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxTune'</span>);
0377 
0378         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0379             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0380             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0381             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0382             <span class="string">'Position'</span>,[26 3+5*(ButtonHeight+3)+Offset3+9+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0383             <span class="string">'String'</span>,<span class="string">'Correct RF Frequency'</span>, <span class="keyword">...</span>
0384             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0385             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0386             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>);
0387 
0388         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0389             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''Feedback'');'</span>, <span class="keyword">...</span>
0390             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0391             <span class="string">'FontSize'</span>,12, <span class="keyword">...</span>
0392             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0393             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0394             <span class="string">'Position'</span>,[8 3+5*(ButtonHeight+3)+3+Offset3-25+Offset5 .5*ButtonWidth-6 1.0*ButtonHeight], <span class="keyword">...</span>
0395             <span class="string">'String'</span>,<span class="string">'Start FB'</span>, <span class="keyword">...</span>
0396             <span class="string">'Value'</span>,0, <span class="keyword">...</span>
0397             <span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>);
0398         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0399             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''StopOrbitFeedback'');pause(0);'</span>, <span class="keyword">...</span>
0400             <span class="string">'Enable'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0401             <span class="string">'FontSize'</span>,12, <span class="keyword">...</span>
0402             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0403             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0404             <span class="string">'Position'</span>,[.5*FigWidth+3 3+5*(ButtonHeight+3)+3+Offset3-25+Offset5 .5*ButtonWidth-6 1.0*ButtonHeight], <span class="keyword">...</span>
0405             <span class="string">'String'</span>,<span class="string">'Stop FB'</span>, <span class="keyword">...</span>
0406             <span class="string">'Value'</span>,0, <span class="keyword">...</span>
0407             <span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>);
0408 
0409         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0410             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0411             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0412             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0413             <span class="string">'Position'</span>,[14 4*(ButtonHeight)+Offset3+Offset5-3 ButtonWidth-14 .75*ButtonHeight], <span class="keyword">...</span>
0414             <span class="string">'String'</span>,<span class="string">'Horizontal RMS = _____ mm'</span>, <span class="keyword">...</span>
0415             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0416             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>);
0417         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0418             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0419             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0420             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0421             <span class="string">'Position'</span>,[26 3+3.5*(ButtonHeight)+16+Offset3-25+Offset5 ButtonWidth-26 .75*ButtonHeight], <span class="keyword">...</span>
0422             <span class="string">'String'</span>,<span class="string">'Vertical RMS = _____ mm'</span>, <span class="keyword">...</span>
0423             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0424             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>);
0425 
0426         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0427             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''FeedbackSetup'',1);'</span>, <span class="keyword">...</span>
0428             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''FeedbackSetup'',0);'</span>, <span class="keyword">...</span>
0429             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0430             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0431             <span class="string">'Position'</span>,[8 3+3.5*(ButtonHeight)+.5+Offset3-25+Offset5 ButtonWidth-5 .75*ButtonHeight], <span class="keyword">...</span>
0432             <span class="string">'String'</span>,<span class="string">'Edit SOFB Setup'</span>, <span class="keyword">...</span>
0433             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0434             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0435             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>);
0436 
0437         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0438             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0439             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0440             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0441             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0442             <span class="string">'String'</span>,<span class="string">'01 ____'</span>, <span class="keyword">...</span>
0443             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0444             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0445             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>);
0446 
0447         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0448             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0449             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0450             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0451             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0452             <span class="string">'String'</span>,<span class="string">'02 ____'</span>, <span class="keyword">...</span>
0453             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0454             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0455             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>);
0456 
0457         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0458             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0459             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0460             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0461             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0462             <span class="string">'String'</span>,<span class="string">'03 ____'</span>, <span class="keyword">...</span>
0463             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0464             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0465             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>);
0466 
0467         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0468             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0469             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0470             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0471             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0472             <span class="string">'String'</span>,<span class="string">'04 ____'</span>, <span class="keyword">...</span>
0473             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0474             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0475             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>);
0476 
0477         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0478             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0479             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0480             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0481             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0482             <span class="string">'String'</span>,<span class="string">'05 ____'</span>, <span class="keyword">...</span>
0483             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0484             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0485             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>);
0486 
0487         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0488             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0489             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0490             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0491             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0492             <span class="string">'String'</span>,<span class="string">'06 ____'</span>, <span class="keyword">...</span>
0493             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0494             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0495             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>);
0496 
0497         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0498             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0499             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0500             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0501             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0502             <span class="string">'String'</span>,<span class="string">'07 ____'</span>, <span class="keyword">...</span>
0503             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0504             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0505             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>);
0506 
0507         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0508             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0509             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0510             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0511             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0512             <span class="string">'String'</span>,<span class="string">'08 ____'</span>, <span class="keyword">...</span>
0513             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0514             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0515             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>);
0516 
0517         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0518             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0519             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0520             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0521             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0522             <span class="string">'String'</span>,<span class="string">'09 ____'</span>, <span class="keyword">...</span>
0523             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0524             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0525             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>);
0526 
0527         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0528             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0529             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0530             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0531             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0532             <span class="string">'String'</span>,<span class="string">'10 ____'</span>, <span class="keyword">...</span>
0533             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0534             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0535             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>);
0536 
0537         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0538             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0539             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0540             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0541             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0542             <span class="string">'String'</span>,<span class="string">'11 ____'</span>, <span class="keyword">...</span>
0543             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0544             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0545             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>);
0546 
0547         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0548             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0549             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0550             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0551             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0552             <span class="string">'String'</span>,<span class="string">'12 ____'</span>, <span class="keyword">...</span>
0553             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0554             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0555             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>);
0556 
0557         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0558             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''FastFeedbackSetup'',1);'</span>, <span class="keyword">...</span>
0559             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''FastFeedbackSetup'',0);'</span>, <span class="keyword">...</span>
0560             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0561             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0562             <span class="string">'Position'</span>,[8 1*(ButtonHeight)+Offset3-3 ButtonWidth-5 .75*ButtonHeight], <span class="keyword">...</span>
0563             <span class="string">'String'</span>,<span class="string">'Edit FOFB Setup'</span>, <span class="keyword">...</span>
0564             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0565             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0566             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>);
0567 
0568         <span class="comment">% Frame Box IV</span>
0569         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0570             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0571             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0572             <span class="string">'Position'</span>,[3 3+ButtonHeight+Offset4-14+Offset5 ButtonWidth+6 ButtonHeight+12], <span class="keyword">...</span>
0573             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0574         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0575             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0576             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0577             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0578             <span class="string">'Position'</span>,[6 3+1.75*ButtonHeight+5+Offset4-21+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0579             <span class="string">'String'</span>,<span class="string">'Storage Ring State'</span>, <span class="keyword">...</span>
0580             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0581             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHeader'</span>);
0582         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0583             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''CheckInputs'');'</span>, <span class="keyword">...</span>
0584             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0585             <span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>, <span class="keyword">...</span>
0586             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0587             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0588             <span class="string">'Position'</span>,[6 3+ButtonHeight+6+3+2+Offset4-22+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0589             <span class="string">'String'</span>,<span class="string">'   '</span>, <span class="keyword">...</span>
0590             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0591             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>);
0592 
0593 
0594         <span class="comment">% Frame Box &quot;Close&quot;</span>
0595         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0596             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0597             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0598             <span class="string">'Position'</span>,[3 8 ButtonWidth+6 ButtonHeight+8], <span class="keyword">...</span>
0599             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0600         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0601             <span class="string">'Callback'</span>,<span class="string">'close(gcbf);'</span>, <span class="keyword">...</span>
0602             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0603             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0604             <span class="string">'Position'</span>,[6 13 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0605             <span class="string">'String'</span>,<span class="string">'Close'</span>, <span class="keyword">...</span>
0606             <span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>);
0607 
0608 
0609         <span class="comment">% Update database channels</span>
0610         <a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>;
0611 
0612         <span class="keyword">if</span> nargout &gt; 0
0613             fig = h0;
0614         <span class="keyword">end</span>
0615 
0616 
0617     <span class="keyword">case</span> <span class="string">'Cycle'</span>
0618         GapFlag = Input2;
0619         BumpMagnetFlag = Input3;
0620 
0621         fprintf(<span class="string">'\n'</span>);
0622         disp(<span class="string">'   **************************'</span>);
0623         disp(<span class="string">'   **  Storage Ring Cycle  **'</span>);
0624         disp(<span class="string">'   **************************'</span>);
0625         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
0626 
0627         BSCFlag = questdlg(sprintf(<span class="string">'Cycle Superbend Magnets?'</span>),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0628         <span class="comment">%if strcmp(BSCFlag,'No')</span>
0629         <span class="comment">%    disp(['   ** Superbends will not be cycled. **']);</span>
0630         <span class="comment">%else</span>
0631         <span class="comment">%    disp(['   ** Superbends will be cycled during the second mini-cycle only. **']);</span>
0632         <span class="comment">%end</span>
0633 
0634         ChicSQFlag = questdlg(sprintf(<span class="string">'Cycle chicanes and skew quads and home motor chicanes?'</span>),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0635         <span class="comment">%if strcmp(ChicSQFlag,'No')</span>
0636         <span class="comment">%    disp(['   ** Chicanes and skew quads will not be cycled; motor chicanes will not be homed. **']);</span>
0637         <span class="comment">%else</span>
0638         <span class="comment">%    disp(['   ** Chicanes and skew quads will be cycled; motor chicanes will be homed. **']);</span>
0639         <span class="comment">%end</span>
0640 
0641 
0642         StartFlag = questdlg(sprintf(<span class="string">'Start %.1f GeV Cycle?'</span>,SR_GEV),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0643         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
0644             disp([<span class="string">'   ***************************'</span>]);
0645             disp([<span class="string">'   **    Cycle  Canceled    **'</span>]);
0646             disp([<span class="string">'   ***************************'</span>]);
0647             fprintf(<span class="string">'\n'</span>);
0648             <span class="keyword">return</span>
0649         <span class="keyword">end</span>
0650 
0651         <span class="keyword">try</span>
0652             <span class="keyword">if</span> GapFlag
0653                 <span class="comment">% Make sure that the gaps are open with FF off</span>
0654                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0655                     <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0656                     disp(<span class="string">'   Insertion device gaps are not open.'</span>);
0657                     disp(<span class="string">'   Opening all gaps at maximum speed.'</span>);
0658                     <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0659                     disp(<span class="string">'   Gap control disabled.'</span>);
0660                     disp(<span class="string">'   Feed forward enabled.'</span>);
0661                     pause(1);
0662                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag)">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0663                     disp(<span class="string">'   Gaps opened.'</span>);
0664                     disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0665                     a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0666                 <span class="keyword">else</span>
0667                     disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0668                 <span class="keyword">end</span>
0669             <span class="keyword">else</span>
0670                 disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0671             <span class="keyword">end</span>
0672 
0673             <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0674             pause(1);
0675             
0676             <a href="srcycle.html" class="code" title="function FailFlag = srcycle(varargin)">srcycle</a>(BSCFlag, ChicSQFlag);
0677 
0678             setpv(<span class="string">'SR_STATE'</span>,1);
0679 
0680         <span class="keyword">catch</span>
0681 
0682             fprintf(<span class="string">'   %s \n'</span>,lasterr);
0683             fprintf(<span class="string">'   Cycle failed due to error condition! \n\n'</span>);
0684             setpv(<span class="string">'SR_STATE'</span>,-1);
0685             
0686         <span class="keyword">end</span>
0687 
0688         date;
0689         a = clock;
0690         datestr1=date;
0691         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0692         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0693         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0694         <span class="keyword">if</span> StateNumber &gt;= 0
0695             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0696             disp(<span class="string">'   **********************************************'</span>);
0697             disp(<span class="string">'   **  SR Cycle complete, ready for injection  **'</span>);
0698             disp(<span class="string">'   **********************************************'</span>); fprintf(<span class="string">'\n'</span>);
0699         <span class="keyword">else</span>
0700             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0701             disp(<span class="string">'   **********************************'</span>);
0702             disp(<span class="string">'   **  Problem cycling SR lattice  **'</span>);
0703             disp(<span class="string">'   **********************************'</span>); fprintf(<span class="string">'\n'</span>);
0704         <span class="keyword">end</span>
0705         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0706         
0707 
0708     <span class="keyword">case</span> <span class="string">'Injection'</span>
0709         AD = getad;
0710         GapFlag = Input2;
0711         BumpMagnetFlag = Input3;
0712 
0713         fprintf(<span class="string">'\n'</span>);
0714         <span class="keyword">if</span> abs(AD.Energy - AD.InjectionEnergy) &gt; .05
0715             fprintf(<span class="string">'   ***************************************************\n'</span>);
0716             fprintf(<span class="string">'   **  Setup For %.2f GeV Injection (with ramping)  **\n'</span>, getfamilydata(<span class="string">'InjectionEnergy'</span>));
0717             fprintf(<span class="string">'   ***************************************************\n'</span>);
0718             <a href="set_alarmhandler_AHU_thresholds_inject.html" class="code" title="function set_alarmhandler_AHU_thresholds_inject">set_alarmhandler_AHU_thresholds_inject</a>;
0719             StartFlag = questdlg(sprintf(<span class="string">'Start setup for injection, %.2f GeV?'</span>,getfamilydata(<span class="string">'InjectionEnergy'</span>)),<span class="string">'Injection Setup'</span>,<span class="string">'Ramp quickly'</span>,<span class="string">'Ramp slowly'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0720         <span class="keyword">else</span>
0721             fprintf(<span class="string">'   *************************************************\n'</span>);
0722             fprintf(<span class="string">'   **  Setup For On Energy Injection at %.2f GeV  **\n'</span>, SR_GEV);
0723             fprintf(<span class="string">'   *************************************************\n'</span>);
0724             StartFlag = questdlg(sprintf(<span class="string">'Start setup for injection, %.2f GeV?'</span>,SR_GEV),<span class="string">'Injection Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0725         <span class="keyword">end</span>
0726         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0727         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'Cancel'</span>)
0728             disp([<span class="string">'   ********************************'</span>]);
0729             disp([<span class="string">'   **  Injection Setup Canceled  **'</span>]);
0730             disp([<span class="string">'   ********************************'</span>]);
0731             <span class="comment">%set_alarmhandler_thresholds_new;</span>
0732             fprintf(<span class="string">'\n'</span>);
0733             <span class="keyword">return</span>
0734         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp quickly'</span>)
0735             setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0736         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp slowly'</span>)
0737             setfamilydata(0.4, <span class="string">'BSCRampRate'</span>);
0738         <span class="keyword">end</span>
0739 
0740         <span class="keyword">try</span>
0741 
0742             <span class="keyword">if</span> GapFlag
0743                 <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([],1,0);
0744                 disp(<span class="string">'   Gap control disabled'</span>);
0745                 disp(<span class="string">'   Feed forward enabled'</span>);
0746                 pause(1);
0747 
0748                 <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0749                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0750                     disp(<span class="string">'   Opening all gaps'</span>);
0751                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag)">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0752                 <span class="keyword">end</span>
0753 
0754                 disp(<span class="string">'   Gaps are open'</span>);
0755                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0756                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0757             <span class="keyword">else</span>
0758                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0759             <span class="keyword">end</span>
0760 
0761             <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0762             pause(1);
0763 
0764             <span class="keyword">if</span> (AD.Energy-AD.InjectionEnergy) &gt; 0.05
0765                 <span class="comment">% Ramp down to Injection Energy</span>
0766                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,<span class="string">'Ramping Down'</span>,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0767                 drawnow;
0768                 ErrorFlag = <a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>(<span class="string">'Injection'</span>);
0769                 <span class="keyword">if</span> ErrorFlag
0770                     error(<span class="string">'Superbends over temperature.'</span>);
0771                 <span class="keyword">end</span>
0772                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n\n'</span>,date, a(4), a(5), a(6));
0773 
0774             <span class="keyword">elseif</span> (AD.Energy-AD.InjectionEnergy) &lt; -0.05
0775 
0776                 <span class="comment">% first load injection lattice, then ramp to 1.9 GeV and back to 1.5 GeV to get onto same hysteresis branch</span>
0777 
0778                 srload(<span class="string">'Injection'</span>);
0779 
0780                 <span class="comment">% load 1.9 GeV lattice</span>
0781                 tempfilename = sprintf(<span class="string">'%s19nuy9prod.mat'</span>, getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>));
0782 
0783                 srload(tempfilename);
0784 
0785                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0786 
0787                 pause(5);
0788 
0789             <span class="keyword">end</span>
0790 
0791             srload(<span class="string">'Injection'</span>);
0792 
0793             setpv(<span class="string">'SR_STATE'</span>,2);
0794 
0795         <span class="keyword">catch</span>
0796 
0797             fprintf(<span class="string">'   %s \n'</span>,lasterr);
0798             fprintf(<span class="string">'   Injection lattice setup failed due to error condition! \n\n'</span>);
0799             setpv(<span class="string">'SR_STATE'</span>,-2);
0800 
0801         <span class="keyword">end</span>
0802 
0803 
0804         date;
0805         a = clock;
0806         datestr1=date;
0807         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0808         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0809         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0810         <span class="keyword">if</span> StateNumber &gt;= 0
0811             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0812             <span class="keyword">if</span> AD.Energy &lt;= 1.5
0813                 disp([<span class="string">'   *******************************************************************************'</span>]);
0814                 disp([<span class="string">'   **  Function complete:  the storage ring is setup for injection at '</span>,sprintf(<span class="string">'%.2f'</span>,SR_GEV),<span class="string">' GeV  **'</span>]);
0815                 disp([<span class="string">'   *******************************************************************************'</span>]); 
0816                 fprintf(<span class="string">'\n'</span>);
0817             <span class="keyword">else</span>
0818                 fprintf(<span class="string">'   **********************************************************************************************\n'</span>);
0819                 fprintf(<span class="string">'   **  Function complete:  the storage ring is setup for injection at %.2f GeV (upper branch)  **\n'</span>, getfamilydata(<span class="string">'InjectionEnergy'</span>));
0820                 fprintf(<span class="string">'   **********************************************************************************************\n'</span>); 
0821                 fprintf(<span class="string">'\n'</span>);
0822             <span class="keyword">end</span>
0823         <span class="keyword">else</span>
0824             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0825             disp([<span class="string">'   ************************************'</span>]);
0826             disp([<span class="string">'   **  Problem with injection setup  **'</span>]);
0827             disp([<span class="string">'   ************************************'</span>]); 
0828             fprintf(<span class="string">'\n'</span>);
0829         <span class="keyword">end</span>
0830         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0831 
0832         <span class="comment">%soundchord;</span>
0833 
0834         setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0835 
0836 
0837     <span class="keyword">case</span> <span class="string">'Production'</span>
0838         GapFlag = Input2;
0839         BumpMagnetFlag = Input3;
0840         AD=getad;
0841         
0842         fprintf(<span class="string">'\n'</span>);
0843         <span class="keyword">if</span> abs(AD.Energy - AD.InjectionEnergy) &gt; .05
0844             disp(<span class="string">'   ********************************************************'</span>);
0845             disp(sprintf(<span class="string">'   **  Setup For %.2f GeV User Operation (with ramping)  **'</span>,SR_GEV));
0846             disp(<span class="string">'   ********************************************************'</span>);
0847             StartFlag = questdlg(sprintf(<span class="string">'Start setup for users, %.1f GeV?'</span>,SR_GEV),<span class="string">'User Setup'</span>,<span class="string">'Ramp quickly'</span>,<span class="string">'Ramp slowly'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0848         <span class="keyword">else</span>
0849             disp(<span class="string">'   *****************************************'</span>);
0850             disp(sprintf(<span class="string">'   **  Setup For %.2f GeV User Operation  **'</span>,SR_GEV));
0851             disp(<span class="string">'   *****************************************'</span>);
0852             StartFlag = questdlg(sprintf(<span class="string">'Start setup for users, %.1f GeV?'</span>,SR_GEV),<span class="string">'User Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0853         <span class="keyword">end</span>
0854         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0855 
0856         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'Cancel'</span>)
0857             disp([<span class="string">'   ***************************'</span>]);
0858             disp([<span class="string">'   **  User Setup Canceled  **'</span>]);
0859             disp([<span class="string">'   ***************************'</span>]);
0860             fprintf(<span class="string">'\n'</span>);
0861             <span class="keyword">return</span>
0862         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp quickly'</span>)
0863             setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0864         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp slowly'</span>)
0865             setfamilydata(0.4, <span class="string">'BSCRampRate'</span>);
0866         <span class="keyword">end</span>
0867 
0868         <span class="keyword">try</span>
0869 
0870             <span class="keyword">if</span> GapFlag
0871                 <span class="comment">% Make sure that the gaps are open</span>
0872                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0873                     <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0874                     disp(<span class="string">'   Insertion device gaps are not open'</span>);
0875                     disp(<span class="string">'   Opening all gaps at maximum speed'</span>);
0876                     <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0877                     disp(<span class="string">'   Gap control disabled'</span>);
0878                     disp(<span class="string">'   Feed forward enabled'</span>);
0879                     pause(1);
0880                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag)">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0881                     disp(<span class="string">'   Gaps opened'</span>);
0882                     disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0883                     a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0884                 <span class="keyword">else</span>
0885                     disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0886                 <span class="keyword">end</span>
0887             <span class="keyword">else</span>
0888                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0889             <span class="keyword">end</span>
0890 
0891             <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0892             pause(1);
0893 
0894             <span class="comment">%%%%%%%%%%%%%%%</span>
0895             <span class="keyword">if</span> (AD.Energy-AD.InjectionEnergy) &gt; 0.05
0896                 <span class="comment">% Ramp up to the production lattice</span>
0897                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,<span class="string">'Ramping Up'</span>,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0898                 drawnow;
0899                 ErrorFlag = <a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>(<span class="string">'Production'</span>);
0900                 <span class="keyword">if</span> ErrorFlag
0901                     error(<span class="string">'Superbends over temperature.'</span>);
0902                 <span class="keyword">end</span>
0903                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0904 
0905                 srload(<span class="string">'Production'</span>);
0906 
0907 
0908             <span class="keyword">elseif</span> abs(AD.Energy-AD.InjectionEnergy) &lt; 0.05
0909 
0910                 <span class="comment">% load production lattice - no ramp required</span>
0911                 srload(<span class="string">'Production'</span>);
0912                 <span class="comment">%a = clock; fprintf('   %s %d:%d:%.0f\n',date, a(4), a(5), a(6));</span>
0913                 pause(1);
0914 
0915             <span class="keyword">end</span>
0916             <span class="comment">%%%%%%%%%%%%%%%</span>
0917             
0918             <span class="keyword">if</span> GapFlag
0919                 <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0920                 disp(<span class="string">'   Gap control disabled'</span>);
0921                 disp(<span class="string">'   Feed forward enable'</span>);
0922                 pause(1);
0923 
0924                 disp(<span class="string">'   Insertion device velocity profile boolean control off'</span>);
0925                 disp(<span class="string">'   Closing all gaps at maximum speed'</span>);
0926 
0927                 <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0928                 [Position, Velocity, RunFlag, UserGap] = <a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>;
0929 
0930                 <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag)">setid</a>([], UserGap, maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0931 
0932                 <span class="comment">% Turn velocity profile on</span>
0933                 disp(<span class="string">'   Insertion device velocity profile boolean control is on'</span>);
0934                 <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag)">setid</a>([], [], maxsp(<span class="string">'IDvel'</span>), 1, 1, 0);
0935 
0936                 disp(<span class="string">'   Gaps are closed'</span>);
0937                 <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([4;7;8;9;10;12], 1, 1);
0938                 <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>(5, 1, 0);
0939                 disp(<span class="string">'   Gap control enabled (except sector 5 (W16))'</span>);
0940             <span class="keyword">end</span>
0941 
0942             <span class="comment">%set_alarmhandler_thresholds_new;</span>
0943             setpv(<span class="string">'SR_STATE'</span>,3);
0944 
0945         <span class="keyword">catch</span>
0946 
0947             fprintf(<span class="string">'   %s \n'</span>, lasterr);
0948             fprintf(<span class="string">'   User lattice setup failed due to error condition! \n\n'</span>);
0949             setpv(<span class="string">'SR_STATE'</span>,-3);
0950 
0951         <span class="keyword">end</span>
0952 
0953         <span class="comment">%give JH scrapers a chance to move</span>
0954         <span class="comment">% pause(15);</span>
0955         
0956         a = clock;
0957         datestr1 = date;
0958         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0959         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0960         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0961         <span class="keyword">if</span> StateNumber &gt;= 0
0962             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0963             disp([<span class="string">'   **************************************************************************'</span>]);
0964             disp([<span class="string">'   **  Function complete:  the storage ring is setup for users at '</span>,sprintf(<span class="string">'%.1f'</span>,SR_GEV),<span class="string">' GeV  **'</span>]);
0965             disp([<span class="string">'   **************************************************************************'</span>]); 
0966             fprintf(<span class="string">'\n'</span>);
0967         <span class="keyword">else</span>
0968             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0969             disp([<span class="string">'   *************************************'</span>]);
0970             disp([<span class="string">'   **  Problem with production setup  **'</span>]);
0971             disp([<span class="string">'   *************************************'</span>]); 
0972             fprintf(<span class="string">'\n'</span>);
0973         <span class="keyword">end</span>
0974         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0975 
0976         setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0977 
0978 
0979 <span class="comment">%         % for BL6.0.x, set lower setpoint limit for IVID to 12.5mm until beamlines are surveyed below that value</span>
0980 <span class="comment">%         try</span>
0981 <span class="comment">%             scaput('SR06U___GDS1PS_AC00.DRVL',12.5);</span>
0982 <span class="comment">%             disp('  Setting SR06U___GDS1PS_AC00.DRVL to 12.5mm (lower limit for IVID');</span>
0983 <span class="comment">%         catch</span>
0984 <span class="comment">%             fprintf('   %s \n',lasterr);</span>
0985 <span class="comment">%             disp('  Trouble setting lower limit for IVID to 12.5mm!');</span>
0986 <span class="comment">%         end</span>
0987 
0988         
0989     <span class="keyword">case</span> <span class="string">'CheckInputs'</span>
0990 
0991         SR_GEV = getfamilydata(<span class="string">'Energy'</span>);
0992         AD=getad;
0993         <a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>; 
0994 
0995         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0996 
0997         <span class="keyword">if</span> AD.Energy &gt; 1.55 &amp; AD.InjectionEnergy &lt; 1.55
0998             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection (Ramp Down)'</span>]);
0999             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users (Ramp Up)'</span>]);
1000         <span class="keyword">elseif</span> AD.Energy &lt; 1.45
1001             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection (Ramp Up+cycle)'</span>]);
1002             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users, '</span>,num2str(round(10*SR_GEV)/10),<span class="string">' GeV (Ramp Down)'</span>]);
1003         <span class="keyword">else</span>
1004             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection'</span>]);
1005             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users, '</span>,num2str(round(10*SR_GEV)/10),<span class="string">' GeV'</span>]);
1006         <span class="keyword">end</span>
1007         set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLTitle'</span>),<span class="string">'String'</span>,SR_Mode);
1008 
1009         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1010         <span class="keyword">if</span> StateNumber &gt;= 0
1011             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1012         <span class="keyword">else</span>
1013             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1014         <span class="keyword">end</span>
1015 
1016         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1017 
1018 
1019     <span class="keyword">case</span> <span class="string">'SRState'</span>
1020         NumErrors = 0;
1021         fprintf(<span class="string">'\n'</span>);
1022         disp(<span class="string">'   ***********************************'</span>);
1023         disp(<span class="string">'   **  Checking Storage Ring State  **'</span>);
1024         disp(<span class="string">'   ***********************************'</span>);
1025         a = clock;
1026         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1027 
1028         <span class="comment">%       FileName = getpv('SR_LATTICE_FILE','String');   % Last srload file name (in OLD MIDDLE LAYER nomenclature!!)</span>
1029 
1030         GeVnow = <a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>;
1031         <span class="keyword">if</span> GeVnow == getfamilydata(<span class="string">'Energy'</span>)
1032             [ConfigSetpoint, ConfigMonitor, FileName] = getproductionlattice;
1033         <span class="keyword">elseif</span> GeVnow == getfamilydata(<span class="string">'InjectionEnergy'</span>)
1034             [ConfigSetpoint, ConfigMonitor, FileName] = getinjectionlattice;
1035         <span class="keyword">else</span>
1036             FileName = <span class="string">''</span>;
1037         <span class="keyword">end</span>
1038 
1039         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1040         fprintf(<span class="string">'   Storage ring operational mode: %s\n'</span>, SR_Mode);
1041         <span class="keyword">if</span> StateNumber &lt; 0
1042             fprintf(<span class="string">'   Storage ring state error: %s\n'</span>, StateString);
1043             NumErrors = NumErrors + 1;
1044         <span class="keyword">else</span>
1045             fprintf(<span class="string">'   Storage ring state: %s\n'</span>, StateString);
1046         <span class="keyword">end</span>
1047         <span class="keyword">if</span> StateNumber==0
1048             <span class="comment">% Storage ring state unknown</span>
1049             NumErrors = NumErrors + 1;
1050         <span class="keyword">elseif</span> abs(StateNumber)==1 || abs(StateNumber)==2
1051             FileNameGoal = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>) getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'InjectionFile'</span>) <span class="string">'.mat'</span>];
1052             <span class="keyword">if</span> ~strcmp(FileName, FileNameGoal)
1053                 fprintf(<span class="string">'   Lattice file %s should be loaded but it appears that %s is loaded.\n'</span>, getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'InjectionFile'</span>), FileName);
1054                 NumErrors = NumErrors + 1;
1055             <span class="keyword">end</span>
1056         <span class="keyword">else</span>
1057             FileNameGoal = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>) getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'LatticeFile'</span>) <span class="string">'.mat'</span>];
1058             <span class="keyword">if</span> ~strcmp(FileName, FileNameGoal)
1059                 fprintf(<span class="string">'   Lattice file %s should be loaded but it appears that %s is loaded.\n'</span>, getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'LatticeFile'</span>), FileName);
1060                 NumErrors = NumErrors + 1;
1061             <span class="keyword">end</span>
1062         <span class="keyword">end</span>
1063 
1064 
1065         <span class="comment">% Check all SR magnets</span>
1066         <span class="keyword">if</span> isempty(FileName)
1067             fprintf(<span class="string">'   Goal setpoints will not be checked since the last lattice load is unknown.\n'</span>);
1068             NumErrors1 = <a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>(<span class="string">''</span>);
1069         <span class="keyword">else</span>
1070 <span class="comment">%            NumErrors1 = checksrmags([getfamilydata('Directory','OpsData') FileName]);</span>
1071             NumErrors1 = <a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>(FileName);
1072         <span class="keyword">end</span>
1073         <span class="keyword">if</span> NumErrors1 == 0
1074             fprintf(<span class="string">'   SR magnets power supplies are OK.\n'</span>);
1075         <span class="keyword">end</span>
1076         NumErrors = NumErrors + NumErrors1;
1077 
1078 
1079         <span class="comment">% Check RF frequency</span>
1080         <span class="keyword">if</span> isempty(FileName)
1081             fprintf(<span class="string">'   RF frequency will not be checked since the last lattice load is unknown.\n'</span>);
1082         <span class="keyword">else</span>
1083 <span class="comment">%            load([getfamilydata('Directory','OpsData'), FileName]);</span>
1084             load(FileName);
1085             [tmp, RFHPCounterPresent] = getrf;
1086             <span class="keyword">if</span> abs(RFHPCounterPresent-ConfigSetpoint.RF.Setpoint.Data) &gt; .002
1087                 NumErrors = NumErrors + 1;
1088                 fprintf(<span class="string">'   RF frequency should be %f, presently it is %f MHz (as measured by the HP counter).\n'</span>, ConfigSetpoint.RF.Setpoint.Data, RFHPCounterPresent);
1089             <span class="keyword">else</span>
1090                 fprintf(<span class="string">'   RF frequency is OK (HP counter is %f MHz, at the time of the lattice save it was %f MHz).\n'</span>, RFHPCounterPresent, ConfigSetpoint.RF.Setpoint.Data);
1091             <span class="keyword">end</span>
1092         <span class="keyword">end</span>
1093 
1094 
1095         <span class="comment">% Check for orbit problems</span>
1096         <span class="keyword">if</span> (StateNumber &gt;= 3) &amp;&amp; (getdcct &gt; 2)   <span class="comment">% Production lattice is loaded with beam in the machine</span>
1097             Xtol = 0.070;
1098             Ytol = 0.010;
1099             NumErrors1 = <a href="checksrorbit.html" class="code" title="function ErrorNums = checksrorbit(SectorList, BPMxtol,BPMytol)">checksrorbit</a>([],Xtol,Ytol);
1100             <span class="keyword">if</span> NumErrors1
1101                 fprintf(<span class="string">'   SR orbit in the ID straight sections or at Bergoz BPMs deviates more than allowed from the golden orbit.\n'</span>);
1102             <span class="keyword">else</span>
1103                 fprintf(<span class="string">'   SR orbit in the ID straight sections and at Bergoz BPMs is OK.\n'</span>);
1104                 fprintf(<span class="string">'   The orbit is within %.3f mm horizontally and %.3f mm vertically'</span>, Xtol, Ytol);
1105             <span class="keyword">end</span>
1106             NumErrors = NumErrors + NumErrors1;
1107         <span class="keyword">else</span>
1108             fprintf(<span class="string">'   Storage ring orbit was not checked.\n'</span>);
1109         <span class="keyword">end</span>
1110 
1111 
1112         a = clock;
1113         datestr1=date;
1114         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
1115         <span class="keyword">if</span> NumErrors
1116             disp(<span class="string">'   *********************************'</span>);
1117             disp(<span class="string">'   **  Storage Ring Has Problems  **'</span>);
1118             disp(<span class="string">'   *********************************'</span>);
1119         <span class="keyword">else</span>
1120             disp(<span class="string">'   **********************************'</span>);
1121             disp(<span class="string">'   **  Storage Ring Lattice is OK  **'</span>);
1122             disp(<span class="string">'   **********************************'</span>);
1123         <span class="keyword">end</span>
1124         fprintf(<span class="string">'   \n'</span>);
1125 
1126         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1127         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1128         <span class="keyword">if</span> StateNumber &gt;= 0
1129             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1130         <span class="keyword">else</span>
1131             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1132         <span class="keyword">end</span>
1133         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1134 
1135 
1136     <span class="keyword">case</span> <span class="string">'OrbitCorrection'</span>
1137         fprintf(<span class="string">'\n'</span>);
1138         fprintf(<span class="string">'   *********************************\n'</span>);
1139         fprintf(<span class="string">'   **  Starting Orbit Correction  **\n'</span>);
1140         fprintf(<span class="string">'   *********************************\n'</span>);
1141         a = clock;
1142         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1143 
1144         StartFlag = questdlg(sprintf(<span class="string">'Start orbit correction, %.1f GeV?'</span>,SR_GEV),<span class="string">'Orbit Correction'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
1145         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
1146             disp([<span class="string">'   ********************************'</span>]);
1147             disp([<span class="string">'   **  Orbit Correction Aborted  **'</span>]);
1148             disp([<span class="string">'   ********************************'</span>]);
1149             fprintf(<span class="string">'\n'</span>);
1150             <span class="keyword">return</span>
1151         <span class="keyword">end</span>
1152 
1153         <span class="keyword">if</span> getdcct &lt; 2     <span class="comment">% Don't correct the orbit if the current is too small</span>
1154             fprintf(<span class="string">'   Orbit not corrected due to small current.\n'</span>);
1155             <span class="keyword">return</span>
1156         <span class="keyword">end</span>
1157 
1158 <span class="comment">%         if abs(SR_GEV-bend2gev(getpv('BEND','Setpoint',[1 1])))&gt;  0.05     % Don't use this routine for the injection lattice</span>
1159 <span class="comment">%             fprintf('   This routine should only be used for the production energy: Correction aborted\n');</span>
1160 <span class="comment">%             return</span>
1161 <span class="comment">%         end</span>
1162 
1163         SR_STATE_OLD = scaget(<span class="string">'SR_STATE'</span>);
1164         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1165         setpv(<span class="string">'SR_STATE'</span>,4);
1166         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1167         <span class="keyword">if</span> StateNumber &gt;= 0
1168             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1169         <span class="keyword">else</span>
1170             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1171         <span class="keyword">end</span>
1172         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1173 
1174 
1175         <span class="keyword">try</span>
1176             <span class="comment">% save current BPM timeconstant - will reset to this after correction</span>
1177             BPMtimeconstantOC = <a href="getbpmtimeconstant.html" class="code" title="function [BPMTimeConstant, WarningFlag] = getbpmtimeconstant(varargin)">getbpmtimeconstant</a>;
1178             fprintf(<span class="string">'   Current Bergoz BPM time constant is %.1fs\n'</span>, BPMtimeconstantOC);
1179 
1180             <span class="comment">% 2 Hz update rate on IDBPMs</span>
1181             disp(<span class="string">'   Bergoz BPM time constant set to 0.5s.'</span>)
1182             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.5)
1183             pause(2);
1184 
1185 
1186             <span class="comment">% Turn off feed forward</span>
1187             fprintf(<span class="string">'   Turning feed forward off.\n'</span>);
1188             [FFEnableBM, FFEnableBC] = <a href="getff.html" class="code" title="function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)">getff</a>;
1189             <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], 0);
1190             scasleep(.2);
1191 
1192 
1193             <span class="comment">% Get vectors</span>
1194             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>);
1195             LocalBumplist = FB.LocalBumplist;
1196 
1197         <span class="keyword">catch</span>
1198 
1199             fprintf(<span class="string">'   %s \n'</span>,lasterr);
1200             fprintf(<span class="string">'   Orbit correction setup failed due to error condition! \n\n'</span>);
1201             setpv(<span class="string">'SR_STATE'</span>,-4);
1202             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1203             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1204             <span class="keyword">if</span> StateNumber &gt;= 0
1205                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1206             <span class="keyword">else</span>
1207                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1208             <span class="keyword">end</span>
1209             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1210 
1211             <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1212             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1213             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1214             <span class="keyword">return</span>
1215         <span class="keyword">end</span>
1216 
1217         iNotHCMChicane = find(FB.HCMlist1(:,2) &lt; 10); <span class="comment">%used by steppv's for setting correctors in loop</span>
1218         iHCMChicane = find(FB.HCMlist1(:,2) == 10);
1219         iNotVCMChicane = find(FB.VCMlist1(:,2) &lt; 10);
1220         iVCMChicane = find(FB.VCMlist1(:,2) == 10);
1221 
1222         fprintf(<span class="string">'   Starting horizontal and vertical global orbit correction (SVD method).\n'</span>);
1223 
1224         <span class="keyword">for</span> iloop = 1:3
1225             <span class="keyword">try</span>
1226                 <span class="comment">% use the following to get corrector settings in OCS without setting them, so the values can be checked</span>
1227                 FB.OCSx = setorbit(FB.OCSx,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1228                 FB.OCSy = setorbit(FB.OCSy,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1229                 <span class="keyword">if</span> any(abs(FB.OCSx.CM.Delta(iNotHCMChicane)) &gt; 5)
1230                   disp(<span class="string">'   Orbit Correction is changing some horizontal corrector(s) &gt; 5A!!'</span>);
1231                 <span class="keyword">end</span>
1232                 <span class="keyword">if</span> any(abs(FB.OCSy.CM.Delta(iNotVCMChicane)) &gt; 5)
1233                   disp(<span class="string">'   Orbit Correction is changing some vertical corrector(s) &gt; 5A!!'</span>);
1234                 <span class="keyword">end</span>
1235                 <span class="keyword">if</span> any(abs(FB.OCSx.CM.Delta(iHCMChicane)) &gt; 10)
1236                   disp(<span class="string">'   Orbit Correction is changing some horizontal chicane corrector(s) &gt; 10A!!'</span>);
1237                 <span class="keyword">end</span>
1238                 <span class="keyword">if</span> any(abs(FB.OCSy.CM.Delta(iVCMChicane)) &gt; 10)
1239                     disp(<span class="string">'   Orbit Correction is changing some vertical chicane corrector(s) &gt; 10A!!'</span>);
1240                 <span class="keyword">end</span>
1241 
1242                 <span class="comment">% Correct RF</span>
1243                 rf0=getrf;
1244                 nRFsteps = 4*ceil(abs(FB.OCSx.DeltaRF/10e-6)); <span class="comment">%added factor 4 to slow down change for laser-lock at BL11.0.1 - 3-14-08, T.Scarvie</span>
1245                 <span class="keyword">if</span> nRFsteps &gt; 100
1246                     nRFsteps = 100;
1247                 <span class="keyword">end</span>
1248                 <span class="keyword">for</span> loop = 1:nRFsteps
1249                     steprf(FB.OCSx.DeltaRF/nRFsteps,0);
1250                 <span class="keyword">end</span>
1251                 fprintf(<span class="string">'   %d. nRFsteps = %d, RF change = %.1f Hz\n'</span>,iloop, nRFsteps, FB.OCSx.DeltaRF*1e6);
1252 <span class="comment">%               fprintf('   %d. RF change = %.1f Hz, nRFsteps = %d, DelRF = %.1f Hz\n',iloop, (getrf-rf0)*1e6, nRFsteps, FB.OCSx.DeltaRF*1e6);</span>
1253 
1254                 <span class="comment">% Correct horizontal and vertical orbits</span>
1255                 <span class="comment">% calculate corrections</span>
1256                 FB.OCSx.CM.Data = FB.OCSx.CM.Data + FB.OCSx.CM.Delta;
1257                 FB.OCSy.CM.Data = FB.OCSy.CM.Data + FB.OCSy.CM.Delta;
1258                 <span class="comment">% start vertical correctors moving</span>
1259                 setpv(FB.OCSy.CM,0);
1260                 <span class="comment">% Correct horizontal</span>
1261                 setpv(FB.OCSx.CM,-1);
1262                 <span class="comment">% Correct vertical</span>
1263                 setpv(FB.OCSy.CM,-2);
1264 
1265                 <span class="comment">% Check for current in machine - stop orbit correction if DCCT &lt; 5mA</span>
1266                 <span class="keyword">if</span> (getdcct &lt; 2)
1267                     error(<span class="string">'**There is less than 5mA in the machine! Stopping orbit correction.'</span>);
1268                 <span class="keyword">end</span>
1269 
1270                 <span class="comment">% Check state of gaps - stop orbit correction if any are moving</span>
1271                 GAPrunflag = getpv(<span class="string">'ID'</span>,<span class="string">'RunFlag'</span>);
1272                 <span class="keyword">if</span> any(GAPrunflag-round(GAPrunflag))
1273                     error(<span class="string">'**One or more of the gaps are moving! Stopping orbit correction.'</span>);
1274                 <span class="keyword">end</span>
1275 
1276                 x = FB.OCSx.GoalOrbit - getx(FB.OCSx.BPM.DeviceList);
1277                 y = FB.OCSy.GoalOrbit - gety(FB.OCSy.BPM.DeviceList);
1278                 fprintf(<span class="string">'   %d. Horizontal RMS = %.3f mm\n'</span>, iloop, norm(x)/sqrt(length(x)));
1279                 fprintf(<span class="string">'   %d.   Vertical RMS = %.3f mm\n'</span>, iloop, norm(y)/sqrt(length(y)));
1280 
1281             <span class="keyword">catch</span>
1282                 fprintf(<span class="string">'   %s \n'</span>,lasterr);
1283                 fprintf(<span class="string">'   Orbit correction failed due to error condition!\n  Fix the problem, reload the lattice (srload), and try again.  \n\n'</span>);
1284                 setpv(<span class="string">'SR_STATE'</span>,-4);
1285                 set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1286                 [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1287                 <span class="keyword">if</span> StateNumber &gt;= 0
1288                     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1289                 <span class="keyword">else</span>
1290                     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1291                 <span class="keyword">end</span>
1292                 set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1293 
1294                 <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1295                 <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1296                 fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1297                 <span class="keyword">return</span>
1298             <span class="keyword">end</span>
1299         <span class="keyword">end</span>
1300 
1301 
1302         <span class="comment">% Set user bumps w/o sextupole correctors</span>
1303         <span class="keyword">try</span>
1304 
1305             <span class="comment">%turn up corrector speed here to quicken setting bumps</span>
1306             HCMramprate = getpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>);
1307             VCMramprate = getpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>);
1308             setpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>, 10, [], 0);
1309             setpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>, 10, [], 0);
1310             
1311             <span class="keyword">if</span> ~isempty(LocalBumplist)
1312                 fprintf(<span class="string">'   Setting local bumps in the straight sections.\n'</span>);
1313                 <span class="keyword">for</span> loop = 1:size(LocalBumplist,1)
1314 
1315                     <span class="comment">% Check for current in machine - stop orbit correction if DCCT &lt; 5mA</span>
1316                     <span class="keyword">if</span> (getdcct &lt; 2)
1317                         error(<span class="string">'** There is less than 5mA in the machine! Stopping local bumps.'</span>);
1318                     <span class="keyword">end</span>
1319 
1320                     <span class="comment">% Check state of gaps - stop setting bumps if any are moving</span>
1321                     GAPrunflag = getpv(<span class="string">'ID'</span>,<span class="string">'RunFlag'</span>);
1322                     <span class="keyword">if</span> any(GAPrunflag-round(GAPrunflag))
1323                         error(<span class="string">'** One or more of the gaps are moving! Stopping local bumps.'</span>);
1324                     <span class="keyword">end</span>
1325 
1326                     HCMoldsp = getsp(<span class="string">'HCM'</span>, FB.HCMlist1);
1327                     VCMoldsp = getsp(<span class="string">'VCM'</span>, FB.VCMlist1);
1328 
1329                     <span class="keyword">if</span> any(LocalBumplist(loop,1) == [4 6 11])
1330                         <span class="keyword">if</span> LocalBumplist(loop,2) == 0
1331                             <span class="comment">% Upstream bump</span>
1332                             [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1)-1 11;LocalBumplist(loop,1)-1 12;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1333                             <span class="keyword">if</span> isempty(iRemove)
1334                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1335                             <span class="keyword">else</span>
1336                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1337                             <span class="keyword">end</span>
1338                         <span class="keyword">elseif</span> LocalBumplist(loop,2) == 1
1339                             <span class="comment">% Upstream bump</span>
1340                             [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1)-1 11;],FB.OCSx.BPM.DeviceList);
1341                             <span class="keyword">if</span> isempty(iRemove)
1342                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1343                             <span class="keyword">else</span>
1344                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1345                             <span class="keyword">end</span>
1346                         <span class="keyword">else</span>
1347                             <span class="comment">% Downstream bump</span>
1348                             [i, iRemove] = findrowindex([LocalBumplist(loop,1)-1 12;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1349                             <span class="keyword">if</span> isempty(iRemove)
1350                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1351                             <span class="keyword">else</span>
1352                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1353                             <span class="keyword">end</span>
1354                         <span class="keyword">end</span>
1355                     <span class="keyword">else</span>
1356                         [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1357                         <span class="keyword">if</span> isempty(iRemove)
1358                             <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1359                         <span class="keyword">else</span>
1360                             fprintf(<span class="string">'\n   BPMs missing from Sector %02d - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,1));
1361                         <span class="keyword">end</span>
1362                     <span class="keyword">end</span>
1363                     
1364                     HCMnewsp = getsp(<span class="string">'HCM'</span>, FB.HCMlist1);
1365                     VCMnewsp = getsp(<span class="string">'VCM'</span>, FB.VCMlist1);
1366                     <span class="comment">% Remove center chicane trim from corrector check</span>
1367                     <span class="keyword">if</span> (max(abs(HCMoldsp(iNotHCMChicane)-HCMnewsp(iNotHCMChicane))) &gt; 5) || (max(abs(VCMoldsp(iNotVCMChicane)-VCMnewsp(iNotVCMChicane))) &gt; 10)
1368                         error(<span class="string">'**Setbumps caused some corrector magnet currents to change by more than 5(Horiz)/10(Vert) A!'</span>);
1369                     <span class="keyword">end</span>
1370                     <span class="comment">% Now check center chicane trims</span>
1371                     <span class="keyword">if</span> (max(abs(HCMoldsp(iNotHCMChicane)-HCMnewsp(iNotHCMChicane))) &gt; 10) || (max(abs(VCMoldsp(iNotVCMChicane)-VCMnewsp(iNotVCMChicane))) &gt; 15)
1372                         error(<span class="string">'**Setbumps caused some chicane trim magnet currents to change by more than 10(Horiz)/15(Vert) A!'</span>);
1373                     <span class="keyword">end</span>
1374                 <span class="keyword">end</span>
1375             <span class="keyword">end</span>
1376 
1377             <span class="comment">%restore corrector speeds</span>
1378             setpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>, HCMramprate, [], 0);
1379             setpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>, VCMramprate, [], 0);
1380 
1381         <span class="keyword">catch</span>
1382             fprintf(<span class="string">'   %s \n'</span>,lasterr);
1383             fprintf(<span class="string">'   Setbumps failed due to error condition!  Fix the problem, reload the lattice (srload), and try again.\n\n'</span>);
1384             setpv(<span class="string">'SR_STATE'</span>,-4);
1385             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1386             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1387             <span class="keyword">if</span> StateNumber &gt;= 0
1388                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1389             <span class="keyword">else</span>
1390                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1391             <span class="keyword">end</span>
1392             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1393 
1394             <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1395             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1396             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1397             <span class="keyword">return</span>
1398         <span class="keyword">end</span>
1399 
1400         <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1401         <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1402         fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1403 
1404         <span class="comment">% Turn feed forward back to it's original state</span>
1405         <span class="keyword">if</span> any(FFEnableBC)
1406             fprintf(<span class="string">'   Turning feed forward back on.\n'</span>);
1407             <a href="setff.html" class="code" title="function setff(DeviceList, FFEnableBC, GapEnableBC)">setff</a>([], FFEnableBC);
1408         <span class="keyword">end</span>
1409 
1410 
1411         a = clock;
1412         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1413         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1414         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1415         <span class="keyword">if</span> StateNumber &gt;= 0
1416             setpv(<span class="string">'SR_STATE'</span>,4.1);
1417             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1418             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1419             fprintf(<span class="string">'   *********************************\n'</span>);
1420             fprintf(<span class="string">'   **  Orbit Correction Complete  **\n'</span>);
1421             fprintf(<span class="string">'   *********************************\n\n'</span>);
1422         <span class="keyword">else</span>
1423             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1424             fprintf(<span class="string">'   *************************************\n'</span>);
1425             fprintf(<span class="string">'   **  Problem With Orbit Correction  **\n'</span>);
1426             fprintf(<span class="string">'   *************************************\n\n'</span>);
1427         <span class="keyword">end</span>
1428         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1429         pause(0);
1430 
1431 
1432     <span class="keyword">case</span> <span class="string">'OrbitCorrectionSetup'</span>
1433         InitFlag = Input2;           <span class="comment">% Input #2: if InitFlag, then initialize variables</span>
1434 
1435         <span class="keyword">if</span> InitFlag
1436             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1437             <span class="comment">% This setup is now done in ocsinit.m %</span>
1438             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1439             <span class="comment">% Setup feedback elements</span>
1440             <span class="comment">% disp('Orbit correction condition: InitFlag=1 -- debugging message');</span>
1441 
1442             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1443             <span class="comment">% Edit the following lists to change default configuration of Orbit Correction %</span>
1444             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1445 <span class="comment">%             hlist=[];vlist=[];</span>
1446 <span class="comment">%             for Sector =1:12</span>
1447 <span class="comment">%                 if Sector == 1</span>
1448 <span class="comment">%                     vlist = [vlist;Sector 2;Sector 4;Sector 5;Sector 8];</span>
1449 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7];</span>
1450 <span class="comment">%                 elseif Sector == 3</span>
1451 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];</span>
1452 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7;Sector 10];</span>
1453 <span class="comment">%                 elseif Sector == 5</span>
1454 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];</span>
1455 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7;Sector 10];</span>
1456 <span class="comment">% %                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8]; %remove HCM and VCM(5,10) since corrector is not controlling starting 4-6-07</span>
1457 <span class="comment">% %                     hlist = [hlist;Sector 2;Sector 7];</span>
1458 <span class="comment">%                 elseif Sector == 10</span>
1459 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];</span>
1460 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7;Sector 10];</span>
1461 <span class="comment">%                 elseif Sector == 12</span>
1462 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 7];</span>
1463 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7];</span>
1464 <span class="comment">%                 else</span>
1465 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8];</span>
1466 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7];</span>
1467 <span class="comment">%                 end</span>
1468 <span class="comment">%             end</span>
1469 <span class="comment">%             HCMlist1 = hlist;</span>
1470 <span class="comment">%             VCMlist1 = vlist;</span>
1471 <span class="comment">%</span>
1472 <span class="comment">%             BPMlist1 = [</span>
1473 <span class="comment">%                 1 2</span>
1474 <span class="comment">%                 1 5</span>
1475 <span class="comment">%                 1 6</span>
1476 <span class="comment">%                 1 10</span>
1477 <span class="comment">%                 2 1</span>
1478 <span class="comment">%                 2 5</span>
1479 <span class="comment">%                 2 6</span>
1480 <span class="comment">%                 2 9</span>
1481 <span class="comment">%                 3 2</span>
1482 <span class="comment">%                 3 5</span>
1483 <span class="comment">%                 3 6</span>
1484 <span class="comment">%                 3 10</span>
1485 <span class="comment">%                 3 11</span>
1486 <span class="comment">%                 3 12</span>
1487 <span class="comment">%                 4 1</span>
1488 <span class="comment">%                 4 5</span>
1489 <span class="comment">%                 4 6</span>
1490 <span class="comment">%                 4 10</span>
1491 <span class="comment">%                 5 1</span>
1492 <span class="comment">%                 5 5</span>
1493 <span class="comment">%                 5 6</span>
1494 <span class="comment">%                 5 10</span>
1495 <span class="comment">%                 5 11</span>
1496 <span class="comment">%                 5 12</span>
1497 <span class="comment">%                 6 1</span>
1498 <span class="comment">%                 6 5</span>
1499 <span class="comment">%                 6 6</span>
1500 <span class="comment">%                 6 10</span>
1501 <span class="comment">%                 7 1</span>
1502 <span class="comment">%                 7 5</span>
1503 <span class="comment">%                 7 6</span>
1504 <span class="comment">%                 7 10</span>
1505 <span class="comment">%                 8 1</span>
1506 <span class="comment">%                 8 5</span>
1507 <span class="comment">%                 8 6</span>
1508 <span class="comment">%                 8 10</span>
1509 <span class="comment">%                 9 1</span>
1510 <span class="comment">%                 9 5</span>
1511 <span class="comment">%                 9 6</span>
1512 <span class="comment">%                 9 10</span>
1513 <span class="comment">%                 10 1</span>
1514 <span class="comment">%                 10 5</span>
1515 <span class="comment">%                 10 6</span>
1516 <span class="comment">%                 10 10</span>
1517 <span class="comment">%                 10 11</span>
1518 <span class="comment">%                 10 12</span>
1519 <span class="comment">%                 11 1</span>
1520 <span class="comment">%                 11 5</span>
1521 <span class="comment">%                 11 6</span>
1522 <span class="comment">%                 11 10</span>
1523 <span class="comment">%                 12 1</span>
1524 <span class="comment">%                 12 5</span>
1525 <span class="comment">%                 12 6</span>
1526 <span class="comment">%                 12 9];</span>
1527 <span class="comment">%</span>
1528 <span class="comment">%             % SVD orbit correction</span>
1529 <span class="comment">%             Xivec = [1:28];</span>
1530 <span class="comment">%             Yivec = [1:51];</span>
1531 <span class="comment">%</span>
1532 <span class="comment">%</span>
1533 <span class="comment">%             % Look for bad status BPMs</span>
1534 <span class="comment">%             iStatus = family2status('BPMx', BPMlist1);</span>
1535 <span class="comment">%             iBad = find(~iStatus);</span>
1536 <span class="comment">%             BPMlist1 = BPMlist1(find(iStatus),:);</span>
1537 <span class="comment">%             if length(iBad)</span>
1538 <span class="comment">%                 fprintf('   Global Orbit Correction: %d BPMs removed for bad status\n', length(iBad));</span>
1539 <span class="comment">%                 Yivec = Yivec(1:end-length(iBad));</span>
1540 <span class="comment">%             end</span>
1541 <span class="comment">%</span>
1542 <span class="comment">%             iStatus = family2status('HCM', HCMlist1);</span>
1543 <span class="comment">%             iBad = find(~iStatus);</span>
1544 <span class="comment">%             HCMlist1 = HCMlist1(find(iStatus),:);</span>
1545 <span class="comment">%             if length(iBad)</span>
1546 <span class="comment">%                 fprintf('   Global Orbit Correction: %d HCMs removed for bad status\n', length(iBad));</span>
1547 <span class="comment">%             end</span>
1548 <span class="comment">%</span>
1549 <span class="comment">%             iStatus = family2status('VCM', VCMlist1);</span>
1550 <span class="comment">%             iBad = find(~iStatus);</span>
1551 <span class="comment">%             VCMlist1 = VCMlist1(find(iStatus),:);</span>
1552 <span class="comment">%             if length(iBad)</span>
1553 <span class="comment">%                 fprintf('   Global Orbit Correction: %d VCMs removed for bad status\n', length(iBad));</span>
1554 <span class="comment">%             end</span>
1555 
1556             <span class="comment">% Initialize RFCorrFlag</span>
1557             RFCorrFlag = <span class="string">'Yes'</span>;
1558 
1559             <span class="comment">% Get the device lists from oscsinit and convert to srcontrol variables</span>
1560             [HBPM, VBPM, HCM, VCM, HSV, VSV] = <a href="ocsinit.html" class="code" title="function [HBPM, VBPM, HCM, VCM, HSV, VSV] = ocsinit(MethodName)">ocsinit</a>(<span class="string">'TopOfFill'</span>);
1561             <span class="keyword">if</span> strcmpi(RFCorrFlag, <span class="string">'Yes'</span>)
1562                 Xivec = 1:HSV+1;
1563             <span class="keyword">else</span>
1564                 Xivec = 1:HSV;
1565             <span class="keyword">end</span>
1566             Yivec = 1:VSV;
1567             BPMlist1 = HBPM.DeviceList;
1568             HCMlist1 = HCM.DeviceList;
1569             VCMlist1 = VCM.DeviceList;
1570             
1571             
1572             LocalBumplist = [
1573               <span class="comment">% 1 1</span>
1574               <span class="comment">% 2 1</span>
1575               <span class="comment">% 3 1</span>
1576                 4 1
1577               <span class="comment">% 4 2</span>
1578                 5 1
1579               <span class="comment">% 6 1</span>
1580               <span class="comment">% 6 2</span>
1581                 7 1
1582                 8 1
1583                 9 1
1584                 10 1
1585                 11 1
1586                 11 2
1587                 12 1
1588                 ];
1589             <span class="comment">%LocalBumplist = []</span>
1590             
1591 
1592         <span class="keyword">else</span>
1593 
1594             <span class="comment">% Get vectors</span>
1595             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>);
1596             BPMlist1 = FB.BPMlist1;
1597             HCMlist1 = FB.HCMlist1;
1598             VCMlist1 = FB.VCMlist1;
1599             Xivec = FB.Xivec;
1600             Yivec = FB.Yivec;
1601             LocalBumplist = FB.LocalBumplist;
1602             Xgoal = FB.Xgoal;
1603             Ygoal = FB.Ygoal;
1604             RFCorrFlag = FB.RFCorrFlag;
1605 
1606             <span class="comment">% Add button to change #ivectors, CMs, IDBPMs,</span>
1607             EditFlag = 0;
1608             h_fig1 = figure;
1609             <span class="keyword">while</span> EditFlag ~= 8
1610 
1611                 <span class="comment">% Sensitivity matrix</span>
1612                 Sx = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
1613                 Sy = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
1614                 
1615                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1616                 <span class="comment">% Can the call below work for setting FOFB RF parameter? %</span>
1617                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1618                 <span class="keyword">if</span> strcmpi(RFCorrFlag, <span class="string">'Yes'</span>)
1619                     Sx = [Sx getdisp(<span class="string">'BPMx'</span>,BPMlist1)];
1620                 <span class="keyword">end</span>
1621                 
1622                 Sx(isnan(Sx)) = 0;
1623                 Sy(isnan(Sy)) = 0;
1624                                
1625                 [Ux, SVx, Vx] = svd(Sx);
1626                 [Uy, SVy, Vy] = svd(Sy);
1627 
1628 
1629                 <span class="comment">% Remove singular values greater than the actual number of singular values</span>
1630                 i = find(Xivec&gt;length(diag(SVx)));
1631                 <span class="keyword">if</span> ~isempty(i)
1632                     disp(<span class="string">'   Horizontal E-vector scaled since there were more elements in the vector than singular values.'</span>);
1633                     pause(0);
1634                     Xivec(i) = [];
1635                 <span class="keyword">end</span>
1636                 i = find(Yivec&gt;length(diag(SVy)));
1637                 <span class="keyword">if</span> ~isempty(i)
1638                     disp(<span class="string">'   Vertical E-vector scaled since there were more elements in the vector than singular values.'</span>);
1639                     pause(0);
1640                     Yivec(i) = [];
1641                 <span class="keyword">end</span>
1642 
1643 
1644                 Ax = Sx*Vx(:,Xivec);
1645                 Tx = inv(Ax'*Ax)*Ax';
1646 
1647                 Ay = Sy*Vy(:,Yivec);
1648                 Ty = inv(Ay'*Ay)*Ay';
1649 
1650 
1651                 figure(h_fig1);
1652                 subplot(2,1,1);
1653                 semilogy(diag(SVx),<span class="string">'b'</span>);
1654                 hold on;
1655                 semilogy(diag(SVx(Xivec,Xivec)),<span class="string">'xr'</span>);
1656                 ylabel(<span class="string">'Horizontal'</span>);
1657                 title(<span class="string">'Response Matrix Singular Values'</span>);
1658                 hold off;
1659                 subplot(2,1,2);
1660                 semilogy(diag(SVy),<span class="string">'b'</span>);
1661                 hold on;
1662                 semilogy(diag(SVy(Yivec,Yivec)),<span class="string">'xr'</span>);
1663                 xlabel(<span class="string">'Singular Value Number'</span>);
1664                 ylabel(<span class="string">'Vertical'</span>);
1665                 hold off;
1666                 drawnow;
1667 
1668                 <span class="keyword">if</span> strcmp(RFCorrFlag,<span class="string">'No'</span>)
1669                     RFCorrState = <span class="string">'NOT CORRECTED'</span>;
1670                 <span class="keyword">elseif</span> strcmp(RFCorrFlag,<span class="string">'Yes'</span>)
1671                     RFCorrState = <span class="string">'CORRECTED'</span>;
1672                 <span class="keyword">else</span>
1673                     RFCorrState = <span class="string">'???'</span>;
1674                 <span class="keyword">end</span>
1675 
1676                 <span class="comment">%         EditFlag = menu('Change Parameters?','Singular Values','HCM List','VCM List','HCM Chicane List','VCM Chicane List','IDBPM List','BBPM List','Change Golden Orbit',...</span>
1677                 <span class="comment">%            'Local Bump List',sprintf('RF Frequency (currently %s)',RFCorrState),'Continue');</span>
1678                 EditFlag = menu(<span class="string">'Change Parameters?'</span>,<span class="string">'Singular Values'</span>,<span class="string">'HCM List'</span>,<span class="string">'VCM List'</span>,<span class="string">'BPM List'</span>,<span class="string">'Change Golden Orbit'</span>,<span class="keyword">...</span>
1679                     <span class="string">'Local Bump List'</span>,sprintf(<span class="string">'RF Frequency (currently %s)'</span>,RFCorrState),<span class="string">'Continue'</span>);
1680 
1681                 <span class="keyword">if</span> EditFlag == 1
1682                     prompt={<span class="string">'Enter the horizontal E-vector numbers (Matlab vector format):'</span>,<span class="string">'Enter the vertical E-vector numbers (Matlab vector format):'</span>};
1683                     def={sprintf(<span class="string">'[%d:%d]'</span>,1,Xivec(end)),sprintf(<span class="string">'[%d:%d]'</span>,1,Yivec(end))};
1684                     titlestr=<span class="string">'SVD Orbit Feedback'</span>;
1685                     lineNo=1;
1686                     answer=inputdlg(prompt,titlestr,lineNo,def);
1687                     <span class="keyword">if</span> ~isempty(answer)
1688                         XivecNew = fix(str2num(answer{1}));
1689                         <span class="keyword">if</span> isempty(XivecNew)
1690                             disp(<span class="string">'   Horizontal E-vector cannot be empty.  No change made.'</span>);
1691                         <span class="keyword">else</span>
1692                             <span class="keyword">if</span> any(XivecNew&lt;=0) || max(XivecNew)&gt;length(diag(SVx))
1693                                 disp(<span class="string">'   Error reading horizontal E-vector.  No change made.'</span>);
1694                             <span class="keyword">else</span>
1695                                 Xivec = XivecNew;
1696                             <span class="keyword">end</span>
1697                         <span class="keyword">end</span>
1698                         YivecNew = fix(str2num(answer{2}));
1699                         <span class="keyword">if</span> isempty(YivecNew)
1700                             disp(<span class="string">'   Vertical E-vector cannot be empty.  No change made.'</span>);
1701                         <span class="keyword">else</span>
1702                             <span class="keyword">if</span> any(YivecNew&lt;=0) || max(YivecNew)&gt;length(diag(SVy))
1703                                 disp(<span class="string">'   Error reading vertical E-vector.  No change made.'</span>);
1704                             <span class="keyword">else</span>
1705                                 Yivec = YivecNew;
1706                             <span class="keyword">end</span>
1707                         <span class="keyword">end</span>
1708                     <span class="keyword">end</span>
1709                 <span class="keyword">end</span>
1710 
1711                 <span class="keyword">if</span> EditFlag == 2
1712                     List = getlist(<span class="string">'HCM'</span>);
1713                     CheckList = zeros(size(List,1));
1714                     Elem = dev2elem(<span class="string">'HCM'</span>, HCMlist1);
1715                     CheckList(Elem) = ones(size(Elem));
1716                     CheckList = CheckList(dev2elem(<span class="string">'HCM'</span>,List));
1717                     newList = editlist(List, <span class="string">'HCM'</span>, CheckList);
1718                     <span class="keyword">if</span> isempty(newList)
1719                         fprintf(<span class="string">'   Horizontal corrector magnet list cannot be empty.  No change made.\n'</span>);
1720                     <span class="keyword">else</span>
1721                         HCMlist1 = newList;
1722                     <span class="keyword">end</span>
1723                 <span class="keyword">end</span>
1724 
1725                 <span class="keyword">if</span> EditFlag == 3
1726                     List = getlist(<span class="string">'VCM'</span>);
1727                     CheckList = zeros(size(List,1));
1728                     Elem = dev2elem(<span class="string">'VCM'</span>, VCMlist1);
1729                     CheckList(Elem) = ones(size(Elem));
1730                     CheckList = CheckList(dev2elem(<span class="string">'VCM'</span>,List));
1731                     newList = editlist(List, <span class="string">'VCM'</span>, CheckList);
1732                     <span class="keyword">if</span> isempty(newList)
1733                         fprintf(<span class="string">'   Vertical corrector magnet cannot be empty.  No change made.\n'</span>);
1734                     <span class="keyword">else</span>
1735                         VCMlist1 = newList;
1736                     <span class="keyword">end</span>
1737                 <span class="keyword">end</span>
1738 
1739                 <span class="keyword">if</span> EditFlag == 4
1740                     ListOld = BPMlist1;
1741                     XgoalOld = Xgoal;
1742                     YgoalOld = Ygoal;
1743 
1744                     <span class="comment">% Full BPM list</span>
1745                     List = <a href="getbpmlist.html" class="code" title="function [DeviceList, Index] = getbpmlist(varargin)">getbpmlist</a>(<span class="string">'Bergoz'</span>);
1746 <span class="comment">%                     List = [</span>
1747 <span class="comment">%                         1 2</span>
1748 <span class="comment">%                         1 5</span>
1749 <span class="comment">%                         1 6</span>
1750 <span class="comment">%                         1 10</span>
1751 <span class="comment">%                         2 1</span>
1752 <span class="comment">%                         2 5</span>
1753 <span class="comment">%                         2 6</span>
1754 <span class="comment">%                         2 9</span>
1755 <span class="comment">%                         3 2</span>
1756 <span class="comment">%                         3 5</span>
1757 <span class="comment">%                         3 6</span>
1758 <span class="comment">%                         3 10</span>
1759 <span class="comment">%                         3 11</span>
1760 <span class="comment">%                         3 12</span>
1761 <span class="comment">%                         4 1</span>
1762 <span class="comment">%                         4 5</span>
1763 <span class="comment">%                         4 6</span>
1764 <span class="comment">%                         4 10</span>
1765 <span class="comment">%                         5 1</span>
1766 <span class="comment">%                         5 5</span>
1767 <span class="comment">%                         5 6</span>
1768 <span class="comment">%                         5 10</span>
1769 <span class="comment">%                         5 11</span>
1770 <span class="comment">%                         5 12</span>
1771 <span class="comment">%                         6 1</span>
1772 <span class="comment">%                         6 5</span>
1773 <span class="comment">%                         6 6</span>
1774 <span class="comment">%                         6 10</span>
1775 <span class="comment">%                         7 1</span>
1776 <span class="comment">%                         7 5</span>
1777 <span class="comment">%                         7 6</span>
1778 <span class="comment">%                         7 10</span>
1779 <span class="comment">%                         8 1</span>
1780 <span class="comment">%                         8 5</span>
1781 <span class="comment">%                         8 6</span>
1782 <span class="comment">%                         8 10</span>
1783 <span class="comment">%                         9 1</span>
1784 <span class="comment">%                         9 5</span>
1785 <span class="comment">%                         9 6</span>
1786 <span class="comment">%                         9 10</span>
1787 <span class="comment">%                         10 1</span>
1788 <span class="comment">%                         10 5</span>
1789 <span class="comment">%                         10 6</span>
1790 <span class="comment">%                         10 10</span>
1791 <span class="comment">%                         10 11</span>
1792 <span class="comment">%                         10 12</span>
1793 <span class="comment">%                         11 1</span>
1794 <span class="comment">%                         11 5</span>
1795 <span class="comment">%                         11 6</span>
1796 <span class="comment">%                         11 10</span>
1797 <span class="comment">%                         12 1</span>
1798 <span class="comment">%                         12 5</span>
1799 <span class="comment">%                         12 6</span>
1800 <span class="comment">%                         12 9</span>
1801 <span class="comment">%                         ];</span>
1802 
1803                     CheckList = zeros(size(List,1),1);
1804                     <span class="keyword">if</span> ~isempty(BPMlist1)
1805                         <span class="keyword">for</span> i = 1:size(List,1)
1806                             k = find(List(i,1)==BPMlist1(:,1));
1807                             l = find(List(i,2)==BPMlist1(k,2));
1808 
1809                             <span class="keyword">if</span> isempty(k) || isempty(l)
1810                                 <span class="comment">% Item not in list</span>
1811                             <span class="keyword">else</span>
1812                                 CheckList(i) = 1;
1813                             <span class="keyword">end</span>
1814                         <span class="keyword">end</span>
1815                     <span class="keyword">end</span>
1816 
1817                     newList = editlist(List, <span class="string">'BPM'</span>, CheckList);
1818                     <span class="keyword">if</span> isempty(newList)
1819                         fprintf(<span class="string">'   BPM list cannot be empty.  No change made.\n'</span>);
1820                     <span class="keyword">else</span>
1821                         BPMlist1 = newList;
1822                     <span class="keyword">end</span>
1823 
1824                     <span class="comment">% Set the goal orbit to the golden orbit</span>
1825                     Xgoal = getgolden(<span class="string">'BPMx'</span>, BPMlist1);
1826                     Ygoal = getgolden(<span class="string">'BPMy'</span>, BPMlist1);
1827 
1828 
1829                     <span class="comment">% If a new BPM is added, then set the goal orbit to the golden orbit</span>
1830                     <span class="keyword">for</span> i = 1:size(BPMlist1,1)
1831 
1832                         <span class="comment">% Is it a new BPM?</span>
1833                         k = find(BPMlist1(i,1)==ListOld(:,1));
1834                         l = find(BPMlist1(i,2)==ListOld(k,2));
1835 
1836                         <span class="keyword">if</span> isempty(k) || isempty(l)
1837                             <span class="comment">% New BPM</span>
1838                         <span class="keyword">else</span>
1839                             <span class="comment">% Use the old value for old BPM</span>
1840                             Xgoal(i) = XgoalOld(k(l));
1841                             Ygoal(i) = YgoalOld(k(l));
1842                         <span class="keyword">end</span>
1843                     <span class="keyword">end</span>
1844                 <span class="keyword">end</span>
1845 
1846                 <span class="keyword">if</span> EditFlag == 5
1847 
1848                     ChangeList = editlist(BPMlist1, <span class="string">'Change BPM'</span>, zeros(size(BPMlist1,1),1));
1849                     <span class="keyword">for</span> i = 1:size(ChangeList,1)
1850 
1851                         k = find(ChangeList(i,1)==BPMlist1(:,1));
1852                         l = find(ChangeList(i,2)==BPMlist1(k,2));
1853 
1854                         prompt = {sprintf(<span class="string">'Enter the new horizontal goal orbit for BPMx(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2)),sprintf(<span class="string">'Enter the new vertical goal orbit for BPMy(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2))};
1855                         def = {sprintf(<span class="string">'%f'</span>,Xgoal(k(l))),sprintf(<span class="string">'%f'</span>,Ygoal(k(l)))};
1856                         titlestr = <span class="string">'CHANGE THE GOAL ORBIT'</span>;
1857                         lineNo = 1;
1858                         answer = inputdlg(prompt, titlestr, lineNo, def);
1859 
1860                         <span class="keyword">if</span> isempty(answer)
1861                             <span class="comment">% No change</span>
1862                             fprintf(<span class="string">'   No change was made to the golden orbit.\n'</span>);
1863                         <span class="keyword">else</span>
1864                             Xgoalnew = str2num(answer{1});
1865                             <span class="keyword">if</span> isempty(Xgoalnew)
1866                                 fprintf(<span class="string">'   No change was made to the horizontal golden orbit.\n'</span>);
1867                             <span class="keyword">else</span>
1868                                 Xgoal(k(l)) = Xgoalnew;
1869                             <span class="keyword">end</span>
1870 
1871                             Ygoalnew = str2num(answer{2});
1872                             <span class="keyword">if</span> isempty(Ygoalnew)
1873                                 fprintf(<span class="string">'   No change was made to the vertical golden orbit.\n'</span>);
1874                             <span class="keyword">else</span>
1875                                 Ygoal(k(l)) = Ygoalnew;
1876                             <span class="keyword">end</span>
1877                         <span class="keyword">end</span>
1878                     <span class="keyword">end</span>
1879                     <span class="keyword">if</span> ~isempty(ChangeList)
1880                         fprintf(<span class="string">'   Note:  changing the goal orbit for &quot;Orbit Correction&quot; does not change the goal orbit for &quot;Slow Orbit Feedback.&quot;\n'</span>);
1881                         fprintf(<span class="string">'          Re-running srcontrol will restart the goal orbit to the golden orbit.&quot;\n'</span>);
1882                     <span class="keyword">end</span>
1883                 <span class="keyword">end</span>
1884 
1885                 <span class="keyword">if</span> EditFlag == 6
1886                     List = [
1887                         1 1
1888                         2 1
1889                         3 1
1890                         4 1
1891                         4 2
1892                         5 1
1893                         6 1
1894                         6 2
1895                         7 1
1896                         8 1
1897                         9 1
1898                         10 1
1899                         11 1
1900                         11 2
1901                         12 1];
1902                     CheckList = zeros(size(List,1),1);
1903                     <span class="keyword">if</span> ~isempty(LocalBumplist)
1904                         <span class="keyword">for</span> i = 1:size(List,1)
1905                             k = find(List(i,1)==LocalBumplist(:,1));
1906                             l = find(List(i,2)==LocalBumplist(k,2));
1907 
1908                             <span class="keyword">if</span> isempty(k) || isempty(l)
1909                                 <span class="comment">% Item not in list</span>
1910                             <span class="keyword">else</span>
1911                                 CheckList(i) = 1;
1912                             <span class="keyword">end</span>
1913                         <span class="keyword">end</span>
1914                     <span class="keyword">end</span>
1915                     LocalBumplist = editlist2(List, <span class="string">'Sector'</span>, CheckList);
1916                 <span class="keyword">end</span>
1917 
1918                 <span class="keyword">if</span> EditFlag == 7
1919                     RFCorrFlag = questdlg(sprintf(<span class="string">'Set RF Frequency during Orbit Correction?'</span>),<span class="string">'RF Frequency'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>, <span class="string">'No'</span>);
1920                     <span class="keyword">if</span> strcmp(RFCorrFlag,<span class="string">'No'</span>)
1921                         disp([<span class="string">'   RF Frequency will not be included in global orbit correction.'</span>]);
1922                     <span class="keyword">elseif</span> strcmp(RFCorrFlag,<span class="string">'Yes'</span>)
1923                         disp([<span class="string">'   RF Frequency will be included in global orbit correction.'</span>]);
1924                     <span class="keyword">end</span>
1925 
1926                 <span class="keyword">end</span>
1927             <span class="keyword">end</span>
1928             close(h_fig1);
1929         <span class="keyword">end</span>
1930 
1931         <span class="comment">%  ORBIT CORRECTION STRUCTURE (OCS)</span>
1932         <span class="comment">%    OCS.BPM (data structure)</span>
1933         <span class="comment">%    OCS.CM  (data structure)</span>
1934         <span class="comment">%    OCS.GoalOrbit</span>
1935         <span class="comment">%    OCS.NIter</span>
1936         <span class="comment">%    OCS.SVDIndex</span>
1937         <span class="comment">%    OCS.IncrementalFlag = 'Yes'/'No'</span>
1938         <span class="comment">%    OCS.BPMWeight</span>
1939         <span class="comment">%    OCS.Flags = { 'FitRF' , etc. }</span>
1940         OCSx.BPM = getx(BPMlist1, <span class="string">'struct'</span>);
1941         OCSx.CM = getsp(<span class="string">'HCM'</span>, HCMlist1, <span class="string">'struct'</span>);
1942         OCSx.GoalOrbit = getgolden(OCSx.BPM, <span class="string">'numeric'</span>);
1943         OCSx.NIter = 1;
1944         OCSx.SVDIndex = Xivec;
1945         OCSx.IncrementalFlag = <span class="string">'No'</span>;
1946         OCSx.FitRF = 1;
1947         OCSy.BPM = gety(BPMlist1, <span class="string">'struct'</span>);
1948         OCSy.CM = getsp(<span class="string">'VCM'</span>, VCMlist1, <span class="string">'struct'</span>);
1949         OCSy.GoalOrbit = getgolden(OCSy.BPM, <span class="string">'numeric'</span>);
1950         OCSy.NIter = 1;
1951         OCSy.SVDIndex = Yivec;
1952         OCSy.IncrementalFlag = <span class="string">'No'</span>;
1953         OCSy.FitRF = 0;
1954 
1955         <span class="comment">% Save vectors</span>
1956         FB.OCSx = OCSx;
1957         FB.OCSy = OCSy;
1958 
1959         FB.BPMlist1 = BPMlist1;
1960         FB.HCMlist1 = HCMlist1;
1961         FB.VCMlist1 = VCMlist1;
1962         FB.Xivec = Xivec;
1963         FB.Yivec = Yivec;
1964         FB.Xgoal = OCSx.GoalOrbit;
1965         FB.Ygoal = OCSy.GoalOrbit;
1966         FB.RFCorrFlag = RFCorrFlag;
1967         FB.LocalBumplist = LocalBumplist;
1968         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>,FB);
1969         
1970         
1971     <span class="keyword">case</span> <span class="string">'Feedback'</span>
1972 
1973         FBloopIter = 1;
1974         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxFOFB'</span>),<span class="string">'Value'</span>) == 1
1975             StartFOFBFlag = 1;
1976         <span class="keyword">else</span>
1977             StartFOFBFlag = 0;
1978         <span class="keyword">end</span>
1979 
1980         FEEDBACK_STOP_FLAG = 0;
1981         HWarnNum=0;
1982         VWarnNum=0;
1983 
1984         SR_GeV = getenergy;
1985         <span class="comment">% Feedback loop setup</span>
1986         PlotInfoFlag = 0;           <span class="comment">% Plot micado stuff</span>
1987         LoopDelay = 1.0;           <span class="comment">% Period of feedback loop [seconds], make sure the BPM averaging is correct</span>
1988         VCM_LSB = .00366211;
1989         VCMCHICANE_LSB = .002441;   <span class="comment">% 80 max?,  Note: not fully implemented</span>
1990 
1991         <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
1992             Xgain  = 0.2;
1993             Ygain  = 0.1;
1994         <span class="keyword">else</span>
1995             Xgain  = 0.8; <span class="comment">% raised 0.5-&gt;0.8 at 17:20, 3-2-05 to more quickly correct EPU4 fast switching orbit distortions</span>
1996             Ygain  = 0.8;
1997         <span class="keyword">end</span>
1998 
1999         <span class="comment">% Load lattice set for tune feed forward</span>
2000         ConfigSetpoint = getproductionlattice;
2001         <span class="comment">%load([getfamilydata('Directory','OpsData') getfamilydata('OpsData','LatticeFile')]);</span>
2002         QFsp = ConfigSetpoint.QF.Setpoint.Data;
2003         QDsp = ConfigSetpoint.QD.Setpoint.Data;
2004         TuneW16Min = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>([5 1], 13.23, 1.8909);
2005         <span class="comment">% Tune response matrix</span>
2006         SR_TUNE_MATRIX = gettuneresp({<span class="string">'QF'</span>,<span class="string">'QD'</span>}, {[],[]}, getenergy(<span class="string">'Production'</span>));    <span class="comment">% Approx. [0.1944 -0.0286;-0.1182 0.1526];</span>
2007         <span class="comment">%SR_TUNE_MATRIX = [0.1641 -0.0245</span>
2008         <span class="comment">%                 -0.1149 0.1477];</span>
2009         
2010         SQSFsp = <a href="amp2k.html" class="code" title="function [k, B] = amp2k(Family, Field, Amps, DeviceList, Energy, BranchFlag)">amp2k</a>(<span class="string">'SQSF'</span>,<span class="string">'Setpoint'</span>,ConfigSetpoint.SQSF.Setpoint.Data);
2011         SQSDsp = <a href="amp2k.html" class="code" title="function [k, B] = amp2k(Family, Field, Amps, DeviceList, Energy, BranchFlag)">amp2k</a>(<span class="string">'SQSD'</span>,<span class="string">'Setpoint'</span>,ConfigSetpoint.SQSD.Setpoint.Data);
2012 
2013 <span class="comment">%         % tune FF for EPUs (data exist for 4 1 parallel, 11 1 parallel and antiparallel</span>
2014 <span class="comment">%         load '/home/als/physdata/matlab/srdata/gaptrack/EPU4-1_tunecomp/after_shimming/nux_map_withgaps.mat'</span>
2015 <span class="comment">%         dnux_epu_41_m0 = tunexmap(2:end,2:end)-tunexmap(2,12);</span>
2016 <span class="comment">%         [gap_epu_41,shift_epu_41]=meshgrid(tunexmap(2:end,1),tunexmap(1,2:end));</span>
2017 <span class="comment">%         load '/home/als/physdata/matlab/srdata/gaptrack/EPU4-1_tunecomp/after_shimming/nuy_map_withgaps.mat'</span>
2018 <span class="comment">%         dnuy_epu_41_m0 = tuneymap(2:end,2:end)-tuneymap(2,12);</span>
2019 <span class="comment">%</span>
2020 <span class="comment">%         load '/home/als/physdata/matlab/srdata/gaptrack/archive/epu11d1m0e19_2007-01-28.mat' tune_x tune_y Gaps GapsLongitudinal</span>
2021 <span class="comment">%         dnux_epu_111_m0 = tune_x-tune_x(1,11);</span>
2022 <span class="comment">%         [gap_epu_111,shift_epu_111]=meshgrid(Gaps,GapsLongitudinal);</span>
2023 <span class="comment">%         dnuy_epu_111_m0 = tune_y-tune_y(1,11);</span>
2024 <span class="comment">%         load '/home/als/physdata/matlab/srdata/gaptrack/archive/epu11d1m1e19_2007-01-28.mat' tune_x tune_y Gaps GapsLongitudinal</span>
2025 <span class="comment">%         dnux_epu_111_m1 = tune_x-tune_x(1,11);</span>
2026 <span class="comment">%         dnuy_epu_111_m1 = tune_y-tune_y(1,11);</span>
2027 
2028         <span class="comment">% tune FF for EPUs (data exist for 4 1 parallel, 11 1 parallel and antiparallel</span>
2029         load <span class="string">'/home/als/physdata/matlab/srdata/epu/tuneshift_2d_tables/epu_tunetables_2d_20070723.mat'</span>
2030         dnux41p = nux41p-nux41p(1,11);      
2031         dnuy41p = nuy41p-nuy41p(1,11);      
2032         dnux41a = nux41a-nux41a(1,11);      
2033         dnuy41a = nuy41a-nuy41a(1,11);      
2034         dnux111p = nux111p-nux111p(1,11);      
2035         dnuy111p = nuy111p-nuy111p(1,11);      
2036         dnux111a = nux111a-nux111a(1,11);      
2037         dnuy111a = nuy111a-nuy111a(1,11);      
2038         dnux112p = nux112p-nux112p(1,11);      
2039         dnuy112p = nuy112p-nuy112p(1,11);      
2040         dnux112a = nux112a-nux112a(1,11);      
2041         dnuy112a = nuy112a-nuy112a(1,11);      
2042         
2043         <span class="comment">% ID tune compensation does not work in the injection lattice, so ...</span>
2044         <span class="keyword">if</span> abs(SR_GEV - <a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>)&gt;  0.05     <span class="comment">% Don't use this routine for the injection lattice</span>
2045             fprintf(<span class="string">'   This routine should only be used for the production energy: Orbit feedback aborted\n'</span>);
2046             <span class="keyword">return</span>
2047         <span class="keyword">end</span>
2048 
2049         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
2050 
2051         <span class="keyword">try</span>
2052             fprintf(<span class="string">'\n'</span>);
2053             fprintf(<span class="string">'   *******************************\n'</span>);
2054             fprintf(<span class="string">'   **  Starting Orbit Feedback  **\n'</span>);
2055             fprintf(<span class="string">'   *******************************\n'</span>);
2056             a = clock;
2057             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2058             fprintf(<span class="string">'   Note: the Matlab command window will be used to display status information.\n'</span>);
2059             fprintf(<span class="string">'         It cannot be used to enter commands during slow orbit feedback.\n'</span>);
2060 
2061 
2062                 <span class="comment">% save current BPM timeconstant - will reset to this when feedback stops</span>
2063                 BPMtimeconstantOFB = <a href="getbpmtimeconstant.html" class="code" title="function [BPMTimeConstant, WarningFlag] = getbpmtimeconstant(varargin)">getbpmtimeconstant</a>;
2064                 fprintf(<span class="string">'   Current Bergoz BPM time constant is %.1fs\n'</span>, BPMtimeconstantOFB);
2065                 
2066             <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
2067             disp(<span class="string">'   Bergoz BPM time constant set to 0.2s.'</span>)
2068             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.2)
2069             pause(1.1);
2070 
2071             <span class="comment">% Check whether bumps and kickers are on and warn to turn off before starting feedback if necessary</span>
2072             <span class="keyword">try</span>
2073                 <span class="keyword">if</span> (getsp(<span class="string">'SR01S___BUMP1__BC21'</span>)==1 &amp;&amp; getsp(<span class="string">'SR01S___BUMP1P_BC22'</span>)==1) || (getsp(<span class="string">'SR01S___SEK____BC21'</span>)==1 &amp;&amp; getsp(<span class="string">'SR01S___SEK_P__BC23'</span>)==1) || (getsp(<span class="string">'SR01S___SEN____BC20'</span>)==1 &amp;&amp; getsp(<span class="string">'SR01S___SEN_P__BC22'</span>)==1)
2074                     soundtada;
2075                     fprintf(<span class="string">'   \n'</span>);
2076                     fprintf(<span class="string">'   *********************************************************************************\n'</span>);
2077                     fprintf(<span class="string">'   ** One or more of the pulsed SR injection magnets is still on!  Turn them off! **\n'</span>);
2078                     fprintf(<span class="string">'   *********************************************************************************\n'</span>);
2079                     fprintf(<span class="string">'   \n'</span>);
2080                 <span class="keyword">end</span>
2081             <span class="keyword">catch</span>
2082                 fprintf(<span class="string">'   %s \n'</span>,lasterr);
2083                 disp(<span class="string">'**Problem checking the state of the bumps and kickers - please check that they are not pulsing.'</span>);
2084             <span class="keyword">end</span>
2085 
2086             <span class="comment">% Get vectors</span>
2087 
2088             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
2089 
2090             BPMlist1 = FB.OCSx.BPM.DeviceList;
2091             <span class="comment">% FOFB_BPMlist =</span>
2092             HCMlist1 = FB.HCMlist1;
2093             VCMlist1 = FB.VCMlist1;
2094             Xivec = FB.Xivec;
2095             Yivec = FB.Yivec;
2096             Xgoal = FB.OCSx.GoalOrbit;
2097             Ygoal = FB.OCSy.GoalOrbit;
2098             FFTypeFlag = FB.FFTypeFlag;   <span class="comment">%local or global tune correction</span>
2099 
2100             iNotHCMChicane = find(HCMlist1(:,2) &lt; 10); <span class="comment">%used by steppv's for setting correctors in loop</span>
2101             iHCMChicane = find(HCMlist1(:,2) == 10);
2102             iNotVCMChicane = find(VCMlist1(:,2) &lt; 10);
2103             iVCMChicane = find(VCMlist1(:,2) == 10);
2104 
2105             <span class="comment">% Sensitivity matrix for setting fast feedback setpoints</span>
2106             Sx1 = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
2107             Sy1 = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
2108 
2109         <span class="keyword">catch</span>
2110             fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
2111 
2112             <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2113             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2114             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2115 
2116 
2117             a = clock;
2118             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2119             fprintf(<span class="string">'   *************************************************************\n'</span>);
2120             fprintf(<span class="string">'   **  Orbit feedback could not start due to error condition  **\n'</span>);
2121             fprintf(<span class="string">'   *************************************************************\n\n'</span>);
2122             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
2123             pause(0);
2124 
2125             <span class="keyword">return</span>
2126         <span class="keyword">end</span>
2127 
2128         StartFlag = questdlg(strvcat(<span class="string">''</span>,<span class="string">'Is it OK to start orbit feedback?'</span>),<span class="string">'Orbit Feedback'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
2129         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
2130             <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2131             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2132             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2133 
2134             a = clock;
2135             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2136             fprintf(<span class="string">'   ***************************\n'</span>);
2137             fprintf(<span class="string">'   **  Orbit Feedback Exit  **\n'</span>);
2138             fprintf(<span class="string">'   ***************************\n\n'</span>);
2139             pause(0);
2140             <span class="keyword">return</span>
2141         <span class="keyword">end</span>
2142 
2143         SR_STATE_OLD = scaget(<span class="string">'SR_STATE'</span>);
2144         setpv(<span class="string">'SR_STATE'</span>, 5);
2145         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
2146         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2147         <span class="keyword">if</span> StateNumber &gt;= 0
2148             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2149         <span class="keyword">else</span>
2150             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2151         <span class="keyword">end</span>
2152         fprintf(<span class="string">'   Using %d E-vectors horizontally.\n'</span>, length(Xivec));
2153         fprintf(<span class="string">'   Using %d E-vectors vertically.\n'</span>,   length(Yivec));
2154         fprintf(<span class="string">'   Starting slow orbit correction every %.1f seconds.\n'</span>, LoopDelay);
2155         <span class="comment">%  fprintf('   Resetting SR11 chicane motors every 20 seconds to fix drift problem.\n');</span>
2156 
2157         IDSector = getlist(<span class="string">'ID'</span>);
2158         EPUlist = find((IDSector(:,1)==4) | (IDSector(:,1)==11));
2159         oldgap=210*ones(size(IDSector,1),1);
2160         oldShift=zeros(size(oldgap));
2161           
2162         <span class="keyword">try</span>
2163             
2164             <span class="comment">% Get and display data</span>
2165             x = FB.OCSx.GoalOrbit - getx(FB.OCSx.BPM.DeviceList);
2166             y = FB.OCSy.GoalOrbit - gety(FB.OCSy.BPM.DeviceList);
2167             STDx = norm(x)/sqrt(length(x));
2168             STDy = norm(y)/sqrt(length(y));
2169             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = %.4f mm'</span>,STDx),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2170             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = %.4f mm'</span>,STDy),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2171 
2172             <span class="comment">% write goldenorbit values to Fast Orbit Feedback</span>
2173             <span class="keyword">try</span>
2174                 <a href="write_goldenorbit_ffb.html" class="code" title="function write_goldenorbit_ffb">write_goldenorbit_ffb</a>;
2175             <span class="keyword">catch</span>
2176                 fprintf(<span class="string">'   %s \n'</span>,lasterr);
2177                 disp(<span class="string">'write_goldenorbit_ffb did not work!'</span>);
2178             <span class="keyword">end</span>
2179             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2180             <span class="comment">%pause(0);</span>
2181 
2182             <span class="comment">%display state of FOFB system</span>
2183             FOFBStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2184                 getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2185                 getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2186                 getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2187             FOFBStatusStr = [<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>];
2188             <span class="keyword">for</span> loop = 1:size(FOFBStatus,2)
2189                 <span class="keyword">if</span> FOFBStatus(loop)==0
2190                     FOFBStatusStr(loop,:) = <span class="string">'OFF '</span>;
2191                 <span class="keyword">elseif</span> FOFBStatus(loop)==1
2192                     FOFBStatusStr(loop,:) = <span class="string">'ON  '</span>;
2193                 <span class="keyword">elseif</span> FOFBStatus(loop)==2
2194                     FOFBStatusStr(loop,:) = <span class="string">'OPEN'</span>;
2195                 <span class="keyword">else</span>
2196                     FOFBStatusStr(loop,:) = <span class="string">'BAD '</span>;
2197                 <span class="keyword">end</span>
2198             <span class="keyword">end</span>
2199             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 %s'</span>,FOFBStatusStr(1,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2200             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 %s'</span>,FOFBStatusStr(2,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2201             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 %s'</span>,FOFBStatusStr(3,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2202             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 %s'</span>,FOFBStatusStr(4,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2203             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 %s'</span>,FOFBStatusStr(5,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2204             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 %s'</span>,FOFBStatusStr(6,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2205             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 %s'</span>,FOFBStatusStr(7,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2206             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 %s'</span>,FOFBStatusStr(8,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2207             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 %s'</span>,FOFBStatusStr(9,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2208             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 %s'</span>,FOFBStatusStr(10,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2209             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 %s'</span>,FOFBStatusStr(11,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2210             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 %s'</span>,FOFBStatusStr(12,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2211 
2212         <span class="keyword">catch</span>
2213 
2214             fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
2215 
2216             <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2217             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2218             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2219 
2220 
2221             a = clock;
2222             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2223             fprintf(<span class="string">'   *************************************************************\n'</span>);
2224             fprintf(<span class="string">'   **  Orbit feedback could not start due to error condition  **\n'</span>);
2225             fprintf(<span class="string">'   *************************************************************\n\n'</span>);
2226 
2227             setpv(<span class="string">'SR_STATE'</span>,SR_STATE_OLD);
2228             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2229             <span class="keyword">if</span> StateNumber &gt;= 0
2230                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2231             <span class="keyword">else</span>
2232                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2233             <span class="keyword">end</span>
2234             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
2235             pause(0);
2236 
2237             <span class="keyword">return</span>
2238 
2239         <span class="keyword">end</span>
2240 
2241 
2242         <span class="comment">% Disable buttons</span>
2243         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
2244         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2245         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2246         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2247         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2248         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2249         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2250         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2251         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2252         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2253         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2254         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2255         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2256         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2257         pause(0);
2258 
2259 
2260         <span class="comment">% Initialize feedback loop</span>
2261         StartTime = gettime;
2262         StartErrorTime = gettime;
2263         Xold = getx(FB.OCSx.BPM.DeviceList);
2264         Yold = gety(FB.OCSy.BPM.DeviceList);
2265         HQMOFM_stalenum = 0;
2266         pause(LoopDelay);
2267 
2268         N_HCM = size(HCMlist1,1);
2269         N_VCM = size(VCMlist1,1);
2270 
2271         N_RFMO = 1;
2272 
2273         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
2274             [FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,<span class="string">'SetRF'</span>,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2275         <span class="keyword">else</span>
2276             [FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2277         <span class="keyword">end</span>
2278         [FB.OCSx, Smatx, Sx, Ux, Vx] = orbitcorrectionmethods(FB.OCSx);
2279 
2280         [FB.OCSy, junk, OCSy0] = setorbit(FB.OCSy,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2281         [FB.OCSy, Smaty, Sy, Uy, Vy] = orbitcorrectionmethods(FB.OCSy);
2282 
2283 
2284         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2285         <span class="comment">% Start feedback loop %</span>
2286         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2287 
2288         <span class="comment">% chicaneloop=1;  % loop variable for resetting drifting chicanes (see a few lines below)</span>
2289         <span class="comment">% fftest=figure;</span>
2290 
2291         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2); <span class="comment">% put FOFB in open loop so beamnoise gets recorded even if FOFB is not enabled</span>
2292 
2293         <span class="keyword">while</span> 1
2294             <span class="keyword">try</span>
2295                 t00 = gettime;
2296 
2297                 <span class="comment">%          if chicaneloop==20 % reset SR11 motor chicane setpoints every 20s due to drifting positions</span>
2298                 <span class="comment">%             setsp('HCMCHICANEM',HCMCHICANEMsp(6),[11 1],0);</span>
2299                 <span class="comment">%             setsp('HCMCHICANEM',HCMCHICANEMsp(7),[11 2],0);</span>
2300                 <span class="comment">%             chicaneloop = 1;</span>
2301                 <span class="comment">%          else</span>
2302                 <span class="comment">%             chicaneloop = chicaneloop + 1;</span>
2303                 <span class="comment">%          end</span>
2304 
2305                 <span class="comment">% Check if GUI has been closed</span>
2306                 <span class="keyword">if</span> isempty(gcbf)
2307                     FEEDBACK_STOP_FLAG = 1;
2308                     lasterr(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2309                     error(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2310                 <span class="keyword">end</span>
2311 
2312                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2313                 <span class="comment">% Fast orbit feedback %</span>
2314                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2315                 <span class="keyword">if</span> StartFOFBFlag == 1 &amp;&amp; FBloopIter &gt; 3
2316                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2317                     pause(0.5);
2318                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,1);
2319                     StartFOFBFlag = 0;
2320                     pause(1);
2321                     FOFBOnStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2322                         getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2323                         getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2324                         getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2325                     <span class="keyword">if</span> any(FOFBOnStatus==0) || any(FOFBOnStatus==2)
2326                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2); <span class="comment">% open FOFB loop</span>
2327                         disp(<span class="string">'************************************************************************************************************'</span>);
2328                         disp(<span class="string">'** Problem turning on Fast Orbit Feedback system...                                                       **'</span>);
2329                         disp(<span class="string">'** Check status of ffbsecXX crates - but remember that a crate reboot will turn off Quads in that sector! **'</span>);
2330                         disp(<span class="string">'** Suggest disabling the &quot;Fast Orbit Correction&quot; checkbox and starting Orbit Feedback again.              **'</span>);
2331                         disp(<span class="string">'************************************************************************************************************'</span>);
2332                     <span class="keyword">else</span>
2333                         fprintf(<span class="string">'   Starting Fast Orbit Feedback at %.0f Hz.\n'</span>, getpv(<span class="string">'SR01____FFBFREQAM00'</span>));
2334                     <span class="keyword">end</span>
2335                 <span class="keyword">end</span>
2336 
2337 
2338                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2339                 <span class="comment">% Horizontal plane &quot;feedback&quot; %</span>
2340                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2341 
2342                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxSOFB'</span>),<span class="string">'Value'</span>) == 1
2343 
2344                     <span class="comment">% Get orbit and check that the BPMs are different from the last update</span>
2345                     Xnew = getx(FB.OCSx.BPM.DeviceList);
2346 
2347                     <span class="comment">% Don't feedback if the current is too small</span>
2348                     <span class="keyword">if</span> getdcct &lt; 2
2349                         FEEDBACK_STOP_FLAG = 1;
2350                         fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2351                         <span class="keyword">break</span>;
2352                     <span class="keyword">end</span>
2353 
2354                     x = Xgoal - Xnew;
2355                     STDx = norm(x)/sqrt(length(x));
2356 
2357                     <span class="keyword">if</span> any(Xold == Xnew)
2358                         a = clock;
2359                         N_Stale_Data_Points = find((Xold==Xnew)==1);
2360                         <span class="keyword">for</span> loop = N_Stale_Data_Points'
2361                             fprintf(<span class="string">'   Stale data: BPMx(%2d,%d), feedback step skipped (%s %d:%d:%.0f). \n'</span>, FB.OCSx.BPM.DeviceList(loop,1), FB.OCSx.BPM.DeviceList(loop,2), date, a(4), a(5), a(6));
2362                         <span class="keyword">end</span>
2363                     <span class="keyword">else</span>
2364                         <span class="comment">% Compute horizontal correction</span>
2365                         <span class="comment">%%%OCSx0 = FB.OCSx;</span>
2366                         FB.OCSx.BPM.Data = Xnew;
2367                         FB.OCSx = orbitcorrectionmethods(FB.OCSx, Smatx, Sx, Ux, Vx);
2368 
2369                         <span class="comment">%%%[FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,'Nodisplay','Nosetsp');</span>
2370 
2371                         <span class="comment">% reduced feedback gain (implemented by Greg Portmann, December 2000)</span>
2372                         <span class="comment">% reduced to 0.1, C. Steier, 2001-09-04, IDBPMs are noisy at the moment</span>
2373                         <span class="comment">% increased back to 0.8 C. Steier, 2001-09-29, IDBPMs filtering + direct DAC read/write + all SVDs (no arc BPMs)</span>
2374                         <span class="comment">% increased to 1.0, C. Steier, 2002-05-04, trim DACs</span>
2375                                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2376                                 <span class="comment">% should probably actively allocate X's size to prevent possible memory leak %</span>
2377                                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2378                         X = [Xgain .* FB.OCSx.CM.Delta; 0.3*FB.OCSx.DeltaRF/4.988e-3];
2379                         
2380                         <span class="comment">%%%X = Xgain .* (FB.OCSx.CM.Data - OCSx0.CM.Data);</span>
2381 
2382                         <span class="comment">% check corrector trim values + next step values, warn or stop FB as necessary</span>
2383                         HCMtrimSP=getpv(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1);
2384                         HCMtrimSP_next = HCMtrimSP + X(1:N_HCM);
2385                         <span class="keyword">if</span> max(abs(HCMtrimSP_next)) &gt; 4
2386                             HCMtrimnum=find(abs(HCMtrimSP_next) &gt; 4);
2387 
2388                             <span class="comment">% print message to screen</span>
2389                             fprintf(<span class="string">'\n'</span>);
2390                             fprintf(<span class="string">'***One or more of the horizontal correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2391                             fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2392                             <span class="keyword">for</span> loop = HCMtrimnum'
2393                                 fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1(loop,:)));
2394                             <span class="keyword">end</span>
2395 
2396                             <span class="comment">% send alphapage to operator pager</span>
2397                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2398                             FEEDBACK_STOP_FLAG = 1;
2399 
2400                             setpv(<span class="string">'SR_STATE'</span>, -5);
2401                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2402                             <span class="keyword">if</span> StateNumber &gt;= 0
2403                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2404                             <span class="keyword">else</span>
2405                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2406                             <span class="keyword">end</span>
2407                         <span class="keyword">end</span>
2408 
2409                         <span class="comment">% check chicane trim coil values + next step values, warn or stop FB as necessary</span>
2410                         HCMCHICANEtrimSP=getpv(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>,HCMlist1(iHCMChicane,:));
2411                         HCMCHICANEtrimSP_next = HCMCHICANEtrimSP + X(iHCMChicane);
2412                         <span class="keyword">if</span> max(abs(HCMCHICANEtrimSP_next)) &gt; 19.9
2413                             HCMCHICANEtrimnum=find(abs(HCMCHICANEtrimSP_next) &gt; 19.9);
2414 
2415                             <span class="comment">% print message to screen</span>
2416                             fprintf(<span class="string">'\n'</span>);
2417                             fprintf(<span class="string">'***One or more of the horizontal chicane trim coil correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2418                             fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2419                             <span class="keyword">for</span> loop = HCMCHICANEtrimnum'
2420                                 fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>,HCMlist1(iHCMChicane(loop,:),:)));
2421                             <span class="keyword">end</span>
2422                             <span class="comment">%fprintf('***Maybe try resetting the setpoints of the motor chicanes in case they are drifting...\n');</span>
2423 
2424                             <span class="comment">% send alphapage to operator pager</span>
2425                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2426                             FEEDBACK_STOP_FLAG = 1;
2427 
2428                             setpv(<span class="string">'SR_STATE'</span>, -5);
2429                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2430                             <span class="keyword">if</span> StateNumber &gt;= 0
2431                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2432                             <span class="keyword">else</span>
2433                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2434                             <span class="keyword">end</span>
2435                         <span class="keyword">end</span>
2436 
2437                         <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2438                             <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2439                             <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2440                                 disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2441                             <span class="keyword">end</span>
2442                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2443                             pause(0.5);
2444                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2445                             <span class="keyword">break</span>;
2446                         <span class="keyword">end</span>
2447 
2448                         <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2449                         pause(0);
2450 
2451                         <span class="keyword">if</span> max(abs(HCMtrimSP_next) &gt; 3)
2452                             HCMtrimnum=find(abs(HCMtrimSP_next) &gt; 3);
2453                             HWarnNum=HWarnNum+1;
2454                             <span class="keyword">if</span> (HWarnNum==1 || rem(HWarnNum,120)==0)
2455 
2456                                 <span class="comment">% print message to screen every two minutes</span>
2457                                 fprintf(<span class="string">'\n'</span>);
2458                                 fprintf(<span class="string">'***One or more of the horizontal corrector trims is above 3A or below -3A! \n'</span>);
2459                                 fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2460                                 <span class="keyword">for</span> loop = HCMtrimnum'
2461                                     fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1(loop,:)));
2462                                 <span class="keyword">end</span>
2463                                 fprintf(<span class="string">'***The orbit feedback is still working but this problem should be investigated. \n'</span>);
2464 
2465                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2466                                 <span class="keyword">if</span> (HWarnNum==1 || HWarnNum==600)
2467                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageHCM.txt
2468                                 <span class="keyword">end</span>
2469                             <span class="keyword">end</span>
2470                         <span class="keyword">elseif</span> max(abs(HCMCHICANEtrimSP_next) &gt; 15)
2471                             HCMCHICANEtrimnum=find(abs(HCMCHICANEtrimSP_next) &gt; 15);
2472                             HWarnNum=HWarnNum+1;
2473                             <span class="keyword">if</span> (HWarnNum==1 || rem(HWarnNum,120)==0)
2474 
2475                                 <span class="comment">% print message to screen every two minutes</span>
2476                                 fprintf(<span class="string">'\n'</span>);
2477                                 fprintf(<span class="string">'***One or more of the horizontal chicane corrector trim coils is above 15A or below -15A! \n'</span>);
2478                                 fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2479                                 <span class="keyword">for</span> loop = HCMCHICANEtrimnum'
2480                                     fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>,HCMlist1(iHCMChicane(loop,:),:)));
2481                                 <span class="keyword">end</span>
2482                                 fprintf(<span class="string">'***The orbit feedback is still working but this problem should be investigated. \n'</span>);
2483                                 
2484 <span class="comment">% All motor chicanes have harmonic drives now, so slipping should be impossible - 6-4-08 - T.Scarvie</span>
2485 <span class="comment">%                                 %reset motor chicanes in case they are drifting</span>
2486 <span class="comment">%                                 try</span>
2487 <span class="comment">%                                     %                                     if HCMCHICANEtrimnum(1)==1</span>
2488 <span class="comment">%                                     %                                         if HCMCHICANEtrimSP_next(1)&gt;15</span>
2489 <span class="comment">%                                     %                                             steppv('HCMCHICANEM',-0.5,[4 1;4 2]);</span>
2490 <span class="comment">%                                     %                                         elseif HCMCHICANEtrimSP_next(1)&lt;(-15)</span>
2491 <span class="comment">%                                     %                                             steppv('HCMCHICANEM',0.5,[4 1;4 2]);</span>
2492 <span class="comment">%                                     %                                         end</span>
2493 <span class="comment">%                                     %                                     end</span>
2494 <span class="comment">%                                     fprintf('   Resetting the setpoints of the motor chicanes in case they are drifting...\n');</span>
2495 <span class="comment">%                                     setpv('HCMCHICANEM','Setpoint',ConfigSetpoint.HCMCHICANEM.Setpoint.Data,[],0);</span>
2496 <span class="comment">%                                 catch</span>
2497 <span class="comment">%                                     fprintf('   %s \n',lasterr);</span>
2498 <span class="comment">%                                 end</span>
2499 
2500                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2501                                 <span class="keyword">if</span> (HWarnNum==1 || HWarnNum==600)
2502                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageHCMCHICANE.txt
2503                                 <span class="keyword">end</span>
2504                             <span class="keyword">end</span>
2505                         <span class="keyword">else</span>
2506                             HWarnNum=0;
2507                         <span class="keyword">end</span>
2508 
2509                         <span class="comment">% Don't feedback if the current is too small</span>
2510                         <span class="keyword">if</span> getdcct &lt; 2
2511                             FEEDBACK_STOP_FLAG = 1;
2512                             fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2513                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/beamisoff.txt
2514                             <span class="keyword">break</span>;
2515                         <span class="keyword">end</span>
2516 
2517                         <span class="keyword">if</span> N_HCM &gt; 0
2518                             steppv(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>, X(iNotHCMChicane), HCMlist1(iNotHCMChicane,:), 0);
2519                             steppv(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>, X(iHCMChicane), HCMlist1(iHCMChicane,:), 0);
2520                         <span class="keyword">end</span>
2521 
2522                         <span class="comment">% write fast orbit feedback setpoints</span>
2523                         <span class="keyword">if</span> 1
2524                             <span class="comment">%write_goldenorbit_ffb_2planes(1, Xnew(1:size(BPMlist1,1))+Sx1*X(1:N_HCM)+Sx3*X(length(X))/20, BPMlist1);</span>
2525                             <span class="comment">% should be corrected to include result of next frequency step ...</span>
2526                             <a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>(1,Xnew(1:size(BPMlist1,1))+Sx1*X(1:N_HCM),BPMlist1);
2527                         <span class="keyword">end</span>
2528 
2529                         <span class="comment">%fprintf('Horizontal Done: %f \n',gettime-t00);</span>
2530 
2531                         <span class="comment">% RF feedback</span>
2532                         HQMOFMsp_last = getpv(<span class="string">'EG______HQMOFM_AC01'</span>);
2533 
2534                         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
2535                             <span class="keyword">if</span> N_RFMO &gt; 0
2536                                 <span class="keyword">if</span> abs(X(end)) &lt; .01
2537                                     <span class="comment">% if abs(FB.OCSx.DeltaRF/3) &lt; .01</span>
2538                                     steppv(<span class="string">'EG______HQMOFM_AC01'</span>, X(end));
2539                                 <span class="keyword">else</span>
2540                                     steppv(<span class="string">'EG______HQMOFM_AC01'</span>, 0.01*sign(X(end)));
2541                                 <span class="keyword">end</span>
2542                             <span class="keyword">end</span>
2543 
2544                             HQMOFMsp_now = getpv(<span class="string">'EG______HQMOFM_AC01'</span>);
2545 
2546                             <span class="comment">% Check for stale RF feedback</span>
2547                             <span class="keyword">if</span> HQMOFMsp_last == HQMOFMsp_now
2548                                 HQMOFM_stalenum = HQMOFM_stalenum + 1;
2549                                 <span class="keyword">if</span> HQMOFM_stalenum == 30 <span class="comment">% warn and message to pager if stale for 30 secs</span>
2550                                     fprintf(<span class="string">'\n'</span>);
2551                                     fprintf(<span class="string">'***The RF is not responding to orbit feedback changes! \n'</span>);
2552                                     fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2553                                     fprintf(<span class="string">'***The orbit feedback is still working but this problem should be investigated. \n'</span>);
2554                                     fprintf(<span class="string">'***ILC 73 controls the EG______HQMOFM_AC01 channel, which sets the RF frequency. \n'</span>);
2555                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstaleRFmessage.txt
2556                                 <span class="keyword">end</span>
2557                                 <span class="keyword">if</span> rem(HQMOFM_stalenum,120)==0 <span class="comment">% message to screen every 2 minutes</span>
2558                                     fprintf(<span class="string">'\n'</span>);
2559                                     fprintf(<span class="string">'***The RF is not responding to orbit feedback changes! (%s)\n'</span>,datestr(now));
2560                                 <span class="keyword">end</span>
2561                             <span class="keyword">else</span>
2562                                 HQMOFM_stalenum = 0;
2563                             <span class="keyword">end</span>
2564 
2565                         <span class="keyword">end</span>
2566 
2567                         <span class="comment">%fprintf('RF Done: %f \n',gettime-t00);</span>
2568 
2569                         Xold = Xnew;
2570                     <span class="keyword">end</span> <span class="comment">% End horizontal correction</span>
2571 
2572 
2573                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2574                     <span class="comment">% Vertical plane &quot;feedback&quot; %</span>
2575                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2576 
2577                     <span class="comment">% Get orbit and check that the BPMs are different from the last update</span>
2578                     Ynew = gety(FB.OCSy.BPM.DeviceList);
2579 
2580                     <span class="comment">% Don't feedback if the current is too small</span>
2581                     <span class="keyword">if</span> getdcct &lt; 2
2582                         FEEDBACK_STOP_FLAG = 1;
2583                         fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2584                         <span class="keyword">break</span>;
2585                     <span class="keyword">end</span>
2586 
2587                     y = Ygoal - Ynew;
2588                     STDy = norm(y)/sqrt(length(y));
2589 
2590                     <span class="keyword">if</span> any(Yold == Ynew)
2591                         a = clock;
2592                         N_Stale_Data_Points = find((Yold==Ynew)==1);
2593                         <span class="keyword">for</span> loop = N_Stale_Data_Points'
2594                             fprintf(<span class="string">'   Stale data: BPMy(%2d,%d), feedback step skipped (%s %d:%d:%.0f). \n'</span>, FB.OCSy.BPM.DeviceList(loop,1), FB.OCSy.BPM.DeviceList(loop,2), date, a(4), a(5), a(6));
2595                         <span class="keyword">end</span>
2596 
2597                     <span class="keyword">else</span>
2598 
2599                         <span class="comment">% Compute vertical correction</span>
2600                         <span class="comment">%%%OCSy0 = FB.OCSy;</span>
2601                         FB.OCSy.BPM.Data = Ynew;
2602                         FB.OCSy = orbitcorrectionmethods(FB.OCSy, Smaty, Sy, Uy, Vy);
2603 
2604                         <span class="comment">%%%[FB.OCSy, RF, OCSy0] = setorbit(FB.OCSy,'Nodisplay','Nosetsp');</span>
2605 
2606                         <span class="comment">% reduced feedback gain, C. Steier, 2001-03-25</span>
2607                         <span class="comment">% reduced to 0.1, C. Steier, 2001-09-04, IDBPMs are noisy at the moment</span>
2608                         <span class="comment">% increased back to 0.8, C. Steier, 2001-09-29, IDBPMs filtering + direct DAC read/write + all SVDs (no arc BPMs)</span>
2609                         <span class="comment">% set to unity gain, C. Steier, 2002-05-04, trim DACs</span>
2610                         Y = Ygain .* FB.OCSy.CM.Delta;
2611                         <span class="comment">%%%Y = Ygain .* (FB.OCSy.CM.Data - OCSy0.CM.Data);</span>
2612 
2613                         <span class="comment">% Just SVD correction</span>
2614                         <span class="comment">% warning('Not using &quot;micado&quot; correction in the vertical plane.');</span>
2615 
2616                         <span class="comment">% check for trim values+next step values, warn or stop FB as necessary</span>
2617                         VCMtrimSP = getpv(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1);
2618                         VCMtrimSP_next = VCMtrimSP + Y(1:N_VCM);
2619                         <span class="keyword">if</span> max(abs(VCMtrimSP_next)) &gt; 12
2620                             VCMtrimnum=find(abs(VCMtrimSP_next) &gt; 12);
2621 
2622                             <span class="comment">% print message to screen</span>
2623                             fprintf(<span class="string">'\n'</span>);
2624                             fprintf(<span class="string">'***One or more of the vertical correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2625                             fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2626                             <span class="keyword">for</span> loop = VCMtrimnum'
2627                                 fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1(loop,:)));
2628                             <span class="keyword">end</span>
2629 
2630                             <span class="comment">% send alphapage to operator pager</span>
2631                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2632                             FEEDBACK_STOP_FLAG = 1;
2633 
2634                             setpv(<span class="string">'SR_STATE'</span>, -5);
2635                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2636                             <span class="keyword">if</span> StateNumber &gt;= 0
2637                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2638                             <span class="keyword">else</span>
2639                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2640                             <span class="keyword">end</span>
2641                         <span class="keyword">end</span>
2642 
2643                         <span class="comment">% check chicane trim coil values + next step values, warn or stop FB as necessary</span>
2644                         VCMCHICANEtrimSP=getpv(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>,VCMlist1(iVCMChicane,:));
2645                         VCMCHICANEtrimSP_next = VCMCHICANEtrimSP + Y(iVCMChicane);
2646                         <span class="keyword">if</span> max(abs(VCMCHICANEtrimSP_next)) &gt; 19.9
2647                             VCMCHICANEtrimnum=find(abs(VCMCHICANEtrimSP_next) &gt; 19.9);
2648 
2649                             <span class="comment">% print message to screen</span>
2650                             fprintf(<span class="string">'\n'</span>);
2651                             fprintf(<span class="string">'***One or more of the vertical chicane trim coil correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2652                             fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2653                             <span class="keyword">for</span> loop = VCMCHICANEtrimnum'
2654                                 fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>,VCMlist1(iVCMChicane(loop,:),:)));
2655                             <span class="keyword">end</span>
2656                             <span class="comment">%fprintf('***Maybe try resetting the setpoints of the motor chicanes in case they are drifting...\n');</span>
2657 
2658                             <span class="comment">% send alphapage to operator pager</span>
2659                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2660                             FEEDBACK_STOP_FLAG = 1;
2661 
2662                             setpv(<span class="string">'SR_STATE'</span>, -5);
2663                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2664                             <span class="keyword">if</span> StateNumber &gt;= 0
2665                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2666                             <span class="keyword">else</span>
2667                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2668                             <span class="keyword">end</span>
2669                         <span class="keyword">end</span>
2670 
2671                         <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2672                             <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2673                             <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2674                                 disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2675                             <span class="keyword">end</span>
2676                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2677                             pause(0.5);
2678                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2679                             <span class="keyword">break</span>;
2680                         <span class="keyword">end</span>
2681 
2682                         <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2683                         <span class="comment">% pause(0);</span>
2684 
2685                         <span class="keyword">if</span> max(abs(VCMtrimSP_next) &gt; 8) <span class="comment">% changed from 6A ~12/1/07 since orbit FB is going past 6A</span>
2686                             VCMtrimnum=find(abs(VCMtrimSP_next) &gt; 8);
2687                             VWarnNum=VWarnNum+1;
2688                             <span class="keyword">if</span> (VWarnNum==1 || rem(VWarnNum,120)==0)
2689 
2690                                 <span class="comment">% print message to screen every two minutes</span>
2691                                 fprintf(<span class="string">'\n'</span>);
2692                                 fprintf(<span class="string">'***One or more of the vertical corrector trims is above 8A or below -8A! \n'</span>);
2693                                 fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2694                                 <span class="keyword">for</span> loop = VCMtrimnum'
2695                                     fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1(loop,:)));
2696                                 <span class="keyword">end</span>
2697                                 fprintf(<span class="string">'***The orbit feedback is still working but this problem should be investigated. \n'</span>);
2698 
2699                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2700                                 <span class="keyword">if</span> (VWarnNum==1 || VWarnNum==600)
2701                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageVCM.txt
2702                                 <span class="keyword">end</span>
2703                             <span class="keyword">end</span>
2704                         <span class="keyword">elseif</span> max(abs(VCMCHICANEtrimSP_next) &gt; 15)
2705                             VCMCHICANEtrimnum=find(abs(VCMCHICANEtrimSP_next) &gt; 15);
2706                             VWarnNum=VWarnNum+1;
2707                             <span class="keyword">if</span> (VWarnNum==1 || rem(VWarnNum,120)==0)
2708 
2709                                 <span class="comment">% print message to screen every two minutes</span>
2710                                 fprintf(<span class="string">'\n'</span>);
2711                                 fprintf(<span class="string">'***One or more of the vertical chicane corrector trim coils is above 15A or below -15A! \n'</span>);
2712                                 fprintf(<span class="string">'   %s\n'</span>,datestr(now));
2713                                 <span class="keyword">for</span> loop = VCMCHICANEtrimnum'
2714                                     fprintf(<span class="string">'***%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>,VCMlist1(iVCMChicane(loop,:),:)));
2715                                 <span class="keyword">end</span>
2716                                 fprintf(<span class="string">'***The orbit feedback is still working but this problem should be investigated. \n'</span>);
2717 
2718 <span class="comment">% All motor chicanes have harmonic drives now, so slipping should be impossible - 6-4-08 - T.Scarvie</span>
2719 <span class="comment">%                                 %reset motor chicanes in case they are drifting</span>
2720 <span class="comment">%                                 try</span>
2721 <span class="comment">%                                         fprintf('  Resetting the setpoints of the motor chicanes in case they are drifting...\n');</span>
2722 <span class="comment">%                                         setpv('HCMCHICANEM','Setpoint',ConfigSetpoint.HCMCHICANEM.Setpoint.Data,[],0);</span>
2723 <span class="comment">%                                 catch</span>
2724 <span class="comment">%                                       fprintf('   %s \n',lasterr);</span>
2725 <span class="comment">%                                 end</span>
2726 
2727                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2728                                 <span class="keyword">if</span> (VWarnNum==1 || VWarnNum==600)
2729                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageVCMCHICANE.txt
2730                                 <span class="keyword">end</span>
2731                             <span class="keyword">end</span>
2732                         <span class="keyword">else</span>
2733                             VWarnNum=0;
2734                         <span class="keyword">end</span>
2735 
2736                         <span class="comment">% Don't feedback if the current is too small</span>
2737                         <span class="keyword">if</span> getdcct &lt; 2
2738                             FEEDBACK_STOP_FLAG = 1;
2739                             fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2740                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/beamisoff.txt
2741                             <span class="keyword">break</span>;
2742                         <span class="keyword">end</span>
2743 
2744                         <span class="keyword">if</span> N_VCM &gt; 0
2745                             steppv(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>, Y(iNotVCMChicane), VCMlist1(iNotVCMChicane,:), 0);
2746                             steppv(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>, Y(iVCMChicane), VCMlist1(iVCMChicane,:), 0);
2747                         <span class="keyword">end</span>
2748 
2749                         <span class="comment">% write fast orbit feedback setpoints</span>
2750                         <span class="keyword">if</span> 1
2751                             <a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>(2,Ynew(1:size(BPMlist1,1))+Sy1*Y(1:N_VCM),BPMlist1);
2752                         <span class="keyword">end</span>
2753 
2754                     <span class="keyword">end</span>
2755 
2756                     Yold = Ynew;
2757 
2758                     <span class="comment">%fprintf('Vertical Done: %f \n',gettime-t00);</span>
2759                 <span class="keyword">end</span> <span class="comment">% End vertical correction</span>
2760 
2761 
2762                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
2763                 <span class="comment">% Tune feed forward %</span>
2764                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
2765                 <span class="comment">% We should do a Sector limit check</span>
2766 
2767                 tic;
2768                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxTune'</span>),<span class="string">'Value'</span>) == 1
2769 
2770                     <span class="keyword">if</span> strcmp(SR_Mode, <span class="string">'1.9 GeV, High Tune'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Inject at 1.23'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Inject at 1.353'</span>) ||<span class="keyword">...</span>
2771                         strcmp(SR_Mode, <span class="string">'1.9 GeV, Two-Bunch'</span>)  || strcmp(SR_Mode, <span class="string">'1.5 GeV, Inject at 1.353'</span>)  || strcmp(SR_Mode, <span class="string">'1.9 GeV, TopOff'</span>)
2772 
2773                         addQFsp = zeros(24,1);
2774                         addQDsp = zeros(24,1);
2775 
2776                         <span class="keyword">if</span> strcmp(FFTypeFlag,<span class="string">'Local'</span>)
2777                             disp(<span class="string">'  No local tune compensation available - global is the default now.'</span>);
2778                         <span class="keyword">elseif</span> strcmp(FFTypeFlag,<span class="string">'Global'</span>)
2779 
2780                             <span class="comment">% The vectorized gets were put outside of loop for speed reasons</span>
2781                             <span class="comment">%</span>
2782                             <span class="comment">% should also set up QFfac, Quadelem, Quadlist structures outside loop</span>
2783                             actualgap = <a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>(IDSector);
2784                             [gapmin,gapmax] = <a href="gaplimit.html" class="code" title="function [GAPmin, GAPmax] = gaplimit(DeviceList)">gaplimit</a>(IDSector);
2785                             corrind = find(actualgap&lt;(gapmin-1));
2786                             actualgap(corrind)=gapmax(corrind);
2787                             Shift=zeros(size(actualgap));
2788                             Shift(EPUlist)=getpv(<span class="string">'EPU'</span>);
2789 
2790                             IDchangedList=find((abs(actualgap-oldgap)&gt;0.005) | (abs(Shift-oldShift)&gt;0.005));
2791 
2792                             <span class="keyword">if</span> ~isempty(IDchangedList)
2793 
2794                                 oldgap=actualgap;
2795                                 oldShift=Shift;
2796 
2797                                 <span class="comment">% EPUs excite nux = .25 resonance in vertical linear polarization mode!</span>
2798                                 <span class="comment">% therefore with EPU tune feedforward</span>
2799                                 <span class="comment">% running, we want to move our nominal working point away (just below) the .25 resonance.</span>
2800                                 <span class="comment">%</span>
2801                                 <span class="comment">% The following tune correction moves nominal</span>
2802                                 <span class="comment">% nu_x from .25 to .245 - this should be enough for well set up lattices.</span>
2803                                 <span class="comment">%</span>
2804                                 <span class="comment">% 24 QF+ 24 QD</span>
2805                                 DeltaAmps = inv(SR_TUNE_MATRIX) * [-0.005;0];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2806                                 addQFsp = addQFsp + DeltaAmps(1,:);
2807                                 addQDsp = addQDsp + DeltaAmps(2,:);
2808 
2809                                 <span class="keyword">for</span> gapnum = 1:length(actualgap)
2810 
2811                                     <span class="comment">% Change in tune and [QF;QD] from maximum gap</span>
2812 
2813                                     <span class="keyword">if</span> (IDSector(gapnum,1) == 4) || (IDSector(gapnum,1) == 11)
2814                                         <span class="keyword">if</span> IDSector(gapnum,2) == 1
2815                                             modenamestr = sprintf(<span class="string">'SR%02dU___ODS1M__DC00'</span>,IDSector(gapnum,1));
2816                                         <span class="keyword">else</span> <span class="comment">% if IDSector(gapnum,2) == 2</span>
2817                                             modenamestr = sprintf(<span class="string">'SR%02dU___ODS2M__DC00'</span>,IDSector(gapnum,1));
2818                                         <span class="keyword">end</span>
2819                                         epumode = getpv(modenamestr);
2820                                         <span class="keyword">if</span> (IDSector(gapnum,1) == 4) &amp;&amp; (IDSector(gapnum,2) == 1) 
2821                                             <span class="keyword">if</span> 1   <span class="comment">% temporary fix as long as we do not have good tune FF table without shims (2008-02-15)</span>
2822                                                 <span class="keyword">if</span> (epumode==0)
2823                                                     DeltaNuX = <a href="shift2tune.html" class="code" title="function [Dnux, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = shift2tune(Sector, Gap, EPUshift, GeV)">shift2tune</a>(IDSector(gapnum,:),actualgap(gapnum),Shift(gapnum));
2824                                                     DeltaNuY = 0;
2825                                                 <span class="keyword">else</span>
2826                                                     DeltaNuX = 0;
2827                                                     DeltaNuY = 0;
2828                                                 <span class="keyword">end</span>
2829                                             <span class="keyword">elseif</span> (epumode == 0)
2830 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_41,shift_epu_41,dnux_epu_41_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2831 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_41,shift_epu_41,dnuy_epu_41_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2832                                                 DeltaNuX = interp2(gap41p',shift41p',dnux41p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2833                                                 DeltaNuY = interp2(gap41p',shift41p',dnuy41p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2834                                             <span class="keyword">elseif</span> (epumode == 1)
2835 <span class="comment">%                                                 DeltaNux = 0;</span>
2836 <span class="comment">%                                                 DeltaNuY = gap2tune(IDSector(gapnum, :), actualgap(gapnum), SR_GeV);</span>
2837                                                 DeltaNuX = interp2(gap41a',shift41a',dnux41a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2838                                                 DeltaNuY = interp2(gap41a',shift41a',dnuy41a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2839                                             <span class="keyword">else</span>
2840                                                 DeltaNux = 0;
2841                                                 DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum, :), actualgap(gapnum), SR_GeV);  
2842                                             <span class="keyword">end</span>
2843                                         <span class="keyword">elseif</span> (IDSector(gapnum,1) == 11) &amp;&amp; (IDSector(gapnum,2) == 1) 
2844                                             <span class="keyword">if</span> (epumode == 0)
2845 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_111,shift_epu_111,dnux_epu_111_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2846 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_111,shift_epu_111,dnuy_epu_111_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2847                                                 DeltaNuX = interp2(gap111p',shift111p',dnux111p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2848                                                 DeltaNuY = interp2(gap111p',shift111p',dnuy111p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2849                                             <span class="keyword">elseif</span> (epumode == 1)
2850 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_111,shift_epu_111,dnux_epu_111_m1',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2851 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_111,shift_epu_111,dnuy_epu_111_m1',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2852                                                 DeltaNuX = interp2(gap111a',shift111a',dnux111a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2853                                                 DeltaNuY = interp2(gap111a',shift111a',dnuy111a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2854                                             <span class="keyword">else</span>
2855                                                 DeltaNuX = 0;
2856                                                 DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);   <span class="comment">% variation of vertical tune shift with phase is small for EPUs</span>
2857                                             <span class="keyword">end</span>
2858                                         <span class="keyword">elseif</span> (IDSector(gapnum,1) == 11) &amp;&amp; (IDSector(gapnum,2) == 2) 
2859                                             <span class="keyword">if</span> (epumode == 0)
2860 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_111,shift_epu_111,dnux_epu_111_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2861 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_111,shift_epu_111,dnuy_epu_111_m0',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2862                                                 DeltaNuX = interp2(gap112p',shift112p',dnux112p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2863                                                 DeltaNuY = interp2(gap112p',shift112p',dnuy112p',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2864                                             <span class="keyword">elseif</span> (epumode == 1)
2865 <span class="comment">%                                                 DeltaNuX = interp2(gap_epu_111,shift_epu_111,dnux_epu_111_m1',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2866 <span class="comment">%                                                 DeltaNuY = interp2(gap_epu_111,shift_epu_111,dnuy_epu_111_m1',actualgap(gapnum),Shift(gapnum),'linear',0);</span>
2867                                                 DeltaNuX = interp2(gap112a',shift112a',dnux112a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2868                                                 DeltaNuY = interp2(gap112a',shift112a',dnuy112a',actualgap(gapnum),Shift(gapnum),<span class="string">'linear'</span>,0);
2869                                             <span class="keyword">else</span>
2870                                                 DeltaNuX = 0;
2871                                                 DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);   <span class="comment">% variation of vertical tune shift with phase is small for EPUs</span>
2872                                             <span class="keyword">end</span>
2873                                         <span class="keyword">else</span>
2874                                             DeltaNuX = 0;
2875                                             DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);   
2876                                         <span class="keyword">end</span>
2877 
2878                                     <span class="keyword">else</span>
2879                                         DeltaNuX = 0;
2880                                         DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);
2881                                     <span class="keyword">end</span>
2882 
2883                                     DelQF = zeros(length(QFsp),1);
2884                                     DelQD = zeros(length(QFsp),1);
2885 
2886                                     fraccorr = 0.8*DeltaNuY ./ TuneW16Min;
2887 
2888                                     <span class="comment">% Find which quads to change (local beta beating correction</span>
2889                                     <span class="comment">% (horizontal for EPU, vertical otherwise)</span>
2890                                     QuadList = [IDSector(gapnum,1)-1 2; IDSector(gapnum,1) 1];
2891                                     QuadElem = dev2elem(<span class="string">'QF'</span>,QuadList); <span class="comment">% in reality use QF and QD ...</span>
2892 
2893                                     <span class="comment">% global vertical tune correction</span>
2894                                     <span class="comment">% 24 QF+ 24 QD</span>
2895                                     DeltaAmps = inv(SR_TUNE_MATRIX) * [(fraccorr*6.23e-4); fraccorr*(-0.05301)];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2896                                     DelQF = DelQF + DeltaAmps(1,:);
2897                                     DelQD = DelQD + DeltaAmps(2,:);
2898 
2899                                     <span class="comment">% local horizontal tune correction (is also nearly a beta beating correction) only nonzero for EPUs!</span>
2900                                     <span class="comment">% 2 QF + 2 QD</span>
2901                                     DeltaAmpsLocal = 12*inv(SR_TUNE_MATRIX) * [-DeltaNuX;0];                       <span class="comment">%  DelAmps =  [QF; QD];</span>
2902                                     DelQF(QuadElem) = DelQF(QuadElem)+DeltaAmpsLocal(1,1);
2903                                     DelQD(QuadElem) = DelQD(QuadElem)+DeltaAmpsLocal(2,1);
2904 
2905                                     <span class="comment">% local vertical beta beating correction (should be used together with above global tune correction)</span>
2906                                     <span class="comment">% set to zero for EPUs, since their vertical tune shift is small</span>
2907                                     <span class="comment">% 2 QF + 2QD</span>
2908                                     <span class="keyword">if</span> (IDSector(gapnum,1)==6) || (IDSector(gapnum,1)==7) || (IDSector(gapnum,1)==10) || (IDSector(gapnum,1)==11)
2909                                         QFfac = ([2.243127/2.237111; 2.243127/2.237111]-1) * fraccorr;
2910                                         QDfac = ([2.556392/2.511045; 2.556392/2.511045]-1) * fraccorr;
2911                                     <span class="keyword">elseif</span> (IDSector(gapnum,1)==5) || (IDSector(gapnum,1)==9)
2912                                         QFfac = ([2.225965/2.219784; 2.243096/2.237111]-1) * fraccorr;
2913                                         QDfac = ([2.528950/2.483259; 2.556345/2.511045]-1) * fraccorr;
2914                                     <span class="keyword">elseif</span> (IDSector(gapnum,1)==4) || (IDSector(gapnum,1)==8) || (IDSector(gapnum,1)==12)
2915                                         QFfac = ([2.243096/2.237111; 2.225965/2.219784]-1) * fraccorr;
2916                                         QDfac = ([2.556345/2.511045; 2.528950/2.483259]-1) * fraccorr;
2917                                     <span class="keyword">else</span>
2918                                         QFfac = zeros(2,1);
2919                                         QDfac = zeros(2,1);
2920                                     <span class="keyword">end</span>
2921 
2922                                     DelQF(QuadElem,:) = DelQF(QuadElem,:) + QFfac.*QFsp(QuadElem,:);
2923                                     DelQD(QuadElem,:) = DelQD(QuadElem,:) + QDfac.*QDsp(QuadElem,:);
2924 
2925                                     <span class="comment">% add all tune and beta beating corrections for this one ID to the summed up correction vectors for all IDs</span>
2926                                     addQFsp = addQFsp+DelQF;
2927                                     addQDsp = addQDsp+DelQD;
2928                                     
2929                                     
2930                                     <span class="comment">% Skew FF for IVID</span>
2931                                     <span class="keyword">if</span> (IDSector(gapnum,1)==6)
2932                                         scale=(<a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>([6 1])/0.005)^(3/4)*0.16;
2933                                         [SQSFincr, SQSDincr] = <a href="set_etaywave_nuy9_20skews_skewFF.html" class="code" title="function [SQSFincr, SQSDincr] = set_etaywave_nuy9_20skews_skewFF(scale);">set_etaywave_nuy9_20skews_skewFF</a>(scale);
2934                                         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2935                                         <span class="comment">% should add a limit check here %</span>
2936                                         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2937                                         setpv(<span class="string">'SQSF'</span>, <span class="string">'Setpoint'</span>, SQSFsp+SQSFincr, [], 0, <span class="string">'Physics'</span>);
2938                                         setpv(<span class="string">'SQSD'</span>, <span class="string">'Setpoint'</span>, SQSDsp+SQSDincr, [], 0, <span class="string">'Physics'</span>);
2939                                     <span class="keyword">end</span>
2940 
2941                                 <span class="keyword">end</span>
2942 
2943                                 <span class="comment">% Set quadrupoles using main setpoint channels</span>
2944                                 setpv(<span class="string">'QF'</span>, QFsp+addQFsp,[], 0);
2945                                 setpv(<span class="string">'QD'</span>, QDsp+addQDsp,[], 0);
2946                                 <span class="comment">% % Set quadrupoles using FF setpoint channels</span>
2947                                 <span class="comment">% setpv('QF', 'FF', addQFsp, [], 0);</span>
2948                                 <span class="comment">% setpv('QD', 'FF', addQDsp, [], 0);</span>
2949                                 
2950                             <span class="keyword">end</span>
2951 
2952                         <span class="keyword">else</span>
2953                             error(<span class="string">'Unknown type selected for tune FF'</span>);
2954                         <span class="keyword">end</span>
2955 
2956                     <span class="keyword">else</span>
2957                         disp(<span class="string">'  No tune FF algorithm for non-production modes yet...'</span>);
2958                     <span class="keyword">end</span>
2959                 <span class="keyword">end</span>
2960 
2961                 ffdeltaquad_delay = toc;
2962                 <span class="comment">%fprintf('tune FF delay = %.1f seconds\n',ffdeltaquad_delay);</span>
2963                 <span class="comment">% fprintf('Tune Done: %f \n',gettime-t00);</span>
2964 
2965                 <span class="comment">% Output info to screen</span>
2966                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = %.4f mm'</span>,STDx),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2967                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = %.4f mm'</span>,STDy),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2968                 <span class="comment">%pause(0);</span>
2969 
2970                 FOFBStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2971                     getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2972                     getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2973                     getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2974                 <span class="keyword">for</span> loop = 1:size(FOFBStatus,2)
2975                     <span class="keyword">if</span> FOFBStatus(loop)==0
2976                         FOFBStatusStr(loop,:) = <span class="string">'OFF '</span>;
2977                     <span class="keyword">elseif</span> FOFBStatus(loop)==1
2978                         FOFBStatusStr(loop,:) = <span class="string">'ON  '</span>;
2979                     <span class="keyword">elseif</span> FOFBStatus(loop)==2
2980                         FOFBStatusStr(loop,:) = <span class="string">'OPEN'</span>;
2981                     <span class="keyword">else</span>
2982                         FOFBStatusStr(loop,:) = <span class="string">'BAD '</span>;
2983                     <span class="keyword">end</span>
2984                 <span class="keyword">end</span>
2985                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 %s'</span>,FOFBStatusStr(1,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2986                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 %s'</span>,FOFBStatusStr(2,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2987                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 %s'</span>,FOFBStatusStr(3,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2988                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 %s'</span>,FOFBStatusStr(4,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2989                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 %s'</span>,FOFBStatusStr(5,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2990                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 %s'</span>,FOFBStatusStr(6,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2991                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 %s'</span>,FOFBStatusStr(7,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2992                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 %s'</span>,FOFBStatusStr(8,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2993                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 %s'</span>,FOFBStatusStr(9,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2994                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 %s'</span>,FOFBStatusStr(10,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2995                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 %s'</span>,FOFBStatusStr(11,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2996                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 %s'</span>,FOFBStatusStr(12,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2997 
2998 
2999                 <span class="comment">%fprintf('End of feedback operations: %f \n\n',gettime-t00);</span>
3000 
3001                 <span class="comment">% Wait for next update time or stop request</span>
3002                 <span class="keyword">while</span> (gettime-t00) &lt; LoopDelay
3003                     <span class="comment">%disp('interval could be shorter')</span>
3004                     pause(.05);
3005                     <span class="comment">% Check if GUI has been closed</span>
3006                     <span class="keyword">if</span> isempty(gcbf)
3007                         FEEDBACK_STOP_FLAG = 1;
3008                         lasterr(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
3009                         error(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
3010                     <span class="keyword">end</span>
3011 
3012                     <span class="comment">% Check if Stop button was pressed</span>
3013                     <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
3014                         <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
3015                         <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
3016                             disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
3017                         <span class="keyword">end</span>
3018                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
3019                         pause(0.5);
3020                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
3021                         <span class="keyword">break</span>;
3022                     <span class="keyword">end</span>
3023                 <span class="keyword">end</span>
3024 
3025 
3026                 <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
3027                     <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
3028                     <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
3029                         disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
3030                     <span class="keyword">end</span>
3031                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
3032                     pause(0.5);
3033                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
3034                     <span class="keyword">break</span>;
3035                 <span class="keyword">end</span>
3036 
3037                 StartErrorTime = gettime;
3038 
3039             <span class="keyword">catch</span>
3040 
3041                 fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
3042 
3043                 <span class="comment">% Quit if error exists for more than 20 seconds</span>
3044                 <span class="keyword">if</span> gettime-StartErrorTime&gt;20 || FEEDBACK_STOP_FLAG==1
3045                     fprintf(<span class="string">'%s  Orbit feedback stopped due to error condition. \n\n'</span>,datestr(now));
3046 
3047                     <span class="comment">%send alphapage to operator pager</span>
3048                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
3049                     FEEDBACK_STOP_FLAG = 1;
3050 
3051                     setpv(<span class="string">'SR_STATE'</span>, -5);
3052                     [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
3053                     <span class="keyword">if</span> StateNumber &gt;= 0
3054                         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
3055                     <span class="keyword">else</span>
3056                         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
3057                     <span class="keyword">end</span>
3058                 <span class="keyword">else</span>
3059                     a = clock;
3060                     fprintf(<span class="string">'   Orbit feedback was paused due to error condition (%s %d:%d:%.0f). \n'</span>, date, a(4), a(5), a(6));
3061                     fprintf(<span class="string">'   Orbit feedback has automatically restarted and is running. \n\n'</span>);
3062                 <span class="keyword">end</span>
3063 
3064             <span class="keyword">end</span>
3065 
3066             <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
3067                 <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
3068                 <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
3069                     disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
3070                 <span class="keyword">end</span>
3071                 setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
3072                 pause(0.5);
3073                 setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
3074                 <span class="keyword">break</span>;
3075             <span class="keyword">end</span>
3076 
3077             <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
3078 
3079             <span class="comment">%pause(0);</span>
3080 
3081             <span class="comment">% this loop delays turn on of Fast Feedback system</span>
3082             <span class="keyword">if</span> FBloopIter &lt; 5
3083                 FBloopIter = FBloopIter + 1;
3084             <span class="keyword">end</span>
3085 
3086         <span class="keyword">end</span>  <span class="comment">% End of feedback loop</span>
3087 
3088 
3089         <span class="comment">% End feedback, reset all parameters</span>
3090         <span class="keyword">try</span>
3091 
3092             <span class="comment">% Enable buttons</span>
3093             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3094             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
3095             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3096             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3097             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3098             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3099             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3100             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3101             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3102             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3103             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3104             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3105             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
3106 
3107             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = _____ mm'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3108             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = _____ mm'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3109 
3110             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3111             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3112             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3113             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3114             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3115             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3116             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3117             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3118             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3119             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3120             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3121             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
3122 
3123             <span class="comment">%pause(0);</span>
3124 
3125         <span class="keyword">catch</span>
3126             fprintf(<span class="string">'   %s \n'</span>,lasterr);
3127             <span class="comment">% GUI must have been closed</span>
3128 
3129         <span class="keyword">end</span>
3130 
3131 
3132         <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
3133         fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
3134         <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
3135 
3136 
3137         a = clock;
3138         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
3139         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
3140         <span class="keyword">if</span> StateNumber &gt;= 0
3141             setpv(<span class="string">'SR_STATE'</span>,5.1);
3142             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
3143             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
3144             fprintf(<span class="string">'   ******************************\n'</span>);
3145             fprintf(<span class="string">'   **  Orbit Feedback Stopped  **\n'</span>);
3146             fprintf(<span class="string">'   ******************************\n\n'</span>);
3147         <span class="keyword">else</span>
3148             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
3149             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
3150             fprintf(<span class="string">'   ****************************************\n'</span>);
3151             fprintf(<span class="string">'   **  Problem With Slow Orbit Feedback  **\n'</span>);
3152             fprintf(<span class="string">'   ****************************************\n\n'</span>);
3153         <span class="keyword">end</span>
3154         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
3155         pause(0);
3156 
3157 
3158     <span class="keyword">case</span> <span class="string">'FeedbackSetup'</span>
3159         InitFlag = Input2;           <span class="comment">% Input #2: if InitFlag, then initialize variables</span>
3160 
3161         <span class="keyword">if</span> InitFlag
3162             
3163            
3164             <span class="comment">% Get the device lists from oscsinit and convert to srcontrol variables</span>
3165             [HBPM, VBPM, HCM, VCM, HSV, VSV] = <a href="ocsinit.html" class="code" title="function [HBPM, VBPM, HCM, VCM, HSV, VSV] = ocsinit(MethodName)">ocsinit</a>(<span class="string">'SOFB'</span>);
3166             Xivec = 1:HSV;
3167             Yivec = 1:VSV;
3168             BPMlist1 = HBPM.DeviceList;
3169             HCMlist1 = HCM.DeviceList;
3170             VCMlist1 = VCM.DeviceList;           
3171             
3172             
3173             OCSx.BPM = getx(BPMlist1, <span class="string">'struct'</span>);
3174             OCSx.CM = getsp(<span class="string">'HCM'</span>, HCMlist1, <span class="string">'struct'</span>);
3175             OCSx.GoalOrbit = getgolden(OCSx.BPM, <span class="string">'numeric'</span>);
3176             OCSx.NIter = 1;
3177             OCSx.SVDIndex = Xivec;
3178             OCSx.IncrementalFlag = <span class="string">'No'</span>;
3179             OCSx.BPMWeight = {[]};
3180             OCSx.FitRF = 0;
3181             OCSy.BPM = gety(BPMlist1, <span class="string">'struct'</span>);
3182             OCSy.CM = getsp(<span class="string">'VCM'</span>, VCMlist1, <span class="string">'struct'</span>);
3183             OCSy.GoalOrbit = getgolden(OCSy.BPM, <span class="string">'numeric'</span>);
3184             OCSy.NIter = 1;
3185             OCSy.SVDIndex = Yivec;
3186             OCSy.IncrementalFlag = <span class="string">'No'</span>;
3187             OCSy.BPMWeight = {[]};
3188             OCSy.FitRF = 0;
3189             
3190             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
3191             <span class="comment">% do we need these Smat calls? %</span>
3192             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
3193             SXmat = getrespmat(OCSx.BPM, OCSx.CM, <span class="string">'numeric'</span>);
3194             SYmat = getrespmat(OCSy.BPM, OCSy.CM, <span class="string">'numeric'</span>);
3195             <span class="comment">% [OCSx, Sx, Ux, Vx] = orbitcorrectionmethods(OCSx, SXmat);</span>
3196             <span class="comment">% [OCSy, Sy, Uy, Vy] = orbitcorrectionmethods(OCSy, SYmat);</span>
3197 
3198             <span class="comment">% initialize FFTypeFlag</span>
3199             FFTypeFlag = <span class="string">'Global'</span>;
3200 
3201             <span class="comment">% Fit decision comes from check box</span>
3202             <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
3203                 OCSx.FitRF = 1;
3204                 Xivec = 1:HSV+1;
3205             <span class="keyword">end</span>
3206         
3207         <span class="keyword">else</span>
3208 
3209             <span class="comment">% Get vectors</span>
3210             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
3211             <span class="comment">% the two lines below seem to fix BPMlist editing problem</span>
3212             OCSx = FB.OCSx;
3213             OCSy = FB.OCSy;
3214             BPMlist1 = FB.BPMlist1;
3215             HCMlist1 = FB.HCMlist1;
3216             VCMlist1 = FB.VCMlist1;
3217             Xivec = FB.Xivec;
3218             Yivec = FB.Yivec;
3219             Xgoal = FB.OCSx.GoalOrbit;
3220             OCSx.GoalOrbit = Xgoal;
3221             Ygoal = FB.OCSy.GoalOrbit;
3222             OCSy.GoalOrbit = Ygoal;
3223             FFTypeFlag = FB.FFTypeFlag;
3224 
3225 
3226             <span class="comment">% FF corrector magnet list - only channels which are blocked when FF is running should be</span>
3227             <span class="comment">% listed</span>
3228             ListFF = [
3229                 4     2
3230                 4     8
3231                 5     1
3232                 5     7
3233 <span class="comment">%               5     8 % IVID is using digital FF, i.e. FF algorithm does not block</span>
3234 <span class="comment">%               6     1 % other access to PVs</span>
3235                 6     8
3236                 7     1
3237                 7     8
3238                 8     1
3239                 8     8
3240                 9     1
3241                 9     8
3242                 10    1
3243                 11    8
3244                 12    1];
3245             ElemFF = dev2elem(<span class="string">'HCM'</span>,ListFF);
3246 
3247 
3248             <span class="comment">% Add button to change #ivectors, cm, IDBPMs,</span>
3249             EditFlag = 0;
3250             h_fig1 = figure;
3251             <span class="keyword">while</span> EditFlag ~= 6
3252 
3253                 Sx = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
3254                 Sy = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
3255                 
3256                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
3257                     DispOrbit = getdisp(<span class="string">'BPMx'</span>, BPMlist1);
3258                     Sx = [Sx DispOrbit];
3259                 <span class="keyword">end</span>
3260                 
3261                 Sx(isnan(Sx)) = 0;
3262                 Sy(isnan(Sy)) = 0;
3263                 
3264                 [Ux, SVx, Vx] = svd(Sx);
3265                 [Uy, SVy, Vy] = svd(Sy);
3266 
3267                 
3268                 <span class="comment">% Remove singular values greater than the actual number of singular values</span>
3269                 i = find(Xivec&gt;length(diag(SVx)));
3270                 <span class="keyword">if</span> ~isempty(i)
3271                     disp(<span class="string">'   Horizontal E-vector scaled since there were more elements in the vector than singular values.'</span>);
3272                     pause(0);
3273                     Xivec(i) = [];
3274                 <span class="keyword">end</span>
3275                 i = find(Yivec&gt;length(diag(SVy)));
3276                 <span class="keyword">if</span> ~isempty(i)
3277                     disp(<span class="string">'   Vertical E-vector scaled since there were more elements in the vector than singular values.'</span>);
3278                     pause(0);
3279                     Yivec(i) = [];
3280                 <span class="keyword">end</span>
3281 
3282 
3283                 Ax = Sx*Vx(:,Xivec);
3284                 Tx = inv(Ax'*Ax)*Ax';
3285 
3286                 Ay = Sy*Vy(:,Yivec);
3287                 Ty = inv(Ay'*Ay)*Ay';
3288 
3289                 figure(h_fig1);
3290                 subplot(2,1,1);
3291                 semilogy(diag(SVx),<span class="string">'b'</span>);
3292                 hold on;
3293                 semilogy(diag(SVx(Xivec,Xivec)),<span class="string">'xr'</span>);
3294                 ylabel(<span class="string">'Horizontal'</span>);
3295                 title(<span class="string">'Response Matrix Singular Values'</span>);
3296                 hold off;
3297                 subplot(2,1,2);
3298                 semilogy(diag(SVy),<span class="string">'b'</span>);
3299                 hold on;
3300                 semilogy(diag(SVy(Yivec,Yivec)),<span class="string">'xr'</span>);
3301                 xlabel(<span class="string">'Singular Value Number'</span>);
3302                 ylabel(<span class="string">'Vertical'</span>);
3303                 hold off;
3304                 drawnow;
3305 
3306                 EditFlag = menu(<span class="string">'Change Parameters?'</span>,<span class="string">'Singular Values'</span>,<span class="string">'HCM List'</span>,<span class="string">'VCM List'</span>, <span class="keyword">...</span>
3307                     <span class="string">'BPM List'</span>,<span class="string">'Change the Goal Orbit'</span>,<span class="string">'Continue'</span>);
3308 
3309                 <span class="keyword">if</span> EditFlag == 1
3310                     prompt={<span class="string">'Enter the horizontal E-vector numbers (Matlab vector format):'</span>,<span class="string">'Enter the vertical E-vector numbers (Matlab vector format):'</span>};
3311                     def={sprintf(<span class="string">'[%d:%d]'</span>,1,Xivec(end)),sprintf(<span class="string">'[%d:%d]'</span>,1,Yivec(end))};
3312                     titlestr=<span class="string">'SVD Orbit Feedback'</span>;
3313                     lineNo=1;
3314                     answer=inputdlg(prompt,titlestr,lineNo,def);
3315                     <span class="keyword">if</span> ~isempty(answer)
3316                         XivecNew = fix(str2num(answer{1}));
3317                         <span class="keyword">if</span> isempty(XivecNew)
3318                             disp(<span class="string">'   Horizontal E-vector cannot be empty.  No change made.'</span>);
3319                         <span class="keyword">else</span>
3320                             <span class="keyword">if</span> any(XivecNew&lt;=0) || max(XivecNew)&gt;length(diag(SVx))
3321                                 disp(<span class="string">'   Error reading horizontal E-vector.  No change made.'</span>);
3322                             <span class="keyword">else</span>
3323                                 Xivec = XivecNew;
3324                             <span class="keyword">end</span>
3325                         <span class="keyword">end</span>
3326                         YivecNew = fix(str2num(answer{2}));
3327                         <span class="keyword">if</span> isempty(YivecNew)
3328                             disp(<span class="string">'   Vertical E-vector cannot be empty.  No change made.'</span>);
3329                         <span class="keyword">else</span>
3330                             <span class="keyword">if</span> any(YivecNew&lt;=0) || max(YivecNew)&gt;length(diag(SVy))
3331                                 disp(<span class="string">'   Error reading vertical E-vector.  No change made.'</span>);
3332                             <span class="keyword">else</span>
3333                                 Yivec = YivecNew;
3334                             <span class="keyword">end</span>
3335                         <span class="keyword">end</span>
3336                     <span class="keyword">end</span>
3337                 <span class="keyword">end</span>
3338 
3339                 <span class="keyword">if</span> EditFlag == 2
3340                     List= getlist(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>);
3341                     CheckList = zeros(96,1);
3342                     Elem = dev2elem(<span class="string">'HCM'</span>, HCMlist1);
3343                     CheckList(Elem) = ones(size(Elem));
3344                     CheckList = CheckList(dev2elem(<span class="string">'HCM'</span>,List));
3345 
3346                     <span class="comment">% Remove FF corrrectors</span>
3347                     <span class="comment">%           Elem = dev2elem('HCM',List);</span>
3348                     <span class="comment">%           for j = length(ElemFF):-1:1</span>
3349                     <span class="comment">%              i = find(Elem==ElemFF(j));</span>
3350                     <span class="comment">%              Elem(i,:) = [];</span>
3351                     <span class="comment">%              List(i,:) = [];</span>
3352                     <span class="comment">%              CheckList(i,:) = [];</span>
3353                     <span class="comment">%           end</span>
3354 
3355                     newList = editlist(List, <span class="string">'HCMtrim'</span>, CheckList);
3356 
3357                     <span class="keyword">if</span> isempty(newList)
3358                         fprintf(<span class="string">'   WARNING: Horizontal corrector magnet list is empty!\n'</span>);
3359                         HCMlist1 = newList;
3360                     <span class="keyword">else</span>
3361                         HCMlist1 = newList;
3362                     <span class="keyword">end</span>
3363                     OCSx.CM.DeviceList = HCMlist1;
3364                 <span class="keyword">end</span>
3365 
3366                 <span class="keyword">if</span> EditFlag == 3
3367                     List = getlist(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>);
3368                     CheckList = zeros(96,1);
3369                     Elem = dev2elem(<span class="string">'VCM'</span>, VCMlist1);
3370                     CheckList(Elem) = ones(size(Elem));
3371                     CheckList = CheckList(dev2elem(<span class="string">'VCM'</span>,List));
3372 
3373                     <span class="comment">% Remove FF corrrectors</span>
3374                     <span class="comment">%           Elem = dev2elem('VCM',List);</span>
3375                     <span class="comment">%           for j = length(ElemFF):-1:1</span>
3376                     <span class="comment">%              i = find(Elem==ElemFF(j));</span>
3377                     <span class="comment">%              Elem(i,:) = [];</span>
3378                     <span class="comment">%              List(i,:) = [];</span>
3379                     <span class="comment">%              CheckList(i,:) = [];</span>
3380                     <span class="comment">%           end</span>
3381 
3382                     newList = editlist(List, <span class="string">'VCMtrim'</span>, CheckList);
3383 
3384                     <span class="keyword">if</span> isempty(newList)
3385                         fprintf(<span class="string">'   WARNING: Vertical corrector magnet list is empty!\n'</span>);
3386                         VCMlist1 = newList;
3387                     <span class="keyword">else</span>
3388                         VCMlist1 = newList;
3389                     <span class="keyword">end</span>
3390                     OCSy.CM.DeviceList = VCMlist1;
3391                 <span class="keyword">end</span>
3392 
3393                 <span class="keyword">if</span> EditFlag == 4
3394                     ListOld = BPMlist1;
3395                     XgoalOld = Xgoal;
3396                     YgoalOld = Ygoal;
3397 
3398                     <span class="comment">% Full BPM list</span>
3399                     List = <a href="getbpmlist.html" class="code" title="function [DeviceList, Index] = getbpmlist(varargin)">getbpmlist</a>(<span class="string">'Bergoz'</span>);
3400 
3401                     CheckList = zeros(size(List,1),1);
3402                     <span class="keyword">if</span> ~isempty(BPMlist1)
3403                         <span class="keyword">for</span> i = 1:size(List,1)
3404                             k = find(List(i,1)==BPMlist1(:,1));
3405                             l = find(List(i,2)==BPMlist1(k,2));
3406 
3407                             <span class="keyword">if</span> isempty(k) || isempty(l)
3408                                 <span class="comment">% Item not in list</span>
3409                             <span class="keyword">else</span>
3410                                 CheckList(i) = 1;
3411                             <span class="keyword">end</span>
3412                         <span class="keyword">end</span>
3413                     <span class="keyword">end</span>
3414 
3415                     newList = editlist(List, <span class="string">'BPM'</span>, CheckList);
3416                     <span class="keyword">if</span> isempty(newList)
3417                         fprintf(<span class="string">'   BPM list cannot be empty.  No change made.\n'</span>);
3418                     <span class="keyword">else</span>
3419                         BPMlist1 = newList;
3420                     <span class="keyword">end</span>
3421 
3422                     <span class="comment">% Set the goal orbit to the golden orbit</span>
3423                     Xgoal = getgolden(<span class="string">'BPMx'</span>, BPMlist1);
3424                     Ygoal = getgolden(<span class="string">'BPMy'</span>, BPMlist1);
3425 
3426 
3427                     <span class="comment">% If a new BPM is added, then set the goal orbit to the golden orbit</span>
3428                     <span class="keyword">for</span> i = 1:size(BPMlist1,1)
3429 
3430                         <span class="comment">% Is it a new BPM?</span>
3431                         k = find(BPMlist1(i,1)==ListOld(:,1));
3432                         l = find(BPMlist1(i,2)==ListOld(k,2));
3433 
3434                         <span class="keyword">if</span> isempty(k) || isempty(l)
3435                             <span class="comment">% New BPM</span>
3436                         <span class="keyword">else</span>
3437                             <span class="comment">% Use the old value for old BPM</span>
3438                             Xgoal(i) = XgoalOld(k(l));
3439                             Ygoal(i) = YgoalOld(k(l));
3440                         <span class="keyword">end</span>
3441                     <span class="keyword">end</span>
3442                     OCSx.BPM.DeviceList = BPMlist1;
3443                     OCSy.BPM.DeviceList = BPMlist1;
3444                     OCSx.GoalOrbit = Xgoal;
3445                     OCSy.GoalOrbit = Ygoal;
3446                 <span class="keyword">end</span>
3447 
3448                 <span class="keyword">if</span> EditFlag == 5
3449                     ChangeList = editlist2(BPMlist1, <span class="string">'Change BPM'</span>, zeros(size(BPMlist1,1),1));
3450 
3451                     <span class="keyword">for</span> i = 1:size(ChangeList,1)
3452 
3453                         k = find(ChangeList(i,1)==BPMlist1(:,1));
3454                         l = find(ChangeList(i,2)==BPMlist1(k,2));
3455 
3456                         prompt={sprintf(<span class="string">'Enter the new horizontal goal orbit for BPMx(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2)),sprintf(<span class="string">'Enter the new vertical goal orbit for BPMy(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2))};
3457                         def={sprintf(<span class="string">'%f'</span>,Xgoal(k(l))),sprintf(<span class="string">'%f'</span>,Ygoal(k(l)))};
3458                         titlestr=<span class="string">'CHANGE THE GOAL ORBIT'</span>;
3459                         lineNo=1;
3460                         answer = inputdlg(prompt, titlestr, lineNo, def);
3461 
3462                         <span class="keyword">if</span> isempty(answer)
3463                             <span class="comment">% No change</span>
3464                             fprintf(<span class="string">'   No change was made to the golden orbit.\n'</span>);
3465                         <span class="keyword">else</span>
3466                             Xgoalnew = str2num(answer{1});
3467                             <span class="keyword">if</span> isempty(Xgoalnew)
3468                                 fprintf(<span class="string">'   No change was made to the horizontal golden orbit.\n'</span>);
3469                             <span class="keyword">else</span>
3470                                 Xgoal(k(l)) = Xgoalnew;
3471                             <span class="keyword">end</span>
3472 
3473                             Ygoalnew = str2num(answer{2});
3474                             <span class="keyword">if</span> isempty(Ygoalnew)
3475                                 fprintf(<span class="string">'   No change was made to the vertical golden orbit.\n'</span>);
3476                             <span class="keyword">else</span>
3477                                 Ygoal(k(l)) = Ygoalnew;
3478                             <span class="keyword">end</span>
3479                         <span class="keyword">end</span>
3480                     <span class="keyword">end</span>
3481                     <span class="keyword">if</span> ~isempty(ChangeList)
3482                         fprintf(<span class="string">'   Note:  Changing the goal orbit for &quot;Slow Orbit Feedback&quot; does not change the goal orbit for &quot;Orbit Correction.&quot;\n'</span>);
3483                         fprintf(<span class="string">'          Re-running srcontrol will restart the goal orbit to the golden orbit.&quot;\n'</span>);
3484                     <span class="keyword">end</span>
3485                     OCSx.GoalOrbit = Xgoal;
3486                     OCSy.GoalOrbit = Ygoal;
3487                 <span class="keyword">end</span>
3488 
3489 <span class="comment">%                 if EditFlag == 6</span>
3490 <span class="comment">%                     FFTypeFlag = questdlg(sprintf('Do you want to use a fully local or a combined local/global compensation of IDs? (nuy=9.2 only)'),'Tune FF','Local','Global', 'Global');</span>
3491 <span class="comment">%                     if strcmp(FFTypeFlag,'Local')</span>
3492 <span class="comment">%                         disp(['   The tune FF will use 8 local quadrupoles to compensate beta beating and tune shift']);</span>
3493 <span class="comment">%                         disp(['   from each ID.']);</span>
3494 <span class="comment">%                     elseif strcmp(FFTypeFlag,'Global')</span>
3495 <span class="comment">%                         disp(['   The tune FF will use 4 local quadrupoles to compensate beta beating and all QF+QD']);</span>
3496 <span class="comment">%                         disp(['   to compensate tune shift from each ID.']);</span>
3497 <span class="comment">%                     end</span>
3498 <span class="comment">%                 end</span>
3499 
3500             <span class="keyword">end</span>
3501             close(h_fig1);
3502         <span class="keyword">end</span>
3503 
3504         <span class="comment">% Save vectors</span>
3505         FB.Xivec = Xivec;
3506         FB.Yivec = Yivec;
3507         FB.HCMlist1 = HCMlist1;
3508         FB.VCMlist1 = VCMlist1;
3509         FB.BPMlist1 = BPMlist1;
3510 
3511         OCSx.SVDIndex = Xivec;
3512         OCSy.SVDIndex = Yivec;
3513         FB.OCSx = OCSx;
3514         FB.OCSy = OCSy;
3515 
3516         FB.FFTypeFlag = FFTypeFlag;
3517         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>,FB);
3518 
3519 
3520     <span class="keyword">case</span> <span class="string">'FastFeedbackSetup'</span>
3521 
3522         InitFlag = Input2;
3523 
3524         <span class="keyword">if</span> InitFlag
3525             FOFBFreq = 1000;
3526             <span class="comment">% user operations 9/14-10/17/04: P=0.5, I=120, D=0.0015 (for both planes)</span>
3527             <span class="comment">% below are known good values for user ops as of 8-1-05</span>
3528             HorP = 2;
3529             HorI = 300;
3530             HorD = 0.002;
3531             VertP = 1;
3532             VertI = 100;
3533             VertD = 0.0015;
3534 
3535             <span class="comment">% this initial set is now done in hwinit.m because it's not a good idea to set anything when srcontrol is launched</span>
3536             <span class="comment">% try</span>
3537             <span class="comment">%     setsp('SR01____FFBFREQAC00', FOFBFreq); % set freq</span>
3538             <span class="comment">%     write_pid_ffb2_patch(HorP, HorI, HorD, VertP, VertI, VertD);</span>
3539             <span class="comment">% catch</span>
3540             <span class="comment">%     fprintf('   %s \n',lasterr);</span>
3541             <span class="comment">%     disp('   Trouble setting Fast Orbit Feedback parameters!');</span>
3542             <span class="comment">% end</span>
3543 
3544         <span class="keyword">else</span>
3545             <span class="comment">% Get vectors</span>
3546             FOFB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
3547             FOFBFreq = FOFB.FOFBFreq;
3548             HorP  = FOFB.HorP;
3549             HorI  = FOFB.HorI;
3550             HorD  = FOFB.HorD;
3551             VertP = FOFB.VertP;
3552             VertI = FOFB.VertI;
3553             VertD = FOFB.VertD;
3554 
3555             <span class="comment">% Add button to change #ivectors, CMs, IDBPMs,</span>
3556             EditFlag = 0;
3557             <span class="comment">%h_fig1 = figure;</span>
3558             <span class="keyword">while</span> EditFlag ~= 3
3559 
3560                 <span class="comment">%EditFlag = menu('Change Parameters?', 'Fast Feedback Frequency', 'PID Values', 'HCM List', 'VCM List', ...</span>
3561                 <span class="comment">%   'IDBPM List', 'BBPM List', 'Continue');</span>
3562                 <span class="comment">% Use menu below until other FFB config routines work (then also uncomment options 3,4,5,6 below)</span>
3563                 EditFlag = menu(<span class="string">'Change Parameters?'</span>, <span class="string">'Fast Feedback Frequency'</span>, <span class="string">'PID Values'</span>, <span class="string">'Continue'</span>);
3564 
3565                 <span class="keyword">if</span> EditFlag == 1
3566                     <span class="comment">% change rate</span>
3567 
3568                     prompt={<span class="string">'Enter the desired Fast Feedback Frequency (1-1000 Hz)'</span>};
3569                     def={num2str(FOFBFreq)};
3570                     titlestr=<span class="string">'Fast Feedback Setup'</span>;
3571                     lineNo=1;
3572                     answer=inputdlg(prompt,titlestr,lineNo,def);
3573                     <span class="keyword">if</span> ~isempty(answer)
3574                         FOFBFreq = fix(str2num(answer{1}));
3575                         <span class="keyword">if</span> isempty(FOFBFreq)
3576                             disp(<span class="string">'   Frequency value cannot be empty.  No change made.'</span>);
3577                             FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3578                         <span class="keyword">else</span>
3579                             <span class="keyword">if</span> FOFBFreq &lt; 1 || FOFBFreq &gt; 1000
3580                                 disp(<span class="string">'   Frequency must be between 1 and 1000 Hz.  No change made.'</span>);
3581                                 FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3582                             <span class="keyword">end</span>
3583                         <span class="keyword">end</span>
3584                         setsp(<span class="string">'SR01____FFBFREQAC00'</span>,FOFBFreq   ); <span class="comment">% change freq</span>
3585                         pause(0.5);
3586                         fprintf(<span class="string">'   Fast orbit feedback frequency is running at %.0f Hz.\n'</span>, getpv(<span class="string">'SR01____FFBFREQAM00'</span>));
3587                     <span class="keyword">else</span>
3588                         FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3589                     <span class="keyword">end</span>
3590                 <span class="keyword">end</span>
3591 
3592                 <span class="keyword">if</span> EditFlag == 2
3593                     <span class="comment">% edit  PIDs</span>
3594                     <span class="comment">% User defaults are HorP=2, HorI=300, HorD=0.002, VertP=1, VertI=100, VertD=0.0015</span>
3595                     prompt={<span class="string">'P horizontal'</span>, <span class="string">'I horizontal'</span>, <span class="string">'D horizontal'</span>, <span class="string">'P vertical'</span>, <span class="string">'I vertical'</span>, <span class="string">'D vertical'</span>};
3596                     def={num2str(HorP), num2str(HorI), num2str(HorD), num2str(VertP), num2str(VertI), num2str(VertD)};
3597                     titlestr=<span class="string">'Fast Feedback PID Setup'</span>;
3598                     lineNo=1;
3599                     answer=inputdlg(prompt,titlestr,lineNo,def);
3600                     <span class="keyword">if</span> ~isempty(answer)
3601                         HorPnewnum = str2num(answer{1});
3602                         <span class="keyword">if</span> isempty(HorPnewnum)
3603                             disp(<span class="string">'   HorP value cannot be empty.  No change made.'</span>);
3604                         <span class="keyword">else</span>
3605                             HorP = HorPnewnum;
3606                         <span class="keyword">end</span>
3607                         HorInewnum = str2num(answer{2});
3608                         <span class="keyword">if</span> isempty(HorInewnum)
3609                             disp(<span class="string">'   HorI value cannot be empty.  No change made.'</span>);
3610                         <span class="keyword">else</span>
3611                             HorI = HorInewnum;
3612                         <span class="keyword">end</span>
3613                         HorDnewnum = str2num(answer{3});
3614                         <span class="keyword">if</span> isempty(HorDnewnum)
3615                             disp(<span class="string">'   HorD value cannot be empty.  No change made.'</span>);
3616                         <span class="keyword">else</span>
3617                             HorD = HorDnewnum;
3618                         <span class="keyword">end</span>
3619                         VertPnewnum = str2num(answer{4});
3620                         <span class="keyword">if</span> isempty(VertPnewnum)
3621                             disp(<span class="string">'   VertP value cannot be empty.  No change made.'</span>);
3622                         <span class="keyword">else</span>
3623                             VertP = VertPnewnum;
3624                         <span class="keyword">end</span>
3625                         VertInewnum = str2num(answer{5});
3626                         <span class="keyword">if</span> isempty(VertInewnum)
3627                             disp(<span class="string">'   VertI value cannot be empty.  No change made.'</span>);
3628                         <span class="keyword">else</span>
3629                             VertI = VertInewnum;
3630                         <span class="keyword">end</span>
3631                         VertDnewnum = str2num(answer{6});
3632                         <span class="keyword">if</span> isempty(VertDnewnum)
3633                             disp(<span class="string">'   VertD value cannot be empty.  No change made.'</span>);
3634                         <span class="keyword">else</span>
3635                             VertD = VertDnewnum;
3636                         <span class="keyword">end</span>
3637 
3638                         <span class="keyword">try</span>
3639                             write_pid_ffb2_patch(HorP, HorI, HorD, VertP, VertI, VertD);
3640                             fprintf(<span class="string">'   Setting FFB gains to Horizontal P=%.2f, I=%.1f, D=%.4f;  Vertical P=%.2f, I=%.1f, D=%.4f\n'</span>, HorP, HorI, HorD, VertP, VertI, VertD);
3641                         <span class="keyword">catch</span>
3642                             fprintf(<span class="string">'   %s \n'</span>,lasterr);
3643                             disp(<span class="string">'   Trouble setting Fast Orbit Feedback parameters!'</span>);
3644                         <span class="keyword">end</span>
3645                     <span class="keyword">end</span>
3646                 <span class="keyword">end</span>
3647 
3648                 <span class="comment">%if EditFlag == 3</span>
3649                 <span class="comment">%   disp('   This function not yet available.');</span>
3650                 <span class="comment">%   % change HCM List</span>
3651                 <span class="comment">%end</span>
3652                 <span class="comment">%</span>
3653                 <span class="comment">%if EditFlag == 4</span>
3654                 <span class="comment">%   disp('   This function not yet available.');</span>
3655                 <span class="comment">%   % change VCM List</span>
3656                 <span class="comment">%end</span>
3657                 <span class="comment">%</span>
3658                 <span class="comment">%if EditFlag == 5</span>
3659                 <span class="comment">%   disp('   This function not yet available.');</span>
3660                 <span class="comment">%   % change IDBPM List</span>
3661                 <span class="comment">%end</span>
3662                 <span class="comment">%</span>
3663                 <span class="comment">%if EditFlag == 6</span>
3664                 <span class="comment">%   disp('   This function not yet available.');</span>
3665                 <span class="comment">%   % change BBPM List</span>
3666                 <span class="comment">%end</span>
3667 
3668             <span class="keyword">end</span>
3669             <span class="comment">%close(h_fig1);</span>
3670         <span class="keyword">end</span>
3671 
3672         <span class="comment">% Save vectors</span>
3673         FOFB.FOFBFreq = FOFBFreq;
3674         FOFB.HorP = HorP;
3675         FOFB.HorI = HorI;
3676         FOFB.HorD = HorD;
3677         FOFB.VertP = VertP;
3678         FOFB.VertI = VertI;
3679         FOFB.VertD = VertD;
3680         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Userdata'</span>,FOFB);
3681 
3682     <span class="keyword">otherwise</span>
3683         fprintf(<span class="string">'   No action for %s.\n'</span>, action);
3684 <span class="keyword">end</span>   <span class="comment">% end case</span></pre></div>
<hr><address>Generated on Fri 01-Aug-2008 11:41:01 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>