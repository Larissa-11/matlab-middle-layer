<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of srcontrol5_including_FOFB_indicators</title>
  <meta name="keywords" content="srcontrol5_including_FOFB_indicators">
  <meta name="description" content="srcontrol5">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">ALS</a> &gt; <a href="index.html">StorageRing</a> &gt; srcontrol5_including_FOFB_indicators.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for ALS\StorageRing&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>srcontrol5_including_FOFB_indicators
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>srcontrol5</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function srcontrol5(action, Input2, Input3) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> srcontrol5
 Storage ring control program

 This program controls all storage ring magnets, performs orbit feedback and
 tune feedforward and helps to diagnose problems in routine user operation
 of the ALS storage ring. It includes a gui to simplify the use of this
 program.

 It was originally programmed by Greg Portmann (until December 2000) with input
 from Winfried Decking, David Robin, Christoph Steier, Ying Wu and others
 and is currently (July 2002) maintained by Christoph Steier and Tom Scarvie.

 The actual version of this program is srcontrol5 (is called by default if you call srcontrol).

 Christoph Steier, July 2002

 SRCONTROL5 is the newest versionof SRCONTROL, edited to work with G. Portmann's new (2005) Matlab middle layer.

 Tom Scarvie, April 2005</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>	BEND2GEV - Compute the energy based on the ramp tables</li><li><a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>	CHECKSRMAGS - Check SR power supplies against a lattice file</li><li><a href="checksrorbit.html" class="code" title="function ErrorNums = checksrorbit(SectorList, BPMxtol,BPMytol)">checksrorbit</a>	ErrorNums =checksrorbit(Sector, BPMxtolerance [.015 mm], [BPMytolerance [.015 mm]])</li><li><a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>	GAP2TUNE - Computes the vertical tune shift for a insertion device gap change.</li><li><a href="gaplimit.html" class="code" title="function [GAPmin, GAPmax] = gaplimit(Dev);">gaplimit</a>	[GapMin, GapMax] = gaplimit(ID_Number);</li><li><a href="getff.html" class="code" title="function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)">getff</a>	function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)</li><li><a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>	GETID - Get the insertion device position, velocity, run flag, and user requested gap</li><li><a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>	[StateNumber, StateString] = getsrstate</li><li><a href="set_alarmhandler_AHU_thresholds_inject.html" class="code" title="function set_alarmhandler_AHU_thresholds_inject">set_alarmhandler_AHU_thresholds_inject</a>	function set_alarmhandler_AHU_thresholds_inject</li><li><a href="set_alarmhandler_thresholds.html" class="code" title="function set_alarmhandler_thresholds">set_alarmhandler_thresholds</a>	set_alarmhandler_thresholds</li><li><a href="set_alarmhandler_thresholds_new.html" class="code" title="function set_alarmhandler_thresholds_new">set_alarmhandler_thresholds_new</a>	set_alarmhandler_thresholds_new</li><li><a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>	SETBPMTIMECONSTANT - Sets the timeconstants for the Bergoz style BPMs.</li><li><a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>	SETBUMPS - Make a straight section bump</li><li><a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>	function setff(Sector, FFEnableBC, GapEnableBC)</li><li><a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>	SETID - Set the insertion device vertical gap</li><li><a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>	</li><li><a href="shift2tune.html" class="code" title="function [Dnux, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = shift2tune(Sector, Gap, EPUshift, GeV)">shift2tune</a>	SHIFT2TUNE - Computes the horizontal tune shift for a EPU gap and horizontal shift</li><li><a href="srcycle.html" class="code" title="function FailFlag = srcycle(varargin)">srcycle</a>	SRCYCLE - Storage ring cycle</li><li><a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>	SRRAMP - Ramp the storage ring energy</li><li><a href="write_goldenorbit_ffb.html" class="code" title="function write_goldenorbit_ffb">write_goldenorbit_ffb</a>	function write_goldenorbit_ffb</li><li><a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>	WRITE_GOLDENORBIT_FFTB_2PLANES - Sets the BPM setpoints which are used by the fast feedback system</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function srcontrol5(action, Input2, Input3)</a>
0002 <span class="comment">% srcontrol5</span>
0003 <span class="comment">% Storage ring control program</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% This program controls all storage ring magnets, performs orbit feedback and</span>
0006 <span class="comment">% tune feedforward and helps to diagnose problems in routine user operation</span>
0007 <span class="comment">% of the ALS storage ring. It includes a gui to simplify the use of this</span>
0008 <span class="comment">% program.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% It was originally programmed by Greg Portmann (until December 2000) with input</span>
0011 <span class="comment">% from Winfried Decking, David Robin, Christoph Steier, Ying Wu and others</span>
0012 <span class="comment">% and is currently (July 2002) maintained by Christoph Steier and Tom Scarvie.</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% The actual version of this program is srcontrol5 (is called by default if you call srcontrol).</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% Christoph Steier, July 2002</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% SRCONTROL5 is the newest versionof SRCONTROL, edited to work with G. Portmann's new (2005) Matlab middle layer.</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% Tom Scarvie, April 2005</span>
0021 
0022 <span class="comment">% known bugs/problems (May 2001):</span>
0023 <span class="comment">% - IDBPM averaging might be a bit too long for orbit feedback</span>
0024 <span class="comment">%        solved after Superbend shutdown ... Instead of averaging, digital low pass filters are used</span>
0025 <span class="comment">% - gap2tune does not give correct answers for wiggler and potentially other IDs -&gt; orbit feedback</span>
0026 <span class="comment">%        seems to be OK for other IDs, has been corrected for wiggler (fit to insertion device</span>
0027 <span class="comment">%        compensation table)</span>
0028 <span class="comment">% - chicanes do not work in orbit feedback</span>
0029 <span class="comment">%        solved. One problem was that orbit response matrizes were mis-scaled by factor of two.</span>
0030 <span class="comment">%        Second problem was different time constant of power supply control. Solved by moving controls</span>
0031 <span class="comment">%        of center chicanes to cPCI (and magnets are fast, hysteresis free, aircore coils).</span>
0032 <span class="comment">%        Center chicane in sector 4 is now routinely used in orbit feedback. Sector 11 to follow soon.</span>
0033 <span class="comment">% - zero reading of ID gap dumps beam</span>
0034 <span class="comment">%        solved in srcontrol5, still a problem in srcontrol5_hightune (but that routine has to be completely</span>
0035 <span class="comment">%        rewritten because of all recent changes to srcontrol5, anyhow). For gap readings below the minimum</span>
0036 <span class="comment">%        allowed gap for a device, the tune feedforward disables itself.</span>
0037 <span class="comment">% - cycling of lattice causes frequent power supply failures</span>
0038 <span class="comment">%        solved by changing the cycling procedure. 1.5 GeV operation is now on the upper hysteresis branch</span>
0039 <span class="comment">%        as was the 1.9 GeV injection lattice before.</span>
0040 <span class="comment">% - frequently stalled data in IDBPM readout</span>
0041 <span class="comment">%        solved with new BPM readouts and digital filtering. Seems to have been a resolution problem</span>
0042 <span class="comment">%        of the digital averaging algorithm.</span>
0043 <span class="comment">% - magnet ramp tables are not in perfect agreement with magnetic measurements</span>
0044 <span class="comment">%        Does not appear to be a serious problem. Superbends are slightly out of sync with other magnets,</span>
0045 <span class="comment">%        but this does not cause any negative effects while ramping.</span>
0046 <span class="comment">% - no good way to operate with injection at 1.5 GeV and storage energy below that</span>
0047 <span class="comment">%        There now is a reasonable way to inject at 1.5 GeV and ramp down to lower storage energy. But</span>
0048 <span class="comment">%        it has to be tested again after implementing new (and more) chicanes ...</span>
0049 
0050 <span class="comment">% revision history</span>
0051 <span class="comment">% 2001-05-10, Christoph Steier</span>
0052 <span class="comment">% check whether readback from insertion device is significantly (more than 1 mm) below minimum</span>
0053 <span class="comment">% gap, to avoid false zero readings of insertion device gaps to cause the tune feed forward</span>
0054 <span class="comment">% to implement false huge correction (and dump the beam). If the insertion device gap readbacks</span>
0055 <span class="comment">% gets more than 1 mm below the nominal minimum gap, the routine now assumes the insertion device</span>
0056 <span class="comment">% to be open.</span>
0057 <span class="comment">%</span>
0058 <span class="comment">% 2001-08-30 and during Superbend commissioning, Christoph Steier, Tom Scarvie, Winni Decking</span>
0059 <span class="comment">% various changes have been made to incorporate the Superbends and some other new equipment</span>
0060 <span class="comment">% installed in the Superbend shutdown. This included some changes to programs being called by srcontrol</span>
0061 <span class="comment">% (like srload, srsave, srcycle, srramp, ...). The main changes within srcontrol were in the orbit</span>
0062 <span class="comment">% correction and slow orbit feedback routines (incorporating frequency feedback, ...)</span>
0063 <span class="comment">%</span>
0064 <span class="comment">% 2002-05-04, Christoph Steier</span>
0065 <span class="comment">% added new IDBPMs, modified orbit feedback to use trim DACs, removed LSB toggling in vertical</span>
0066 <span class="comment">% orbit feedback, ...</span>
0067 <span class="comment">%</span>
0068 
0069 <span class="comment">% 2002-07-29, T.Scarvie</span>
0070 <span class="comment">% added check of CM trim currents to warn of problems that might rail the orbit feedback</span>
0071 <span class="comment">%</span>
0072 <span class="comment">% 2002-07-31, Christoph Steier</span>
0073 <span class="comment">% increased the gain of the RF frequency feedback from 1/50 of the gain of the horizontal</span>
0074 <span class="comment">% orbit feedback to 1/20. Reason was that the frequency feedback was reacting a bit too slow if all</span>
0075 <span class="comment">% insertion device gaps are closed at once at high speed at the beginning of a fill.</span>
0076 <span class="comment">%</span>
0077 <span class="comment">% 2002-08-05, C.Steier, T.Scarvie</span>
0078 <span class="comment">% Added conditional to reduce orbit feedback gain if running in two-bunch mode</span>
0079 <span class="comment">%</span>
0080 <span class="comment">% 2003-06-02, T.Scarvie</span>
0081 <span class="comment">% Added loop inside orbit feedback to reset the SR11 chicane M1 and M2 motors every 20s to combat drift problem</span>
0082 <span class="comment">%</span>
0083 <span class="comment">% 2003-06-18, C. Steier</span>
0084 <span class="comment">% Disabled loop to periodically reset chicane in SR11. Al Robb replaced power supply, seems to be no problem anymore.</span>
0085 <span class="comment">%</span>
0086 <span class="comment">% 2004-05-10, C. Steier</span>
0087 <span class="comment">% The list of all BBPMs is now set up automatically be calling getlist('BBPMx'). This way, new BBPMs have to be added</span>
0088 <span class="comment">% at fewer places in the software. It should now be sufficient to modify getlist and run the orbit response matrix</span>
0089 <span class="comment">% rountine (getsmat) once to enable use of the new BBPMs.</span>
0090 <span class="comment">%</span>
0091 <span class="comment">% 2004-05-14, C. Steier</span>
0092 <span class="comment">% Modified parameters for ramprate reduction (in srramp and here). Previous parameters were slightly too</span>
0093 <span class="comment">% cautious. Increased initial slow ramprate to 0.4 A/s.</span>
0094 <span class="comment">%</span>
0095 <span class="comment">% 2004-05-14, C. Steier</span>
0096 <span class="comment">% Incorporated insertion device compensation schemes for nu_y = 9.2 lattice.</span>
0097 <span class="comment">%</span>
0098 <span class="comment">% 2004-06-14, T.Scarvie</span>
0099 <span class="comment">% Added controls for fast orbit feedback</span>
0100 <span class="comment">%</span>
0101 <span class="comment">% 2004-06-21, C. Steier</span>
0102 <span class="comment">% Added tune feedforward (in the global tune compensation scheme for the nu_y=9.2 lattice) for the shift</span>
0103 <span class="comment">% dependent tune shift of the EPUs, as well as a skew quadrupole feedforward for the EPU im sector 11</span>
0104 <span class="comment">% (both only active in parallel mode so far).</span>
0105 <span class="comment">%</span>
0106 <span class="comment">% 2005-02-13, T.Scarvie</span>
0107 <span class="comment">% Separated horizontal and vertical planes for setting Fast Feedback PIDs</span>
0108 
0109 
0110 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0111 <span class="comment">% NOTES for conversion to new Middle Layer %</span>
0112 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0113 <span class="comment">%</span>
0114 <span class="comment">% We never use the gap and bump control flags - the radio buttons have been disabled -</span>
0115 <span class="comment">%        should we try to keep the functionality?</span>
0116 <span class="comment">%</span>
0117 <span class="comment">% remove handle globals</span>
0118 <span class="comment">% set(0,'showhiddenhandles','on'); what does this do?</span>
0119 <span class="comment">% grampbsc -&gt; should be handled by new srramp (which uses k-values)</span>
0120 <span class="comment">% checksrmags</span>
0121 <span class="comment">% checksrorbit(...)</span>
0122 <span class="comment">% getdcct</span>
0123 <span class="comment">% setbpmtimeconstant</span>
0124 <span class="comment">% getsmatelements</span>
0125 <span class="comment">% Chicane trims are now part of the corrector family</span>
0126 <span class="comment">% getname('IDrunflag',...) family name change</span>
0127 <span class="comment">% write_goldenorbit_ffb, write_goldenorbit_ffb2</span>
0128 
0129 
0130 <span class="comment">% For the compiler</span>
0131 <span class="comment">%#function goldenpage</span>
0132 <span class="comment">%#function setoperationalmode</span>
0133 
0134 
0135 <span class="comment">% Check if the AO exists</span>
0136 checkforao;
0137 
0138 
0139 <span class="comment">%%%%%%%%%%%%%%</span>
0140 <span class="comment">% Initialize %</span>
0141 <span class="comment">%%%%%%%%%%%%%%</span>
0142 
0143 <span class="keyword">global</span> FEEDBACK_STOP_FLAG
0144 
0145 SR_Mode = getfamilydata(<span class="string">'OperationalMode'</span>);
0146 SR_GEV = getfamilydata(<span class="string">'Energy'</span>);
0147 
0148 BSCramprate = getfamilydata(<span class="string">'BSCRampRate'</span>);
0149 <span class="keyword">if</span> isnan(BSCramprate) | isempty(BSCramprate)
0150     BSCramprate = 0.4;
0151     setfamilydata(BSCramprate, <span class="string">'BSCRampRate'</span>);
0152 <span class="keyword">end</span>
0153 
0154 <span class="keyword">if</span> nargin &lt; 1
0155     action = <span class="string">'Initialize'</span>;
0156 <span class="keyword">end</span>
0157 <span class="keyword">if</span> nargin &lt; 2
0158     Input2 = 0;
0159 <span class="keyword">end</span>
0160 <span class="keyword">if</span> nargin &lt; 3
0161     Input3 = 0;
0162 <span class="keyword">end</span>
0163 
0164 <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
0165     FOFBcheckboxVal = 0;
0166 <span class="keyword">else</span>
0167     FOFBcheckboxVal = 1;
0168 <span class="keyword">end</span>
0169 
0170 <span class="comment">%%%%%%%%%%%%%%%%</span>
0171 <span class="comment">% Main Program %</span>
0172 <span class="comment">%%%%%%%%%%%%%%%%</span>
0173 
0174 <span class="keyword">switch</span>(action)
0175 
0176     <span class="keyword">case</span> <span class="string">'StopOrbitFeedback'</span>
0177 
0178         FEEDBACK_STOP_FLAG = 1;
0179 
0180     <span class="keyword">case</span> <span class="string">'Initialize'</span>
0181 
0182         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0183         <span class="comment">% GUI</span>
0184         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0185         ButtonWidth = 200;
0186         ButtonHeight  = 25;
0187 
0188         Offset1 = 8*25+12 + 47 + 25+25;
0189         Offset2 = 47+25+25;
0190         Offset3 = 45+25;
0191         Offset4 = 1;
0192         Offset5 = 30;
0193         FigWidth = ButtonWidth+6;
0194         FigHeight  = 3+9*(ButtonHeight+6)+24+Offset1;
0195         ButtonWidth = 200-6;
0196 
0197         <span class="comment">% Change figure position</span>
0198         set(0,<span class="string">'Units'</span>,<span class="string">'pixels'</span>);
0199         p=get(0,<span class="string">'screensize'</span>);
0200 
0201         h0 = figure( <span class="keyword">...</span>
0202             <span class="string">'Color'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0203             <span class="string">'HandleVisibility'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0204             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0205             <span class="string">'MenuBar'</span>,<span class="string">'none'</span>, <span class="keyword">...</span>
0206             <span class="string">'Name'</span>,<span class="string">'ALS SR CONTROL'</span>, <span class="keyword">...</span>
0207             <span class="string">'NumberTitle'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0208             <span class="string">'Units'</span>,<span class="string">'pixels'</span>, <span class="keyword">...</span>
0209             <span class="string">'Position'</span>,[30 p(4)-FigHeight-40 FigWidth FigHeight+Offset5], <span class="keyword">...</span>
0210             <span class="string">'Resize'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0211             <span class="string">'Tag'</span>,<span class="string">'SRCTRLFig1'</span>);
0212 
0213         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0214             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0215             <span class="string">'Callback'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0216             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0217             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0218             <span class="string">'FontWeight'</span>,<span class="string">'Bold'</span>, <span class="keyword">...</span>
0219             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0220             <span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>, <span class="keyword">...</span>
0221             <span class="string">'Position'</span>,[6 3+8*(ButtonHeight+3)+19+19+8+Offset1  ButtonWidth 20+Offset5], <span class="keyword">...</span>
0222             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0223             <span class="string">'String'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0224             <span class="string">'Tag'</span>,<span class="string">'SRCTRLTitle'</span>);
0225 
0226         <span class="comment">% Frame Box I</span>
0227         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0228             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0229             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0230             <span class="string">'Position'</span>,[3 3+3*(ButtonHeight+3)+Offset1-3+Offset5 ButtonWidth+6 7*ButtonHeight+18], <span class="keyword">...</span>
0231             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0232 
0233         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0234             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0235             <span class="string">'Callback'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0236             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0237             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0238             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0239             <span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>, <span class="keyword">...</span>
0240             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)+Offset1  ButtonWidth 15+Offset5], <span class="keyword">...</span>
0241             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0242             <span class="string">'String'</span>,<span class="string">'Lattice Setup Functions'</span>);
0243 
0244         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0245             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Cycle'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0246             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0247             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0248             <span class="string">'Position'</span>,[6 3+8*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0249             <span class="string">'String'</span>,<span class="string">'Cycle SR Lattice'</span>, <span class="keyword">...</span>
0250             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>);
0251 
0252         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0253             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Injection'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0254             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0255             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0256             <span class="string">'Position'</span>,[6 3+7*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0257             <span class="string">'String'</span>,<span class="string">'Injection'</span>, <span class="keyword">...</span>
0258             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>);
0259 
0260         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0261             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Production'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0262             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0263             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0264             <span class="string">'Position'</span>,[6 3+6*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0265             <span class="string">'String'</span>,[<span class="string">'Production'</span>], <span class="keyword">...</span>
0266             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>);
0267 
0268         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0269             <span class="string">'Callback'</span>,[<span class="keyword">...</span>
0270             <span class="string">'fprintf(''\n'');'</span> <span class="keyword">...</span>
0271             <span class="string">'disp([''   **********************************************'']);'</span>, <span class="keyword">...</span>
0272             <span class="string">'disp([''   **  Changing Storage Ring Operational Mode  **'']);'</span>, <span class="keyword">...</span>
0273             <span class="string">'disp([''   **********************************************'']);'</span>, <span class="keyword">...</span>
0274             <span class="string">'setoperationalmode;'</span>, <span class="keyword">...</span>
0275             <span class="string">'srcontrol5(''CheckInputs'');'</span>, <span class="keyword">...</span>
0276             <span class="string">'disp([''   ****************************'']);'</span>, <span class="keyword">...</span>
0277             <span class="string">'disp([''   **  Mode Change Complete  **'']);'</span>, <span class="keyword">...</span>
0278             <span class="string">'disp([''   ****************************'']);'</span>, <span class="keyword">...</span>
0279             <span class="string">'fprintf(''\n'');'</span>], <span class="keyword">...</span>
0280             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0281             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0282             <span class="string">'Position'</span>,[6 3+5*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0283             <span class="string">'Value'</span>,1, <span class="keyword">...</span>
0284             <span class="string">'String'</span>,<span class="string">'Change Operational Mode'</span>, <span class="keyword">...</span>
0285             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>);
0286 
0287         h1 = uicontrol(<span class="keyword">...</span>
0288             <span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0289             <span class="string">'Callback'</span>, [<span class="keyword">...</span>
0290             <span class="string">'srcontrol5(''CheckInputs'');'</span>,<span class="keyword">...</span>
0291             <span class="string">'srcontrol5(''SRState'');'</span>], <span class="keyword">...</span>
0292             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0293             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0294             <span class="string">'Position'</span>,[6 3+4*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0295             <span class="string">'String'</span>,<span class="string">'Check For Problems'</span>, <span class="keyword">...</span>
0296             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>);
0297 
0298         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0299             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs''); goldenpage;'</span>, <span class="keyword">...</span>
0300             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0301             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0302             <span class="string">'Position'</span>,[6 3+3*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0303             <span class="string">'String'</span>,<span class="string">'Golden Page'</span>, <span class="keyword">...</span>
0304             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>);
0305 
0306 
0307         <span class="comment">% Frame Box II</span>
0308         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0309             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0310             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0311             <span class="string">'Position'</span>,[3 3+9*(ButtonHeight+3)-29+Offset2+Offset5 ButtonWidth+6 2*ButtonHeight+15], <span class="keyword">...</span>
0312             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0313         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0314             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0315             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0316             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0317             <span class="string">'Position'</span>,[6 3+10*(ButtonHeight+3)-10+Offset2 ButtonWidth .6*ButtonHeight+Offset5], <span class="keyword">...</span>
0318             <span class="string">'String'</span>,<span class="string">'Global/Local Orbit Correction'</span>, <span class="keyword">...</span>
0319             <span class="string">'Style'</span>,<span class="string">'text'</span>);
0320         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0321             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''OrbitCorrection'');'</span>, <span class="keyword">...</span>
0322             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0323             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0324             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)-6+Offset2+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0325             <span class="string">'String'</span>,<span class="string">'Correct Global Orbit w/ IDBPMs'</span>, <span class="keyword">...</span>
0326             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>);
0327         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0328             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''OrbitCorrectionSetup'',1);'</span>, <span class="keyword">...</span>
0329             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''OrbitCorrectionSetup'',0);'</span>, <span class="keyword">...</span>
0330             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0331             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0332             <span class="string">'Position'</span>,[6 9*(ButtonHeight+3)-22+Offset2+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0333             <span class="string">'String'</span>,<span class="string">'Edit IDBPM, CM, &amp; Local Bump Lists'</span>, <span class="keyword">...</span>
0334             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0335             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0336             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>);
0337 
0338 
0339         <span class="comment">% Frame Box III</span>
0340         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0341             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0342             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0343             <span class="string">'Position'</span>,[3 1*(ButtonHeight)+Offset3+Offset5-38 ButtonWidth+6 8*ButtonHeight+61], <span class="keyword">...</span>
0344             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0345         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0346             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0347             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0348             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0349             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)+Offset3-25 ButtonWidth .55*ButtonHeight+Offset5], <span class="keyword">...</span>
0350             <span class="string">'String'</span>,<span class="string">'Orbit Feedback'</span>, <span class="keyword">...</span>
0351             <span class="string">'Style'</span>,<span class="string">'text'</span>);
0352 
0353         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0354             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0355             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0356             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0357             <span class="string">'Position'</span>,[26 3+8*(ButtonHeight+3)+Offset3-18+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0358             <span class="string">'String'</span>,<span class="string">'Slow Orbit Correction'</span>, <span class="keyword">...</span>
0359             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0360             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0361             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxSOFB'</span>);
0362         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0363             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0364             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0365             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0366             <span class="string">'Position'</span>,[26 3+7*(ButtonHeight+3)+Offset3-9+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0367             <span class="string">'String'</span>,<span class="string">'Fast Orbit Correction'</span>, <span class="keyword">...</span>
0368             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0369             <span class="string">'Value'</span>,FOFBcheckboxVal,<span class="keyword">...</span>
0370             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxFOFB'</span>);
0371 
0372         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0373             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0374             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0375             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0376             <span class="string">'Position'</span>,[26 3+6*(ButtonHeight+3)+Offset3+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0377             <span class="string">'String'</span>,<span class="string">'Correct ID Tune Shift  '</span>, <span class="keyword">...</span>
0378             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0379             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0380             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxTune'</span>);
0381 
0382         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0383             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0384             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0385             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0386             <span class="string">'Position'</span>,[26 3+5*(ButtonHeight+3)+Offset3+9+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0387             <span class="string">'String'</span>,<span class="string">'Correct RF Frequency'</span>, <span class="keyword">...</span>
0388             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0389             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0390             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>);
0391 
0392         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0393             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''Feedback'');'</span>, <span class="keyword">...</span>
0394             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0395             <span class="string">'FontSize'</span>,12, <span class="keyword">...</span>
0396             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0397             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0398             <span class="string">'Position'</span>,[8 3+5*(ButtonHeight+3)+3+Offset3-25+Offset5 .5*ButtonWidth-6 1.0*ButtonHeight], <span class="keyword">...</span>
0399             <span class="string">'String'</span>,<span class="string">'Start FB'</span>, <span class="keyword">...</span>
0400             <span class="string">'Value'</span>,0, <span class="keyword">...</span>
0401             <span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>);
0402         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0403             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''StopOrbitFeedback'');pause(0);'</span>, <span class="keyword">...</span>
0404             <span class="string">'Enable'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0405             <span class="string">'FontSize'</span>,12, <span class="keyword">...</span>
0406             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0407             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0408             <span class="string">'Position'</span>,[.5*FigWidth+3 3+5*(ButtonHeight+3)+3+Offset3-25+Offset5 .5*ButtonWidth-6 1.0*ButtonHeight], <span class="keyword">...</span>
0409             <span class="string">'String'</span>,<span class="string">'Stop FB'</span>, <span class="keyword">...</span>
0410             <span class="string">'Value'</span>,0, <span class="keyword">...</span>
0411             <span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>);
0412 
0413         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0414             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0415             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0416             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0417             <span class="string">'Position'</span>,[14 4*(ButtonHeight)+Offset3+Offset5-3 ButtonWidth-14 .75*ButtonHeight], <span class="keyword">...</span>
0418             <span class="string">'String'</span>,<span class="string">'Horizontal RMS = _____ mm'</span>, <span class="keyword">...</span>
0419             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0420             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>);
0421         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0422             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0423             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0424             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0425             <span class="string">'Position'</span>,[26 3+3.5*(ButtonHeight)+16+Offset3-25+Offset5 ButtonWidth-26 .75*ButtonHeight], <span class="keyword">...</span>
0426             <span class="string">'String'</span>,<span class="string">'Vertical RMS = _____ mm'</span>, <span class="keyword">...</span>
0427             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0428             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>);
0429 
0430         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0431             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''FeedbackSetup'',1);'</span>, <span class="keyword">...</span>
0432             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''FeedbackSetup'',0);'</span>, <span class="keyword">...</span>
0433             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0434             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0435             <span class="string">'Position'</span>,[8 3+3.5*(ButtonHeight)+.5+Offset3-25+Offset5 ButtonWidth-5 .75*ButtonHeight], <span class="keyword">...</span>
0436             <span class="string">'String'</span>,<span class="string">'Edit SOFB Setup'</span>, <span class="keyword">...</span>
0437             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0438             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0439             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>);
0440 
0441         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0442             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0443             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0444             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0445             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0446             <span class="string">'String'</span>,<span class="string">'01 ____'</span>, <span class="keyword">...</span>
0447             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0448             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0449             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>);
0450 
0451         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0452             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0453             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0454             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0455             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0456             <span class="string">'String'</span>,<span class="string">'02 ____'</span>, <span class="keyword">...</span>
0457             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0458             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0459             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>);
0460 
0461         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0462             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0463             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0464             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0465             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0466             <span class="string">'String'</span>,<span class="string">'03 ____'</span>, <span class="keyword">...</span>
0467             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0468             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0469             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>);
0470 
0471         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0472             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0473             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0474             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0475             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0476             <span class="string">'String'</span>,<span class="string">'04 ____'</span>, <span class="keyword">...</span>
0477             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0478             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0479             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>);
0480 
0481         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0482             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0483             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0484             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0485             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0486             <span class="string">'String'</span>,<span class="string">'05 ____'</span>, <span class="keyword">...</span>
0487             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0488             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0489             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>);
0490 
0491         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0492             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0493             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0494             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0495             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0496             <span class="string">'String'</span>,<span class="string">'06 ____'</span>, <span class="keyword">...</span>
0497             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0498             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0499             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>);
0500 
0501         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0502             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0503             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0504             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0505             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0506             <span class="string">'String'</span>,<span class="string">'07 ____'</span>, <span class="keyword">...</span>
0507             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0508             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0509             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>);
0510 
0511         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0512             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0513             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0514             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0515             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0516             <span class="string">'String'</span>,<span class="string">'08 ____'</span>, <span class="keyword">...</span>
0517             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0518             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0519             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>);
0520 
0521         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0522             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0523             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0524             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0525             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0526             <span class="string">'String'</span>,<span class="string">'09 ____'</span>, <span class="keyword">...</span>
0527             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0528             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0529             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>);
0530 
0531         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0532             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0533             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0534             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0535             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0536             <span class="string">'String'</span>,<span class="string">'10 ____'</span>, <span class="keyword">...</span>
0537             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0538             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0539             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>);
0540 
0541         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0542             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0543             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0544             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0545             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0546             <span class="string">'String'</span>,<span class="string">'11 ____'</span>, <span class="keyword">...</span>
0547             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0548             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0549             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>);
0550 
0551         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0552             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0553             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0554             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0555             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0556             <span class="string">'String'</span>,<span class="string">'12 ____'</span>, <span class="keyword">...</span>
0557             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0558             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0559             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>);
0560 
0561         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0562             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''FastFeedbackSetup'',1);'</span>, <span class="keyword">...</span>
0563             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''FastFeedbackSetup'',0);'</span>, <span class="keyword">...</span>
0564             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0565             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0566             <span class="string">'Position'</span>,[8 1*(ButtonHeight)+Offset3-3 ButtonWidth-5 .75*ButtonHeight], <span class="keyword">...</span>
0567             <span class="string">'String'</span>,<span class="string">'Edit FOFB Setup'</span>, <span class="keyword">...</span>
0568             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0569             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0570             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>);
0571 
0572         <span class="comment">% Frame Box IV</span>
0573         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0574             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0575             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0576             <span class="string">'Position'</span>,[3 3+ButtonHeight+Offset4-14+Offset5 ButtonWidth+6 ButtonHeight+12], <span class="keyword">...</span>
0577             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0578         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0579             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0580             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0581             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0582             <span class="string">'Position'</span>,[6 3+1.75*ButtonHeight+5+Offset4-21+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0583             <span class="string">'String'</span>,<span class="string">'Storage Ring State'</span>, <span class="keyword">...</span>
0584             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0585             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHeader'</span>);
0586         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0587             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''CheckInputs'');'</span>, <span class="keyword">...</span>
0588             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0589             <span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>, <span class="keyword">...</span>
0590             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0591             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0592             <span class="string">'Position'</span>,[6 3+ButtonHeight+6+3+2+Offset4-22+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0593             <span class="string">'String'</span>,<span class="string">'   '</span>, <span class="keyword">...</span>
0594             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0595             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>);
0596 
0597 
0598         <span class="comment">% Frame Box &quot;Close&quot;</span>
0599         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0600             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0601             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0602             <span class="string">'Position'</span>,[3 8 ButtonWidth+6 ButtonHeight+8], <span class="keyword">...</span>
0603             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0604         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0605             <span class="string">'Callback'</span>,<span class="string">'close(gcbf);'</span>, <span class="keyword">...</span>
0606             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0607             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0608             <span class="string">'Position'</span>,[6 13 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0609             <span class="string">'String'</span>,<span class="string">'Close'</span>, <span class="keyword">...</span>
0610             <span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>);
0611 
0612 
0613         <span class="comment">% Update database channels</span>
0614         <a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>;
0615 
0616         <span class="keyword">if</span> nargout &gt; 0
0617             fig = h0;
0618         <span class="keyword">end</span>
0619 
0620 
0621     <span class="keyword">case</span> <span class="string">'Cycle'</span>
0622         GapFlag = Input2;
0623         BumpMagnetFlag = Input3;
0624 
0625         fprintf(<span class="string">'\n'</span>);
0626         disp(<span class="string">'   **************************'</span>);
0627         disp(<span class="string">'   **  Storage Ring Cycle  **'</span>);
0628         disp(<span class="string">'   **************************'</span>);
0629         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
0630 
0631         BSCFlag = questdlg(sprintf(<span class="string">'Cycle Superbend Magnets?'</span>),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0632         <span class="comment">%if strcmp(BSCFlag,'No')</span>
0633         <span class="comment">%    disp(['   ** Superbends will not be cycled. **']);</span>
0634         <span class="comment">%else</span>
0635         <span class="comment">%    disp(['   ** Superbends will be cycled during the second mini-cycle only. **']);</span>
0636         <span class="comment">%end</span>
0637 
0638         ChicSQFlag = questdlg(sprintf(<span class="string">'Cycle chicanes and skew quads and home motor chicanes?'</span>),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0639         <span class="comment">%if strcmp(ChicSQFlag,'No')</span>
0640         <span class="comment">%    disp(['   ** Chicanes and skew quads will not be cycled; motor chicanes will not be homed. **']);</span>
0641         <span class="comment">%else</span>
0642         <span class="comment">%    disp(['   ** Chicanes and skew quads will be cycled; motor chicanes will be homed. **']);</span>
0643         <span class="comment">%end</span>
0644 
0645 
0646         StartFlag = questdlg(sprintf(<span class="string">'Start %.1f GeV Cycle?'</span>,SR_GEV),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0647         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
0648             disp([<span class="string">'   ***************************'</span>]);
0649             disp([<span class="string">'   **    Cycle  Canceled    **'</span>]);
0650             disp([<span class="string">'   ***************************'</span>]);
0651             fprintf(<span class="string">'\n'</span>);
0652             <span class="keyword">return</span>
0653         <span class="keyword">end</span>
0654 
0655         <span class="keyword">try</span>
0656             <span class="keyword">if</span> GapFlag
0657                 <span class="comment">% Make sure that the gaps are open with FF off</span>
0658                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0659                     <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0660                     disp(<span class="string">'   Insertion device gaps are not open.'</span>);
0661                     disp(<span class="string">'   Opening all gaps at maximum speed.'</span>);
0662                     <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0663                     disp(<span class="string">'   Gap control disabled.'</span>);
0664                     disp(<span class="string">'   Feed forward enabled.'</span>);
0665                     pause(1);
0666                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0667                     disp(<span class="string">'   Gaps opened.'</span>);
0668                     disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0669                     a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0670                 <span class="keyword">else</span>
0671                     disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0672                 <span class="keyword">end</span>
0673             <span class="keyword">else</span>
0674                 disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0675             <span class="keyword">end</span>
0676 
0677             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0678             pause(1);
0679             
0680             <a href="srcycle.html" class="code" title="function FailFlag = srcycle(varargin)">srcycle</a>(BSCFlag, ChicSQFlag);
0681 
0682             setpv(<span class="string">'SR_STATE'</span>,1);
0683 
0684         <span class="keyword">catch</span>
0685 
0686             fprintf(<span class="string">'   %s \n'</span>,lasterr);
0687             fprintf(<span class="string">'   Cycle failed due to error condition! \n\n'</span>);
0688             setpv(<span class="string">'SR_STATE'</span>,-1);
0689             
0690         <span class="keyword">end</span>
0691 
0692         date;
0693         a = clock;
0694         datestr1=date;
0695         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0696         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0697         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0698         <span class="keyword">if</span> StateNumber &gt;= 0
0699             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0700             disp(<span class="string">'   **********************************************'</span>);
0701             disp(<span class="string">'   **  SR Cycle complete, ready for injection  **'</span>);
0702             disp(<span class="string">'   **********************************************'</span>); fprintf(<span class="string">'\n'</span>);
0703         <span class="keyword">else</span>
0704             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0705             disp(<span class="string">'   **********************************'</span>);
0706             disp(<span class="string">'   **  Problem cycling SR lattice  **'</span>);
0707             disp(<span class="string">'   **********************************'</span>); fprintf(<span class="string">'\n'</span>);
0708         <span class="keyword">end</span>
0709         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0710         
0711 
0712     <span class="keyword">case</span> <span class="string">'Injection'</span>
0713         AD = getad;
0714         GapFlag = Input2;
0715         BumpMagnetFlag = Input3;
0716 
0717         fprintf(<span class="string">'\n'</span>);
0718         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0719 
0720         <span class="keyword">if</span> abs(AD.Energy - AD.InjectionEnergy) &gt; .05
0721             fprintf(<span class="string">'   ***************************************************\n'</span>);
0722             fprintf(<span class="string">'   **  Setup For %.2f GeV Injection (with ramping)  **\n'</span>, getfamilydata(<span class="string">'InjectionEnergy'</span>));
0723             fprintf(<span class="string">'   ***************************************************\n'</span>);
0724             <a href="set_alarmhandler_AHU_thresholds_inject.html" class="code" title="function set_alarmhandler_AHU_thresholds_inject">set_alarmhandler_AHU_thresholds_inject</a>;
0725             StartFlag = questdlg(sprintf(<span class="string">'Start setup for injection, %.2f GeV?'</span>,getfamilydata(<span class="string">'InjectionEnergy'</span>)),<span class="string">'Injection Setup'</span>,<span class="string">'Ramp quickly'</span>,<span class="string">'Ramp slowly'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0726         <span class="keyword">else</span>
0727             fprintf(<span class="string">'   *************************************************\n'</span>);
0728             fprintf(<span class="string">'   **  Setup For On Energy Injection at %.2f GeV  **\n'</span>, SR_GEV);
0729             fprintf(<span class="string">'   *************************************************\n'</span>);
0730             StartFlag = questdlg(sprintf(<span class="string">'Start setup for injection, %.2f GeV?'</span>,SR_GEV),<span class="string">'Injection Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0731         <span class="keyword">end</span>
0732         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'Cancel'</span>)
0733             disp([<span class="string">'   ********************************'</span>]);
0734             disp([<span class="string">'   **  Injection Setup Canceled  **'</span>]);
0735             disp([<span class="string">'   ********************************'</span>]);
0736             <a href="set_alarmhandler_thresholds.html" class="code" title="function set_alarmhandler_thresholds">set_alarmhandler_thresholds</a>;
0737             fprintf(<span class="string">'\n'</span>);
0738             <span class="keyword">return</span>
0739         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp quickly'</span>)
0740             setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0741         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp slowly'</span>)
0742             setfamilydata(0.4, <span class="string">'BSCRampRate'</span>);
0743         <span class="keyword">end</span>
0744 
0745         <span class="keyword">try</span>
0746 
0747             <span class="keyword">if</span> GapFlag
0748                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([],1,0);
0749                 disp(<span class="string">'   Gap control disabled'</span>);
0750                 disp(<span class="string">'   Feed forward enabled'</span>);
0751                 pause(1);
0752 
0753                 <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0754                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0755                     disp(<span class="string">'   Opening all gaps'</span>);
0756                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0757                 <span class="keyword">end</span>
0758 
0759                 disp(<span class="string">'   Gaps are open'</span>);
0760                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0761                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0762             <span class="keyword">else</span>
0763                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0764             <span class="keyword">end</span>
0765 
0766             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0767             pause(1);
0768 
0769             <span class="keyword">if</span> (AD.Energy-AD.InjectionEnergy) &gt; 0.05
0770                 <span class="comment">% Ramp down to Injection Energy</span>
0771                 ErrorFlag = <a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>(<span class="string">'Injection'</span>);
0772                 <span class="keyword">if</span> ErrorFlag
0773                     error(<span class="string">'Superbends over temperature.'</span>);
0774                 <span class="keyword">end</span>
0775                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n\n'</span>,date, a(4), a(5), a(6));
0776 
0777             <span class="keyword">elseif</span> (AD.Energy-AD.InjectionEnergy) &lt; -0.05
0778 
0779                 <span class="comment">% first load injection lattice, then ramp to 1.9 GeV and back to 1.5 GeV to get onto same hysteresis branch</span>
0780 
0781                 srload(<span class="string">'Injection'</span>);
0782 
0783                 <span class="comment">% load 1.9 GeV lattice</span>
0784                 tempfilename = sprintf(<span class="string">'%s19nuy9prod.mat'</span>, getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>));
0785 
0786                 srload(tempfilename);
0787 
0788                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0789 
0790                 pause(5);
0791 
0792             <span class="keyword">end</span>
0793 
0794             srload(<span class="string">'Injection'</span>);
0795 
0796             setpv(<span class="string">'SR_STATE'</span>,2);
0797 
0798         <span class="keyword">catch</span>
0799 
0800             fprintf(<span class="string">'   %s \n'</span>,lasterr);
0801             fprintf(<span class="string">'   Injection lattice setup failed due to error condition! \n\n'</span>);
0802             setpv(<span class="string">'SR_STATE'</span>,-2);
0803 
0804         <span class="keyword">end</span>
0805 
0806 
0807         date;
0808         a = clock;
0809         datestr1=date;
0810         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0811         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0812         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0813         <span class="keyword">if</span> StateNumber &gt;= 0
0814             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0815             <span class="keyword">if</span> AD.Energy &lt;= 1.5
0816                 disp([<span class="string">'   *******************************************************************************'</span>]);
0817                 disp([<span class="string">'   **  Function complete:  the storage ring is setup for injection at '</span>,sprintf(<span class="string">'%.2f'</span>,SR_GEV),<span class="string">' GeV  **'</span>]);
0818                 disp([<span class="string">'   *******************************************************************************'</span>]); 
0819                 fprintf(<span class="string">'\n'</span>);
0820             <span class="keyword">else</span>
0821                 fprintf(<span class="string">'   **********************************************************************************************\n'</span>);
0822                 fprintf(<span class="string">'   **  Function complete:  the storage ring is setup for injection at %.2f GeV (upper branch)  **\n'</span>, getfamilydata(<span class="string">'InjectionEnergy'</span>));
0823                 fprintf(<span class="string">'   **********************************************************************************************\n'</span>); 
0824                 fprintf(<span class="string">'\n'</span>);
0825             <span class="keyword">end</span>
0826         <span class="keyword">else</span>
0827             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0828             disp([<span class="string">'   ************************************'</span>]);
0829             disp([<span class="string">'   **  Problem with injection setup  **'</span>]);
0830             disp([<span class="string">'   ************************************'</span>]); 
0831             fprintf(<span class="string">'\n'</span>);
0832         <span class="keyword">end</span>
0833         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0834 
0835         <span class="comment">%soundchord;</span>
0836 
0837         setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0838 
0839 
0840     <span class="keyword">case</span> <span class="string">'Production'</span>
0841         GapFlag = Input2;
0842         BumpMagnetFlag = Input3;
0843         AD=getad;
0844         
0845         fprintf(<span class="string">'\n'</span>);
0846         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0847 
0848         <span class="keyword">if</span> abs(AD.Energy - AD.InjectionEnergy) &gt; .05
0849             disp(<span class="string">'   ********************************************************'</span>);
0850             disp(sprintf(<span class="string">'   **  Setup For %.2f GeV User Operation (with ramping)  **'</span>,SR_GEV));
0851             disp(<span class="string">'   ********************************************************'</span>);
0852             StartFlag = questdlg(sprintf(<span class="string">'Start setup for users, %.1f GeV?'</span>,SR_GEV),<span class="string">'User Setup'</span>,<span class="string">'Ramp quickly'</span>,<span class="string">'Ramp slowly'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0853         <span class="keyword">else</span>
0854             disp(<span class="string">'   *****************************************'</span>);
0855             disp(sprintf(<span class="string">'   **  Setup For %.2f GeV User Operation  **'</span>,SR_GEV));
0856             disp(<span class="string">'   *****************************************'</span>);
0857             StartFlag = questdlg(sprintf(<span class="string">'Start setup for users, %.1f GeV?'</span>,SR_GEV),<span class="string">'User Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0858         <span class="keyword">end</span>
0859 
0860         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'Cancel'</span>)
0861             disp([<span class="string">'   ***************************'</span>]);
0862             disp([<span class="string">'   **  User Setup Canceled  **'</span>]);
0863             disp([<span class="string">'   ***************************'</span>]);
0864             fprintf(<span class="string">'\n'</span>);
0865             <span class="keyword">return</span>
0866         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp quickly'</span>)
0867             setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0868         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp slowly'</span>)
0869             setfamilydata(0.4, <span class="string">'BSCRampRate'</span>);
0870         <span class="keyword">end</span>
0871 
0872         <span class="keyword">try</span>
0873 
0874             <span class="keyword">if</span> GapFlag
0875                 <span class="comment">% Make sure that the gaps are open</span>
0876                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0877                     <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0878                     disp(<span class="string">'   Insertion device gaps are not open'</span>);
0879                     disp(<span class="string">'   Opening all gaps at maximum speed'</span>);
0880                     <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0881                     disp(<span class="string">'   Gap control disabled'</span>);
0882                     disp(<span class="string">'   Feed forward enabled'</span>);
0883                     pause(1);
0884                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0885                     disp(<span class="string">'   Gaps opened'</span>);
0886                     disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0887                     a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0888                 <span class="keyword">else</span>
0889                     disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0890                 <span class="keyword">end</span>
0891             <span class="keyword">else</span>
0892                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0893             <span class="keyword">end</span>
0894 
0895             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0896             pause(1);
0897 
0898             <span class="comment">% Ramp up to the production lattice</span>
0899             ErrorFlag = <a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>(<span class="string">'Production'</span>);
0900             <span class="keyword">if</span> ErrorFlag
0901                 error(<span class="string">'Superbends over temperature.'</span>);
0902             <span class="keyword">end</span>
0903             a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0904 
0905             srload(<span class="string">'Production'</span>);
0906 
0907             <span class="keyword">if</span> GapFlag
0908                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0909                 disp(<span class="string">'   Gap control disabled'</span>);
0910                 disp(<span class="string">'   Feed forward enable'</span>);
0911                 pause(1);
0912 
0913                 disp(<span class="string">'   Insertion device velocity profile boolean control off'</span>);
0914                 disp(<span class="string">'   Closing all gaps at maximum speed'</span>);
0915 
0916                 <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0917                 [Position, Velocity, RunFlag, UserGap] = <a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>;
0918 
0919                 <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], UserGap, maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0920 
0921                 <span class="comment">% Turn velocity profile on</span>
0922                 disp(<span class="string">'   Insertion device velocity profile boolean control is on'</span>);
0923                 <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], [], maxsp(<span class="string">'IDvel'</span>), 1, 1, 0);
0924 
0925                 disp(<span class="string">'   Gaps are closed'</span>);
0926                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([4;7;8;9;10;12], 1, 1);
0927                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>(5, 1, 0);
0928                 disp(<span class="string">'   Gap control enabled (except sector 5 (W16))'</span>);
0929             <span class="keyword">end</span>
0930 
0931             <a href="set_alarmhandler_thresholds_new.html" class="code" title="function set_alarmhandler_thresholds_new">set_alarmhandler_thresholds_new</a>;
0932             setpv(<span class="string">'SR_STATE'</span>,3);
0933 
0934         <span class="keyword">catch</span>
0935 
0936             fprintf(<span class="string">'   %s \n'</span>, lasterr);
0937             fprintf(<span class="string">'   User lattice setup failed due to error condition! \n\n'</span>);
0938             setpv(<span class="string">'SR_STATE'</span>,-3);
0939 
0940         <span class="keyword">end</span>
0941 
0942         a = clock;
0943         datestr1=date;
0944         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0945         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0946         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0947         <span class="keyword">if</span> StateNumber &gt;= 0
0948             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0949             disp([<span class="string">'   **************************************************************************'</span>]);
0950             disp([<span class="string">'   **  Function complete:  the storage ring is setup for users at '</span>,sprintf(<span class="string">'%.1f'</span>,SR_GEV),<span class="string">' GeV  **'</span>]);
0951             disp([<span class="string">'   **************************************************************************'</span>]); fprintf(<span class="string">'\n'</span>);
0952         <span class="keyword">else</span>
0953             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0954             disp([<span class="string">'   *************************************'</span>]);
0955             disp([<span class="string">'   **  Problem with production setup  **'</span>]);
0956             disp([<span class="string">'   *************************************'</span>]); fprintf(<span class="string">'\n'</span>);
0957         <span class="keyword">end</span>
0958         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0959 
0960         setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0961 
0962     <span class="keyword">case</span> <span class="string">'CheckInputs'</span>
0963 
0964         SR_GEV = getfamilydata(<span class="string">'Energy'</span>);
0965         AD=getad;
0966         <a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>; 
0967 
0968         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0969 
0970         <span class="keyword">if</span> AD.Energy &gt; 1.55
0971             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection (Ramp Down)'</span>]);
0972             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users (Ramp Up)'</span>]);
0973         <span class="keyword">elseif</span> AD.Energy &lt; 1.45
0974             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection (Ramp Up+cycle)'</span>]);
0975             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users, '</span>,num2str(round(10*SR_GEV)/10),<span class="string">' GeV (Ramp Down)'</span>]);
0976         <span class="keyword">else</span>
0977             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection'</span>]);
0978             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users, '</span>,num2str(round(10*SR_GEV)/10),<span class="string">' GeV'</span>]);
0979         <span class="keyword">end</span>
0980         set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLTitle'</span>),<span class="string">'String'</span>,SR_Mode);
0981 
0982         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0983         <span class="keyword">if</span> StateNumber &gt;= 0
0984             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0985         <span class="keyword">else</span>
0986             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0987         <span class="keyword">end</span>
0988 
0989         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0990 
0991 
0992     <span class="keyword">case</span> <span class="string">'SRState'</span>
0993         NumErrors = 0;
0994         fprintf(<span class="string">'\n'</span>);
0995         disp(<span class="string">'   ***********************************'</span>);
0996         disp(<span class="string">'   **  Checking Storage Ring State  **'</span>);
0997         disp(<span class="string">'   ***********************************'</span>);
0998         a = clock;
0999         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1000 
1001         <span class="comment">%       FileName = getpv('SR_LATTICE_FILE','String');   % Last srload file name (in OLD MIDDLE LAYER nomenclature!!)</span>
1002 
1003         GeVnow = <a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>;
1004         <span class="keyword">if</span> GeVnow == getfamilydata(<span class="string">'Energy'</span>)
1005             [ConfigSetpoint, ConfigMonitor, FileName] = getproductionlattice;
1006         <span class="keyword">elseif</span> GeVnow == getfamilydata(<span class="string">'InjectionEnergy'</span>)
1007             [ConfigSetpoint, ConfigMonitor, FileName] = getinjectionlattice;
1008         <span class="keyword">else</span>
1009             FileName = <span class="string">''</span>;
1010         <span class="keyword">end</span>
1011 
1012         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1013         fprintf(<span class="string">'   Storage ring operational mode: %s\n'</span>, SR_Mode);
1014         <span class="keyword">if</span> StateNumber &lt; 0
1015             fprintf(<span class="string">'   Storage ring state error: %s\n'</span>, StateString);
1016             NumErrors = NumErrors + 1;
1017         <span class="keyword">else</span>
1018             fprintf(<span class="string">'   Storage ring state: %s\n'</span>, StateString);
1019         <span class="keyword">end</span>
1020         <span class="keyword">if</span> StateNumber==0
1021             <span class="comment">% Storage ring state unknown</span>
1022             NumErrors = NumErrors + 1;
1023         <span class="keyword">elseif</span> abs(StateNumber)==1 || abs(StateNumber)==2
1024             FileNameGoal = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>) getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'InjectionFile'</span>) <span class="string">'.mat'</span>];
1025             <span class="keyword">if</span> ~strcmp(FileName, FileNameGoal)
1026                 fprintf(<span class="string">'   Lattice file %s should be loaded but it appears that %s is loaded.\n'</span>, getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'InjectionFile'</span>), FileName);
1027                 NumErrors = NumErrors + 1;
1028             <span class="keyword">end</span>
1029         <span class="keyword">else</span>
1030             FileNameGoal = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>) getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'LatticeFile'</span>) <span class="string">'.mat'</span>];
1031             <span class="keyword">if</span> ~strcmp(FileName, FileNameGoal)
1032                 fprintf(<span class="string">'   Lattice file %s should be loaded but it appears that %s is loaded.\n'</span>, getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'LatticeFile'</span>), FileName);
1033                 NumErrors = NumErrors + 1;
1034             <span class="keyword">end</span>
1035         <span class="keyword">end</span>
1036 
1037 
1038         <span class="comment">% Check all SR magnets</span>
1039         <span class="keyword">if</span> isempty(FileName)
1040             fprintf(<span class="string">'   Goal setpoints will not be checked since the last lattice load is unknown.\n'</span>);
1041             NumErrors1 = <a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>(<span class="string">''</span>);
1042         <span class="keyword">else</span>
1043 <span class="comment">%            NumErrors1 = checksrmags([getfamilydata('Directory','OpsData') FileName]);</span>
1044             NumErrors1 = <a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>(FileName);
1045         <span class="keyword">end</span>
1046         <span class="keyword">if</span> NumErrors1 == 0
1047             fprintf(<span class="string">'   SR magnets power supplies are OK.\n'</span>);
1048         <span class="keyword">end</span>
1049         NumErrors = NumErrors + NumErrors1;
1050 
1051 
1052         <span class="comment">% Check RF frequency</span>
1053         <span class="keyword">if</span> isempty(FileName)
1054             fprintf(<span class="string">'   RF frequency will not be checked since the last lattice load is unknown.\n'</span>);
1055         <span class="keyword">else</span>
1056 <span class="comment">%            load([getfamilydata('Directory','OpsData'), FileName]);</span>
1057             load(FileName);
1058             [tmp, RFHPCounterPresent] = getrf;
1059             <span class="keyword">if</span> abs(RFHPCounterPresent-ConfigSetpoint.RF.Setpoint.Data) &gt; .002
1060                 NumErrors = NumErrors + 1;
1061                 fprintf(<span class="string">'   RF frequency should be %f, presently it is %f MHz (as measured by the HP counter).\n'</span>, ConfigSetpoint.RF.Setpoint.Data, RFHPCounterPresent);
1062             <span class="keyword">else</span>
1063                 fprintf(<span class="string">'   RF frequency is OK (HP counter is %f MHz, at the time of the lattice save it was %f MHz).\n'</span>, RFHPCounterPresent, ConfigSetpoint.RF.Setpoint.Data);
1064             <span class="keyword">end</span>
1065         <span class="keyword">end</span>
1066 
1067 
1068         <span class="comment">% Check for orbit problems</span>
1069         <span class="keyword">if</span> (StateNumber &gt;= 3) &amp; (getdcct &gt; 2)   <span class="comment">% Production lattice is loaded with beam in the machine</span>
1070             Xtol = 0.070;
1071             Ytol = 0.010;
1072             NumErrors1 = <a href="checksrorbit.html" class="code" title="function ErrorNums = checksrorbit(SectorList, BPMxtol,BPMytol)">checksrorbit</a>([],Xtol,Ytol);
1073             <span class="keyword">if</span> NumErrors1
1074                 fprintf(<span class="string">'   SR orbit in the ID straight sections or at Bergoz BPMs deviates more than allowed from the golden orbit.\n'</span>);
1075             <span class="keyword">else</span>
1076                 fprintf(<span class="string">'   SR orbit in the ID straight sections and at Bergoz BPMs is OK.\n'</span>);
1077                 fprintf(<span class="string">'   The orbit is within %.3f mm horizontally and %.3f mm vertically'</span>, Xtol, Ytol);
1078             <span class="keyword">end</span>
1079             NumErrors = NumErrors + NumErrors1;
1080         <span class="keyword">else</span>
1081             fprintf(<span class="string">'   Storage ring orbit was not checked.\n'</span>);
1082         <span class="keyword">end</span>
1083 
1084 
1085         a = clock;
1086         datestr1=date;
1087         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
1088         <span class="keyword">if</span> NumErrors
1089             disp(<span class="string">'   *********************************'</span>);
1090             disp(<span class="string">'   **  Storage Ring Has Problems  **'</span>);
1091             disp(<span class="string">'   *********************************'</span>);
1092         <span class="keyword">else</span>
1093             disp(<span class="string">'   **********************************'</span>);
1094             disp(<span class="string">'   **  Storage Ring Lattice is OK  **'</span>);
1095             disp(<span class="string">'   **********************************'</span>);
1096         <span class="keyword">end</span>
1097         fprintf(<span class="string">'   \n'</span>);
1098 
1099         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1100         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1101         <span class="keyword">if</span> StateNumber &gt;= 0
1102             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1103         <span class="keyword">else</span>
1104             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1105         <span class="keyword">end</span>
1106         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1107 
1108 
1109     <span class="keyword">case</span> <span class="string">'OrbitCorrection'</span>
1110         fprintf(<span class="string">'\n'</span>);
1111         fprintf(<span class="string">'   *********************************\n'</span>);
1112         fprintf(<span class="string">'   **  Starting Orbit Correction  **\n'</span>);
1113         fprintf(<span class="string">'   *********************************\n'</span>);
1114         a = clock;
1115         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1116 
1117         StartFlag = questdlg(sprintf(<span class="string">'Start orbit correction, %.1f GeV?'</span>,SR_GEV),<span class="string">'Orbit Correction'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
1118         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
1119             disp([<span class="string">'   ********************************'</span>]);
1120             disp([<span class="string">'   **  Orbit Correction Aborted  **'</span>]);
1121             disp([<span class="string">'   ********************************'</span>]);
1122             fprintf(<span class="string">'\n'</span>);
1123             <span class="keyword">return</span>
1124         <span class="keyword">end</span>
1125 
1126         <span class="keyword">if</span> getdcct &lt; 5     <span class="comment">% Don't correct the orbit if the current is too small</span>
1127             fprintf(<span class="string">'   Orbit not corrected due to small current.\n'</span>);
1128             <span class="keyword">return</span>
1129         <span class="keyword">end</span>
1130 
1131         <span class="keyword">if</span> abs(SR_GEV-<a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>(getpv(<span class="string">'BEND'</span>,[1 1])))&gt;  0.05     <span class="comment">% Don't use this routine for the injection lattice</span>
1132             fprintf(<span class="string">'   This routine should only be used for the production energy: Correction aborted\n'</span>);
1133             <span class="keyword">return</span>
1134         <span class="keyword">end</span>
1135 
1136         SR_STATE_OLD = scaget(<span class="string">'SR_STATE'</span>);
1137         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1138         setpv(<span class="string">'SR_STATE'</span>,4);
1139         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1140         <span class="keyword">if</span> StateNumber &gt;= 0
1141             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1142         <span class="keyword">else</span>
1143             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1144         <span class="keyword">end</span>
1145         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1146 
1147 
1148         <span class="keyword">try</span>
1149 
1150             <span class="comment">% 2 Hz update rate on IDBPMs</span>
1151             disp(<span class="string">'   IDBPM time constant set to 0.5s.'</span>)
1152             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.5)
1153             pause(2);
1154 
1155 
1156             <span class="comment">% Turn off feed forward</span>
1157             fprintf(<span class="string">'   Turning feed forward off.\n'</span>);
1158             [FFEnableBM, FFEnableBC] = <a href="getff.html" class="code" title="function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)">getff</a>;
1159             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0);
1160             scasleep(.2);
1161 
1162 
1163             <span class="comment">% Get vectors</span>
1164             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>);
1165             LocalBumplist = FB.LocalBumplist;
1166 
1167         <span class="keyword">catch</span>
1168 
1169             fprintf(<span class="string">'   %s \n'</span>,lasterr);
1170             fprintf(<span class="string">'   Orbit correction setup failed due to error condition! \n\n'</span>);
1171             setpv(<span class="string">'SR_STATE'</span>,-4);
1172             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1173             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1174             <span class="keyword">if</span> StateNumber &gt;= 0
1175                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1176             <span class="keyword">else</span>
1177                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1178             <span class="keyword">end</span>
1179             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1180             <span class="keyword">return</span>
1181 
1182         <span class="keyword">end</span>
1183 
1184         iNotHCMChicane = find(FB.HCMlist1(:,2) &lt; 10); <span class="comment">%used by steppv's for setting correctors in loop</span>
1185         iHCMChicane = find(FB.HCMlist1(:,2) == 10);
1186         iNotVCMChicane = find(FB.VCMlist1(:,2) &lt; 10);
1187         iVCMChicane = find(FB.VCMlist1(:,2) == 10);
1188 
1189         fprintf(<span class="string">'   Starting horizontal and vertical global orbit correction (SVD method).\n'</span>);
1190 
1191         <span class="keyword">for</span> iloop = 1:3
1192             <span class="keyword">try</span>
1193                 <span class="comment">% use the following to get corrector settings in OCS without setting them, so the values can be checked</span>
1194                 FB.OCSx = setorbit(FB.OCSx,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1195                 FB.OCSy = setorbit(FB.OCSy,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1196                 <span class="keyword">if</span> any(abs(FB.OCSx.CM.Delta(iNotHCMChicane)) &gt; 5)
1197                   disp(<span class="string">'   Orbit Correction is changing some horizontal corrector(s) &gt; 5A!!'</span>);
1198                 <span class="keyword">end</span>
1199                 <span class="keyword">if</span> any(abs(FB.OCSy.CM.Delta(iNotVCMChicane)) &gt; 5)
1200                   disp(<span class="string">'   Orbit Correction is changing some vertical corrector(s) &gt; 5A!!'</span>);
1201                 <span class="keyword">end</span>
1202                 <span class="keyword">if</span> any(abs(FB.OCSx.CM.Delta(iHCMChicane)) &gt; 10)
1203                   disp(<span class="string">'   Orbit Correction is changing some horizontal chicane corrector(s) &gt; 10A!!'</span>);
1204                 <span class="keyword">end</span>
1205                 <span class="keyword">if</span> any(abs(FB.OCSy.CM.Delta(iVCMChicane)) &gt; 10)
1206                   disp(<span class="string">'   Orbit Correction is changing some vertical chicane corrector(s) &gt; 10A!!'</span>);
1207                 <span class="keyword">end</span>
1208 
1209 
1210                 <span class="comment">% Correct horizontal orbit</span>
1211                 FB.OCSx = setorbit(FB.OCSx,<span class="string">'NoDisplay'</span>);
1212                 <span class="comment">% Correct vertical orbit</span>
1213                 FB.OCSy = setorbit(FB.OCSy,<span class="string">'NoDisplay'</span>);
1214 
1215 
1216                 <span class="comment">% Check for current in machine - stop orbit correction if DCCT &lt; 5mA</span>
1217                 <span class="keyword">if</span> (getdcct &lt; 4.5)
1218                     error(<span class="string">'**There is less than 5mA in the machine! Stopping orbit correction.'</span>);
1219                 <span class="keyword">end</span>
1220 
1221                 <span class="comment">% Check state of gaps - stop orbit correction if any are moving</span>
1222                 GAPrunflag = getpv(<span class="string">'ID'</span>,<span class="string">'RunFlag'</span>);
1223                 <span class="keyword">if</span> any(GAPrunflag-round(GAPrunflag))
1224                     error(<span class="string">'**One or more of the gaps are moving! Stopping orbit correction.'</span>);
1225                 <span class="keyword">end</span>
1226 
1227                 x = FB.OCSx.GoalOrbit - getx(FB.OCSx.BPM.DeviceList);
1228                 y = FB.OCSy.GoalOrbit - gety(FB.OCSy.BPM.DeviceList);
1229                 fprintf(<span class="string">'   %d. Horizontal RMS = %.3f mm\n'</span>, iloop, norm(x)/sqrt(length(x)));
1230                 fprintf(<span class="string">'   %d.   Vertical RMS = %.3f mm\n'</span>, iloop, norm(y)/sqrt(length(y)));
1231 
1232             <span class="keyword">catch</span>
1233                 <span class="comment">% fprintf('   %s \n',lasterr);</span>
1234                 fprintf(<span class="string">'   Orbit correction failed due to error condition!\n  Fix the problem, reload the lattice (srload), and try again.  \n\n'</span>);
1235                 setpv(<span class="string">'SR_STATE'</span>,-4);
1236                 set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1237                 [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1238                 <span class="keyword">if</span> StateNumber &gt;= 0
1239                     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1240                 <span class="keyword">else</span>
1241                     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1242                 <span class="keyword">end</span>
1243                 set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1244                 <span class="keyword">return</span>
1245             <span class="keyword">end</span>
1246         <span class="keyword">end</span>
1247 
1248 
1249         <span class="comment">% Set user bumps w/o sextupole correctors</span>
1250         <span class="keyword">try</span>
1251 
1252             <span class="comment">%turn up corrector speed here to quicken setting bumps</span>
1253             HCMramprate = getpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>);
1254             VCMramprate = getpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>);
1255             setpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>, 10, [], 0);
1256             setpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>, 10, [], 0);
1257             
1258             <span class="keyword">if</span> ~isempty(LocalBumplist)
1259                 fprintf(<span class="string">'   Setting local bumps in the straight sections.\n'</span>);
1260                 <span class="keyword">for</span> loop = 1:size(LocalBumplist,1)
1261 
1262                     <span class="comment">% Check for current in machine - stop orbit correction if DCCT &lt; 5mA</span>
1263                     <span class="keyword">if</span> (getdcct &lt; 5)
1264                         error(<span class="string">'** There is less than 5mA in the machine! Stopping local bumps.'</span>);
1265                     <span class="keyword">end</span>
1266 
1267                     <span class="comment">% Check state of gaps - stop setting bumps if any are moving</span>
1268                     GAPrunflag = getpv(<span class="string">'ID'</span>,<span class="string">'RunFlag'</span>);
1269                     <span class="keyword">if</span> any(GAPrunflag-round(GAPrunflag))
1270                         error(<span class="string">'** One or more of the gaps are moving! Stopping local bumps.'</span>);
1271                     <span class="keyword">end</span>
1272 
1273                     HCMoldsp = getsp(<span class="string">'HCM'</span>, FB.HCMlist1);
1274                     VCMoldsp = getsp(<span class="string">'VCM'</span>, FB.VCMlist1);
1275 
1276                     <span class="keyword">if</span> any(LocalBumplist(loop,1) == [4 6 11])
1277                         <span class="keyword">if</span> LocalBumplist(loop,2) == 0
1278                             <span class="comment">% Upstream bump</span>
1279                             [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1)-1 11;LocalBumplist(loop,1)-1 12;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1280                             <span class="keyword">if</span> isempty(iRemove)
1281                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1282                             <span class="keyword">else</span>
1283                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1284                             <span class="keyword">end</span>
1285                         <span class="keyword">elseif</span> LocalBumplist(loop,2) == 1
1286                             <span class="comment">% Upstream bump</span>
1287                             [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1)-1 11;],FB.OCSx.BPM.DeviceList);
1288                             <span class="keyword">if</span> isempty(iRemove)
1289                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1290                             <span class="keyword">else</span>
1291                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1292                             <span class="keyword">end</span>
1293                         <span class="keyword">else</span>
1294                             <span class="comment">% Downstream bump</span>
1295                             [i, iRemove] = findrowindex([LocalBumplist(loop,1)-1 12;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1296                             <span class="keyword">if</span> isempty(iRemove)
1297                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1298                             <span class="keyword">else</span>
1299                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1300                             <span class="keyword">end</span>
1301                         <span class="keyword">end</span>
1302                     <span class="keyword">else</span>
1303                         [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1304                         <span class="keyword">if</span> isempty(iRemove)
1305                             <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1306                         <span class="keyword">else</span>
1307                             fprintf(<span class="string">'\n   BPMs missing from Sector %02d - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,1));
1308                         <span class="keyword">end</span>
1309                     <span class="keyword">end</span>
1310                     
1311                     HCMnewsp = getsp(<span class="string">'HCM'</span>, FB.HCMlist1);
1312                     VCMnewsp = getsp(<span class="string">'VCM'</span>, FB.VCMlist1);
1313                     <span class="comment">% Remove center chicane trim from corrector check</span>
1314                     <span class="keyword">if</span> (max(abs(HCMoldsp(iNotHCMChicane)-HCMnewsp(iNotHCMChicane))) &gt; 5) | (max(abs(VCMoldsp(iNotVCMChicane)-VCMnewsp(iNotVCMChicane))) &gt; 10)
1315                         error(<span class="string">'**Setbumps caused some corrector magnet currents to change by more than 5(Horiz)/10(Vert) A!'</span>);
1316                     <span class="keyword">end</span>
1317                     <span class="comment">% Now check center chicane trims</span>
1318                     <span class="keyword">if</span> (max(abs(HCMoldsp(iNotHCMChicane)-HCMnewsp(iNotHCMChicane))) &gt; 10) | (max(abs(VCMoldsp(iNotVCMChicane)-VCMnewsp(iNotVCMChicane))) &gt; 15)
1319                         error(<span class="string">'**Setbumps caused some chicane trim magnet currents to change by more than 10(Horiz)/15(Vert) A!'</span>);
1320                     <span class="keyword">end</span>
1321                 <span class="keyword">end</span>
1322             <span class="keyword">end</span>
1323 
1324             <span class="comment">%restore corrector speeds</span>
1325             setpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>, HCMramprate, [], 0);
1326             setpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>, VCMramprate, [], 0);
1327 
1328         <span class="keyword">catch</span>
1329             fprintf(<span class="string">'   %s \n'</span>,lasterr);
1330             fprintf(<span class="string">'   Setbumps failed due to error condition!  Fix the problem, reload the lattice (srload), and try again.\n\n'</span>);
1331             setpv(<span class="string">'SR_STATE'</span>,-4);
1332             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1333             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1334             <span class="keyword">if</span> StateNumber &gt;= 0
1335                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1336             <span class="keyword">else</span>
1337                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1338             <span class="keyword">end</span>
1339             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1340             <span class="keyword">return</span>
1341         <span class="keyword">end</span>
1342 
1343 
1344         <span class="comment">% Turn feed forward back to it's original state</span>
1345         <span class="keyword">if</span> any(FFEnableBC)
1346             fprintf(<span class="string">'   Turning feed forward back on.\n'</span>);
1347             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], FFEnableBC);
1348         <span class="keyword">end</span>
1349 
1350 
1351         a = clock;
1352         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1353         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1354         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1355         <span class="keyword">if</span> StateNumber &gt;= 0
1356             setpv(<span class="string">'SR_STATE'</span>,4.1);
1357             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1358             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1359             fprintf(<span class="string">'   *********************************\n'</span>);
1360             fprintf(<span class="string">'   **  Orbit Correction Complete  **\n'</span>);
1361             fprintf(<span class="string">'   *********************************\n\n'</span>);
1362         <span class="keyword">else</span>
1363             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1364             fprintf(<span class="string">'   *************************************\n'</span>);
1365             fprintf(<span class="string">'   **  Problem With Orbit Correction  **\n'</span>);
1366             fprintf(<span class="string">'   *************************************\n\n'</span>);
1367         <span class="keyword">end</span>
1368         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1369         pause(0);
1370 
1371 
1372     <span class="keyword">case</span> <span class="string">'OrbitCorrectionSetup'</span>
1373         InitFlag = Input2;           <span class="comment">% Input #2: if InitFlag, then initialize variables</span>
1374 
1375         <span class="keyword">if</span> InitFlag
1376             <span class="comment">% Setup feedback elements</span>
1377             <span class="comment">% disp('Orbit correction condition: InitFlag=1 -- debugging message');</span>
1378 
1379             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1380             <span class="comment">% Edit the following lists to change default configuration of Orbit Correction %</span>
1381             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1382             hlist=[];vlist=[];
1383             <span class="keyword">for</span> Sector =1:12
1384                 <span class="keyword">if</span> Sector == 1
1385                     vlist = [vlist;Sector 2;Sector 4;Sector 5;Sector 8];
1386                     hlist = [hlist;Sector 2;Sector 7];
1387                 <span class="keyword">elseif</span> Sector == 3
1388                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];
1389                     hlist = [hlist;Sector 2;Sector 7;Sector 10];
1390                 <span class="keyword">elseif</span> Sector == 5
1391 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];</span>
1392 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7;Sector 10];</span>
1393                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8]; <span class="comment">%remove HCM and VCM(5,10) since corrector is not controlling starting 4-6-07</span>
1394                     hlist = [hlist;Sector 2;Sector 7];
1395                 <span class="keyword">elseif</span> Sector == 10
1396                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];
1397                     hlist = [hlist;Sector 2;Sector 7;Sector 10];
1398                 <span class="keyword">elseif</span> Sector == 12
1399                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 7];
1400                     hlist = [hlist;Sector 2;Sector 7];
1401                 <span class="keyword">else</span>
1402                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8];
1403                     hlist = [hlist;Sector 2;Sector 7];
1404                 <span class="keyword">end</span>
1405             <span class="keyword">end</span>
1406             HCMlist1 = hlist;
1407             VCMlist1 = vlist;
1408 
1409             BPMlist1 = [
1410                 1 2
1411                 1 5
1412                 1 6
1413                 1 10
1414                 2 1
1415                 2 5
1416                 2 6
1417                 2 9
1418                 3 2
1419                 3 5
1420                 3 6
1421                 3 10
1422                 3 11
1423                 3 12
1424                 4 1
1425                 4 5
1426                 4 6
1427                 4 10
1428                 5 1
1429                 5 5
1430                 5 6
1431                 5 10
1432 <span class="comment">%                 5 11</span>
1433 <span class="comment">%                 5 12</span>
1434                 6 1
1435                 6 5
1436                 6 6
1437                 6 10
1438                 7 1
1439                 7 5
1440                 7 6
1441                 7 10
1442                 8 1
1443                 8 5
1444                 8 6
1445                 8 10
1446                 9 1
1447                 9 5
1448                 9 6
1449                 9 10
1450                 10 1
1451                 10 5
1452                 10 6
1453                 10 10
1454                 10 11
1455                 10 12
1456                 11 1
1457                 11 5
1458                 11 6
1459                 11 10
1460                 12 1
1461                 12 5
1462                 12 6
1463                 12 9];
1464 
1465             <span class="comment">% SVD orbit correction</span>
1466             Xivec = [1:27];
1467             Yivec = [1:48];
1468 
1469 
1470             LocalBumplist = [
1471               <span class="comment">% 1 1</span>
1472               <span class="comment">% 2 1</span>
1473               <span class="comment">% 3 1</span>
1474                 4 1
1475               <span class="comment">% 4 2</span>
1476                 5 1
1477               <span class="comment">% 6 1</span>
1478               <span class="comment">% 6 2</span>
1479                 7 1
1480                 8 1
1481                 9 1
1482                 10 1
1483                 11 1
1484                 11 2
1485                 12 1
1486 ];
1487             <span class="comment">%LocalBumplist = []</span>
1488             
1489             <span class="comment">% initialize RFCorrFlag</span>
1490             RFCorrFlag = <span class="string">'Yes'</span>;
1491         <span class="keyword">else</span>
1492 
1493             <span class="comment">% Get vectors</span>
1494             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>);
1495             BPMlist1 = FB.BPMlist1;
1496             HCMlist1 = FB.HCMlist1;
1497             VCMlist1 = FB.VCMlist1;
1498             Xivec = FB.Xivec;
1499             Yivec = FB.Yivec;
1500             LocalBumplist = FB.LocalBumplist;
1501             Xgoal = FB.Xgoal;
1502             Ygoal = FB.Ygoal;
1503             RFCorrFlag = FB.RFCorrFlag;
1504 
1505             <span class="comment">% Add button to change #ivectors, CMs, IDBPMs,</span>
1506             EditFlag = 0;
1507             h_fig1 = figure;
1508             <span class="keyword">while</span> EditFlag ~= 8
1509 
1510                 <span class="comment">% Sensitivity matrix</span>
1511                 Sx = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
1512                 Sy = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
1513                 
1514                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1515                 <span class="comment">% Can the call below work for setting FOFB RF parameter? %</span>
1516                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1517                 <span class="keyword">if</span> strcmpi(RFCorrFlag, <span class="string">'Yes'</span>)
1518                     Sx = [Sx getdisp(<span class="string">'BPMx'</span>,BPMlist1)];
1519                 <span class="keyword">end</span>
1520                 
1521                 [Ux, SVx, Vx] = svd(Sx);
1522                 [Uy, SVy, Vy] = svd(Sy);
1523 
1524 
1525                 <span class="comment">% Remove singular values greater than the actual number of singular values</span>
1526                 i = find(Xivec&gt;length(diag(SVx)));
1527                 <span class="keyword">if</span> ~isempty(i)
1528                     disp(<span class="string">'   Horizontal E-vector scaled since there were more elements in the vector than singular values.'</span>);
1529                     pause(0);
1530                     Xivec(i) = [];
1531                 <span class="keyword">end</span>
1532                 i = find(Yivec&gt;length(diag(SVy)));
1533                 <span class="keyword">if</span> ~isempty(i)
1534                     disp(<span class="string">'   Vertical E-vector scaled since there were more elements in the vector than singular values.'</span>);
1535                     pause(0);
1536                     Yivec(i) = [];
1537                 <span class="keyword">end</span>
1538 
1539 
1540                 Ax = Sx*Vx(:,Xivec);
1541                 Tx = inv(Ax'*Ax)*Ax';
1542 
1543                 Ay = Sy*Vy(:,Yivec);
1544                 Ty = inv(Ay'*Ay)*Ay';
1545 
1546 
1547                 figure(h_fig1);
1548                 subplot(2,1,1);
1549                 semilogy(diag(SVx),<span class="string">'b'</span>);
1550                 hold on;
1551                 semilogy(diag(SVx(Xivec,Xivec)),<span class="string">'xr'</span>);
1552                 ylabel(<span class="string">'Horizontal'</span>);
1553                 title(<span class="string">'Response Matrix Singular Values'</span>);
1554                 hold off;
1555                 subplot(2,1,2);
1556                 semilogy(diag(SVy),<span class="string">'b'</span>);
1557                 hold on;
1558                 semilogy(diag(SVy(Yivec,Yivec)),<span class="string">'xr'</span>);
1559                 xlabel(<span class="string">'Singular Value Number'</span>);
1560                 ylabel(<span class="string">'Vertical'</span>);
1561                 hold off;
1562                 drawnow;
1563 
1564                 <span class="keyword">if</span> strcmp(RFCorrFlag,<span class="string">'No'</span>)
1565                     RFCorrState = <span class="string">'NOT CORRECTED'</span>;
1566                 <span class="keyword">elseif</span> strcmp(RFCorrFlag,<span class="string">'Yes'</span>)
1567                     RFCorrState = <span class="string">'CORRECTED'</span>;
1568                 <span class="keyword">else</span>
1569                     RFCorrState = <span class="string">'???'</span>;
1570                 <span class="keyword">end</span>
1571 
1572                 <span class="comment">%         EditFlag = menu('Change Parameters?','Singular Values','HCM List','VCM List','HCM Chicane List','VCM Chicane List','IDBPM List','BBPM List','Change Golden Orbit',...</span>
1573                 <span class="comment">%            'Local Bump List',sprintf('RF Frequency (currently %s)',RFCorrState),'Continue');</span>
1574                 EditFlag = menu(<span class="string">'Change Parameters?'</span>,<span class="string">'Singular Values'</span>,<span class="string">'HCM List'</span>,<span class="string">'VCM List'</span>,<span class="string">'BPM List'</span>,<span class="string">'Change Golden Orbit'</span>,<span class="keyword">...</span>
1575                     <span class="string">'Local Bump List'</span>,sprintf(<span class="string">'RF Frequency (currently %s)'</span>,RFCorrState),<span class="string">'Continue'</span>);
1576 
1577                 <span class="keyword">if</span> EditFlag == 1
1578                     prompt={<span class="string">'Enter the horizontal E-vector numbers (Matlab vector format):'</span>,<span class="string">'Enter the vertical E-vector numbers (Matlab vector format):'</span>};
1579                     def={sprintf(<span class="string">'[%d:%d]'</span>,1,Xivec(end)),sprintf(<span class="string">'[%d:%d]'</span>,1,Yivec(end))};
1580                     titlestr=<span class="string">'SVD Orbit Feedback'</span>;
1581                     lineNo=1;
1582                     answer=inputdlg(prompt,titlestr,lineNo,def);
1583                     <span class="keyword">if</span> ~isempty(answer)
1584                         XivecNew = fix(str2num(answer{1}));
1585                         <span class="keyword">if</span> isempty(XivecNew)
1586                             disp(<span class="string">'   Horizontal E-vector cannot be empty.  No change made.'</span>);
1587                         <span class="keyword">else</span>
1588                             <span class="keyword">if</span> any(XivecNew&lt;=0) | max(XivecNew)&gt;length(diag(SVx))
1589                                 disp(<span class="string">'   Error reading horizontal E-vector.  No change made.'</span>);
1590                             <span class="keyword">else</span>
1591                                 Xivec = XivecNew;
1592                             <span class="keyword">end</span>
1593                         <span class="keyword">end</span>
1594                         YivecNew = fix(str2num(answer{2}));
1595                         <span class="keyword">if</span> isempty(YivecNew)
1596                             disp(<span class="string">'   Vertical E-vector cannot be empty.  No change made.'</span>);
1597                         <span class="keyword">else</span>
1598                             <span class="keyword">if</span> any(YivecNew&lt;=0) | max(YivecNew)&gt;length(diag(SVy))
1599                                 disp(<span class="string">'   Error reading vertical E-vector.  No change made.'</span>);
1600                             <span class="keyword">else</span>
1601                                 Yivec = YivecNew;
1602                             <span class="keyword">end</span>
1603                         <span class="keyword">end</span>
1604                     <span class="keyword">end</span>
1605                 <span class="keyword">end</span>
1606 
1607                 <span class="keyword">if</span> EditFlag == 2
1608                     List = getlist(<span class="string">'HCM'</span>);
1609                     CheckList = zeros(size(List,1));
1610                     Elem = dev2elem(<span class="string">'HCM'</span>, HCMlist1);
1611                     CheckList(Elem) = ones(size(Elem));
1612                     CheckList = CheckList(dev2elem(<span class="string">'HCM'</span>,List));
1613                     newList = editlist(List, <span class="string">'HCM'</span>, CheckList);
1614                     <span class="keyword">if</span> isempty(newList)
1615                         fprintf(<span class="string">'   Horizontal corrector magnet list cannot be empty.  No change made.\n'</span>);
1616                     <span class="keyword">else</span>
1617                         HCMlist1 = newList;
1618                     <span class="keyword">end</span>
1619                 <span class="keyword">end</span>
1620 
1621                 <span class="keyword">if</span> EditFlag == 3
1622                     List = getlist(<span class="string">'VCM'</span>);
1623                     CheckList = zeros(size(List,1));
1624                     Elem = dev2elem(<span class="string">'VCM'</span>, VCMlist1);
1625                     CheckList(Elem) = ones(size(Elem));
1626                     CheckList = CheckList(dev2elem(<span class="string">'VCM'</span>,List));
1627                     newList = editlist(List, <span class="string">'VCM'</span>, CheckList);
1628                     <span class="keyword">if</span> isempty(newList)
1629                         fprintf(<span class="string">'   Vertical corrector magnet cannot be empty.  No change made.\n'</span>);
1630                     <span class="keyword">else</span>
1631                         VCMlist1 = newList;
1632                     <span class="keyword">end</span>
1633                 <span class="keyword">end</span>
1634 
1635                 <span class="keyword">if</span> EditFlag == 4
1636                     ListOld = BPMlist1;
1637                     XgoalOld = Xgoal;
1638                     YgoalOld = Ygoal;
1639 
1640                     <span class="comment">% Full BPM list</span>
1641                     List = [
1642                         1 2
1643                         1 5
1644                         1 6
1645                         1 10
1646                         2 1
1647                         2 5
1648                         2 6
1649                         2 9
1650                         3 2
1651                         3 5
1652                         3 6
1653                         3 10
1654                         3 11
1655                         3 12
1656                         4 1
1657                         4 5
1658                         4 6
1659                         4 10
1660                         5 1
1661                         5 5
1662                         5 6
1663                         5 10
1664                         5 11
1665                         5 12
1666                         6 1
1667                         6 5
1668                         6 6
1669                         6 10
1670                         7 1
1671                         7 5
1672                         7 6
1673                         7 10
1674                         8 1
1675                         8 5
1676                         8 6
1677                         8 10
1678                         9 1
1679                         9 5
1680                         9 6
1681                         9 10
1682                         10 1
1683                         10 5
1684                         10 6
1685                         10 10
1686                         10 11
1687                         10 12
1688                         11 1
1689                         11 5
1690                         11 6
1691                         11 10
1692                         12 1
1693                         12 5
1694                         12 6
1695                         12 9
1696                         ];
1697 
1698                     CheckList = zeros(size(List,1),1);
1699                     <span class="keyword">if</span> ~isempty(BPMlist1)
1700                         <span class="keyword">for</span> i = 1:size(List,1)
1701                             k = find(List(i,1)==BPMlist1(:,1));
1702                             l = find(List(i,2)==BPMlist1(k,2));
1703 
1704                             <span class="keyword">if</span> isempty(k) | isempty(l)
1705                                 <span class="comment">% Item not in list</span>
1706                             <span class="keyword">else</span>
1707                                 CheckList(i) = 1;
1708                             <span class="keyword">end</span>
1709                         <span class="keyword">end</span>
1710                     <span class="keyword">end</span>
1711 
1712                     newList = editlist(List, <span class="string">'BPM'</span>, CheckList);
1713                     <span class="keyword">if</span> isempty(newList)
1714                         fprintf(<span class="string">'   BPM list cannot be empty.  No change made.\n'</span>);
1715                     <span class="keyword">else</span>
1716                         BPMlist1 = newList;
1717                     <span class="keyword">end</span>
1718 
1719                     <span class="comment">% Set the goal orbit to the golden orbit</span>
1720                     Xgoal = getgolden(<span class="string">'BPMx'</span>, BPMlist1);
1721                     Ygoal = getgolden(<span class="string">'BPMy'</span>, BPMlist1);
1722 
1723 
1724                     <span class="comment">% If a new BPM is added, then set the goal orbit to the golden orbit</span>
1725                     <span class="keyword">for</span> i = 1:size(BPMlist1,1)
1726 
1727                         <span class="comment">% Is it a new BPM?</span>
1728                         k = find(BPMlist1(i,1)==ListOld(:,1));
1729                         l = find(BPMlist1(i,2)==ListOld(k,2));
1730 
1731                         <span class="keyword">if</span> isempty(k) | isempty(l)
1732                             <span class="comment">% New BPM</span>
1733                         <span class="keyword">else</span>
1734                             <span class="comment">% Use the old value for old BPM</span>
1735                             Xgoal(i) = XgoalOld(k(l));
1736                             Ygoal(i) = YgoalOld(k(l));
1737                         <span class="keyword">end</span>
1738                     <span class="keyword">end</span>
1739                 <span class="keyword">end</span>
1740 
1741                 <span class="keyword">if</span> EditFlag == 5
1742 
1743                     ChangeList = editlist(BPMlist1, <span class="string">'Change BPM'</span>, zeros(size(BPMlist1,1),1));
1744                     <span class="keyword">for</span> i = 1:size(ChangeList,1)
1745 
1746                         k = find(ChangeList(i,1)==BPMlist1(:,1));
1747                         l = find(ChangeList(i,2)==BPMlist1(k,2));
1748 
1749                         prompt = {sprintf(<span class="string">'Enter the new horizontal goal orbit for BPMx(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2)),sprintf(<span class="string">'Enter the new vertical goal orbit for BPMy(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2))};
1750                         def = {sprintf(<span class="string">'%f'</span>,Xgoal(k(l))),sprintf(<span class="string">'%f'</span>,Ygoal(k(l)))};
1751                         titlestr = <span class="string">'CHANGE THE GOAL ORBIT'</span>;
1752                         lineNo = 1;
1753                         answer = inputdlg(prompt, titlestr, lineNo, def);
1754 
1755                         <span class="keyword">if</span> isempty(answer)
1756                             <span class="comment">% No change</span>
1757                             fprintf(<span class="string">'   No change was made to the golden orbit.\n'</span>);
1758                         <span class="keyword">else</span>
1759                             Xgoalnew = str2num(answer{1});
1760                             <span class="keyword">if</span> isempty(Xgoalnew)
1761                                 fprintf(<span class="string">'   No change was made to the horizontal golden orbit.\n'</span>);
1762                             <span class="keyword">else</span>
1763                                 Xgoal(k(l)) = Xgoalnew;
1764                             <span class="keyword">end</span>
1765 
1766                             Ygoalnew = str2num(answer{2});
1767                             <span class="keyword">if</span> isempty(Ygoalnew)
1768                                 fprintf(<span class="string">'   No change was made to the vertical golden orbit.\n'</span>);
1769                             <span class="keyword">else</span>
1770                                 Ygoal(k(l)) = Ygoalnew;
1771                             <span class="keyword">end</span>
1772                         <span class="keyword">end</span>
1773                     <span class="keyword">end</span>
1774                     <span class="keyword">if</span> ~isempty(ChangeList)
1775                         fprintf(<span class="string">'   Note:  changing the goal orbit for &quot;Orbit Correction&quot; does not change the goal orbit for &quot;Slow Orbit Feedback.&quot;\n'</span>);
1776                         fprintf(<span class="string">'          Re-running srcontrol will restart the goal orbit to the golden orbit.&quot;\n'</span>);
1777                     <span class="keyword">end</span>
1778                 <span class="keyword">end</span>
1779 
1780                 <span class="keyword">if</span> EditFlag == 6
1781                     List = [
1782                         1 1
1783                         2 1
1784                         3 1
1785                         4 1
1786                         4 2
1787                         5 1
1788                         6 1
1789                         6 2
1790                         7 1
1791                         8 1
1792                         9 1
1793                         10 1
1794                         11 1
1795                         11 2
1796                         12 1];
1797                     CheckList = zeros(size(List,1),1);
1798                     <span class="keyword">if</span> ~isempty(LocalBumplist)
1799                         <span class="keyword">for</span> i = 1:size(List,1)
1800                             k = find(List(i,1)==LocalBumplist(:,1));
1801                             l = find(List(i,2)==LocalBumplist(k,2));
1802 
1803                             <span class="keyword">if</span> isempty(k) | isempty(l)
1804                                 <span class="comment">% Item not in list</span>
1805                             <span class="keyword">else</span>
1806                                 CheckList(i) = 1;
1807                             <span class="keyword">end</span>
1808                         <span class="keyword">end</span>
1809                     <span class="keyword">end</span>
1810                     LocalBumplist = editlist2(List, <span class="string">'Sector'</span>, CheckList);
1811                 <span class="keyword">end</span>
1812 
1813                 <span class="keyword">if</span> EditFlag == 7
1814                     RFCorrFlag = questdlg(sprintf(<span class="string">'Set RF Frequency during Orbit Correction?'</span>),<span class="string">'RF Frequency'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>, <span class="string">'No'</span>);
1815                     <span class="keyword">if</span> strcmp(RFCorrFlag,<span class="string">'No'</span>)
1816                         disp([<span class="string">'   RF Frequency will not be included in global orbit correction.'</span>]);
1817                     <span class="keyword">elseif</span> strcmp(RFCorrFlag,<span class="string">'Yes'</span>)
1818                         disp([<span class="string">'   RF Frequency will be included in global orbit correction.'</span>]);
1819                     <span class="keyword">end</span>
1820 
1821                 <span class="keyword">end</span>
1822             <span class="keyword">end</span>
1823             close(h_fig1);
1824         <span class="keyword">end</span>
1825         
1826 <span class="comment">%  ORBIT CORRECTION STRUCTURE (OCS)</span>
1827 <span class="comment">%    OCS.BPM (data structure)</span>
1828 <span class="comment">%    OCS.CM  (data structure)</span>
1829 <span class="comment">%    OCS.GoalOrbit</span>
1830 <span class="comment">%    OCS.NIter</span>
1831 <span class="comment">%    OCS.SVDIndex</span>
1832 <span class="comment">%    OCS.IncrementalFlag = 'Yes'/'No'</span>
1833 <span class="comment">%    OCS.BPMWeight</span>
1834 <span class="comment">%    OCS.Flags = { 'FitRF' , etc.  }</span>
1835         OCSx.BPM = getx(BPMlist1, <span class="string">'struct'</span>);
1836         OCSx.CM = getsp(<span class="string">'HCM'</span>, HCMlist1, <span class="string">'struct'</span>);
1837         OCSx.GoalOrbit = getgolden(OCSx.BPM, <span class="string">'numeric'</span>);
1838         OCSx.NIter = 1;
1839         OCSx.SVDIndex = Xivec;
1840         OCSx.IncrementalFlag = <span class="string">'No'</span>;
1841         OCSx.FitRF = 1;
1842         OCSy.BPM = gety(BPMlist1, <span class="string">'struct'</span>);
1843         OCSy.CM = getsp(<span class="string">'VCM'</span>, VCMlist1, <span class="string">'struct'</span>);
1844         OCSy.GoalOrbit = getgolden(OCSy.BPM, <span class="string">'numeric'</span>);
1845         OCSy.NIter = 1;
1846         OCSy.SVDIndex = Yivec;
1847         OCSy.IncrementalFlag = <span class="string">'No'</span>;
1848         OCSy.FitRF = 0;
1849 
1850         <span class="comment">% Save vectors</span>
1851         FB.OCSx = OCSx;
1852         FB.OCSy = OCSy;
1853 
1854         FB.BPMlist1 = BPMlist1;
1855         FB.HCMlist1 = HCMlist1;
1856         FB.VCMlist1 = VCMlist1;
1857         FB.Xivec = Xivec;
1858         FB.Yivec = Yivec;
1859         FB.Xgoal = OCSx.GoalOrbit;
1860         FB.Ygoal = OCSy.GoalOrbit;
1861         FB.RFCorrFlag = RFCorrFlag;
1862         FB.LocalBumplist = LocalBumplist;
1863         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>,FB);
1864         
1865         
1866     <span class="keyword">case</span> <span class="string">'Feedback'</span>
1867 
1868         FBloopIter = 1;
1869         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxFOFB'</span>),<span class="string">'Value'</span>) == 1
1870             StartFOFBFlag = 1;
1871         <span class="keyword">else</span>
1872             StartFOFBFlag = 0;
1873         <span class="keyword">end</span>
1874 
1875         FEEDBACK_STOP_FLAG = 0;
1876         HWarnNum=0;
1877         VWarnNum=0;
1878 
1879         SR_GeV = getenergy;
1880         <span class="comment">% Feedback loop setup</span>
1881         PlotInfoFlag = 0;           <span class="comment">% Plot micado stuff</span>
1882         LoopDelay = 1.0;           <span class="comment">% Period of feedback loop [seconds], make sure the BPM averaging is correct</span>
1883         VCM_LSB = .00366211;
1884         VCMCHICANE_LSB = .002441;   <span class="comment">% 80 max?,  Note: not fully implemented</span>
1885 
1886         <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
1887             Xgain  = 0.2;
1888             Ygain  = 0.1;
1889         <span class="keyword">else</span>
1890             Xgain  = 0.8; <span class="comment">% raised 0.5-&gt;0.8 at 17:20, 3-2-05 to more quickly correct EPU4 fast switching orbit distortions</span>
1891             Ygain  = 0.8;
1892         <span class="keyword">end</span>
1893 
1894         <span class="comment">% Load lattice set for tune feed forward</span>
1895         ConfigSetpoint = getproductionlattice;
1896         <span class="comment">%load([getfamilydata('Directory','OpsData') getfamilydata('OpsData','LatticeFile')]);</span>
1897         QFsp = ConfigSetpoint.QF.Setpoint.Data;
1898         QDsp = ConfigSetpoint.QD.Setpoint.Data;
1899         TuneW16Min = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(5, 13.23, 1.8909);
1900         <span class="comment">% Tune response matrix</span>
1901         SR_TUNE_MATRIX = gettuneresp({<span class="string">'QF'</span>,<span class="string">'QD'</span>}, {[],[]}, getenergy(<span class="string">'Production'</span>));    <span class="comment">% Approx. [0.1944 -0.0286;-0.1182 0.1526];</span>
1902         <span class="comment">%SR_TUNE_MATRIX = [0.1641 -0.0245</span>
1903         <span class="comment">%                 -0.1149 0.1477];</span>
1904 
1905         <span class="comment">% ID tune compensation does not work in the injection lattice, so ...</span>
1906         <span class="keyword">if</span> abs(SR_GEV - <a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>)&gt;  0.05     <span class="comment">% Don't use this routine for the injection lattice</span>
1907             fprintf(<span class="string">'   This routine should only be used for the production energy: Orbit feedback aborted\n'</span>);
1908             <span class="keyword">return</span>
1909         <span class="keyword">end</span>
1910 
1911         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1912 
1913         <span class="keyword">try</span>
1914             fprintf(<span class="string">'\n'</span>);
1915             fprintf(<span class="string">'   *******************************\n'</span>);
1916             fprintf(<span class="string">'   **  Starting Orbit Feedback  **\n'</span>);
1917             fprintf(<span class="string">'   *******************************\n'</span>);
1918             a = clock;
1919             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1920             fprintf(<span class="string">'   Note: the Matlab command window will be used to display status information.\n'</span>);
1921             fprintf(<span class="string">'         It cannot be used to enter commands during slow orbit feedback.\n'</span>);
1922 
1923 
1924             <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
1925             disp(<span class="string">'   IDBPM time constant set to 0.2s.'</span>)
1926             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.2)
1927             pause(1.1);
1928 
1929             <span class="comment">% Check whether bumps and kickers are on and warn to turn off before starting feedback if necessary</span>
1930             <span class="keyword">try</span>
1931                 <span class="keyword">if</span> (getsp(<span class="string">'SR01S___BUMP1__BC21'</span>)==1 &amp; getsp(<span class="string">'SR01S___BUMP1P_BC22'</span>)==1) | (getsp(<span class="string">'SR01S___SEK____BC21'</span>)==1 &amp; getsp(<span class="string">'SR01S___SEK_P__BC23'</span>)==1) | (getsp(<span class="string">'SR01S___SEN____BC20'</span>)==1 &amp; getsp(<span class="string">'SR01S___SEN_P__BC22'</span>)==1)
1932                     soundtada;
1933                     fprintf(<span class="string">'   \n'</span>);
1934                     fprintf(<span class="string">'   *********************************************************************************\n'</span>);
1935                     fprintf(<span class="string">'   ** One or more of the pulsed SR injection magnets is still on!  Turn them off! **\n'</span>);
1936                     fprintf(<span class="string">'   *********************************************************************************\n'</span>);
1937                     fprintf(<span class="string">'   \n'</span>);
1938                 <span class="keyword">end</span>
1939             <span class="keyword">catch</span>
1940                 disp(<span class="string">'**Problem checking the state of the bumps and kickers - please check that they are not pulsing.'</span>);
1941             <span class="keyword">end</span>
1942 
1943             <span class="comment">% Get vectors</span>
1944 
1945             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
1946 
1947             BPMlist1 = FB.OCSx.BPM.DeviceList;
1948             <span class="comment">% FOFB_BPMlist =</span>
1949             HCMlist1 = FB.HCMlist1;
1950             VCMlist1 = FB.VCMlist1;
1951             Xivec = FB.Xivec;
1952             Yivec = FB.Yivec;
1953             Xgoal = FB.OCSx.GoalOrbit;
1954             Ygoal = FB.OCSy.GoalOrbit;
1955             FFTypeFlag = FB.FFTypeFlag;   <span class="comment">%local or global tune correction</span>
1956 
1957             iNotHCMChicane = find(HCMlist1(:,2) &lt; 10); <span class="comment">%used by steppv's for setting correctors in loop</span>
1958             iHCMChicane = find(HCMlist1(:,2) == 10);
1959             iNotVCMChicane = find(VCMlist1(:,2) &lt; 10);
1960             iVCMChicane = find(VCMlist1(:,2) == 10);
1961 
1962             <span class="comment">% Sensitivity matrix for setting fast feedback setpoints</span>
1963             Sx1 = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
1964             Sy1 = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
1965 
1966         <span class="keyword">catch</span>
1967             fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
1968 
1969             <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
1970             disp(<span class="string">'   IDBPM time constant set to 0.25s.'</span>)
1971             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.25)
1972 
1973 
1974             a = clock;
1975             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1976             fprintf(<span class="string">'   *************************************************************\n'</span>);
1977             fprintf(<span class="string">'   **  Orbit feedback could not start due to error condition  **\n'</span>);
1978             fprintf(<span class="string">'   *************************************************************\n\n'</span>);
1979             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1980             pause(0);
1981 
1982             <span class="keyword">return</span>
1983         <span class="keyword">end</span>
1984 
1985         StartFlag = questdlg(strvcat(<span class="string">''</span>,<span class="string">'Is it OK to start orbit feedback?'</span>),<span class="string">'Orbit Feedback'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
1986         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
1987             <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
1988             disp(<span class="string">'   IDBPM time constant set to 0.25s.'</span>)
1989             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.25)
1990 
1991             a = clock;
1992             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1993             fprintf(<span class="string">'   ***************************\n'</span>);
1994             fprintf(<span class="string">'   **  Orbit Feedback Exit  **\n'</span>);
1995             fprintf(<span class="string">'   ***************************\n\n'</span>);
1996             pause(0);
1997             <span class="keyword">return</span>
1998         <span class="keyword">end</span>
1999 
2000         SR_STATE_OLD = scaget(<span class="string">'SR_STATE'</span>);
2001         setpv(<span class="string">'SR_STATE'</span>, 5);
2002         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
2003         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2004         <span class="keyword">if</span> StateNumber &gt;= 0
2005             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2006         <span class="keyword">else</span>
2007             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2008         <span class="keyword">end</span>
2009         fprintf(<span class="string">'   Using %d E-vectors horizontally.\n'</span>, length(Xivec));
2010         fprintf(<span class="string">'   Using %d E-vectors vertically.\n'</span>,   length(Yivec));
2011         fprintf(<span class="string">'   Starting slow orbit correction every %.1f seconds.\n'</span>, LoopDelay);
2012         <span class="comment">%  fprintf('   Resetting SR11 chicane motors every 20 seconds to fix drift problem.\n');</span>
2013 
2014         IDSector = getlist(<span class="string">'ID'</span>);
2015         EPUlist = find((IDSector(:,1)==4) | (IDSector(:,1)==11));
2016         oldgap=210*ones(size(IDSector,1),1);
2017         oldShift=zeros(size(oldgap));
2018           
2019         <span class="keyword">try</span>
2020             
2021             <span class="comment">% Get and display data</span>
2022             x = FB.OCSx.GoalOrbit - getx(FB.OCSx.BPM.DeviceList);
2023             y = FB.OCSy.GoalOrbit - gety(FB.OCSy.BPM.DeviceList);
2024             STDx = norm(x)/sqrt(length(x));
2025             STDy = norm(y)/sqrt(length(y));
2026             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = %.4f mm'</span>,STDx),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2027             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = %.4f mm'</span>,STDy),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2028 
2029             <span class="comment">% write goldenorbit values to Fast Orbit Feedback</span>
2030             <span class="keyword">try</span>
2031                 <a href="write_goldenorbit_ffb.html" class="code" title="function write_goldenorbit_ffb">write_goldenorbit_ffb</a>;
2032             <span class="keyword">catch</span>
2033                 disp(<span class="string">'write_goldenorbit_ffb did not work!'</span>);
2034             <span class="keyword">end</span>
2035             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2036             <span class="comment">%pause(0);</span>
2037 
2038             <span class="comment">%display state of FOFB system</span>
2039             FOFBStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2040                 getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2041                 getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2042                 getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2043             FOFBStatusStr = [<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>];
2044             <span class="keyword">for</span> loop = 1:size(FOFBStatus,2)
2045                 <span class="keyword">if</span> FOFBStatus(loop)==0
2046                     FOFBStatusStr(loop,:) = <span class="string">'OFF '</span>;
2047                 <span class="keyword">elseif</span> FOFBStatus(loop)==1
2048                     FOFBStatusStr(loop,:) = <span class="string">'ON  '</span>;
2049                 <span class="keyword">elseif</span> FOFBStatus(loop)==2
2050                     FOFBStatusStr(loop,:) = <span class="string">'OPEN'</span>;
2051                 <span class="keyword">else</span>
2052                     FOFBStatusStr(loop,:) = <span class="string">'BAD '</span>;
2053                 <span class="keyword">end</span>
2054             <span class="keyword">end</span>
2055             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 %s'</span>,FOFBStatusStr(1,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2056             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 %s'</span>,FOFBStatusStr(2,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2057             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 %s'</span>,FOFBStatusStr(3,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2058             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 %s'</span>,FOFBStatusStr(4,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2059             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 %s'</span>,FOFBStatusStr(5,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2060             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 %s'</span>,FOFBStatusStr(6,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2061             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 %s'</span>,FOFBStatusStr(7,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2062             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 %s'</span>,FOFBStatusStr(8,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2063             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 %s'</span>,FOFBStatusStr(9,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2064             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 %s'</span>,FOFBStatusStr(10,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2065             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 %s'</span>,FOFBStatusStr(11,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2066             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 %s'</span>,FOFBStatusStr(12,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2067 
2068         <span class="keyword">catch</span>
2069 
2070             fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
2071 
2072             <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
2073             disp(<span class="string">'   IDBPM time constant set to 0.25s.'</span>)
2074             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.25);
2075 
2076 
2077             a = clock;
2078             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2079             fprintf(<span class="string">'   *************************************************************\n'</span>);
2080             fprintf(<span class="string">'   **  Orbit feedback could not start due to error condition  **\n'</span>);
2081             fprintf(<span class="string">'   *************************************************************\n\n'</span>);
2082 
2083             setpv(<span class="string">'SR_STATE'</span>,SR_STATE_OLD);
2084             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2085             <span class="keyword">if</span> StateNumber &gt;= 0
2086                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2087             <span class="keyword">else</span>
2088                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2089             <span class="keyword">end</span>
2090             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
2091             pause(0);
2092 
2093             <span class="keyword">return</span>
2094 
2095         <span class="keyword">end</span>
2096 
2097 
2098         <span class="comment">% Disable buttons</span>
2099         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
2100         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2101         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2102         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2103         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2104         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2105         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2106         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2107         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2108         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2109         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2110         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2111         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2112         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2113         pause(0);
2114 
2115 
2116         <span class="comment">% Initialize feedback loop</span>
2117         StartTime = gettime;
2118         StartErrorTime = gettime;
2119         Xold = getx(FB.OCSx.BPM.DeviceList);
2120         Yold = gety(FB.OCSy.BPM.DeviceList);
2121         HQMOFM_stalenum = 0;
2122         pause(LoopDelay);
2123 
2124         N_HCM = size(HCMlist1,1);
2125         N_VCM = size(VCMlist1,1);
2126 
2127         N_RFMO = 1;
2128 
2129         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
2130             [FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,<span class="string">'SetRF'</span>,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2131         <span class="keyword">else</span>
2132             [FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2133         <span class="keyword">end</span>
2134         [FB.OCSx, Smatx, Sx, Ux, Vx] = orbitcorrectionmethods(FB.OCSx);
2135 
2136         [FB.OCSy, junk, OCSy0] = setorbit(FB.OCSy,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2137         [FB.OCSy, Smaty, Sy, Uy, Vy] = orbitcorrectionmethods(FB.OCSy);
2138 
2139 
2140         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2141         <span class="comment">% Start feedback loop %</span>
2142         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2143 
2144         <span class="comment">% chicaneloop=1;  % loop variable for resetting drifting chicanes (see a few lines below)</span>
2145         <span class="comment">% fftest=figure;</span>
2146 
2147         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2); <span class="comment">% put FOFB in open loop so beamnoise gets recorded even if FOFB is not enabled</span>
2148 
2149         <span class="keyword">while</span> 1
2150             <span class="keyword">try</span>
2151                 t00 = gettime;
2152 
2153                 <span class="comment">%          if chicaneloop==20 % reset SR11 motor chicane setpoints every 20s due to drifting positions</span>
2154                 <span class="comment">%             setsp('HCMCHICANEM',HCMCHICANEMsp(6),[11 1],0);</span>
2155                 <span class="comment">%             setsp('HCMCHICANEM',HCMCHICANEMsp(7),[11 2],0);</span>
2156                 <span class="comment">%             chicaneloop = 1;</span>
2157                 <span class="comment">%          else</span>
2158                 <span class="comment">%             chicaneloop = chicaneloop + 1;</span>
2159                 <span class="comment">%          end</span>
2160 
2161                 <span class="comment">% Check if GUI has been closed</span>
2162                 <span class="keyword">if</span> isempty(gcbf)
2163                     FEEDBACK_STOP_FLAG = 1;
2164                     lasterr(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2165                     error(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2166                 <span class="keyword">end</span>
2167 
2168                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2169                 <span class="comment">% Fast orbit feedback %</span>
2170                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2171                 <span class="keyword">if</span> StartFOFBFlag == 1 &amp; FBloopIter &gt; 3
2172                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2173                     pause(0.5);
2174                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,1);
2175                     StartFOFBFlag = 0;
2176                     pause(1);
2177                     FOFBOnStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2178                         getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2179                         getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2180                         getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2181                     <span class="keyword">if</span> any(FOFBOnStatus==0) | any(FOFBOnStatus==2)
2182                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2); <span class="comment">% open FOFB loop</span>
2183                         disp(<span class="string">'************************************************************************************************************'</span>);
2184                         disp(<span class="string">'** Problem turning on Fast Orbit Feedback system...                                                       **'</span>);
2185                         disp(<span class="string">'** Check status of ffbsecXX crates - but remember that a crate reboot will turn off Quads in that sector! **'</span>);
2186                         disp(<span class="string">'** Suggest disabling the &quot;Fast Orbit Correction&quot; checkbox and starting Orbit Feedback again.              **'</span>);
2187                         disp(<span class="string">'************************************************************************************************************'</span>);
2188                     <span class="keyword">else</span>
2189                         fprintf(<span class="string">'   Starting Fast Orbit Feedback at %.0f Hz.\n'</span>, getpv(<span class="string">'SR01____FFBFREQAM00'</span>));
2190                     <span class="keyword">end</span>
2191                 <span class="keyword">end</span>
2192 
2193 
2194                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2195                 <span class="comment">% Horizontal plane &quot;feedback&quot; %</span>
2196                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2197 
2198                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxSOFB'</span>),<span class="string">'Value'</span>) == 1
2199 
2200                     <span class="comment">% Get orbit and check that the BPMs are different from the last update</span>
2201                     Xnew = getx(FB.OCSx.BPM.DeviceList);
2202 
2203                     <span class="comment">% Don't feedback if the current is too small</span>
2204                     <span class="keyword">if</span> getdcct &lt; 5
2205                         FEEDBACK_STOP_FLAG = 1;
2206                         fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2207                         <span class="keyword">break</span>;
2208                     <span class="keyword">end</span>
2209 
2210                     x = Xgoal - Xnew;
2211                     STDx = norm(x)/sqrt(length(x));
2212 
2213                     <span class="keyword">if</span> any(Xold == Xnew)
2214                         a = clock;
2215                         N_Stale_Data_Points = find((Xold==Xnew)==1);
2216                         <span class="keyword">for</span> loop = N_Stale_Data_Points'
2217                             fprintf(<span class="string">'   Stale data: BPMx(%2d,%d), feedback step skipped (%s %d:%d:%.0f). \n'</span>, FB.OCSx.BPM.DeviceList(loop,1), FB.OCSx.BPM.DeviceList(loop,2), date, a(4), a(5), a(6));
2218                         <span class="keyword">end</span>
2219                     <span class="keyword">else</span>
2220                         <span class="comment">% Compute horizontal correction</span>
2221                         <span class="comment">%%%OCSx0 = FB.OCSx;</span>
2222                         FB.OCSx.BPM.Data = Xnew;
2223                         FB.OCSx = orbitcorrectionmethods(FB.OCSx, Smatx, Sx, Ux, Vx);
2224 
2225                         <span class="comment">%%%[FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,'Nodisplay','Nosetsp');</span>
2226 
2227                         <span class="comment">% reduced feedback gain (implemented by Greg Portmann, December 2000)</span>
2228                         <span class="comment">% reduced to 0.1, C. Steier, 2001-09-04, IDBPMs are noisy at the moment</span>
2229                         <span class="comment">% increased back to 0.8 C. Steier, 2001-09-29, IDBPMs filtering + direct DAC read/write + all SVDs (no arc BPMs)</span>
2230                         <span class="comment">% increased to 1.0, C. Steier, 2002-05-04, trim DACs</span>
2231                         X = Xgain .* FB.OCSx.CM.Delta;
2232                         X(N_HCM+1) = 0.3*FB.OCSx.DeltaRF/4.988e-3;
2233                         <span class="comment">%%%X = Xgain .* (FB.OCSx.CM.Data - OCSx0.CM.Data);</span>
2234 
2235                         <span class="comment">% check for trim values+next step values, warn or stop FB as necessary</span>
2236                         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2237                         <span class="comment">% need to extract Chicanes from this comparison or maybe check them first for range %</span>
2238                         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2239                         HCMtrimSP=getpv(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1);
2240                         HCMtrimSP_next = HCMtrimSP + X(1:N_HCM);
2241                         <span class="keyword">if</span> max(abs(HCMtrimSP_next)) &gt; 4
2242                             HCMtrimnum=find(abs(HCMtrimSP_next) &gt; 4);
2243 
2244                             <span class="comment">% print message to screen</span>
2245                             fprintf(<span class="string">'**One or more of the horizontal correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2246                             fprintf(<span class="string">'%s\n'</span>,datestr(now));
2247                             <span class="keyword">for</span> loop = HCMtrimnum'
2248                                 fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1(loop,:)));
2249                             <span class="keyword">end</span>
2250 
2251                             <span class="comment">% send alphapage to operator pager</span>
2252                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2253                             FEEDBACK_STOP_FLAG = 1;
2254 
2255                             setpv(<span class="string">'SR_STATE'</span>, -5);
2256                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2257                             <span class="keyword">if</span> StateNumber &gt;= 0
2258                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2259                             <span class="keyword">else</span>
2260                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2261                             <span class="keyword">end</span>
2262                         <span class="keyword">end</span>
2263 
2264                         <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2265                             <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2266                             <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2267                                 disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2268                             <span class="keyword">end</span>
2269                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2270                             pause(0.5);
2271                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2272                             <span class="keyword">break</span>;
2273                         <span class="keyword">end</span>
2274 
2275                         <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2276                         pause(0);
2277 
2278                         <span class="keyword">if</span> max(abs(HCMtrimSP_next) &gt; 3)
2279                             HCMtrimnum=find(abs(HCMtrimSP_next) &gt; 3);
2280                             HWarnNum=HWarnNum+1;
2281                             <span class="keyword">if</span> (HWarnNum==1 | rem(HWarnNum,120)==0)
2282 
2283                                 <span class="comment">% print message to screen every two minutes</span>
2284                                 fprintf(<span class="string">'**One or more of the horizontal corrector trims is above 3A or below -3A! \n'</span>);
2285                                 fprintf(<span class="string">'%s\n'</span>,datestr(now));
2286                                 <span class="keyword">for</span> loop = HCMtrimnum'
2287                                     fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1(loop,:)));
2288                                 <span class="keyword">end</span>
2289                                 fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2290 
2291                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2292                                 <span class="keyword">if</span> (HWarnNum==1 | HWarnNum==600)
2293                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageHCM.txt
2294                                 <span class="keyword">end</span>
2295                             <span class="keyword">end</span>
2296                         <span class="keyword">else</span>
2297                             HWarnNum=0;
2298                         <span class="keyword">end</span>
2299 
2300                         <span class="comment">% Don't feedback if the current is too small</span>
2301                         <span class="keyword">if</span> getdcct &lt; 5
2302                             FEEDBACK_STOP_FLAG = 1;
2303                             fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2304                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/beamisoff.txt
2305                             <span class="keyword">break</span>;
2306                         <span class="keyword">end</span>
2307 
2308                         <span class="keyword">if</span> N_HCM &gt; 0
2309                             steppv(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>, X(iNotHCMChicane), HCMlist1(iNotHCMChicane,:), 0);
2310                             steppv(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>, X(iHCMChicane), HCMlist1(iHCMChicane,:), 0);
2311                         <span class="keyword">end</span>
2312 
2313                         <span class="comment">% write fast orbit feedback setpoints</span>
2314                         <span class="keyword">if</span> 1
2315                             <span class="comment">%write_goldenorbit_ffb_2planes(1, Xnew(1:size(BPMlist1,1))+Sx1*X(1:N_HCM)+Sx3*X(length(X))/20, BPMlist1);</span>
2316                             <span class="comment">% should be corrected to include result of next frequency step ...</span>
2317                             <a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>(1,Xnew(1:size(BPMlist1,1))+Sx1*X(1:N_HCM),BPMlist1);
2318                         <span class="keyword">end</span>
2319 
2320                         <span class="comment">%fprintf('Horizontal Done: %f \n',gettime-t00);</span>
2321 
2322                         <span class="comment">% RF feedback</span>
2323                         HQMOFMsp_last = getpv(<span class="string">'EG______HQMOFM_AC01'</span>);
2324 
2325                         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
2326                             <span class="keyword">if</span> N_RFMO &gt; 0
2327                                 <span class="keyword">if</span> abs(X(end)/3) &lt; .01
2328                                     <span class="comment">% if abs(FB.OCSx.DeltaRF/3) &lt; .01</span>
2329                                     steppv(<span class="string">'EG______HQMOFM_AC01'</span>, X(end));
2330                                 <span class="keyword">else</span>
2331                                     steppv(<span class="string">'EG______HQMOFM_AC01'</span>, 0.01*sign(X(end)));
2332                                 <span class="keyword">end</span>
2333                             <span class="keyword">end</span>
2334 
2335                             HQMOFMsp_now = getpv(<span class="string">'EG______HQMOFM_AC01'</span>);
2336 
2337                             <span class="comment">% Check for stale RF feedback</span>
2338                             <span class="keyword">if</span> HQMOFMsp_last == HQMOFMsp_now
2339                                 HQMOFM_stalenum = HQMOFM_stalenum + 1;
2340                                 <span class="keyword">if</span> HQMOFM_stalenum == 30 <span class="comment">% warn and message to pager if stale for 30 secs</span>
2341                                     fprintf(<span class="string">'**The RF is not responding to orbit feedback changes! \n'</span>);
2342                                     fprintf(<span class="string">'%s\n'</span>,datestr(now));
2343                                     fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2344                                     fprintf(<span class="string">'**ILC 73 controls the EG______HQMOFM_AC01 channel, which sets the RF frequency. \n'</span>);
2345                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstaleRFmessage.txt
2346                                 <span class="keyword">end</span>
2347                                 <span class="keyword">if</span> rem(HQMOFM_stalenum,120)==0 <span class="comment">% message to screen every 2 minutes</span>
2348                                     fprintf(<span class="string">'**The RF is not responding to orbit feedback changes! (%s)\n'</span>,datestr(now));
2349                                 <span class="keyword">end</span>
2350                             <span class="keyword">else</span>
2351                                 HQMOFM_stalenum = 0;
2352                             <span class="keyword">end</span>
2353 
2354                         <span class="keyword">end</span>
2355 
2356                         <span class="comment">%fprintf('RF Done: %f \n',gettime-t00);</span>
2357 
2358                         Xold = Xnew;
2359                     <span class="keyword">end</span> <span class="comment">% End horizontal correction</span>
2360 
2361 
2362                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2363                     <span class="comment">% Vertical plane &quot;feedback&quot; %</span>
2364                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2365 
2366                     <span class="comment">% Get orbit and check that the BPMs are different from the last update</span>
2367                     Ynew = gety(FB.OCSy.BPM.DeviceList);
2368 
2369                     <span class="comment">% Don't feedback if the current is too small</span>
2370                     <span class="keyword">if</span> getdcct &lt; 5
2371                         FEEDBACK_STOP_FLAG = 1;
2372                         fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2373                         <span class="keyword">break</span>;
2374                     <span class="keyword">end</span>
2375 
2376                     y = Ygoal - Ynew;
2377                     STDy = norm(y)/sqrt(length(y));
2378 
2379                     <span class="keyword">if</span> any(Yold == Ynew)
2380                         a = clock;
2381                         N_Stale_Data_Points = find((Yold==Ynew)==1);
2382                         <span class="keyword">for</span> loop = N_Stale_Data_Points'
2383                             fprintf(<span class="string">'   Stale data: BPMy(%2d,%d), feedback step skipped (%s %d:%d:%.0f). \n'</span>, FB.OCSy.BPM.DeviceList(loop,1), FB.OCSy.BPM.DeviceList(loop,2), date, a(4), a(5), a(6));
2384                         <span class="keyword">end</span>
2385 
2386                     <span class="keyword">else</span>
2387 
2388                         <span class="comment">% Compute vertical correction</span>
2389                         <span class="comment">%%%OCSy0 = FB.OCSy;</span>
2390                         FB.OCSy.BPM.Data = Ynew;
2391                         FB.OCSy = orbitcorrectionmethods(FB.OCSy, Smaty, Sy, Uy, Vy);
2392 
2393                         <span class="comment">%%%[FB.OCSy, RF, OCSy0] = setorbit(FB.OCSy,'Nodisplay','Nosetsp');</span>
2394 
2395                         <span class="comment">% reduced feedback gain, C. Steier, 2001-03-25</span>
2396                         <span class="comment">% reduced to 0.1, C. Steier, 2001-09-04, IDBPMs are noisy at the moment</span>
2397                         <span class="comment">% increased back to 0.8, C. Steier, 2001-09-29, IDBPMs filtering + direct DAC read/write + all SVDs (no arc BPMs)</span>
2398                         <span class="comment">% set to unity gain, C. Steier, 2002-05-04, trim DACs</span>
2399                         Y = Ygain .* FB.OCSy.CM.Delta;
2400                         <span class="comment">%%%Y = Ygain .* (FB.OCSy.CM.Data - OCSy0.CM.Data);</span>
2401 
2402                         <span class="comment">% Just SVD correction</span>
2403                         <span class="comment">% warning('Not using &quot;micado&quot; correction in the vertical plane.');</span>
2404 
2405                         <span class="comment">% check for trim values+next step values, warn or stop FB as necessary</span>
2406                         VCMtrimSP = getpv(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1);
2407                         VCMtrimSP_next = VCMtrimSP + Y(1:N_VCM);
2408                         <span class="keyword">if</span> max(abs(VCMtrimSP_next)) &gt; 12
2409                             VCMtrimnum=find(abs(VCMtrimSP_next) &gt; 12);
2410 
2411                             <span class="comment">% print message to screen</span>
2412                             fprintf(<span class="string">'**One or more of the vertical correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2413                             fprintf(<span class="string">'%s\n'</span>,datestr(now));
2414                             <span class="keyword">for</span> loop = VCMtrimnum'
2415                                 fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1(loop,:)));
2416                             <span class="keyword">end</span>
2417 
2418                             <span class="comment">% send alphapage to operator pager</span>
2419                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2420                             FEEDBACK_STOP_FLAG = 1;
2421 
2422                             setpv(<span class="string">'SR_STATE'</span>, -5);
2423                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2424                             <span class="keyword">if</span> StateNumber &gt;= 0
2425                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2426                             <span class="keyword">else</span>
2427                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2428                             <span class="keyword">end</span>
2429                         <span class="keyword">end</span>
2430 
2431                         <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2432                             <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2433                             <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2434                                 disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2435                             <span class="keyword">end</span>
2436                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2437                             pause(0.5);
2438                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2439                             <span class="keyword">break</span>;
2440                         <span class="keyword">end</span>
2441 
2442                         <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2443                         <span class="comment">% pause(0);</span>
2444 
2445                         <span class="keyword">if</span> max(abs(VCMtrimSP_next) &gt; 4)
2446                             VCMtrimnum=find(abs(VCMtrimSP_next) &gt; 4);
2447                             VWarnNum=VWarnNum+1;
2448                             <span class="keyword">if</span> (VWarnNum==1 | rem(VWarnNum,120)==0)
2449 
2450                                 <span class="comment">% print message to screen every two minutes</span>
2451                                 fprintf(<span class="string">'**One or more of the vertical corrector trims is above 4A or below -4A! \n'</span>);
2452                                 fprintf(<span class="string">'%s\n'</span>,datestr(now));
2453                                 <span class="keyword">for</span> loop = VCMtrimnum'
2454                                     fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1(loop,:)));
2455                                 <span class="keyword">end</span>
2456                                 fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2457 
2458                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2459                                 <span class="keyword">if</span> (VWarnNum==1 | VWarnNum==600)
2460                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageVCM.txt
2461                                 <span class="keyword">end</span>
2462                             <span class="keyword">end</span>
2463                         <span class="keyword">else</span>
2464                             VWarnNum=0;
2465                         <span class="keyword">end</span>
2466 
2467                         <span class="comment">% Don't feedback if the current is too small</span>
2468                         <span class="keyword">if</span> getdcct &lt; 5
2469                             FEEDBACK_STOP_FLAG = 1;
2470                             fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2471                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/beamisoff.txt
2472                             <span class="keyword">break</span>;
2473                         <span class="keyword">end</span>
2474 
2475                         <span class="keyword">if</span> N_VCM &gt; 0
2476                             steppv(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>, Y(iNotVCMChicane), VCMlist1(iNotVCMChicane,:), 0);
2477                             steppv(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>, Y(iVCMChicane), VCMlist1(iVCMChicane,:), 0);
2478                         <span class="keyword">end</span>
2479 
2480                         <span class="comment">% write fast orbit feedback setpoints</span>
2481                         <span class="keyword">if</span> 1
2482                             <a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>(2,Ynew(1:size(BPMlist1,1))+Sy1*Y(1:N_VCM),BPMlist1);
2483                         <span class="keyword">end</span>
2484 
2485                     <span class="keyword">end</span>
2486 
2487                     Yold = Ynew;
2488 
2489                     <span class="comment">%fprintf('Vertical Done: %f \n',gettime-t00);</span>
2490                 <span class="keyword">end</span> <span class="comment">% End vertical correction</span>
2491 
2492 
2493                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
2494                 <span class="comment">% Tune feed forward %</span>
2495                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
2496                 <span class="comment">% We should do a Sector limit check</span>
2497 
2498                 tic;
2499                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxTune'</span>),<span class="string">'Value'</span>) == 1
2500 
2501                     <span class="keyword">if</span> strcmp(SR_Mode, <span class="string">'1.9 GeV, High Tune'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Inject at 1.23'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Two-Bunch'</span>)
2502 
2503                         addQFsp = zeros(24,1);
2504                         addQDsp = zeros(24,1);
2505 
2506                         <span class="keyword">if</span> strcmp(FFTypeFlag,<span class="string">'Local'</span>)
2507                             disp(<span class="string">'  No local tune compensation available - global is the default now.'</span>);
2508                         <span class="keyword">elseif</span> strcmp(FFTypeFlag,<span class="string">'Global'</span>)
2509 
2510                             <span class="comment">% The vectorized gets were put outside of loop for speed reasons</span>
2511                             <span class="comment">%</span>
2512                             <span class="comment">% should also set up QFfac, Quadelem, Quadlist structures outside loop</span>
2513                             actualgap = <a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>(IDSector);
2514                             [gapmin,gapmax] = <a href="gaplimit.html" class="code" title="function [GAPmin, GAPmax] = gaplimit(Dev);">gaplimit</a>(IDSector);
2515                             corrind = find(actualgap&lt;(gapmin-1));
2516                             actualgap(corrind)=gapmax(corrind);
2517                             Shift=zeros(size(actualgap));
2518                             Shift(EPUlist)=getpv(<span class="string">'EPU'</span>);
2519 
2520                             IDchangedList=find((abs(actualgap-oldgap)&gt;0.005) | (abs(Shift-oldShift)&gt;0.005));
2521 
2522                             <span class="keyword">if</span> ~isempty(IDchangedList)
2523 
2524                                 oldgap=actualgap;
2525                                 oldShift=Shift;
2526 
2527                                 <span class="comment">% EPUs excite nux = .25 resonance in vertical linear polarization mode!</span>
2528                                 <span class="comment">% therefore with EPU tune feedforward</span>
2529                                 <span class="comment">% running, we want to move our nominal working point away (just below) the .25 resonance.</span>
2530                                 <span class="comment">%</span>
2531                                 <span class="comment">% The following tune correction moves nominal</span>
2532                                 <span class="comment">% nu_x from .25 to .245 - this should be enough for well set up lattices.</span>
2533                                 <span class="comment">%</span>
2534                                 <span class="comment">% 24 QF+ 24 QD</span>
2535                                 DeltaAmps = inv(SR_TUNE_MATRIX) * [-0.005;0];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2536                                 addQFsp = addQFsp + DeltaAmps(1,:);
2537                                 addQDsp = addQDsp + DeltaAmps(2,:);
2538 
2539                                 <span class="keyword">for</span> gapnum = 1:length(actualgap)
2540 
2541                                     <span class="comment">% Change in tune and [QF;QD] from maximum gap</span>
2542 
2543                                     <span class="keyword">if</span> (IDSector(gapnum,1) == 4) | (IDSector(gapnum,1) == 11)
2544                                         <span class="keyword">if</span> IDSector(gapnum,2) == 1
2545                                             modenamestr = sprintf(<span class="string">'SR%02dU___ODS1M__DC00'</span>,IDSector(gapnum,1));
2546                                         <span class="keyword">else</span> <span class="comment">% if IDSector(gapnum,2) == 2</span>
2547                                             modenamestr = sprintf(<span class="string">'SR%02dU___ODS2M__DC00'</span>,IDSector(gapnum,1));
2548                                         <span class="keyword">end</span>
2549                                         epumode = getpvonline(modenamestr);
2550                                         <span class="keyword">if</span> IDSector(gapnum,2)==2
2551                                             longshift=3;
2552                                         <span class="keyword">else</span>
2553                                             longshift=0;
2554                                         <span class="keyword">end</span>
2555                                         <span class="keyword">if</span> (epumode==0) &amp; (any(IDSector(gapnum,:)~=[11 1]))      <span class="comment">% antiparallel tables need to be fit to data so that they could be used here</span>
2556                                             DeltaNuX = <a href="shift2tune.html" class="code" title="function [Dnux, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = shift2tune(Sector, Gap, EPUshift, GeV)">shift2tune</a>(IDSector(gapnum,1),actualgap(gapnum),Shift(gapnum)+longshift,SR_GeV);
2557                                             DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);   <span class="comment">% variation of vertical tune shift with phase is small for EPUs</span>
2558                                         <span class="keyword">else</span>
2559                                             DeltaNuX = 0;
2560                                             DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);   <span class="comment">% variation of vertical tune shift with phase is small for EPUs</span>
2561                                         <span class="keyword">end</span>
2562 
2563                                     <span class="keyword">else</span>
2564                                         DeltaNuX = 0;
2565                                         DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);
2566                                     <span class="keyword">end</span>
2567 
2568                                     DelQF = zeros(length(QFsp),1);
2569                                     DelQD = zeros(length(QFsp),1);
2570 
2571                                     fraccorr = 0.8*DeltaNuY ./ TuneW16Min;
2572 
2573                                     <span class="comment">% Find which quads to change (local beta beating correction</span>
2574                                     <span class="comment">% (horizontal for EPU, vertical otherwise)</span>
2575                                     QuadList = [IDSector(gapnum,1)-1 2; IDSector(gapnum,1) 1];
2576                                     QuadElem = dev2elem(<span class="string">'QF'</span>,QuadList); <span class="comment">% in reality use QF and QD ...</span>
2577 
2578                                     <span class="comment">% global vertical tune correction</span>
2579                                     <span class="comment">% 24 QF+ 24 QD</span>
2580                                     DeltaAmps = inv(SR_TUNE_MATRIX) * [(fraccorr*6.23e-4); fraccorr*(-0.05301)];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2581                                     DelQF = DelQF + DeltaAmps(1,:);
2582                                     DelQD = DelQD + DeltaAmps(2,:);
2583 
2584                                     <span class="comment">% local horizontal tune correction (is also nearly a beta beating correction) only nonzero for EPUs!</span>
2585                                     <span class="comment">% 2 QF + 2 QD</span>
2586                                     DeltaAmpsLocal = 12*inv(SR_TUNE_MATRIX) * [-DeltaNuX;0];                       <span class="comment">%  DelAmps =  [QF; QD];</span>
2587                                     DelQF(QuadElem) = DelQF(QuadElem)+DeltaAmpsLocal(1,1);
2588                                     DelQD(QuadElem) = DelQD(QuadElem)+DeltaAmpsLocal(2,1);
2589 
2590                                     <span class="comment">% local vertical beta beating correction (should be used together with above global tune correction)</span>
2591                                     <span class="comment">% set to zero for EPUs, since their vertical tune shift is small</span>
2592                                     <span class="comment">% 2 QF + 2QD</span>
2593                                     <span class="keyword">if</span> (IDSector(gapnum,1)==6) | (IDSector(gapnum,1)==7) | (IDSector(gapnum,1)==10) | (IDSector(gapnum,1)==11)
2594                                         QFfac = ([2.243127/2.237111; 2.243127/2.237111]-1) * fraccorr;
2595                                         QDfac = ([2.556392/2.511045; 2.556392/2.511045]-1) * fraccorr;
2596                                     <span class="keyword">elseif</span> (IDSector(gapnum,1)==5) | (IDSector(gapnum,1)==9)
2597                                         QFfac = ([2.225965/2.219784; 2.243096/2.237111]-1) * fraccorr;
2598                                         QDfac = ([2.528950/2.483259; 2.556345/2.511045]-1) * fraccorr;
2599                                     <span class="keyword">elseif</span> (IDSector(gapnum,1)==4) | (IDSector(gapnum,1)==8) | (IDSector(gapnum,1)==12)
2600                                         QFfac = ([2.243096/2.237111; 2.225965/2.219784]-1) * fraccorr;
2601                                         QDfac = ([2.556345/2.511045; 2.528950/2.483259]-1) * fraccorr;
2602                                     <span class="keyword">else</span>
2603                                         QFfac = zeros(2,1);
2604                                         QDfac = zeros(2,1);
2605                                     <span class="keyword">end</span>
2606 
2607                                     DelQF(QuadElem,:) = DelQF(QuadElem,:) + QFfac.*QFsp(QuadElem,:);
2608                                     DelQD(QuadElem,:) = DelQD(QuadElem,:) + QDfac.*QDsp(QuadElem,:);
2609 
2610                                     <span class="comment">% add all tune and beta beating corrections for this one ID to the summed up correction vectors for all IDs</span>
2611                                     addQFsp = addQFsp+DelQF;
2612                                     addQDsp = addQDsp+DelQD;
2613 
2614                                 <span class="keyword">end</span>
2615 
2616                                 <span class="comment">% Set quadrupoles using main setpoint channels</span>
2617                                 setpv(<span class="string">'QF'</span>, QFsp+addQFsp,[], 0);
2618                                 setpv(<span class="string">'QD'</span>, QDsp+addQDsp,[], 0);
2619                                 <span class="comment">% % Set quadrupoles using FF setpoint channels</span>
2620                                 <span class="comment">% setpv('QF', 'FF', addQFsp, [], 0);</span>
2621                                 <span class="comment">% setpv('QD', 'FF', addQDsp, [], 0);</span>
2622                             <span class="keyword">end</span>
2623 
2624                         <span class="keyword">else</span>
2625                             error(<span class="string">'Unknown type selected for tune FF'</span>);
2626                         <span class="keyword">end</span>
2627 
2628                     <span class="keyword">else</span>
2629                         disp(<span class="string">'  No tune FF algorithm for non-production modes yet...'</span>);
2630                     <span class="keyword">end</span>
2631                 <span class="keyword">end</span>
2632 
2633                 ffdeltaquad_delay = toc;
2634                 <span class="comment">%fprintf('tune FF delay = %.1f seconds\n',ffdeltaquad_delay);</span>
2635                 <span class="comment">% fprintf('Tune Done: %f \n',gettime-t00);</span>
2636 
2637                 <span class="comment">% Output info to screen</span>
2638                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = %.4f mm'</span>,STDx),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2639                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = %.4f mm'</span>,STDy),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2640                 <span class="comment">%pause(0);</span>
2641 
2642                 FOFBStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2643                     getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2644                     getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2645                     getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2646                 <span class="keyword">for</span> loop = 1:size(FOFBStatus,2)
2647                     <span class="keyword">if</span> FOFBStatus(loop)==0
2648                         FOFBStatusStr(loop,:) = <span class="string">'OFF '</span>;
2649                     <span class="keyword">elseif</span> FOFBStatus(loop)==1
2650                         FOFBStatusStr(loop,:) = <span class="string">'ON  '</span>;
2651                     <span class="keyword">elseif</span> FOFBStatus(loop)==2
2652                         FOFBStatusStr(loop,:) = <span class="string">'OPEN'</span>;
2653                     <span class="keyword">else</span>
2654                         FOFBStatusStr(loop,:) = <span class="string">'BAD '</span>;
2655                     <span class="keyword">end</span>
2656                 <span class="keyword">end</span>
2657                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 %s'</span>,FOFBStatusStr(1,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2658                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 %s'</span>,FOFBStatusStr(2,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2659                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 %s'</span>,FOFBStatusStr(3,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2660                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 %s'</span>,FOFBStatusStr(4,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2661                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 %s'</span>,FOFBStatusStr(5,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2662                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 %s'</span>,FOFBStatusStr(6,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2663                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 %s'</span>,FOFBStatusStr(7,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2664                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 %s'</span>,FOFBStatusStr(8,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2665                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 %s'</span>,FOFBStatusStr(9,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2666                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 %s'</span>,FOFBStatusStr(10,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2667                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 %s'</span>,FOFBStatusStr(11,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2668                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 %s'</span>,FOFBStatusStr(12,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2669 
2670 
2671                 <span class="comment">%fprintf('End of feedback operations: %f \n\n',gettime-t00);</span>
2672 
2673                 <span class="comment">% Wait for next update time or stop request</span>
2674                 <span class="keyword">while</span> (gettime-t00) &lt; LoopDelay
2675                     <span class="comment">%disp('interval could be shorter')</span>
2676                     pause(.05);
2677                     <span class="comment">% Check if GUI has been closed</span>
2678                     <span class="keyword">if</span> isempty(gcbf)
2679                         FEEDBACK_STOP_FLAG = 1;
2680                         lasterr(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2681                         error(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2682                     <span class="keyword">end</span>
2683 
2684                     <span class="comment">% Check if Stop button was pressed</span>
2685                     <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2686                         <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2687                         <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2688                             disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2689                         <span class="keyword">end</span>
2690                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2691                         pause(0.5);
2692                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2693                         <span class="keyword">break</span>;
2694                     <span class="keyword">end</span>
2695                 <span class="keyword">end</span>
2696 
2697 
2698                 <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2699                     <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2700                     <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2701                         disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2702                     <span class="keyword">end</span>
2703                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2704                     pause(0.5);
2705                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2706                     <span class="keyword">break</span>;
2707                 <span class="keyword">end</span>
2708 
2709                 StartErrorTime = gettime;
2710 
2711             <span class="keyword">catch</span>
2712 
2713                 fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
2714 
2715                 <span class="comment">% Quit if error exists for more than 20 seconds</span>
2716                 <span class="keyword">if</span> gettime-StartErrorTime&gt;20 | FEEDBACK_STOP_FLAG==1
2717                     fprintf(<span class="string">'%s  Orbit feedback stopped due to error condition. \n\n'</span>,datestr(now));
2718 
2719                     <span class="comment">%send alphapage to operator pager</span>
2720                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2721                     FEEDBACK_STOP_FLAG = 1;
2722 
2723                     setpv(<span class="string">'SR_STATE'</span>, -5);
2724                     [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2725                     <span class="keyword">if</span> StateNumber &gt;= 0
2726                         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2727                     <span class="keyword">else</span>
2728                         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2729                     <span class="keyword">end</span>
2730                 <span class="keyword">else</span>
2731                     a = clock;
2732                     fprintf(<span class="string">'   Orbit feedback was paused due to error condition (%s %d:%d:%.0f). \n'</span>, date, a(4), a(5), a(6));
2733                     fprintf(<span class="string">'   Orbit feedback has automatically restarted and is running. \n\n'</span>);
2734                 <span class="keyword">end</span>
2735 
2736             <span class="keyword">end</span>
2737 
2738             <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2739                 <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2740                 <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2741                     disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2742                 <span class="keyword">end</span>
2743                 setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2744                 pause(0.5);
2745                 setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2746                 <span class="keyword">break</span>;
2747             <span class="keyword">end</span>
2748 
2749             <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2750 
2751             <span class="comment">%pause(0);</span>
2752 
2753             <span class="comment">% this loop delays turn on of Fast Feedback system</span>
2754             <span class="keyword">if</span> FBloopIter &lt; 5
2755                 FBloopIter = FBloopIter + 1;
2756             <span class="keyword">end</span>
2757 
2758         <span class="keyword">end</span>  <span class="comment">% End of feedback loop</span>
2759 
2760 
2761         <span class="comment">% End feedback, reset all parameters</span>
2762         <span class="keyword">try</span>
2763 
2764             <span class="comment">% Enable buttons</span>
2765             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2766             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2767             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2768             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2769             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2770             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2771             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2772             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2773             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2774             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2775             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2776             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2777             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2778 
2779             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = _____ mm'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2780             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = _____ mm'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2781 
2782             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2783             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2784             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2785             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2786             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2787             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2788             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2789             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2790             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2791             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2792             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2793             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2794 
2795             <span class="comment">%pause(0);</span>
2796 
2797         <span class="keyword">catch</span>
2798 
2799             <span class="comment">% GUI must have been closed</span>
2800 
2801         <span class="keyword">end</span>
2802 
2803 
2804         <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
2805         disp(<span class="string">'   IDBPM time constant set to 0.25s.'</span>);
2806         <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.25);
2807 
2808 
2809         a = clock;
2810         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2811         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2812         <span class="keyword">if</span> StateNumber &gt;= 0
2813             setpv(<span class="string">'SR_STATE'</span>,5.1);
2814             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2815             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2816             fprintf(<span class="string">'   ******************************\n'</span>);
2817             fprintf(<span class="string">'   **  Orbit Feedback Stopped  **\n'</span>);
2818             fprintf(<span class="string">'   ******************************\n\n'</span>);
2819         <span class="keyword">else</span>
2820             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2821             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2822             fprintf(<span class="string">'   ****************************************\n'</span>);
2823             fprintf(<span class="string">'   **  Problem With Slow Orbit Feedback  **\n'</span>);
2824             fprintf(<span class="string">'   ****************************************\n\n'</span>);
2825         <span class="keyword">end</span>
2826         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
2827         pause(0);
2828 
2829 
2830     <span class="keyword">case</span> <span class="string">'FeedbackSetup'</span>
2831         InitFlag = Input2;           <span class="comment">% Input #2: if InitFlag, then initialize variables</span>
2832 
2833         <span class="keyword">if</span> InitFlag
2834             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2835             <span class="comment">% Edit the following lists to change default configuration of Orbit Correction %</span>
2836             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2837 
2838             <span class="comment">% Corrector magnets</span>
2839             listh=[
2840                 1 2;
2841                 1 8;
2842                 2 1;
2843                 2 8;
2844                 3 1;
2845                 3 8;
2846                 3 10; <span class="comment">%SR04U_HCM2 (chicane trim)</span>
2847                 4 1;
2848                 4 8;
2849                 5 1;
2850                 5 8;
2851                 <span class="comment">%                 5 10; %SR06U_HCM2 (chicane trim)</span>
2852                 6 1;
2853                 6 8;
2854                 7 1;
2855                 7 8;
2856                 8 1;
2857                 8 8;
2858                 9 1;
2859                 9 8;
2860                 10 1;
2861                 10 8;
2862                 10 10; <span class="comment">%SR11U_HCM2 (chicane trim)</span>
2863                 11 1;
2864                 11 8;
2865                 12 1;
2866                 12 7];
2867             listv=[
2868                 1 2;
2869                 1 8;
2870                 2 1;
2871                 2 8;
2872                 3 1;
2873                 3 7;
2874                 3 8;
2875                 3 10; <span class="comment">%SR04U_VHCM2 (chicane trim)</span>
2876                 4 1;
2877                 4 7;
2878                 4 8;
2879                 5 1;
2880                 5 8;
2881 <span class="comment">%                 5 10; %SR06U_VHCM2 (chicane trim)</span>
2882                 6 1;
2883                 6 8;
2884                 7 1;
2885                 7 8;
2886                 8 1;
2887                 8 8;
2888                 9 1;
2889                 9 8;
2890                 10 1;
2891                 10 2;
2892                 10 7;
2893                 10 8;
2894                 10 10; <span class="comment">%SR11U_VHCM2 (chicane trim)</span>
2895                 11 1;
2896                 11 7;
2897                 11 8;
2898                 12 1;
2899                 12 7];
2900 
2901             Xivec = [1:27];
2902             Yivec = [1:31];
2903             HCMlist1 = listh;
2904             VCMlist1 = listv;
2905 
2906             <span class="comment">% Full BPM list</span>
2907             BPMlist1 = [
2908                 1 2
2909                 1 5
2910                 1 6
2911                 1 10
2912                 2 1
2913                 2 5
2914                 2 6
2915                 2 9
2916                 3 2
2917                 3 5
2918                 3 6
2919                 3 10
2920                 3 11
2921                 3 12
2922                 4 1
2923                 4 5
2924                 4 6
2925                 4 10
2926                 5 1
2927                 5 5
2928                 5 6
2929                 5 10
2930 <span class="comment">%                 5 11</span>
2931 <span class="comment">%                 5 12</span>
2932                 6 1
2933                 6 5
2934                 6 6
2935                 6 10
2936                 7 1
2937                 7 5
2938                 7 6
2939                 7 10
2940                 8 1
2941                 8 5
2942                 8 6
2943                 8 10
2944                 9 1
2945                 9 5
2946                 9 6
2947                 9 10
2948                 10 1
2949                 10 5
2950                 10 6
2951                 10 10
2952                 10 11
2953                 10 12
2954                 11 1
2955                 11 5
2956                 11 6
2957                 11 10
2958                 12 1
2959                 12 5
2960                 12 6
2961                 12 9
2962                 ];
2963 
2964             <span class="comment">% remove Bergoz BPMs in SR01 and SR03 for 2-bunch (noisy at low currents) and drop singular values</span>
2965             <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
2966                     BPMlist1 = [
2967                          <span class="comment">%1 2</span>
2968                          1 5
2969                          1 6
2970                          1 10
2971                          2 1
2972                          2 5
2973                          2 6
2974                          <span class="comment">%2 9</span>
2975                          <span class="comment">%3 2</span>
2976                          3 5
2977                          3 6
2978                          3 10
2979                          3 11
2980                          3 12
2981                          4 1
2982                          4 5
2983                          4 6
2984                          4 10
2985                          5 1
2986                          5 5
2987                          5 6
2988                          5 10
2989                          5 11
2990                          5 12
2991                          6 1
2992                          6 5
2993                          6 6
2994                          6 10
2995                          7 1
2996                          7 5
2997                          7 6
2998                          7 10
2999                          8 1
3000                          8 5
3001                          8 6
3002                          8 10
3003                          9 1
3004                          9 5
3005                          9 6
3006                          9 10
3007                          10 1
3008                          10 5
3009                          10 6
3010                          10 10
3011                          10 11
3012                          10 12
3013                          11 1
3014                          11 5
3015                          11 6
3016                          11 10
3017                          12 1
3018                          12 5
3019                          12 6
3020                          <span class="comment">%12 9</span>
3021                          ];
3022             <span class="keyword">end</span>
3023 
3024             OCSx.BPM = getx(BPMlist1, <span class="string">'struct'</span>);
3025             OCSx.CM = getsp(<span class="string">'HCM'</span>, HCMlist1, <span class="string">'struct'</span>);
3026             OCSx.GoalOrbit = getgolden(OCSx.BPM, <span class="string">'numeric'</span>);
3027             OCSx.NIter = 1;
3028             OCSx.SVDIndex = Xivec;
3029             OCSx.IncrementalFlag = <span class="string">'No'</span>;
3030             OCSx.BPMWeight = {[]};
3031             OCSx.FitRF = 0;
3032             OCSy.BPM = gety(BPMlist1, <span class="string">'struct'</span>);
3033             OCSy.CM = getsp(<span class="string">'VCM'</span>, VCMlist1, <span class="string">'struct'</span>);
3034             OCSy.GoalOrbit = getgolden(OCSy.BPM, <span class="string">'numeric'</span>);
3035             OCSy.NIter = 1;
3036             OCSy.SVDIndex = Yivec;
3037             OCSy.IncrementalFlag = <span class="string">'No'</span>;
3038             OCSy.BPMWeight = {[]};
3039             OCSy.FitRF = 0;
3040             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
3041             <span class="comment">% do we need these Smat calls? %</span>
3042             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
3043             SXmat = getrespmat(OCSx.BPM, OCSx.CM, <span class="string">'numeric'</span>);
3044             SYmat = getrespmat(OCSy.BPM, OCSy.CM, <span class="string">'numeric'</span>);
3045             <span class="comment">% [OCSx, Sx, Ux, Vx] = orbitcorrectionmethods(OCSx, SXmat);</span>
3046             <span class="comment">% [OCSy, Sy, Uy, Vy] = orbitcorrectionmethods(OCSy, SYmat);</span>
3047 
3048             <span class="comment">% initialize FFTypeFlag</span>
3049             FFTypeFlag = <span class="string">'Global'</span>;
3050 
3051         <span class="keyword">else</span>
3052 
3053             <span class="comment">% Get vectors</span>
3054             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
3055             <span class="comment">% the two lines below seem to fix BPMlist editing problem</span>
3056             OCSx = FB.OCSx;
3057             OCSy = FB.OCSy;
3058             BPMlist1 = FB.BPMlist1;
3059             HCMlist1 = FB.HCMlist1;
3060             VCMlist1 = FB.VCMlist1;
3061             Xivec = FB.Xivec;
3062             Yivec = FB.Yivec;
3063             Xgoal = FB.OCSx.GoalOrbit;
3064             OCSx.GoalOrbit = Xgoal;
3065             Ygoal = FB.OCSy.GoalOrbit;
3066             OCSy.GoalOrbit = Ygoal;
3067             FFTypeFlag = FB.FFTypeFlag;
3068 
3069 
3070             <span class="comment">% FF corrector magnet list</span>
3071             ListFF = [
3072                 4     2
3073                 4     8
3074                 5     1
3075                 5     7
3076 <span class="comment">%               5     8 % why are these out???</span>
3077 <span class="comment">%               6     1 % why are these out???</span>
3078                 6     8
3079                 7     1
3080                 7     8
3081                 8     1
3082                 8     8
3083                 9     1
3084                 9     8
3085                 10    1
3086                 11    8
3087                 12    1];
3088             ElemFF = dev2elem(<span class="string">'HCM'</span>,ListFF);
3089 
3090 
3091             <span class="comment">% Add button to change #ivectors, cm, IDBPMs,</span>
3092             EditFlag = 0;
3093             h_fig1 = figure;
3094             <span class="keyword">while</span> EditFlag ~= 6
3095 
3096                 Sx = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
3097                 Sy = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
3098                 
3099                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
3100                     DispOrbit = getdisp(<span class="string">'BPMx'</span>, BPMlist1);
3101                     Sx = [Sx DispOrbit];
3102                 <span class="keyword">end</span>
3103                 
3104                 [Ux, SVx, Vx] = svd(Sx);
3105                 [Uy, SVy, Vy] = svd(Sy);
3106 
3107                 
3108                 <span class="comment">% Remove singular values greater than the actual number of singular values</span>
3109                 i = find(Xivec&gt;length(diag(SVx)));
3110                 <span class="keyword">if</span> ~isempty(i)
3111                     disp(<span class="string">'   Horizontal E-vector scaled since there were more elements in the vector than singular values.'</span>);
3112                     pause(0);
3113                     Xivec(i) = [];
3114                 <span class="keyword">end</span>
3115                 i = find(Yivec&gt;length(diag(SVy)));
3116                 <span class="keyword">if</span> ~isempty(i)
3117                     disp(<span class="string">'   Vertical E-vector scaled since there were more elements in the vector than singular values.'</span>);
3118                     pause(0);
3119                     Yivec(i) = [];
3120                 <span class="keyword">end</span>
3121 
3122 
3123                 Ax = Sx*Vx(:,Xivec);
3124                 Tx = inv(Ax'*Ax)*Ax';
3125 
3126                 Ay = Sy*Vy(:,Yivec);
3127                 Ty = inv(Ay'*Ay)*Ay';
3128 
3129                 figure(h_fig1);
3130                 subplot(2,1,1);
3131                 semilogy(diag(SVx),<span class="string">'b'</span>);
3132                 hold on;
3133                 semilogy(diag(SVx(Xivec,Xivec)),<span class="string">'xr'</span>);
3134                 ylabel(<span class="string">'Horizontal'</span>);
3135                 title(<span class="string">'Response Matrix Singular Values'</span>);
3136                 hold off;
3137                 subplot(2,1,2);
3138                 semilogy(diag(SVy),<span class="string">'b'</span>);
3139                 hold on;
3140                 semilogy(diag(SVy(Yivec,Yivec)),<span class="string">'xr'</span>);
3141                 xlabel(<span class="string">'Singular Value Number'</span>);
3142                 ylabel(<span class="string">'Vertical'</span>);
3143                 hold off;
3144                 drawnow;
3145 
3146                 EditFlag = menu(<span class="string">'Change Parameters?'</span>,<span class="string">'Singular Values'</span>,<span class="string">'HCM List'</span>,<span class="string">'VCM List'</span>, <span class="keyword">...</span>
3147                     <span class="string">'BPM List'</span>,<span class="string">'Change the Goal Orbit'</span>,<span class="string">'Continue'</span>);
3148 
3149                 <span class="keyword">if</span> EditFlag == 1
3150                     prompt={<span class="string">'Enter the horizontal E-vector numbers (Matlab vector format):'</span>,<span class="string">'Enter the vertical E-vector numbers (Matlab vector format):'</span>};
3151                     def={sprintf(<span class="string">'[%d:%d]'</span>,1,Xivec(end)),sprintf(<span class="string">'[%d:%d]'</span>,1,Yivec(end))};
3152                     titlestr=<span class="string">'SVD Orbit Feedback'</span>;
3153                     lineNo=1;
3154                     answer=inputdlg(prompt,titlestr,lineNo,def);
3155                     <span class="keyword">if</span> ~isempty(answer)
3156                         XivecNew = fix(str2num(answer{1}));
3157                         <span class="keyword">if</span> isempty(XivecNew)
3158                             disp(<span class="string">'   Horizontal E-vector cannot be empty.  No change made.'</span>);
3159                         <span class="keyword">else</span>
3160                             <span class="keyword">if</span> any(XivecNew&lt;=0) | max(XivecNew)&gt;length(diag(SVx))
3161                                 disp(<span class="string">'   Error reading horizontal E-vector.  No change made.'</span>);
3162                             <span class="keyword">else</span>
3163                                 Xivec = XivecNew;
3164                             <span class="keyword">end</span>
3165                         <span class="keyword">end</span>
3166                         YivecNew = fix(str2num(answer{2}));
3167                         <span class="keyword">if</span> isempty(YivecNew)
3168                             disp(<span class="string">'   Vertical E-vector cannot be empty.  No change made.'</span>);
3169                         <span class="keyword">else</span>
3170                             <span class="keyword">if</span> any(YivecNew&lt;=0) | max(YivecNew)&gt;length(diag(SVy))
3171                                 disp(<span class="string">'   Error reading vertical E-vector.  No change made.'</span>);
3172                             <span class="keyword">else</span>
3173                                 Yivec = YivecNew;
3174                             <span class="keyword">end</span>
3175                         <span class="keyword">end</span>
3176                     <span class="keyword">end</span>
3177                 <span class="keyword">end</span>
3178 
3179                 <span class="keyword">if</span> EditFlag == 2
3180                     List= getlist(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>);
3181                     CheckList = zeros(96,1);
3182                     Elem = dev2elem(<span class="string">'HCM'</span>, HCMlist1);
3183                     CheckList(Elem) = ones(size(Elem));
3184                     CheckList = CheckList(dev2elem(<span class="string">'HCM'</span>,List));
3185 
3186                     <span class="comment">% Remove FF corrrectors</span>
3187                     <span class="comment">%           Elem = dev2elem('HCM',List);</span>
3188                     <span class="comment">%           for j = length(ElemFF):-1:1</span>
3189                     <span class="comment">%              i = find(Elem==ElemFF(j));</span>
3190                     <span class="comment">%              Elem(i,:) = [];</span>
3191                     <span class="comment">%              List(i,:) = [];</span>
3192                     <span class="comment">%              CheckList(i,:) = [];</span>
3193                     <span class="comment">%           end</span>
3194 
3195                     newList = editlist(List, <span class="string">'HCMtrim'</span>, CheckList);
3196 
3197                     <span class="keyword">if</span> isempty(newList)
3198                         fprintf(<span class="string">'   WARNING: Horizontal corrector magnet list is empty!\n'</span>);
3199                         HCMlist1 = newList;
3200                     <span class="keyword">else</span>
3201                         HCMlist1 = newList;
3202                     <span class="keyword">end</span>
3203                     OCSx.CM.DeviceList = HCMlist1;
3204                 <span class="keyword">end</span>
3205 
3206                 <span class="keyword">if</span> EditFlag == 3
3207                     List = getlist(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>);
3208                     CheckList = zeros(96,1);
3209                     Elem = dev2elem(<span class="string">'VCM'</span>, VCMlist1);
3210                     CheckList(Elem) = ones(size(Elem));
3211                     CheckList = CheckList(dev2elem(<span class="string">'VCM'</span>,List));
3212 
3213                     <span class="comment">% Remove FF corrrectors</span>
3214                     <span class="comment">%           Elem = dev2elem('VCM',List);</span>
3215                     <span class="comment">%           for j = length(ElemFF):-1:1</span>
3216                     <span class="comment">%              i = find(Elem==ElemFF(j));</span>
3217                     <span class="comment">%              Elem(i,:) = [];</span>
3218                     <span class="comment">%              List(i,:) = [];</span>
3219                     <span class="comment">%              CheckList(i,:) = [];</span>
3220                     <span class="comment">%           end</span>
3221 
3222                     newList = editlist(List, <span class="string">'VCMtrim'</span>, CheckList);
3223 
3224                     <span class="keyword">if</span> isempty(newList)
3225                         fprintf(<span class="string">'   WARNING: Vertical corrector magnet list is empty!\n'</span>);
3226                         VCMlist1 = newList;
3227                     <span class="keyword">else</span>
3228                         VCMlist1 = newList;
3229                     <span class="keyword">end</span>
3230                     OCSy.CM.DeviceList = VCMlist1;
3231                 <span class="keyword">end</span>
3232 
3233                 <span class="keyword">if</span> EditFlag == 4
3234                     ListOld = BPMlist1;
3235                     XgoalOld = Xgoal;
3236                     YgoalOld = Ygoal;
3237 
3238                     <span class="comment">% Full BPM list</span>
3239                     List = [
3240                         1 2
3241                         1 5
3242                         1 6
3243                         1 10
3244                         2 1
3245                         2 5
3246                         2 6
3247                         2 9
3248                         3 2
3249                         3 5
3250                         3 6
3251                         3 10
3252                         3 11
3253                         3 12
3254                         4 1
3255                         4 5
3256                         4 6
3257                         4 10
3258                         5 1
3259                         5 5
3260                         5 6
3261                         5 10
3262                         5 11
3263                         5 12
3264                         6 1
3265                         6 5
3266                         6 6
3267                         6 10
3268                         7 1
3269                         7 5
3270                         7 6
3271                         7 10
3272                         8 1
3273                         8 5
3274                         8 6
3275                         8 10
3276                         9 1
3277                         9 5
3278                         9 6
3279                         9 10
3280                         10 1
3281                         10 5
3282                         10 6
3283                         10 10
3284                         10 11
3285                         10 12
3286                         11 1
3287                         11 5
3288                         11 6
3289                         11 10
3290                         12 1
3291                         12 5
3292                         12 6
3293                         12 9
3294                         ];
3295 
3296 
3297                     CheckList = zeros(size(List,1),1);
3298                     <span class="keyword">if</span> ~isempty(BPMlist1)
3299                         <span class="keyword">for</span> i = 1:size(List,1)
3300                             k = find(List(i,1)==BPMlist1(:,1));
3301                             l = find(List(i,2)==BPMlist1(k,2));
3302 
3303                             <span class="keyword">if</span> isempty(k) | isempty(l)
3304                                 <span class="comment">% Item not in list</span>
3305                             <span class="keyword">else</span>
3306                                 CheckList(i) = 1;
3307                             <span class="keyword">end</span>
3308                         <span class="keyword">end</span>
3309                     <span class="keyword">end</span>
3310 
3311                     newList = editlist(List, <span class="string">'BPM'</span>, CheckList);
3312                     <span class="keyword">if</span> isempty(newList)
3313                         fprintf(<span class="string">'   BPM list cannot be empty.  No change made.\n'</span>);
3314                     <span class="keyword">else</span>
3315                         BPMlist1 = newList;
3316                     <span class="keyword">end</span>
3317 
3318                     <span class="comment">% Set the goal orbit to the golden orbit</span>
3319                     Xgoal = getgolden(<span class="string">'BPMx'</span>, BPMlist1);
3320                     Ygoal = getgolden(<span class="string">'BPMy'</span>, BPMlist1);
3321 
3322 
3323                     <span class="comment">% If a new BPM is added, then set the goal orbit to the golden orbit</span>
3324                     <span class="keyword">for</span> i = 1:size(BPMlist1,1)
3325 
3326                         <span class="comment">% Is it a new BPM?</span>
3327                         k = find(BPMlist1(i,1)==ListOld(:,1));
3328                         l = find(BPMlist1(i,2)==ListOld(k,2));
3329 
3330                         <span class="keyword">if</span> isempty(k) | isempty(l)
3331                             <span class="comment">% New BPM</span>
3332                         <span class="keyword">else</span>
3333                             <span class="comment">% Use the old value for old BPM</span>
3334                             Xgoal(i) = XgoalOld(k(l));
3335                             Ygoal(i) = YgoalOld(k(l));
3336                         <span class="keyword">end</span>
3337                     <span class="keyword">end</span>
3338                     OCSx.BPM.DeviceList = BPMlist1;
3339                     OCSy.BPM.DeviceList = BPMlist1;
3340                     OCSx.GoalOrbit = Xgoal;
3341                     OCSy.GoalOrbit = Ygoal;
3342                 <span class="keyword">end</span>
3343 
3344                 <span class="keyword">if</span> EditFlag == 5
3345                     ChangeList = editlist2(BPMlist1, <span class="string">'Change BPM'</span>, zeros(size(BPMlist1,1),1));
3346 
3347                     <span class="keyword">for</span> i = 1:size(ChangeList,1)
3348 
3349                         k = find(ChangeList(i,1)==BPMlist1(:,1));
3350                         l = find(ChangeList(i,2)==BPMlist1(k,2));
3351 
3352                         prompt={sprintf(<span class="string">'Enter the new horizontal goal orbit for BPMx(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2)),sprintf(<span class="string">'Enter the new vertical goal orbit for BPMy(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2))};
3353                         def={sprintf(<span class="string">'%f'</span>,Xgoal(k(l))),sprintf(<span class="string">'%f'</span>,Ygoal(k(l)))};
3354                         titlestr=<span class="string">'CHANGE THE GOAL ORBIT'</span>;
3355                         lineNo=1;
3356                         answer = inputdlg(prompt, titlestr, lineNo, def);
3357 
3358                         <span class="keyword">if</span> isempty(answer)
3359                             <span class="comment">% No change</span>
3360                             fprintf(<span class="string">'   No change was made to the golden orbit.\n'</span>);
3361                         <span class="keyword">else</span>
3362                             Xgoalnew = str2num(answer{1});
3363                             <span class="keyword">if</span> isempty(Xgoalnew)
3364                                 fprintf(<span class="string">'   No change was made to the horizontal golden orbit.\n'</span>);
3365                             <span class="keyword">else</span>
3366                                 Xgoal(k(l)) = Xgoalnew;
3367                             <span class="keyword">end</span>
3368 
3369                             Ygoalnew = str2num(answer{2});
3370                             <span class="keyword">if</span> isempty(Ygoalnew)
3371                                 fprintf(<span class="string">'   No change was made to the vertical golden orbit.\n'</span>);
3372                             <span class="keyword">else</span>
3373                                 Ygoal(k(l)) = Ygoalnew;
3374                             <span class="keyword">end</span>
3375                         <span class="keyword">end</span>
3376                     <span class="keyword">end</span>
3377                     <span class="keyword">if</span> ~isempty(ChangeList)
3378                         fprintf(<span class="string">'   Note:  Changing the goal orbit for &quot;Slow Orbit Feedback&quot; does not change the goal orbit for &quot;Orbit Correction.&quot;\n'</span>);
3379                         fprintf(<span class="string">'          Re-running srcontrol will restart the goal orbit to the golden orbit.&quot;\n'</span>);
3380                     <span class="keyword">end</span>
3381                     OCSx.GoalOrbit = Xgoal;
3382                     OCSy.GoalOrbit = Ygoal;
3383                 <span class="keyword">end</span>
3384 
3385 <span class="comment">%                 if EditFlag == 6</span>
3386 <span class="comment">%                     FFTypeFlag = questdlg(sprintf('Do you want to use a fully local or a combined local/global compensation of IDs? (nuy=9.2 only)'),'Tune FF','Local','Global', 'Global');</span>
3387 <span class="comment">%                     if strcmp(FFTypeFlag,'Local')</span>
3388 <span class="comment">%                         disp(['   The tune FF will use 8 local quadrupoles to compensate beta beating and tune shift']);</span>
3389 <span class="comment">%                         disp(['   from each ID.']);</span>
3390 <span class="comment">%                     elseif strcmp(FFTypeFlag,'Global')</span>
3391 <span class="comment">%                         disp(['   The tune FF will use 4 local quadrupoles to compensate beta beating and all QF+QD']);</span>
3392 <span class="comment">%                         disp(['   to compensate tune shift from each ID.']);</span>
3393 <span class="comment">%                     end</span>
3394 <span class="comment">%                 end</span>
3395 
3396             <span class="keyword">end</span>
3397             close(h_fig1);
3398         <span class="keyword">end</span>
3399 
3400         <span class="comment">% Save vectors</span>
3401         FB.Xivec = Xivec;
3402         FB.Yivec = Yivec;
3403         FB.HCMlist1 = HCMlist1;
3404         FB.VCMlist1 = VCMlist1;
3405         FB.BPMlist1 = BPMlist1;
3406 
3407         OCSx.SVDIndex = Xivec;
3408         OCSy.SVDIndex = Yivec;
3409         FB.OCSx = OCSx;
3410         FB.OCSy = OCSy;
3411 
3412         FB.FFTypeFlag = FFTypeFlag;
3413         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>,FB);
3414 
3415 
3416     <span class="keyword">case</span> <span class="string">'FastFeedbackSetup'</span>
3417 
3418         InitFlag = Input2;
3419 
3420         <span class="keyword">if</span> InitFlag
3421             FOFBFreq = 1000;
3422             <span class="comment">% user operations 9/14-10/17/04: P=0.5, I=120, D=0.0015 (for both planes)</span>
3423             <span class="comment">% below are known good values for user ops as of 8-1-05</span>
3424             HorP = 2;
3425             HorI = 300;
3426             HorD = 0.002;
3427             VertP = 1;
3428             VertI = 100;
3429             VertD = 0.0015;
3430 
3431             <span class="comment">% this initial set is now done in hwinit.m because it's not a good idea to set anything when srcontrol is launched</span>
3432             <span class="comment">% try</span>
3433             <span class="comment">%     setsp('SR01____FFBFREQAC00', FOFBFreq); % set freq</span>
3434             <span class="comment">%     write_pid_ffb2_patch(HorP, HorI, HorD, VertP, VertI, VertD);</span>
3435             <span class="comment">% catch</span>
3436             <span class="comment">%     disp('   Trouble setting Fast Orbit Feedback parameters!');</span>
3437             <span class="comment">% end</span>
3438 
3439         <span class="keyword">else</span>
3440             <span class="comment">% Get vectors</span>
3441             FOFB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
3442             FOFBFreq = FOFB.FOFBFreq;
3443             HorP  = FOFB.HorP;
3444             HorI  = FOFB.HorI;
3445             HorD  = FOFB.HorD;
3446             VertP = FOFB.VertP;
3447             VertI = FOFB.VertI;
3448             VertD = FOFB.VertD;
3449 
3450             <span class="comment">% Add button to change #ivectors, CMs, IDBPMs,</span>
3451             EditFlag = 0;
3452             <span class="comment">%h_fig1 = figure;</span>
3453             <span class="keyword">while</span> EditFlag ~= 3
3454 
3455                 <span class="comment">%EditFlag = menu('Change Parameters?', 'Fast Feedback Frequency', 'PID Values', 'HCM List', 'VCM List', ...</span>
3456                 <span class="comment">%   'IDBPM List', 'BBPM List', 'Continue');</span>
3457                 <span class="comment">% Use menu below until other FFB config routines work (then also uncomment options 3,4,5,6 below)</span>
3458                 EditFlag = menu(<span class="string">'Change Parameters?'</span>, <span class="string">'Fast Feedback Frequency'</span>, <span class="string">'PID Values'</span>, <span class="string">'Continue'</span>);
3459 
3460                 <span class="keyword">if</span> EditFlag == 1
3461                     <span class="comment">% change rate</span>
3462 
3463                     prompt={<span class="string">'Enter the desired Fast Feedback Frequency (1-1000 Hz)'</span>};
3464                     def={num2str(FOFBFreq)};
3465                     titlestr=<span class="string">'Fast Feedback Setup'</span>;
3466                     lineNo=1;
3467                     answer=inputdlg(prompt,titlestr,lineNo,def);
3468                     <span class="keyword">if</span> ~isempty(answer)
3469                         FOFBFreq = fix(str2num(answer{1}));
3470                         <span class="keyword">if</span> isempty(FOFBFreq)
3471                             disp(<span class="string">'   Frequency value cannot be empty.  No change made.'</span>);
3472                             FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3473                         <span class="keyword">else</span>
3474                             <span class="keyword">if</span> FOFBFreq &lt; 1 | FOFBFreq &gt; 1000
3475                                 disp(<span class="string">'   Frequency must be between 1 and 1000 Hz.  No change made.'</span>);
3476                                 FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3477                             <span class="keyword">end</span>
3478                         <span class="keyword">end</span>
3479                         setsp(<span class="string">'SR01____FFBFREQAC00'</span>,FOFBFreq   ); <span class="comment">% change freq</span>
3480                         pause(0.5);
3481                         fprintf(<span class="string">'   Fast orbit feedback frequency is running at %.0f Hz.\n'</span>, getpv(<span class="string">'SR01____FFBFREQAM00'</span>));
3482                     <span class="keyword">else</span>
3483                         FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3484                     <span class="keyword">end</span>
3485                 <span class="keyword">end</span>
3486 
3487                 <span class="keyword">if</span> EditFlag == 2
3488                     <span class="comment">% edit  PIDs</span>
3489                     <span class="comment">% User defaults are HorP=2, HorI=300, HorD=0.002, VertP=1, VertI=100, VertD=0.0015</span>
3490                     prompt={<span class="string">'P horizontal'</span>, <span class="string">'I horizontal'</span>, <span class="string">'D horizontal'</span>, <span class="string">'P vertical'</span>, <span class="string">'I vertical'</span>, <span class="string">'D vertical'</span>};
3491                     def={num2str(HorP), num2str(HorI), num2str(HorD), num2str(VertP), num2str(VertI), num2str(VertD)};
3492                     titlestr=<span class="string">'Fast Feedback PID Setup'</span>;
3493                     lineNo=1;
3494                     answer=inputdlg(prompt,titlestr,lineNo,def);
3495                     <span class="keyword">if</span> ~isempty(answer)
3496                         HorPnewnum = str2num(answer{1});
3497                         <span class="keyword">if</span> isempty(HorPnewnum)
3498                             disp(<span class="string">'   HorP value cannot be empty.  No change made.'</span>);
3499                         <span class="keyword">else</span>
3500                             HorP = HorPnewnum;
3501                         <span class="keyword">end</span>
3502                         HorInewnum = str2num(answer{2});
3503                         <span class="keyword">if</span> isempty(HorInewnum)
3504                             disp(<span class="string">'   HorI value cannot be empty.  No change made.'</span>);
3505                         <span class="keyword">else</span>
3506                             HorI = HorInewnum;
3507                         <span class="keyword">end</span>
3508                         HorDnewnum = str2num(answer{3});
3509                         <span class="keyword">if</span> isempty(HorDnewnum)
3510                             disp(<span class="string">'   HorD value cannot be empty.  No change made.'</span>);
3511                         <span class="keyword">else</span>
3512                             HorD = HorDnewnum;
3513                         <span class="keyword">end</span>
3514                         VertPnewnum = str2num(answer{4});
3515                         <span class="keyword">if</span> isempty(VertPnewnum)
3516                             disp(<span class="string">'   VertP value cannot be empty.  No change made.'</span>);
3517                         <span class="keyword">else</span>
3518                             VertP = VertPnewnum;
3519                         <span class="keyword">end</span>
3520                         VertInewnum = str2num(answer{5});
3521                         <span class="keyword">if</span> isempty(VertInewnum)
3522                             disp(<span class="string">'   VertI value cannot be empty.  No change made.'</span>);
3523                         <span class="keyword">else</span>
3524                             VertI = VertInewnum;
3525                         <span class="keyword">end</span>
3526                         VertDnewnum = str2num(answer{6});
3527                         <span class="keyword">if</span> isempty(VertDnewnum)
3528                             disp(<span class="string">'   VertD value cannot be empty.  No change made.'</span>);
3529                         <span class="keyword">else</span>
3530                             VertD = VertDnewnum;
3531                         <span class="keyword">end</span>
3532 
3533                         <span class="keyword">try</span>
3534                             write_pid_ffb2_patch(HorP, HorI, HorD, VertP, VertI, VertD);
3535                             fprintf(<span class="string">'   Setting FFB gains to Horizontal P=%.2f, I=%.1f, D=%.4f;  Vertical P=%.2f, I=%.1f, D=%.4f\n'</span>, HorP, HorI, HorD, VertP, VertI, VertD);
3536                         <span class="keyword">catch</span>
3537                             disp(<span class="string">'   Trouble setting Fast Orbit Feedback parameters!'</span>);
3538                         <span class="keyword">end</span>
3539                     <span class="keyword">end</span>
3540                 <span class="keyword">end</span>
3541 
3542                 <span class="comment">%if EditFlag == 3</span>
3543                 <span class="comment">%   disp('   This function not yet available.');</span>
3544                 <span class="comment">%   % change HCM List</span>
3545                 <span class="comment">%end</span>
3546                 <span class="comment">%</span>
3547                 <span class="comment">%if EditFlag == 4</span>
3548                 <span class="comment">%   disp('   This function not yet available.');</span>
3549                 <span class="comment">%   % change VCM List</span>
3550                 <span class="comment">%end</span>
3551                 <span class="comment">%</span>
3552                 <span class="comment">%if EditFlag == 5</span>
3553                 <span class="comment">%   disp('   This function not yet available.');</span>
3554                 <span class="comment">%   % change IDBPM List</span>
3555                 <span class="comment">%end</span>
3556                 <span class="comment">%</span>
3557                 <span class="comment">%if EditFlag == 6</span>
3558                 <span class="comment">%   disp('   This function not yet available.');</span>
3559                 <span class="comment">%   % change BBPM List</span>
3560                 <span class="comment">%end</span>
3561 
3562             <span class="keyword">end</span>
3563             <span class="comment">%close(h_fig1);</span>
3564         <span class="keyword">end</span>
3565 
3566         <span class="comment">% Save vectors</span>
3567         FOFB.FOFBFreq = FOFBFreq;
3568         FOFB.HorP = HorP;
3569         FOFB.HorI = HorI;
3570         FOFB.HorD = HorD;
3571         FOFB.VertP = VertP;
3572         FOFB.VertI = VertI;
3573         FOFB.VertD = VertD;
3574         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Userdata'</span>,FOFB);
3575 
3576     <span class="keyword">otherwise</span>
3577         fprintf(<span class="string">'   No action for %s.\n'</span>, action);
3578 <span class="keyword">end</span>   <span class="comment">% end case</span></pre></div>
<hr><address>Generated on Thu 02-Aug-2007 13:16:07 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>