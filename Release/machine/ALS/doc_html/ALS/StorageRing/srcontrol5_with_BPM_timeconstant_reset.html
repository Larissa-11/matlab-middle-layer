<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of srcontrol5_with_BPM_timeconstant_reset</title>
  <meta name="keywords" content="srcontrol5_with_BPM_timeconstant_reset">
  <meta name="description" content="srcontrol5">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">ALS</a> &gt; <a href="index.html">StorageRing</a> &gt; srcontrol5_with_BPM_timeconstant_reset.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for ALS\StorageRing&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>srcontrol5_with_BPM_timeconstant_reset
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>srcontrol5</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function srcontrol5(action, Input2, Input3) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> srcontrol5
 Storage ring control program

 This program controls all storage ring magnets, performs orbit feedback and
 tune feedforward and helps to diagnose problems in routine user operation
 of the ALS storage ring. It includes a gui to simplify the use of this
 program.

 It was originally programmed by Greg Portmann (until December 2000) with input
 from Winfried Decking, David Robin, Christoph Steier, Ying Wu and others
 and is currently (July 2002) maintained by Christoph Steier and Tom Scarvie.

 The actual version of this program is srcontrol5 (is called by default if you call srcontrol).

 Christoph Steier, July 2002

 SRCONTROL5 is the newest versionof SRCONTROL, edited to work with G. Portmann's new (2005) Matlab middle layer.

 Tom Scarvie, April 2005</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>	BEND2GEV - Compute the energy based on the ramp tables</li><li><a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>	CHECKSRMAGS - Check SR power supplies against a lattice file</li><li><a href="checksrorbit.html" class="code" title="function ErrorNums = checksrorbit(SectorList, BPMxtol,BPMytol)">checksrorbit</a>	ErrorNums =checksrorbit(Sector, BPMxtolerance [.015 mm], [BPMytolerance [.015 mm]])</li><li><a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>	GAP2TUNE - Computes the vertical tune shift for a insertion device gap change.</li><li><a href="gaplimit.html" class="code" title="function [GAPmin, GAPmax] = gaplimit(Dev);">gaplimit</a>	[GapMin, GapMax] = gaplimit(ID_Number);</li><li><a href="getbpmtimeconstant.html" class="code" title="function [BPMTimeConstant, WarningFlag] = getbpmtimeconstant(varargin)">getbpmtimeconstant</a>	GETBPMTIMECONSTANT - Sets the timeconstants for the Bergoz style BPMs.</li><li><a href="getff.html" class="code" title="function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)">getff</a>	function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)</li><li><a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>	GETID - Get the insertion device position, velocity, run flag, and user requested gap</li><li><a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>	[StateNumber, StateString] = getsrstate</li><li><a href="set_alarmhandler_AHU_thresholds_inject.html" class="code" title="function set_alarmhandler_AHU_thresholds_inject">set_alarmhandler_AHU_thresholds_inject</a>	function set_alarmhandler_AHU_thresholds_inject</li><li><a href="set_alarmhandler_thresholds.html" class="code" title="function set_alarmhandler_thresholds">set_alarmhandler_thresholds</a>	set_alarmhandler_thresholds</li><li><a href="set_alarmhandler_thresholds_new.html" class="code" title="function set_alarmhandler_thresholds_new">set_alarmhandler_thresholds_new</a>	set_alarmhandler_thresholds_new</li><li><a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>	SETBPMTIMECONSTANT - Sets the timeconstants for the Bergoz style BPMs.</li><li><a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>	SETBUMPS - Make a straight section bump</li><li><a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>	function setff(Sector, FFEnableBC, GapEnableBC)</li><li><a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>	SETID - Set the insertion device vertical gap</li><li><a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>	</li><li><a href="shift2tune.html" class="code" title="function [Dnux, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = shift2tune(Sector, Gap, EPUshift, GeV)">shift2tune</a>	SHIFT2TUNE - Computes the horizontal tune shift for a EPU gap and horizontal shift</li><li><a href="srcycle.html" class="code" title="function FailFlag = srcycle(varargin)">srcycle</a>	SRCYCLE - Storage ring cycle</li><li><a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>	SRRAMP - Ramp the storage ring energy</li><li><a href="write_goldenorbit_ffb.html" class="code" title="function write_goldenorbit_ffb">write_goldenorbit_ffb</a>	function write_goldenorbit_ffb</li><li><a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>	WRITE_GOLDENORBIT_FFTB_2PLANES - Sets the BPM setpoints which are used by the fast feedback system</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function srcontrol5(action, Input2, Input3)</a>
0002 <span class="comment">% srcontrol5</span>
0003 <span class="comment">% Storage ring control program</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% This program controls all storage ring magnets, performs orbit feedback and</span>
0006 <span class="comment">% tune feedforward and helps to diagnose problems in routine user operation</span>
0007 <span class="comment">% of the ALS storage ring. It includes a gui to simplify the use of this</span>
0008 <span class="comment">% program.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% It was originally programmed by Greg Portmann (until December 2000) with input</span>
0011 <span class="comment">% from Winfried Decking, David Robin, Christoph Steier, Ying Wu and others</span>
0012 <span class="comment">% and is currently (July 2002) maintained by Christoph Steier and Tom Scarvie.</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% The actual version of this program is srcontrol5 (is called by default if you call srcontrol).</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% Christoph Steier, July 2002</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% SRCONTROL5 is the newest versionof SRCONTROL, edited to work with G. Portmann's new (2005) Matlab middle layer.</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% Tom Scarvie, April 2005</span>
0021 
0022 <span class="comment">% known bugs/problems (May 2001):</span>
0023 <span class="comment">% - IDBPM averaging might be a bit too long for orbit feedback</span>
0024 <span class="comment">%        solved after Superbend shutdown ... Instead of averaging, digital low pass filters are used</span>
0025 <span class="comment">% - gap2tune does not give correct answers for wiggler and potentially other IDs -&gt; orbit feedback</span>
0026 <span class="comment">%        seems to be OK for other IDs, has been corrected for wiggler (fit to insertion device</span>
0027 <span class="comment">%        compensation table)</span>
0028 <span class="comment">% - chicanes do not work in orbit feedback</span>
0029 <span class="comment">%        solved. One problem was that orbit response matrizes were mis-scaled by factor of two.</span>
0030 <span class="comment">%        Second problem was different time constant of power supply control. Solved by moving controls</span>
0031 <span class="comment">%        of center chicanes to cPCI (and magnets are fast, hysteresis free, aircore coils).</span>
0032 <span class="comment">%        Center chicane in sector 4 is now routinely used in orbit feedback. Sector 11 to follow soon.</span>
0033 <span class="comment">% - zero reading of ID gap dumps beam</span>
0034 <span class="comment">%        solved in srcontrol5, still a problem in srcontrol5_hightune (but that routine has to be completely</span>
0035 <span class="comment">%        rewritten because of all recent changes to srcontrol5, anyhow). For gap readings below the minimum</span>
0036 <span class="comment">%        allowed gap for a device, the tune feedforward disables itself.</span>
0037 <span class="comment">% - cycling of lattice causes frequent power supply failures</span>
0038 <span class="comment">%        solved by changing the cycling procedure. 1.5 GeV operation is now on the upper hysteresis branch</span>
0039 <span class="comment">%        as was the 1.9 GeV injection lattice before.</span>
0040 <span class="comment">% - frequently stalled data in IDBPM readout</span>
0041 <span class="comment">%        solved with new BPM readouts and digital filtering. Seems to have been a resolution problem</span>
0042 <span class="comment">%        of the digital averaging algorithm.</span>
0043 <span class="comment">% - magnet ramp tables are not in perfect agreement with magnetic measurements</span>
0044 <span class="comment">%        Does not appear to be a serious problem. Superbends are slightly out of sync with other magnets,</span>
0045 <span class="comment">%        but this does not cause any negative effects while ramping.</span>
0046 <span class="comment">% - no good way to operate with injection at 1.5 GeV and storage energy below that</span>
0047 <span class="comment">%        There now is a reasonable way to inject at 1.5 GeV and ramp down to lower storage energy. But</span>
0048 <span class="comment">%        it has to be tested again after implementing new (and more) chicanes ...</span>
0049 
0050 <span class="comment">% revision history</span>
0051 <span class="comment">% 2001-05-10, Christoph Steier</span>
0052 <span class="comment">% check whether readback from insertion device is significantly (more than 1 mm) below minimum</span>
0053 <span class="comment">% gap, to avoid false zero readings of insertion device gaps to cause the tune feed forward</span>
0054 <span class="comment">% to implement false huge correction (and dump the beam). If the insertion device gap readbacks</span>
0055 <span class="comment">% gets more than 1 mm below the nominal minimum gap, the routine now assumes the insertion device</span>
0056 <span class="comment">% to be open.</span>
0057 <span class="comment">%</span>
0058 <span class="comment">% 2001-08-30 and during Superbend commissioning, Christoph Steier, Tom Scarvie, Winni Decking</span>
0059 <span class="comment">% various changes have been made to incorporate the Superbends and some other new equipment</span>
0060 <span class="comment">% installed in the Superbend shutdown. This included some changes to programs being called by srcontrol</span>
0061 <span class="comment">% (like srload, srsave, srcycle, srramp, ...). The main changes within srcontrol were in the orbit</span>
0062 <span class="comment">% correction and slow orbit feedback routines (incorporating frequency feedback, ...)</span>
0063 <span class="comment">%</span>
0064 <span class="comment">% 2002-05-04, Christoph Steier</span>
0065 <span class="comment">% added new IDBPMs, modified orbit feedback to use trim DACs, removed LSB toggling in vertical</span>
0066 <span class="comment">% orbit feedback, ...</span>
0067 <span class="comment">%</span>
0068 
0069 <span class="comment">% 2002-07-29, T.Scarvie</span>
0070 <span class="comment">% added check of CM trim currents to warn of problems that might rail the orbit feedback</span>
0071 <span class="comment">%</span>
0072 <span class="comment">% 2002-07-31, Christoph Steier</span>
0073 <span class="comment">% increased the gain of the RF frequency feedback from 1/50 of the gain of the horizontal</span>
0074 <span class="comment">% orbit feedback to 1/20. Reason was that the frequency feedback was reacting a bit too slow if all</span>
0075 <span class="comment">% insertion device gaps are closed at once at high speed at the beginning of a fill.</span>
0076 <span class="comment">%</span>
0077 <span class="comment">% 2002-08-05, C.Steier, T.Scarvie</span>
0078 <span class="comment">% Added conditional to reduce orbit feedback gain if running in two-bunch mode</span>
0079 <span class="comment">%</span>
0080 <span class="comment">% 2003-06-02, T.Scarvie</span>
0081 <span class="comment">% Added loop inside orbit feedback to reset the SR11 chicane M1 and M2 motors every 20s to combat drift problem</span>
0082 <span class="comment">%</span>
0083 <span class="comment">% 2003-06-18, C. Steier</span>
0084 <span class="comment">% Disabled loop to periodically reset chicane in SR11. Al Robb replaced power supply, seems to be no problem anymore.</span>
0085 <span class="comment">%</span>
0086 <span class="comment">% 2004-05-10, C. Steier</span>
0087 <span class="comment">% The list of all BBPMs is now set up automatically be calling getlist('BBPMx'). This way, new BBPMs have to be added</span>
0088 <span class="comment">% at fewer places in the software. It should now be sufficient to modify getlist and run the orbit response matrix</span>
0089 <span class="comment">% rountine (getsmat) once to enable use of the new BBPMs.</span>
0090 <span class="comment">%</span>
0091 <span class="comment">% 2004-05-14, C. Steier</span>
0092 <span class="comment">% Modified parameters for ramprate reduction (in srramp and here). Previous parameters were slightly too</span>
0093 <span class="comment">% cautious. Increased initial slow ramprate to 0.4 A/s.</span>
0094 <span class="comment">%</span>
0095 <span class="comment">% 2004-05-14, C. Steier</span>
0096 <span class="comment">% Incorporated insertion device compensation schemes for nu_y = 9.2 lattice.</span>
0097 <span class="comment">%</span>
0098 <span class="comment">% 2004-06-14, T.Scarvie</span>
0099 <span class="comment">% Added controls for fast orbit feedback</span>
0100 <span class="comment">%</span>
0101 <span class="comment">% 2004-06-21, C. Steier</span>
0102 <span class="comment">% Added tune feedforward (in the global tune compensation scheme for the nu_y=9.2 lattice) for the shift</span>
0103 <span class="comment">% dependent tune shift of the EPUs, as well as a skew quadrupole feedforward for the EPU im sector 11</span>
0104 <span class="comment">% (both only active in parallel mode so far).</span>
0105 <span class="comment">%</span>
0106 <span class="comment">% 2005-02-13, T.Scarvie</span>
0107 <span class="comment">% Separated horizontal and vertical planes for setting Fast Feedback PIDs</span>
0108 
0109 
0110 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0111 <span class="comment">% NOTES for conversion to new Middle Layer %</span>
0112 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0113 <span class="comment">%</span>
0114 <span class="comment">% We never use the gap and bump control flags - the radio buttons have been disabled -</span>
0115 <span class="comment">%        should we try to keep the functionality?</span>
0116 <span class="comment">%</span>
0117 <span class="comment">% remove handle globals</span>
0118 <span class="comment">% set(0,'showhiddenhandles','on'); what does this do?</span>
0119 <span class="comment">% grampbsc -&gt; should be handled by new srramp (which uses k-values)</span>
0120 <span class="comment">% checksrmags</span>
0121 <span class="comment">% checksrorbit(...)</span>
0122 <span class="comment">% getdcct</span>
0123 <span class="comment">% setbpmtimeconstant</span>
0124 <span class="comment">% getsmatelements</span>
0125 <span class="comment">% Chicane trims are now part of the corrector family</span>
0126 <span class="comment">% getname('IDrunflag',...) family name change</span>
0127 <span class="comment">% write_goldenorbit_ffb, write_goldenorbit_ffb2</span>
0128 
0129 
0130 <span class="comment">% For the compiler</span>
0131 <span class="comment">%#function goldenpage</span>
0132 <span class="comment">%#function setoperationalmode</span>
0133 
0134 
0135 <span class="comment">% Check if the AO exists</span>
0136 checkforao;
0137 
0138 
0139 <span class="comment">%%%%%%%%%%%%%%</span>
0140 <span class="comment">% Initialize %</span>
0141 <span class="comment">%%%%%%%%%%%%%%</span>
0142 
0143 <span class="keyword">global</span> FEEDBACK_STOP_FLAG
0144 
0145 SR_Mode = getfamilydata(<span class="string">'OperationalMode'</span>);
0146 SR_GEV = getfamilydata(<span class="string">'Energy'</span>);
0147 
0148 BSCramprate = getfamilydata(<span class="string">'BSCRampRate'</span>);
0149 <span class="keyword">if</span> isnan(BSCramprate) | isempty(BSCramprate)
0150     BSCramprate = 0.4;
0151     setfamilydata(BSCramprate, <span class="string">'BSCRampRate'</span>);
0152 <span class="keyword">end</span>
0153 
0154 <span class="keyword">if</span> nargin &lt; 1
0155     action = <span class="string">'Initialize'</span>;
0156 <span class="keyword">end</span>
0157 <span class="keyword">if</span> nargin &lt; 2
0158     Input2 = 0;
0159 <span class="keyword">end</span>
0160 <span class="keyword">if</span> nargin &lt; 3
0161     Input3 = 0;
0162 <span class="keyword">end</span>
0163 
0164 <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
0165     FOFBcheckboxVal = 0;
0166 <span class="keyword">else</span>
0167     FOFBcheckboxVal = 1;
0168 <span class="keyword">end</span>
0169 
0170 <span class="comment">%%%%%%%%%%%%%%%%</span>
0171 <span class="comment">% Main Program %</span>
0172 <span class="comment">%%%%%%%%%%%%%%%%</span>
0173 
0174 <span class="keyword">switch</span>(action)
0175 
0176     <span class="keyword">case</span> <span class="string">'StopOrbitFeedback'</span>
0177 
0178         FEEDBACK_STOP_FLAG = 1;
0179 
0180     <span class="keyword">case</span> <span class="string">'Initialize'</span>
0181 
0182         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0183         <span class="comment">% GUI</span>
0184         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0185         ButtonWidth = 200;
0186         ButtonHeight  = 25;
0187 
0188         Offset1 = 8*25+12 + 47 + 25+25;
0189         Offset2 = 47+25+25;
0190         Offset3 = 45+25;
0191         Offset4 = 1;
0192         Offset5 = 30;
0193         FigWidth = ButtonWidth+6;
0194         FigHeight  = 3+9*(ButtonHeight+6)+24+Offset1;
0195         ButtonWidth = 200-6;
0196 
0197         <span class="comment">% Change figure position</span>
0198         set(0,<span class="string">'Units'</span>,<span class="string">'pixels'</span>);
0199         p=get(0,<span class="string">'screensize'</span>);
0200 
0201         h0 = figure( <span class="keyword">...</span>
0202             <span class="string">'Color'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0203             <span class="string">'HandleVisibility'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0204             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0205             <span class="string">'MenuBar'</span>,<span class="string">'none'</span>, <span class="keyword">...</span>
0206             <span class="string">'Name'</span>,<span class="string">'ALS SR CONTROL'</span>, <span class="keyword">...</span>
0207             <span class="string">'NumberTitle'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0208             <span class="string">'Units'</span>,<span class="string">'pixels'</span>, <span class="keyword">...</span>
0209             <span class="string">'Position'</span>,[30 p(4)-FigHeight-40 FigWidth FigHeight+Offset5], <span class="keyword">...</span>
0210             <span class="string">'Resize'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0211             <span class="string">'Tag'</span>,<span class="string">'SRCTRLFig1'</span>);
0212 
0213         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0214             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0215             <span class="string">'Callback'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0216             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0217             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0218             <span class="string">'FontWeight'</span>,<span class="string">'Bold'</span>, <span class="keyword">...</span>
0219             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0220             <span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>, <span class="keyword">...</span>
0221             <span class="string">'Position'</span>,[6 3+8*(ButtonHeight+3)+19+19+8+Offset1  ButtonWidth 20+Offset5], <span class="keyword">...</span>
0222             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0223             <span class="string">'String'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0224             <span class="string">'Tag'</span>,<span class="string">'SRCTRLTitle'</span>);
0225 
0226         <span class="comment">% Frame Box I</span>
0227         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0228             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0229             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0230             <span class="string">'Position'</span>,[3 3+3*(ButtonHeight+3)+Offset1-3+Offset5 ButtonWidth+6 7*ButtonHeight+18], <span class="keyword">...</span>
0231             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0232 
0233         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0234             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0235             <span class="string">'Callback'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0236             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0237             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0238             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0239             <span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>, <span class="keyword">...</span>
0240             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)+Offset1  ButtonWidth 15+Offset5], <span class="keyword">...</span>
0241             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0242             <span class="string">'String'</span>,<span class="string">'Lattice Setup Functions'</span>);
0243 
0244         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0245             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Cycle'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0246             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0247             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0248             <span class="string">'Position'</span>,[6 3+8*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0249             <span class="string">'String'</span>,<span class="string">'Cycle SR Lattice'</span>, <span class="keyword">...</span>
0250             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>);
0251 
0252         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0253             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Injection'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0254             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0255             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0256             <span class="string">'Position'</span>,[6 3+7*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0257             <span class="string">'String'</span>,<span class="string">'Injection'</span>, <span class="keyword">...</span>
0258             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>);
0259 
0260         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0261             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Production'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0262             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0263             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0264             <span class="string">'Position'</span>,[6 3+6*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0265             <span class="string">'String'</span>,[<span class="string">'Production'</span>], <span class="keyword">...</span>
0266             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>);
0267 
0268         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0269             <span class="string">'Callback'</span>,[<span class="keyword">...</span>
0270             <span class="string">'fprintf(''\n'');'</span> <span class="keyword">...</span>
0271             <span class="string">'disp([''   **********************************************'']);'</span>, <span class="keyword">...</span>
0272             <span class="string">'disp([''   **  Changing Storage Ring Operational Mode  **'']);'</span>, <span class="keyword">...</span>
0273             <span class="string">'disp([''   **********************************************'']);'</span>, <span class="keyword">...</span>
0274             <span class="string">'setoperationalmode;'</span>, <span class="keyword">...</span>
0275             <span class="string">'srcontrol5(''CheckInputs'');'</span>, <span class="keyword">...</span>
0276             <span class="string">'disp([''   ****************************'']);'</span>, <span class="keyword">...</span>
0277             <span class="string">'disp([''   **  Mode Change Complete  **'']);'</span>, <span class="keyword">...</span>
0278             <span class="string">'disp([''   ****************************'']);'</span>, <span class="keyword">...</span>
0279             <span class="string">'fprintf(''\n'');'</span>], <span class="keyword">...</span>
0280             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0281             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0282             <span class="string">'Position'</span>,[6 3+5*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0283             <span class="string">'Value'</span>,1, <span class="keyword">...</span>
0284             <span class="string">'String'</span>,<span class="string">'Change Operational Mode'</span>, <span class="keyword">...</span>
0285             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>);
0286 
0287         h1 = uicontrol(<span class="keyword">...</span>
0288             <span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0289             <span class="string">'Callback'</span>, [<span class="keyword">...</span>
0290             <span class="string">'srcontrol5(''CheckInputs'');'</span>,<span class="keyword">...</span>
0291             <span class="string">'srcontrol5(''SRState'');'</span>], <span class="keyword">...</span>
0292             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0293             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0294             <span class="string">'Position'</span>,[6 3+4*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0295             <span class="string">'String'</span>,<span class="string">'Check For Problems'</span>, <span class="keyword">...</span>
0296             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>);
0297 
0298         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0299             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs''); goldenpage;'</span>, <span class="keyword">...</span>
0300             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0301             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0302             <span class="string">'Position'</span>,[6 3+3*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0303             <span class="string">'String'</span>,<span class="string">'Golden Page'</span>, <span class="keyword">...</span>
0304             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>);
0305 
0306 
0307         <span class="comment">% Frame Box II</span>
0308         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0309             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0310             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0311             <span class="string">'Position'</span>,[3 3+9*(ButtonHeight+3)-29+Offset2+Offset5 ButtonWidth+6 2*ButtonHeight+15], <span class="keyword">...</span>
0312             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0313         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0314             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0315             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0316             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0317             <span class="string">'Position'</span>,[6 3+10*(ButtonHeight+3)-10+Offset2 ButtonWidth .6*ButtonHeight+Offset5], <span class="keyword">...</span>
0318             <span class="string">'String'</span>,<span class="string">'Global/Local Orbit Correction'</span>, <span class="keyword">...</span>
0319             <span class="string">'Style'</span>,<span class="string">'text'</span>);
0320         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0321             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''OrbitCorrection'');'</span>, <span class="keyword">...</span>
0322             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0323             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0324             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)-6+Offset2+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0325             <span class="string">'String'</span>,<span class="string">'Correct Global Orbit w/ IDBPMs'</span>, <span class="keyword">...</span>
0326             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>);
0327         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0328             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''OrbitCorrectionSetup'',1);'</span>, <span class="keyword">...</span>
0329             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''OrbitCorrectionSetup'',0);'</span>, <span class="keyword">...</span>
0330             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0331             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0332             <span class="string">'Position'</span>,[6 9*(ButtonHeight+3)-22+Offset2+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0333             <span class="string">'String'</span>,<span class="string">'Edit IDBPM, CM, &amp; Local Bump Lists'</span>, <span class="keyword">...</span>
0334             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0335             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0336             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>);
0337 
0338 
0339         <span class="comment">% Frame Box III</span>
0340         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0341             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0342             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0343             <span class="string">'Position'</span>,[3 1*(ButtonHeight)+Offset3+Offset5-38 ButtonWidth+6 8*ButtonHeight+61], <span class="keyword">...</span>
0344             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0345         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0346             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0347             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0348             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0349             <span class="string">'Position'</span>,[6 3+9*(ButtonHeight+3)+Offset3-25 ButtonWidth .55*ButtonHeight+Offset5], <span class="keyword">...</span>
0350             <span class="string">'String'</span>,<span class="string">'Orbit Feedback'</span>, <span class="keyword">...</span>
0351             <span class="string">'Style'</span>,<span class="string">'text'</span>);
0352 
0353         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0354             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0355             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0356             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0357             <span class="string">'Position'</span>,[26 3+8*(ButtonHeight+3)+Offset3-18+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0358             <span class="string">'String'</span>,<span class="string">'Slow Orbit Correction'</span>, <span class="keyword">...</span>
0359             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0360             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0361             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxSOFB'</span>);
0362         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0363             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0364             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0365             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0366             <span class="string">'Position'</span>,[26 3+7*(ButtonHeight+3)+Offset3-9+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0367             <span class="string">'String'</span>,<span class="string">'Fast Orbit Correction'</span>, <span class="keyword">...</span>
0368             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0369             <span class="string">'Value'</span>,FOFBcheckboxVal,<span class="keyword">...</span>
0370             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxFOFB'</span>);
0371 
0372         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0373             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0374             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0375             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0376             <span class="string">'Position'</span>,[26 3+6*(ButtonHeight+3)+Offset3+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0377             <span class="string">'String'</span>,<span class="string">'Correct ID Tune Shift  '</span>, <span class="keyword">...</span>
0378             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0379             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0380             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxTune'</span>);
0381 
0382         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0383             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0384             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0385             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0386             <span class="string">'Position'</span>,[26 3+5*(ButtonHeight+3)+Offset3+9+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0387             <span class="string">'String'</span>,<span class="string">'Correct RF Frequency'</span>, <span class="keyword">...</span>
0388             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0389             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0390             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>);
0391 
0392         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0393             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''Feedback'');'</span>, <span class="keyword">...</span>
0394             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0395             <span class="string">'FontSize'</span>,12, <span class="keyword">...</span>
0396             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0397             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0398             <span class="string">'Position'</span>,[8 3+5*(ButtonHeight+3)+3+Offset3-25+Offset5 .5*ButtonWidth-6 1.0*ButtonHeight], <span class="keyword">...</span>
0399             <span class="string">'String'</span>,<span class="string">'Start FB'</span>, <span class="keyword">...</span>
0400             <span class="string">'Value'</span>,0, <span class="keyword">...</span>
0401             <span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>);
0402         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0403             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''StopOrbitFeedback'');pause(0);'</span>, <span class="keyword">...</span>
0404             <span class="string">'Enable'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0405             <span class="string">'FontSize'</span>,12, <span class="keyword">...</span>
0406             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0407             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0408             <span class="string">'Position'</span>,[.5*FigWidth+3 3+5*(ButtonHeight+3)+3+Offset3-25+Offset5 .5*ButtonWidth-6 1.0*ButtonHeight], <span class="keyword">...</span>
0409             <span class="string">'String'</span>,<span class="string">'Stop FB'</span>, <span class="keyword">...</span>
0410             <span class="string">'Value'</span>,0, <span class="keyword">...</span>
0411             <span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>);
0412 
0413         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0414             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0415             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0416             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0417             <span class="string">'Position'</span>,[14 4*(ButtonHeight)+Offset3+Offset5-3 ButtonWidth-14 .75*ButtonHeight], <span class="keyword">...</span>
0418             <span class="string">'String'</span>,<span class="string">'Horizontal RMS = _____ mm'</span>, <span class="keyword">...</span>
0419             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0420             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>);
0421         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0422             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0423             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0424             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0425             <span class="string">'Position'</span>,[26 3+3.5*(ButtonHeight)+16+Offset3-25+Offset5 ButtonWidth-26 .75*ButtonHeight], <span class="keyword">...</span>
0426             <span class="string">'String'</span>,<span class="string">'Vertical RMS = _____ mm'</span>, <span class="keyword">...</span>
0427             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0428             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>);
0429 
0430         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0431             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''FeedbackSetup'',1);'</span>, <span class="keyword">...</span>
0432             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''FeedbackSetup'',0);'</span>, <span class="keyword">...</span>
0433             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0434             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0435             <span class="string">'Position'</span>,[8 3+3.5*(ButtonHeight)+.5+Offset3-25+Offset5 ButtonWidth-5 .75*ButtonHeight], <span class="keyword">...</span>
0436             <span class="string">'String'</span>,<span class="string">'Edit SOFB Setup'</span>, <span class="keyword">...</span>
0437             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0438             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0439             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>);
0440 
0441         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0442             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0443             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0444             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0445             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0446             <span class="string">'String'</span>,<span class="string">'01 ____'</span>, <span class="keyword">...</span>
0447             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0448             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0449             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>);
0450 
0451         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0452             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0453             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0454             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0455             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0456             <span class="string">'String'</span>,<span class="string">'02 ____'</span>, <span class="keyword">...</span>
0457             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0458             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0459             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>);
0460 
0461         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0462             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0463             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0464             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0465             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0466             <span class="string">'String'</span>,<span class="string">'03 ____'</span>, <span class="keyword">...</span>
0467             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0468             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0469             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>);
0470 
0471         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0472             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0473             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0474             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0475             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-32 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0476             <span class="string">'String'</span>,<span class="string">'04 ____'</span>, <span class="keyword">...</span>
0477             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0478             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0479             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>);
0480 
0481         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0482             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0483             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0484             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0485             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0486             <span class="string">'String'</span>,<span class="string">'05 ____'</span>, <span class="keyword">...</span>
0487             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0488             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0489             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>);
0490 
0491         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0492             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0493             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0494             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0495             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0496             <span class="string">'String'</span>,<span class="string">'06 ____'</span>, <span class="keyword">...</span>
0497             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0498             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0499             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>);
0500 
0501         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0502             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0503             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0504             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0505             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0506             <span class="string">'String'</span>,<span class="string">'07 ____'</span>, <span class="keyword">...</span>
0507             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0508             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0509             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>);
0510 
0511         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0512             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0513             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0514             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0515             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-47 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0516             <span class="string">'String'</span>,<span class="string">'08 ____'</span>, <span class="keyword">...</span>
0517             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0518             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0519             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>);
0520 
0521         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0522             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0523             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0524             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0525             <span class="string">'Position'</span>,[7 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0526             <span class="string">'String'</span>,<span class="string">'09 ____'</span>, <span class="keyword">...</span>
0527             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0528             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0529             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>);
0530 
0531         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0532             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0533             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0534             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0535             <span class="string">'Position'</span>,[55 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0536             <span class="string">'String'</span>,<span class="string">'10 ____'</span>, <span class="keyword">...</span>
0537             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0538             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0539             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>);
0540 
0541         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0542             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0543             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0544             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0545             <span class="string">'Position'</span>,[103 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0546             <span class="string">'String'</span>,<span class="string">'11 ____'</span>, <span class="keyword">...</span>
0547             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0548             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0549             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>);
0550 
0551         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0552             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0553             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0554             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0555             <span class="string">'Position'</span>,[151 4*(ButtonHeight)+Offset3-62 ButtonWidth-145 .75*ButtonHeight], <span class="keyword">...</span>
0556             <span class="string">'String'</span>,<span class="string">'12 ____'</span>, <span class="keyword">...</span>
0557             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0558             <span class="string">'FontSize'</span>, 8,<span class="keyword">...</span>
0559             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>);
0560 
0561         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0562             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''FastFeedbackSetup'',1);'</span>, <span class="keyword">...</span>
0563             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''FastFeedbackSetup'',0);'</span>, <span class="keyword">...</span>
0564             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0565             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0566             <span class="string">'Position'</span>,[8 1*(ButtonHeight)+Offset3-3 ButtonWidth-5 .75*ButtonHeight], <span class="keyword">...</span>
0567             <span class="string">'String'</span>,<span class="string">'Edit FOFB Setup'</span>, <span class="keyword">...</span>
0568             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0569             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0570             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>);
0571 
0572         <span class="comment">% Frame Box IV</span>
0573         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0574             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0575             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0576             <span class="string">'Position'</span>,[3 3+ButtonHeight+Offset4-14+Offset5 ButtonWidth+6 ButtonHeight+12], <span class="keyword">...</span>
0577             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0578         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0579             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0580             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0581             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0582             <span class="string">'Position'</span>,[6 3+1.75*ButtonHeight+5+Offset4-21+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0583             <span class="string">'String'</span>,<span class="string">'Storage Ring State'</span>, <span class="keyword">...</span>
0584             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0585             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHeader'</span>);
0586         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0587             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''CheckInputs'');'</span>, <span class="keyword">...</span>
0588             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0589             <span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>, <span class="keyword">...</span>
0590             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0591             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0592             <span class="string">'Position'</span>,[6 3+ButtonHeight+6+3+2+Offset4-22+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0593             <span class="string">'String'</span>,<span class="string">'   '</span>, <span class="keyword">...</span>
0594             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0595             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>);
0596 
0597 
0598         <span class="comment">% Frame Box &quot;Close&quot;</span>
0599         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0600             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0601             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0602             <span class="string">'Position'</span>,[3 8 ButtonWidth+6 ButtonHeight+8], <span class="keyword">...</span>
0603             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0604         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0605             <span class="string">'Callback'</span>,<span class="string">'close(gcbf);'</span>, <span class="keyword">...</span>
0606             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0607             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0608             <span class="string">'Position'</span>,[6 13 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0609             <span class="string">'String'</span>,<span class="string">'Close'</span>, <span class="keyword">...</span>
0610             <span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>);
0611 
0612 
0613         <span class="comment">% Update database channels</span>
0614         <a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>;
0615 
0616         <span class="keyword">if</span> nargout &gt; 0
0617             fig = h0;
0618         <span class="keyword">end</span>
0619 
0620 
0621     <span class="keyword">case</span> <span class="string">'Cycle'</span>
0622         GapFlag = Input2;
0623         BumpMagnetFlag = Input3;
0624 
0625         fprintf(<span class="string">'\n'</span>);
0626         disp(<span class="string">'   **************************'</span>);
0627         disp(<span class="string">'   **  Storage Ring Cycle  **'</span>);
0628         disp(<span class="string">'   **************************'</span>);
0629         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
0630 
0631         BSCFlag = questdlg(sprintf(<span class="string">'Cycle Superbend Magnets?'</span>),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0632         <span class="comment">%if strcmp(BSCFlag,'No')</span>
0633         <span class="comment">%    disp(['   ** Superbends will not be cycled. **']);</span>
0634         <span class="comment">%else</span>
0635         <span class="comment">%    disp(['   ** Superbends will be cycled during the second mini-cycle only. **']);</span>
0636         <span class="comment">%end</span>
0637 
0638         ChicSQFlag = questdlg(sprintf(<span class="string">'Cycle chicanes and skew quads and home motor chicanes?'</span>),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0639         <span class="comment">%if strcmp(ChicSQFlag,'No')</span>
0640         <span class="comment">%    disp(['   ** Chicanes and skew quads will not be cycled; motor chicanes will not be homed. **']);</span>
0641         <span class="comment">%else</span>
0642         <span class="comment">%    disp(['   ** Chicanes and skew quads will be cycled; motor chicanes will be homed. **']);</span>
0643         <span class="comment">%end</span>
0644 
0645 
0646         StartFlag = questdlg(sprintf(<span class="string">'Start %.1f GeV Cycle?'</span>,SR_GEV),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0647         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
0648             disp([<span class="string">'   ***************************'</span>]);
0649             disp([<span class="string">'   **    Cycle  Canceled    **'</span>]);
0650             disp([<span class="string">'   ***************************'</span>]);
0651             fprintf(<span class="string">'\n'</span>);
0652             <span class="keyword">return</span>
0653         <span class="keyword">end</span>
0654 
0655         <span class="keyword">try</span>
0656             <span class="keyword">if</span> GapFlag
0657                 <span class="comment">% Make sure that the gaps are open with FF off</span>
0658                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0659                     <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0660                     disp(<span class="string">'   Insertion device gaps are not open.'</span>);
0661                     disp(<span class="string">'   Opening all gaps at maximum speed.'</span>);
0662                     <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0663                     disp(<span class="string">'   Gap control disabled.'</span>);
0664                     disp(<span class="string">'   Feed forward enabled.'</span>);
0665                     pause(1);
0666                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0667                     disp(<span class="string">'   Gaps opened.'</span>);
0668                     disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0669                     a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0670                 <span class="keyword">else</span>
0671                     disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0672                 <span class="keyword">end</span>
0673             <span class="keyword">else</span>
0674                 disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0675             <span class="keyword">end</span>
0676 
0677             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0678             pause(1);
0679             
0680             <a href="srcycle.html" class="code" title="function FailFlag = srcycle(varargin)">srcycle</a>(BSCFlag, ChicSQFlag);
0681 
0682             setpv(<span class="string">'SR_STATE'</span>,1);
0683 
0684         <span class="keyword">catch</span>
0685 
0686             fprintf(<span class="string">'   %s \n'</span>,lasterr);
0687             fprintf(<span class="string">'   Cycle failed due to error condition! \n\n'</span>);
0688             setpv(<span class="string">'SR_STATE'</span>,-1);
0689             
0690         <span class="keyword">end</span>
0691 
0692         date;
0693         a = clock;
0694         datestr1=date;
0695         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0696         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0697         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0698         <span class="keyword">if</span> StateNumber &gt;= 0
0699             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0700             disp(<span class="string">'   **********************************************'</span>);
0701             disp(<span class="string">'   **  SR Cycle complete, ready for injection  **'</span>);
0702             disp(<span class="string">'   **********************************************'</span>); fprintf(<span class="string">'\n'</span>);
0703         <span class="keyword">else</span>
0704             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0705             disp(<span class="string">'   **********************************'</span>);
0706             disp(<span class="string">'   **  Problem cycling SR lattice  **'</span>);
0707             disp(<span class="string">'   **********************************'</span>); fprintf(<span class="string">'\n'</span>);
0708         <span class="keyword">end</span>
0709         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0710         
0711 
0712     <span class="keyword">case</span> <span class="string">'Injection'</span>
0713         AD = getad;
0714         GapFlag = Input2;
0715         BumpMagnetFlag = Input3;
0716 
0717         fprintf(<span class="string">'\n'</span>);
0718         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0719 
0720         <span class="keyword">if</span> abs(AD.Energy - AD.InjectionEnergy) &gt; .05
0721             fprintf(<span class="string">'   ***************************************************\n'</span>);
0722             fprintf(<span class="string">'   **  Setup For %.2f GeV Injection (with ramping)  **\n'</span>, getfamilydata(<span class="string">'InjectionEnergy'</span>));
0723             fprintf(<span class="string">'   ***************************************************\n'</span>);
0724             <a href="set_alarmhandler_AHU_thresholds_inject.html" class="code" title="function set_alarmhandler_AHU_thresholds_inject">set_alarmhandler_AHU_thresholds_inject</a>;
0725             StartFlag = questdlg(sprintf(<span class="string">'Start setup for injection, %.2f GeV?'</span>,getfamilydata(<span class="string">'InjectionEnergy'</span>)),<span class="string">'Injection Setup'</span>,<span class="string">'Ramp quickly'</span>,<span class="string">'Ramp slowly'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0726         <span class="keyword">else</span>
0727             fprintf(<span class="string">'   *************************************************\n'</span>);
0728             fprintf(<span class="string">'   **  Setup For On Energy Injection at %.2f GeV  **\n'</span>, SR_GEV);
0729             fprintf(<span class="string">'   *************************************************\n'</span>);
0730             StartFlag = questdlg(sprintf(<span class="string">'Start setup for injection, %.2f GeV?'</span>,SR_GEV),<span class="string">'Injection Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0731         <span class="keyword">end</span>
0732         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'Cancel'</span>)
0733             disp([<span class="string">'   ********************************'</span>]);
0734             disp([<span class="string">'   **  Injection Setup Canceled  **'</span>]);
0735             disp([<span class="string">'   ********************************'</span>]);
0736             <a href="set_alarmhandler_thresholds.html" class="code" title="function set_alarmhandler_thresholds">set_alarmhandler_thresholds</a>;
0737             fprintf(<span class="string">'\n'</span>);
0738             <span class="keyword">return</span>
0739         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp quickly'</span>)
0740             setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0741         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp slowly'</span>)
0742             setfamilydata(0.4, <span class="string">'BSCRampRate'</span>);
0743         <span class="keyword">end</span>
0744 
0745         <span class="keyword">try</span>
0746 
0747             <span class="keyword">if</span> GapFlag
0748                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([],1,0);
0749                 disp(<span class="string">'   Gap control disabled'</span>);
0750                 disp(<span class="string">'   Feed forward enabled'</span>);
0751                 pause(1);
0752 
0753                 <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0754                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0755                     disp(<span class="string">'   Opening all gaps'</span>);
0756                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0757                 <span class="keyword">end</span>
0758 
0759                 disp(<span class="string">'   Gaps are open'</span>);
0760                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0761                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0762             <span class="keyword">else</span>
0763                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0764             <span class="keyword">end</span>
0765 
0766             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0767             pause(1);
0768 
0769             <span class="keyword">if</span> (AD.Energy-AD.InjectionEnergy) &gt; 0.05
0770                 <span class="comment">% Ramp down to Injection Energy</span>
0771                 ErrorFlag = <a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>(<span class="string">'Injection'</span>);
0772                 <span class="keyword">if</span> ErrorFlag
0773                     error(<span class="string">'Superbends over temperature.'</span>);
0774                 <span class="keyword">end</span>
0775                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n\n'</span>,date, a(4), a(5), a(6));
0776 
0777             <span class="keyword">elseif</span> (AD.Energy-AD.InjectionEnergy) &lt; -0.05
0778 
0779                 <span class="comment">% first load injection lattice, then ramp to 1.9 GeV and back to 1.5 GeV to get onto same hysteresis branch</span>
0780 
0781                 srload(<span class="string">'Injection'</span>);
0782 
0783                 <span class="comment">% load 1.9 GeV lattice</span>
0784                 tempfilename = sprintf(<span class="string">'%s19nuy9prod.mat'</span>, getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>));
0785 
0786                 srload(tempfilename);
0787 
0788                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0789 
0790                 pause(5);
0791 
0792             <span class="keyword">end</span>
0793 
0794             srload(<span class="string">'Injection'</span>);
0795 
0796             setpv(<span class="string">'SR_STATE'</span>,2);
0797 
0798         <span class="keyword">catch</span>
0799 
0800             fprintf(<span class="string">'   %s \n'</span>,lasterr);
0801             fprintf(<span class="string">'   Injection lattice setup failed due to error condition! \n\n'</span>);
0802             setpv(<span class="string">'SR_STATE'</span>,-2);
0803 
0804         <span class="keyword">end</span>
0805 
0806 
0807         date;
0808         a = clock;
0809         datestr1=date;
0810         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0811         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0812         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0813         <span class="keyword">if</span> StateNumber &gt;= 0
0814             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0815             <span class="keyword">if</span> AD.Energy &lt;= 1.5
0816                 disp([<span class="string">'   *******************************************************************************'</span>]);
0817                 disp([<span class="string">'   **  Function complete:  the storage ring is setup for injection at '</span>,sprintf(<span class="string">'%.2f'</span>,SR_GEV),<span class="string">' GeV  **'</span>]);
0818                 disp([<span class="string">'   *******************************************************************************'</span>]); 
0819                 fprintf(<span class="string">'\n'</span>);
0820             <span class="keyword">else</span>
0821                 fprintf(<span class="string">'   **********************************************************************************************\n'</span>);
0822                 fprintf(<span class="string">'   **  Function complete:  the storage ring is setup for injection at %.2f GeV (upper branch)  **\n'</span>, getfamilydata(<span class="string">'InjectionEnergy'</span>));
0823                 fprintf(<span class="string">'   **********************************************************************************************\n'</span>); 
0824                 fprintf(<span class="string">'\n'</span>);
0825             <span class="keyword">end</span>
0826         <span class="keyword">else</span>
0827             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0828             disp([<span class="string">'   ************************************'</span>]);
0829             disp([<span class="string">'   **  Problem with injection setup  **'</span>]);
0830             disp([<span class="string">'   ************************************'</span>]); 
0831             fprintf(<span class="string">'\n'</span>);
0832         <span class="keyword">end</span>
0833         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0834 
0835         <span class="comment">%soundchord;</span>
0836 
0837         setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0838 
0839 
0840     <span class="keyword">case</span> <span class="string">'Production'</span>
0841         GapFlag = Input2;
0842         BumpMagnetFlag = Input3;
0843         AD=getad;
0844         
0845         fprintf(<span class="string">'\n'</span>);
0846         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0847 
0848         <span class="keyword">if</span> abs(AD.Energy - AD.InjectionEnergy) &gt; .05
0849             disp(<span class="string">'   ********************************************************'</span>);
0850             disp(sprintf(<span class="string">'   **  Setup For %.2f GeV User Operation (with ramping)  **'</span>,SR_GEV));
0851             disp(<span class="string">'   ********************************************************'</span>);
0852             StartFlag = questdlg(sprintf(<span class="string">'Start setup for users, %.1f GeV?'</span>,SR_GEV),<span class="string">'User Setup'</span>,<span class="string">'Ramp quickly'</span>,<span class="string">'Ramp slowly'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0853         <span class="keyword">else</span>
0854             disp(<span class="string">'   *****************************************'</span>);
0855             disp(sprintf(<span class="string">'   **  Setup For %.2f GeV User Operation  **'</span>,SR_GEV));
0856             disp(<span class="string">'   *****************************************'</span>);
0857             StartFlag = questdlg(sprintf(<span class="string">'Start setup for users, %.1f GeV?'</span>,SR_GEV),<span class="string">'User Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0858         <span class="keyword">end</span>
0859 
0860         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'Cancel'</span>)
0861             disp([<span class="string">'   ***************************'</span>]);
0862             disp([<span class="string">'   **  User Setup Canceled  **'</span>]);
0863             disp([<span class="string">'   ***************************'</span>]);
0864             fprintf(<span class="string">'\n'</span>);
0865             <span class="keyword">return</span>
0866         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp quickly'</span>)
0867             setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0868         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp slowly'</span>)
0869             setfamilydata(0.4, <span class="string">'BSCRampRate'</span>);
0870         <span class="keyword">end</span>
0871 
0872         <span class="keyword">try</span>
0873 
0874             <span class="keyword">if</span> GapFlag
0875                 <span class="comment">% Make sure that the gaps are open</span>
0876                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0877                     <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0878                     disp(<span class="string">'   Insertion device gaps are not open'</span>);
0879                     disp(<span class="string">'   Opening all gaps at maximum speed'</span>);
0880                     <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0881                     disp(<span class="string">'   Gap control disabled'</span>);
0882                     disp(<span class="string">'   Feed forward enabled'</span>);
0883                     pause(1);
0884                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0885                     disp(<span class="string">'   Gaps opened'</span>);
0886                     disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0887                     a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0888                 <span class="keyword">else</span>
0889                     disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0890                 <span class="keyword">end</span>
0891             <span class="keyword">else</span>
0892                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0893             <span class="keyword">end</span>
0894 
0895             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0896             pause(1);
0897 
0898             <span class="comment">% Ramp up to the production lattice</span>
0899             ErrorFlag = <a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>(<span class="string">'Production'</span>);
0900             <span class="keyword">if</span> ErrorFlag
0901                 error(<span class="string">'Superbends over temperature.'</span>);
0902             <span class="keyword">end</span>
0903             a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0904 
0905             srload(<span class="string">'Production'</span>);
0906 
0907             <span class="keyword">if</span> GapFlag
0908                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0909                 disp(<span class="string">'   Gap control disabled'</span>);
0910                 disp(<span class="string">'   Feed forward enable'</span>);
0911                 pause(1);
0912 
0913                 disp(<span class="string">'   Insertion device velocity profile boolean control off'</span>);
0914                 disp(<span class="string">'   Closing all gaps at maximum speed'</span>);
0915 
0916                 <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0917                 [Position, Velocity, RunFlag, UserGap] = <a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>;
0918 
0919                 <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], UserGap, maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0920 
0921                 <span class="comment">% Turn velocity profile on</span>
0922                 disp(<span class="string">'   Insertion device velocity profile boolean control is on'</span>);
0923                 <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], [], maxsp(<span class="string">'IDvel'</span>), 1, 1, 0);
0924 
0925                 disp(<span class="string">'   Gaps are closed'</span>);
0926                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([4;7;8;9;10;12], 1, 1);
0927                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>(5, 1, 0);
0928                 disp(<span class="string">'   Gap control enabled (except sector 5 (W16))'</span>);
0929             <span class="keyword">end</span>
0930 
0931             <a href="set_alarmhandler_thresholds_new.html" class="code" title="function set_alarmhandler_thresholds_new">set_alarmhandler_thresholds_new</a>;
0932             setpv(<span class="string">'SR_STATE'</span>,3);
0933 
0934         <span class="keyword">catch</span>
0935 
0936             fprintf(<span class="string">'   %s \n'</span>, lasterr);
0937             fprintf(<span class="string">'   User lattice setup failed due to error condition! \n\n'</span>);
0938             setpv(<span class="string">'SR_STATE'</span>,-3);
0939 
0940         <span class="keyword">end</span>
0941 
0942         a = clock;
0943         datestr1=date;
0944         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0945         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0946         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0947         <span class="keyword">if</span> StateNumber &gt;= 0
0948             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0949             disp([<span class="string">'   **************************************************************************'</span>]);
0950             disp([<span class="string">'   **  Function complete:  the storage ring is setup for users at '</span>,sprintf(<span class="string">'%.1f'</span>,SR_GEV),<span class="string">' GeV  **'</span>]);
0951             disp([<span class="string">'   **************************************************************************'</span>]); fprintf(<span class="string">'\n'</span>);
0952         <span class="keyword">else</span>
0953             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0954             disp([<span class="string">'   *************************************'</span>]);
0955             disp([<span class="string">'   **  Problem with production setup  **'</span>]);
0956             disp([<span class="string">'   *************************************'</span>]); fprintf(<span class="string">'\n'</span>);
0957         <span class="keyword">end</span>
0958         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0959 
0960         setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0961 
0962         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0963         <span class="comment">%set lower setpoint limit for IVID to 7mm until beamline is scrubbed - 4-18-07 - T.Scarvie</span>
0964         <span class="keyword">try</span>
0965             scaput(<span class="string">'SR06U___GDS1PS_AC00.DRVL'</span>,7)
0966         <span class="keyword">catch</span>
0967             disp(<span class="string">'  Trouble setting lower limit for IVID to 7mm!'</span>);
0968         <span class="keyword">end</span>
0969         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0970 
0971         
0972     <span class="keyword">case</span> <span class="string">'CheckInputs'</span>
0973 
0974         SR_GEV = getfamilydata(<span class="string">'Energy'</span>);
0975         AD=getad;
0976         <a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>; 
0977 
0978         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0979 
0980         <span class="keyword">if</span> AD.Energy &gt; 1.55
0981             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection (Ramp Down)'</span>]);
0982             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users (Ramp Up)'</span>]);
0983         <span class="keyword">elseif</span> AD.Energy &lt; 1.45
0984             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection (Ramp Up+cycle)'</span>]);
0985             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users, '</span>,num2str(round(10*SR_GEV)/10),<span class="string">' GeV (Ramp Down)'</span>]);
0986         <span class="keyword">else</span>
0987             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection'</span>]);
0988             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users, '</span>,num2str(round(10*SR_GEV)/10),<span class="string">' GeV'</span>]);
0989         <span class="keyword">end</span>
0990         set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLTitle'</span>),<span class="string">'String'</span>,SR_Mode);
0991 
0992         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0993         <span class="keyword">if</span> StateNumber &gt;= 0
0994             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0995         <span class="keyword">else</span>
0996             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0997         <span class="keyword">end</span>
0998 
0999         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1000 
1001 
1002     <span class="keyword">case</span> <span class="string">'SRState'</span>
1003         NumErrors = 0;
1004         fprintf(<span class="string">'\n'</span>);
1005         disp(<span class="string">'   ***********************************'</span>);
1006         disp(<span class="string">'   **  Checking Storage Ring State  **'</span>);
1007         disp(<span class="string">'   ***********************************'</span>);
1008         a = clock;
1009         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1010 
1011         <span class="comment">%       FileName = getpv('SR_LATTICE_FILE','String');   % Last srload file name (in OLD MIDDLE LAYER nomenclature!!)</span>
1012 
1013         GeVnow = <a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>;
1014         <span class="keyword">if</span> GeVnow == getfamilydata(<span class="string">'Energy'</span>)
1015             [ConfigSetpoint, ConfigMonitor, FileName] = getproductionlattice;
1016         <span class="keyword">elseif</span> GeVnow == getfamilydata(<span class="string">'InjectionEnergy'</span>)
1017             [ConfigSetpoint, ConfigMonitor, FileName] = getinjectionlattice;
1018         <span class="keyword">else</span>
1019             FileName = <span class="string">''</span>;
1020         <span class="keyword">end</span>
1021 
1022         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1023         fprintf(<span class="string">'   Storage ring operational mode: %s\n'</span>, SR_Mode);
1024         <span class="keyword">if</span> StateNumber &lt; 0
1025             fprintf(<span class="string">'   Storage ring state error: %s\n'</span>, StateString);
1026             NumErrors = NumErrors + 1;
1027         <span class="keyword">else</span>
1028             fprintf(<span class="string">'   Storage ring state: %s\n'</span>, StateString);
1029         <span class="keyword">end</span>
1030         <span class="keyword">if</span> StateNumber==0
1031             <span class="comment">% Storage ring state unknown</span>
1032             NumErrors = NumErrors + 1;
1033         <span class="keyword">elseif</span> abs(StateNumber)==1 || abs(StateNumber)==2
1034             FileNameGoal = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>) getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'InjectionFile'</span>) <span class="string">'.mat'</span>];
1035             <span class="keyword">if</span> ~strcmp(FileName, FileNameGoal)
1036                 fprintf(<span class="string">'   Lattice file %s should be loaded but it appears that %s is loaded.\n'</span>, getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'InjectionFile'</span>), FileName);
1037                 NumErrors = NumErrors + 1;
1038             <span class="keyword">end</span>
1039         <span class="keyword">else</span>
1040             FileNameGoal = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>) getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'LatticeFile'</span>) <span class="string">'.mat'</span>];
1041             <span class="keyword">if</span> ~strcmp(FileName, FileNameGoal)
1042                 fprintf(<span class="string">'   Lattice file %s should be loaded but it appears that %s is loaded.\n'</span>, getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'LatticeFile'</span>), FileName);
1043                 NumErrors = NumErrors + 1;
1044             <span class="keyword">end</span>
1045         <span class="keyword">end</span>
1046 
1047 
1048         <span class="comment">% Check all SR magnets</span>
1049         <span class="keyword">if</span> isempty(FileName)
1050             fprintf(<span class="string">'   Goal setpoints will not be checked since the last lattice load is unknown.\n'</span>);
1051             NumErrors1 = <a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>(<span class="string">''</span>);
1052         <span class="keyword">else</span>
1053 <span class="comment">%            NumErrors1 = checksrmags([getfamilydata('Directory','OpsData') FileName]);</span>
1054             NumErrors1 = <a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>(FileName);
1055         <span class="keyword">end</span>
1056         <span class="keyword">if</span> NumErrors1 == 0
1057             fprintf(<span class="string">'   SR magnets power supplies are OK.\n'</span>);
1058         <span class="keyword">end</span>
1059         NumErrors = NumErrors + NumErrors1;
1060 
1061 
1062         <span class="comment">% Check RF frequency</span>
1063         <span class="keyword">if</span> isempty(FileName)
1064             fprintf(<span class="string">'   RF frequency will not be checked since the last lattice load is unknown.\n'</span>);
1065         <span class="keyword">else</span>
1066 <span class="comment">%            load([getfamilydata('Directory','OpsData'), FileName]);</span>
1067             load(FileName);
1068             [tmp, RFHPCounterPresent] = getrf;
1069             <span class="keyword">if</span> abs(RFHPCounterPresent-ConfigSetpoint.RF.Setpoint.Data) &gt; .002
1070                 NumErrors = NumErrors + 1;
1071                 fprintf(<span class="string">'   RF frequency should be %f, presently it is %f MHz (as measured by the HP counter).\n'</span>, ConfigSetpoint.RF.Setpoint.Data, RFHPCounterPresent);
1072             <span class="keyword">else</span>
1073                 fprintf(<span class="string">'   RF frequency is OK (HP counter is %f MHz, at the time of the lattice save it was %f MHz).\n'</span>, RFHPCounterPresent, ConfigSetpoint.RF.Setpoint.Data);
1074             <span class="keyword">end</span>
1075         <span class="keyword">end</span>
1076 
1077 
1078         <span class="comment">% Check for orbit problems</span>
1079         <span class="keyword">if</span> (StateNumber &gt;= 3) &amp; (getdcct &gt; 2)   <span class="comment">% Production lattice is loaded with beam in the machine</span>
1080             Xtol = 0.070;
1081             Ytol = 0.010;
1082             NumErrors1 = <a href="checksrorbit.html" class="code" title="function ErrorNums = checksrorbit(SectorList, BPMxtol,BPMytol)">checksrorbit</a>([],Xtol,Ytol);
1083             <span class="keyword">if</span> NumErrors1
1084                 fprintf(<span class="string">'   SR orbit in the ID straight sections or at Bergoz BPMs deviates more than allowed from the golden orbit.\n'</span>);
1085             <span class="keyword">else</span>
1086                 fprintf(<span class="string">'   SR orbit in the ID straight sections and at Bergoz BPMs is OK.\n'</span>);
1087                 fprintf(<span class="string">'   The orbit is within %.3f mm horizontally and %.3f mm vertically'</span>, Xtol, Ytol);
1088             <span class="keyword">end</span>
1089             NumErrors = NumErrors + NumErrors1;
1090         <span class="keyword">else</span>
1091             fprintf(<span class="string">'   Storage ring orbit was not checked.\n'</span>);
1092         <span class="keyword">end</span>
1093 
1094 
1095         a = clock;
1096         datestr1=date;
1097         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
1098         <span class="keyword">if</span> NumErrors
1099             disp(<span class="string">'   *********************************'</span>);
1100             disp(<span class="string">'   **  Storage Ring Has Problems  **'</span>);
1101             disp(<span class="string">'   *********************************'</span>);
1102         <span class="keyword">else</span>
1103             disp(<span class="string">'   **********************************'</span>);
1104             disp(<span class="string">'   **  Storage Ring Lattice is OK  **'</span>);
1105             disp(<span class="string">'   **********************************'</span>);
1106         <span class="keyword">end</span>
1107         fprintf(<span class="string">'   \n'</span>);
1108 
1109         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1110         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1111         <span class="keyword">if</span> StateNumber &gt;= 0
1112             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1113         <span class="keyword">else</span>
1114             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1115         <span class="keyword">end</span>
1116         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1117 
1118 
1119     <span class="keyword">case</span> <span class="string">'OrbitCorrection'</span>
1120         fprintf(<span class="string">'\n'</span>);
1121         fprintf(<span class="string">'   *********************************\n'</span>);
1122         fprintf(<span class="string">'   **  Starting Orbit Correction  **\n'</span>);
1123         fprintf(<span class="string">'   *********************************\n'</span>);
1124         a = clock;
1125         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1126 
1127         StartFlag = questdlg(sprintf(<span class="string">'Start orbit correction, %.1f GeV?'</span>,SR_GEV),<span class="string">'Orbit Correction'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
1128         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
1129             disp([<span class="string">'   ********************************'</span>]);
1130             disp([<span class="string">'   **  Orbit Correction Aborted  **'</span>]);
1131             disp([<span class="string">'   ********************************'</span>]);
1132             fprintf(<span class="string">'\n'</span>);
1133             <span class="keyword">return</span>
1134         <span class="keyword">end</span>
1135 
1136         <span class="keyword">if</span> getdcct &lt; 5     <span class="comment">% Don't correct the orbit if the current is too small</span>
1137             fprintf(<span class="string">'   Orbit not corrected due to small current.\n'</span>);
1138             <span class="keyword">return</span>
1139         <span class="keyword">end</span>
1140 
1141         <span class="keyword">if</span> abs(SR_GEV-<a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>(getpv(<span class="string">'BEND'</span>,[1 1])))&gt;  0.05     <span class="comment">% Don't use this routine for the injection lattice</span>
1142             fprintf(<span class="string">'   This routine should only be used for the production energy: Correction aborted\n'</span>);
1143             <span class="keyword">return</span>
1144         <span class="keyword">end</span>
1145 
1146         SR_STATE_OLD = scaget(<span class="string">'SR_STATE'</span>);
1147         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1148         setpv(<span class="string">'SR_STATE'</span>,4);
1149         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1150         <span class="keyword">if</span> StateNumber &gt;= 0
1151             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1152         <span class="keyword">else</span>
1153             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1154         <span class="keyword">end</span>
1155         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1156 
1157 
1158         <span class="keyword">try</span>
1159                 <span class="comment">% save current BPM timeconstant - will reset to this after correction</span>
1160                 BPMtimeconstantOC = <a href="getbpmtimeconstant.html" class="code" title="function [BPMTimeConstant, WarningFlag] = getbpmtimeconstant(varargin)">getbpmtimeconstant</a>;
1161                 fprintf(<span class="string">'   Current Bergoz BPM time constant is %.1fs\n'</span>, BPMtimeconstantOC);
1162                 
1163             <span class="comment">% 2 Hz update rate on IDBPMs</span>
1164             disp(<span class="string">'   Bergoz BPM time constant set to 0.5s.'</span>)
1165             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.5)
1166             pause(2);
1167 
1168 
1169             <span class="comment">% Turn off feed forward</span>
1170             fprintf(<span class="string">'   Turning feed forward off.\n'</span>);
1171             [FFEnableBM, FFEnableBC] = <a href="getff.html" class="code" title="function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)">getff</a>;
1172             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0);
1173             scasleep(.2);
1174 
1175 
1176             <span class="comment">% Get vectors</span>
1177             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>);
1178             LocalBumplist = FB.LocalBumplist;
1179 
1180         <span class="keyword">catch</span>
1181 
1182             fprintf(<span class="string">'   %s \n'</span>,lasterr);
1183             fprintf(<span class="string">'   Orbit correction setup failed due to error condition! \n\n'</span>);
1184             setpv(<span class="string">'SR_STATE'</span>,-4);
1185             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1186             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1187             <span class="keyword">if</span> StateNumber &gt;= 0
1188                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1189             <span class="keyword">else</span>
1190                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1191             <span class="keyword">end</span>
1192             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1193             <span class="keyword">return</span>
1194 
1195         <span class="keyword">end</span>
1196 
1197         iNotHCMChicane = find(FB.HCMlist1(:,2) &lt; 10); <span class="comment">%used by steppv's for setting correctors in loop</span>
1198         iHCMChicane = find(FB.HCMlist1(:,2) == 10);
1199         iNotVCMChicane = find(FB.VCMlist1(:,2) &lt; 10);
1200         iVCMChicane = find(FB.VCMlist1(:,2) == 10);
1201 
1202         fprintf(<span class="string">'   Starting horizontal and vertical global orbit correction (SVD method).\n'</span>);
1203 
1204         <span class="keyword">for</span> iloop = 1:3
1205             <span class="keyword">try</span>
1206                 <span class="comment">% use the following to get corrector settings in OCS without setting them, so the values can be checked</span>
1207                 FB.OCSx = setorbit(FB.OCSx,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1208                 FB.OCSy = setorbit(FB.OCSy,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1209                 <span class="keyword">if</span> any(abs(FB.OCSx.CM.Delta(iNotHCMChicane)) &gt; 5)
1210                   disp(<span class="string">'   Orbit Correction is changing some horizontal corrector(s) &gt; 5A!!'</span>);
1211                 <span class="keyword">end</span>
1212                 <span class="keyword">if</span> any(abs(FB.OCSy.CM.Delta(iNotVCMChicane)) &gt; 5)
1213                   disp(<span class="string">'   Orbit Correction is changing some vertical corrector(s) &gt; 5A!!'</span>);
1214                 <span class="keyword">end</span>
1215                 <span class="keyword">if</span> any(abs(FB.OCSx.CM.Delta(iHCMChicane)) &gt; 10)
1216                   disp(<span class="string">'   Orbit Correction is changing some horizontal chicane corrector(s) &gt; 10A!!'</span>);
1217                 <span class="keyword">end</span>
1218                 <span class="keyword">if</span> any(abs(FB.OCSy.CM.Delta(iVCMChicane)) &gt; 10)
1219                   disp(<span class="string">'   Orbit Correction is changing some vertical chicane corrector(s) &gt; 10A!!'</span>);
1220                 <span class="keyword">end</span>
1221 
1222 
1223                 <span class="comment">% Correct horizontal orbit</span>
1224                 FB.OCSx = setorbit(FB.OCSx,<span class="string">'NoDisplay'</span>);
1225                 <span class="comment">% Correct vertical orbit</span>
1226                 FB.OCSy = setorbit(FB.OCSy,<span class="string">'NoDisplay'</span>);
1227 
1228 
1229                 <span class="comment">% Check for current in machine - stop orbit correction if DCCT &lt; 5mA</span>
1230                 <span class="keyword">if</span> (getdcct &lt; 4.5)
1231                     error(<span class="string">'**There is less than 5mA in the machine! Stopping orbit correction.'</span>);
1232                 <span class="keyword">end</span>
1233 
1234                 <span class="comment">% Check state of gaps - stop orbit correction if any are moving</span>
1235                 GAPrunflag = getpv(<span class="string">'ID'</span>,<span class="string">'RunFlag'</span>);
1236                 <span class="keyword">if</span> any(GAPrunflag-round(GAPrunflag))
1237                     error(<span class="string">'**One or more of the gaps are moving! Stopping orbit correction.'</span>);
1238                 <span class="keyword">end</span>
1239 
1240                 x = FB.OCSx.GoalOrbit - getx(FB.OCSx.BPM.DeviceList);
1241                 y = FB.OCSy.GoalOrbit - gety(FB.OCSy.BPM.DeviceList);
1242                 fprintf(<span class="string">'   %d. Horizontal RMS = %.3f mm\n'</span>, iloop, norm(x)/sqrt(length(x)));
1243                 fprintf(<span class="string">'   %d.   Vertical RMS = %.3f mm\n'</span>, iloop, norm(y)/sqrt(length(y)));
1244 
1245             <span class="keyword">catch</span>
1246                 <span class="comment">% fprintf('   %s \n',lasterr);</span>
1247                 fprintf(<span class="string">'   Orbit correction failed due to error condition!\n  Fix the problem, reload the lattice (srload), and try again.  \n\n'</span>);
1248                 setpv(<span class="string">'SR_STATE'</span>,-4);
1249                 set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1250                 [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1251                 <span class="keyword">if</span> StateNumber &gt;= 0
1252                     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1253                 <span class="keyword">else</span>
1254                     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1255                 <span class="keyword">end</span>
1256                 set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1257                 <span class="keyword">return</span>
1258             <span class="keyword">end</span>
1259         <span class="keyword">end</span>
1260 
1261 
1262         <span class="comment">% Set user bumps w/o sextupole correctors</span>
1263         <span class="keyword">try</span>
1264 
1265             <span class="comment">%turn up corrector speed here to quicken setting bumps</span>
1266             HCMramprate = getpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>);
1267             VCMramprate = getpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>);
1268             setpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>, 10, [], 0);
1269             setpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>, 10, [], 0);
1270             
1271             <span class="keyword">if</span> ~isempty(LocalBumplist)
1272                 fprintf(<span class="string">'   Setting local bumps in the straight sections.\n'</span>);
1273                 <span class="keyword">for</span> loop = 1:size(LocalBumplist,1)
1274 
1275                     <span class="comment">% Check for current in machine - stop orbit correction if DCCT &lt; 5mA</span>
1276                     <span class="keyword">if</span> (getdcct &lt; 5)
1277                         error(<span class="string">'** There is less than 5mA in the machine! Stopping local bumps.'</span>);
1278                     <span class="keyword">end</span>
1279 
1280                     <span class="comment">% Check state of gaps - stop setting bumps if any are moving</span>
1281                     GAPrunflag = getpv(<span class="string">'ID'</span>,<span class="string">'RunFlag'</span>);
1282                     <span class="keyword">if</span> any(GAPrunflag-round(GAPrunflag))
1283                         error(<span class="string">'** One or more of the gaps are moving! Stopping local bumps.'</span>);
1284                     <span class="keyword">end</span>
1285 
1286                     HCMoldsp = getsp(<span class="string">'HCM'</span>, FB.HCMlist1);
1287                     VCMoldsp = getsp(<span class="string">'VCM'</span>, FB.VCMlist1);
1288 
1289                     <span class="keyword">if</span> any(LocalBumplist(loop,1) == [4 6 11])
1290                         <span class="keyword">if</span> LocalBumplist(loop,2) == 0
1291                             <span class="comment">% Upstream bump</span>
1292                             [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1)-1 11;LocalBumplist(loop,1)-1 12;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1293                             <span class="keyword">if</span> isempty(iRemove)
1294                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1295                             <span class="keyword">else</span>
1296                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1297                             <span class="keyword">end</span>
1298                         <span class="keyword">elseif</span> LocalBumplist(loop,2) == 1
1299                             <span class="comment">% Upstream bump</span>
1300                             [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1)-1 11;],FB.OCSx.BPM.DeviceList);
1301                             <span class="keyword">if</span> isempty(iRemove)
1302                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1303                             <span class="keyword">else</span>
1304                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1305                             <span class="keyword">end</span>
1306                         <span class="keyword">else</span>
1307                             <span class="comment">% Downstream bump</span>
1308                             [i, iRemove] = findrowindex([LocalBumplist(loop,1)-1 12;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1309                             <span class="keyword">if</span> isempty(iRemove)
1310                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1311                             <span class="keyword">else</span>
1312                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1313                             <span class="keyword">end</span>
1314                         <span class="keyword">end</span>
1315                     <span class="keyword">else</span>
1316                         [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1317                         <span class="keyword">if</span> isempty(iRemove)
1318                             <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1319                         <span class="keyword">else</span>
1320                             fprintf(<span class="string">'\n   BPMs missing from Sector %02d - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,1));
1321                         <span class="keyword">end</span>
1322                     <span class="keyword">end</span>
1323                     
1324                     HCMnewsp = getsp(<span class="string">'HCM'</span>, FB.HCMlist1);
1325                     VCMnewsp = getsp(<span class="string">'VCM'</span>, FB.VCMlist1);
1326                     <span class="comment">% Remove center chicane trim from corrector check</span>
1327                     <span class="keyword">if</span> (max(abs(HCMoldsp(iNotHCMChicane)-HCMnewsp(iNotHCMChicane))) &gt; 5) | (max(abs(VCMoldsp(iNotVCMChicane)-VCMnewsp(iNotVCMChicane))) &gt; 10)
1328                         error(<span class="string">'**Setbumps caused some corrector magnet currents to change by more than 5(Horiz)/10(Vert) A!'</span>);
1329                     <span class="keyword">end</span>
1330                     <span class="comment">% Now check center chicane trims</span>
1331                     <span class="keyword">if</span> (max(abs(HCMoldsp(iNotHCMChicane)-HCMnewsp(iNotHCMChicane))) &gt; 10) | (max(abs(VCMoldsp(iNotVCMChicane)-VCMnewsp(iNotVCMChicane))) &gt; 15)
1332                         error(<span class="string">'**Setbumps caused some chicane trim magnet currents to change by more than 10(Horiz)/15(Vert) A!'</span>);
1333                     <span class="keyword">end</span>
1334                 <span class="keyword">end</span>
1335             <span class="keyword">end</span>
1336 
1337             <span class="comment">%restore corrector speeds</span>
1338             setpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>, HCMramprate, [], 0);
1339             setpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>, VCMramprate, [], 0);
1340 
1341         <span class="keyword">catch</span>
1342             fprintf(<span class="string">'   %s \n'</span>,lasterr);
1343             fprintf(<span class="string">'   Setbumps failed due to error condition!  Fix the problem, reload the lattice (srload), and try again.\n\n'</span>);
1344             setpv(<span class="string">'SR_STATE'</span>,-4);
1345             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1346             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1347             <span class="keyword">if</span> StateNumber &gt;= 0
1348                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1349             <span class="keyword">else</span>
1350                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1351             <span class="keyword">end</span>
1352             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1353             <span class="keyword">return</span>
1354         <span class="keyword">end</span>
1355 
1356             <span class="comment">% Reset BPM timeconstant to whatever it was before correction</span>
1357             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOC);
1358             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1fs\n'</span>, BPMtimeconstantOC);
1359 
1360         <span class="comment">% Turn feed forward back to it's original state</span>
1361         <span class="keyword">if</span> any(FFEnableBC)
1362             fprintf(<span class="string">'   Turning feed forward back on.\n'</span>);
1363             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], FFEnableBC);
1364         <span class="keyword">end</span>
1365 
1366 
1367         a = clock;
1368         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1369         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1370         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1371         <span class="keyword">if</span> StateNumber &gt;= 0
1372             setpv(<span class="string">'SR_STATE'</span>,4.1);
1373             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1374             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1375             fprintf(<span class="string">'   *********************************\n'</span>);
1376             fprintf(<span class="string">'   **  Orbit Correction Complete  **\n'</span>);
1377             fprintf(<span class="string">'   *********************************\n\n'</span>);
1378         <span class="keyword">else</span>
1379             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1380             fprintf(<span class="string">'   *************************************\n'</span>);
1381             fprintf(<span class="string">'   **  Problem With Orbit Correction  **\n'</span>);
1382             fprintf(<span class="string">'   *************************************\n\n'</span>);
1383         <span class="keyword">end</span>
1384         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1385         pause(0);
1386 
1387 
1388     <span class="keyword">case</span> <span class="string">'OrbitCorrectionSetup'</span>
1389         InitFlag = Input2;           <span class="comment">% Input #2: if InitFlag, then initialize variables</span>
1390 
1391         <span class="keyword">if</span> InitFlag
1392             <span class="comment">% Setup feedback elements</span>
1393             <span class="comment">% disp('Orbit correction condition: InitFlag=1 -- debugging message');</span>
1394 
1395             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1396             <span class="comment">% Edit the following lists to change default configuration of Orbit Correction %</span>
1397             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1398             hlist=[];vlist=[];
1399             <span class="keyword">for</span> Sector =1:12
1400                 <span class="keyword">if</span> Sector == 1
1401                     vlist = [vlist;Sector 2;Sector 4;Sector 5;Sector 8];
1402                     hlist = [hlist;Sector 2;Sector 7];
1403                 <span class="keyword">elseif</span> Sector == 3
1404                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];
1405                     hlist = [hlist;Sector 2;Sector 7;Sector 10];
1406                 <span class="keyword">elseif</span> Sector == 5
1407                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];
1408                     hlist = [hlist;Sector 2;Sector 7;Sector 10];
1409 <span class="comment">%                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8]; %remove HCM and VCM(5,10) since corrector is not controlling starting 4-6-07</span>
1410 <span class="comment">%                     hlist = [hlist;Sector 2;Sector 7];</span>
1411                 <span class="keyword">elseif</span> Sector == 10
1412                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];
1413                     hlist = [hlist;Sector 2;Sector 7;Sector 10];
1414                 <span class="keyword">elseif</span> Sector == 12
1415                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 7];
1416                     hlist = [hlist;Sector 2;Sector 7];
1417                 <span class="keyword">else</span>
1418                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8];
1419                     hlist = [hlist;Sector 2;Sector 7];
1420                 <span class="keyword">end</span>
1421             <span class="keyword">end</span>
1422             HCMlist1 = hlist;
1423             VCMlist1 = vlist;
1424 
1425             BPMlist1 = [
1426                 1 2
1427                 1 5
1428                 1 6
1429                 1 10
1430                 2 1
1431                 2 5
1432                 2 6
1433                 2 9
1434                 3 2
1435                 3 5
1436                 3 6
1437                 3 10
1438                 3 11
1439                 3 12
1440                 4 1
1441                 4 5
1442                 4 6
1443                 4 10
1444                 5 1
1445                 5 5
1446                 5 6
1447                 5 10
1448                 5 11
1449                 5 12
1450                 6 1
1451                 6 5
1452                 6 6
1453                 6 10
1454                 7 1
1455                 7 5
1456                 7 6
1457                 7 10
1458                 8 1
1459                 8 5
1460                 8 6
1461                 8 10
1462                 9 1
1463                 9 5
1464                 9 6
1465                 9 10
1466                 10 1
1467                 10 5
1468                 10 6
1469                 10 10
1470                 10 11
1471                 10 12
1472                 11 1
1473                 11 5
1474                 11 6
1475                 11 10
1476                 12 1
1477                 12 5
1478                 12 6
1479                 12 9];
1480 
1481             <span class="comment">% SVD orbit correction</span>
1482             Xivec = [1:28];
1483             Yivec = [1:51];
1484 
1485 
1486             LocalBumplist = [
1487               <span class="comment">% 1 1</span>
1488               <span class="comment">% 2 1</span>
1489               <span class="comment">% 3 1</span>
1490                 4 1
1491               <span class="comment">% 4 2</span>
1492                 5 1
1493               <span class="comment">% 6 1</span>
1494               <span class="comment">% 6 2</span>
1495                 7 1
1496                 8 1
1497                 9 1
1498                 10 1
1499                 11 1
1500                 11 2
1501                 12 1
1502 ];
1503             <span class="comment">%LocalBumplist = []</span>
1504             
1505             <span class="comment">% initialize RFCorrFlag</span>
1506             RFCorrFlag = <span class="string">'Yes'</span>;
1507         <span class="keyword">else</span>
1508 
1509             <span class="comment">% Get vectors</span>
1510             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>);
1511             BPMlist1 = FB.BPMlist1;
1512             HCMlist1 = FB.HCMlist1;
1513             VCMlist1 = FB.VCMlist1;
1514             Xivec = FB.Xivec;
1515             Yivec = FB.Yivec;
1516             LocalBumplist = FB.LocalBumplist;
1517             Xgoal = FB.Xgoal;
1518             Ygoal = FB.Ygoal;
1519             RFCorrFlag = FB.RFCorrFlag;
1520 
1521             <span class="comment">% Add button to change #ivectors, CMs, IDBPMs,</span>
1522             EditFlag = 0;
1523             h_fig1 = figure;
1524             <span class="keyword">while</span> EditFlag ~= 8
1525 
1526                 <span class="comment">% Sensitivity matrix</span>
1527                 Sx = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
1528                 Sy = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
1529                 
1530                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1531                 <span class="comment">% Can the call below work for setting FOFB RF parameter? %</span>
1532                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1533                 <span class="keyword">if</span> strcmpi(RFCorrFlag, <span class="string">'Yes'</span>)
1534                     Sx = [Sx getdisp(<span class="string">'BPMx'</span>,BPMlist1)];
1535                 <span class="keyword">end</span>
1536                 
1537                 [Ux, SVx, Vx] = svd(Sx);
1538                 [Uy, SVy, Vy] = svd(Sy);
1539 
1540 
1541                 <span class="comment">% Remove singular values greater than the actual number of singular values</span>
1542                 i = find(Xivec&gt;length(diag(SVx)));
1543                 <span class="keyword">if</span> ~isempty(i)
1544                     disp(<span class="string">'   Horizontal E-vector scaled since there were more elements in the vector than singular values.'</span>);
1545                     pause(0);
1546                     Xivec(i) = [];
1547                 <span class="keyword">end</span>
1548                 i = find(Yivec&gt;length(diag(SVy)));
1549                 <span class="keyword">if</span> ~isempty(i)
1550                     disp(<span class="string">'   Vertical E-vector scaled since there were more elements in the vector than singular values.'</span>);
1551                     pause(0);
1552                     Yivec(i) = [];
1553                 <span class="keyword">end</span>
1554 
1555 
1556                 Ax = Sx*Vx(:,Xivec);
1557                 Tx = inv(Ax'*Ax)*Ax';
1558 
1559                 Ay = Sy*Vy(:,Yivec);
1560                 Ty = inv(Ay'*Ay)*Ay';
1561 
1562 
1563                 figure(h_fig1);
1564                 subplot(2,1,1);
1565                 semilogy(diag(SVx),<span class="string">'b'</span>);
1566                 hold on;
1567                 semilogy(diag(SVx(Xivec,Xivec)),<span class="string">'xr'</span>);
1568                 ylabel(<span class="string">'Horizontal'</span>);
1569                 title(<span class="string">'Response Matrix Singular Values'</span>);
1570                 hold off;
1571                 subplot(2,1,2);
1572                 semilogy(diag(SVy),<span class="string">'b'</span>);
1573                 hold on;
1574                 semilogy(diag(SVy(Yivec,Yivec)),<span class="string">'xr'</span>);
1575                 xlabel(<span class="string">'Singular Value Number'</span>);
1576                 ylabel(<span class="string">'Vertical'</span>);
1577                 hold off;
1578                 drawnow;
1579 
1580                 <span class="keyword">if</span> strcmp(RFCorrFlag,<span class="string">'No'</span>)
1581                     RFCorrState = <span class="string">'NOT CORRECTED'</span>;
1582                 <span class="keyword">elseif</span> strcmp(RFCorrFlag,<span class="string">'Yes'</span>)
1583                     RFCorrState = <span class="string">'CORRECTED'</span>;
1584                 <span class="keyword">else</span>
1585                     RFCorrState = <span class="string">'???'</span>;
1586                 <span class="keyword">end</span>
1587 
1588                 <span class="comment">%         EditFlag = menu('Change Parameters?','Singular Values','HCM List','VCM List','HCM Chicane List','VCM Chicane List','IDBPM List','BBPM List','Change Golden Orbit',...</span>
1589                 <span class="comment">%            'Local Bump List',sprintf('RF Frequency (currently %s)',RFCorrState),'Continue');</span>
1590                 EditFlag = menu(<span class="string">'Change Parameters?'</span>,<span class="string">'Singular Values'</span>,<span class="string">'HCM List'</span>,<span class="string">'VCM List'</span>,<span class="string">'BPM List'</span>,<span class="string">'Change Golden Orbit'</span>,<span class="keyword">...</span>
1591                     <span class="string">'Local Bump List'</span>,sprintf(<span class="string">'RF Frequency (currently %s)'</span>,RFCorrState),<span class="string">'Continue'</span>);
1592 
1593                 <span class="keyword">if</span> EditFlag == 1
1594                     prompt={<span class="string">'Enter the horizontal E-vector numbers (Matlab vector format):'</span>,<span class="string">'Enter the vertical E-vector numbers (Matlab vector format):'</span>};
1595                     def={sprintf(<span class="string">'[%d:%d]'</span>,1,Xivec(end)),sprintf(<span class="string">'[%d:%d]'</span>,1,Yivec(end))};
1596                     titlestr=<span class="string">'SVD Orbit Feedback'</span>;
1597                     lineNo=1;
1598                     answer=inputdlg(prompt,titlestr,lineNo,def);
1599                     <span class="keyword">if</span> ~isempty(answer)
1600                         XivecNew = fix(str2num(answer{1}));
1601                         <span class="keyword">if</span> isempty(XivecNew)
1602                             disp(<span class="string">'   Horizontal E-vector cannot be empty.  No change made.'</span>);
1603                         <span class="keyword">else</span>
1604                             <span class="keyword">if</span> any(XivecNew&lt;=0) | max(XivecNew)&gt;length(diag(SVx))
1605                                 disp(<span class="string">'   Error reading horizontal E-vector.  No change made.'</span>);
1606                             <span class="keyword">else</span>
1607                                 Xivec = XivecNew;
1608                             <span class="keyword">end</span>
1609                         <span class="keyword">end</span>
1610                         YivecNew = fix(str2num(answer{2}));
1611                         <span class="keyword">if</span> isempty(YivecNew)
1612                             disp(<span class="string">'   Vertical E-vector cannot be empty.  No change made.'</span>);
1613                         <span class="keyword">else</span>
1614                             <span class="keyword">if</span> any(YivecNew&lt;=0) | max(YivecNew)&gt;length(diag(SVy))
1615                                 disp(<span class="string">'   Error reading vertical E-vector.  No change made.'</span>);
1616                             <span class="keyword">else</span>
1617                                 Yivec = YivecNew;
1618                             <span class="keyword">end</span>
1619                         <span class="keyword">end</span>
1620                     <span class="keyword">end</span>
1621                 <span class="keyword">end</span>
1622 
1623                 <span class="keyword">if</span> EditFlag == 2
1624                     List = getlist(<span class="string">'HCM'</span>);
1625                     CheckList = zeros(size(List,1));
1626                     Elem = dev2elem(<span class="string">'HCM'</span>, HCMlist1);
1627                     CheckList(Elem) = ones(size(Elem));
1628                     CheckList = CheckList(dev2elem(<span class="string">'HCM'</span>,List));
1629                     newList = editlist(List, <span class="string">'HCM'</span>, CheckList);
1630                     <span class="keyword">if</span> isempty(newList)
1631                         fprintf(<span class="string">'   Horizontal corrector magnet list cannot be empty.  No change made.\n'</span>);
1632                     <span class="keyword">else</span>
1633                         HCMlist1 = newList;
1634                     <span class="keyword">end</span>
1635                 <span class="keyword">end</span>
1636 
1637                 <span class="keyword">if</span> EditFlag == 3
1638                     List = getlist(<span class="string">'VCM'</span>);
1639                     CheckList = zeros(size(List,1));
1640                     Elem = dev2elem(<span class="string">'VCM'</span>, VCMlist1);
1641                     CheckList(Elem) = ones(size(Elem));
1642                     CheckList = CheckList(dev2elem(<span class="string">'VCM'</span>,List));
1643                     newList = editlist(List, <span class="string">'VCM'</span>, CheckList);
1644                     <span class="keyword">if</span> isempty(newList)
1645                         fprintf(<span class="string">'   Vertical corrector magnet cannot be empty.  No change made.\n'</span>);
1646                     <span class="keyword">else</span>
1647                         VCMlist1 = newList;
1648                     <span class="keyword">end</span>
1649                 <span class="keyword">end</span>
1650 
1651                 <span class="keyword">if</span> EditFlag == 4
1652                     ListOld = BPMlist1;
1653                     XgoalOld = Xgoal;
1654                     YgoalOld = Ygoal;
1655 
1656                     <span class="comment">% Full BPM list</span>
1657                     List = [
1658                         1 2
1659                         1 5
1660                         1 6
1661                         1 10
1662                         2 1
1663                         2 5
1664                         2 6
1665                         2 9
1666                         3 2
1667                         3 5
1668                         3 6
1669                         3 10
1670                         3 11
1671                         3 12
1672                         4 1
1673                         4 5
1674                         4 6
1675                         4 10
1676                         5 1
1677                         5 5
1678                         5 6
1679                         5 10
1680                         5 11
1681                         5 12
1682                         6 1
1683                         6 5
1684                         6 6
1685                         6 10
1686                         7 1
1687                         7 5
1688                         7 6
1689                         7 10
1690                         8 1
1691                         8 5
1692                         8 6
1693                         8 10
1694                         9 1
1695                         9 5
1696                         9 6
1697                         9 10
1698                         10 1
1699                         10 5
1700                         10 6
1701                         10 10
1702                         10 11
1703                         10 12
1704                         11 1
1705                         11 5
1706                         11 6
1707                         11 10
1708                         12 1
1709                         12 5
1710                         12 6
1711                         12 9
1712                         ];
1713 
1714                     CheckList = zeros(size(List,1),1);
1715                     <span class="keyword">if</span> ~isempty(BPMlist1)
1716                         <span class="keyword">for</span> i = 1:size(List,1)
1717                             k = find(List(i,1)==BPMlist1(:,1));
1718                             l = find(List(i,2)==BPMlist1(k,2));
1719 
1720                             <span class="keyword">if</span> isempty(k) | isempty(l)
1721                                 <span class="comment">% Item not in list</span>
1722                             <span class="keyword">else</span>
1723                                 CheckList(i) = 1;
1724                             <span class="keyword">end</span>
1725                         <span class="keyword">end</span>
1726                     <span class="keyword">end</span>
1727 
1728                     newList = editlist(List, <span class="string">'BPM'</span>, CheckList);
1729                     <span class="keyword">if</span> isempty(newList)
1730                         fprintf(<span class="string">'   BPM list cannot be empty.  No change made.\n'</span>);
1731                     <span class="keyword">else</span>
1732                         BPMlist1 = newList;
1733                     <span class="keyword">end</span>
1734 
1735                     <span class="comment">% Set the goal orbit to the golden orbit</span>
1736                     Xgoal = getgolden(<span class="string">'BPMx'</span>, BPMlist1);
1737                     Ygoal = getgolden(<span class="string">'BPMy'</span>, BPMlist1);
1738 
1739 
1740                     <span class="comment">% If a new BPM is added, then set the goal orbit to the golden orbit</span>
1741                     <span class="keyword">for</span> i = 1:size(BPMlist1,1)
1742 
1743                         <span class="comment">% Is it a new BPM?</span>
1744                         k = find(BPMlist1(i,1)==ListOld(:,1));
1745                         l = find(BPMlist1(i,2)==ListOld(k,2));
1746 
1747                         <span class="keyword">if</span> isempty(k) | isempty(l)
1748                             <span class="comment">% New BPM</span>
1749                         <span class="keyword">else</span>
1750                             <span class="comment">% Use the old value for old BPM</span>
1751                             Xgoal(i) = XgoalOld(k(l));
1752                             Ygoal(i) = YgoalOld(k(l));
1753                         <span class="keyword">end</span>
1754                     <span class="keyword">end</span>
1755                 <span class="keyword">end</span>
1756 
1757                 <span class="keyword">if</span> EditFlag == 5
1758 
1759                     ChangeList = editlist(BPMlist1, <span class="string">'Change BPM'</span>, zeros(size(BPMlist1,1),1));
1760                     <span class="keyword">for</span> i = 1:size(ChangeList,1)
1761 
1762                         k = find(ChangeList(i,1)==BPMlist1(:,1));
1763                         l = find(ChangeList(i,2)==BPMlist1(k,2));
1764 
1765                         prompt = {sprintf(<span class="string">'Enter the new horizontal goal orbit for BPMx(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2)),sprintf(<span class="string">'Enter the new vertical goal orbit for BPMy(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2))};
1766                         def = {sprintf(<span class="string">'%f'</span>,Xgoal(k(l))),sprintf(<span class="string">'%f'</span>,Ygoal(k(l)))};
1767                         titlestr = <span class="string">'CHANGE THE GOAL ORBIT'</span>;
1768                         lineNo = 1;
1769                         answer = inputdlg(prompt, titlestr, lineNo, def);
1770 
1771                         <span class="keyword">if</span> isempty(answer)
1772                             <span class="comment">% No change</span>
1773                             fprintf(<span class="string">'   No change was made to the golden orbit.\n'</span>);
1774                         <span class="keyword">else</span>
1775                             Xgoalnew = str2num(answer{1});
1776                             <span class="keyword">if</span> isempty(Xgoalnew)
1777                                 fprintf(<span class="string">'   No change was made to the horizontal golden orbit.\n'</span>);
1778                             <span class="keyword">else</span>
1779                                 Xgoal(k(l)) = Xgoalnew;
1780                             <span class="keyword">end</span>
1781 
1782                             Ygoalnew = str2num(answer{2});
1783                             <span class="keyword">if</span> isempty(Ygoalnew)
1784                                 fprintf(<span class="string">'   No change was made to the vertical golden orbit.\n'</span>);
1785                             <span class="keyword">else</span>
1786                                 Ygoal(k(l)) = Ygoalnew;
1787                             <span class="keyword">end</span>
1788                         <span class="keyword">end</span>
1789                     <span class="keyword">end</span>
1790                     <span class="keyword">if</span> ~isempty(ChangeList)
1791                         fprintf(<span class="string">'   Note:  changing the goal orbit for &quot;Orbit Correction&quot; does not change the goal orbit for &quot;Slow Orbit Feedback.&quot;\n'</span>);
1792                         fprintf(<span class="string">'          Re-running srcontrol will restart the goal orbit to the golden orbit.&quot;\n'</span>);
1793                     <span class="keyword">end</span>
1794                 <span class="keyword">end</span>
1795 
1796                 <span class="keyword">if</span> EditFlag == 6
1797                     List = [
1798                         1 1
1799                         2 1
1800                         3 1
1801                         4 1
1802                         4 2
1803                         5 1
1804                         6 1
1805                         6 2
1806                         7 1
1807                         8 1
1808                         9 1
1809                         10 1
1810                         11 1
1811                         11 2
1812                         12 1];
1813                     CheckList = zeros(size(List,1),1);
1814                     <span class="keyword">if</span> ~isempty(LocalBumplist)
1815                         <span class="keyword">for</span> i = 1:size(List,1)
1816                             k = find(List(i,1)==LocalBumplist(:,1));
1817                             l = find(List(i,2)==LocalBumplist(k,2));
1818 
1819                             <span class="keyword">if</span> isempty(k) | isempty(l)
1820                                 <span class="comment">% Item not in list</span>
1821                             <span class="keyword">else</span>
1822                                 CheckList(i) = 1;
1823                             <span class="keyword">end</span>
1824                         <span class="keyword">end</span>
1825                     <span class="keyword">end</span>
1826                     LocalBumplist = editlist2(List, <span class="string">'Sector'</span>, CheckList);
1827                 <span class="keyword">end</span>
1828 
1829                 <span class="keyword">if</span> EditFlag == 7
1830                     RFCorrFlag = questdlg(sprintf(<span class="string">'Set RF Frequency during Orbit Correction?'</span>),<span class="string">'RF Frequency'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>, <span class="string">'No'</span>);
1831                     <span class="keyword">if</span> strcmp(RFCorrFlag,<span class="string">'No'</span>)
1832                         disp([<span class="string">'   RF Frequency will not be included in global orbit correction.'</span>]);
1833                     <span class="keyword">elseif</span> strcmp(RFCorrFlag,<span class="string">'Yes'</span>)
1834                         disp([<span class="string">'   RF Frequency will be included in global orbit correction.'</span>]);
1835                     <span class="keyword">end</span>
1836 
1837                 <span class="keyword">end</span>
1838             <span class="keyword">end</span>
1839             close(h_fig1);
1840         <span class="keyword">end</span>
1841         
1842 <span class="comment">%  ORBIT CORRECTION STRUCTURE (OCS)</span>
1843 <span class="comment">%    OCS.BPM (data structure)</span>
1844 <span class="comment">%    OCS.CM  (data structure)</span>
1845 <span class="comment">%    OCS.GoalOrbit</span>
1846 <span class="comment">%    OCS.NIter</span>
1847 <span class="comment">%    OCS.SVDIndex</span>
1848 <span class="comment">%    OCS.IncrementalFlag = 'Yes'/'No'</span>
1849 <span class="comment">%    OCS.BPMWeight</span>
1850 <span class="comment">%    OCS.Flags = { 'FitRF' , etc.  }</span>
1851         OCSx.BPM = getx(BPMlist1, <span class="string">'struct'</span>);
1852         OCSx.CM = getsp(<span class="string">'HCM'</span>, HCMlist1, <span class="string">'struct'</span>);
1853         OCSx.GoalOrbit = getgolden(OCSx.BPM, <span class="string">'numeric'</span>);
1854         OCSx.NIter = 1;
1855         OCSx.SVDIndex = Xivec;
1856         OCSx.IncrementalFlag = <span class="string">'No'</span>;
1857         OCSx.FitRF = 1;
1858         OCSy.BPM = gety(BPMlist1, <span class="string">'struct'</span>);
1859         OCSy.CM = getsp(<span class="string">'VCM'</span>, VCMlist1, <span class="string">'struct'</span>);
1860         OCSy.GoalOrbit = getgolden(OCSy.BPM, <span class="string">'numeric'</span>);
1861         OCSy.NIter = 1;
1862         OCSy.SVDIndex = Yivec;
1863         OCSy.IncrementalFlag = <span class="string">'No'</span>;
1864         OCSy.FitRF = 0;
1865 
1866         <span class="comment">% Save vectors</span>
1867         FB.OCSx = OCSx;
1868         FB.OCSy = OCSy;
1869 
1870         FB.BPMlist1 = BPMlist1;
1871         FB.HCMlist1 = HCMlist1;
1872         FB.VCMlist1 = VCMlist1;
1873         FB.Xivec = Xivec;
1874         FB.Yivec = Yivec;
1875         FB.Xgoal = OCSx.GoalOrbit;
1876         FB.Ygoal = OCSy.GoalOrbit;
1877         FB.RFCorrFlag = RFCorrFlag;
1878         FB.LocalBumplist = LocalBumplist;
1879         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>,FB);
1880         
1881         
1882     <span class="keyword">case</span> <span class="string">'Feedback'</span>
1883 
1884         FBloopIter = 1;
1885         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxFOFB'</span>),<span class="string">'Value'</span>) == 1
1886             StartFOFBFlag = 1;
1887         <span class="keyword">else</span>
1888             StartFOFBFlag = 0;
1889         <span class="keyword">end</span>
1890 
1891         FEEDBACK_STOP_FLAG = 0;
1892         HWarnNum=0;
1893         VWarnNum=0;
1894 
1895         SR_GeV = getenergy;
1896         <span class="comment">% Feedback loop setup</span>
1897         PlotInfoFlag = 0;           <span class="comment">% Plot micado stuff</span>
1898         LoopDelay = 1.0;           <span class="comment">% Period of feedback loop [seconds], make sure the BPM averaging is correct</span>
1899         VCM_LSB = .00366211;
1900         VCMCHICANE_LSB = .002441;   <span class="comment">% 80 max?,  Note: not fully implemented</span>
1901 
1902         <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
1903             Xgain  = 0.2;
1904             Ygain  = 0.1;
1905         <span class="keyword">else</span>
1906             Xgain  = 0.8; <span class="comment">% raised 0.5-&gt;0.8 at 17:20, 3-2-05 to more quickly correct EPU4 fast switching orbit distortions</span>
1907             Ygain  = 0.8;
1908         <span class="keyword">end</span>
1909 
1910         <span class="comment">% Load lattice set for tune feed forward</span>
1911         ConfigSetpoint = getproductionlattice;
1912         <span class="comment">%load([getfamilydata('Directory','OpsData') getfamilydata('OpsData','LatticeFile')]);</span>
1913         QFsp = ConfigSetpoint.QF.Setpoint.Data;
1914         QDsp = ConfigSetpoint.QD.Setpoint.Data;
1915         TuneW16Min = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(5, 13.23, 1.8909);
1916         <span class="comment">% Tune response matrix</span>
1917         SR_TUNE_MATRIX = gettuneresp({<span class="string">'QF'</span>,<span class="string">'QD'</span>}, {[],[]}, getenergy(<span class="string">'Production'</span>));    <span class="comment">% Approx. [0.1944 -0.0286;-0.1182 0.1526];</span>
1918         <span class="comment">%SR_TUNE_MATRIX = [0.1641 -0.0245</span>
1919         <span class="comment">%                 -0.1149 0.1477];</span>
1920 
1921         <span class="comment">% ID tune compensation does not work in the injection lattice, so ...</span>
1922         <span class="keyword">if</span> abs(SR_GEV - <a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>)&gt;  0.05     <span class="comment">% Don't use this routine for the injection lattice</span>
1923             fprintf(<span class="string">'   This routine should only be used for the production energy: Orbit feedback aborted\n'</span>);
1924             <span class="keyword">return</span>
1925         <span class="keyword">end</span>
1926 
1927         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1928 
1929         <span class="keyword">try</span>
1930             fprintf(<span class="string">'\n'</span>);
1931             fprintf(<span class="string">'   *******************************\n'</span>);
1932             fprintf(<span class="string">'   **  Starting Orbit Feedback  **\n'</span>);
1933             fprintf(<span class="string">'   *******************************\n'</span>);
1934             a = clock;
1935             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1936             fprintf(<span class="string">'   Note: the Matlab command window will be used to display status information.\n'</span>);
1937             fprintf(<span class="string">'         It cannot be used to enter commands during slow orbit feedback.\n'</span>);
1938 
1939 
1940                 <span class="comment">% save current BPM timeconstant - will reset to this when feedback stops</span>
1941                 BPMtimeconstantOFB = <a href="getbpmtimeconstant.html" class="code" title="function [BPMTimeConstant, WarningFlag] = getbpmtimeconstant(varargin)">getbpmtimeconstant</a>;
1942                 fprintf(<span class="string">'   Current Bergoz BPM time constant is %.1fs\n'</span>, BPMtimeconstantOFB);
1943                 
1944             <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
1945             disp(<span class="string">'   Bergoz BPM time constant set to 0.2s.'</span>)
1946             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.2)
1947             pause(1.1);
1948 
1949             <span class="comment">% Check whether bumps and kickers are on and warn to turn off before starting feedback if necessary</span>
1950             <span class="keyword">try</span>
1951                 <span class="keyword">if</span> (getsp(<span class="string">'SR01S___BUMP1__BC21'</span>)==1 &amp; getsp(<span class="string">'SR01S___BUMP1P_BC22'</span>)==1) | (getsp(<span class="string">'SR01S___SEK____BC21'</span>)==1 &amp; getsp(<span class="string">'SR01S___SEK_P__BC23'</span>)==1) | (getsp(<span class="string">'SR01S___SEN____BC20'</span>)==1 &amp; getsp(<span class="string">'SR01S___SEN_P__BC22'</span>)==1)
1952                     soundtada;
1953                     fprintf(<span class="string">'   \n'</span>);
1954                     fprintf(<span class="string">'   *********************************************************************************\n'</span>);
1955                     fprintf(<span class="string">'   ** One or more of the pulsed SR injection magnets is still on!  Turn them off! **\n'</span>);
1956                     fprintf(<span class="string">'   *********************************************************************************\n'</span>);
1957                     fprintf(<span class="string">'   \n'</span>);
1958                 <span class="keyword">end</span>
1959             <span class="keyword">catch</span>
1960                 disp(<span class="string">'**Problem checking the state of the bumps and kickers - please check that they are not pulsing.'</span>);
1961             <span class="keyword">end</span>
1962 
1963             <span class="comment">% Get vectors</span>
1964 
1965             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
1966 
1967             BPMlist1 = FB.OCSx.BPM.DeviceList;
1968             <span class="comment">% FOFB_BPMlist =</span>
1969             HCMlist1 = FB.HCMlist1;
1970             VCMlist1 = FB.VCMlist1;
1971             Xivec = FB.Xivec;
1972             Yivec = FB.Yivec;
1973             Xgoal = FB.OCSx.GoalOrbit;
1974             Ygoal = FB.OCSy.GoalOrbit;
1975             FFTypeFlag = FB.FFTypeFlag;   <span class="comment">%local or global tune correction</span>
1976 
1977             iNotHCMChicane = find(HCMlist1(:,2) &lt; 10); <span class="comment">%used by steppv's for setting correctors in loop</span>
1978             iHCMChicane = find(HCMlist1(:,2) == 10);
1979             iNotVCMChicane = find(VCMlist1(:,2) &lt; 10);
1980             iVCMChicane = find(VCMlist1(:,2) == 10);
1981 
1982             <span class="comment">% Sensitivity matrix for setting fast feedback setpoints</span>
1983             Sx1 = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
1984             Sy1 = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
1985 
1986         <span class="keyword">catch</span>
1987             fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
1988 
1989             <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
1990             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
1991             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
1992 
1993 
1994             a = clock;
1995             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1996             fprintf(<span class="string">'   *************************************************************\n'</span>);
1997             fprintf(<span class="string">'   **  Orbit feedback could not start due to error condition  **\n'</span>);
1998             fprintf(<span class="string">'   *************************************************************\n\n'</span>);
1999             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
2000             pause(0);
2001 
2002             <span class="keyword">return</span>
2003         <span class="keyword">end</span>
2004 
2005         StartFlag = questdlg(strvcat(<span class="string">''</span>,<span class="string">'Is it OK to start orbit feedback?'</span>),<span class="string">'Orbit Feedback'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
2006         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
2007             <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2008             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2009             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2010 
2011             a = clock;
2012             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2013             fprintf(<span class="string">'   ***************************\n'</span>);
2014             fprintf(<span class="string">'   **  Orbit Feedback Exit  **\n'</span>);
2015             fprintf(<span class="string">'   ***************************\n\n'</span>);
2016             pause(0);
2017             <span class="keyword">return</span>
2018         <span class="keyword">end</span>
2019 
2020         SR_STATE_OLD = scaget(<span class="string">'SR_STATE'</span>);
2021         setpv(<span class="string">'SR_STATE'</span>, 5);
2022         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
2023         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2024         <span class="keyword">if</span> StateNumber &gt;= 0
2025             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2026         <span class="keyword">else</span>
2027             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2028         <span class="keyword">end</span>
2029         fprintf(<span class="string">'   Using %d E-vectors horizontally.\n'</span>, length(Xivec));
2030         fprintf(<span class="string">'   Using %d E-vectors vertically.\n'</span>,   length(Yivec));
2031         fprintf(<span class="string">'   Starting slow orbit correction every %.1f seconds.\n'</span>, LoopDelay);
2032         <span class="comment">%  fprintf('   Resetting SR11 chicane motors every 20 seconds to fix drift problem.\n');</span>
2033 
2034         IDSector = getlist(<span class="string">'ID'</span>);
2035         EPUlist = find((IDSector(:,1)==4) | (IDSector(:,1)==11));
2036         oldgap=210*ones(size(IDSector,1),1);
2037         oldShift=zeros(size(oldgap));
2038           
2039         <span class="keyword">try</span>
2040             
2041             <span class="comment">% Get and display data</span>
2042             x = FB.OCSx.GoalOrbit - getx(FB.OCSx.BPM.DeviceList);
2043             y = FB.OCSy.GoalOrbit - gety(FB.OCSy.BPM.DeviceList);
2044             STDx = norm(x)/sqrt(length(x));
2045             STDy = norm(y)/sqrt(length(y));
2046             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = %.4f mm'</span>,STDx),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2047             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = %.4f mm'</span>,STDy),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2048 
2049             <span class="comment">% write goldenorbit values to Fast Orbit Feedback</span>
2050             <span class="keyword">try</span>
2051                 <a href="write_goldenorbit_ffb.html" class="code" title="function write_goldenorbit_ffb">write_goldenorbit_ffb</a>;
2052             <span class="keyword">catch</span>
2053                 disp(<span class="string">'write_goldenorbit_ffb did not work!'</span>);
2054             <span class="keyword">end</span>
2055             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2056             <span class="comment">%pause(0);</span>
2057 
2058             <span class="comment">%display state of FOFB system</span>
2059             FOFBStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2060                 getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2061                 getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2062                 getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2063             FOFBStatusStr = [<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>;<span class="string">'    '</span>];
2064             <span class="keyword">for</span> loop = 1:size(FOFBStatus,2)
2065                 <span class="keyword">if</span> FOFBStatus(loop)==0
2066                     FOFBStatusStr(loop,:) = <span class="string">'OFF '</span>;
2067                 <span class="keyword">elseif</span> FOFBStatus(loop)==1
2068                     FOFBStatusStr(loop,:) = <span class="string">'ON  '</span>;
2069                 <span class="keyword">elseif</span> FOFBStatus(loop)==2
2070                     FOFBStatusStr(loop,:) = <span class="string">'OPEN'</span>;
2071                 <span class="keyword">else</span>
2072                     FOFBStatusStr(loop,:) = <span class="string">'BAD '</span>;
2073                 <span class="keyword">end</span>
2074             <span class="keyword">end</span>
2075             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 %s'</span>,FOFBStatusStr(1,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2076             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 %s'</span>,FOFBStatusStr(2,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2077             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 %s'</span>,FOFBStatusStr(3,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2078             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 %s'</span>,FOFBStatusStr(4,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2079             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 %s'</span>,FOFBStatusStr(5,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2080             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 %s'</span>,FOFBStatusStr(6,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2081             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 %s'</span>,FOFBStatusStr(7,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2082             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 %s'</span>,FOFBStatusStr(8,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2083             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 %s'</span>,FOFBStatusStr(9,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2084             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 %s'</span>,FOFBStatusStr(10,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2085             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 %s'</span>,FOFBStatusStr(11,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2086             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 %s'</span>,FOFBStatusStr(12,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2087 
2088         <span class="keyword">catch</span>
2089 
2090             fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
2091 
2092             <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2093             fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2094             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2095 
2096 
2097             a = clock;
2098             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2099             fprintf(<span class="string">'   *************************************************************\n'</span>);
2100             fprintf(<span class="string">'   **  Orbit feedback could not start due to error condition  **\n'</span>);
2101             fprintf(<span class="string">'   *************************************************************\n\n'</span>);
2102 
2103             setpv(<span class="string">'SR_STATE'</span>,SR_STATE_OLD);
2104             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2105             <span class="keyword">if</span> StateNumber &gt;= 0
2106                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2107             <span class="keyword">else</span>
2108                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2109             <span class="keyword">end</span>
2110             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
2111             pause(0);
2112 
2113             <span class="keyword">return</span>
2114 
2115         <span class="keyword">end</span>
2116 
2117 
2118         <span class="comment">% Disable buttons</span>
2119         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
2120         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2121         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2122         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2123         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2124         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2125         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2126         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2127         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2128         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2129         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2130         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2131         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2132         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2133         pause(0);
2134 
2135 
2136         <span class="comment">% Initialize feedback loop</span>
2137         StartTime = gettime;
2138         StartErrorTime = gettime;
2139         Xold = getx(FB.OCSx.BPM.DeviceList);
2140         Yold = gety(FB.OCSy.BPM.DeviceList);
2141         HQMOFM_stalenum = 0;
2142         pause(LoopDelay);
2143 
2144         N_HCM = size(HCMlist1,1);
2145         N_VCM = size(VCMlist1,1);
2146 
2147         N_RFMO = 1;
2148 
2149         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
2150             [FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,<span class="string">'SetRF'</span>,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2151         <span class="keyword">else</span>
2152             [FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2153         <span class="keyword">end</span>
2154         [FB.OCSx, Smatx, Sx, Ux, Vx] = orbitcorrectionmethods(FB.OCSx);
2155 
2156         [FB.OCSy, junk, OCSy0] = setorbit(FB.OCSy,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
2157         [FB.OCSy, Smaty, Sy, Uy, Vy] = orbitcorrectionmethods(FB.OCSy);
2158 
2159 
2160         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2161         <span class="comment">% Start feedback loop %</span>
2162         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2163 
2164         <span class="comment">% chicaneloop=1;  % loop variable for resetting drifting chicanes (see a few lines below)</span>
2165         <span class="comment">% fftest=figure;</span>
2166 
2167         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2); <span class="comment">% put FOFB in open loop so beamnoise gets recorded even if FOFB is not enabled</span>
2168 
2169         <span class="keyword">while</span> 1
2170             <span class="keyword">try</span>
2171                 t00 = gettime;
2172 
2173                 <span class="comment">%          if chicaneloop==20 % reset SR11 motor chicane setpoints every 20s due to drifting positions</span>
2174                 <span class="comment">%             setsp('HCMCHICANEM',HCMCHICANEMsp(6),[11 1],0);</span>
2175                 <span class="comment">%             setsp('HCMCHICANEM',HCMCHICANEMsp(7),[11 2],0);</span>
2176                 <span class="comment">%             chicaneloop = 1;</span>
2177                 <span class="comment">%          else</span>
2178                 <span class="comment">%             chicaneloop = chicaneloop + 1;</span>
2179                 <span class="comment">%          end</span>
2180 
2181                 <span class="comment">% Check if GUI has been closed</span>
2182                 <span class="keyword">if</span> isempty(gcbf)
2183                     FEEDBACK_STOP_FLAG = 1;
2184                     lasterr(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2185                     error(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2186                 <span class="keyword">end</span>
2187 
2188                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2189                 <span class="comment">% Fast orbit feedback %</span>
2190                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2191                 <span class="keyword">if</span> StartFOFBFlag == 1 &amp; FBloopIter &gt; 3
2192                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2193                     pause(0.5);
2194                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,1);
2195                     StartFOFBFlag = 0;
2196                     pause(1);
2197                     FOFBOnStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2198                         getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2199                         getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2200                         getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2201                     <span class="keyword">if</span> any(FOFBOnStatus==0) | any(FOFBOnStatus==2)
2202                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2); <span class="comment">% open FOFB loop</span>
2203                         disp(<span class="string">'************************************************************************************************************'</span>);
2204                         disp(<span class="string">'** Problem turning on Fast Orbit Feedback system...                                                       **'</span>);
2205                         disp(<span class="string">'** Check status of ffbsecXX crates - but remember that a crate reboot will turn off Quads in that sector! **'</span>);
2206                         disp(<span class="string">'** Suggest disabling the &quot;Fast Orbit Correction&quot; checkbox and starting Orbit Feedback again.              **'</span>);
2207                         disp(<span class="string">'************************************************************************************************************'</span>);
2208                     <span class="keyword">else</span>
2209                         fprintf(<span class="string">'   Starting Fast Orbit Feedback at %.0f Hz.\n'</span>, getpv(<span class="string">'SR01____FFBFREQAM00'</span>));
2210                     <span class="keyword">end</span>
2211                 <span class="keyword">end</span>
2212 
2213 
2214                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2215                 <span class="comment">% Horizontal plane &quot;feedback&quot; %</span>
2216                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2217 
2218                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxSOFB'</span>),<span class="string">'Value'</span>) == 1
2219 
2220                     <span class="comment">% Get orbit and check that the BPMs are different from the last update</span>
2221                     Xnew = getx(FB.OCSx.BPM.DeviceList);
2222 
2223                     <span class="comment">% Don't feedback if the current is too small</span>
2224                     <span class="keyword">if</span> getdcct &lt; 5
2225                         FEEDBACK_STOP_FLAG = 1;
2226                         fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2227                         <span class="keyword">break</span>;
2228                     <span class="keyword">end</span>
2229 
2230                     x = Xgoal - Xnew;
2231                     STDx = norm(x)/sqrt(length(x));
2232 
2233                     <span class="keyword">if</span> any(Xold == Xnew)
2234                         a = clock;
2235                         N_Stale_Data_Points = find((Xold==Xnew)==1);
2236                         <span class="keyword">for</span> loop = N_Stale_Data_Points'
2237                             fprintf(<span class="string">'   Stale data: BPMx(%2d,%d), feedback step skipped (%s %d:%d:%.0f). \n'</span>, FB.OCSx.BPM.DeviceList(loop,1), FB.OCSx.BPM.DeviceList(loop,2), date, a(4), a(5), a(6));
2238                         <span class="keyword">end</span>
2239                     <span class="keyword">else</span>
2240                         <span class="comment">% Compute horizontal correction</span>
2241                         <span class="comment">%%%OCSx0 = FB.OCSx;</span>
2242                         FB.OCSx.BPM.Data = Xnew;
2243                         FB.OCSx = orbitcorrectionmethods(FB.OCSx, Smatx, Sx, Ux, Vx);
2244 
2245                         <span class="comment">%%%[FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,'Nodisplay','Nosetsp');</span>
2246 
2247                         <span class="comment">% reduced feedback gain (implemented by Greg Portmann, December 2000)</span>
2248                         <span class="comment">% reduced to 0.1, C. Steier, 2001-09-04, IDBPMs are noisy at the moment</span>
2249                         <span class="comment">% increased back to 0.8 C. Steier, 2001-09-29, IDBPMs filtering + direct DAC read/write + all SVDs (no arc BPMs)</span>
2250                         <span class="comment">% increased to 1.0, C. Steier, 2002-05-04, trim DACs</span>
2251                         X = Xgain .* FB.OCSx.CM.Delta;
2252                         X(N_HCM+1) = 0.3*FB.OCSx.DeltaRF/4.988e-3;
2253                         <span class="comment">%%%X = Xgain .* (FB.OCSx.CM.Data - OCSx0.CM.Data);</span>
2254 
2255                         <span class="comment">% check for trim values+next step values, warn or stop FB as necessary</span>
2256                         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2257                         <span class="comment">% need to extract Chicanes from this comparison or maybe check them first for range %</span>
2258                         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2259                         HCMtrimSP=getpv(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1);
2260                         HCMtrimSP_next = HCMtrimSP + X(1:N_HCM);
2261                         <span class="keyword">if</span> max(abs(HCMtrimSP_next)) &gt; 4
2262                             HCMtrimnum=find(abs(HCMtrimSP_next) &gt; 4);
2263 
2264                             <span class="comment">% print message to screen</span>
2265                             fprintf(<span class="string">'**One or more of the horizontal correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2266                             fprintf(<span class="string">'%s\n'</span>,datestr(now));
2267                             <span class="keyword">for</span> loop = HCMtrimnum'
2268                                 fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1(loop,:)));
2269                             <span class="keyword">end</span>
2270 
2271                             <span class="comment">% send alphapage to operator pager</span>
2272                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2273                             FEEDBACK_STOP_FLAG = 1;
2274 
2275                             setpv(<span class="string">'SR_STATE'</span>, -5);
2276                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2277                             <span class="keyword">if</span> StateNumber &gt;= 0
2278                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2279                             <span class="keyword">else</span>
2280                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2281                             <span class="keyword">end</span>
2282                         <span class="keyword">end</span>
2283 
2284                         <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2285                             <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2286                             <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2287                                 disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2288                             <span class="keyword">end</span>
2289                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2290                             pause(0.5);
2291                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2292                             <span class="keyword">break</span>;
2293                         <span class="keyword">end</span>
2294 
2295                         <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2296                         pause(0);
2297 
2298                         <span class="keyword">if</span> max(abs(HCMtrimSP_next) &gt; 3)
2299                             HCMtrimnum=find(abs(HCMtrimSP_next) &gt; 3);
2300                             HWarnNum=HWarnNum+1;
2301                             <span class="keyword">if</span> (HWarnNum==1 | rem(HWarnNum,120)==0)
2302 
2303                                 <span class="comment">% print message to screen every two minutes</span>
2304                                 fprintf(<span class="string">'**One or more of the horizontal corrector trims is above 3A or below -3A! \n'</span>);
2305                                 fprintf(<span class="string">'%s\n'</span>,datestr(now));
2306                                 <span class="keyword">for</span> loop = HCMtrimnum'
2307                                     fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1(loop,:)));
2308                                 <span class="keyword">end</span>
2309                                 fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2310 
2311                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2312                                 <span class="keyword">if</span> (HWarnNum==1 | HWarnNum==600)
2313                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageHCM.txt
2314                                 <span class="keyword">end</span>
2315                             <span class="keyword">end</span>
2316                         <span class="keyword">else</span>
2317                             HWarnNum=0;
2318                         <span class="keyword">end</span>
2319 
2320                         <span class="comment">% Don't feedback if the current is too small</span>
2321                         <span class="keyword">if</span> getdcct &lt; 5
2322                             FEEDBACK_STOP_FLAG = 1;
2323                             fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2324                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/beamisoff.txt
2325                             <span class="keyword">break</span>;
2326                         <span class="keyword">end</span>
2327 
2328                         <span class="keyword">if</span> N_HCM &gt; 0
2329                             steppv(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>, X(iNotHCMChicane), HCMlist1(iNotHCMChicane,:), 0);
2330                             steppv(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>, X(iHCMChicane), HCMlist1(iHCMChicane,:), 0);
2331                         <span class="keyword">end</span>
2332 
2333                         <span class="comment">% write fast orbit feedback setpoints</span>
2334                         <span class="keyword">if</span> 1
2335                             <span class="comment">%write_goldenorbit_ffb_2planes(1, Xnew(1:size(BPMlist1,1))+Sx1*X(1:N_HCM)+Sx3*X(length(X))/20, BPMlist1);</span>
2336                             <span class="comment">% should be corrected to include result of next frequency step ...</span>
2337                             <a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>(1,Xnew(1:size(BPMlist1,1))+Sx1*X(1:N_HCM),BPMlist1);
2338                         <span class="keyword">end</span>
2339 
2340                         <span class="comment">%fprintf('Horizontal Done: %f \n',gettime-t00);</span>
2341 
2342                         <span class="comment">% RF feedback</span>
2343                         HQMOFMsp_last = getpv(<span class="string">'EG______HQMOFM_AC01'</span>);
2344 
2345                         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
2346                             <span class="keyword">if</span> N_RFMO &gt; 0
2347                                 <span class="keyword">if</span> abs(X(end)/3) &lt; .01
2348                                     <span class="comment">% if abs(FB.OCSx.DeltaRF/3) &lt; .01</span>
2349                                     steppv(<span class="string">'EG______HQMOFM_AC01'</span>, X(end));
2350                                 <span class="keyword">else</span>
2351                                     steppv(<span class="string">'EG______HQMOFM_AC01'</span>, 0.01*sign(X(end)));
2352                                 <span class="keyword">end</span>
2353                             <span class="keyword">end</span>
2354 
2355                             HQMOFMsp_now = getpv(<span class="string">'EG______HQMOFM_AC01'</span>);
2356 
2357                             <span class="comment">% Check for stale RF feedback</span>
2358                             <span class="keyword">if</span> HQMOFMsp_last == HQMOFMsp_now
2359                                 HQMOFM_stalenum = HQMOFM_stalenum + 1;
2360                                 <span class="keyword">if</span> HQMOFM_stalenum == 30 <span class="comment">% warn and message to pager if stale for 30 secs</span>
2361                                     fprintf(<span class="string">'**The RF is not responding to orbit feedback changes! \n'</span>);
2362                                     fprintf(<span class="string">'%s\n'</span>,datestr(now));
2363                                     fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2364                                     fprintf(<span class="string">'**ILC 73 controls the EG______HQMOFM_AC01 channel, which sets the RF frequency. \n'</span>);
2365                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstaleRFmessage.txt
2366                                 <span class="keyword">end</span>
2367                                 <span class="keyword">if</span> rem(HQMOFM_stalenum,120)==0 <span class="comment">% message to screen every 2 minutes</span>
2368                                     fprintf(<span class="string">'**The RF is not responding to orbit feedback changes! (%s)\n'</span>,datestr(now));
2369                                 <span class="keyword">end</span>
2370                             <span class="keyword">else</span>
2371                                 HQMOFM_stalenum = 0;
2372                             <span class="keyword">end</span>
2373 
2374                         <span class="keyword">end</span>
2375 
2376                         <span class="comment">%fprintf('RF Done: %f \n',gettime-t00);</span>
2377 
2378                         Xold = Xnew;
2379                     <span class="keyword">end</span> <span class="comment">% End horizontal correction</span>
2380 
2381 
2382                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2383                     <span class="comment">% Vertical plane &quot;feedback&quot; %</span>
2384                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2385 
2386                     <span class="comment">% Get orbit and check that the BPMs are different from the last update</span>
2387                     Ynew = gety(FB.OCSy.BPM.DeviceList);
2388 
2389                     <span class="comment">% Don't feedback if the current is too small</span>
2390                     <span class="keyword">if</span> getdcct &lt; 5
2391                         FEEDBACK_STOP_FLAG = 1;
2392                         fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2393                         <span class="keyword">break</span>;
2394                     <span class="keyword">end</span>
2395 
2396                     y = Ygoal - Ynew;
2397                     STDy = norm(y)/sqrt(length(y));
2398 
2399                     <span class="keyword">if</span> any(Yold == Ynew)
2400                         a = clock;
2401                         N_Stale_Data_Points = find((Yold==Ynew)==1);
2402                         <span class="keyword">for</span> loop = N_Stale_Data_Points'
2403                             fprintf(<span class="string">'   Stale data: BPMy(%2d,%d), feedback step skipped (%s %d:%d:%.0f). \n'</span>, FB.OCSy.BPM.DeviceList(loop,1), FB.OCSy.BPM.DeviceList(loop,2), date, a(4), a(5), a(6));
2404                         <span class="keyword">end</span>
2405 
2406                     <span class="keyword">else</span>
2407 
2408                         <span class="comment">% Compute vertical correction</span>
2409                         <span class="comment">%%%OCSy0 = FB.OCSy;</span>
2410                         FB.OCSy.BPM.Data = Ynew;
2411                         FB.OCSy = orbitcorrectionmethods(FB.OCSy, Smaty, Sy, Uy, Vy);
2412 
2413                         <span class="comment">%%%[FB.OCSy, RF, OCSy0] = setorbit(FB.OCSy,'Nodisplay','Nosetsp');</span>
2414 
2415                         <span class="comment">% reduced feedback gain, C. Steier, 2001-03-25</span>
2416                         <span class="comment">% reduced to 0.1, C. Steier, 2001-09-04, IDBPMs are noisy at the moment</span>
2417                         <span class="comment">% increased back to 0.8, C. Steier, 2001-09-29, IDBPMs filtering + direct DAC read/write + all SVDs (no arc BPMs)</span>
2418                         <span class="comment">% set to unity gain, C. Steier, 2002-05-04, trim DACs</span>
2419                         Y = Ygain .* FB.OCSy.CM.Delta;
2420                         <span class="comment">%%%Y = Ygain .* (FB.OCSy.CM.Data - OCSy0.CM.Data);</span>
2421 
2422                         <span class="comment">% Just SVD correction</span>
2423                         <span class="comment">% warning('Not using &quot;micado&quot; correction in the vertical plane.');</span>
2424 
2425                         <span class="comment">% check for trim values+next step values, warn or stop FB as necessary</span>
2426                         VCMtrimSP = getpv(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1);
2427                         VCMtrimSP_next = VCMtrimSP + Y(1:N_VCM);
2428                         <span class="keyword">if</span> max(abs(VCMtrimSP_next)) &gt; 12
2429                             VCMtrimnum=find(abs(VCMtrimSP_next) &gt; 12);
2430 
2431                             <span class="comment">% print message to screen</span>
2432                             fprintf(<span class="string">'**One or more of the vertical correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2433                             fprintf(<span class="string">'%s\n'</span>,datestr(now));
2434                             <span class="keyword">for</span> loop = VCMtrimnum'
2435                                 fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1(loop,:)));
2436                             <span class="keyword">end</span>
2437 
2438                             <span class="comment">% send alphapage to operator pager</span>
2439                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2440                             FEEDBACK_STOP_FLAG = 1;
2441 
2442                             setpv(<span class="string">'SR_STATE'</span>, -5);
2443                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2444                             <span class="keyword">if</span> StateNumber &gt;= 0
2445                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2446                             <span class="keyword">else</span>
2447                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2448                             <span class="keyword">end</span>
2449                         <span class="keyword">end</span>
2450 
2451                         <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2452                             <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2453                             <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2454                                 disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2455                             <span class="keyword">end</span>
2456                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2457                             pause(0.5);
2458                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2459                             <span class="keyword">break</span>;
2460                         <span class="keyword">end</span>
2461 
2462                         <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2463                         <span class="comment">% pause(0);</span>
2464 
2465                         <span class="keyword">if</span> max(abs(VCMtrimSP_next) &gt; 4)
2466                             VCMtrimnum=find(abs(VCMtrimSP_next) &gt; 4);
2467                             VWarnNum=VWarnNum+1;
2468                             <span class="keyword">if</span> (VWarnNum==1 | rem(VWarnNum,120)==0)
2469 
2470                                 <span class="comment">% print message to screen every two minutes</span>
2471                                 fprintf(<span class="string">'**One or more of the vertical corrector trims is above 4A or below -4A! \n'</span>);
2472                                 fprintf(<span class="string">'%s\n'</span>,datestr(now));
2473                                 <span class="keyword">for</span> loop = VCMtrimnum'
2474                                     fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1(loop,:)));
2475                                 <span class="keyword">end</span>
2476                                 fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2477 
2478                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2479                                 <span class="keyword">if</span> (VWarnNum==1 | VWarnNum==600)
2480                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageVCM.txt
2481                                 <span class="keyword">end</span>
2482                             <span class="keyword">end</span>
2483                         <span class="keyword">else</span>
2484                             VWarnNum=0;
2485                         <span class="keyword">end</span>
2486 
2487                         <span class="comment">% Don't feedback if the current is too small</span>
2488                         <span class="keyword">if</span> getdcct &lt; 5
2489                             FEEDBACK_STOP_FLAG = 1;
2490                             fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2491                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/beamisoff.txt
2492                             <span class="keyword">break</span>;
2493                         <span class="keyword">end</span>
2494 
2495                         <span class="keyword">if</span> N_VCM &gt; 0
2496                             steppv(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>, Y(iNotVCMChicane), VCMlist1(iNotVCMChicane,:), 0);
2497                             steppv(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>, Y(iVCMChicane), VCMlist1(iVCMChicane,:), 0);
2498                         <span class="keyword">end</span>
2499 
2500                         <span class="comment">% write fast orbit feedback setpoints</span>
2501                         <span class="keyword">if</span> 1
2502                             <a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>(2,Ynew(1:size(BPMlist1,1))+Sy1*Y(1:N_VCM),BPMlist1);
2503                         <span class="keyword">end</span>
2504 
2505                     <span class="keyword">end</span>
2506 
2507                     Yold = Ynew;
2508 
2509                     <span class="comment">%fprintf('Vertical Done: %f \n',gettime-t00);</span>
2510                 <span class="keyword">end</span> <span class="comment">% End vertical correction</span>
2511 
2512 
2513                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
2514                 <span class="comment">% Tune feed forward %</span>
2515                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
2516                 <span class="comment">% We should do a Sector limit check</span>
2517 
2518                 tic;
2519                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxTune'</span>),<span class="string">'Value'</span>) == 1
2520 
2521                     <span class="keyword">if</span> strcmp(SR_Mode, <span class="string">'1.9 GeV, High Tune'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Inject at 1.23'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Two-Bunch'</span>)
2522 
2523                         addQFsp = zeros(24,1);
2524                         addQDsp = zeros(24,1);
2525 
2526                         <span class="keyword">if</span> strcmp(FFTypeFlag,<span class="string">'Local'</span>)
2527                             disp(<span class="string">'  No local tune compensation available - global is the default now.'</span>);
2528                         <span class="keyword">elseif</span> strcmp(FFTypeFlag,<span class="string">'Global'</span>)
2529 
2530                             <span class="comment">% The vectorized gets were put outside of loop for speed reasons</span>
2531                             <span class="comment">%</span>
2532                             <span class="comment">% should also set up QFfac, Quadelem, Quadlist structures outside loop</span>
2533                             actualgap = <a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>(IDSector);
2534                             [gapmin,gapmax] = <a href="gaplimit.html" class="code" title="function [GAPmin, GAPmax] = gaplimit(Dev);">gaplimit</a>(IDSector);
2535                             corrind = find(actualgap&lt;(gapmin-1));
2536                             actualgap(corrind)=gapmax(corrind);
2537                             Shift=zeros(size(actualgap));
2538                             Shift(EPUlist)=getpv(<span class="string">'EPU'</span>);
2539 
2540                             IDchangedList=find((abs(actualgap-oldgap)&gt;0.005) | (abs(Shift-oldShift)&gt;0.005));
2541 
2542                             <span class="keyword">if</span> ~isempty(IDchangedList)
2543 
2544                                 oldgap=actualgap;
2545                                 oldShift=Shift;
2546 
2547                                 <span class="comment">% EPUs excite nux = .25 resonance in vertical linear polarization mode!</span>
2548                                 <span class="comment">% therefore with EPU tune feedforward</span>
2549                                 <span class="comment">% running, we want to move our nominal working point away (just below) the .25 resonance.</span>
2550                                 <span class="comment">%</span>
2551                                 <span class="comment">% The following tune correction moves nominal</span>
2552                                 <span class="comment">% nu_x from .25 to .245 - this should be enough for well set up lattices.</span>
2553                                 <span class="comment">%</span>
2554                                 <span class="comment">% 24 QF+ 24 QD</span>
2555                                 DeltaAmps = inv(SR_TUNE_MATRIX) * [-0.005;0];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2556                                 addQFsp = addQFsp + DeltaAmps(1,:);
2557                                 addQDsp = addQDsp + DeltaAmps(2,:);
2558 
2559                                 <span class="keyword">for</span> gapnum = 1:length(actualgap)
2560 
2561                                     <span class="comment">% Change in tune and [QF;QD] from maximum gap</span>
2562 
2563                                     <span class="keyword">if</span> (IDSector(gapnum,1) == 4) | (IDSector(gapnum,1) == 11)
2564                                         <span class="keyword">if</span> IDSector(gapnum,2) == 1
2565                                             modenamestr = sprintf(<span class="string">'SR%02dU___ODS1M__DC00'</span>,IDSector(gapnum,1));
2566                                         <span class="keyword">else</span> <span class="comment">% if IDSector(gapnum,2) == 2</span>
2567                                             modenamestr = sprintf(<span class="string">'SR%02dU___ODS2M__DC00'</span>,IDSector(gapnum,1));
2568                                         <span class="keyword">end</span>
2569                                         epumode = getpvonline(modenamestr);
2570                                         <span class="keyword">if</span> IDSector(gapnum,2)==2
2571                                             longshift=3;
2572                                         <span class="keyword">else</span>
2573                                             longshift=0;
2574                                         <span class="keyword">end</span>
2575                                         <span class="keyword">if</span> (epumode==0) &amp; (any(IDSector(gapnum,:)~=[11 1]))      <span class="comment">% antiparallel tables need to be fit to data so that they could be used here</span>
2576                                             DeltaNuX = <a href="shift2tune.html" class="code" title="function [Dnux, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = shift2tune(Sector, Gap, EPUshift, GeV)">shift2tune</a>(IDSector(gapnum,1),actualgap(gapnum),Shift(gapnum)+longshift,SR_GeV);
2577                                             DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);   <span class="comment">% variation of vertical tune shift with phase is small for EPUs</span>
2578                                         <span class="keyword">else</span>
2579                                             DeltaNuX = 0;
2580                                             DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);   <span class="comment">% variation of vertical tune shift with phase is small for EPUs</span>
2581                                         <span class="keyword">end</span>
2582 
2583                                     <span class="keyword">else</span>
2584                                         DeltaNuX = 0;
2585                                         DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap(gapnum), SR_GeV);
2586                                     <span class="keyword">end</span>
2587 
2588                                     DelQF = zeros(length(QFsp),1);
2589                                     DelQD = zeros(length(QFsp),1);
2590 
2591                                     fraccorr = 0.8*DeltaNuY ./ TuneW16Min;
2592 
2593                                     <span class="comment">% Find which quads to change (local beta beating correction</span>
2594                                     <span class="comment">% (horizontal for EPU, vertical otherwise)</span>
2595                                     QuadList = [IDSector(gapnum,1)-1 2; IDSector(gapnum,1) 1];
2596                                     QuadElem = dev2elem(<span class="string">'QF'</span>,QuadList); <span class="comment">% in reality use QF and QD ...</span>
2597 
2598                                     <span class="comment">% global vertical tune correction</span>
2599                                     <span class="comment">% 24 QF+ 24 QD</span>
2600                                     DeltaAmps = inv(SR_TUNE_MATRIX) * [(fraccorr*6.23e-4); fraccorr*(-0.05301)];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2601                                     DelQF = DelQF + DeltaAmps(1,:);
2602                                     DelQD = DelQD + DeltaAmps(2,:);
2603 
2604                                     <span class="comment">% local horizontal tune correction (is also nearly a beta beating correction) only nonzero for EPUs!</span>
2605                                     <span class="comment">% 2 QF + 2 QD</span>
2606                                     DeltaAmpsLocal = 12*inv(SR_TUNE_MATRIX) * [-DeltaNuX;0];                       <span class="comment">%  DelAmps =  [QF; QD];</span>
2607                                     DelQF(QuadElem) = DelQF(QuadElem)+DeltaAmpsLocal(1,1);
2608                                     DelQD(QuadElem) = DelQD(QuadElem)+DeltaAmpsLocal(2,1);
2609 
2610                                     <span class="comment">% local vertical beta beating correction (should be used together with above global tune correction)</span>
2611                                     <span class="comment">% set to zero for EPUs, since their vertical tune shift is small</span>
2612                                     <span class="comment">% 2 QF + 2QD</span>
2613                                     <span class="keyword">if</span> (IDSector(gapnum,1)==6) | (IDSector(gapnum,1)==7) | (IDSector(gapnum,1)==10) | (IDSector(gapnum,1)==11)
2614                                         QFfac = ([2.243127/2.237111; 2.243127/2.237111]-1) * fraccorr;
2615                                         QDfac = ([2.556392/2.511045; 2.556392/2.511045]-1) * fraccorr;
2616                                     <span class="keyword">elseif</span> (IDSector(gapnum,1)==5) | (IDSector(gapnum,1)==9)
2617                                         QFfac = ([2.225965/2.219784; 2.243096/2.237111]-1) * fraccorr;
2618                                         QDfac = ([2.528950/2.483259; 2.556345/2.511045]-1) * fraccorr;
2619                                     <span class="keyword">elseif</span> (IDSector(gapnum,1)==4) | (IDSector(gapnum,1)==8) | (IDSector(gapnum,1)==12)
2620                                         QFfac = ([2.243096/2.237111; 2.225965/2.219784]-1) * fraccorr;
2621                                         QDfac = ([2.556345/2.511045; 2.528950/2.483259]-1) * fraccorr;
2622                                     <span class="keyword">else</span>
2623                                         QFfac = zeros(2,1);
2624                                         QDfac = zeros(2,1);
2625                                     <span class="keyword">end</span>
2626 
2627                                     DelQF(QuadElem,:) = DelQF(QuadElem,:) + QFfac.*QFsp(QuadElem,:);
2628                                     DelQD(QuadElem,:) = DelQD(QuadElem,:) + QDfac.*QDsp(QuadElem,:);
2629 
2630                                     <span class="comment">% add all tune and beta beating corrections for this one ID to the summed up correction vectors for all IDs</span>
2631                                     addQFsp = addQFsp+DelQF;
2632                                     addQDsp = addQDsp+DelQD;
2633 
2634                                 <span class="keyword">end</span>
2635 
2636                                 <span class="comment">% Set quadrupoles using main setpoint channels</span>
2637                                 setpv(<span class="string">'QF'</span>, QFsp+addQFsp,[], 0);
2638                                 setpv(<span class="string">'QD'</span>, QDsp+addQDsp,[], 0);
2639                                 <span class="comment">% % Set quadrupoles using FF setpoint channels</span>
2640                                 <span class="comment">% setpv('QF', 'FF', addQFsp, [], 0);</span>
2641                                 <span class="comment">% setpv('QD', 'FF', addQDsp, [], 0);</span>
2642                             <span class="keyword">end</span>
2643 
2644                         <span class="keyword">else</span>
2645                             error(<span class="string">'Unknown type selected for tune FF'</span>);
2646                         <span class="keyword">end</span>
2647 
2648                     <span class="keyword">else</span>
2649                         disp(<span class="string">'  No tune FF algorithm for non-production modes yet...'</span>);
2650                     <span class="keyword">end</span>
2651                 <span class="keyword">end</span>
2652 
2653                 ffdeltaquad_delay = toc;
2654                 <span class="comment">%fprintf('tune FF delay = %.1f seconds\n',ffdeltaquad_delay);</span>
2655                 <span class="comment">% fprintf('Tune Done: %f \n',gettime-t00);</span>
2656 
2657                 <span class="comment">% Output info to screen</span>
2658                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = %.4f mm'</span>,STDx),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2659                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = %.4f mm'</span>,STDy),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2660                 <span class="comment">%pause(0);</span>
2661 
2662                 FOFBStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2663                     getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2664                     getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2665                     getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2666                 <span class="keyword">for</span> loop = 1:size(FOFBStatus,2)
2667                     <span class="keyword">if</span> FOFBStatus(loop)==0
2668                         FOFBStatusStr(loop,:) = <span class="string">'OFF '</span>;
2669                     <span class="keyword">elseif</span> FOFBStatus(loop)==1
2670                         FOFBStatusStr(loop,:) = <span class="string">'ON  '</span>;
2671                     <span class="keyword">elseif</span> FOFBStatus(loop)==2
2672                         FOFBStatusStr(loop,:) = <span class="string">'OPEN'</span>;
2673                     <span class="keyword">else</span>
2674                         FOFBStatusStr(loop,:) = <span class="string">'BAD '</span>;
2675                     <span class="keyword">end</span>
2676                 <span class="keyword">end</span>
2677                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 %s'</span>,FOFBStatusStr(1,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2678                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 %s'</span>,FOFBStatusStr(2,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2679                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 %s'</span>,FOFBStatusStr(3,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2680                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 %s'</span>,FOFBStatusStr(4,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2681                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 %s'</span>,FOFBStatusStr(5,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2682                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 %s'</span>,FOFBStatusStr(6,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2683                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 %s'</span>,FOFBStatusStr(7,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2684                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 %s'</span>,FOFBStatusStr(8,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2685                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 %s'</span>,FOFBStatusStr(9,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2686                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 %s'</span>,FOFBStatusStr(10,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2687                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 %s'</span>,FOFBStatusStr(11,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2688                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 %s'</span>,FOFBStatusStr(12,:)),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2689 
2690 
2691                 <span class="comment">%fprintf('End of feedback operations: %f \n\n',gettime-t00);</span>
2692 
2693                 <span class="comment">% Wait for next update time or stop request</span>
2694                 <span class="keyword">while</span> (gettime-t00) &lt; LoopDelay
2695                     <span class="comment">%disp('interval could be shorter')</span>
2696                     pause(.05);
2697                     <span class="comment">% Check if GUI has been closed</span>
2698                     <span class="keyword">if</span> isempty(gcbf)
2699                         FEEDBACK_STOP_FLAG = 1;
2700                         lasterr(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2701                         error(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2702                     <span class="keyword">end</span>
2703 
2704                     <span class="comment">% Check if Stop button was pressed</span>
2705                     <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2706                         <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2707                         <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2708                             disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2709                         <span class="keyword">end</span>
2710                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2711                         pause(0.5);
2712                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2713                         <span class="keyword">break</span>;
2714                     <span class="keyword">end</span>
2715                 <span class="keyword">end</span>
2716 
2717 
2718                 <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2719                     <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2720                     <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2721                         disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2722                     <span class="keyword">end</span>
2723                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2724                     pause(0.5);
2725                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2726                     <span class="keyword">break</span>;
2727                 <span class="keyword">end</span>
2728 
2729                 StartErrorTime = gettime;
2730 
2731             <span class="keyword">catch</span>
2732 
2733                 fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
2734 
2735                 <span class="comment">% Quit if error exists for more than 20 seconds</span>
2736                 <span class="keyword">if</span> gettime-StartErrorTime&gt;20 | FEEDBACK_STOP_FLAG==1
2737                     fprintf(<span class="string">'%s  Orbit feedback stopped due to error condition. \n\n'</span>,datestr(now));
2738 
2739                     <span class="comment">%send alphapage to operator pager</span>
2740                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2741                     FEEDBACK_STOP_FLAG = 1;
2742 
2743                     setpv(<span class="string">'SR_STATE'</span>, -5);
2744                     [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2745                     <span class="keyword">if</span> StateNumber &gt;= 0
2746                         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2747                     <span class="keyword">else</span>
2748                         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2749                     <span class="keyword">end</span>
2750                 <span class="keyword">else</span>
2751                     a = clock;
2752                     fprintf(<span class="string">'   Orbit feedback was paused due to error condition (%s %d:%d:%.0f). \n'</span>, date, a(4), a(5), a(6));
2753                     fprintf(<span class="string">'   Orbit feedback has automatically restarted and is running. \n\n'</span>);
2754                 <span class="keyword">end</span>
2755 
2756             <span class="keyword">end</span>
2757 
2758             <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2759                 <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2760                 <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2761                     disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2762                 <span class="keyword">end</span>
2763                 setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2764                 pause(0.5);
2765                 setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2766                 <span class="keyword">break</span>;
2767             <span class="keyword">end</span>
2768 
2769             <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2770 
2771             <span class="comment">%pause(0);</span>
2772 
2773             <span class="comment">% this loop delays turn on of Fast Feedback system</span>
2774             <span class="keyword">if</span> FBloopIter &lt; 5
2775                 FBloopIter = FBloopIter + 1;
2776             <span class="keyword">end</span>
2777 
2778         <span class="keyword">end</span>  <span class="comment">% End of feedback loop</span>
2779 
2780 
2781         <span class="comment">% End feedback, reset all parameters</span>
2782         <span class="keyword">try</span>
2783 
2784             <span class="comment">% Enable buttons</span>
2785             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2786             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2787             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2788             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2789             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2790             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2791             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2792             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2793             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2794             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2795             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2796             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2797             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2798 
2799             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = _____ mm'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2800             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = _____ mm'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2801 
2802             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB01'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'01 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2803             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB02'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'02 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2804             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB03'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'03 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2805             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB04'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'04 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2806             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB05'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'05 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2807             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB06'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'06 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2808             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB07'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'07 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2809             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB08'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'08 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2810             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB09'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'09 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2811             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB10'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'10 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2812             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB11'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'11 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2813             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextFOFB12'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'12 ____'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2814 
2815             <span class="comment">%pause(0);</span>
2816 
2817         <span class="keyword">catch</span>
2818 
2819             <span class="comment">% GUI must have been closed</span>
2820 
2821         <span class="keyword">end</span>
2822 
2823 
2824         <span class="comment">% Reset Bergoz BPM time constant to whatever it was before feedback started</span>
2825         fprintf(<span class="string">'   Bergoz BPM time constant set back to %.1f\n'</span>, BPMtimeconstantOFB);
2826         <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(BPMtimeconstantOFB);
2827 
2828 
2829         a = clock;
2830         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2831         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2832         <span class="keyword">if</span> StateNumber &gt;= 0
2833             setpv(<span class="string">'SR_STATE'</span>,5.1);
2834             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2835             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2836             fprintf(<span class="string">'   ******************************\n'</span>);
2837             fprintf(<span class="string">'   **  Orbit Feedback Stopped  **\n'</span>);
2838             fprintf(<span class="string">'   ******************************\n\n'</span>);
2839         <span class="keyword">else</span>
2840             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2841             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2842             fprintf(<span class="string">'   ****************************************\n'</span>);
2843             fprintf(<span class="string">'   **  Problem With Slow Orbit Feedback  **\n'</span>);
2844             fprintf(<span class="string">'   ****************************************\n\n'</span>);
2845         <span class="keyword">end</span>
2846         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
2847         pause(0);
2848 
2849 
2850     <span class="keyword">case</span> <span class="string">'FeedbackSetup'</span>
2851         InitFlag = Input2;           <span class="comment">% Input #2: if InitFlag, then initialize variables</span>
2852 
2853         <span class="keyword">if</span> InitFlag
2854             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2855             <span class="comment">% Edit the following lists to change default configuration of Orbit Correction %</span>
2856             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2857 
2858             <span class="comment">% Corrector magnets</span>
2859             listh=[
2860                 1 2;
2861                 1 8;
2862                 2 1;
2863                 2 8;
2864                 3 1;
2865                 3 8;
2866                 3 10; <span class="comment">%SR04U_HCM2 (chicane trim)</span>
2867                 4 1;
2868                 4 8;
2869                 5 1;
2870                 5 8;
2871                 5 10; <span class="comment">%SR06U_HCM2 (chicane trim)</span>
2872                 6 1;
2873                 6 8;
2874                 7 1;
2875                 7 8;
2876                 8 1;
2877                 8 8;
2878                 9 1;
2879                 9 8;
2880                 10 1;
2881                 10 8;
2882                 10 10; <span class="comment">%SR11U_HCM2 (chicane trim)</span>
2883                 11 1;
2884                 11 8;
2885                 12 1;
2886                 12 7];
2887             listv=[
2888                 1 2;
2889                 1 8;
2890                 2 1;
2891                 2 8;
2892                 3 1;
2893                 3 7;
2894                 3 8;
2895                 3 10; <span class="comment">%SR04U_VHCM2 (chicane trim)</span>
2896                 4 1;
2897                 4 7;
2898                 4 8;
2899                 5 1;
2900                 5 8;
2901                 5 10; <span class="comment">%SR06U_VHCM2 (chicane trim)</span>
2902                 6 1;
2903                 6 8;
2904                 7 1;
2905                 7 8;
2906                 8 1;
2907                 8 8;
2908                 9 1;
2909                 9 8;
2910                 10 1;
2911                 10 2;
2912                 10 7;
2913                 10 8;
2914                 10 10; <span class="comment">%SR11U_VHCM2 (chicane trim)</span>
2915                 11 1;
2916                 11 7;
2917                 11 8;
2918                 12 1;
2919                 12 7];
2920 
2921             Xivec = [1:28];
2922             Yivec = [1:31];
2923             HCMlist1 = listh;
2924             VCMlist1 = listv;
2925 
2926             <span class="comment">% Full BPM list</span>
2927             BPMlist1 = [
2928                 1 2
2929                 1 5
2930                 1 6
2931                 1 10
2932                 2 1
2933                 2 5
2934                 2 6
2935                 2 9
2936                 3 2
2937                 3 5
2938                 3 6
2939                 3 10
2940                 3 11
2941                 3 12
2942                 4 1
2943                 4 5
2944                 4 6
2945                 4 10
2946                 5 1
2947                 5 5
2948                 5 6
2949                 5 10
2950                 5 11
2951                 5 12
2952                 6 1
2953                 6 5
2954                 6 6
2955                 6 10
2956                 7 1
2957                 7 5
2958                 7 6
2959                 7 10
2960                 8 1
2961                 8 5
2962                 8 6
2963                 8 10
2964                 9 1
2965                 9 5
2966                 9 6
2967                 9 10
2968                 10 1
2969                 10 5
2970                 10 6
2971                 10 10
2972                 10 11
2973                 10 12
2974                 11 1
2975                 11 5
2976                 11 6
2977                 11 10
2978                 12 1
2979                 12 5
2980                 12 6
2981                 12 9
2982                 ];
2983 
2984             <span class="comment">% remove Bergoz BPMs in SR01 and SR03 for 2-bunch (noisy at low currents) and drop singular values</span>
2985             <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
2986                     BPMlist1 = [
2987                          <span class="comment">%1 2</span>
2988                          1 5
2989                          1 6
2990                          1 10
2991                          2 1
2992                          2 5
2993                          2 6
2994                          <span class="comment">%2 9</span>
2995                          <span class="comment">%3 2</span>
2996                          3 5
2997                          3 6
2998                          3 10
2999                          3 11
3000                          3 12
3001                          4 1
3002                          4 5
3003                          4 6
3004                          4 10
3005                          5 1
3006                          5 5
3007                          5 6
3008                          5 10
3009                          5 11
3010                          5 12
3011                          6 1
3012                          6 5
3013                          6 6
3014                          6 10
3015                          7 1
3016                          7 5
3017                          7 6
3018                          7 10
3019                          8 1
3020                          8 5
3021                          8 6
3022                          8 10
3023                          9 1
3024                          9 5
3025                          9 6
3026                          9 10
3027                          10 1
3028                          10 5
3029                          10 6
3030                          10 10
3031                          10 11
3032                          10 12
3033                          11 1
3034                          11 5
3035                          11 6
3036                          11 10
3037                          12 1
3038                          12 5
3039                          12 6
3040                          <span class="comment">%12 9</span>
3041                          ];
3042             <span class="keyword">end</span>
3043 
3044             OCSx.BPM = getx(BPMlist1, <span class="string">'struct'</span>);
3045             OCSx.CM = getsp(<span class="string">'HCM'</span>, HCMlist1, <span class="string">'struct'</span>);
3046             OCSx.GoalOrbit = getgolden(OCSx.BPM, <span class="string">'numeric'</span>);
3047             OCSx.NIter = 1;
3048             OCSx.SVDIndex = Xivec;
3049             OCSx.IncrementalFlag = <span class="string">'No'</span>;
3050             OCSx.BPMWeight = {[]};
3051             OCSx.FitRF = 0;
3052             OCSy.BPM = gety(BPMlist1, <span class="string">'struct'</span>);
3053             OCSy.CM = getsp(<span class="string">'VCM'</span>, VCMlist1, <span class="string">'struct'</span>);
3054             OCSy.GoalOrbit = getgolden(OCSy.BPM, <span class="string">'numeric'</span>);
3055             OCSy.NIter = 1;
3056             OCSy.SVDIndex = Yivec;
3057             OCSy.IncrementalFlag = <span class="string">'No'</span>;
3058             OCSy.BPMWeight = {[]};
3059             OCSy.FitRF = 0;
3060             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
3061             <span class="comment">% do we need these Smat calls? %</span>
3062             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
3063             SXmat = getrespmat(OCSx.BPM, OCSx.CM, <span class="string">'numeric'</span>);
3064             SYmat = getrespmat(OCSy.BPM, OCSy.CM, <span class="string">'numeric'</span>);
3065             <span class="comment">% [OCSx, Sx, Ux, Vx] = orbitcorrectionmethods(OCSx, SXmat);</span>
3066             <span class="comment">% [OCSy, Sy, Uy, Vy] = orbitcorrectionmethods(OCSy, SYmat);</span>
3067 
3068             <span class="comment">% initialize FFTypeFlag</span>
3069             FFTypeFlag = <span class="string">'Global'</span>;
3070 
3071         <span class="keyword">else</span>
3072 
3073             <span class="comment">% Get vectors</span>
3074             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
3075             <span class="comment">% the two lines below seem to fix BPMlist editing problem</span>
3076             OCSx = FB.OCSx;
3077             OCSy = FB.OCSy;
3078             BPMlist1 = FB.BPMlist1;
3079             HCMlist1 = FB.HCMlist1;
3080             VCMlist1 = FB.VCMlist1;
3081             Xivec = FB.Xivec;
3082             Yivec = FB.Yivec;
3083             Xgoal = FB.OCSx.GoalOrbit;
3084             OCSx.GoalOrbit = Xgoal;
3085             Ygoal = FB.OCSy.GoalOrbit;
3086             OCSy.GoalOrbit = Ygoal;
3087             FFTypeFlag = FB.FFTypeFlag;
3088 
3089 
3090             <span class="comment">% FF corrector magnet list</span>
3091             ListFF = [
3092                 4     2
3093                 4     8
3094                 5     1
3095                 5     7
3096 <span class="comment">%               5     8 % why are these out???</span>
3097 <span class="comment">%               6     1 % why are these out???</span>
3098                 6     8
3099                 7     1
3100                 7     8
3101                 8     1
3102                 8     8
3103                 9     1
3104                 9     8
3105                 10    1
3106                 11    8
3107                 12    1];
3108             ElemFF = dev2elem(<span class="string">'HCM'</span>,ListFF);
3109 
3110 
3111             <span class="comment">% Add button to change #ivectors, cm, IDBPMs,</span>
3112             EditFlag = 0;
3113             h_fig1 = figure;
3114             <span class="keyword">while</span> EditFlag ~= 6
3115 
3116                 Sx = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
3117                 Sy = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
3118                 
3119                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
3120                     DispOrbit = getdisp(<span class="string">'BPMx'</span>, BPMlist1);
3121                     Sx = [Sx DispOrbit];
3122                 <span class="keyword">end</span>
3123                 
3124                 [Ux, SVx, Vx] = svd(Sx);
3125                 [Uy, SVy, Vy] = svd(Sy);
3126 
3127                 
3128                 <span class="comment">% Remove singular values greater than the actual number of singular values</span>
3129                 i = find(Xivec&gt;length(diag(SVx)));
3130                 <span class="keyword">if</span> ~isempty(i)
3131                     disp(<span class="string">'   Horizontal E-vector scaled since there were more elements in the vector than singular values.'</span>);
3132                     pause(0);
3133                     Xivec(i) = [];
3134                 <span class="keyword">end</span>
3135                 i = find(Yivec&gt;length(diag(SVy)));
3136                 <span class="keyword">if</span> ~isempty(i)
3137                     disp(<span class="string">'   Vertical E-vector scaled since there were more elements in the vector than singular values.'</span>);
3138                     pause(0);
3139                     Yivec(i) = [];
3140                 <span class="keyword">end</span>
3141 
3142 
3143                 Ax = Sx*Vx(:,Xivec);
3144                 Tx = inv(Ax'*Ax)*Ax';
3145 
3146                 Ay = Sy*Vy(:,Yivec);
3147                 Ty = inv(Ay'*Ay)*Ay';
3148 
3149                 figure(h_fig1);
3150                 subplot(2,1,1);
3151                 semilogy(diag(SVx),<span class="string">'b'</span>);
3152                 hold on;
3153                 semilogy(diag(SVx(Xivec,Xivec)),<span class="string">'xr'</span>);
3154                 ylabel(<span class="string">'Horizontal'</span>);
3155                 title(<span class="string">'Response Matrix Singular Values'</span>);
3156                 hold off;
3157                 subplot(2,1,2);
3158                 semilogy(diag(SVy),<span class="string">'b'</span>);
3159                 hold on;
3160                 semilogy(diag(SVy(Yivec,Yivec)),<span class="string">'xr'</span>);
3161                 xlabel(<span class="string">'Singular Value Number'</span>);
3162                 ylabel(<span class="string">'Vertical'</span>);
3163                 hold off;
3164                 drawnow;
3165 
3166                 EditFlag = menu(<span class="string">'Change Parameters?'</span>,<span class="string">'Singular Values'</span>,<span class="string">'HCM List'</span>,<span class="string">'VCM List'</span>, <span class="keyword">...</span>
3167                     <span class="string">'BPM List'</span>,<span class="string">'Change the Goal Orbit'</span>,<span class="string">'Continue'</span>);
3168 
3169                 <span class="keyword">if</span> EditFlag == 1
3170                     prompt={<span class="string">'Enter the horizontal E-vector numbers (Matlab vector format):'</span>,<span class="string">'Enter the vertical E-vector numbers (Matlab vector format):'</span>};
3171                     def={sprintf(<span class="string">'[%d:%d]'</span>,1,Xivec(end)),sprintf(<span class="string">'[%d:%d]'</span>,1,Yivec(end))};
3172                     titlestr=<span class="string">'SVD Orbit Feedback'</span>;
3173                     lineNo=1;
3174                     answer=inputdlg(prompt,titlestr,lineNo,def);
3175                     <span class="keyword">if</span> ~isempty(answer)
3176                         XivecNew = fix(str2num(answer{1}));
3177                         <span class="keyword">if</span> isempty(XivecNew)
3178                             disp(<span class="string">'   Horizontal E-vector cannot be empty.  No change made.'</span>);
3179                         <span class="keyword">else</span>
3180                             <span class="keyword">if</span> any(XivecNew&lt;=0) | max(XivecNew)&gt;length(diag(SVx))
3181                                 disp(<span class="string">'   Error reading horizontal E-vector.  No change made.'</span>);
3182                             <span class="keyword">else</span>
3183                                 Xivec = XivecNew;
3184                             <span class="keyword">end</span>
3185                         <span class="keyword">end</span>
3186                         YivecNew = fix(str2num(answer{2}));
3187                         <span class="keyword">if</span> isempty(YivecNew)
3188                             disp(<span class="string">'   Vertical E-vector cannot be empty.  No change made.'</span>);
3189                         <span class="keyword">else</span>
3190                             <span class="keyword">if</span> any(YivecNew&lt;=0) | max(YivecNew)&gt;length(diag(SVy))
3191                                 disp(<span class="string">'   Error reading vertical E-vector.  No change made.'</span>);
3192                             <span class="keyword">else</span>
3193                                 Yivec = YivecNew;
3194                             <span class="keyword">end</span>
3195                         <span class="keyword">end</span>
3196                     <span class="keyword">end</span>
3197                 <span class="keyword">end</span>
3198 
3199                 <span class="keyword">if</span> EditFlag == 2
3200                     List= getlist(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>);
3201                     CheckList = zeros(96,1);
3202                     Elem = dev2elem(<span class="string">'HCM'</span>, HCMlist1);
3203                     CheckList(Elem) = ones(size(Elem));
3204                     CheckList = CheckList(dev2elem(<span class="string">'HCM'</span>,List));
3205 
3206                     <span class="comment">% Remove FF corrrectors</span>
3207                     <span class="comment">%           Elem = dev2elem('HCM',List);</span>
3208                     <span class="comment">%           for j = length(ElemFF):-1:1</span>
3209                     <span class="comment">%              i = find(Elem==ElemFF(j));</span>
3210                     <span class="comment">%              Elem(i,:) = [];</span>
3211                     <span class="comment">%              List(i,:) = [];</span>
3212                     <span class="comment">%              CheckList(i,:) = [];</span>
3213                     <span class="comment">%           end</span>
3214 
3215                     newList = editlist(List, <span class="string">'HCMtrim'</span>, CheckList);
3216 
3217                     <span class="keyword">if</span> isempty(newList)
3218                         fprintf(<span class="string">'   WARNING: Horizontal corrector magnet list is empty!\n'</span>);
3219                         HCMlist1 = newList;
3220                     <span class="keyword">else</span>
3221                         HCMlist1 = newList;
3222                     <span class="keyword">end</span>
3223                     OCSx.CM.DeviceList = HCMlist1;
3224                 <span class="keyword">end</span>
3225 
3226                 <span class="keyword">if</span> EditFlag == 3
3227                     List = getlist(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>);
3228                     CheckList = zeros(96,1);
3229                     Elem = dev2elem(<span class="string">'VCM'</span>, VCMlist1);
3230                     CheckList(Elem) = ones(size(Elem));
3231                     CheckList = CheckList(dev2elem(<span class="string">'VCM'</span>,List));
3232 
3233                     <span class="comment">% Remove FF corrrectors</span>
3234                     <span class="comment">%           Elem = dev2elem('VCM',List);</span>
3235                     <span class="comment">%           for j = length(ElemFF):-1:1</span>
3236                     <span class="comment">%              i = find(Elem==ElemFF(j));</span>
3237                     <span class="comment">%              Elem(i,:) = [];</span>
3238                     <span class="comment">%              List(i,:) = [];</span>
3239                     <span class="comment">%              CheckList(i,:) = [];</span>
3240                     <span class="comment">%           end</span>
3241 
3242                     newList = editlist(List, <span class="string">'VCMtrim'</span>, CheckList);
3243 
3244                     <span class="keyword">if</span> isempty(newList)
3245                         fprintf(<span class="string">'   WARNING: Vertical corrector magnet list is empty!\n'</span>);
3246                         VCMlist1 = newList;
3247                     <span class="keyword">else</span>
3248                         VCMlist1 = newList;
3249                     <span class="keyword">end</span>
3250                     OCSy.CM.DeviceList = VCMlist1;
3251                 <span class="keyword">end</span>
3252 
3253                 <span class="keyword">if</span> EditFlag == 4
3254                     ListOld = BPMlist1;
3255                     XgoalOld = Xgoal;
3256                     YgoalOld = Ygoal;
3257 
3258                     <span class="comment">% Full BPM list</span>
3259                     List = [
3260                         1 2
3261                         1 5
3262                         1 6
3263                         1 10
3264                         2 1
3265                         2 5
3266                         2 6
3267                         2 9
3268                         3 2
3269                         3 5
3270                         3 6
3271                         3 10
3272                         3 11
3273                         3 12
3274                         4 1
3275                         4 5
3276                         4 6
3277                         4 10
3278                         5 1
3279                         5 5
3280                         5 6
3281                         5 10
3282                         5 11
3283                         5 12
3284                         6 1
3285                         6 5
3286                         6 6
3287                         6 10
3288                         7 1
3289                         7 5
3290                         7 6
3291                         7 10
3292                         8 1
3293                         8 5
3294                         8 6
3295                         8 10
3296                         9 1
3297                         9 5
3298                         9 6
3299                         9 10
3300                         10 1
3301                         10 5
3302                         10 6
3303                         10 10
3304                         10 11
3305                         10 12
3306                         11 1
3307                         11 5
3308                         11 6
3309                         11 10
3310                         12 1
3311                         12 5
3312                         12 6
3313                         12 9
3314                         ];
3315 
3316 
3317                     CheckList = zeros(size(List,1),1);
3318                     <span class="keyword">if</span> ~isempty(BPMlist1)
3319                         <span class="keyword">for</span> i = 1:size(List,1)
3320                             k = find(List(i,1)==BPMlist1(:,1));
3321                             l = find(List(i,2)==BPMlist1(k,2));
3322 
3323                             <span class="keyword">if</span> isempty(k) | isempty(l)
3324                                 <span class="comment">% Item not in list</span>
3325                             <span class="keyword">else</span>
3326                                 CheckList(i) = 1;
3327                             <span class="keyword">end</span>
3328                         <span class="keyword">end</span>
3329                     <span class="keyword">end</span>
3330 
3331                     newList = editlist(List, <span class="string">'BPM'</span>, CheckList);
3332                     <span class="keyword">if</span> isempty(newList)
3333                         fprintf(<span class="string">'   BPM list cannot be empty.  No change made.\n'</span>);
3334                     <span class="keyword">else</span>
3335                         BPMlist1 = newList;
3336                     <span class="keyword">end</span>
3337 
3338                     <span class="comment">% Set the goal orbit to the golden orbit</span>
3339                     Xgoal = getgolden(<span class="string">'BPMx'</span>, BPMlist1);
3340                     Ygoal = getgolden(<span class="string">'BPMy'</span>, BPMlist1);
3341 
3342 
3343                     <span class="comment">% If a new BPM is added, then set the goal orbit to the golden orbit</span>
3344                     <span class="keyword">for</span> i = 1:size(BPMlist1,1)
3345 
3346                         <span class="comment">% Is it a new BPM?</span>
3347                         k = find(BPMlist1(i,1)==ListOld(:,1));
3348                         l = find(BPMlist1(i,2)==ListOld(k,2));
3349 
3350                         <span class="keyword">if</span> isempty(k) | isempty(l)
3351                             <span class="comment">% New BPM</span>
3352                         <span class="keyword">else</span>
3353                             <span class="comment">% Use the old value for old BPM</span>
3354                             Xgoal(i) = XgoalOld(k(l));
3355                             Ygoal(i) = YgoalOld(k(l));
3356                         <span class="keyword">end</span>
3357                     <span class="keyword">end</span>
3358                     OCSx.BPM.DeviceList = BPMlist1;
3359                     OCSy.BPM.DeviceList = BPMlist1;
3360                     OCSx.GoalOrbit = Xgoal;
3361                     OCSy.GoalOrbit = Ygoal;
3362                 <span class="keyword">end</span>
3363 
3364                 <span class="keyword">if</span> EditFlag == 5
3365                     ChangeList = editlist2(BPMlist1, <span class="string">'Change BPM'</span>, zeros(size(BPMlist1,1),1));
3366 
3367                     <span class="keyword">for</span> i = 1:size(ChangeList,1)
3368 
3369                         k = find(ChangeList(i,1)==BPMlist1(:,1));
3370                         l = find(ChangeList(i,2)==BPMlist1(k,2));
3371 
3372                         prompt={sprintf(<span class="string">'Enter the new horizontal goal orbit for BPMx(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2)),sprintf(<span class="string">'Enter the new vertical goal orbit for BPMy(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2))};
3373                         def={sprintf(<span class="string">'%f'</span>,Xgoal(k(l))),sprintf(<span class="string">'%f'</span>,Ygoal(k(l)))};
3374                         titlestr=<span class="string">'CHANGE THE GOAL ORBIT'</span>;
3375                         lineNo=1;
3376                         answer = inputdlg(prompt, titlestr, lineNo, def);
3377 
3378                         <span class="keyword">if</span> isempty(answer)
3379                             <span class="comment">% No change</span>
3380                             fprintf(<span class="string">'   No change was made to the golden orbit.\n'</span>);
3381                         <span class="keyword">else</span>
3382                             Xgoalnew = str2num(answer{1});
3383                             <span class="keyword">if</span> isempty(Xgoalnew)
3384                                 fprintf(<span class="string">'   No change was made to the horizontal golden orbit.\n'</span>);
3385                             <span class="keyword">else</span>
3386                                 Xgoal(k(l)) = Xgoalnew;
3387                             <span class="keyword">end</span>
3388 
3389                             Ygoalnew = str2num(answer{2});
3390                             <span class="keyword">if</span> isempty(Ygoalnew)
3391                                 fprintf(<span class="string">'   No change was made to the vertical golden orbit.\n'</span>);
3392                             <span class="keyword">else</span>
3393                                 Ygoal(k(l)) = Ygoalnew;
3394                             <span class="keyword">end</span>
3395                         <span class="keyword">end</span>
3396                     <span class="keyword">end</span>
3397                     <span class="keyword">if</span> ~isempty(ChangeList)
3398                         fprintf(<span class="string">'   Note:  Changing the goal orbit for &quot;Slow Orbit Feedback&quot; does not change the goal orbit for &quot;Orbit Correction.&quot;\n'</span>);
3399                         fprintf(<span class="string">'          Re-running srcontrol will restart the goal orbit to the golden orbit.&quot;\n'</span>);
3400                     <span class="keyword">end</span>
3401                     OCSx.GoalOrbit = Xgoal;
3402                     OCSy.GoalOrbit = Ygoal;
3403                 <span class="keyword">end</span>
3404 
3405 <span class="comment">%                 if EditFlag == 6</span>
3406 <span class="comment">%                     FFTypeFlag = questdlg(sprintf('Do you want to use a fully local or a combined local/global compensation of IDs? (nuy=9.2 only)'),'Tune FF','Local','Global', 'Global');</span>
3407 <span class="comment">%                     if strcmp(FFTypeFlag,'Local')</span>
3408 <span class="comment">%                         disp(['   The tune FF will use 8 local quadrupoles to compensate beta beating and tune shift']);</span>
3409 <span class="comment">%                         disp(['   from each ID.']);</span>
3410 <span class="comment">%                     elseif strcmp(FFTypeFlag,'Global')</span>
3411 <span class="comment">%                         disp(['   The tune FF will use 4 local quadrupoles to compensate beta beating and all QF+QD']);</span>
3412 <span class="comment">%                         disp(['   to compensate tune shift from each ID.']);</span>
3413 <span class="comment">%                     end</span>
3414 <span class="comment">%                 end</span>
3415 
3416             <span class="keyword">end</span>
3417             close(h_fig1);
3418         <span class="keyword">end</span>
3419 
3420         <span class="comment">% Save vectors</span>
3421         FB.Xivec = Xivec;
3422         FB.Yivec = Yivec;
3423         FB.HCMlist1 = HCMlist1;
3424         FB.VCMlist1 = VCMlist1;
3425         FB.BPMlist1 = BPMlist1;
3426 
3427         OCSx.SVDIndex = Xivec;
3428         OCSy.SVDIndex = Yivec;
3429         FB.OCSx = OCSx;
3430         FB.OCSy = OCSy;
3431 
3432         FB.FFTypeFlag = FFTypeFlag;
3433         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>,FB);
3434 
3435 
3436     <span class="keyword">case</span> <span class="string">'FastFeedbackSetup'</span>
3437 
3438         InitFlag = Input2;
3439 
3440         <span class="keyword">if</span> InitFlag
3441             FOFBFreq = 1000;
3442             <span class="comment">% user operations 9/14-10/17/04: P=0.5, I=120, D=0.0015 (for both planes)</span>
3443             <span class="comment">% below are known good values for user ops as of 8-1-05</span>
3444             HorP = 2;
3445             HorI = 300;
3446             HorD = 0.002;
3447             VertP = 1;
3448             VertI = 100;
3449             VertD = 0.0015;
3450 
3451             <span class="comment">% this initial set is now done in hwinit.m because it's not a good idea to set anything when srcontrol is launched</span>
3452             <span class="comment">% try</span>
3453             <span class="comment">%     setsp('SR01____FFBFREQAC00', FOFBFreq); % set freq</span>
3454             <span class="comment">%     write_pid_ffb2_patch(HorP, HorI, HorD, VertP, VertI, VertD);</span>
3455             <span class="comment">% catch</span>
3456             <span class="comment">%     disp('   Trouble setting Fast Orbit Feedback parameters!');</span>
3457             <span class="comment">% end</span>
3458 
3459         <span class="keyword">else</span>
3460             <span class="comment">% Get vectors</span>
3461             FOFB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
3462             FOFBFreq = FOFB.FOFBFreq;
3463             HorP  = FOFB.HorP;
3464             HorI  = FOFB.HorI;
3465             HorD  = FOFB.HorD;
3466             VertP = FOFB.VertP;
3467             VertI = FOFB.VertI;
3468             VertD = FOFB.VertD;
3469 
3470             <span class="comment">% Add button to change #ivectors, CMs, IDBPMs,</span>
3471             EditFlag = 0;
3472             <span class="comment">%h_fig1 = figure;</span>
3473             <span class="keyword">while</span> EditFlag ~= 3
3474 
3475                 <span class="comment">%EditFlag = menu('Change Parameters?', 'Fast Feedback Frequency', 'PID Values', 'HCM List', 'VCM List', ...</span>
3476                 <span class="comment">%   'IDBPM List', 'BBPM List', 'Continue');</span>
3477                 <span class="comment">% Use menu below until other FFB config routines work (then also uncomment options 3,4,5,6 below)</span>
3478                 EditFlag = menu(<span class="string">'Change Parameters?'</span>, <span class="string">'Fast Feedback Frequency'</span>, <span class="string">'PID Values'</span>, <span class="string">'Continue'</span>);
3479 
3480                 <span class="keyword">if</span> EditFlag == 1
3481                     <span class="comment">% change rate</span>
3482 
3483                     prompt={<span class="string">'Enter the desired Fast Feedback Frequency (1-1000 Hz)'</span>};
3484                     def={num2str(FOFBFreq)};
3485                     titlestr=<span class="string">'Fast Feedback Setup'</span>;
3486                     lineNo=1;
3487                     answer=inputdlg(prompt,titlestr,lineNo,def);
3488                     <span class="keyword">if</span> ~isempty(answer)
3489                         FOFBFreq = fix(str2num(answer{1}));
3490                         <span class="keyword">if</span> isempty(FOFBFreq)
3491                             disp(<span class="string">'   Frequency value cannot be empty.  No change made.'</span>);
3492                             FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3493                         <span class="keyword">else</span>
3494                             <span class="keyword">if</span> FOFBFreq &lt; 1 | FOFBFreq &gt; 1000
3495                                 disp(<span class="string">'   Frequency must be between 1 and 1000 Hz.  No change made.'</span>);
3496                                 FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3497                             <span class="keyword">end</span>
3498                         <span class="keyword">end</span>
3499                         setsp(<span class="string">'SR01____FFBFREQAC00'</span>,FOFBFreq   ); <span class="comment">% change freq</span>
3500                         pause(0.5);
3501                         fprintf(<span class="string">'   Fast orbit feedback frequency is running at %.0f Hz.\n'</span>, getpv(<span class="string">'SR01____FFBFREQAM00'</span>));
3502                     <span class="keyword">else</span>
3503                         FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3504                     <span class="keyword">end</span>
3505                 <span class="keyword">end</span>
3506 
3507                 <span class="keyword">if</span> EditFlag == 2
3508                     <span class="comment">% edit  PIDs</span>
3509                     <span class="comment">% User defaults are HorP=2, HorI=300, HorD=0.002, VertP=1, VertI=100, VertD=0.0015</span>
3510                     prompt={<span class="string">'P horizontal'</span>, <span class="string">'I horizontal'</span>, <span class="string">'D horizontal'</span>, <span class="string">'P vertical'</span>, <span class="string">'I vertical'</span>, <span class="string">'D vertical'</span>};
3511                     def={num2str(HorP), num2str(HorI), num2str(HorD), num2str(VertP), num2str(VertI), num2str(VertD)};
3512                     titlestr=<span class="string">'Fast Feedback PID Setup'</span>;
3513                     lineNo=1;
3514                     answer=inputdlg(prompt,titlestr,lineNo,def);
3515                     <span class="keyword">if</span> ~isempty(answer)
3516                         HorPnewnum = str2num(answer{1});
3517                         <span class="keyword">if</span> isempty(HorPnewnum)
3518                             disp(<span class="string">'   HorP value cannot be empty.  No change made.'</span>);
3519                         <span class="keyword">else</span>
3520                             HorP = HorPnewnum;
3521                         <span class="keyword">end</span>
3522                         HorInewnum = str2num(answer{2});
3523                         <span class="keyword">if</span> isempty(HorInewnum)
3524                             disp(<span class="string">'   HorI value cannot be empty.  No change made.'</span>);
3525                         <span class="keyword">else</span>
3526                             HorI = HorInewnum;
3527                         <span class="keyword">end</span>
3528                         HorDnewnum = str2num(answer{3});
3529                         <span class="keyword">if</span> isempty(HorDnewnum)
3530                             disp(<span class="string">'   HorD value cannot be empty.  No change made.'</span>);
3531                         <span class="keyword">else</span>
3532                             HorD = HorDnewnum;
3533                         <span class="keyword">end</span>
3534                         VertPnewnum = str2num(answer{4});
3535                         <span class="keyword">if</span> isempty(VertPnewnum)
3536                             disp(<span class="string">'   VertP value cannot be empty.  No change made.'</span>);
3537                         <span class="keyword">else</span>
3538                             VertP = VertPnewnum;
3539                         <span class="keyword">end</span>
3540                         VertInewnum = str2num(answer{5});
3541                         <span class="keyword">if</span> isempty(VertInewnum)
3542                             disp(<span class="string">'   VertI value cannot be empty.  No change made.'</span>);
3543                         <span class="keyword">else</span>
3544                             VertI = VertInewnum;
3545                         <span class="keyword">end</span>
3546                         VertDnewnum = str2num(answer{6});
3547                         <span class="keyword">if</span> isempty(VertDnewnum)
3548                             disp(<span class="string">'   VertD value cannot be empty.  No change made.'</span>);
3549                         <span class="keyword">else</span>
3550                             VertD = VertDnewnum;
3551                         <span class="keyword">end</span>
3552 
3553                         <span class="keyword">try</span>
3554                             write_pid_ffb2_patch(HorP, HorI, HorD, VertP, VertI, VertD);
3555                             fprintf(<span class="string">'   Setting FFB gains to Horizontal P=%.2f, I=%.1f, D=%.4f;  Vertical P=%.2f, I=%.1f, D=%.4f\n'</span>, HorP, HorI, HorD, VertP, VertI, VertD);
3556                         <span class="keyword">catch</span>
3557                             disp(<span class="string">'   Trouble setting Fast Orbit Feedback parameters!'</span>);
3558                         <span class="keyword">end</span>
3559                     <span class="keyword">end</span>
3560                 <span class="keyword">end</span>
3561 
3562                 <span class="comment">%if EditFlag == 3</span>
3563                 <span class="comment">%   disp('   This function not yet available.');</span>
3564                 <span class="comment">%   % change HCM List</span>
3565                 <span class="comment">%end</span>
3566                 <span class="comment">%</span>
3567                 <span class="comment">%if EditFlag == 4</span>
3568                 <span class="comment">%   disp('   This function not yet available.');</span>
3569                 <span class="comment">%   % change VCM List</span>
3570                 <span class="comment">%end</span>
3571                 <span class="comment">%</span>
3572                 <span class="comment">%if EditFlag == 5</span>
3573                 <span class="comment">%   disp('   This function not yet available.');</span>
3574                 <span class="comment">%   % change IDBPM List</span>
3575                 <span class="comment">%end</span>
3576                 <span class="comment">%</span>
3577                 <span class="comment">%if EditFlag == 6</span>
3578                 <span class="comment">%   disp('   This function not yet available.');</span>
3579                 <span class="comment">%   % change BBPM List</span>
3580                 <span class="comment">%end</span>
3581 
3582             <span class="keyword">end</span>
3583             <span class="comment">%close(h_fig1);</span>
3584         <span class="keyword">end</span>
3585 
3586         <span class="comment">% Save vectors</span>
3587         FOFB.FOFBFreq = FOFBFreq;
3588         FOFB.HorP = HorP;
3589         FOFB.HorI = HorI;
3590         FOFB.HorD = HorD;
3591         FOFB.VertP = VertP;
3592         FOFB.VertI = VertI;
3593         FOFB.VertD = VertD;
3594         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Userdata'</span>,FOFB);
3595 
3596     <span class="keyword">otherwise</span>
3597         fprintf(<span class="string">'   No action for %s.\n'</span>, action);
3598 <span class="keyword">end</span>   <span class="comment">% end case</span></pre></div>
<hr><address>Generated on Thu 02-Aug-2007 13:16:07 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>