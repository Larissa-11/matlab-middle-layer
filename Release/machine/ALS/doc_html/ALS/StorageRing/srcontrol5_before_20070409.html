<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of srcontrol5_before_20070409</title>
  <meta name="keywords" content="srcontrol5_before_20070409">
  <meta name="description" content="srcontrol5">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="#">ALS</a> &gt; <a href="index.html">StorageRing</a> &gt; srcontrol5_before_20070409.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for ALS\StorageRing&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>srcontrol5_before_20070409
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>srcontrol5</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function srcontrol5(action, Input2, Input3) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> srcontrol5
 Storage ring control program

 This program controls all storage ring magnets, performs orbit feedback and
 tune feedforward and helps to diagnose problems in routine user operation
 of the ALS storage ring. It includes a gui to simplify the use of this
 program.

 It was originally programmed by Greg Portmann (until December 2000) with input
 from Winfried Decking, David Robin, Christoph Steier, Ying Wu and others
 and is currently (July 2002) maintained by Christoph Steier and Tom Scarvie.

 The actual version of this program is srcontrol5 (is called by default if you call srcontrol).

 Christoph Steier, July 2002

 SRCONTROL5 is the newest versionof SRCONTROL, edited to work with G. Portmann's new (2005) Matlab middle layer.

 Tom Scarvie, April 2005</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>	BEND2GEV - Compute the energy based on the ramp tables</li><li><a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>	CHECKSRMAGS - Check SR power supplies against a lattice file</li><li><a href="checksrorbit.html" class="code" title="function ErrorNums = checksrorbit(SectorList, BPMxtol,BPMytol)">checksrorbit</a>	ErrorNums =checksrorbit(Sector, BPMxtolerance [.015 mm], [BPMytolerance [.015 mm]])</li><li><a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>	GAP2TUNE - Computes the vertical tune shift for a insertion device gap change.</li><li><a href="gaplimit.html" class="code" title="function [GAPmin, GAPmax] = gaplimit(Dev);">gaplimit</a>	[GapMin, GapMax] = gaplimit(ID_Number);</li><li><a href="getff.html" class="code" title="function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)">getff</a>	function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)</li><li><a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>	GETID - Get the insertion device position, velocity, run flag, and user requested gap</li><li><a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>	[StateNumber, StateString] = getsrstate</li><li><a href="set_alarmhandler_AHU_thresholds_inject.html" class="code" title="function set_alarmhandler_AHU_thresholds_inject">set_alarmhandler_AHU_thresholds_inject</a>	function set_alarmhandler_AHU_thresholds_inject</li><li><a href="set_alarmhandler_thresholds.html" class="code" title="function set_alarmhandler_thresholds">set_alarmhandler_thresholds</a>	set_alarmhandler_thresholds</li><li><a href="set_alarmhandler_thresholds_new.html" class="code" title="function set_alarmhandler_thresholds_new">set_alarmhandler_thresholds_new</a>	set_alarmhandler_thresholds_new</li><li><a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>	SETBPMTIMECONSTANT - Sets the timeconstants for the Bergoz style BPMs.</li><li><a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>	SETBUMPS - Make a straight section bump</li><li><a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>	function setff(Sector, FFEnableBC, GapEnableBC)</li><li><a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>	SETID - Set the insertion device vertical gap</li><li><a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>	</li><li><a href="srcycle.html" class="code" title="function FailFlag = srcycle(varargin)">srcycle</a>	SRCYCLE - Storage ring cycle</li><li><a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>	SRRAMP - Ramp the storage ring energy</li><li><a href="write_goldenorbit_ffb.html" class="code" title="function write_goldenorbit_ffb">write_goldenorbit_ffb</a>	function write_goldenorbit_ffb</li><li><a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>	WRITE_GOLDENORBIT_FFTB_2PLANES - Sets the BPM setpoints which are used by the fast feedback system</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function srcontrol5(action, Input2, Input3)</a>
0002 <span class="comment">% srcontrol5</span>
0003 <span class="comment">% Storage ring control program</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% This program controls all storage ring magnets, performs orbit feedback and</span>
0006 <span class="comment">% tune feedforward and helps to diagnose problems in routine user operation</span>
0007 <span class="comment">% of the ALS storage ring. It includes a gui to simplify the use of this</span>
0008 <span class="comment">% program.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% It was originally programmed by Greg Portmann (until December 2000) with input</span>
0011 <span class="comment">% from Winfried Decking, David Robin, Christoph Steier, Ying Wu and others</span>
0012 <span class="comment">% and is currently (July 2002) maintained by Christoph Steier and Tom Scarvie.</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% The actual version of this program is srcontrol5 (is called by default if you call srcontrol).</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% Christoph Steier, July 2002</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% SRCONTROL5 is the newest versionof SRCONTROL, edited to work with G. Portmann's new (2005) Matlab middle layer.</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% Tom Scarvie, April 2005</span>
0021 
0022 <span class="comment">% known bugs/problems (May 2001):</span>
0023 <span class="comment">% - IDBPM averaging might be a bit too long for orbit feedback</span>
0024 <span class="comment">%        solved after Superbend shutdown ... Instead of averaging, digital low pass filters are used</span>
0025 <span class="comment">% - gap2tune does not give correct answers for wiggler and potentially other IDs -&gt; orbit feedback</span>
0026 <span class="comment">%        seems to be OK for other IDs, has been corrected for wiggler (fit to insertion device</span>
0027 <span class="comment">%        compensation table)</span>
0028 <span class="comment">% - chicanes do not work in orbit feedback</span>
0029 <span class="comment">%        solved. One problem was that orbit response matrizes were mis-scaled by factor of two.</span>
0030 <span class="comment">%        Second problem was different time constant of power supply control. Solved by moving controls</span>
0031 <span class="comment">%        of center chicanes to cPCI (and magnets are fast, hysteresis free, aircore coils).</span>
0032 <span class="comment">%        Center chicane in sector 4 is now routinely used in orbit feedback. Sector 11 to follow soon.</span>
0033 <span class="comment">% - zero reading of ID gap dumps beam</span>
0034 <span class="comment">%        solved in srcontrol5, still a problem in srcontrol5_hightune (but that routine has to be completely</span>
0035 <span class="comment">%        rewritten because of all recent changes to srcontrol5, anyhow). For gap readings below the minimum</span>
0036 <span class="comment">%        allowed gap for a device, the tune feedforward disables itself.</span>
0037 <span class="comment">% - cycling of lattice causes frequent power supply failures</span>
0038 <span class="comment">%        solved by changing the cycling procedure. 1.5 GeV operation is now on the upper hysteresis branch</span>
0039 <span class="comment">%        as was the 1.9 GeV injection lattice before.</span>
0040 <span class="comment">% - frequently stalled data in IDBPM readout</span>
0041 <span class="comment">%        solved with new BPM readouts and digital filtering. Seems to have been a resolution problem</span>
0042 <span class="comment">%        of the digital averaging algorithm.</span>
0043 <span class="comment">% - magnet ramp tables are not in perfect agreement with magnetic measurements</span>
0044 <span class="comment">%        Does not appear to be a serious problem. Superbends are slightly out of sync with other magnets,</span>
0045 <span class="comment">%        but this does not cause any negative effects while ramping.</span>
0046 <span class="comment">% - no good way to operate with injection at 1.5 GeV and storage energy below that</span>
0047 <span class="comment">%        There now is a reasonable way to inject at 1.5 GeV and ramp down to lower storage energy. But</span>
0048 <span class="comment">%        it has to be tested again after implementing new (and more) chicanes ...</span>
0049 
0050 <span class="comment">% revision history</span>
0051 <span class="comment">% 2001-05-10, Christoph Steier</span>
0052 <span class="comment">% check whether readback from insertion device is significantly (more than 1 mm) below minimum</span>
0053 <span class="comment">% gap, to avoid false zero readings of insertion device gaps to cause the tune feed forward</span>
0054 <span class="comment">% to implement false huge correction (and dump the beam). If the insertion device gap readbacks</span>
0055 <span class="comment">% gets more than 1 mm below the nominal minimum gap, the routine now assumes the insertion device</span>
0056 <span class="comment">% to be open.</span>
0057 <span class="comment">%</span>
0058 <span class="comment">% 2001-08-30 and during Superbend commissioning, Christoph Steier, Tom Scarvie, Winni Decking</span>
0059 <span class="comment">% various changes have been made to incorporate the Superbends and some other new equipment</span>
0060 <span class="comment">% installed in the Superbend shutdown. This included some changes to programs being called by srcontrol</span>
0061 <span class="comment">% (like srload, srsave, srcycle, srramp, ...). The main changes within srcontrol were in the orbit</span>
0062 <span class="comment">% correction and slow orbit feedback routines (incorporating frequency feedback, ...)</span>
0063 <span class="comment">%</span>
0064 <span class="comment">% 2002-05-04, Christoph Steier</span>
0065 <span class="comment">% added new IDBPMs, modified orbit feedback to use trim DACs, removed LSB toggling in vertical</span>
0066 <span class="comment">% orbit feedback, ...</span>
0067 <span class="comment">%</span>
0068 
0069 <span class="comment">% 2002-07-29, T.Scarvie</span>
0070 <span class="comment">% added check of CM trim currents to warn of problems that might rail the orbit feedback</span>
0071 <span class="comment">%</span>
0072 <span class="comment">% 2002-07-31, Christoph Steier</span>
0073 <span class="comment">% increased the gain of the RF frequency feedback from 1/50 of the gain of the horizontal</span>
0074 <span class="comment">% orbit feedback to 1/20. Reason was that the frequency feedback was reacting a bit too slow if all</span>
0075 <span class="comment">% insertion device gaps are closed at once at high speed at the beginning of a fill.</span>
0076 <span class="comment">%</span>
0077 <span class="comment">% 2002-08-05, C.Steier, T.Scarvie</span>
0078 <span class="comment">% Added conditional to reduce orbit feedback gain if running in two-bunch mode</span>
0079 <span class="comment">%</span>
0080 <span class="comment">% 2003-06-02, T.Scarvie</span>
0081 <span class="comment">% Added loop inside orbit feedback to reset the SR11 chicane M1 and M2 motors every 20s to combat drift problem</span>
0082 <span class="comment">%</span>
0083 <span class="comment">% 2003-06-18, C. Steier</span>
0084 <span class="comment">% Disabled loop to periodically reset chicane in SR11. Al Robb replaced power supply, seems to be no problem anymore.</span>
0085 <span class="comment">%</span>
0086 <span class="comment">% 2004-05-10, C. Steier</span>
0087 <span class="comment">% The list of all BBPMs is now set up automatically be calling getlist('BBPMx'). This way, new BBPMs have to be added</span>
0088 <span class="comment">% at fewer places in the software. It should now be sufficient to modify getlist and run the orbit response matrix</span>
0089 <span class="comment">% rountine (getsmat) once to enable use of the new BBPMs.</span>
0090 <span class="comment">%</span>
0091 <span class="comment">% 2004-05-14, C. Steier</span>
0092 <span class="comment">% Modified parameters for ramprate reduction (in srramp and here). Previous parameters were slightly too</span>
0093 <span class="comment">% cautious. Increased initial slow ramprate to 0.4 A/s.</span>
0094 <span class="comment">%</span>
0095 <span class="comment">% 2004-05-14, C. Steier</span>
0096 <span class="comment">% Incorporated insertion device compensation schemes for nu_y = 9.2 lattice.</span>
0097 <span class="comment">%</span>
0098 <span class="comment">% 2004-06-14, T.Scarvie</span>
0099 <span class="comment">% Added controls for fast orbit feedback</span>
0100 <span class="comment">%</span>
0101 <span class="comment">% 2004-06-21, C. Steier</span>
0102 <span class="comment">% Added tune feedforward (in the global tune compensation scheme for the nu_y=9.2 lattice) for the shift</span>
0103 <span class="comment">% dependent tune shift of the EPUs, as well as a skew quadrupole feedforward for the EPU im sector 11</span>
0104 <span class="comment">% (both only active in parallel mode so far).</span>
0105 <span class="comment">%</span>
0106 <span class="comment">% 2005-02-13, T.Scarvie</span>
0107 <span class="comment">% Separated horizontal and vertical planes for setting Fast Feedback PIDs</span>
0108 
0109 
0110 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0111 <span class="comment">% NOTES for conversion to new Middle Layer %</span>
0112 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0113 <span class="comment">%</span>
0114 <span class="comment">% We never use the gap and bump control flags - the radio buttons have been disabled -</span>
0115 <span class="comment">%        should we try to keep the functionality?</span>
0116 <span class="comment">%</span>
0117 <span class="comment">% remove handle globals</span>
0118 <span class="comment">% set(0,'showhiddenhandles','on'); what does this do?</span>
0119 <span class="comment">% grampbsc -&gt; should be handled by new srramp (which uses k-values)</span>
0120 <span class="comment">% checksrmags</span>
0121 <span class="comment">% checksrorbit(...)</span>
0122 <span class="comment">% getdcct</span>
0123 <span class="comment">% setbpmtimeconstant</span>
0124 <span class="comment">% getsmatelements</span>
0125 <span class="comment">% Chicane trims are now part of the corrector family</span>
0126 <span class="comment">% getname('IDrunflag',...) family name change</span>
0127 <span class="comment">% write_goldenorbit_ffb, write_goldenorbit_ffb2</span>
0128 
0129 
0130 <span class="comment">% For the compiler</span>
0131 <span class="comment">%#function goldenpage</span>
0132 <span class="comment">%#function setoperationalmode</span>
0133 
0134 
0135 <span class="comment">% Check if the AO exists</span>
0136 checkforao;
0137 
0138 
0139 <span class="comment">%%%%%%%%%%%%%%</span>
0140 <span class="comment">% Initialize %</span>
0141 <span class="comment">%%%%%%%%%%%%%%</span>
0142 
0143 <span class="keyword">global</span> FEEDBACK_STOP_FLAG
0144 
0145 SR_Mode = getfamilydata(<span class="string">'OperationalMode'</span>);
0146 SR_GEV = getfamilydata(<span class="string">'Energy'</span>);
0147 
0148 BSCramprate = getfamilydata(<span class="string">'BSCRampRate'</span>);
0149 <span class="keyword">if</span> isnan(BSCramprate) | isempty(BSCramprate)
0150     BSCramprate = 0.4;
0151     setfamilydata(BSCramprate, <span class="string">'BSCRampRate'</span>);
0152 <span class="keyword">end</span>
0153 
0154 <span class="keyword">if</span> nargin &lt; 1
0155     action = <span class="string">'Initialize'</span>;
0156 <span class="keyword">end</span>
0157 <span class="keyword">if</span> nargin &lt; 2
0158     Input2 = 0;
0159 <span class="keyword">end</span>
0160 <span class="keyword">if</span> nargin &lt; 3
0161     Input3 = 0;
0162 <span class="keyword">end</span>
0163 
0164 <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
0165     FOFBcheckboxVal = 0;
0166 <span class="keyword">else</span>
0167     FOFBcheckboxVal = 1;
0168 <span class="keyword">end</span>
0169 
0170 
0171 <span class="comment">%%%%%%%%%%%%%%%%</span>
0172 <span class="comment">% Main Program %</span>
0173 <span class="comment">%%%%%%%%%%%%%%%%</span>
0174 
0175 <span class="keyword">switch</span>(action)
0176 
0177     <span class="keyword">case</span> <span class="string">'StopOrbitFeedback'</span>
0178 
0179         FEEDBACK_STOP_FLAG = 1;
0180 
0181     <span class="keyword">case</span> <span class="string">'Initialize'</span>
0182 
0183         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0184         <span class="comment">% GUI</span>
0185         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0186         ButtonWidth = 200;
0187         ButtonHeight  = 25;
0188 
0189         Offset1 = 8*25+12 + 47 + 25+25;
0190         Offset2 = 47+25+25;
0191         Offset3 = 45+25;
0192         Offset4 = 1;
0193         Offset5 = 30;
0194         FigWidth = ButtonWidth+6;
0195         FigHeight  = 3+7*(ButtonHeight+6)+24+Offset1;
0196         ButtonWidth = 200-6;
0197 
0198         <span class="comment">% Change figure position</span>
0199         set(0,<span class="string">'Units'</span>,<span class="string">'pixels'</span>);
0200         p=get(0,<span class="string">'screensize'</span>);
0201 
0202         h0 = figure( <span class="keyword">...</span>
0203             <span class="string">'Color'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0204             <span class="string">'HandleVisibility'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0205             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0206             <span class="string">'MenuBar'</span>,<span class="string">'none'</span>, <span class="keyword">...</span>
0207             <span class="string">'Name'</span>,<span class="string">'ALS SR CONTROL'</span>, <span class="keyword">...</span>
0208             <span class="string">'NumberTitle'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0209             <span class="string">'Units'</span>,<span class="string">'pixels'</span>, <span class="keyword">...</span>
0210             <span class="string">'Position'</span>,[30 p(4)-FigHeight-40 FigWidth FigHeight+Offset5], <span class="keyword">...</span>
0211             <span class="string">'Resize'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0212             <span class="string">'Tag'</span>,<span class="string">'SRCTRLFig1'</span>);
0213 
0214         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0215             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0216             <span class="string">'Callback'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0217             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0218             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0219             <span class="string">'FontWeight'</span>,<span class="string">'Bold'</span>, <span class="keyword">...</span>
0220             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0221             <span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>, <span class="keyword">...</span>
0222             <span class="string">'Position'</span>,[6 3+6*(ButtonHeight+3)+19+19+8+Offset1  ButtonWidth 20+Offset5], <span class="keyword">...</span>
0223             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0224             <span class="string">'String'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0225             <span class="string">'Tag'</span>,<span class="string">'SRCTRLTitle'</span>);
0226 
0227         <span class="comment">% Frame Box I</span>
0228         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0229             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0230             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0231             <span class="string">'Position'</span>,[3 3+1*(ButtonHeight+3)+Offset1-3+Offset5 ButtonWidth+6 7*ButtonHeight+18], <span class="keyword">...</span>
0232             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0233 
0234         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0235             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0236             <span class="string">'Callback'</span>,<span class="string">''</span>, <span class="keyword">...</span>
0237             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0238             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0239             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0240             <span class="string">'HorizontalAlignment'</span>,<span class="string">'Center'</span>, <span class="keyword">...</span>
0241             <span class="string">'Position'</span>,[6 3+7*(ButtonHeight+3)+Offset1  ButtonWidth 15+Offset5], <span class="keyword">...</span>
0242             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0243             <span class="string">'String'</span>,<span class="string">'Lattice Setup Functions'</span>);
0244 
0245         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0246             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Cycle'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0247             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0248             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0249             <span class="string">'Position'</span>,[6 3+6*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0250             <span class="string">'String'</span>,<span class="string">'Cycle SR Lattice'</span>, <span class="keyword">...</span>
0251             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>);
0252 
0253         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0254             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Injection'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0255             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0256             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0257             <span class="string">'Position'</span>,[6 3+5*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0258             <span class="string">'String'</span>,<span class="string">'Injection'</span>, <span class="keyword">...</span>
0259             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>);
0260 
0261         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0262             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs'');srcontrol5(''Production'',get(findobj(gcbf,''Tag'',''SRCTRLRadioGaps''),''Value''),get(findobj(gcbf,''Tag'',''SRCTRLRadioBumps''),''Value''));'</span>, <span class="keyword">...</span>
0263             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0264             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0265             <span class="string">'Position'</span>,[6 3+4*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0266             <span class="string">'String'</span>,[<span class="string">'Production'</span>], <span class="keyword">...</span>
0267             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>);
0268 
0269         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0270             <span class="string">'Callback'</span>,[<span class="keyword">...</span>
0271             <span class="string">'fprintf(''\n'');'</span> <span class="keyword">...</span>
0272             <span class="string">'disp([''   **********************************************'']);'</span>, <span class="keyword">...</span>
0273             <span class="string">'disp([''   **  Changing Storage Ring Operational Mode  **'']);'</span>, <span class="keyword">...</span>
0274             <span class="string">'disp([''   **********************************************'']);'</span>, <span class="keyword">...</span>
0275             <span class="string">'setoperationalmode;'</span>, <span class="keyword">...</span>
0276             <span class="string">'srcontrol5(''CheckInputs'');'</span>, <span class="keyword">...</span>
0277             <span class="string">'disp([''   ****************************'']);'</span>, <span class="keyword">...</span>
0278             <span class="string">'disp([''   **  Mode Change Complete  **'']);'</span>, <span class="keyword">...</span>
0279             <span class="string">'disp([''   ****************************'']);'</span>, <span class="keyword">...</span>
0280             <span class="string">'fprintf(''\n'');'</span>], <span class="keyword">...</span>
0281             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0282             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0283             <span class="string">'Position'</span>,[6 3+3*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0284             <span class="string">'Value'</span>,1, <span class="keyword">...</span>
0285             <span class="string">'String'</span>,<span class="string">'Change Operational Mode'</span>, <span class="keyword">...</span>
0286             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>);
0287 
0288         h1 = uicontrol(<span class="keyword">...</span>
0289             <span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0290             <span class="string">'Callback'</span>, [<span class="keyword">...</span>
0291             <span class="string">'srcontrol5(''CheckInputs'');'</span>,<span class="keyword">...</span>
0292             <span class="string">'srcontrol5(''SRState'');'</span>], <span class="keyword">...</span>
0293             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0294             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0295             <span class="string">'Position'</span>,[6 3+2*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0296             <span class="string">'String'</span>,<span class="string">'Check For Problems'</span>, <span class="keyword">...</span>
0297             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>);
0298 
0299         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0300             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''CheckInputs''); goldenpage;'</span>, <span class="keyword">...</span>
0301             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0302             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0303             <span class="string">'Position'</span>,[6 3+1*(ButtonHeight+3)+Offset1+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0304             <span class="string">'String'</span>,<span class="string">'Golden Page'</span>, <span class="keyword">...</span>
0305             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>);
0306 
0307 
0308         <span class="comment">% Frame Box II</span>
0309         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0310             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0311             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0312             <span class="string">'Position'</span>,[3 3+7*(ButtonHeight+3)-29+Offset2+Offset5 ButtonWidth+6 2*ButtonHeight+15], <span class="keyword">...</span>
0313             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0314         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0315             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0316             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0317             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0318             <span class="string">'Position'</span>,[6 3+8*(ButtonHeight+3)-10+Offset2 ButtonWidth .6*ButtonHeight+Offset5], <span class="keyword">...</span>
0319             <span class="string">'String'</span>,<span class="string">'Global/Local Orbit Correction'</span>, <span class="keyword">...</span>
0320             <span class="string">'Style'</span>,<span class="string">'text'</span>);
0321         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0322             <span class="string">'Callback'</span>,<span class="string">'srcontrol5(''OrbitCorrection'');'</span>, <span class="keyword">...</span>
0323             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0324             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0325             <span class="string">'Position'</span>,[6 3+7*(ButtonHeight+3)-6+Offset2+Offset5 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0326             <span class="string">'String'</span>,<span class="string">'Correct Global Orbit w/ IDBPMs'</span>, <span class="keyword">...</span>
0327             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>);
0328         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0329             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''OrbitCorrectionSetup'',1);'</span>, <span class="keyword">...</span>
0330             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''OrbitCorrectionSetup'',0);'</span>, <span class="keyword">...</span>
0331             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0332             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0333             <span class="string">'Position'</span>,[6 7*(ButtonHeight+3)-22+Offset2+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0334             <span class="string">'String'</span>,<span class="string">'Edit IDBPM, CM, &amp; Local Bump Lists'</span>, <span class="keyword">...</span>
0335             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0336             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0337             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>);
0338 
0339 
0340         <span class="comment">% Frame Box III</span>
0341         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0342             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0343             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0344             <span class="string">'Position'</span>,[3 1.25*(ButtonHeight)+Offset3-45+Offset5 ButtonWidth+6 8*ButtonHeight+5], <span class="keyword">...</span>
0345             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0346         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0347             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0348             <span class="string">'FontSize'</span>,10, <span class="keyword">...</span>
0349             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0350             <span class="string">'Position'</span>,[6 3+7*(ButtonHeight+3)+Offset3-25 ButtonWidth .55*ButtonHeight+Offset5], <span class="keyword">...</span>
0351             <span class="string">'String'</span>,<span class="string">'Orbit Feedback'</span>, <span class="keyword">...</span>
0352             <span class="string">'Style'</span>,<span class="string">'text'</span>);
0353 
0354         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0355             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0356             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0357             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0358             <span class="string">'Position'</span>,[26 3+6*(ButtonHeight+3)+Offset3-18+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0359             <span class="string">'String'</span>,<span class="string">'Slow Orbit Correction'</span>, <span class="keyword">...</span>
0360             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0361             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0362             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxSOFB'</span>);
0363         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0364             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0365             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0366             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0367             <span class="string">'Position'</span>,[26 3+5*(ButtonHeight+3)+Offset3-9+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0368             <span class="string">'String'</span>,<span class="string">'Fast Orbit Correction'</span>, <span class="keyword">...</span>
0369             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0370             <span class="string">'Value'</span>,FOFBcheckboxVal,<span class="keyword">...</span>
0371             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxFOFB'</span>);
0372 
0373         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0374             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0375             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0376             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0377             <span class="string">'Position'</span>,[26 3+4*(ButtonHeight+3)+Offset3+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0378             <span class="string">'String'</span>,<span class="string">'Correct ID Tune Shift  '</span>, <span class="keyword">...</span>
0379             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0380             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0381             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxTune'</span>);
0382 
0383         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0384             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0385             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0386             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0387             <span class="string">'Position'</span>,[26 3+3*(ButtonHeight+3)+Offset3+9+Offset5 ButtonWidth-32 .8*ButtonHeight], <span class="keyword">...</span>
0388             <span class="string">'String'</span>,<span class="string">'Correct RF Frequency'</span>, <span class="keyword">...</span>
0389             <span class="string">'Style'</span>,<span class="string">'checkbox'</span>, <span class="keyword">...</span>
0390             <span class="string">'Value'</span>,1,<span class="keyword">...</span>
0391             <span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>);
0392 
0393         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0394             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''Feedback'');'</span>, <span class="keyword">...</span>
0395             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0396             <span class="string">'FontSize'</span>,12, <span class="keyword">...</span>
0397             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0398             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0399             <span class="string">'Position'</span>,[8 3+3*(ButtonHeight+3)+3+Offset3-25+Offset5 .5*ButtonWidth-6 1.0*ButtonHeight], <span class="keyword">...</span>
0400             <span class="string">'String'</span>,<span class="string">'Start FB'</span>, <span class="keyword">...</span>
0401             <span class="string">'Value'</span>,0, <span class="keyword">...</span>
0402             <span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>);
0403         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0404             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''StopOrbitFeedback'');pause(0);'</span>, <span class="keyword">...</span>
0405             <span class="string">'Enable'</span>,<span class="string">'off'</span>, <span class="keyword">...</span>
0406             <span class="string">'FontSize'</span>,12, <span class="keyword">...</span>
0407             <span class="string">'Interruptible'</span>, <span class="string">'on'</span>, <span class="keyword">...</span>
0408             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0409             <span class="string">'Position'</span>,[.5*FigWidth+3 3+3*(ButtonHeight+3)+3+Offset3-25+Offset5 .5*ButtonWidth-6 1.0*ButtonHeight], <span class="keyword">...</span>
0410             <span class="string">'String'</span>,<span class="string">'Stop FB'</span>, <span class="keyword">...</span>
0411             <span class="string">'Value'</span>,0, <span class="keyword">...</span>
0412             <span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>);
0413 
0414         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0415             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0416             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0417             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0418             <span class="string">'Position'</span>,[14 3+2*(ButtonHeight)+14+Offset3-25+Offset5 ButtonWidth-14 .75*ButtonHeight], <span class="keyword">...</span>
0419             <span class="string">'String'</span>,<span class="string">'Horizontal RMS = _____ mm'</span>, <span class="keyword">...</span>
0420             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0421             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>);
0422         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0423             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0424             <span class="string">'HorizontalAlignment'</span>,<span class="string">'left'</span>, <span class="keyword">...</span>
0425             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0426             <span class="string">'Position'</span>,[26 3+1.25*(ButtonHeight)+16+Offset3-25+Offset5 ButtonWidth-26 .75*ButtonHeight], <span class="keyword">...</span>
0427             <span class="string">'String'</span>,<span class="string">'Vertical RMS = _____ mm'</span>, <span class="keyword">...</span>
0428             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0429             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>);
0430 
0431         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0432             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''FeedbackSetup'',1);'</span>, <span class="keyword">...</span>
0433             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''FeedbackSetup'',0);'</span>, <span class="keyword">...</span>
0434             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0435             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0436             <span class="string">'Position'</span>,[8 3+1.25*(ButtonHeight)+.5+Offset3-25+Offset5 ButtonWidth-5 .75*ButtonHeight], <span class="keyword">...</span>
0437             <span class="string">'String'</span>,<span class="string">'Edit SOFB Setup'</span>, <span class="keyword">...</span>
0438             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0439             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0440             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>);
0441 
0442         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0443             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''FastFeedbackSetup'',1);'</span>, <span class="keyword">...</span>
0444             <span class="string">'callback'</span>,<span class="string">'srcontrol5(''FastFeedbackSetup'',0);'</span>, <span class="keyword">...</span>
0445             <span class="string">'Enable'</span>,<span class="string">'on'</span>, <span class="keyword">...</span>
0446             <span class="string">'Interruptible'</span>, <span class="string">'off'</span>, <span class="keyword">...</span>
0447             <span class="string">'Position'</span>,[8 3+1.25*(ButtonHeight)+.5+Offset3-45+Offset5 ButtonWidth-5 .75*ButtonHeight], <span class="keyword">...</span>
0448             <span class="string">'String'</span>,<span class="string">'Edit FOFB Setup'</span>, <span class="keyword">...</span>
0449             <span class="string">'Style'</span>,<span class="string">'PushButton'</span>, <span class="keyword">...</span>
0450             <span class="string">'Value'</span>,0,<span class="keyword">...</span>
0451             <span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>);
0452 
0453         <span class="comment">% Frame Box IV</span>
0454         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0455             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0456             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0457             <span class="string">'Position'</span>,[3 3+ButtonHeight+Offset4-14+Offset5 ButtonWidth+6 ButtonHeight+12], <span class="keyword">...</span>
0458             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0459         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0460             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0461             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0462             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0463             <span class="string">'Position'</span>,[6 3+1.75*ButtonHeight+5+Offset4-21+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0464             <span class="string">'String'</span>,<span class="string">'Storage Ring State'</span>, <span class="keyword">...</span>
0465             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0466             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHeader'</span>);
0467         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0468             <span class="string">'CreateFcn'</span>,<span class="string">'srcontrol5(''CheckInputs'');'</span>, <span class="keyword">...</span>
0469             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0470             <span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>, <span class="keyword">...</span>
0471             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0472             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0473             <span class="string">'Position'</span>,[6 3+ButtonHeight+6+3+2+Offset4-22+Offset5 ButtonWidth .7*ButtonHeight], <span class="keyword">...</span>
0474             <span class="string">'String'</span>,<span class="string">'   '</span>, <span class="keyword">...</span>
0475             <span class="string">'Style'</span>,<span class="string">'text'</span>, <span class="keyword">...</span>
0476             <span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>);
0477 
0478 
0479         <span class="comment">% Frame Box &quot;Close&quot;</span>
0480         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0481             <span class="string">'BackgroundColor'</span>,[0.8 0.8 0.8], <span class="keyword">...</span>
0482             <span class="string">'ListboxTop'</span>,0, <span class="keyword">...</span>
0483             <span class="string">'Position'</span>,[3 8 ButtonWidth+6 ButtonHeight+8], <span class="keyword">...</span>
0484             <span class="string">'Style'</span>,<span class="string">'frame'</span>);
0485         h1 = uicontrol(<span class="string">'Parent'</span>,h0, <span class="keyword">...</span>
0486             <span class="string">'Callback'</span>,<span class="string">'close(gcbf);'</span>, <span class="keyword">...</span>
0487             <span class="string">'Enable'</span>,<span class="string">'On'</span>, <span class="keyword">...</span>
0488             <span class="string">'Interruptible'</span>,<span class="string">'Off'</span>, <span class="keyword">...</span>
0489             <span class="string">'Position'</span>,[6 13 ButtonWidth ButtonHeight], <span class="keyword">...</span>
0490             <span class="string">'String'</span>,<span class="string">'Close'</span>, <span class="keyword">...</span>
0491             <span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>);
0492 
0493 
0494         <span class="comment">% Update database channels</span>
0495         <a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>;
0496 
0497         <span class="keyword">if</span> nargout &gt; 0
0498             fig = h0;
0499         <span class="keyword">end</span>
0500 
0501 
0502     <span class="keyword">case</span> <span class="string">'Cycle'</span>
0503         GapFlag = Input2;
0504         BumpMagnetFlag = Input3;
0505 
0506         fprintf(<span class="string">'\n'</span>);
0507         disp(<span class="string">'   **************************'</span>);
0508         disp(<span class="string">'   **  Storage Ring Cycle  **'</span>);
0509         disp(<span class="string">'   **************************'</span>);
0510         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
0511 
0512         BSCFlag = questdlg(sprintf(<span class="string">'Cycle Superbend Magnets?'</span>),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0513         <span class="comment">%if strcmp(BSCFlag,'No')</span>
0514         <span class="comment">%    disp(['   ** Superbends will not be cycled. **']);</span>
0515         <span class="comment">%else</span>
0516         <span class="comment">%    disp(['   ** Superbends will be cycled during the second mini-cycle only. **']);</span>
0517         <span class="comment">%end</span>
0518 
0519         ChicSQFlag = questdlg(sprintf(<span class="string">'Cycle chicanes and skew quads and home motor chicanes?'</span>),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0520         <span class="comment">%if strcmp(ChicSQFlag,'No')</span>
0521         <span class="comment">%    disp(['   ** Chicanes and skew quads will not be cycled; motor chicanes will not be homed. **']);</span>
0522         <span class="comment">%else</span>
0523         <span class="comment">%    disp(['   ** Chicanes and skew quads will be cycled; motor chicanes will be homed. **']);</span>
0524         <span class="comment">%end</span>
0525 
0526 
0527         StartFlag = questdlg(sprintf(<span class="string">'Start %.1f GeV Cycle?'</span>,SR_GEV),<span class="string">'SR Cycle'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0528         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
0529             disp([<span class="string">'   ***************************'</span>]);
0530             disp([<span class="string">'   **    Cycle  Canceled    **'</span>]);
0531             disp([<span class="string">'   ***************************'</span>]);
0532             fprintf(<span class="string">'\n'</span>);
0533             <span class="keyword">return</span>
0534         <span class="keyword">end</span>
0535 
0536         <span class="keyword">try</span>
0537             <span class="keyword">if</span> GapFlag
0538                 <span class="comment">% Make sure that the gaps are open with FF off</span>
0539                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0540                     <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0541                     disp(<span class="string">'   Insertion device gaps are not open.'</span>);
0542                     disp(<span class="string">'   Opening all gaps at maximum speed.'</span>);
0543                     <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0544                     disp(<span class="string">'   Gap control disabled.'</span>);
0545                     disp(<span class="string">'   Feed forward enabled.'</span>);
0546                     pause(1);
0547                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0548                     disp(<span class="string">'   Gaps opened.'</span>);
0549                     disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0550                     a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0551                 <span class="keyword">else</span>
0552                     disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0553                 <span class="keyword">end</span>
0554             <span class="keyword">else</span>
0555                 disp(<span class="string">'   Feed forward and gap control disabled.'</span>);
0556             <span class="keyword">end</span>
0557 
0558             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0559             pause(1);
0560             
0561             <a href="srcycle.html" class="code" title="function FailFlag = srcycle(varargin)">srcycle</a>(BSCFlag, ChicSQFlag);
0562 
0563             setpv(<span class="string">'SR_STATE'</span>,1);
0564 
0565         <span class="keyword">catch</span>
0566 
0567             fprintf(<span class="string">'   %s \n'</span>,lasterr);
0568             fprintf(<span class="string">'   Cycle failed due to error condition! \n\n'</span>);
0569             setpv(<span class="string">'SR_STATE'</span>,-1);
0570             
0571         <span class="keyword">end</span>
0572 
0573         date;
0574         a = clock;
0575         datestr1=date;
0576         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0577         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0578         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0579         <span class="keyword">if</span> StateNumber &gt;= 0
0580             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0581             disp(<span class="string">'   **********************************************'</span>);
0582             disp(<span class="string">'   **  SR Cycle complete, ready for injection  **'</span>);
0583             disp(<span class="string">'   **********************************************'</span>); fprintf(<span class="string">'\n'</span>);
0584         <span class="keyword">else</span>
0585             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0586             disp(<span class="string">'   **********************************'</span>);
0587             disp(<span class="string">'   **  Problem cycling SR lattice  **'</span>);
0588             disp(<span class="string">'   **********************************'</span>); fprintf(<span class="string">'\n'</span>);
0589         <span class="keyword">end</span>
0590         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0591         
0592 
0593     <span class="keyword">case</span> <span class="string">'Injection'</span>
0594         AD = getad;
0595         GapFlag = Input2;
0596         BumpMagnetFlag = Input3;
0597 
0598         fprintf(<span class="string">'\n'</span>);
0599         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0600 
0601         <span class="keyword">if</span> abs(AD.Energy - AD.InjectionEnergy) &gt; .05
0602             fprintf(<span class="string">'   ***************************************************\n'</span>);
0603             fprintf(<span class="string">'   **  Setup For %.2f GeV Injection (with ramping)  **\n'</span>, getfamilydata(<span class="string">'InjectionEnergy'</span>));
0604             fprintf(<span class="string">'   ***************************************************\n'</span>);
0605             <a href="set_alarmhandler_AHU_thresholds_inject.html" class="code" title="function set_alarmhandler_AHU_thresholds_inject">set_alarmhandler_AHU_thresholds_inject</a>;
0606             StartFlag = questdlg(sprintf(<span class="string">'Start setup for injection, %.2f GeV?'</span>,getfamilydata(<span class="string">'InjectionEnergy'</span>)),<span class="string">'Injection Setup'</span>,<span class="string">'Ramp quickly'</span>,<span class="string">'Ramp slowly'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0607         <span class="keyword">else</span>
0608             fprintf(<span class="string">'   *************************************************\n'</span>);
0609             fprintf(<span class="string">'   **  Setup For On Energy Injection at %.2f GeV  **\n'</span>, SR_GEV);
0610             fprintf(<span class="string">'   *************************************************\n'</span>);
0611             StartFlag = questdlg(sprintf(<span class="string">'Start setup for injection, %.2f GeV?'</span>,SR_GEV),<span class="string">'Injection Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0612         <span class="keyword">end</span>
0613         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'Cancel'</span>)
0614             disp([<span class="string">'   ********************************'</span>]);
0615             disp([<span class="string">'   **  Injection Setup Canceled  **'</span>]);
0616             disp([<span class="string">'   ********************************'</span>]);
0617             <a href="set_alarmhandler_thresholds.html" class="code" title="function set_alarmhandler_thresholds">set_alarmhandler_thresholds</a>;
0618             fprintf(<span class="string">'\n'</span>);
0619             <span class="keyword">return</span>
0620         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp quickly'</span>)
0621             setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0622         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp slowly'</span>)
0623             setfamilydata(0.4, <span class="string">'BSCRampRate'</span>);
0624         <span class="keyword">end</span>
0625 
0626         <span class="keyword">try</span>
0627 
0628             <span class="keyword">if</span> GapFlag
0629                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([],1,0);
0630                 disp(<span class="string">'   Gap control disabled'</span>);
0631                 disp(<span class="string">'   Feed forward enabled'</span>);
0632                 pause(1);
0633 
0634                 <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0635                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0636                     disp(<span class="string">'   Opening all gaps'</span>);
0637                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0638                 <span class="keyword">end</span>
0639 
0640                 disp(<span class="string">'   Gaps are open'</span>);
0641                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0642                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0643             <span class="keyword">else</span>
0644                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0645             <span class="keyword">end</span>
0646 
0647             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0648             pause(1);
0649 
0650             <span class="keyword">if</span> (AD.Energy-AD.InjectionEnergy) &gt; 0.05
0651                 <span class="comment">% Ramp down to Injection Energy</span>
0652                 ErrorFlag = <a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>(<span class="string">'Injection'</span>);
0653                 <span class="keyword">if</span> ErrorFlag
0654                     error(<span class="string">'Superbends over temperature.'</span>);
0655                 <span class="keyword">end</span>
0656                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n\n'</span>,date, a(4), a(5), a(6));
0657 
0658             <span class="keyword">elseif</span> (AD.Energy-AD.InjectionEnergy) &lt; -0.05
0659 
0660                 <span class="comment">% first load injection lattice, then ramp to 1.9 GeV and back to 1.5 GeV to get onto same hysteresis branch</span>
0661 
0662                 srload(<span class="string">'Injection'</span>);
0663 
0664                 <span class="comment">% load 1.9 GeV lattice</span>
0665                 tempfilename = sprintf(<span class="string">'%s19nuy9prod.mat'</span>, getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>));
0666 
0667                 srload(tempfilename);
0668 
0669                 a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0670 
0671                 pause(5);
0672 
0673             <span class="keyword">end</span>
0674 
0675             srload(<span class="string">'Injection'</span>);
0676 
0677             setpv(<span class="string">'SR_STATE'</span>,2);
0678 
0679         <span class="keyword">catch</span>
0680 
0681             fprintf(<span class="string">'   %s \n'</span>,lasterr);
0682             fprintf(<span class="string">'   Injection lattice setup failed due to error condition! \n\n'</span>);
0683             setpv(<span class="string">'SR_STATE'</span>,-2);
0684 
0685         <span class="keyword">end</span>
0686 
0687 
0688         date;
0689         a = clock;
0690         datestr1=date;
0691         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0692         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0693         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0694         <span class="keyword">if</span> StateNumber &gt;= 0
0695             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0696             <span class="keyword">if</span> AD.Energy &lt;= 1.5
0697                 disp([<span class="string">'   *******************************************************************************'</span>]);
0698                 disp([<span class="string">'   **  Function complete:  the storage ring is setup for injection at '</span>,sprintf(<span class="string">'%.2f'</span>,SR_GEV),<span class="string">' GeV  **'</span>]);
0699                 disp([<span class="string">'   *******************************************************************************'</span>]); 
0700                 fprintf(<span class="string">'\n'</span>);
0701             <span class="keyword">else</span>
0702                 fprintf(<span class="string">'   **********************************************************************************************\n'</span>);
0703                 fprintf(<span class="string">'   **  Function complete:  the storage ring is setup for injection at %.2f GeV (upper branch)  **\n'</span>, getfamilydata(<span class="string">'InjectionEnergy'</span>));
0704                 fprintf(<span class="string">'   **********************************************************************************************\n'</span>); 
0705                 fprintf(<span class="string">'\n'</span>);
0706             <span class="keyword">end</span>
0707         <span class="keyword">else</span>
0708             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0709             disp([<span class="string">'   ************************************'</span>]);
0710             disp([<span class="string">'   **  Problem with injection setup  **'</span>]);
0711             disp([<span class="string">'   ************************************'</span>]); 
0712             fprintf(<span class="string">'\n'</span>);
0713         <span class="keyword">end</span>
0714         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0715 
0716         <span class="comment">%soundchord;</span>
0717 
0718         setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0719 
0720 
0721     <span class="keyword">case</span> <span class="string">'Production'</span>
0722         GapFlag = Input2;
0723         BumpMagnetFlag = Input3;
0724         AD=getad;
0725         
0726         fprintf(<span class="string">'\n'</span>);
0727         a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0728 
0729         <span class="keyword">if</span> abs(AD.Energy - AD.InjectionEnergy) &gt; .05
0730             disp(<span class="string">'   ********************************************************'</span>);
0731             disp(sprintf(<span class="string">'   **  Setup For %.2f GeV User Operation (with ramping)  **'</span>,SR_GEV));
0732             disp(<span class="string">'   ********************************************************'</span>);
0733             StartFlag = questdlg(sprintf(<span class="string">'Start setup for users, %.1f GeV?'</span>,SR_GEV),<span class="string">'User Setup'</span>,<span class="string">'Ramp quickly'</span>,<span class="string">'Ramp slowly'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0734         <span class="keyword">else</span>
0735             disp(<span class="string">'   *****************************************'</span>);
0736             disp(sprintf(<span class="string">'   **  Setup For %.2f GeV User Operation  **'</span>,SR_GEV));
0737             disp(<span class="string">'   *****************************************'</span>);
0738             StartFlag = questdlg(sprintf(<span class="string">'Start setup for users, %.1f GeV?'</span>,SR_GEV),<span class="string">'User Setup'</span>,<span class="string">'Yes'</span>,<span class="string">'Cancel'</span>,<span class="string">'Cancel'</span>);
0739         <span class="keyword">end</span>
0740 
0741         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'Cancel'</span>)
0742             disp([<span class="string">'   ***************************'</span>]);
0743             disp([<span class="string">'   **  User Setup Canceled  **'</span>]);
0744             disp([<span class="string">'   ***************************'</span>]);
0745             fprintf(<span class="string">'\n'</span>);
0746             <span class="keyword">return</span>
0747         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp quickly'</span>)
0748             setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0749         <span class="keyword">elseif</span> strcmp(StartFlag,<span class="string">'Ramp slowly'</span>)
0750             setfamilydata(0.4, <span class="string">'BSCRampRate'</span>);
0751         <span class="keyword">end</span>
0752 
0753         <span class="keyword">try</span>
0754 
0755             <span class="keyword">if</span> GapFlag
0756                 <span class="comment">% Make sure that the gaps are open</span>
0757                 <span class="keyword">if</span> any(getsp(<span class="string">'IDpos'</span>) ~= maxsp(<span class="string">'IDpos'</span>))
0758                     <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0759                     disp(<span class="string">'   Insertion device gaps are not open'</span>);
0760                     disp(<span class="string">'   Opening all gaps at maximum speed'</span>);
0761                     <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0762                     disp(<span class="string">'   Gap control disabled'</span>);
0763                     disp(<span class="string">'   Feed forward enabled'</span>);
0764                     pause(1);
0765                     <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], maxsp(<span class="string">'IDpos'</span>), maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0766                     disp(<span class="string">'   Gaps opened'</span>);
0767                     disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0768                     a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0769                 <span class="keyword">else</span>
0770                     disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0771                 <span class="keyword">end</span>
0772             <span class="keyword">else</span>
0773                 disp(<span class="string">'   Feed forward and gap control disabled'</span>);
0774             <span class="keyword">end</span>
0775 
0776             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0, 0);
0777             pause(1);
0778 
0779             <span class="comment">% Ramp up to the production lattice</span>
0780             ErrorFlag = <a href="srramp.html" class="code" title="function FailFlag = srramp(varargin)">srramp</a>(<span class="string">'Production'</span>);
0781             <span class="keyword">if</span> ErrorFlag
0782                 error(<span class="string">'Superbends over temperature.'</span>);
0783             <span class="keyword">end</span>
0784             a = clock; fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>,date, a(4), a(5), a(6));
0785 
0786             srload(<span class="string">'Production'</span>);
0787 
0788             <span class="keyword">if</span> GapFlag
0789                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 1, 0);
0790                 disp(<span class="string">'   Gap control disabled'</span>);
0791                 disp(<span class="string">'   Feed forward enable'</span>);
0792                 pause(1);
0793 
0794                 disp(<span class="string">'   Insertion device velocity profile boolean control off'</span>);
0795                 disp(<span class="string">'   Closing all gaps at maximum speed'</span>);
0796 
0797                 <span class="comment">% Set IDs at max velocity w/ velocity profile off</span>
0798                 [Position, Velocity, RunFlag, UserGap] = <a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>;
0799 
0800                 <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], UserGap, maxsp(<span class="string">'IDvel'</span>), 1, 0, 1);
0801 
0802                 <span class="comment">% Turn velocity profile on</span>
0803                 disp(<span class="string">'   Insertion device velocity profile boolean control is on'</span>);
0804                 <a href="setid.html" class="code" title="function Err = setid(DeviceList, NewPos, NewVel , WaitFlag, VelocityProfile, InfoFlag);">setid</a>([], [], maxsp(<span class="string">'IDvel'</span>), 1, 1, 0);
0805 
0806                 disp(<span class="string">'   Gaps are closed'</span>);
0807                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([4;7;8;9;10;12], 1, 1);
0808                 <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>(5, 1, 0);
0809                 disp(<span class="string">'   Gap control enabled (except sector 5 (W16))'</span>);
0810             <span class="keyword">end</span>
0811 
0812             <a href="set_alarmhandler_thresholds_new.html" class="code" title="function set_alarmhandler_thresholds_new">set_alarmhandler_thresholds_new</a>;
0813             setpv(<span class="string">'SR_STATE'</span>,3);
0814 
0815         <span class="keyword">catch</span>
0816 
0817             fprintf(<span class="string">'   %s \n'</span>, lasterr);
0818             fprintf(<span class="string">'   User lattice setup failed due to error condition! \n\n'</span>);
0819             setpv(<span class="string">'SR_STATE'</span>,-3);
0820 
0821         <span class="keyword">end</span>
0822 
0823         a = clock;
0824         datestr1=date;
0825         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0826         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0827         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0828         <span class="keyword">if</span> StateNumber &gt;= 0
0829             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0830             disp([<span class="string">'   **************************************************************************'</span>]);
0831             disp([<span class="string">'   **  Function complete:  the storage ring is setup for users at '</span>,sprintf(<span class="string">'%.1f'</span>,SR_GEV),<span class="string">' GeV  **'</span>]);
0832             disp([<span class="string">'   **************************************************************************'</span>]); fprintf(<span class="string">'\n'</span>);
0833         <span class="keyword">else</span>
0834             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0835             disp([<span class="string">'   *************************************'</span>]);
0836             disp([<span class="string">'   **  Problem with production setup  **'</span>]);
0837             disp([<span class="string">'   *************************************'</span>]); fprintf(<span class="string">'\n'</span>);
0838         <span class="keyword">end</span>
0839         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0840 
0841         setfamilydata(0.8, <span class="string">'BSCRampRate'</span>);
0842 
0843     <span class="keyword">case</span> <span class="string">'CheckInputs'</span>
0844 
0845         SR_GEV = getfamilydata(<span class="string">'Energy'</span>);
0846         AD=getad;
0847         <a href="setsrstatechannels.html" class="code" title="function setsrstatechannels">setsrstatechannels</a>; 
0848 
0849         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0850 
0851         <span class="keyword">if</span> AD.Energy &gt; 1.55
0852             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection (Ramp Down)'</span>]);
0853             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users (Ramp Up)'</span>]);
0854         <span class="keyword">elseif</span> AD.Energy &lt; 1.45
0855             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection (Ramp Up+cycle)'</span>]);
0856             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users, '</span>,num2str(round(10*SR_GEV)/10),<span class="string">' GeV (Ramp Down)'</span>]);
0857         <span class="keyword">else</span>
0858             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Injection'</span>]);
0859             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'String'</span>,[<span class="string">'Setup For Users, '</span>,num2str(round(10*SR_GEV)/10),<span class="string">' GeV'</span>]);
0860         <span class="keyword">end</span>
0861         set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLTitle'</span>),<span class="string">'String'</span>,SR_Mode);
0862 
0863         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0864         <span class="keyword">if</span> StateNumber &gt;= 0
0865             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0866         <span class="keyword">else</span>
0867             set(findobj(<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0868         <span class="keyword">end</span>
0869 
0870         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0871 
0872 
0873     <span class="keyword">case</span> <span class="string">'SRState'</span>
0874         NumErrors = 0;
0875         fprintf(<span class="string">'\n'</span>);
0876         disp(<span class="string">'   ***********************************'</span>);
0877         disp(<span class="string">'   **  Checking Storage Ring State  **'</span>);
0878         disp(<span class="string">'   ***********************************'</span>);
0879         a = clock;
0880         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
0881 
0882         <span class="comment">%       FileName = getpv('SR_LATTICE_FILE','String');   % Last srload file name (in OLD MIDDLE LAYER nomenclature!!)</span>
0883 
0884         GeVnow = <a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>;
0885         <span class="keyword">if</span> GeVnow == getfamilydata(<span class="string">'Energy'</span>)
0886             [ConfigSetpoint, ConfigMonitor, FileName] = getproductionlattice;
0887         <span class="keyword">elseif</span> GeVnow == getfamilydata(<span class="string">'InjectionEnergy'</span>)
0888             [ConfigSetpoint, ConfigMonitor, FileName] = getinjectionlattice;
0889         <span class="keyword">else</span>
0890             FileName = <span class="string">''</span>;
0891         <span class="keyword">end</span>
0892 
0893         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0894         fprintf(<span class="string">'   Storage ring operational mode: %s\n'</span>, SR_Mode);
0895         <span class="keyword">if</span> StateNumber &lt; 0
0896             fprintf(<span class="string">'   Storage ring state error: %s\n'</span>, StateString);
0897             NumErrors = NumErrors + 1;
0898         <span class="keyword">else</span>
0899             fprintf(<span class="string">'   Storage ring state: %s\n'</span>, StateString);
0900         <span class="keyword">end</span>
0901         <span class="keyword">if</span> StateNumber==0
0902             <span class="comment">% Storage ring state unknown</span>
0903             NumErrors = NumErrors + 1;
0904         <span class="keyword">elseif</span> abs(StateNumber)==1 || abs(StateNumber)==2
0905             FileNameGoal = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>) getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'InjectionFile'</span>) <span class="string">'.mat'</span>];
0906             <span class="keyword">if</span> ~strcmp(FileName, FileNameGoal)
0907                 fprintf(<span class="string">'   Lattice file %s should be loaded but it appears that %s is loaded.\n'</span>, getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'InjectionFile'</span>), FileName);
0908                 NumErrors = NumErrors + 1;
0909             <span class="keyword">end</span>
0910         <span class="keyword">else</span>
0911             FileNameGoal = [getfamilydata(<span class="string">'Directory'</span>,<span class="string">'OpsData'</span>) getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'LatticeFile'</span>) <span class="string">'.mat'</span>];
0912             <span class="keyword">if</span> ~strcmp(FileName, FileNameGoal)
0913                 fprintf(<span class="string">'   Lattice file %s should be loaded but it appears that %s is loaded.\n'</span>, getfamilydata(<span class="string">'OpsData'</span>,<span class="string">'LatticeFile'</span>), FileName);
0914                 NumErrors = NumErrors + 1;
0915             <span class="keyword">end</span>
0916         <span class="keyword">end</span>
0917 
0918 
0919         <span class="comment">% Check all SR magnets</span>
0920         <span class="keyword">if</span> isempty(FileName)
0921             fprintf(<span class="string">'   Goal setpoints will not be checked since the last lattice load is unknown.\n'</span>);
0922             NumErrors1 = <a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>(<span class="string">''</span>);
0923         <span class="keyword">else</span>
0924 <span class="comment">%            NumErrors1 = checksrmags([getfamilydata('Directory','OpsData') FileName]);</span>
0925             NumErrors1 = <a href="checksrmags.html" class="code" title="function NumErrors = checksrmags(LatticeFileName)">checksrmags</a>(FileName);
0926         <span class="keyword">end</span>
0927         <span class="keyword">if</span> NumErrors1 == 0
0928             fprintf(<span class="string">'   SR magnets power supplies are OK.\n'</span>);
0929         <span class="keyword">end</span>
0930         NumErrors = NumErrors + NumErrors1;
0931 
0932 
0933         <span class="comment">% Check RF frequency</span>
0934         <span class="keyword">if</span> isempty(FileName)
0935             fprintf(<span class="string">'   RF frequency will not be checked since the last lattice load is unknown.\n'</span>);
0936         <span class="keyword">else</span>
0937 <span class="comment">%            load([getfamilydata('Directory','OpsData'), FileName]);</span>
0938             load(FileName);
0939             [tmp, RFHPCounterPresent] = getrf;
0940             <span class="keyword">if</span> abs(RFHPCounterPresent-ConfigSetpoint.RF.Setpoint.Data) &gt; .002
0941                 NumErrors = NumErrors + 1;
0942                 fprintf(<span class="string">'   RF frequency should be %f, presently it is %f MHz (as measured by the HP counter).\n'</span>, ConfigSetpoint.RF.Setpoint.Data, RFHPCounterPresent);
0943             <span class="keyword">else</span>
0944                 fprintf(<span class="string">'   RF frequency is OK (HP counter is %f MHz, at the time of the lattice save it was %f MHz).\n'</span>, RFHPCounterPresent, ConfigSetpoint.RF.Setpoint.Data);
0945             <span class="keyword">end</span>
0946         <span class="keyword">end</span>
0947 
0948 
0949         <span class="comment">% Check for orbit problems</span>
0950         <span class="keyword">if</span> (StateNumber &gt;= 3) &amp; (getdcct &gt; 2)   <span class="comment">% Production lattice is loaded with beam in the machine</span>
0951             Xtol = 0.070;
0952             Ytol = 0.010;
0953             NumErrors1 = <a href="checksrorbit.html" class="code" title="function ErrorNums = checksrorbit(SectorList, BPMxtol,BPMytol)">checksrorbit</a>([],Xtol,Ytol);
0954             <span class="keyword">if</span> NumErrors1
0955                 fprintf(<span class="string">'   SR orbit in the ID straight sections or at Bergoz BPMs deviates more than allowed from the golden orbit.\n'</span>);
0956             <span class="keyword">else</span>
0957                 fprintf(<span class="string">'   SR orbit in the ID straight sections and at Bergoz BPMs is OK.\n'</span>);
0958                 fprintf(<span class="string">'   The orbit is within %.3f mm horizontally and %.3f mm vertically'</span>, Xtol, Ytol);
0959             <span class="keyword">end</span>
0960             NumErrors = NumErrors + NumErrors1;
0961         <span class="keyword">else</span>
0962             fprintf(<span class="string">'   Storage ring orbit was not checked.\n'</span>);
0963         <span class="keyword">end</span>
0964 
0965 
0966         a = clock;
0967         datestr1=date;
0968         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, datestr1, a(4), a(5), a(6));
0969         <span class="keyword">if</span> NumErrors
0970             disp(<span class="string">'   *********************************'</span>);
0971             disp(<span class="string">'   **  Storage Ring Has Problems  **'</span>);
0972             disp(<span class="string">'   *********************************'</span>);
0973         <span class="keyword">else</span>
0974             disp(<span class="string">'   **********************************'</span>);
0975             disp(<span class="string">'   **  Storage Ring Lattice is OK  **'</span>);
0976             disp(<span class="string">'   **********************************'</span>);
0977         <span class="keyword">end</span>
0978         fprintf(<span class="string">'   \n'</span>);
0979 
0980         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
0981         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
0982         <span class="keyword">if</span> StateNumber &gt;= 0
0983             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
0984         <span class="keyword">else</span>
0985             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
0986         <span class="keyword">end</span>
0987         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
0988 
0989 
0990     <span class="keyword">case</span> <span class="string">'OrbitCorrection'</span>
0991         fprintf(<span class="string">'\n'</span>);
0992         fprintf(<span class="string">'   *********************************\n'</span>);
0993         fprintf(<span class="string">'   **  Starting Orbit Correction  **\n'</span>);
0994         fprintf(<span class="string">'   *********************************\n'</span>);
0995         a = clock;
0996         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
0997 
0998         StartFlag = questdlg(sprintf(<span class="string">'Start orbit correction, %.1f GeV?'</span>,SR_GEV),<span class="string">'Orbit Correction'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
0999         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
1000             disp([<span class="string">'   ********************************'</span>]);
1001             disp([<span class="string">'   **  Orbit Correction Aborted  **'</span>]);
1002             disp([<span class="string">'   ********************************'</span>]);
1003             fprintf(<span class="string">'\n'</span>);
1004             <span class="keyword">return</span>
1005         <span class="keyword">end</span>
1006 
1007         <span class="keyword">if</span> getdcct &lt; 5     <span class="comment">% Don't correct the orbit if the current is too small</span>
1008             fprintf(<span class="string">'   Orbit not corrected due to small current.\n'</span>);
1009             <span class="keyword">return</span>
1010         <span class="keyword">end</span>
1011 
1012         <span class="keyword">if</span> abs(SR_GEV-<a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>(getpv(<span class="string">'BEND'</span>,[1 1])))&gt;  0.05     <span class="comment">% Don't use this routine for the injection lattice</span>
1013             fprintf(<span class="string">'   This routine should only be used for the production energy: Correction aborted\n'</span>);
1014             <span class="keyword">return</span>
1015         <span class="keyword">end</span>
1016 
1017         SR_STATE_OLD = scaget(<span class="string">'SR_STATE'</span>);
1018         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1019         setpv(<span class="string">'SR_STATE'</span>,4);
1020         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1021         <span class="keyword">if</span> StateNumber &gt;= 0
1022             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1023         <span class="keyword">else</span>
1024             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1025         <span class="keyword">end</span>
1026         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1027 
1028 
1029         <span class="keyword">try</span>
1030 
1031             <span class="comment">% 2 Hz update rate on IDBPMs</span>
1032             disp(<span class="string">'   IDBPM time constant set to 0.5s.'</span>)
1033             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.5)
1034             pause(2);
1035 
1036 
1037             <span class="comment">% Turn off feed forward</span>
1038             fprintf(<span class="string">'   Turning feed forward off.\n'</span>);
1039             [FFEnableBM, FFEnableBC] = <a href="getff.html" class="code" title="function [FFEnableBM, FFEnableBC, GapEnableBM, GapEnableBC, Sector] = getff(Sector)">getff</a>;
1040             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], 0);
1041             scasleep(.2);
1042 
1043 
1044             <span class="comment">% Get vectors</span>
1045             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>);
1046             LocalBumplist = FB.LocalBumplist;
1047 
1048         <span class="keyword">catch</span>
1049 
1050             fprintf(<span class="string">'   %s \n'</span>,lasterr);
1051             fprintf(<span class="string">'   Orbit correction setup failed due to error condition! \n\n'</span>);
1052             setpv(<span class="string">'SR_STATE'</span>,-4);
1053             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1054             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1055             <span class="keyword">if</span> StateNumber &gt;= 0
1056                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1057             <span class="keyword">else</span>
1058                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1059             <span class="keyword">end</span>
1060             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1061             <span class="keyword">return</span>
1062 
1063         <span class="keyword">end</span>
1064 
1065         iNotHCMChicane = find(FB.HCMlist1(:,2) &lt; 10); <span class="comment">%used by steppv's for setting correctors in loop</span>
1066         iHCMChicane = find(FB.HCMlist1(:,2) == 10);
1067         iNotVCMChicane = find(FB.VCMlist1(:,2) &lt; 10);
1068         iVCMChicane = find(FB.VCMlist1(:,2) == 10);
1069 
1070         fprintf(<span class="string">'   Starting horizontal and vertical global orbit correction (SVD method).\n'</span>);
1071 
1072         <span class="keyword">for</span> iloop = 1:3
1073             <span class="keyword">try</span>
1074                 <span class="comment">% use the following to get corrector settings in OCS without setting them, so the values can be checked</span>
1075                 FB.OCSx = setorbit(FB.OCSx,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1076                 FB.OCSy = setorbit(FB.OCSy,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1077                 <span class="keyword">if</span> any(abs(FB.OCSx.CM.Delta(iNotHCMChicane)) &gt; 5)
1078                   disp(<span class="string">'   Orbit Correction is changing some horizontal corrector(s) &gt; 5A!!'</span>);
1079                 <span class="keyword">end</span>
1080                 <span class="keyword">if</span> any(abs(FB.OCSy.CM.Delta(iNotVCMChicane)) &gt; 5)
1081                   disp(<span class="string">'   Orbit Correction is changing some vertical corrector(s) &gt; 5A!!'</span>);
1082                 <span class="keyword">end</span>
1083                 <span class="keyword">if</span> any(abs(FB.OCSx.CM.Delta(iHCMChicane)) &gt; 10)
1084                   disp(<span class="string">'   Orbit Correction is changing some horizontal chicane corrector(s) &gt; 10A!!'</span>);
1085                 <span class="keyword">end</span>
1086                 <span class="keyword">if</span> any(abs(FB.OCSy.CM.Delta(iVCMChicane)) &gt; 10)
1087                   disp(<span class="string">'   Orbit Correction is changing some vertical chicane corrector(s) &gt; 10A!!'</span>);
1088                 <span class="keyword">end</span>
1089 
1090 
1091                 <span class="comment">% Correct horizontal orbit</span>
1092                 FB.OCSx = setorbit(FB.OCSx,<span class="string">'NoDisplay'</span>);
1093                 <span class="comment">% Correct vertical orbit</span>
1094                 FB.OCSy = setorbit(FB.OCSy,<span class="string">'NoDisplay'</span>);
1095 
1096 
1097                 <span class="comment">% Check for current in machine - stop orbit correction if DCCT &lt; 5mA</span>
1098                 <span class="keyword">if</span> (getdcct &lt; 4.5)
1099                     error(<span class="string">'**There is less than 5mA in the machine! Stopping orbit correction.'</span>);
1100                 <span class="keyword">end</span>
1101 
1102                 <span class="comment">% Check state of gaps - stop orbit correction if any are moving</span>
1103                 GAPrunflag = getpv(<span class="string">'ID'</span>,<span class="string">'RunFlag'</span>);
1104                 <span class="keyword">if</span> any(GAPrunflag-round(GAPrunflag))
1105                     error(<span class="string">'**One or more of the gaps are moving! Stopping orbit correction.'</span>);
1106                 <span class="keyword">end</span>
1107 
1108                 x = FB.OCSx.GoalOrbit - getx(FB.OCSx.BPM.DeviceList);
1109                 y = FB.OCSy.GoalOrbit - gety(FB.OCSy.BPM.DeviceList);
1110                 fprintf(<span class="string">'   %d. Horizontal RMS = %.3f mm\n'</span>, iloop, norm(x)/sqrt(length(x)));
1111                 fprintf(<span class="string">'   %d.   Vertical RMS = %.3f mm\n'</span>, iloop, norm(y)/sqrt(length(y)));
1112 
1113             <span class="keyword">catch</span>
1114                 <span class="comment">% fprintf('   %s \n',lasterr);</span>
1115                 fprintf(<span class="string">'   Orbit correction failed due to error condition!\n  Fix the problem, reload the lattice (srload), and try again.  \n\n'</span>);
1116                 setpv(<span class="string">'SR_STATE'</span>,-4);
1117                 set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1118                 [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1119                 <span class="keyword">if</span> StateNumber &gt;= 0
1120                     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1121                 <span class="keyword">else</span>
1122                     set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1123                 <span class="keyword">end</span>
1124                 set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1125                 <span class="keyword">return</span>
1126             <span class="keyword">end</span>
1127         <span class="keyword">end</span>
1128 
1129 
1130         <span class="comment">% Set user bumps w/o sextupole correctors</span>
1131         <span class="keyword">try</span>
1132 
1133             <span class="comment">%turn up corrector speed here to quicken setting bumps</span>
1134             HCMramprate = getpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>);
1135             VCMramprate = getpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>);
1136             setpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>, 10, [], 0);
1137             setpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>, 10, [], 0);
1138             
1139             <span class="keyword">if</span> ~isempty(LocalBumplist)
1140                 fprintf(<span class="string">'   Setting local bumps in the straight sections.\n'</span>);
1141                 <span class="keyword">for</span> loop = 1:size(LocalBumplist,1)
1142 
1143                     <span class="comment">% Check for current in machine - stop orbit correction if DCCT &lt; 5mA</span>
1144                     <span class="keyword">if</span> (getdcct &lt; 5)
1145                         error(<span class="string">'** There is less than 5mA in the machine! Stopping local bumps.'</span>);
1146                     <span class="keyword">end</span>
1147 
1148                     <span class="comment">% Check state of gaps - stop setting bumps if any are moving</span>
1149                     GAPrunflag = getpv(<span class="string">'ID'</span>,<span class="string">'RunFlag'</span>);
1150                     <span class="keyword">if</span> any(GAPrunflag-round(GAPrunflag))
1151                         error(<span class="string">'** One or more of the gaps are moving! Stopping local bumps.'</span>);
1152                     <span class="keyword">end</span>
1153 
1154                     HCMoldsp = getsp(<span class="string">'HCM'</span>, FB.HCMlist1);
1155                     VCMoldsp = getsp(<span class="string">'VCM'</span>, FB.VCMlist1);
1156 
1157                     <span class="keyword">if</span> any(LocalBumplist(loop,1) == [4 6 11])
1158                         <span class="keyword">if</span> LocalBumplist(loop,2) == 0
1159                             <span class="comment">% Upstream bump</span>
1160                             [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1)-1 11;LocalBumplist(loop,1)-1 12;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1161                             <span class="keyword">if</span> isempty(iRemove)
1162                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1163                             <span class="keyword">else</span>
1164                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1165                             <span class="keyword">end</span>
1166                         <span class="keyword">elseif</span> LocalBumplist(loop,2) == 1
1167                             <span class="comment">% Upstream bump</span>
1168                             [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1)-1 11;],FB.OCSx.BPM.DeviceList);
1169                             <span class="keyword">if</span> isempty(iRemove)
1170                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1171                             <span class="keyword">else</span>
1172                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1173                             <span class="keyword">end</span>
1174                         <span class="keyword">else</span>
1175                             <span class="comment">% Downstream bump</span>
1176                             [i, iRemove] = findrowindex([LocalBumplist(loop,1)-1 12;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1177                             <span class="keyword">if</span> isempty(iRemove)
1178                                 <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1179                             <span class="keyword">else</span>
1180                                 fprintf(<span class="string">'\n   BPMs missing from Sector(%02d,%02d) - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,:));
1181                             <span class="keyword">end</span>
1182                         <span class="keyword">end</span>
1183                     <span class="keyword">else</span>
1184                         [i,iRemove] = findrowindex([LocalBumplist(loop,1)-1 10;LocalBumplist(loop,1) 1],FB.OCSx.BPM.DeviceList);
1185                         <span class="keyword">if</span> isempty(iRemove)
1186                             <a href="setbumps.html" class="code" title="function setbumps(IDDeviceList, CMGroup, BPMxGoal, BPMyGoal, BPMIter, BPMTol, DisplayFlag)">setbumps</a>(LocalBumplist(loop,:), 1);
1187                         <span class="keyword">else</span>
1188                             fprintf(<span class="string">'\n   BPMs missing from Sector %02d - skipping local bump for that sector.\n\n'</span>, LocalBumplist(loop,1));
1189                         <span class="keyword">end</span>
1190                     <span class="keyword">end</span>
1191                     
1192                     HCMnewsp = getsp(<span class="string">'HCM'</span>, FB.HCMlist1);
1193                     VCMnewsp = getsp(<span class="string">'VCM'</span>, FB.VCMlist1);
1194                     <span class="comment">% Remove center chicane trim from corrector check</span>
1195                     <span class="keyword">if</span> (max(abs(HCMoldsp(iNotHCMChicane)-HCMnewsp(iNotHCMChicane))) &gt; 5) | (max(abs(VCMoldsp(iNotVCMChicane)-VCMnewsp(iNotVCMChicane))) &gt; 10)
1196                         error(<span class="string">'**Setbumps caused some corrector magnet currents to change by more than 5(Horiz)/10(Vert) A!'</span>);
1197                     <span class="keyword">end</span>
1198                     <span class="comment">% Now check center chicane trims</span>
1199                     <span class="keyword">if</span> (max(abs(HCMoldsp(iNotHCMChicane)-HCMnewsp(iNotHCMChicane))) &gt; 10) | (max(abs(VCMoldsp(iNotVCMChicane)-VCMnewsp(iNotVCMChicane))) &gt; 15)
1200                         error(<span class="string">'**Setbumps caused some chicane trim magnet currents to change by more than 10(Horiz)/15(Vert) A!'</span>);
1201                     <span class="keyword">end</span>
1202                 <span class="keyword">end</span>
1203             <span class="keyword">end</span>
1204 
1205             <span class="comment">%restore corrector speeds</span>
1206             setpv(<span class="string">'HCM'</span>, <span class="string">'RampRate'</span>, HCMramprate, [], 0);
1207             setpv(<span class="string">'VCM'</span>, <span class="string">'RampRate'</span>, VCMramprate, [], 0);
1208 
1209         <span class="keyword">catch</span>
1210             fprintf(<span class="string">'   %s \n'</span>,lasterr);
1211             fprintf(<span class="string">'   Setbumps failed due to error condition!  Fix the problem, reload the lattice (srload), and try again.\n\n'</span>);
1212             setpv(<span class="string">'SR_STATE'</span>,-4);
1213             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1214             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1215             <span class="keyword">if</span> StateNumber &gt;= 0
1216                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1217             <span class="keyword">else</span>
1218                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1219             <span class="keyword">end</span>
1220             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1221             <span class="keyword">return</span>
1222         <span class="keyword">end</span>
1223 
1224 
1225         <span class="comment">% Turn feed forward back to it's original state</span>
1226         <span class="keyword">if</span> any(FFEnableBC)
1227             fprintf(<span class="string">'   Turning feed forward back on.\n'</span>);
1228             <a href="setff.html" class="code" title="function setff(Sector, FFEnableBC, GapEnableBC)">setff</a>([], FFEnableBC);
1229         <span class="keyword">end</span>
1230 
1231 
1232         a = clock;
1233         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1234         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1235         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1236         <span class="keyword">if</span> StateNumber &gt;= 0
1237             setpv(<span class="string">'SR_STATE'</span>,4.1);
1238             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1239             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1240             fprintf(<span class="string">'   *********************************\n'</span>);
1241             fprintf(<span class="string">'   **  Orbit Correction Complete  **\n'</span>);
1242             fprintf(<span class="string">'   *********************************\n\n'</span>);
1243         <span class="keyword">else</span>
1244             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1245             fprintf(<span class="string">'   *************************************\n'</span>);
1246             fprintf(<span class="string">'   **  Problem With Orbit Correction  **\n'</span>);
1247             fprintf(<span class="string">'   *************************************\n\n'</span>);
1248         <span class="keyword">end</span>
1249         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1250         pause(0);
1251 
1252 
1253     <span class="keyword">case</span> <span class="string">'OrbitCorrectionSetup'</span>
1254         InitFlag = Input2;           <span class="comment">% Input #2: if InitFlag, then initialize variables</span>
1255 
1256         <span class="keyword">if</span> InitFlag
1257             <span class="comment">% Setup feedback elements</span>
1258             <span class="comment">% disp('Orbit correction condition: InitFlag=1 -- debugging message');</span>
1259 
1260             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1261             <span class="comment">% Edit the following lists to change default configuration of Orbit Correction %</span>
1262             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1263             hlist=[];vlist=[];
1264             <span class="keyword">for</span> Sector =1:12
1265                 <span class="keyword">if</span> Sector == 1
1266                     vlist = [vlist;Sector 2;Sector 4;Sector 5;Sector 8];
1267                     hlist = [hlist;Sector 2;Sector 7];
1268                 <span class="keyword">elseif</span> Sector == 3
1269                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];
1270                     hlist = [hlist;Sector 2;Sector 7;Sector 10];
1271                 <span class="keyword">elseif</span> Sector == 5
1272                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];
1273                     hlist = [hlist;Sector 2;Sector 7;Sector 10];
1274                 <span class="keyword">elseif</span> Sector == 10
1275                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8;Sector 10];
1276                     hlist = [hlist;Sector 2;Sector 7;Sector 10];
1277                 <span class="keyword">elseif</span> Sector == 12
1278                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 7];
1279                     hlist = [hlist;Sector 2;Sector 7];
1280                 <span class="keyword">else</span>
1281                     vlist = [vlist;Sector 1;Sector 4;Sector 5;Sector 8];
1282                     hlist = [hlist;Sector 2;Sector 7];
1283                 <span class="keyword">end</span>
1284             <span class="keyword">end</span>
1285             HCMlist1 = hlist;
1286             VCMlist1 = vlist;
1287 
1288             BPMlist1 = [
1289                 1 2
1290                 1 5
1291                 1 6
1292                 1 10
1293                 2 1
1294                 2 5
1295                 2 6
1296                 2 9
1297                 3 2
1298                 3 5
1299                 3 6
1300                 3 10
1301                 3 11
1302                 3 12
1303                 4 1
1304                 4 5
1305                 4 6
1306                 4 10
1307                 5 1
1308                 5 5
1309                 5 6
1310                 5 10
1311                 5 11
1312                 5 12
1313                 6 1
1314                 6 5
1315                 6 6
1316                 6 10
1317                 7 1
1318                 7 5
1319                 7 6
1320                 7 10
1321                 8 1
1322                 8 5
1323                 8 6
1324                 8 10
1325                 9 1
1326                 9 5
1327                 9 6
1328                 9 10
1329                 10 1
1330                 10 5
1331                 10 6
1332                 10 10
1333                 10 11
1334                 10 12
1335                 11 1
1336                 11 5
1337                 11 6
1338                 11 10
1339                 12 1
1340                 12 5
1341                 12 6
1342                 12 9];
1343 
1344             <span class="comment">% SVD orbit correction</span>
1345             Xivec = [1:28];
1346             Yivec = [1:48];
1347 
1348 
1349             LocalBumplist = [
1350               <span class="comment">% 1 1</span>
1351               <span class="comment">% 2 1</span>
1352               <span class="comment">% 3 1</span>
1353                 4 1
1354               <span class="comment">% 4 2</span>
1355                 5 1
1356                 6 1
1357               <span class="comment">% 6 2</span>
1358                 7 1
1359                 8 1
1360                 9 1
1361                 10 1
1362                 11 1
1363                 11 2
1364                 12 1
1365 ];
1366             <span class="comment">%LocalBumplist = []</span>
1367             
1368             <span class="comment">% initialize RFCorrFlag</span>
1369             RFCorrFlag = <span class="string">'Yes'</span>;
1370         <span class="keyword">else</span>
1371 
1372             <span class="comment">% Get vectors</span>
1373             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>);
1374             BPMlist1 = FB.BPMlist1;
1375             HCMlist1 = FB.HCMlist1;
1376             VCMlist1 = FB.VCMlist1;
1377             Xivec = FB.Xivec;
1378             Yivec = FB.Yivec;
1379             LocalBumplist = FB.LocalBumplist;
1380             Xgoal = FB.Xgoal;
1381             Ygoal = FB.Ygoal;
1382             RFCorrFlag = FB.RFCorrFlag;
1383 
1384             <span class="comment">% Add button to change #ivectors, CMs, IDBPMs,</span>
1385             EditFlag = 0;
1386             h_fig1 = figure;
1387             <span class="keyword">while</span> EditFlag ~= 8
1388 
1389                 <span class="comment">% Sensitivity matrix</span>
1390                 Sx = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
1391                 Sy = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
1392                 
1393                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1394                 <span class="comment">% Can the call below work for setting FOFB RF parameter? %</span>
1395                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
1396                 <span class="keyword">if</span> strcmpi(RFCorrFlag, <span class="string">'Yes'</span>)
1397                     Sx = [Sx getdisp(<span class="string">'BPMx'</span>,BPMlist1)];
1398                 <span class="keyword">end</span>
1399                 
1400                 [Ux, SVx, Vx] = svd(Sx);
1401                 [Uy, SVy, Vy] = svd(Sy);
1402 
1403 
1404                 <span class="comment">% Remove singular values greater than the actual number of singular values</span>
1405                 i = find(Xivec&gt;length(diag(SVx)));
1406                 <span class="keyword">if</span> ~isempty(i)
1407                     disp(<span class="string">'   Horizontal E-vector scaled since there were more elements in the vector than singular values.'</span>);
1408                     pause(0);
1409                     Xivec(i) = [];
1410                 <span class="keyword">end</span>
1411                 i = find(Yivec&gt;length(diag(SVy)));
1412                 <span class="keyword">if</span> ~isempty(i)
1413                     disp(<span class="string">'   Vertical E-vector scaled since there were more elements in the vector than singular values.'</span>);
1414                     pause(0);
1415                     Yivec(i) = [];
1416                 <span class="keyword">end</span>
1417 
1418 
1419                 Ax = Sx*Vx(:,Xivec);
1420                 Tx = inv(Ax'*Ax)*Ax';
1421 
1422                 Ay = Sy*Vy(:,Yivec);
1423                 Ty = inv(Ay'*Ay)*Ay';
1424 
1425 
1426                 figure(h_fig1);
1427                 subplot(2,1,1);
1428                 semilogy(diag(SVx),<span class="string">'b'</span>);
1429                 hold on;
1430                 semilogy(diag(SVx(Xivec,Xivec)),<span class="string">'xr'</span>);
1431                 ylabel(<span class="string">'Horizontal'</span>);
1432                 title(<span class="string">'Response Matrix Singular Values'</span>);
1433                 hold off;
1434                 subplot(2,1,2);
1435                 semilogy(diag(SVy),<span class="string">'b'</span>);
1436                 hold on;
1437                 semilogy(diag(SVy(Yivec,Yivec)),<span class="string">'xr'</span>);
1438                 xlabel(<span class="string">'Singular Value Number'</span>);
1439                 ylabel(<span class="string">'Vertical'</span>);
1440                 hold off;
1441                 drawnow;
1442 
1443                 <span class="keyword">if</span> strcmp(RFCorrFlag,<span class="string">'No'</span>)
1444                     RFCorrState = <span class="string">'NOT CORRECTED'</span>;
1445                 <span class="keyword">elseif</span> strcmp(RFCorrFlag,<span class="string">'Yes'</span>)
1446                     RFCorrState = <span class="string">'CORRECTED'</span>;
1447                 <span class="keyword">else</span>
1448                     RFCorrState = <span class="string">'???'</span>;
1449                 <span class="keyword">end</span>
1450 
1451                 <span class="comment">%         EditFlag = menu('Change Parameters?','Singular Values','HCM List','VCM List','HCM Chicane List','VCM Chicane List','IDBPM List','BBPM List','Change Golden Orbit',...</span>
1452                 <span class="comment">%            'Local Bump List',sprintf('RF Frequency (currently %s)',RFCorrState),'Continue');</span>
1453                 EditFlag = menu(<span class="string">'Change Parameters?'</span>,<span class="string">'Singular Values'</span>,<span class="string">'HCM List'</span>,<span class="string">'VCM List'</span>,<span class="string">'BPM List'</span>,<span class="string">'Change Golden Orbit'</span>,<span class="keyword">...</span>
1454                     <span class="string">'Local Bump List'</span>,sprintf(<span class="string">'RF Frequency (currently %s)'</span>,RFCorrState),<span class="string">'Continue'</span>);
1455 
1456                 <span class="keyword">if</span> EditFlag == 1
1457                     prompt={<span class="string">'Enter the horizontal E-vector numbers (Matlab vector format):'</span>,<span class="string">'Enter the vertical E-vector numbers (Matlab vector format):'</span>};
1458                     def={sprintf(<span class="string">'[%d:%d]'</span>,1,Xivec(end)),sprintf(<span class="string">'[%d:%d]'</span>,1,Yivec(end))};
1459                     titlestr=<span class="string">'SVD Orbit Feedback'</span>;
1460                     lineNo=1;
1461                     answer=inputdlg(prompt,titlestr,lineNo,def);
1462                     <span class="keyword">if</span> ~isempty(answer)
1463                         XivecNew = fix(str2num(answer{1}));
1464                         <span class="keyword">if</span> isempty(XivecNew)
1465                             disp(<span class="string">'   Horizontal E-vector cannot be empty.  No change made.'</span>);
1466                         <span class="keyword">else</span>
1467                             <span class="keyword">if</span> any(XivecNew&lt;=0) | max(XivecNew)&gt;length(diag(SVx))
1468                                 disp(<span class="string">'   Error reading horizontal E-vector.  No change made.'</span>);
1469                             <span class="keyword">else</span>
1470                                 Xivec = XivecNew;
1471                             <span class="keyword">end</span>
1472                         <span class="keyword">end</span>
1473                         YivecNew = fix(str2num(answer{2}));
1474                         <span class="keyword">if</span> isempty(YivecNew)
1475                             disp(<span class="string">'   Vertical E-vector cannot be empty.  No change made.'</span>);
1476                         <span class="keyword">else</span>
1477                             <span class="keyword">if</span> any(YivecNew&lt;=0) | max(YivecNew)&gt;length(diag(SVy))
1478                                 disp(<span class="string">'   Error reading vertical E-vector.  No change made.'</span>);
1479                             <span class="keyword">else</span>
1480                                 Yivec = YivecNew;
1481                             <span class="keyword">end</span>
1482                         <span class="keyword">end</span>
1483                     <span class="keyword">end</span>
1484                 <span class="keyword">end</span>
1485 
1486                 <span class="keyword">if</span> EditFlag == 2
1487                     List = getlist(<span class="string">'HCM'</span>);
1488                     CheckList = zeros(size(List,1));
1489                     Elem = dev2elem(<span class="string">'HCM'</span>, HCMlist1);
1490                     CheckList(Elem) = ones(size(Elem));
1491                     CheckList = CheckList(dev2elem(<span class="string">'HCM'</span>,List));
1492                     newList = editlist(List, <span class="string">'HCM'</span>, CheckList);
1493                     <span class="keyword">if</span> isempty(newList)
1494                         fprintf(<span class="string">'   Horizontal corrector magnet list cannot be empty.  No change made.\n'</span>);
1495                     <span class="keyword">else</span>
1496                         HCMlist1 = newList;
1497                     <span class="keyword">end</span>
1498                 <span class="keyword">end</span>
1499 
1500                 <span class="keyword">if</span> EditFlag == 3
1501                     List = getlist(<span class="string">'VCM'</span>);
1502                     CheckList = zeros(size(List,1));
1503                     Elem = dev2elem(<span class="string">'VCM'</span>, VCMlist1);
1504                     CheckList(Elem) = ones(size(Elem));
1505                     CheckList = CheckList(dev2elem(<span class="string">'VCM'</span>,List));
1506                     newList = editlist(List, <span class="string">'VCM'</span>, CheckList);
1507                     <span class="keyword">if</span> isempty(newList)
1508                         fprintf(<span class="string">'   Vertical corrector magnet cannot be empty.  No change made.\n'</span>);
1509                     <span class="keyword">else</span>
1510                         VCMlist1 = newList;
1511                     <span class="keyword">end</span>
1512                 <span class="keyword">end</span>
1513 
1514                 <span class="keyword">if</span> EditFlag == 4
1515                     ListOld = BPMlist1;
1516                     XgoalOld = Xgoal;
1517                     YgoalOld = Ygoal;
1518 
1519                     <span class="comment">% Full BPM list</span>
1520                     List = [
1521                         1 2
1522                         1 5
1523                         1 6
1524                         1 10
1525                         2 1
1526                         2 5
1527                         2 6
1528                         2 9
1529                         3 2
1530                         3 5
1531                         3 6
1532                         3 10
1533                         3 11
1534                         3 12
1535                         4 1
1536                         4 5
1537                         4 6
1538                         4 10
1539                         5 1
1540                         5 5
1541                         5 6
1542                         5 10
1543                         5 11
1544                         5 12
1545                         6 1
1546                         6 5
1547                         6 6
1548                         6 10
1549                         7 1
1550                         7 5
1551                         7 6
1552                         7 10
1553                         8 1
1554                         8 5
1555                         8 6
1556                         8 10
1557                         9 1
1558                         9 5
1559                         9 6
1560                         9 10
1561                         10 1
1562                         10 5
1563                         10 6
1564                         10 10
1565                         10 11
1566                         10 12
1567                         11 1
1568                         11 5
1569                         11 6
1570                         11 10
1571                         12 1
1572                         12 5
1573                         12 6
1574                         12 9
1575                         ];
1576 
1577                     CheckList = zeros(size(List,1),1);
1578                     <span class="keyword">if</span> ~isempty(BPMlist1)
1579                         <span class="keyword">for</span> i = 1:size(List,1)
1580                             k = find(List(i,1)==BPMlist1(:,1));
1581                             l = find(List(i,2)==BPMlist1(k,2));
1582 
1583                             <span class="keyword">if</span> isempty(k) | isempty(l)
1584                                 <span class="comment">% Item not in list</span>
1585                             <span class="keyword">else</span>
1586                                 CheckList(i) = 1;
1587                             <span class="keyword">end</span>
1588                         <span class="keyword">end</span>
1589                     <span class="keyword">end</span>
1590 
1591                     newList = editlist(List, <span class="string">'BPM'</span>, CheckList);
1592                     <span class="keyword">if</span> isempty(newList)
1593                         fprintf(<span class="string">'   BPM list cannot be empty.  No change made.\n'</span>);
1594                     <span class="keyword">else</span>
1595                         BPMlist1 = newList;
1596                     <span class="keyword">end</span>
1597 
1598                     <span class="comment">% Set the goal orbit to the golden orbit</span>
1599                     Xgoal = getgolden(<span class="string">'BPMx'</span>, BPMlist1);
1600                     Ygoal = getgolden(<span class="string">'BPMy'</span>, BPMlist1);
1601 
1602 
1603                     <span class="comment">% If a new BPM is added, then set the goal orbit to the golden orbit</span>
1604                     <span class="keyword">for</span> i = 1:size(BPMlist1,1)
1605 
1606                         <span class="comment">% Is it a new BPM?</span>
1607                         k = find(BPMlist1(i,1)==ListOld(:,1));
1608                         l = find(BPMlist1(i,2)==ListOld(k,2));
1609 
1610                         <span class="keyword">if</span> isempty(k) | isempty(l)
1611                             <span class="comment">% New BPM</span>
1612                         <span class="keyword">else</span>
1613                             <span class="comment">% Use the old value for old BPM</span>
1614                             Xgoal(i) = XgoalOld(k(l));
1615                             Ygoal(i) = YgoalOld(k(l));
1616                         <span class="keyword">end</span>
1617                     <span class="keyword">end</span>
1618                 <span class="keyword">end</span>
1619 
1620                 <span class="keyword">if</span> EditFlag == 5
1621 
1622                     ChangeList = editlist(BPMlist1, <span class="string">'Change BPM'</span>, zeros(size(BPMlist1,1),1));
1623                     <span class="keyword">for</span> i = 1:size(ChangeList,1)
1624 
1625                         k = find(ChangeList(i,1)==BPMlist1(:,1));
1626                         l = find(ChangeList(i,2)==BPMlist1(k,2));
1627 
1628                         prompt = {sprintf(<span class="string">'Enter the new horizontal goal orbit for BPMx(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2)),sprintf(<span class="string">'Enter the new vertical goal orbit for BPMy(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2))};
1629                         def = {sprintf(<span class="string">'%f'</span>,Xgoal(k(l))),sprintf(<span class="string">'%f'</span>,Ygoal(k(l)))};
1630                         titlestr = <span class="string">'CHANGE THE GOAL ORBIT'</span>;
1631                         lineNo = 1;
1632                         answer = inputdlg(prompt, titlestr, lineNo, def);
1633 
1634                         <span class="keyword">if</span> isempty(answer)
1635                             <span class="comment">% No change</span>
1636                             fprintf(<span class="string">'   No change was made to the golden orbit.\n'</span>);
1637                         <span class="keyword">else</span>
1638                             Xgoalnew = str2num(answer{1});
1639                             <span class="keyword">if</span> isempty(Xgoalnew)
1640                                 fprintf(<span class="string">'   No change was made to the horizontal golden orbit.\n'</span>);
1641                             <span class="keyword">else</span>
1642                                 Xgoal(k(l)) = Xgoalnew;
1643                             <span class="keyword">end</span>
1644 
1645                             Ygoalnew = str2num(answer{2});
1646                             <span class="keyword">if</span> isempty(Ygoalnew)
1647                                 fprintf(<span class="string">'   No change was made to the vertical golden orbit.\n'</span>);
1648                             <span class="keyword">else</span>
1649                                 Ygoal(k(l)) = Ygoalnew;
1650                             <span class="keyword">end</span>
1651                         <span class="keyword">end</span>
1652                     <span class="keyword">end</span>
1653                     <span class="keyword">if</span> ~isempty(ChangeList)
1654                         fprintf(<span class="string">'   Note:  changing the goal orbit for &quot;Orbit Correction&quot; does not change the goal orbit for &quot;Slow Orbit Feedback.&quot;\n'</span>);
1655                         fprintf(<span class="string">'          Re-running srcontrol will restart the goal orbit to the golden orbit.&quot;\n'</span>);
1656                     <span class="keyword">end</span>
1657                 <span class="keyword">end</span>
1658 
1659                 <span class="keyword">if</span> EditFlag == 6
1660                     List = [
1661                         1 1
1662                         2 1
1663                         3 1
1664                         4 1
1665                         4 2
1666                         5 1
1667                         6 1
1668                         6 2
1669                         7 1
1670                         8 1
1671                         9 1
1672                         10 1
1673                         11 1
1674                         11 2
1675                         12 1];
1676                     CheckList = zeros(size(List,1),1);
1677                     <span class="keyword">if</span> ~isempty(LocalBumplist)
1678                         <span class="keyword">for</span> i = 1:size(List,1)
1679                             k = find(List(i,1)==LocalBumplist(:,1));
1680                             l = find(List(i,2)==LocalBumplist(k,2));
1681 
1682                             <span class="keyword">if</span> isempty(k) | isempty(l)
1683                                 <span class="comment">% Item not in list</span>
1684                             <span class="keyword">else</span>
1685                                 CheckList(i) = 1;
1686                             <span class="keyword">end</span>
1687                         <span class="keyword">end</span>
1688                     <span class="keyword">end</span>
1689                     LocalBumplist = editlist2(List, <span class="string">'Sector'</span>, CheckList);
1690                 <span class="keyword">end</span>
1691 
1692                 <span class="keyword">if</span> EditFlag == 7
1693                     RFCorrFlag = questdlg(sprintf(<span class="string">'Set RF Frequency during Orbit Correction?'</span>),<span class="string">'RF Frequency'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>, <span class="string">'No'</span>);
1694                     <span class="keyword">if</span> strcmp(RFCorrFlag,<span class="string">'No'</span>)
1695                         disp([<span class="string">'   RF Frequency will not be included in global orbit correction.'</span>]);
1696                     <span class="keyword">elseif</span> strcmp(RFCorrFlag,<span class="string">'Yes'</span>)
1697                         disp([<span class="string">'   RF Frequency will be included in global orbit correction.'</span>]);
1698                     <span class="keyword">end</span>
1699 
1700                 <span class="keyword">end</span>
1701             <span class="keyword">end</span>
1702             close(h_fig1);
1703         <span class="keyword">end</span>
1704         
1705 <span class="comment">%  ORBIT CORRECTION STRUCTURE (OCS)</span>
1706 <span class="comment">%    OCS.BPM (data structure)</span>
1707 <span class="comment">%    OCS.CM  (data structure)</span>
1708 <span class="comment">%    OCS.GoalOrbit</span>
1709 <span class="comment">%    OCS.NIter</span>
1710 <span class="comment">%    OCS.SVDIndex</span>
1711 <span class="comment">%    OCS.IncrementalFlag = 'Yes'/'No'</span>
1712 <span class="comment">%    OCS.BPMWeight</span>
1713 <span class="comment">%    OCS.Flags = { 'FitRF' , etc.  }</span>
1714         OCSx.BPM = getx(BPMlist1, <span class="string">'struct'</span>);
1715         OCSx.CM = getsp(<span class="string">'HCM'</span>, HCMlist1, <span class="string">'struct'</span>);
1716         OCSx.GoalOrbit = getgolden(OCSx.BPM, <span class="string">'numeric'</span>);
1717         OCSx.NIter = 1;
1718         OCSx.SVDIndex = Xivec;
1719         OCSx.IncrementalFlag = <span class="string">'No'</span>;
1720         OCSx.FitRF = 1;
1721         OCSy.BPM = gety(BPMlist1, <span class="string">'struct'</span>);
1722         OCSy.CM = getsp(<span class="string">'VCM'</span>, VCMlist1, <span class="string">'struct'</span>);
1723         OCSy.GoalOrbit = getgolden(OCSy.BPM, <span class="string">'numeric'</span>);
1724         OCSy.NIter = 1;
1725         OCSy.SVDIndex = Yivec;
1726         OCSy.IncrementalFlag = <span class="string">'No'</span>;
1727         OCSy.FitRF = 0;
1728 
1729         <span class="comment">% Save vectors</span>
1730         FB.OCSx = OCSx;
1731         FB.OCSy = OCSy;
1732 
1733         FB.BPMlist1 = BPMlist1;
1734         FB.HCMlist1 = HCMlist1;
1735         FB.VCMlist1 = VCMlist1;
1736         FB.Xivec = Xivec;
1737         FB.Yivec = Yivec;
1738         FB.Xgoal = OCSx.GoalOrbit;
1739         FB.Ygoal = OCSy.GoalOrbit;
1740         FB.RFCorrFlag = RFCorrFlag;
1741         FB.LocalBumplist = LocalBumplist;
1742         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Userdata'</span>,FB);
1743         
1744         
1745     <span class="keyword">case</span> <span class="string">'Feedback'</span>
1746 
1747         FBloopIter = 1;
1748         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxFOFB'</span>),<span class="string">'Value'</span>) == 1
1749             StartFOFBFlag = 1;
1750         <span class="keyword">else</span>
1751             StartFOFBFlag = 0;
1752         <span class="keyword">end</span>
1753 
1754         FEEDBACK_STOP_FLAG = 0;
1755         HWarnNum=0;
1756         VWarnNum=0;
1757 
1758         SR_GeV = getenergy;
1759         <span class="comment">% Feedback loop setup</span>
1760         PlotInfoFlag = 0;           <span class="comment">% Plot micado stuff</span>
1761         LoopDelay = 1.0;           <span class="comment">% Period of feedback loop [seconds], make sure the BPM averaging is correct</span>
1762         VCM_LSB = .00366211;
1763         VCMCHICANE_LSB = .002441;   <span class="comment">% 80 max?,  Note: not fully implemented</span>
1764 
1765         <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
1766             Xgain  = 0.2;
1767             Ygain  = 0.1;
1768         <span class="keyword">else</span>
1769             Xgain  = 0.8; <span class="comment">% raised 0.5-&gt;0.8 at 17:20, 3-2-05 to more quickly correct EPU4 fast switching orbit distortions</span>
1770             Ygain  = 0.8;
1771         <span class="keyword">end</span>
1772 
1773         <span class="comment">% Load lattice set for tune feed forward</span>
1774         ConfigSetpoint = getproductionlattice;
1775         <span class="comment">%load([getfamilydata('Directory','OpsData') getfamilydata('OpsData','LatticeFile')]);</span>
1776         QFsp = ConfigSetpoint.QF.Setpoint.Data;
1777         QDsp = ConfigSetpoint.QD.Setpoint.Data;
1778         TuneW16Min = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(5, 13.23, 1.8909);
1779         <span class="comment">% Tune response matrix</span>
1780         SR_TUNE_MATRIX = gettuneresp({<span class="string">'QF'</span>,<span class="string">'QD'</span>}, {[],[]}, getenergy(<span class="string">'Production'</span>));    <span class="comment">% Approx. [0.1944 -0.0286;-0.1182 0.1526];</span>
1781         <span class="comment">%SR_TUNE_MATRIX = [0.1641 -0.0245</span>
1782         <span class="comment">%                 -0.1149 0.1477];</span>
1783 
1784         <span class="comment">% ID tune compensation does not work in the injection lattice, so ...</span>
1785         <span class="keyword">if</span> abs(SR_GEV - <a href="bend2gev.html" class="code" title="function GeV = bend2gev(varargin)">bend2gev</a>)&gt;  0.05     <span class="comment">% Don't use this routine for the injection lattice</span>
1786             fprintf(<span class="string">'   This routine should only be used for the production energy: Orbit feedback aborted\n'</span>);
1787             <span class="keyword">return</span>
1788         <span class="keyword">end</span>
1789 
1790         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1791 
1792         <span class="keyword">try</span>
1793             fprintf(<span class="string">'\n'</span>);
1794             fprintf(<span class="string">'   *******************************\n'</span>);
1795             fprintf(<span class="string">'   **  Starting Orbit Feedback  **\n'</span>);
1796             fprintf(<span class="string">'   *******************************\n'</span>);
1797             a = clock;
1798             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1799             fprintf(<span class="string">'   Note: the Matlab command window will be used to display status information.\n'</span>);
1800             fprintf(<span class="string">'         It cannot be used to enter commands during slow orbit feedback.\n'</span>);
1801 
1802 
1803             <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
1804             disp(<span class="string">'   IDBPM time constant set to 0.2s.'</span>)
1805             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.2)
1806             pause(1.1);
1807 
1808             <span class="comment">% Check whether bumps and kickers are on and warn to turn off before starting feedback if necessary</span>
1809             <span class="keyword">try</span>
1810                 <span class="keyword">if</span> (getsp(<span class="string">'SR01S___BUMP1__BC21'</span>)==1 &amp; getsp(<span class="string">'SR01S___BUMP1P_BC22'</span>)==1) | (getsp(<span class="string">'SR01S___SEK____BC21'</span>)==1 &amp; getsp(<span class="string">'SR01S___SEK_P__BC23'</span>)==1) | (getsp(<span class="string">'SR01S___SEN____BC20'</span>)==1 &amp; getsp(<span class="string">'SR01S___SEN_P__BC22'</span>)==1)
1811                     soundtada;
1812                     fprintf(<span class="string">'   \n'</span>);
1813                     fprintf(<span class="string">'   *********************************************************************************\n'</span>);
1814                     fprintf(<span class="string">'   ** One or more of the pulsed SR injection magnets is still on!  Turn them off! **\n'</span>);
1815                     fprintf(<span class="string">'   *********************************************************************************\n'</span>);
1816                     fprintf(<span class="string">'   \n'</span>);
1817                 <span class="keyword">end</span>
1818             <span class="keyword">catch</span>
1819                 disp(<span class="string">'**Problem checking the state of the bumps and kickers - please check that they are not pulsing.'</span>);
1820             <span class="keyword">end</span>
1821 
1822             <span class="comment">% Get vectors</span>
1823 
1824             <span class="comment">% is there a need to set these up? (we do later calls to FB.OCSx..., not the bare OCSx...) %</span>
1825             <span class="comment">%            OCSx = FB.OCSx;</span>
1826             <span class="comment">%            OCSy = FB.OCSy;</span>
1827 
1828             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
1829 
1830             BPMlist1 = FB.OCSx.BPM.DeviceList;
1831             <span class="comment">% FOFB_BPMlist =</span>
1832             HCMlist1 = FB.HCMlist1;
1833             VCMlist1 = FB.VCMlist1;
1834             Xivec = FB.Xivec;
1835             Yivec = FB.Yivec;
1836             Xgoal = FB.OCSx.GoalOrbit;
1837             Ygoal = FB.OCSy.GoalOrbit;
1838             FFTypeFlag = FB.FFTypeFlag;   <span class="comment">%local or global tune correction</span>
1839 
1840             iNotHCMChicane = find(HCMlist1(:,2) &lt; 10); <span class="comment">%used by steppv's for setting correctors in loop</span>
1841             iHCMChicane = find(HCMlist1(:,2) == 10);
1842             iNotVCMChicane = find(VCMlist1(:,2) &lt; 10);
1843             iVCMChicane = find(VCMlist1(:,2) == 10);
1844 
1845             <span class="comment">% Sensitivity matrix for setting fast feedback setpoints</span>
1846             Sx1 = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
1847             Sy1 = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
1848 
1849             <span class="comment">% Sx3 = getrespmat('BPMx', BPMlist1, 'HQMOFM', [1 1], [], SR_GEV);</span>
1850             <span class="comment">% Sy3 = getrespmat('BPMy', BPMlist1, 'HQMOFM', [1 1], [], SR_GEV);</span>
1851 
1852         <span class="keyword">catch</span>
1853             fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
1854 
1855             <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
1856             disp(<span class="string">'   IDBPM time constant set to 0.25s.'</span>)
1857             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.25)
1858 
1859 
1860             a = clock;
1861             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1862             fprintf(<span class="string">'   *************************************************************\n'</span>);
1863             fprintf(<span class="string">'   **  Orbit feedback could not start due to error condition  **\n'</span>);
1864             fprintf(<span class="string">'   *************************************************************\n\n'</span>);
1865             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1866             pause(0);
1867 
1868             <span class="keyword">return</span>
1869         <span class="keyword">end</span>
1870 
1871         StartFlag = questdlg(strvcat(<span class="string">''</span>,<span class="string">'Is it OK to start orbit feedback?'</span>),<span class="string">'Orbit Feedback'</span>,<span class="string">'Yes'</span>,<span class="string">'No'</span>,<span class="string">'No'</span>);
1872         <span class="keyword">if</span> strcmp(StartFlag,<span class="string">'No'</span>)
1873             <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
1874             disp(<span class="string">'   IDBPM time constant set to 0.25s.'</span>)
1875             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.25)
1876 
1877             a = clock;
1878             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1879             fprintf(<span class="string">'   ***************************\n'</span>);
1880             fprintf(<span class="string">'   **  Orbit Feedback Exit  **\n'</span>);
1881             fprintf(<span class="string">'   ***************************\n\n'</span>);
1882             pause(0);
1883             <span class="keyword">return</span>
1884         <span class="keyword">end</span>
1885 
1886         SR_STATE_OLD = scaget(<span class="string">'SR_STATE'</span>);
1887         setpv(<span class="string">'SR_STATE'</span>, 5);
1888         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1889         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1890         <span class="keyword">if</span> StateNumber &gt;= 0
1891             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1892         <span class="keyword">else</span>
1893             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1894         <span class="keyword">end</span>
1895         fprintf(<span class="string">'   Using %d E-vectors horizontally.\n'</span>, length(Xivec));
1896         fprintf(<span class="string">'   Using %d E-vectors vertically.\n'</span>,   length(Yivec));
1897         fprintf(<span class="string">'   Starting slow orbit correction every %.1f seconds.\n'</span>, LoopDelay);
1898         <span class="comment">%  fprintf('   Resetting SR11 chicane motors every 20 seconds to fix drift problem.\n');</span>
1899 
1900         IDSector = getlist(<span class="string">'ID'</span>);
1901 
1902         <span class="keyword">try</span>
1903 
1904             <span class="comment">% Get and display data</span>
1905             x = FB.OCSx.GoalOrbit - getx(FB.OCSx.BPM.DeviceList);
1906             y = FB.OCSy.GoalOrbit - gety(FB.OCSy.BPM.DeviceList);
1907             STDx = norm(x)/sqrt(length(x));
1908             STDy = norm(y)/sqrt(length(y));
1909             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = %.4f mm'</span>,STDx),<span class="string">'ForegroundColor'</span>,[0 0 0]);
1910             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = %.4f mm'</span>,STDy),<span class="string">'ForegroundColor'</span>,[0 0 0]);
1911 
1912             <span class="comment">% write goldenorbit values to Fast Orbit Feedback</span>
1913             <span class="keyword">try</span>
1914                 <a href="write_goldenorbit_ffb.html" class="code" title="function write_goldenorbit_ffb">write_goldenorbit_ffb</a>;
1915             <span class="keyword">catch</span>
1916                 disp(<span class="string">'write_goldenorbit_ffb did not work!'</span>);
1917             <span class="keyword">end</span>
1918             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
1919             pause(0);
1920 
1921         <span class="keyword">catch</span>
1922 
1923             fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
1924 
1925             <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
1926             disp(<span class="string">'   IDBPM time constant set to 0.25s.'</span>)
1927             <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.25);
1928 
1929 
1930             a = clock;
1931             fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
1932             fprintf(<span class="string">'   *************************************************************\n'</span>);
1933             fprintf(<span class="string">'   **  Orbit feedback could not start due to error condition  **\n'</span>);
1934             fprintf(<span class="string">'   *************************************************************\n\n'</span>);
1935 
1936             setpv(<span class="string">'SR_STATE'</span>,SR_STATE_OLD);
1937             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
1938             <span class="keyword">if</span> StateNumber &gt;= 0
1939                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
1940             <span class="keyword">else</span>
1941                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
1942             <span class="keyword">end</span>
1943             set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
1944             pause(0);
1945 
1946             <span class="keyword">return</span>
1947 
1948         <span class="keyword">end</span>
1949 
1950 
1951         <span class="comment">% Disable buttons</span>
1952         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'on'</span>);
1953         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1954         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
1955         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1956         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1957         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1958         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1959         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1960         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1961         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1962         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1963         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1964         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1965         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
1966         pause(0);
1967 
1968 
1969         <span class="comment">% Initialize feedback loop</span>
1970         StartTime = gettime;
1971         StartErrorTime = gettime;
1972         Xold = getx(FB.OCSx.BPM.DeviceList);
1973         Yold = gety(FB.OCSy.BPM.DeviceList);
1974         HQMOFM_stalenum = 0;
1975         pause(LoopDelay);
1976 
1977         N_HCM = size(HCMlist1,1);
1978         N_VCM = size(VCMlist1,1);
1979 
1980         N_RFMO = 1;
1981         
1982         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
1983             [FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,<span class="string">'SetRF'</span>,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1984         <span class="keyword">else</span>
1985             [FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1986         <span class="keyword">end</span>
1987         [FB.OCSx, Smatx, Sx, Ux, Vx] = orbitcorrectionmethods(FB.OCSx);
1988             
1989         [FB.OCSy, junk, OCSy0] = setorbit(FB.OCSy,<span class="string">'Nodisplay'</span>,<span class="string">'Nosetsp'</span>);
1990         [FB.OCSy, Smaty, Sy, Uy, Vy] = orbitcorrectionmethods(FB.OCSy);
1991 
1992      
1993         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
1994         <span class="comment">% Start feedback loop %</span>
1995         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
1996 
1997         <span class="comment">% chicaneloop=1;  % loop variable for resetting drifting chicanes (see a few lines below)</span>
1998         <span class="comment">% fftest=figure;</span>
1999 
2000         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2); <span class="comment">% put FOFB in open loop so beamnoise gets recorded even if FOFB is not enabled</span>
2001 
2002         <span class="keyword">while</span> 1
2003             <span class="keyword">try</span>
2004                 t00 = gettime;
2005 
2006                 <span class="comment">%          if chicaneloop==20 % reset SR11 motor chicane setpoints every 20s due to drifting positions</span>
2007                 <span class="comment">%             setsp('HCMCHICANEM',HCMCHICANEMsp(6),[11 1],0);</span>
2008                 <span class="comment">%             setsp('HCMCHICANEM',HCMCHICANEMsp(7),[11 2],0);</span>
2009                 <span class="comment">%             chicaneloop = 1;</span>
2010                 <span class="comment">%          else</span>
2011                 <span class="comment">%             chicaneloop = chicaneloop + 1;</span>
2012                 <span class="comment">%          end</span>
2013 
2014                 <span class="comment">% Check if GUI has been closed</span>
2015                 <span class="keyword">if</span> isempty(gcbf)
2016                     FEEDBACK_STOP_FLAG = 1;
2017                     lasterr(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2018                     error(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2019                 <span class="keyword">end</span>
2020 
2021                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2022                 <span class="comment">% Fast orbit feedback %</span>
2023                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%</span>
2024                 <span class="keyword">if</span> StartFOFBFlag == 1 &amp; FBloopIter &gt; 3
2025                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2026                     pause(0.5);
2027                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,1);
2028                     StartFOFBFlag = 0;
2029                     pause(1);
2030                     FOFBOnStatus = [getpv(<span class="string">'SR01____FFBON__BM00'</span>) getpv(<span class="string">'SR02____FFBON__BM00'</span>) getpv(<span class="string">'SR03____FFBON__BM00'</span>)<span class="keyword">...</span>
2031                         getpv(<span class="string">'SR04____FFBON__BM00'</span>) getpv(<span class="string">'SR05____FFBON__BM00'</span>) getpv(<span class="string">'SR06____FFBON__BM00'</span>)<span class="keyword">...</span>
2032                         getpv(<span class="string">'SR07____FFBON__BM00'</span>) getpv(<span class="string">'SR08____FFBON__BM00'</span>) getpv(<span class="string">'SR09____FFBON__BM00'</span>)<span class="keyword">...</span>
2033                         getpv(<span class="string">'SR10____FFBON__BM00'</span>) getpv(<span class="string">'SR11____FFBON__BM00'</span>) getpv(<span class="string">'SR12____FFBON__BM00'</span>)];
2034                     <span class="keyword">if</span> any(FOFBOnStatus==0) | any(FOFBOnStatus==2)
2035                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2); <span class="comment">% open FOFB loop</span>
2036                         disp(<span class="string">'************************************************************************************************************'</span>);
2037                         disp(<span class="string">'** Problem turning on Fast Orbit Feedback system...                                                       **'</span>);
2038                         disp(<span class="string">'** Check status of ffbsecXX crates - but remember that a crate reboot will turn off Quads in that sector! **'</span>);
2039                         disp(<span class="string">'** Suggest disabling the &quot;Fast Orbit Correction&quot; checkbox and starting Orbit Feedback again.              **'</span>);
2040                         disp(<span class="string">'************************************************************************************************************'</span>);
2041                     <span class="keyword">else</span>
2042                         fprintf(<span class="string">'   Starting Fast Orbit Feedback at %.0f Hz.\n'</span>, getpv(<span class="string">'SR01____FFBFREQAM00'</span>));
2043                     <span class="keyword">end</span>
2044                 <span class="keyword">end</span>
2045 
2046 
2047                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2048                 <span class="comment">% Horizontal plane &quot;feedback&quot; %</span>
2049                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2050 
2051                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxSOFB'</span>),<span class="string">'Value'</span>) == 1
2052 
2053                     <span class="comment">% Get orbit and check that the BPMs are different from the last update</span>
2054                     Xnew = getx(FB.OCSx.BPM.DeviceList);
2055 
2056                     <span class="comment">% Don't feedback if the current is too small</span>
2057                     <span class="keyword">if</span> getdcct &lt; 5
2058                         FEEDBACK_STOP_FLAG = 1;
2059                         fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2060                         <span class="keyword">break</span>;
2061                     <span class="keyword">end</span>
2062 
2063                     x = Xgoal - Xnew;
2064                     STDx = norm(x)/sqrt(length(x));
2065 
2066                     <span class="keyword">if</span> any(Xold == Xnew)
2067                         a = clock;
2068                         N_Stale_Data_Points = find((Xold==Xnew)==1);
2069                         <span class="keyword">for</span> loop = N_Stale_Data_Points'
2070                             fprintf(<span class="string">'   Stale data: BPMx(%2d,%d), feedback step skipped (%s %d:%d:%.0f). \n'</span>, FB.OCSx.BPM.DeviceList(loop,1), FB.OCSx.BPM.DeviceList(loop,2), date, a(4), a(5), a(6));
2071                         <span class="keyword">end</span>
2072                     <span class="keyword">else</span>
2073                         <span class="comment">% Compute horizontal correction</span>
2074 
2075                         <span class="comment">%%%OCSx0 = FB.OCSx;</span>
2076                         FB.OCSx.BPM.Data = Xnew;
2077                         FB.OCSx = orbitcorrectionmethods(FB.OCSx, Smatx, Sx, Ux, Vx);
2078 
2079                         <span class="comment">%%%[FB.OCSx, RF, OCSx0] = setorbit(FB.OCSx,'Nodisplay','Nosetsp');</span>
2080 
2081                         <span class="comment">% reduced feedback gain (implemented by Greg Portmann, December 2000)</span>
2082                         <span class="comment">% reduced to 0.1, C. Steier, 2001-09-04, IDBPMs are noisy at the moment</span>
2083                         <span class="comment">% increased back to 0.8 C. Steier, 2001-09-29, IDBPMs filtering + direct DAC read/write + all SVDs (no arc BPMs)</span>
2084                         <span class="comment">% increased to 1.0, C. Steier, 2002-05-04, trim DACs</span>
2085                         X = Xgain .* FB.OCSx.CM.Delta;
2086                         X(N_HCM+1) = 0.3*FB.OCSx.DeltaRF/4.988e-3;
2087                         <span class="comment">%%%X = Xgain .* (FB.OCSx.CM.Data - OCSx0.CM.Data);</span>
2088 
2089                         <span class="comment">% check for trim values+next step values, warn or stop FB as necessary</span>
2090                         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2091                         <span class="comment">% need to extract Chicanes from this comparison or maybe check them first for range %</span>
2092                         <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2093                         HCMtrimSP=getpv(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1);
2094                         HCMtrimSP_next = HCMtrimSP + X(1:N_HCM);                        
2095                         <span class="keyword">if</span> max(abs(HCMtrimSP_next)) &gt; 4
2096                             HCMtrimnum=find(abs(HCMtrimSP_next) &gt; 4);
2097 
2098                             <span class="comment">% print message to screen</span>
2099                             fprintf(<span class="string">'**One or more of the horizontal correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2100                             fprintf(<span class="string">'%s\n'</span>,datestr(now));
2101                             <span class="keyword">for</span> loop = HCMtrimnum'
2102                                 fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1(loop,:)));
2103                             <span class="keyword">end</span>
2104 
2105                             <span class="comment">% send alphapage to operator pager</span>
2106                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2107                             FEEDBACK_STOP_FLAG = 1;
2108 
2109                             setpv(<span class="string">'SR_STATE'</span>, -5);
2110                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2111                             <span class="keyword">if</span> StateNumber &gt;= 0
2112                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2113                             <span class="keyword">else</span>
2114                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2115                             <span class="keyword">end</span>
2116                         <span class="keyword">end</span>
2117 
2118                         <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2119                             <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2120                             <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2121                                 disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2122                             <span class="keyword">end</span>
2123                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2124                             pause(0.5);
2125                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2126                             <span class="keyword">break</span>;
2127                         <span class="keyword">end</span>
2128 
2129                         <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2130                         pause(0);
2131 
2132                         <span class="keyword">if</span> max(abs(HCMtrimSP_next) &gt; 3)
2133                             HCMtrimnum=find(abs(HCMtrimSP_next) &gt; 3);
2134                             HWarnNum=HWarnNum+1;
2135                             <span class="keyword">if</span> (HWarnNum==1 | rem(HWarnNum,120)==0)
2136 
2137                                 <span class="comment">% print message to screen every two minutes</span>
2138                                 fprintf(<span class="string">'**One or more of the horizontal corrector trims is above 3A or below -3A! \n'</span>);
2139                                 fprintf(<span class="string">'%s\n'</span>,datestr(now));
2140                                 <span class="keyword">for</span> loop = HCMtrimnum'
2141                                     fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>,HCMlist1(loop,:)));
2142                                 <span class="keyword">end</span>
2143                                 fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2144 
2145                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2146                                 <span class="keyword">if</span> (HWarnNum==1 | HWarnNum==600)
2147                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageHCM.txt
2148                                 <span class="keyword">end</span>
2149                             <span class="keyword">end</span>
2150                         <span class="keyword">else</span>
2151                             HWarnNum=0;
2152                         <span class="keyword">end</span>
2153 
2154                         <span class="comment">% Don't feedback if the current is too small</span>
2155                         <span class="keyword">if</span> getdcct &lt; 5
2156                             FEEDBACK_STOP_FLAG = 1;
2157                             fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2158                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/beamisoff.txt
2159                             <span class="keyword">break</span>;
2160                         <span class="keyword">end</span>
2161 
2162                         <span class="keyword">if</span> N_HCM &gt; 0
2163                             steppv(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>, X(iNotHCMChicane), HCMlist1(iNotHCMChicane,:), 0);
2164                             steppv(<span class="string">'HCM'</span>,<span class="string">'Setpoint'</span>, X(iHCMChicane), HCMlist1(iHCMChicane,:), 0);
2165                         <span class="keyword">end</span>
2166 
2167                         <span class="comment">% write fast orbit feedback setpoints</span>
2168                         <span class="keyword">if</span> 1
2169                             <span class="comment">%write_goldenorbit_ffb_2planes(1, Xnew(1:size(BPMlist1,1))+Sx1*X(1:N_HCM)+Sx3*X(length(X))/20, BPMlist1);</span>
2170                             <span class="comment">% should be corrected to include result of next frequency step ...</span>
2171                             <a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>(1,Xnew(1:size(BPMlist1,1))+Sx1*X(1:N_HCM),BPMlist1);
2172                         <span class="keyword">end</span>
2173 
2174                         <span class="comment">%fprintf('Horizontal Done: %f \n',gettime-t00);</span>
2175 
2176                         <span class="comment">% RF feedback</span>
2177                         HQMOFMsp_last = getpv(<span class="string">'EG______HQMOFM_AC01'</span>);
2178 
2179                         <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
2180                             <span class="keyword">if</span> N_RFMO &gt; 0
2181                                 <span class="keyword">if</span> abs(X(end)/3) &lt; .01
2182                                 <span class="comment">% if abs(FB.OCSx.DeltaRF/3) &lt; .01</span>
2183                                     steppv(<span class="string">'EG______HQMOFM_AC01'</span>, X(end));
2184                                 <span class="keyword">else</span>
2185                                     steppv(<span class="string">'EG______HQMOFM_AC01'</span>, 0.01*sign(X(end)));
2186                                 <span class="keyword">end</span>
2187                             <span class="keyword">end</span>
2188 
2189                             HQMOFMsp_now = getpv(<span class="string">'EG______HQMOFM_AC01'</span>);
2190 
2191                             <span class="comment">% Check for stale RF feedback</span>
2192                             <span class="keyword">if</span> HQMOFMsp_last == HQMOFMsp_now
2193                                 HQMOFM_stalenum = HQMOFM_stalenum + 1;
2194                                 <span class="keyword">if</span> HQMOFM_stalenum == 30 <span class="comment">% warn and message to pager if stale for 30 secs</span>
2195                                     fprintf(<span class="string">'**The RF is not responding to orbit feedback changes! \n'</span>);
2196                                     fprintf(<span class="string">'%s\n'</span>,datestr(now));
2197                                     fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2198                                     fprintf(<span class="string">'**ILC 73 controls the EG______HQMOFM_AC01 channel, which sets the RF frequency. \n'</span>);
2199                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstaleRFmessage.txt
2200                                 <span class="keyword">end</span>
2201                                 <span class="keyword">if</span> rem(HQMOFM_stalenum,120)==0 <span class="comment">% message to screen every 2 minutes</span>
2202                                     fprintf(<span class="string">'**The RF is not responding to orbit feedback changes! (%s)\n'</span>,datestr(now));
2203                                 <span class="keyword">end</span>
2204                             <span class="keyword">else</span>
2205                                 HQMOFM_stalenum = 0;
2206                             <span class="keyword">end</span>
2207 
2208                         <span class="keyword">end</span>
2209 
2210                         <span class="comment">%fprintf('RF Done: %f \n',gettime-t00);</span>
2211 
2212                         Xold = Xnew;
2213                     <span class="keyword">end</span> <span class="comment">% End horizontal correction</span>
2214 
2215 
2216                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2217                     <span class="comment">% Vertical plane &quot;feedback&quot; %</span>
2218                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2219 
2220                     <span class="comment">% Get orbit and check that the BPMs are different from the last update</span>
2221                     Ynew = gety(FB.OCSy.BPM.DeviceList);
2222 
2223                     <span class="comment">% Don't feedback if the current is too small</span>
2224                     <span class="keyword">if</span> getdcct &lt; 5
2225                         FEEDBACK_STOP_FLAG = 1;
2226                         fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2227                         <span class="keyword">break</span>;
2228                     <span class="keyword">end</span>
2229 
2230                     y = Ygoal - Ynew;
2231                     STDy = norm(y)/sqrt(length(y));
2232 
2233                     <span class="keyword">if</span> any(Yold == Ynew)
2234                         a = clock;
2235                         N_Stale_Data_Points = find((Yold==Ynew)==1);
2236                         <span class="keyword">for</span> loop = N_Stale_Data_Points'
2237                             fprintf(<span class="string">'   Stale data: BPMy(%2d,%d), feedback step skipped (%s %d:%d:%.0f). \n'</span>, FB.OCSy.BPM.DeviceList(loop,1), FB.OCSy.BPM.DeviceList(loop,2), date, a(4), a(5), a(6));
2238                         <span class="keyword">end</span>
2239 
2240                     <span class="keyword">else</span>
2241 
2242                         <span class="comment">% Compute vertical correction</span>
2243                         <span class="comment">%%%OCSy0 = FB.OCSy;</span>
2244                         FB.OCSy.BPM.Data = Ynew;
2245                         FB.OCSy = orbitcorrectionmethods(FB.OCSy, Smaty, Sy, Uy, Vy);
2246 
2247                         <span class="comment">%%%[FB.OCSy, RF, OCSy0] = setorbit(FB.OCSy,'Nodisplay','Nosetsp');</span>
2248 
2249                         <span class="comment">% reduced feedback gain, C. Steier, 2001-03-25</span>
2250                         <span class="comment">% reduced to 0.1, C. Steier, 2001-09-04, IDBPMs are noisy at the moment</span>
2251                         <span class="comment">% increased back to 0.8, C. Steier, 2001-09-29, IDBPMs filtering + direct DAC read/write + all SVDs (no arc BPMs)</span>
2252                         <span class="comment">% set to unity gain, C. Steier, 2002-05-04, trim DACs</span>
2253                         Y = Ygain .* FB.OCSy.CM.Delta;
2254                         <span class="comment">%%%Y = Ygain .* (FB.OCSy.CM.Data - OCSy0.CM.Data);</span>
2255 
2256                         <span class="comment">% Just SVD correction</span>
2257                         <span class="comment">% warning('Not using &quot;micado&quot; correction in the vertical plane.');</span>
2258 
2259                         <span class="comment">% check for trim values+next step values, warn or stop FB as necessary</span>
2260                         VCMtrimSP = getpv(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1);
2261                         VCMtrimSP_next = VCMtrimSP + Y(1:N_VCM);
2262                         <span class="keyword">if</span> max(abs(VCMtrimSP_next)) &gt; 12
2263                             VCMtrimnum=find(abs(VCMtrimSP_next) &gt; 12);
2264 
2265                             <span class="comment">% print message to screen</span>
2266                             fprintf(<span class="string">'**One or more of the vertical correctors is at its maximum!! Stopping orbit feedback. \n'</span>);
2267                             fprintf(<span class="string">'%s\n'</span>,datestr(now));
2268                             <span class="keyword">for</span> loop = VCMtrimnum'
2269                                 fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1(loop,:)));
2270                             <span class="keyword">end</span>
2271 
2272                             <span class="comment">% send alphapage to operator pager</span>
2273                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2274                             FEEDBACK_STOP_FLAG = 1;
2275 
2276                             setpv(<span class="string">'SR_STATE'</span>, -5);
2277                             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2278                             <span class="keyword">if</span> StateNumber &gt;= 0
2279                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2280                             <span class="keyword">else</span>
2281                                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2282                             <span class="keyword">end</span>
2283                         <span class="keyword">end</span>
2284 
2285                         <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2286                             <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2287                             <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2288                                 disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2289                             <span class="keyword">end</span>
2290                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2291                             pause(0.5);
2292                             setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2293                             <span class="keyword">break</span>;
2294                         <span class="keyword">end</span>
2295 
2296                         <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2297                         <span class="comment">% pause(0);</span>
2298 
2299                         <span class="keyword">if</span> max(abs(VCMtrimSP_next) &gt; 4)
2300                             VCMtrimnum=find(abs(VCMtrimSP_next) &gt; 4);
2301                             VWarnNum=VWarnNum+1;
2302                             <span class="keyword">if</span> (VWarnNum==1 | rem(VWarnNum,120)==0)
2303 
2304                                 <span class="comment">% print message to screen every two minutes</span>
2305                                 fprintf(<span class="string">'**One or more of the vertical corrector trims is above 4A or below -4A! \n'</span>);
2306                                 fprintf(<span class="string">'%s\n'</span>,datestr(now));
2307                                 <span class="keyword">for</span> loop = VCMtrimnum'
2308                                     fprintf(<span class="string">'**%s is one of the problem correctors.\n'</span>,getname(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>,VCMlist1(loop,:)));
2309                                 <span class="keyword">end</span>
2310                                 fprintf(<span class="string">'**The orbit feedback is still working but this problem should be investigated. \n'</span>);
2311 
2312                                 <span class="comment">%send alphapage to operator pager the first time then at 10 minutes</span>
2313                                 <span class="keyword">if</span> (VWarnNum==1 | VWarnNum==600)
2314                                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBwarningmessageVCM.txt
2315                                 <span class="keyword">end</span>
2316                             <span class="keyword">end</span>
2317                         <span class="keyword">else</span>
2318                             VWarnNum=0;
2319                         <span class="keyword">end</span>
2320 
2321                         <span class="comment">% Don't feedback if the current is too small</span>
2322                         <span class="keyword">if</span> getdcct &lt; 5
2323                             FEEDBACK_STOP_FLAG = 1;
2324                             fprintf(<span class="string">'%s         Orbit feedback stopped due to low beam current (&lt;5mA)\n'</span>,datestr(now));
2325                             !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/beamisoff.txt
2326                             <span class="keyword">break</span>;
2327                         <span class="keyword">end</span>
2328 
2329                         <span class="keyword">if</span> N_VCM &gt; 0
2330                             steppv(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>, Y(iNotVCMChicane), VCMlist1(iNotVCMChicane,:), 0);
2331                             steppv(<span class="string">'VCM'</span>,<span class="string">'Setpoint'</span>, Y(iVCMChicane), VCMlist1(iVCMChicane,:), 0);
2332                         <span class="keyword">end</span>
2333 
2334                         <span class="comment">% write fast orbit feedback setpoints</span>
2335                         <span class="keyword">if</span> 1
2336                             <a href="write_goldenorbit_ffb_2planes.html" class="code" title="function write_goldenorbit_ffb_2planes(Plane, GoldenOrbit, BPMlist)">write_goldenorbit_ffb_2planes</a>(2,Ynew(1:size(BPMlist1,1))+Sy1*Y(1:N_VCM),BPMlist1);
2337                         <span class="keyword">end</span>
2338 
2339                     <span class="keyword">end</span>
2340 
2341                     Yold = Ynew;
2342 
2343                     <span class="comment">%fprintf('Vertical Done: %f \n',gettime-t00);</span>
2344                 <span class="keyword">end</span> <span class="comment">% End vertical correction</span>
2345 
2346 
2347                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
2348                 <span class="comment">% Tune feed forward %</span>
2349                 <span class="comment">%%%%%%%%%%%%%%%%%%%%%</span>
2350                 <span class="comment">% We should do a Sector limit check</span>
2351 
2352                
2353                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxTune'</span>),<span class="string">'Value'</span>) == 1
2354 
2355                     <span class="keyword">if</span> strcmp(SR_Mode, <span class="string">'1.9 GeV, High Tune'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Inject at 1.23'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Two-Bunch'</span>)
2356 
2357                         <span class="keyword">if</span> strcmp(FFTypeFlag,<span class="string">'Local'</span>)
2358                             disp(<span class="string">'  No local tune compensation available - global is the default now.'</span>);
2359                         <span class="keyword">elseif</span> strcmp(FFTypeFlag,<span class="string">'Global'</span>)
2360                             
2361                             addQFsp = zeros(24,1);
2362                             addQDsp = zeros(24,1);
2363                             <span class="comment">%The line below is for vectorized version of TuneFF code - other changes below not made yet</span>
2364                             <span class="comment">%actualgap = getid(IDSector);</span>
2365                             <span class="keyword">for</span> gapnum = 1:size(IDSector,1)
2366                                 <span class="comment">% Change in tune and [QF;QD] from maximum gap</span>
2367                                 actualgap = <a href="getid.html" class="code" title="function [Position, Velocity, RunFlag, UserGap] = getid(DeviceList, ChanType)">getid</a>(IDSector(gapnum,:));
2368                                 [gapmin,gapmax] = <a href="gaplimit.html" class="code" title="function [GAPmin, GAPmax] = gaplimit(Dev);">gaplimit</a>(IDSector(gapnum,:));
2369                                 <span class="keyword">if</span> actualgap &lt; (gapmin-1)
2370                                     actualgap = gapmax;
2371                                 <span class="keyword">end</span>
2372 
2373                                 <span class="keyword">if</span> (IDSector(gapnum,1) == 4) | (IDSector(gapnum,1) == 11)
2374                                     <span class="keyword">if</span> IDSector(gapnum,2) == 1
2375                                         modenamestr = sprintf(<span class="string">'SR%02dU___ODS1M__DC00'</span>,IDSector(gapnum,1));
2376                                     <span class="keyword">else</span> <span class="comment">% if IDSector(gapnum,2) == 2</span>
2377                                         modenamestr = sprintf(<span class="string">'SR%02dU___ODS2M__DC00'</span>,IDSector(gapnum,1));
2378                                     <span class="keyword">end</span>
2379                                     epumode = getpv(modenamestr);
2380                                     
2381                                     DelQF = zeros(24,1);
2382                                     DelQD = zeros(24,1);
2383                                     
2384                                     <span class="comment">% [DelQF, DelQD] = ...</span>
2385                                     <span class="comment">%      ffdeltaquadepu(IDSector(gapnum,:), actualgap, getepu(IDSector(gapnum,:)), epumode, SR_GeV);</span>
2386                                 <span class="keyword">else</span>
2387                                     <span class="comment">%[DelQF, DelQD] = ...</span>
2388                                     <span class="comment">%    ffdeltaquad(IDSector(gapnum,:), actualgap, SR_GeV);</span>
2389                                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2390                                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2391 
2392                                     <span class="comment">% Tune response matrix</span>
2393                                     <span class="comment">% gettuneresp is too slow for orbit feedback</span>
2394                                     <span class="comment">%TuneResponseMat = [0.1641 -0.0245</span>
2395                                     <span class="comment">%    -0.1149 0.1477];</span>
2396                                     <span class="comment">%TuneResponseMat = gettuneresp({'QF','QD'}, {[],[]}, GeV);</span>
2397                                     <span class="comment">%TuneResponseMat = gettuneresp;  %('NoEnergyScaling'); or scale at the operational energy</span>
2398 
2399                                     
2400                                     <span class="comment">% Initialize</span>
2401                                     DelQF  = zeros(length(QFsp), 1);
2402                                     DelQD  = zeros(length(QDsp), 1);
2403 
2404                                     <span class="keyword">if</span> strcmp(SR_Mode, <span class="string">'1.9 GeV, High Tune'</span>) ||  strcmp(SR_Mode, <span class="string">'1.9 GeV, Inject at 1.23'</span>) || strcmp(SR_Mode, <span class="string">'1.9 GeV, Two-Bunch'</span>)
2405 
2406                                         <span class="comment">% SR11 epu skew quadrupole feed forward</span>
2407                                         <span class="comment">% scale= -0.06;    % for nu_y = 8.20 lattice</span>
2408                                         <span class="comment">%               scale = -0.063;</span>
2409                                         <span class="comment">%               mid = ceil(length(epu_shift5)/2);</span>
2410 
2411                                         <span class="comment">%               if getsp('SR11U___ODS1M__DC00')==0</span>
2412                                         <span class="comment">%                  gap=getid(11);</span>
2413                                         <span class="comment">%                  shift=getepu(11);</span>
2414                                         <span class="comment">%                  [gapmin,gapmax] = gaplimit(11);</span>
2415                                         <span class="comment">%                  if gap &lt; (gapmin-1)</span>
2416                                         <span class="comment">%                     gap = gapmax;</span>
2417                                         <span class="comment">%                  end</span>
2418                                         <span class="comment">%                  corrval=sqrt(shift2tune(11,gap,25)/shift2tune(11,15.67,25))* ...</span>
2419                                         <span class="comment">%                     scale*interp1(epu_shift5,int_epu_grad5-int_epu_grad5(mid),shift,'spline');</span>
2420                                         <span class="comment">%                  setsp('SR11U___Q______AC01',corrval);</span>
2421                                         <span class="comment">%               end</span>
2422 
2423                                         <span class="keyword">if</span> strcmp(FFTypeFlag,<span class="string">'Local'</span>)
2424                                             <span class="comment">% Change in tune and [QF;QD] from maximum gap</span>
2425                                             DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap, SR_GeV);
2426                                             fraccorr = 1.15 * DeltaNuY / TuneW16Min;
2427 
2428                                             <span class="comment">% Find which quads to change</span>
2429                                             QuadList = [IDSector(gapnum,1)-1 1;IDSector(gapnum,1)-1 2;IDSector(gapnum,1) 1;IDSector(gapnum,1) 2];
2430                                             QuadElem = dev2elem(<span class="string">'QF'</span>, QuadList);
2431 
2432                                             <span class="keyword">if</span> (IDSector(gapnum,1)==7) | (IDSector(gapnum,1)==10) | (IDSector(gapnum,1)==11)
2433                                                 QFfac = ([2.227520/2.237111; 2.239570/2.237111; 2.239570/2.237111; 2.227520/2.237111]-1) * fraccorr;
2434                                                 QDfac = ([2.432264/2.511045; 2.543089/2.511045; 2.543080/2.511045; 2.432264/2.511045]-1) * fraccorr;
2435                                             <span class="keyword">elseif</span> (IDSector(gapnum,1)==5) | (IDSector(gapnum,1)==9)
2436                                                 QFfac = ([2.208418/2.219784; 2.225926/2.219784; 2.231777/2.237111; 2.233775/2.237111]-1) * fraccorr;
2437                                                 QDfac = ([2.386512/2.483259; 2.545907/2.483259; 2.474571/2.511045; 2.491079/2.511045]-1) * fraccorr;
2438                                             <span class="keyword">elseif</span> (IDSector(gapnum,1)==4) | (IDSector(gapnum,1)==8) | (IDSector(gapnum,1)==12)
2439                                                 QFfac = ([2.233775/2.237111; 2.231777/2.237111; 2.225926/2.219784; 2.208418/2.219784]-1) * fraccorr;
2440                                                 QDfac = ([2.491079/2.511045; 2.474571/2.511045; 2.545907/2.483259; 2.386512/2.483259]-1) * fraccorr;
2441                                             <span class="keyword">else</span>
2442                                                 QFfac = zeros(4,size(actualgap,2));
2443                                                 QDfac = zeros(4,size(actualgap,2));
2444                                             <span class="keyword">end</span>
2445 
2446                                             DelQF(QuadElem,:) = DelQF(QuadElem,:) + QFfac.*QFsp(QuadElem,:);
2447                                             DelQD(QuadElem,:) = DelQD(QuadElem,:) + QDfac.*QDsp(QuadElem,:);
2448 
2449                                         <span class="keyword">elseif</span> strcmp(FFTypeFlag,<span class="string">'Global'</span>)
2450                                             <span class="comment">% Change in tune and [QF;QD] from maximum gap</span>
2451 
2452                                             DeltaNuX = 0;
2453                                             DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap, SR_GeV);
2454 
2455                                             <span class="keyword">if</span> (IDSector(gapnum,1) == 4) | (IDSector(gapnum,1) == 11)
2456                                                 <span class="comment">% Remove sector 4 and 11 tune correction</span>
2457                                                 DeltaNuY = 0;
2458                                             <span class="keyword">end</span>
2459                                             <span class="comment">% if (IDSector(gapnum,1) == 4) | (IDSector(gapnum,1) == 11)</span>
2460                                             <span class="comment">%     if IDSector(i,:) == [11 1]</span>
2461                                             <span class="comment">%         modenamestr = sprintf('SR%02dU___ODS1M__DC00',IDSector(gapnum,1));</span>
2462                                             <span class="comment">%         longshift=3;</span>
2463                                             <span class="comment">%     elseif IDSector(i,:) == [11 2]</span>
2464                                             <span class="comment">%         modenamestr = sprintf('SR%02dU___ODS2M__DC00',IDSector(gapnum,1));</span>
2465                                             <span class="comment">%         longshift=3;</span>
2466                                             <span class="comment">%     else</span>
2467                                             <span class="comment">%         modenamestr = sprintf('SR%02dU___ODS1M__DC00',IDSector(gapnum,1));</span>
2468                                             <span class="comment">%         longshift=0;</span>
2469                                             <span class="comment">%     end</span>
2470                                             <span class="comment">%     if getsp(modenamestr)==0</span>
2471                                             <span class="comment">%         % DeltaNuX = shift2tune(IDSector,actualgap(i,:),getepu(IDSector)+longshift)+0.005;</span>
2472                                             <span class="comment">%         DeltaNuX = 0;   % problem with beam stability (instability/resonance?) with nu_x = 14.25 for EPU shift at 25 mm</span>
2473                                             <span class="comment">%         DeltaNuY = 0;   % correct vertical tune shift of EPUs is very small</span>
2474                                             <span class="comment">%     else</span>
2475                                             <span class="comment">%         DeltaNuX = 0;</span>
2476                                             <span class="comment">%         DeltaNuY = 0;</span>
2477                                             <span class="comment">%     end</span>
2478                                             <span class="comment">% else</span>
2479                                             <span class="comment">%     DeltaNuX = 0;</span>
2480                                             <span class="comment">% end</span>
2481 
2482 
2483                                             fraccorr = DeltaNuY ./ TuneW16Min;
2484 
2485                                             <span class="comment">% Find which quads to change</span>
2486                                             QuadList = [IDSector(gapnum,1)-1 2; IDSector(gapnum,1) 1];
2487                                             QuadElem = dev2elem(<span class="string">'QF'</span>,QuadList);
2488 
2489                                             DeltaAmps = inv(SR_TUNE_MATRIX) * [(fraccorr*6.23e-4)-DeltaNuX; fraccorr*(-0.05301)];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2490                                             <span class="comment">%             if IDSector(gapnum,1)==5</span>
2491                                             <span class="comment">%                 DeltaAmps</span>
2492                                             <span class="comment">%             end</span>
2493                                             DelQF = DelQF + DeltaAmps(1,:);
2494                                             DelQD = DelQD + DeltaAmps(2,:);
2495                                             <span class="comment">%DelQF = DelQF + (DeltaAmps(1,:)' * ones(1,size(DelQF,1)))';  % Not any faster</span>
2496                                             <span class="comment">%DelQD = DelQD + (DeltaAmps(2,:)' * ones(1,size(DelQD,1)))';</span>
2497 
2498                                             DeltaAmpsLocal = 12*inv(SR_TUNE_MATRIX) * [-DeltaNuX;0];                       <span class="comment">%  DelAmps =  [QF; QD];</span>
2499                                             DelQF(QuadElem) = DelQF(QuadElem)+DeltaAmpsLocal(1,1);
2500                                             DelQD(QuadElem) = DelQD(QuadElem)+DeltaAmpsLocal(2,1);
2501 
2502                                             <span class="keyword">if</span> (IDSector(gapnum,1)==6) | (IDSector(gapnum,1)==7) | (IDSector(gapnum,1)==10) | (IDSector(gapnum,1)==11)
2503                                                 QFfac = ([2.243127/2.237111; 2.243127/2.237111]-1) * fraccorr;
2504                                                 QDfac = ([2.556392/2.511045; 2.556392/2.511045]-1) * fraccorr;
2505                                             <span class="keyword">elseif</span> (IDSector(gapnum,1)==5) | (IDSector(gapnum,1)==9)
2506                                                 QFfac = ([2.225965/2.219784; 2.243096/2.237111]-1) * fraccorr;
2507                                                 QDfac = ([2.528950/2.483259; 2.556345/2.511045]-1) * fraccorr;
2508                                             <span class="keyword">elseif</span> (IDSector(gapnum,1)==4) | (IDSector(gapnum,1)==8) | (IDSector(gapnum,1)==12)
2509                                                 QFfac = ([2.243096/2.237111; 2.225965/2.219784]-1) * fraccorr;
2510                                                 QDfac = ([2.556345/2.511045; 2.528950/2.483259]-1) * fraccorr;
2511                                             <span class="keyword">else</span>
2512                                                 QFfac = zeros(2,size(actualgap,2));
2513                                                 QDfac = zeros(2,size(actualgap,2));
2514                                             <span class="keyword">end</span>
2515 
2516                                             DelQF(QuadElem,:) = DelQF(QuadElem,:) + QFfac.*QFsp(QuadElem,:);
2517                                             DelQD(QuadElem,:) = DelQD(QuadElem,:) + QDfac.*QDsp(QuadElem,:);
2518 
2519                                         <span class="keyword">else</span>
2520                                             error(<span class="string">'Unknown type selected for tune FF'</span>);
2521                                         <span class="keyword">end</span>
2522 
2523                                     <span class="keyword">else</span>
2524 
2525                                         <span class="comment">% SR11 epu skew quadrupole feed forward</span>
2526 
2527                                         <span class="comment">%               scale= -0.06;  % for nu_y = 8.20 lattice</span>
2528                                         <span class="comment">% scale = -0.063;  % for nu_y = 9.20 lattice</span>
2529                                         <span class="comment">%               mid = ceil(length(epu_shift5)/2);</span>
2530 
2531                                         <span class="comment">%               if getsp('SR11U___ODS1M__DC00')==0</span>
2532                                         <span class="comment">%                  gap=getid(11);</span>
2533                                         <span class="comment">%                  shift=getepu(11);</span>
2534                                         <span class="comment">%                  corrval=shift2tune(11,gap,25)/shift2tune(11,15.67,25)* ...</span>
2535                                         <span class="comment">%                     scale*interp1(epu_shift5,int_epu_grad5-int_epu_grad5(mid),shift,'spline');</span>
2536                                         <span class="comment">%                  setsp('SR11U___Q______AC01',corrval);</span>
2537                                         <span class="comment">%               end</span>
2538 
2539                                         <span class="comment">% Change in tune and [QF;QD] from maximum gap</span>
2540                                         DeltaNuY = <a href="gap2tune.html" class="code" title="function [Dnuy, Beff, Bmax, Lambda, IDLength, B10, B30, B50] = gap2tune(Sector, Gap, GeV, FitFlag)">gap2tune</a>(IDSector(gapnum,:), actualgap, SR_GeV);
2541 
2542                                         <span class="keyword">if</span> (IDSector(gapnum,1)==7) | (IDSector(gapnum,1)==10) | (IDSector(gapnum,1)==11)
2543                                             DeltaAmps = inv(SR_TUNE_MATRIX/12) * [zeros(size(DeltaNuY)); -DeltaNuY];    <span class="comment">%  DelAmps =  [QF; QD];</span>
2544                                             DeltaAmpsQF = [DeltaAmps(1,:); DeltaAmps(1,:)];
2545                                             DeltaAmpsQD = [DeltaAmps(2,:); DeltaAmps(2,:)];
2546                                         <span class="keyword">elseif</span> (IDSector(gapnum,1)==5) | (IDSector(gapnum,1)==9)
2547                                             DeltaAmpsQF = [-1.0637; -0.5132] * DeltaNuY / 0.0181 * 0.37;
2548                                             DeltaAmpsQD = [-6.6328; -3.3434] * DeltaNuY / 0.0181 * 0.37;
2549                                         <span class="keyword">elseif</span> (IDSector(gapnum,1)==4) | (IDSector(gapnum,1)==8) | (IDSector(gapnum,1)==12)
2550                                             DeltaAmpsQF = [-0.5132; -1.0637] * DeltaNuY / 0.0181 * 0.37;
2551                                             DeltaAmpsQD = [-3.3434; -6.6328] * DeltaNuY / 0.0181 * 0.37;
2552                                         <span class="keyword">else</span>
2553                                             DeltaAmpsQF = zeros(2,size(actualgap,2));
2554                                             DeltaAmpsQD = zeros(2,size(actualgap,2));
2555                                         <span class="keyword">end</span>
2556 
2557                                         <span class="comment">% Find which quads to change</span>
2558                                         QuadList = [IDSector(gapnum,1)-1 1;IDSector(gapnum,1) 2];
2559                                         QuadElem = dev2elem(<span class="string">'QF'</span>, QuadList);
2560 
2561                                         DelQF(QuadElem,:) = DelQF(QuadElem,:) + DeltaAmpsQF;
2562                                         DelQD(QuadElem,:) = DelQD(QuadElem,:) + DeltaAmpsQD;
2563                                     <span class="keyword">end</span>
2564                                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2565                                     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2566                                 <span class="keyword">end</span>
2567 
2568                                 <span class="comment">% if IDSector(gapnum,1)==5</span>
2569                                 <span class="comment">%     DelQF</span>
2570                                 <span class="comment">%     DelQD</span>
2571                                 <span class="comment">% end</span>
2572 
2573                                 addQFsp = addQFsp+DelQF;
2574                                 addQDsp = addQDsp+DelQD;
2575                             <span class="keyword">end</span>
2576                         <span class="keyword">else</span>
2577                             error(<span class="string">'Unknown type selected for tune FF'</span>);
2578                         <span class="keyword">end</span>
2579 
2580                         <span class="comment">% Set quadrupoles using main setpoint channels</span>
2581                         setpv(<span class="string">'QF'</span>, QFsp+addQFsp,[], 0);
2582                         setpv(<span class="string">'QD'</span>, QDsp+addQDsp,[], 0);
2583 
2584                         <span class="comment">%                         % Set quadrupoles using FF setpoint channels</span>
2585                         <span class="comment">%                         setpv('QF', 'FF', addQFsp, [], 0);</span>
2586                         <span class="comment">%                         setpv('QD', 'FF', addQDsp, [], 0);</span>
2587 
2588                     <span class="keyword">else</span>
2589                         disp(<span class="string">'  No tune FF algorithm for non-production modes yet...'</span>);
2590                     <span class="keyword">end</span>
2591                 <span class="keyword">end</span>
2592                 ffdeltaquad_delay = toc;
2593                 <span class="comment">%fprintf('tune FF delay = %.1f seconds\n',ffdeltaquad_delay);</span>
2594                 <span class="comment">% fprintf('Tune Done: %f \n',gettime-t00);</span>
2595 
2596                 <span class="comment">% Output info to screen</span>
2597                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = %.4f mm'</span>,STDx),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2598                 set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = %.4f mm'</span>,STDy),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2599                 pause(0);
2600 
2601 
2602                 <span class="comment">%fprintf('End of feedback operations: %f \n\n',gettime-t00);</span>
2603 
2604                 <span class="comment">% Wait for next update time or stop request</span>
2605                 <span class="keyword">while</span> (gettime-t00) &lt; LoopDelay
2606                     <span class="comment">%disp('interval could be shorter')</span>
2607                     pause(.05);
2608                     <span class="comment">% Check if GUI has been closed</span>
2609                     <span class="keyword">if</span> isempty(gcbf)
2610                         FEEDBACK_STOP_FLAG = 1;
2611                         lasterr(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2612                         error(<span class="string">'SRCONTROL GUI DISAPPEARED!'</span>);
2613                     <span class="keyword">end</span>
2614 
2615                     <span class="comment">% Check if Stop button was pressed</span>
2616                     <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2617                         <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2618                         <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2619                             disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2620                         <span class="keyword">end</span>
2621                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2622                         pause(0.5);
2623                         setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2624                         <span class="keyword">break</span>;
2625                     <span class="keyword">end</span>
2626                 <span class="keyword">end</span>
2627                 
2628 
2629                 <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2630                     <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2631                     <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2632                         disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2633                     <span class="keyword">end</span>
2634                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2635                     pause(0.5);
2636                     setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2637                     <span class="keyword">break</span>;
2638                 <span class="keyword">end</span>
2639 
2640                 StartErrorTime = gettime;
2641 
2642             <span class="keyword">catch</span>
2643 
2644                 fprintf(<span class="string">'\n  %s \n'</span>,lasterr);
2645 
2646                 <span class="comment">% Quit if error exists for more than 20 seconds</span>
2647                 <span class="keyword">if</span> gettime-StartErrorTime&gt;20 | FEEDBACK_STOP_FLAG==1
2648                     fprintf(<span class="string">'%s  Orbit feedback stopped due to error condition. \n\n'</span>,datestr(now));
2649 
2650                     <span class="comment">%send alphapage to operator pager</span>
2651                     !/usr/ucb/Mail 5108120447@mmode.com &lt; /home/als/physbase/machine/ALS/StorageRing/SOFBstoppedmessage.txt
2652                     FEEDBACK_STOP_FLAG = 1;
2653 
2654                     setpv(<span class="string">'SR_STATE'</span>, -5);
2655                     [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2656                     <span class="keyword">if</span> StateNumber &gt;= 0
2657                         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2658                     <span class="keyword">else</span>
2659                         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2660                     <span class="keyword">end</span>
2661                 <span class="keyword">else</span>
2662                     a = clock;
2663                     fprintf(<span class="string">'   Orbit feedback was paused due to error condition (%s %d:%d:%.0f). \n'</span>, date, a(4), a(5), a(6));
2664                     fprintf(<span class="string">'   Orbit feedback has automatically restarted and is running. \n\n'</span>);
2665                 <span class="keyword">end</span>
2666 
2667             <span class="keyword">end</span>
2668             
2669             <span class="keyword">if</span> FEEDBACK_STOP_FLAG == 1
2670                 <span class="comment">% turn off then open FOFB loop (turn off to transfer correctors, then open to enable logging</span>
2671                 <span class="keyword">if</span> getpv(<span class="string">'SR01____FFBON__BC00'</span>)==1
2672                     disp(<span class="string">'   Stopping Fast Orbit Feedback.'</span>);
2673                 <span class="keyword">end</span>
2674                 setpv(<span class="string">'SR01____FFBON__BC00'</span>,0);
2675                 pause(0.5);
2676                 setpv(<span class="string">'SR01____FFBON__BC00'</span>,2);
2677                 <span class="keyword">break</span>;
2678             <span class="keyword">end</span>
2679 
2680             <span class="comment">%fprintf('End of feedback loop: %f \n\n',gettime-t00);</span>
2681 
2682             <span class="comment">%pause(0);</span>
2683 
2684             <span class="comment">% this loop delays turn on of Fast Feedback system</span>
2685             <span class="keyword">if</span> FBloopIter &lt; 5
2686                 FBloopIter = FBloopIter + 1;
2687             <span class="keyword">end</span>
2688 
2689         <span class="keyword">end</span>  <span class="comment">% End of feedback loop</span>
2690 
2691 
2692         <span class="comment">% End feedback, reset all parameters</span>
2693         <span class="keyword">try</span>
2694 
2695             <span class="comment">% Enable buttons</span>
2696             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStart'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2697             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLPushbuttonStop'</span>),<span class="string">'Enable'</span>,<span class="string">'off'</span>);
2698             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton1'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2699             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton2'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2700             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButton3'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2701             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonChangeMode'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2702             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonSRState'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2703             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonGoldenPage'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2704             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrection'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2705             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonOrbitCorrectionSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2706             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2707             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2708             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLClose'</span>),<span class="string">'Enable'</span>,<span class="string">'on'</span>);
2709 
2710             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextHorizontal'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Horizontal RMS = _____ mm'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2711             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextVertical'</span>),<span class="string">'String'</span>,sprintf(<span class="string">'Vertical RMS = _____ mm'</span>),<span class="string">'ForegroundColor'</span>,[0 0 0]);
2712             pause(0);
2713 
2714         <span class="keyword">catch</span>
2715 
2716             <span class="comment">% GUI must have been closed</span>
2717 
2718         <span class="keyword">end</span>
2719 
2720 
2721         <span class="comment">% &gt;= 2 Hz update rate on IDBPMs</span>
2722         disp(<span class="string">'   IDBPM time constant set to 0.25s.'</span>);
2723         <a href="setbpmtimeconstant.html" class="code" title="function setbpmtimeconstant(BPMTimeConstant, DeviceList)">setbpmtimeconstant</a>(0.25);
2724 
2725 
2726         a = clock;
2727         fprintf(<span class="string">'   %s %d:%d:%.0f\n'</span>, date, a(4), a(5), a(6));
2728         [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2729         <span class="keyword">if</span> StateNumber &gt;= 0
2730             setpv(<span class="string">'SR_STATE'</span>,5.1);
2731             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2732             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'b'</span>);
2733             fprintf(<span class="string">'   ******************************\n'</span>);
2734             fprintf(<span class="string">'   **  Orbit Feedback Stopped  **\n'</span>);
2735             fprintf(<span class="string">'   ******************************\n\n'</span>);
2736         <span class="keyword">else</span>
2737             [StateNumber, StateString] = <a href="getsrstate.html" class="code" title="function [StateNumber, StateString] = getsrstate">getsrstate</a>;
2738             set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLStaticTextInformation'</span>),<span class="string">'String'</span>,StateString,<span class="string">'ForegroundColor'</span>,<span class="string">'r'</span>);
2739             fprintf(<span class="string">'   ****************************************\n'</span>);
2740             fprintf(<span class="string">'   **  Problem With Slow Orbit Feedback  **\n'</span>);
2741             fprintf(<span class="string">'   ****************************************\n\n'</span>);
2742         <span class="keyword">end</span>
2743         set(0,<span class="string">'showhiddenhandles'</span>,<span class="string">'off'</span>);
2744         pause(0);
2745 
2746 
2747     <span class="keyword">case</span> <span class="string">'FeedbackSetup'</span>
2748         InitFlag = Input2;           <span class="comment">% Input #2: if InitFlag, then initialize variables</span>
2749 
2750         <span class="keyword">if</span> InitFlag
2751             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2752             <span class="comment">% Edit the following lists to change default configuration of Orbit Correction %</span>
2753             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2754 
2755             <span class="comment">% Corrector magnets</span>
2756             listh=[
2757                 1 2;
2758                 1 8;
2759                 2 1;
2760                 2 8;
2761                 3 1;
2762                 3 8;
2763                 3 10; <span class="comment">%SR04U_HCM2 (chicane trim)</span>
2764                 4 1;
2765                 4 8;
2766                 5 1;
2767                 5 8;
2768                <span class="comment">% 5 10; %SR06U_HCM2 (chicane trim)</span>
2769                 6 1;
2770                 6 8;
2771                 7 1;
2772                 7 8;
2773                 8 1;
2774                 8 8;
2775                 9 1;
2776                 9 8;
2777                 10 1;
2778                 10 8;
2779                 10 10; <span class="comment">%SR11U_HCM2 (chicane trim)</span>
2780                 11 1;
2781                 11 8;
2782                 12 1;
2783                 12 7];
2784             listv=[
2785                 1 2;
2786                 1 8;
2787                 2 1;
2788                 2 8;
2789                 3 1;
2790                 3 7;
2791                 3 8;
2792                 3 10; <span class="comment">%SR04U_VHCM2 (chicane trim)</span>
2793                 4 1;
2794                 4 7;
2795                 4 8;
2796                 5 1;
2797                 5 8;
2798                <span class="comment">% 5 10; %SR06U_VHCM2 (chicane trim)</span>
2799                 6 1;
2800                 6 8;
2801                 7 1;
2802                 7 8;
2803                 8 1;
2804                 8 8;
2805                 9 1;
2806                 9 8;
2807                 10 1;
2808                 10 2;
2809                 10 7;
2810                 10 8;
2811                 10 10; <span class="comment">%SR11U_VHCM2 (chicane trim)</span>
2812                 11 1;
2813                 11 7;
2814                 11 8;
2815                 12 1;
2816                 12 7];
2817 
2818             Xivec = [1:27];
2819             Yivec = [1:31];
2820             HCMlist1 = listh;
2821             VCMlist1 = listv;
2822 
2823             <span class="comment">% Full BPM list</span>
2824             BPMlist1 = [
2825                 1 2
2826                 1 5
2827                 1 6
2828                 1 10
2829                 2 1
2830                 2 5
2831                 2 6
2832                 2 9
2833                 3 2
2834                 3 5
2835                 3 6
2836                 3 10
2837                 3 11
2838                 3 12
2839                 4 1
2840                 4 5
2841                 4 6
2842                 4 10
2843                 5 1
2844                 5 5
2845                 5 6
2846                 5 10
2847 <span class="comment">%                5 11</span>
2848 <span class="comment">%                5 12</span>
2849                 6 1
2850                 6 5
2851                 6 6
2852                 6 10
2853                 7 1
2854                 7 5
2855                 7 6
2856                 7 10
2857                 8 1
2858                 8 5
2859                 8 6
2860                 8 10
2861                 9 1
2862                 9 5
2863                 9 6
2864                 9 10
2865                 10 1
2866                 10 5
2867                 10 6
2868                 10 10
2869                 10 11
2870                 10 12
2871                 11 1
2872                 11 5
2873                 11 6
2874                 11 10
2875                 12 1
2876                 12 5
2877                 12 6
2878                 12 9
2879                 ];
2880 
2881             <span class="comment">% remove Bergoz BPMs in SR01 and SR03 for 2-bunch (noisy at low currents) and drop singular values</span>
2882             <span class="keyword">if</span> strcmp(getfamilydata(<span class="string">'OperationalMode'</span>), <span class="string">'1.9 GeV, Two-Bunch'</span>)
2883                     BPMlist1 = [
2884                          <span class="comment">%1 2</span>
2885                          1 5
2886                          1 6
2887                          1 10
2888                          2 1
2889                          2 5
2890                          2 6
2891                          <span class="comment">%2 9</span>
2892                          <span class="comment">%3 2</span>
2893                          3 5
2894                          3 6
2895                          3 10
2896                          3 11
2897                          3 12
2898                          4 1
2899                          4 5
2900                          4 6
2901                          4 10
2902                          5 1
2903                          5 5
2904                          5 6
2905                          5 10
2906                          5 11
2907                          5 12
2908                          6 1
2909                          6 5
2910                          6 6
2911                          6 10
2912                          7 1
2913                          7 5
2914                          7 6
2915                          7 10
2916                          8 1
2917                          8 5
2918                          8 6
2919                          8 10
2920                          9 1
2921                          9 5
2922                          9 6
2923                          9 10
2924                          10 1
2925                          10 5
2926                          10 6
2927                          10 10
2928                          10 11
2929                          10 12
2930                          11 1
2931                          11 5
2932                          11 6
2933                          11 10
2934                          12 1
2935                          12 5
2936                          12 6
2937                          <span class="comment">%12 9</span>
2938                          ];
2939             <span class="keyword">end</span>
2940 
2941             OCSx.BPM = getx(BPMlist1, <span class="string">'struct'</span>);
2942             OCSx.CM = getsp(<span class="string">'HCM'</span>, HCMlist1, <span class="string">'struct'</span>);
2943             OCSx.GoalOrbit = getgolden(OCSx.BPM, <span class="string">'numeric'</span>);
2944             OCSx.NIter = 1;
2945             OCSx.SVDIndex = Xivec;
2946             OCSx.IncrementalFlag = <span class="string">'No'</span>;
2947             OCSx.BPMWeight = {[]};
2948             OCSx.FitRF = 0;
2949             OCSy.BPM = gety(BPMlist1, <span class="string">'struct'</span>);
2950             OCSy.CM = getsp(<span class="string">'VCM'</span>, VCMlist1, <span class="string">'struct'</span>);
2951             OCSy.GoalOrbit = getgolden(OCSy.BPM, <span class="string">'numeric'</span>);
2952             OCSy.NIter = 1;
2953             OCSy.SVDIndex = Yivec;
2954             OCSy.IncrementalFlag = <span class="string">'No'</span>;
2955             OCSy.BPMWeight = {[]};
2956             OCSy.FitRF = 0;
2957             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2958             <span class="comment">% do we need these Smat calls? %</span>
2959             <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
2960             SXmat = getrespmat(OCSx.BPM, OCSx.CM, <span class="string">'numeric'</span>);
2961             SYmat = getrespmat(OCSy.BPM, OCSy.CM, <span class="string">'numeric'</span>);
2962             <span class="comment">% [OCSx, Sx, Ux, Vx] = orbitcorrectionmethods(OCSx, SXmat);</span>
2963             <span class="comment">% [OCSy, Sy, Uy, Vy] = orbitcorrectionmethods(OCSy, SYmat);</span>
2964 
2965             <span class="comment">% initialize FFTypeFlag</span>
2966             FFTypeFlag = <span class="string">'Global'</span>;
2967 
2968         <span class="keyword">else</span>
2969 
2970             <span class="comment">% Get vectors</span>
2971             FB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
2972             <span class="comment">% the two lines below seem to fix BPMlist editing problem</span>
2973             OCSx = FB.OCSx;
2974             OCSy = FB.OCSy;
2975             BPMlist1 = FB.BPMlist1;
2976             HCMlist1 = FB.HCMlist1;
2977             VCMlist1 = FB.VCMlist1;
2978             Xivec = FB.Xivec;
2979             Yivec = FB.Yivec;
2980             Xgoal = FB.OCSx.GoalOrbit;
2981             OCSx.GoalOrbit = Xgoal;
2982             Ygoal = FB.OCSy.GoalOrbit;
2983             OCSy.GoalOrbit = Ygoal;
2984             FFTypeFlag = FB.FFTypeFlag;
2985 
2986 
2987             <span class="comment">% FF corrector magnet list</span>
2988             ListFF = [
2989                 4     2
2990                 4     8
2991                 5     1
2992                 5     7
2993 <span class="comment">%               5     8 % why are these out???</span>
2994 <span class="comment">%               6     1 % why are these out???</span>
2995                 6     8
2996                 7     1
2997                 7     8
2998                 8     1
2999                 8     8
3000                 9     1
3001                 9     8
3002                 10    1
3003                 11    8
3004                 12    1];
3005             ElemFF = dev2elem(<span class="string">'HCM'</span>,ListFF);
3006 
3007 
3008             <span class="comment">% Add button to change #ivectors, cm, IDBPMs,</span>
3009             EditFlag = 0;
3010             h_fig1 = figure;
3011             <span class="keyword">while</span> EditFlag ~= 7
3012 
3013                 Sx = getrespmat(<span class="string">'BPMx'</span>, BPMlist1, <span class="string">'HCM'</span>, HCMlist1, [], SR_GEV);
3014                 Sy = getrespmat(<span class="string">'BPMy'</span>, BPMlist1, <span class="string">'VCM'</span>, VCMlist1, [], SR_GEV);
3015                 
3016                 <span class="keyword">if</span> get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLCheckboxRF'</span>),<span class="string">'Value'</span>) == 1
3017                     DispOrbit = getdisp(<span class="string">'BPMx'</span>, BPMlist1);
3018                     Sx = [Sx DispOrbit];
3019                 <span class="keyword">end</span>
3020                 
3021                 [Ux, SVx, Vx] = svd(Sx);
3022                 [Uy, SVy, Vy] = svd(Sy);
3023 
3024                 
3025                 <span class="comment">% Remove singular values greater than the actual number of singular values</span>
3026                 i = find(Xivec&gt;length(diag(SVx)));
3027                 <span class="keyword">if</span> ~isempty(i)
3028                     disp(<span class="string">'   Horizontal E-vector scaled since there were more elements in the vector than singular values.'</span>);
3029                     pause(0);
3030                     Xivec(i) = [];
3031                 <span class="keyword">end</span>
3032                 i = find(Yivec&gt;length(diag(SVy)));
3033                 <span class="keyword">if</span> ~isempty(i)
3034                     disp(<span class="string">'   Vertical E-vector scaled since there were more elements in the vector than singular values.'</span>);
3035                     pause(0);
3036                     Yivec(i) = [];
3037                 <span class="keyword">end</span>
3038 
3039 
3040                 Ax = Sx*Vx(:,Xivec);
3041                 Tx = inv(Ax'*Ax)*Ax';
3042 
3043                 Ay = Sy*Vy(:,Yivec);
3044                 Ty = inv(Ay'*Ay)*Ay';
3045 
3046                 figure(h_fig1);
3047                 subplot(2,1,1);
3048                 semilogy(diag(SVx),<span class="string">'b'</span>);
3049                 hold on;
3050                 semilogy(diag(SVx(Xivec,Xivec)),<span class="string">'xr'</span>);
3051                 ylabel(<span class="string">'Horizontal'</span>);
3052                 title(<span class="string">'Response Matrix Singular Values'</span>);
3053                 hold off;
3054                 subplot(2,1,2);
3055                 semilogy(diag(SVy),<span class="string">'b'</span>);
3056                 hold on;
3057                 semilogy(diag(SVy(Yivec,Yivec)),<span class="string">'xr'</span>);
3058                 xlabel(<span class="string">'Singular Value Number'</span>);
3059                 ylabel(<span class="string">'Vertical'</span>);
3060                 hold off;
3061                 drawnow;
3062 
3063                 EditFlag = menu(<span class="string">'Change Parameters?'</span>,<span class="string">'Singular Values'</span>,<span class="string">'HCM List'</span>,<span class="string">'VCM List'</span>, <span class="keyword">...</span>
3064                     <span class="string">'BPM List'</span>,<span class="string">'Change the Goal Orbit'</span>, <span class="keyword">...</span>
3065                     <span class="string">'Change Tune FF Method (nuy=9.2 only)'</span>,<span class="string">'Continue'</span>);
3066 
3067                 <span class="keyword">if</span> EditFlag == 1
3068                     prompt={<span class="string">'Enter the horizontal E-vector numbers (Matlab vector format):'</span>,<span class="string">'Enter the vertical E-vector numbers (Matlab vector format):'</span>};
3069                     def={sprintf(<span class="string">'[%d:%d]'</span>,1,Xivec(end)),sprintf(<span class="string">'[%d:%d]'</span>,1,Yivec(end))};
3070                     titlestr=<span class="string">'SVD Orbit Feedback'</span>;
3071                     lineNo=1;
3072                     answer=inputdlg(prompt,titlestr,lineNo,def);
3073                     <span class="keyword">if</span> ~isempty(answer)
3074                         XivecNew = fix(str2num(answer{1}));
3075                         <span class="keyword">if</span> isempty(XivecNew)
3076                             disp(<span class="string">'   Horizontal E-vector cannot be empty.  No change made.'</span>);
3077                         <span class="keyword">else</span>
3078                             <span class="keyword">if</span> any(XivecNew&lt;=0) | max(XivecNew)&gt;length(diag(SVx))
3079                                 disp(<span class="string">'   Error reading horizontal E-vector.  No change made.'</span>);
3080                             <span class="keyword">else</span>
3081                                 Xivec = XivecNew;
3082                             <span class="keyword">end</span>
3083                         <span class="keyword">end</span>
3084                         YivecNew = fix(str2num(answer{2}));
3085                         <span class="keyword">if</span> isempty(YivecNew)
3086                             disp(<span class="string">'   Vertical E-vector cannot be empty.  No change made.'</span>);
3087                         <span class="keyword">else</span>
3088                             <span class="keyword">if</span> any(YivecNew&lt;=0) | max(YivecNew)&gt;length(diag(SVy))
3089                                 disp(<span class="string">'   Error reading vertical E-vector.  No change made.'</span>);
3090                             <span class="keyword">else</span>
3091                                 Yivec = YivecNew;
3092                             <span class="keyword">end</span>
3093                         <span class="keyword">end</span>
3094                     <span class="keyword">end</span>
3095                 <span class="keyword">end</span>
3096 
3097                 <span class="keyword">if</span> EditFlag == 2
3098                     List= getlist(<span class="string">'HCM'</span>,<span class="string">'Trim'</span>);
3099                     CheckList = zeros(96,1);
3100                     Elem = dev2elem(<span class="string">'HCM'</span>, HCMlist1);
3101                     CheckList(Elem) = ones(size(Elem));
3102                     CheckList = CheckList(dev2elem(<span class="string">'HCM'</span>,List));
3103 
3104                     <span class="comment">% Remove FF corrrectors</span>
3105                     <span class="comment">%           Elem = dev2elem('HCM',List);</span>
3106                     <span class="comment">%           for j = length(ElemFF):-1:1</span>
3107                     <span class="comment">%              i = find(Elem==ElemFF(j));</span>
3108                     <span class="comment">%              Elem(i,:) = [];</span>
3109                     <span class="comment">%              List(i,:) = [];</span>
3110                     <span class="comment">%              CheckList(i,:) = [];</span>
3111                     <span class="comment">%           end</span>
3112 
3113                     newList = editlist(List, <span class="string">'HCMtrim'</span>, CheckList);
3114 
3115                     <span class="keyword">if</span> isempty(newList)
3116                         fprintf(<span class="string">'   WARNING: Horizontal corrector magnet list is empty!\n'</span>);
3117                         HCMlist1 = newList;
3118                     <span class="keyword">else</span>
3119                         HCMlist1 = newList;
3120                     <span class="keyword">end</span>
3121                 <span class="keyword">end</span>
3122 
3123                 <span class="keyword">if</span> EditFlag == 3
3124                     List = getlist(<span class="string">'VCM'</span>,<span class="string">'Trim'</span>);
3125                     CheckList = zeros(96,1);
3126                     Elem = dev2elem(<span class="string">'VCM'</span>, VCMlist1);
3127                     CheckList(Elem) = ones(size(Elem));
3128                     CheckList = CheckList(dev2elem(<span class="string">'VCM'</span>,List));
3129 
3130                     <span class="comment">% Remove FF corrrectors</span>
3131                     <span class="comment">%           Elem = dev2elem('VCM',List);</span>
3132                     <span class="comment">%           for j = length(ElemFF):-1:1</span>
3133                     <span class="comment">%              i = find(Elem==ElemFF(j));</span>
3134                     <span class="comment">%              Elem(i,:) = [];</span>
3135                     <span class="comment">%              List(i,:) = [];</span>
3136                     <span class="comment">%              CheckList(i,:) = [];</span>
3137                     <span class="comment">%           end</span>
3138 
3139                     newList = editlist(List, <span class="string">'VCMtrim'</span>, CheckList);
3140 
3141                     <span class="keyword">if</span> isempty(newList)
3142                         fprintf(<span class="string">'   WARNING: Vertical corrector magnet list is empty!\n'</span>);
3143                         VCMlist1 = newList;
3144                     <span class="keyword">else</span>
3145                         VCMlist1 = newList;
3146                     <span class="keyword">end</span>
3147                 <span class="keyword">end</span>
3148 
3149                 <span class="keyword">if</span> EditFlag == 4
3150                     ListOld = BPMlist1;
3151                     XgoalOld = Xgoal;
3152                     YgoalOld = Ygoal;
3153 
3154                     <span class="comment">% Full BPM list</span>
3155                     List = [
3156                         1 2
3157                         1 5
3158                         1 6
3159                         1 10
3160                         2 1
3161                         2 5
3162                         2 6
3163                         2 9
3164                         3 2
3165                         3 5
3166                         3 6
3167                         3 10
3168                         3 11
3169                         3 12
3170                         4 1
3171                         4 5
3172                         4 6
3173                         4 10
3174                         5 1
3175                         5 5
3176                         5 6
3177                         5 10
3178                         5 11
3179                         5 12
3180                         6 1
3181                         6 5
3182                         6 6
3183                         6 10
3184                         7 1
3185                         7 5
3186                         7 6
3187                         7 10
3188                         8 1
3189                         8 5
3190                         8 6
3191                         8 10
3192                         9 1
3193                         9 5
3194                         9 6
3195                         9 10
3196                         10 1
3197                         10 5
3198                         10 6
3199                         10 10
3200                         10 11
3201                         10 12
3202                         11 1
3203                         11 5
3204                         11 6
3205                         11 10
3206                         12 1
3207                         12 5
3208                         12 6
3209                         12 9
3210                         ];
3211 
3212 
3213                     CheckList = zeros(size(List,1),1);
3214                     <span class="keyword">if</span> ~isempty(BPMlist1)
3215                         <span class="keyword">for</span> i = 1:size(List,1)
3216                             k = find(List(i,1)==BPMlist1(:,1));
3217                             l = find(List(i,2)==BPMlist1(k,2));
3218 
3219                             <span class="keyword">if</span> isempty(k) | isempty(l)
3220                                 <span class="comment">% Item not in list</span>
3221                             <span class="keyword">else</span>
3222                                 CheckList(i) = 1;
3223                             <span class="keyword">end</span>
3224                         <span class="keyword">end</span>
3225                     <span class="keyword">end</span>
3226 
3227                     newList = editlist(List, <span class="string">'BPM'</span>, CheckList);
3228                     <span class="keyword">if</span> isempty(newList)
3229                         fprintf(<span class="string">'   BPM list cannot be empty.  No change made.\n'</span>);
3230                     <span class="keyword">else</span>
3231                         BPMlist1 = newList;
3232                     <span class="keyword">end</span>
3233 
3234                     <span class="comment">% Set the goal orbit to the golden orbit</span>
3235                     Xgoal = getgolden(<span class="string">'BPMx'</span>, BPMlist1);
3236                     Ygoal = getgolden(<span class="string">'BPMy'</span>, BPMlist1);
3237 
3238 
3239                     <span class="comment">% If a new BPM is added, then set the goal orbit to the golden orbit</span>
3240                     <span class="keyword">for</span> i = 1:size(BPMlist1,1)
3241 
3242                         <span class="comment">% Is it a new BPM?</span>
3243                         k = find(BPMlist1(i,1)==ListOld(:,1));
3244                         l = find(BPMlist1(i,2)==ListOld(k,2));
3245 
3246                         <span class="keyword">if</span> isempty(k) | isempty(l)
3247                             <span class="comment">% New BPM</span>
3248                         <span class="keyword">else</span>
3249                             <span class="comment">% Use the old value for old BPM</span>
3250                             Xgoal(i) = XgoalOld(k(l));
3251                             Ygoal(i) = YgoalOld(k(l));
3252                         <span class="keyword">end</span>
3253                     <span class="keyword">end</span>
3254                     OCSx.BPM.DeviceList = BPMlist1;
3255                     OCSy.BPM.DeviceList = BPMlist1;
3256                     OCSx.GoalOrbit = Xgoal;
3257                     OCSy.GoalOrbit = Ygoal;
3258                 <span class="keyword">end</span>
3259 
3260                 <span class="keyword">if</span> EditFlag == 5
3261                     ChangeList = editlist2(BPMlist1, <span class="string">'Change BPM'</span>, zeros(size(BPMlist1,1),1));
3262 
3263                     <span class="keyword">for</span> i = 1:size(ChangeList,1)
3264 
3265                         k = find(ChangeList(i,1)==BPMlist1(:,1));
3266                         l = find(ChangeList(i,2)==BPMlist1(k,2));
3267 
3268                         prompt={sprintf(<span class="string">'Enter the new horizontal goal orbit for BPMx(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2)),sprintf(<span class="string">'Enter the new vertical goal orbit for BPMy(%d,%d):'</span>,BPMlist1(k(l),1),BPMlist1(k(l),2))};
3269                         def={sprintf(<span class="string">'%f'</span>,Xgoal(k(l))),sprintf(<span class="string">'%f'</span>,Ygoal(k(l)))};
3270                         titlestr=<span class="string">'CHANGE THE GOAL ORBIT'</span>;
3271                         lineNo=1;
3272                         answer = inputdlg(prompt, titlestr, lineNo, def);
3273 
3274                         <span class="keyword">if</span> isempty(answer)
3275                             <span class="comment">% No change</span>
3276                             fprintf(<span class="string">'   No change was made to the golden orbit.\n'</span>);
3277                         <span class="keyword">else</span>
3278                             Xgoalnew = str2num(answer{1});
3279                             <span class="keyword">if</span> isempty(Xgoalnew)
3280                                 fprintf(<span class="string">'   No change was made to the horizontal golden orbit.\n'</span>);
3281                             <span class="keyword">else</span>
3282                                 Xgoal(k(l)) = Xgoalnew;
3283                             <span class="keyword">end</span>
3284 
3285                             Ygoalnew = str2num(answer{2});
3286                             <span class="keyword">if</span> isempty(Ygoalnew)
3287                                 fprintf(<span class="string">'   No change was made to the vertical golden orbit.\n'</span>);
3288                             <span class="keyword">else</span>
3289                                 Ygoal(k(l)) = Ygoalnew;
3290                             <span class="keyword">end</span>
3291                         <span class="keyword">end</span>
3292                     <span class="keyword">end</span>
3293                     <span class="keyword">if</span> ~isempty(ChangeList)
3294                         fprintf(<span class="string">'   Note:  Changing the goal orbit for &quot;Slow Orbit Feedback&quot; does not change the goal orbit for &quot;Orbit Correction.&quot;\n'</span>);
3295                         fprintf(<span class="string">'          Re-running srcontrol will restart the goal orbit to the golden orbit.&quot;\n'</span>);
3296                     <span class="keyword">end</span>
3297                     OCSx.GoalOrbit = Xgoal;
3298                     OCSy.GoalOrbit = Ygoal;
3299                 <span class="keyword">end</span>
3300 
3301                 <span class="keyword">if</span> EditFlag == 6
3302                     FFTypeFlag = questdlg(sprintf(<span class="string">'Do you want to use a fully local or a combined local/global compensation of IDs? (nuy=9.2 only)'</span>),<span class="string">'Tune FF'</span>,<span class="string">'Local'</span>,<span class="string">'Global'</span>, <span class="string">'Global'</span>);
3303                     <span class="keyword">if</span> strcmp(FFTypeFlag,<span class="string">'Local'</span>)
3304                         disp([<span class="string">'   The tune FF will use 8 local quadrupoles to compensate beta beating and tune shift'</span>]);
3305                         disp([<span class="string">'   from each ID.'</span>]);
3306                     <span class="keyword">elseif</span> strcmp(FFTypeFlag,<span class="string">'Global'</span>)
3307                         disp([<span class="string">'   The tune FF will use 4 local quadrupoles to compensate beta beating and all QF+QD'</span>]);
3308                         disp([<span class="string">'   to compensate tune shift from each ID.'</span>]);
3309                     <span class="keyword">end</span>
3310 
3311                 <span class="keyword">end</span>
3312 
3313             <span class="keyword">end</span>
3314             close(h_fig1);
3315         <span class="keyword">end</span>
3316 
3317         <span class="comment">% Save vectors</span>
3318         FB.Xivec = Xivec;
3319         FB.Yivec = Yivec;
3320         FB.HCMlist1 = HCMlist1;
3321         FB.VCMlist1 = VCMlist1;
3322         FB.BPMlist1 = BPMlist1;
3323 
3324         OCSx.SVDIndex = Xivec;
3325         OCSy.SVDIndex = Yivec;
3326         FB.OCSx = OCSx;
3327         FB.OCSy = OCSy;
3328 
3329         FB.FFTypeFlag = FFTypeFlag;
3330         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFeedbackSetup'</span>),<span class="string">'Userdata'</span>,FB);
3331 
3332 
3333     <span class="keyword">case</span> <span class="string">'FastFeedbackSetup'</span>
3334 
3335         InitFlag = Input2;
3336 
3337         <span class="keyword">if</span> InitFlag
3338             FOFBFreq = 1000;
3339             <span class="comment">% user operations 9/14-10/17/04: P=0.5, I=120, D=0.0015 (for both planes)</span>
3340             <span class="comment">% below are known good values for user ops as of 8-1-05</span>
3341             HorP = 2;
3342             HorI = 300;
3343             HorD = 0.002;
3344             VertP = 1;
3345             VertI = 100;
3346             VertD = 0.0015;
3347 
3348             <span class="comment">% this initial set is now done in hwinit.m because it's not a good idea to set anything when srcontrol is launched</span>
3349             <span class="comment">% try</span>
3350             <span class="comment">%     setsp('SR01____FFBFREQAC00', FOFBFreq); % set freq</span>
3351             <span class="comment">%     write_pid_ffb2_patch(HorP, HorI, HorD, VertP, VertI, VertD);</span>
3352             <span class="comment">% catch</span>
3353             <span class="comment">%     disp('   Trouble setting Fast Orbit Feedback parameters!');</span>
3354             <span class="comment">% end</span>
3355 
3356         <span class="keyword">else</span>
3357             <span class="comment">% Get vectors</span>
3358             FOFB = get(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Userdata'</span>);
3359             FOFBFreq = FOFB.FOFBFreq;
3360             HorP  = FOFB.HorP;
3361             HorI  = FOFB.HorI;
3362             HorD  = FOFB.HorD;
3363             VertP = FOFB.VertP;
3364             VertI = FOFB.VertI;
3365             VertD = FOFB.VertD;
3366 
3367             <span class="comment">% Add button to change #ivectors, CMs, IDBPMs,</span>
3368             EditFlag = 0;
3369             <span class="comment">%h_fig1 = figure;</span>
3370             <span class="keyword">while</span> EditFlag ~= 3
3371 
3372                 <span class="comment">%EditFlag = menu('Change Parameters?', 'Fast Feedback Frequency', 'PID Values', 'HCM List', 'VCM List', ...</span>
3373                 <span class="comment">%   'IDBPM List', 'BBPM List', 'Continue');</span>
3374                 <span class="comment">% Use menu below until other FFB config routines work (then also uncomment options 3,4,5,6 below)</span>
3375                 EditFlag = menu(<span class="string">'Change Parameters?'</span>, <span class="string">'Fast Feedback Frequency'</span>, <span class="string">'PID Values'</span>, <span class="string">'Continue'</span>);
3376 
3377                 <span class="keyword">if</span> EditFlag == 1
3378                     <span class="comment">% change rate</span>
3379 
3380                     prompt={<span class="string">'Enter the desired Fast Feedback Frequency (1-1000 Hz)'</span>};
3381                     def={num2str(FOFBFreq)};
3382                     titlestr=<span class="string">'Fast Feedback Setup'</span>;
3383                     lineNo=1;
3384                     answer=inputdlg(prompt,titlestr,lineNo,def);
3385                     <span class="keyword">if</span> ~isempty(answer)
3386                         FOFBFreq = fix(str2num(answer{1}));
3387                         <span class="keyword">if</span> isempty(FOFBFreq)
3388                             disp(<span class="string">'   Frequency value cannot be empty.  No change made.'</span>);
3389                             FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3390                         <span class="keyword">else</span>
3391                             <span class="keyword">if</span> FOFBFreq &lt; 1 | FOFBFreq &gt; 1000
3392                                 disp(<span class="string">'   Frequency must be between 1 and 1000 Hz.  No change made.'</span>);
3393                                 FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3394                             <span class="keyword">end</span>
3395                         <span class="keyword">end</span>
3396                         setsp(<span class="string">'SR01____FFBFREQAC00'</span>,FOFBFreq   ); <span class="comment">% change freq</span>
3397                         pause(0.5);
3398                         fprintf(<span class="string">'   Fast orbit feedback frequency is running at %.0f Hz.\n'</span>, getpv(<span class="string">'SR01____FFBFREQAM00'</span>));
3399                     <span class="keyword">else</span>
3400                         FOFBFreq = getsp(<span class="string">'SR01____FFBFREQAC00'</span>);
3401                     <span class="keyword">end</span>
3402                 <span class="keyword">end</span>
3403 
3404                 <span class="keyword">if</span> EditFlag == 2
3405                     <span class="comment">% edit  PIDs</span>
3406                     <span class="comment">% User defaults are HorP=2, HorI=300, HorD=0.002, VertP=1, VertI=100, VertD=0.0015</span>
3407                     prompt={<span class="string">'P horizontal'</span>, <span class="string">'I horizontal'</span>, <span class="string">'D horizontal'</span>, <span class="string">'P vertical'</span>, <span class="string">'I vertical'</span>, <span class="string">'D vertical'</span>};
3408                     def={num2str(HorP), num2str(HorI), num2str(HorD), num2str(VertP), num2str(VertI), num2str(VertD)};
3409                     titlestr=<span class="string">'Fast Feedback PID Setup'</span>;
3410                     lineNo=1;
3411                     answer=inputdlg(prompt,titlestr,lineNo,def);
3412                     <span class="keyword">if</span> ~isempty(answer)
3413                         HorPnewnum = str2num(answer{1});
3414                         <span class="keyword">if</span> isempty(HorPnewnum)
3415                             disp(<span class="string">'   HorP value cannot be empty.  No change made.'</span>);
3416                         <span class="keyword">else</span>
3417                             HorP = HorPnewnum;
3418                         <span class="keyword">end</span>
3419                         HorInewnum = str2num(answer{2});
3420                         <span class="keyword">if</span> isempty(HorInewnum)
3421                             disp(<span class="string">'   HorI value cannot be empty.  No change made.'</span>);
3422                         <span class="keyword">else</span>
3423                             HorI = HorInewnum;
3424                         <span class="keyword">end</span>
3425                         HorDnewnum = str2num(answer{3});
3426                         <span class="keyword">if</span> isempty(HorDnewnum)
3427                             disp(<span class="string">'   HorD value cannot be empty.  No change made.'</span>);
3428                         <span class="keyword">else</span>
3429                             HorD = HorDnewnum;
3430                         <span class="keyword">end</span>
3431                         VertPnewnum = str2num(answer{4});
3432                         <span class="keyword">if</span> isempty(VertPnewnum)
3433                             disp(<span class="string">'   VertP value cannot be empty.  No change made.'</span>);
3434                         <span class="keyword">else</span>
3435                             VertP = VertPnewnum;
3436                         <span class="keyword">end</span>
3437                         VertInewnum = str2num(answer{5});
3438                         <span class="keyword">if</span> isempty(VertInewnum)
3439                             disp(<span class="string">'   VertI value cannot be empty.  No change made.'</span>);
3440                         <span class="keyword">else</span>
3441                             VertI = VertInewnum;
3442                         <span class="keyword">end</span>
3443                         VertDnewnum = str2num(answer{6});
3444                         <span class="keyword">if</span> isempty(VertDnewnum)
3445                             disp(<span class="string">'   VertD value cannot be empty.  No change made.'</span>);
3446                         <span class="keyword">else</span>
3447                             VertD = VertDnewnum;
3448                         <span class="keyword">end</span>
3449 
3450                         <span class="keyword">try</span>
3451                             write_pid_ffb2_patch(HorP, HorI, HorD, VertP, VertI, VertD);
3452                             fprintf(<span class="string">'   Setting FFB gains to Horizontal P=%.2f, I=%.1f, D=%.4f;  Vertical P=%.2f, I=%.1f, D=%.4f\n'</span>, HorP, HorI, HorD, VertP, VertI, VertD);
3453                         <span class="keyword">catch</span>
3454                             disp(<span class="string">'   Trouble setting Fast Orbit Feedback parameters!'</span>);
3455                         <span class="keyword">end</span>
3456                     <span class="keyword">end</span>
3457                 <span class="keyword">end</span>
3458 
3459                 <span class="comment">%if EditFlag == 3</span>
3460                 <span class="comment">%   disp('   This function not yet available.');</span>
3461                 <span class="comment">%   % change HCM List</span>
3462                 <span class="comment">%end</span>
3463                 <span class="comment">%</span>
3464                 <span class="comment">%if EditFlag == 4</span>
3465                 <span class="comment">%   disp('   This function not yet available.');</span>
3466                 <span class="comment">%   % change VCM List</span>
3467                 <span class="comment">%end</span>
3468                 <span class="comment">%</span>
3469                 <span class="comment">%if EditFlag == 5</span>
3470                 <span class="comment">%   disp('   This function not yet available.');</span>
3471                 <span class="comment">%   % change IDBPM List</span>
3472                 <span class="comment">%end</span>
3473                 <span class="comment">%</span>
3474                 <span class="comment">%if EditFlag == 6</span>
3475                 <span class="comment">%   disp('   This function not yet available.');</span>
3476                 <span class="comment">%   % change BBPM List</span>
3477                 <span class="comment">%end</span>
3478 
3479             <span class="keyword">end</span>
3480             <span class="comment">%close(h_fig1);</span>
3481         <span class="keyword">end</span>
3482 
3483         <span class="comment">% Save vectors</span>
3484         FOFB.FOFBFreq = FOFBFreq;
3485         FOFB.HorP = HorP;
3486         FOFB.HorI = HorI;
3487         FOFB.HorD = HorD;
3488         FOFB.VertP = VertP;
3489         FOFB.VertI = VertI;
3490         FOFB.VertD = VertD;
3491         set(findobj(gcbf,<span class="string">'Tag'</span>,<span class="string">'SRCTRLButtonFastFeedbackSetup'</span>),<span class="string">'Userdata'</span>,FOFB);
3492 
3493     <span class="keyword">otherwise</span>
3494         fprintf(<span class="string">'   No action for %s.\n'</span>, action);
3495 <span class="keyword">end</span>   <span class="comment">% end case</span></pre></div>
<hr><address>Generated on Thu 02-Aug-2007 13:16:07 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/">m2html</a></strong> &copy; 2003</address>
</body>
</html>